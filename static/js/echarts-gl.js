!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("echarts")):"function"==typeof define&&define.amd?define(["echarts"],e):"object"==typeof exports?exports["echarts-gl"]=e(require("echarts")):t["echarts-gl"]=e(t.echarts)}(self,function(e){return(()=>{"use strict";var r={"./src/export/all.js":(L,P,t)=>{t.r(P);var O=t("echarts/lib/echarts");function N(l,t,e){"object"==typeof t&&(e=t,t=null);var h,u=this;if(!(l instanceof Function))for(var r in h=[],l)l.hasOwnProperty(r)&&h.push(r);function i(){}var c=function(t){if(u.apply(this,arguments),l instanceof Function)R(this,l.call(this,t));else for(var e=this,r=l,i=h,n=0;n<i.length;n++){var o=i[n];e[o]=r[o]}if(this.constructor===c)for(var a=c.__initializers__,s=0;s<a.length;s++)a[s].apply(this,arguments)};(c.__super__=u).__initializers__?c.__initializers__=u.__initializers__.slice():c.__initializers__=[],t&&c.__initializers__.push(t);return i.prototype=u.prototype,c.prototype=new i,R((c.prototype.constructor=c).prototype,e),c.extend=u.extend,c.derive=u.extend,c}function R(t,e){if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}P={extend:N,derive:N};function z(t,e){this.action=t,this.context=e}var U={trigger:function(t){if(this.hasOwnProperty("__handlers__")&&this.__handlers__.hasOwnProperty(t)){var e=this.__handlers__[t],r=e.length,i=-1,n=arguments;switch(n.length){case 1:for(;++i<r;)e[i].action.call(e[i].context);return;case 2:for(;++i<r;)e[i].action.call(e[i].context,n[1]);return;case 3:for(;++i<r;)e[i].action.call(e[i].context,n[1],n[2]);return;case 4:for(;++i<r;)e[i].action.call(e[i].context,n[1],n[2],n[3]);return;case 5:for(;++i<r;)e[i].action.call(e[i].context,n[1],n[2],n[3],n[4]);return;default:for(;++i<r;)e[i].action.apply(e[i].context,Array.prototype.slice.call(n,1));return}}},on:function(t,e,r){if(t&&e){var i=this.__handlers__||(this.__handlers__={});if(i[t]){if(this.has(t,e))return}else i[t]=[];e=new z(e,r||this);return i[t].push(e),this}},once:function(e,r,t){var i;if(e&&r)return(i=this).on(e,function t(){i.off(e,t),r.apply(this,arguments)},t)},before:function(t,e,r){if(t&&e)return this.on(t="before"+t,e,r)},after:function(t,e,r){if(t&&e)return this.on(t="after"+t,e,r)},success:function(t,e){return this.once("success",t,e)},error:function(t,e){return this.once("error",t,e)},off:function(t,e){var r=this.__handlers__||(this.__handlers__={});if(e){if(r[t]){for(var i=r[t],n=[],o=0;o<i.length;o++)e&&i[o].action!==e&&n.push(i[o]);r[t]=n}return this}r[t]=[]},has:function(t,e){var r=this.__handlers__;if(!r||!r[t])return!1;for(var i=r[t],n=0;n<i.length;n++)if(i[n].action===e)return!0}},G=0,H=Array.prototype.forEach,V={genGUID:function(){return++G},relative2absolute:function(t,e){if(!e||t.match(/^\//))return t;for(var r=t.split("/"),i=e.split("/"),n=r[0];"."===n||".."===n;)".."===n&&i.pop(),r.shift(),n=r[0];return i.join("/")+"/"+r.join("/")},extend:function(t,e){if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},defaults:function(t,e){if(e)for(var r in e)void 0===t[r]&&(t[r]=e[r]);return t},extendWithPropList:function(t,e,r){if(e)for(var i=0;i<r.length;i++){var n=r[i];t[n]=e[n]}return t},defaultsWithPropList:function(t,e,r){if(e)for(var i=0;i<r.length;i++){var n=r[i];null==t[n]&&(t[n]=e[n])}return t},each:function(t,e,r){if(t&&e)if(t.forEach&&t.forEach===H)t.forEach(e,r);else if(t.length===+t.length)for(var i=0,n=t.length;i<n;i++)e.call(r,t[i],i,t);else for(var o in t)t.hasOwnProperty(o)&&e.call(r,t[o],o,t)},isObject:function(t){return t===Object(t)},isArray:function(t){return Array.isArray(t)},isArrayLike:function(t){return!!t&&t.length===+t.length},clone:function(t){if(V.isObject(t)){if(V.isArray(t))return t.slice();if(V.isArrayLike(t)){for(var e=new t.constructor(t.length),r=0;r<t.length;r++)e[r]=t[r];return e}return V.extend({},t)}return t}};const W=V;function X(){this.__uid__=W.genGUID()}X.__initializers__=[function(t){W.extend(this,t)}],W.extend(X,P),W.extend(X.prototype,U);var P=X,j=["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","EXT_shader_texture_lod","WEBGL_draw_buffers","EXT_frag_depth","EXT_sRGB","ANGLE_instanced_arrays"],Z=["MAX_TEXTURE_SIZE","MAX_CUBE_MAP_TEXTURE_SIZE"];const Y=function(r){for(var i={},e={},t=0;t<j.length;t++)o(j[t]);for(t=0;t<Z.length;t++){var n=Z[t];e[n]=r.getParameter(r[n])}function o(t){var e;r.getExtension&&(e=(e=(e=r.getExtension(t))||r.getExtension("MOZ_"+t))||r.getExtension("WEBKIT_"+t),i[t]=e)}this.getExtension=function(t){return t in i||o(t),i[t]},this.getParameter=function(t){return e[t]}},E={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_ATTRIBUTES:35721,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,COMPILE_STATUS:35713,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444};var K,e={get:function(r){var e=new XMLHttpRequest;e.open("get",r.url),e.responseType=r.responseType||"text",r.onprogress&&(e.onprogress=function(t){var e;t.lengthComputable?(e=t.loaded/t.total,r.onprogress(e,t.loaded,t.total)):r.onprogress(null)}),e.onload=function(t){400<=e.status?r.onerror&&r.onerror():r.onload&&r.onload(e.response)},r.onerror&&(e.onerror=r.onerror),e.send(null)}},Q={supportWebGL:function(){if(null==K)try{var t=document.createElement("canvas");if(!(t.getContext("webgl")||t.getContext("experimental-webgl")))throw new Error}catch(t){K=!1}return K}},J=(Q.Int8Array="undefined"==typeof Int8Array?Array:Int8Array,Q.Uint8Array="undefined"==typeof Uint8Array?Array:Uint8Array,Q.Uint16Array="undefined"==typeof Uint16Array?Array:Uint16Array,Q.Uint32Array="undefined"==typeof Uint32Array?Array:Uint32Array,Q.Int16Array="undefined"==typeof Int16Array?Array:Int16Array,Q.Float32Array="undefined"==typeof Float32Array?Array:Float32Array,Q.Float64Array="undefined"==typeof Float64Array?Array:Float64Array,{});"undefined"!=typeof window?J=window:void 0!==t.g&&(J=t.g),Q.requestAnimationFrame=J.requestAnimationFrame||J.msRequestAnimationFrame||J.mozRequestAnimationFrame||J.webkitRequestAnimationFrame||function(t){setTimeout(t,16)},Q.createCanvas=function(){return document.createElement("canvas")},Q.createImage=function(){return new J.Image},Q.request={get:e.get},Q.addEventListener=function(t,e,r,i){t.addEventListener(e,r,i)},Q.removeEventListener=function(t,e,r){t.removeEventListener(e,r)};const $=Q;function tt(){this.head=null,this.tail=null,this._length=0}tt.prototype.insert=function(t){t=new tt.Entry(t);return this.insertEntry(t),t},tt.prototype.insertAt=function(t,e){if(!(t<0)){for(var r,i,n=this.head,o=0;n&&o!=t;)n=n.next,o++;n?(r=new tt.Entry(e),(i=n.prev)?(i.next=r).prev=i:this.head=r,(r.next=n).prev=r):this.insert(e)}},tt.prototype.insertBeforeEntry=function(t,e){var t=new tt.Entry(t),r=e.prev;r?(r.next=t).prev=r:this.head=t,(t.next=e).prev=t,this._length++},tt.prototype.insertEntry=function(t){this.head?((this.tail.next=t).prev=this.tail,this.tail=t):this.head=this.tail=t,this._length++},tt.prototype.remove=function(t){var e=t.prev,r=t.next;e?e.next=r:this.head=r,r?r.prev=e:this.tail=e,t.next=t.prev=null,this._length--},tt.prototype.removeAt=function(t){if(!(t<0)){for(var e=this.head,r=0;e&&r!=t;)e=e.next,r++;return e?(this.remove(e),e.value):void 0}},tt.prototype.getHead=function(){if(this.head)return this.head.value},tt.prototype.getTail=function(){if(this.tail)return this.tail.value},tt.prototype.getAt=function(t){if(!(t<0)){for(var e=this.head,r=0;e&&r!=t;)e=e.next,r++;return e.value}},tt.prototype.indexOf=function(t){for(var e=this.head,r=0;e;){if(e.value===t)return r;e=e.next,r++}},tt.prototype.length=function(){return this._length},tt.prototype.isEmpty=function(){return 0===this._length},tt.prototype.forEach=function(t,e){for(var r=this.head,i=0,n=void 0!==e;r;)n?t.call(e,r.value,i):t(r.value,i),r=r.next,i++},tt.prototype.clear=function(){this.tail=this.head=null,this._length=0},tt.Entry=function(t){this.value=t,this.next=null,this.prev=null};const et=tt;function rt(t){this._list=new et,this._map={},this._maxSize=t||10}rt.prototype.setMaxSize=function(t){this._maxSize=t},rt.prototype.put=function(t,e){var r;this._map.hasOwnProperty(t)||((r=this._list.length())>=this._maxSize&&0<r&&(r=this._list.head,this._list.remove(r),delete this._map[r.key]),(r=this._list.insert(e)).key=t,this._map[t]=r)},rt.prototype.get=function(t){var e=this._map[t];if(this._map.hasOwnProperty(t))return e!==this._list.tail&&(this._list.remove(e),this._list.insertEntry(e)),e.value},rt.prototype.remove=function(t){var e=this._map[t];void 0!==e&&(delete this._map[t],this._list.remove(e))},rt.prototype.clear=function(){this._list.clear(),this._map={}};const it=rt;var nt={},ot={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function at(t){return(t=Math.round(t))<0?0:255<t?255:t}function st(t){return t<0?0:1<t?1:t}function lt(t){return t.length&&"%"===t.charAt(t.length-1)?at(parseFloat(t)/100*255):at(parseInt(t,10))}function ht(t){return t.length&&"%"===t.charAt(t.length-1)?st(parseFloat(t)/100):st(parseFloat(t))}function ut(t,e,r){return r<0?r+=1:1<r&&--r,6*r<1?t+(e-t)*r*6:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function ct(t,e,r){return t+(e-t)*r}function dt(t,e,r,i,n){t[0]=e,t[1]=r,t[2]=i,t[3]=n}function ft(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}var pt=new it(20),mt=null;function gt(t,e){mt&&ft(mt,e),mt=pt.put(t,mt||e.slice())}function _t(t,e){var r=(parseFloat(t[0])%360+360)%360/360,i=ht(t[1]),n=ht(t[2]),i=n<=.5?n*(i+1):n+i-n*i,n=2*n-i;return dt(e=e||[],at(255*ut(n,i,r+1/3)),at(255*ut(n,i,r)),at(255*ut(n,i,r-1/3)),1),4===t.length&&(e[3]=t[3]),e}nt.parse=function(t,e){if(t){e=e||[];var r=pt.get(t);if(r)return ft(e,r);r=(t+="").replace(/ /g,"").toLowerCase();if(r in ot)return ft(e,ot[r]),gt(t,e),e;if("#"===r.charAt(0))return 4===r.length?0<=(i=parseInt(r.substr(1),16))&&i<=4095?(dt(e,(3840&i)>>4|(3840&i)>>8,240&i|(240&i)>>4,15&i|(15&i)<<4,1),gt(t,e),e):void dt(e,0,0,0,1):7===r.length?0<=(i=parseInt(r.substr(1),16))&&i<=16777215?(dt(e,(16711680&i)>>16,(65280&i)>>8,255&i,1),gt(t,e),e):void dt(e,0,0,0,1):void 0;var i=r.indexOf("("),n=r.indexOf(")");if(-1!==i&&n+1===r.length){var o=r.substr(0,i),a=r.substr(i+1,n-(i+1)).split(","),s=1;switch(o){case"rgba":if(4!==a.length)return void dt(e,0,0,0,1);s=ht(a.pop());case"rgb":return 3!==a.length?void dt(e,0,0,0,1):(dt(e,lt(a[0]),lt(a[1]),lt(a[2]),s),gt(t,e),e);case"hsla":return 4!==a.length?void dt(e,0,0,0,1):(a[3]=ht(a[3]),_t(a,e),gt(t,e),e);case"hsl":return 3!==a.length?void dt(e,0,0,0,1):(_t(a,e),gt(t,e),e);default:return}}dt(e,0,0,0,1)}},nt.parseToFloat=function(t,e){if(e=nt.parse(t,e))return e[0]/=255,e[1]/=255,e[2]/=255,e},nt.lift=function(t,e){var r=nt.parse(t);if(r){for(var i=0;i<3;i++)r[i]=e<0?r[i]*(1-e)|0:(255-r[i])*e+r[i]|0;return nt.stringify(r,4===r.length?"rgba":"rgb")}},nt.toHex=function(t){t=nt.parse(t);if(t)return((1<<24)+(t[0]<<16)+(t[1]<<8)+ +t[2]).toString(16).slice(1)},nt.fastLerp=function(t,e,r){var i,n,o;if(e&&e.length&&0<=t&&t<=1)return r=r||[],t=t*(e.length-1),i=Math.floor(t),o=Math.ceil(t),n=e[i],e=e[o],r[0]=at(ct(n[0],e[0],o=t-i)),r[1]=at(ct(n[1],e[1],o)),r[2]=at(ct(n[2],e[2],o)),r[3]=st(ct(n[3],e[3],o)),r},nt.fastMapToColor=nt.fastLerp,nt.lerp=function(t,e,r){var i,n,o,a;if(e&&e.length&&0<=t&&t<=1)return t=t*(e.length-1),i=Math.floor(t),n=Math.ceil(t),a=nt.parse(e[i]),e=nt.parse(e[n]),a=nt.stringify([at(ct(a[0],e[0],o=t-i)),at(ct(a[1],e[1],o)),at(ct(a[2],e[2],o)),st(ct(a[3],e[3],o))],"rgba"),r?{color:a,leftIndex:i,rightIndex:n,value:t}:a},nt.mapToColor=nt.lerp,nt.modifyHSL=function(t,e,r,i){if(t=nt.parse(t))return t=function(t){var e,r,i,n,o,a,s,l,h,u;if(t)return u=t[0]/255,e=t[1]/255,r=t[2]/255,s=Math.min(u,e,r),n=((i=Math.max(u,e,r))+s)/2,0==(h=i-s)?a=o=0:(a=n<.5?h/(i+s):h/(2-i-s),s=((i-u)/6+h/2)/h,l=((i-e)/6+h/2)/h,h=((i-r)/6+h/2)/h,u===i?o=h-l:e===i?o=1/3+s-h:r===i&&(o=2/3+l-s),o<0&&(o+=1),1<o&&--o),u=[360*o,a,n],null!=t[3]&&u.push(t[3]),u}(t),null!=e&&(t[0]=(e=e,(e=Math.round(e))<0?0:360<e?360:e)),null!=r&&(t[1]=ht(r)),null!=i&&(t[2]=ht(i)),nt.stringify(_t(t),"rgba")},nt.modifyAlpha=function(t,e){if((t=nt.parse(t))&&null!=e)return t[3]=st(e),nt.stringify(t,"rgba")},nt.stringify=function(t,e){var r;if(t&&t.length)return r=t[0]+","+t[1]+","+t[2],"rgba"!==e&&"hsva"!==e&&"hsla"!==e||(r+=","+t[3]),e+"("+r+")"};var yt=nt.parseToFloat,vt={};function xt(t){for(var e=Object.keys(t),r=(e.sort(),[]),i=0;i<e.length;i++){var n=e[i],o=t[n];r.push(null===o?n:n+" "+o.toString())}return r.join("\n")}const Tt=P.extend(function(){return{name:"",depthTest:!0,depthMask:!0,transparent:!1,blend:null,autoUpdateTextureStatus:!0,uniforms:{},vertexDefines:{},fragmentDefines:{},_textureStatus:{},_enabledUniforms:null}},function(){this.name||(this.name="MATERIAL_"+this.__uid__),this.shader&&this.attachShader(this.shader,!0)},{precision:"highp",setUniform:function(t,e){void 0===e&&console.warn('Uniform value "'+t+'" is undefined');var r=this.uniforms[t];r&&("string"==typeof e&&(e=yt(e)||e),r.value=e,this.autoUpdateTextureStatus)&&"t"===r.type&&(e?this.enableTexture(t):this.disableTexture(t))},setUniforms:function(t){for(var e in t){var r=t[e];this.setUniform(e,r)}},isUniformEnabled:function(t){return 0<=this._enabledUniforms.indexOf(t)},getEnabledUniforms:function(){return this._enabledUniforms},getTextureUniforms:function(){return this._textureUniforms},set:function(t,e){if("object"==typeof t)for(var r in t){var i=t[r];this.setUniform(r,i)}else this.setUniform(t,e)},get:function(t){t=this.uniforms[t];if(t)return t.value},attachShader:function(t,e){var r=this.uniforms,i=(this.uniforms=t.createUniforms(),this.shader=t,this.uniforms),n=(this._enabledUniforms=Object.keys(i),this._enabledUniforms.sort(),this._textureUniforms=this._enabledUniforms.filter(function(t){t=this.uniforms[t].type;return"t"===t||"tv"===t},this),this.vertexDefines),o=this.fragmentDefines;if(this.vertexDefines=W.clone(t.vertexDefines),this.fragmentDefines=W.clone(t.fragmentDefines),e){for(var a in r)i[a]&&(i[a].value=r[a].value);W.defaults(this.vertexDefines,n),W.defaults(this.fragmentDefines,o)}var s,l={};for(s in t.textures)l[s]={shaderType:t.textures[s].shaderType,type:t.textures[s].type,enabled:!(!e||!this._textureStatus[s])&&this._textureStatus[s].enabled};this._textureStatus=l,this._programKey=""},clone:function(){var t,e=new this.constructor({name:this.name,shader:this.shader});for(t in this.uniforms)e.uniforms[t].value=this.uniforms[t].value;return e.depthTest=this.depthTest,e.depthMask=this.depthMask,e.transparent=this.transparent,e.blend=this.blend,e.vertexDefines=W.clone(this.vertexDefines),e.fragmentDefines=W.clone(this.fragmentDefines),e.enableTexture(this.getEnabledTextures()),e.precision=this.precision,e},define:function(t,e,r){var i=this.vertexDefines,n=this.fragmentDefines;"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<3&&(r=e,e=t,t="both"),r=null!=r?r:null,"vertex"!==t&&"both"!==t||i[e]!==r&&(i[e]=r,this._programKey=""),"fragment"!==t&&"both"!==t||n[e]!==r&&(n[e]=r,"both"!==t)&&(this._programKey="")},undefine:function(t,e){"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<2&&(e=t,t="both"),"vertex"!==t&&"both"!==t||this.isDefined("vertex",e)&&(delete this.vertexDefines[e],this._programKey=""),"fragment"!==t&&"both"!==t||this.isDefined("fragment",e)&&(delete this.fragmentDefines[e],"both"!==t)&&(this._programKey="")},isDefined:function(t,e){switch(t){case"vertex":return void 0!==this.vertexDefines[e];case"fragment":return void 0!==this.fragmentDefines[e]}},getDefine:function(t,e){switch(t){case"vertex":return this.vertexDefines[e];case"fragment":return this.fragmentDefines[e]}},enableTexture:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.enableTexture(t[e]);else{var r=this._textureStatus[t];r&&!r.enabled&&(r.enabled=!0,this._programKey="")}},enableTexturesAll:function(){var t,e=this._textureStatus;for(t in e)e[t].enabled=!0;this._programKey=""},disableTexture:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.disableTexture(t[e]);else{var r=this._textureStatus[t];r&&r.enabled&&(r.enabled=!1,this._programKey="")}},disableTexturesAll:function(){var t,e=this._textureStatus;for(t in e)e[t].enabled=!1;this._programKey=""},isTextureEnabled:function(t){var e=this._textureStatus;return!!e[t]&&e[t].enabled},getEnabledTextures:function(){var t,e=[],r=this._textureStatus;for(t in r)r[t].enabled&&e.push(t);return e},dirtyDefines:function(){this._programKey=""},getProgramKey:function(){return this._programKey||(this._programKey=function(t,e,r){r.sort();for(var i=[],n=0;n<r.length;n++){var o=r[n];i.push(o)}return t=xt(t)+"\n"+xt(e)+"\n"+i.join("\n"),vt[t]||(e=W.genGUID(),vt[t]=e)}(this.vertexDefines,this.fragmentDefines,this.getEnabledTextures())),this._programKey}});var bt,wt=Array,St=Math.random,t={create:function(){var t=new wt(2);return t[0]=0,t[1]=0,t},clone:function(t){var e=new wt(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var r=new wt(2);return r[0]=t,r[1]=e,r},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,r){return t[0]=e,t[1]=r,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}};t.sub=t.subtract,t.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t},t.mul=t.multiply,t.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t},t.div=t.divide,t.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},t.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},t.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},t.scaleAndAdd=function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t},t.distance=function(t,e){var r=e[0]-t[0],e=e[1]-t[1];return Math.sqrt(r*r+e*e)},t.dist=t.distance,t.squaredDistance=function(t,e){var r=e[0]-t[0],e=e[1]-t[1];return r*r+e*e},t.sqrDist=t.squaredDistance,t.length=function(t){var e=t[0],t=t[1];return Math.sqrt(e*e+t*t)},t.len=t.length,t.squaredLength=function(t){var e=t[0],t=t[1];return e*e+t*t},t.sqrLen=t.squaredLength,t.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},t.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},t.normalize=function(t,e){var r=e[0],i=e[1],r=r*r+i*i;return 0<r&&(r=1/Math.sqrt(r),t[0]=e[0]*r,t[1]=e[1]*r),t},t.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},t.cross=function(t,e,r){e=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=e,t},t.lerp=function(t,e,r,i){var n=e[0],e=e[1];return t[0]=n+i*(r[0]-n),t[1]=e+i*(r[1]-e),t},t.random=function(t,e){e=e||1;var r=2*GLMAT_RANDOM()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},t.transformMat2=function(t,e,r){var i=e[0],e=e[1];return t[0]=r[0]*i+r[2]*e,t[1]=r[1]*i+r[3]*e,t},t.transformMat2d=function(t,e,r){var i=e[0],e=e[1];return t[0]=r[0]*i+r[2]*e+r[4],t[1]=r[1]*i+r[3]*e+r[5],t},t.transformMat3=function(t,e,r){var i=e[0],e=e[1];return t[0]=r[0]*i+r[3]*e+r[6],t[1]=r[1]*i+r[4]*e+r[7],t},t.transformMat4=function(t,e,r){var i=e[0],e=e[1];return t[0]=r[0]*i+r[4]*e+r[12],t[1]=r[1]*i+r[5]*e+r[13],t},t.forEach=(bt=t.create(),function(t,e,r,i,n,o){var a,s;for(e=e||2,r=r||0,s=i?Math.min(i*e+r,t.length):t.length,a=r;a<s;a+=e)bt[0]=t[a],bt[1]=t[a+1],n(bt,bt,o),t[a]=bt[0],t[a+1]=bt[1];return t});const n=t;function r(t,e){t=t||0,e=e||0,this.array=n.fromValues(t,e),this._dirty=!0}r.prototype={constructor:r,add:function(t){return n.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e){return this.array[0]=t,this.array[1]=e,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this._dirty=!0,this},clone:function(){return new r(this.x,this.y)},copy:function(t){return n.copy(this.array,t.array),this._dirty=!0,this},cross:function(t,e){return n.cross(t.array,this.array,e.array),t._dirty=!0,this},dist:function(t){return n.dist(this.array,t.array)},distance:function(t){return n.distance(this.array,t.array)},div:function(t){return n.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return n.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return n.dot(this.array,t.array)},len:function(){return n.len(this.array)},length:function(){return n.length(this.array)},lerp:function(t,e,r){return n.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return n.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return n.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return n.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return n.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return n.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return n.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return n.random(this.array,t),this._dirty=!0,this},scale:function(t){return n.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return n.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return n.sqrDist(this.array,t.array)},squaredDistance:function(t){return n.squaredDistance(this.array,t.array)},sqrLen:function(){return n.sqrLen(this.array)},squaredLength:function(){return n.squaredLength(this.array)},sub:function(t){return n.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return n.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat2:function(t){return n.transformMat2(this.array,this.array,t.array),this._dirty=!0,this},transformMat2d:function(t){return n.transformMat2d(this.array,this.array,t.array),this._dirty=!0,this},transformMat3:function(t){return n.transformMat3(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return n.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Object.defineProperty&&(e=r.prototype,Object.defineProperty(e,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),Object.defineProperty(e,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}})),r.add=function(t,e,r){return n.add(t.array,e.array,r.array),t._dirty=!0,t},r.set=function(t,e,r){return n.set(t.array,e,r),t._dirty=!0,t},r.copy=function(t,e){return n.copy(t.array,e.array),t._dirty=!0,t},r.cross=function(t,e,r){return n.cross(t.array,e.array,r.array),t._dirty=!0,t},r.distance=r.dist=function(t,e){return n.distance(t.array,e.array)},r.divide=r.div=function(t,e,r){return n.divide(t.array,e.array,r.array),t._dirty=!0,t},r.dot=function(t,e){return n.dot(t.array,e.array)},r.len=function(t){return n.length(t.array)},r.lerp=function(t,e,r,i){return n.lerp(t.array,e.array,r.array,i),t._dirty=!0,t},r.min=function(t,e,r){return n.min(t.array,e.array,r.array),t._dirty=!0,t},r.max=function(t,e,r){return n.max(t.array,e.array,r.array),t._dirty=!0,t},r.multiply=r.mul=function(t,e,r){return n.multiply(t.array,e.array,r.array),t._dirty=!0,t},r.negate=function(t,e){return n.negate(t.array,e.array),t._dirty=!0,t},r.normalize=function(t,e){return n.normalize(t.array,e.array),t._dirty=!0,t},r.random=function(t,e){return n.random(t.array,e),t._dirty=!0,t},r.scale=function(t,e,r){return n.scale(t.array,e.array,r),t._dirty=!0,t},r.scaleAndAdd=function(t,e,r,i){return n.scaleAndAdd(t.array,e.array,r.array,i),t._dirty=!0,t},r.squaredDistance=r.sqrDist=function(t,e){return n.sqrDist(t.array,e.array)},r.squaredLength=r.sqrLen=function(t){return n.sqrLen(t.array)},r.subtract=r.sub=function(t,e,r){return n.subtract(t.array,e.array,r.array),t._dirty=!0,t},r.transformMat2=function(t,e,r){return n.transformMat2(t.array,e.array,r.array),t._dirty=!0,t},r.transformMat2d=function(t,e,r){return n.transformMat2d(t.array,e.array,r.array),t._dirty=!0,t},r.transformMat3=function(t,e,r){return n.transformMat3(t.array,e.array,r.array),t._dirty=!0,t},r.transformMat4=function(t,e,r){return n.transformMat4(t.array,e.array,r.array),t._dirty=!0,t};const Et=r;var Mt={};function At(t,e,r){if(!t.getShaderParameter(e,t.COMPILE_STATUS))return[t.getShaderInfoLog(e),function(t){for(var e=t.split("\n"),r=0,i=e.length;r<i;r++)e[r]=r+1+": "+e[r];return e.join("\n")}(r)].join("\n")}var Ct=new $.Float32Array(16);const Dt=P.extend({uniformSemantics:{},attributes:{}},function(){this._locations={},this._textureSlot=0,this._program=null},{bind:function(t){this._textureSlot=0,t.gl.useProgram(this._program)},hasUniform:function(t){t=this._locations[t];return null!=t},useTextureSlot:function(t,e,r){e&&(t.gl.activeTexture(t.gl.TEXTURE0+r),e.isRenderable()?e.bind(t):e.unbind(t))},currentTextureSlot:function(){return this._textureSlot},resetTextureSlot:function(t){this._textureSlot=t||0},takeCurrentTextureSlot:function(t,e){var r=this._textureSlot;return this.useTextureSlot(t,e,r),this._textureSlot++,r},setUniform:function(t,e,r,i){var n=this._locations[r];if(null==n)return!1;switch(e){case"m4":if(!(i instanceof Float32Array)){for(var o=0;o<i.length;o++)Ct[o]=i[o];i=Ct}t.uniformMatrix4fv(n,!1,i);break;case"2i":t.uniform2i(n,i[0],i[1]);break;case"2f":t.uniform2f(n,i[0],i[1]);break;case"3i":t.uniform3i(n,i[0],i[1],i[2]);break;case"3f":t.uniform3f(n,i[0],i[1],i[2]);break;case"4i":t.uniform4i(n,i[0],i[1],i[2],i[3]);break;case"4f":t.uniform4f(n,i[0],i[1],i[2],i[3]);break;case"1i":t.uniform1i(n,i);break;case"1f":t.uniform1f(n,i);break;case"1fv":t.uniform1fv(n,i);break;case"1iv":t.uniform1iv(n,i);break;case"2iv":t.uniform2iv(n,i);break;case"2fv":t.uniform2fv(n,i);break;case"3iv":t.uniform3iv(n,i);break;case"3fv":t.uniform3fv(n,i);break;case"4iv":t.uniform4iv(n,i);break;case"4fv":t.uniform4fv(n,i);break;case"m2":case"m2v":t.uniformMatrix2fv(n,!1,i);break;case"m3":case"m3v":t.uniformMatrix3fv(n,!1,i);break;case"m4v":if(Array.isArray(i)&&Array.isArray(i[0])){for(var a=new $.Float32Array(16*i.length),s=0,o=0;o<i.length;o++)for(var l=i[o],h=0;h<16;h++)a[s++]=l[h];t.uniformMatrix4fv(n,!1,a)}else t.uniformMatrix4fv(n,!1,i)}return!0},setUniformOfSemantic:function(t,e,r){e=this.uniformSemantics[e];return!!e&&this.setUniform(t,e.type,e.symbol,r)},enableAttributes:function(t,e,r){var i=t.gl,n=this._program,o=this._locations,a=r?r.__enabledAttributeList:Mt[t.__uid__];a=a||(r?r.__enabledAttributeList=[]:Mt[t.__uid__]=[]);for(var s=[],l=0;l<e.length;l++){var h=e[l];if(this.attributes[h]){var u=o[h];if(null==u){if(-1===(u=i.getAttribLocation(n,h))){s[l]=-1;continue}o[h]=u}a[s[l]=u]?a[u]=2:a[u]=1}else s[l]=-1}for(l=0;l<a.length;l++)switch(a[l]){case 1:i.enableVertexAttribArray(l),a[l]=3;break;case 2:a[l]=3;break;case 3:i.disableVertexAttribArray(l),a[l]=0}return s},getAttribLocation:function(t,e){var r=this._locations,i=r[e];return null==i&&(i=t.getAttribLocation(this._program,e),r[e]=i),i},buildProgram:function(t,e,r,i){var n=t.createShader(t.VERTEX_SHADER),o=t.createProgram(),a=(t.shaderSource(n,r),t.compileShader(n),t.createShader(t.FRAGMENT_SHADER)),s=(t.shaderSource(a,i),t.compileShader(a),At(t,n,r));if(s)return s;if(s=At(t,a,i))return s;if(t.attachShader(o,n),t.attachShader(o,a),e.attributeSemantics.POSITION?t.bindAttribLocation(o,0,e.attributeSemantics.POSITION.symbol):(s=Object.keys(this.attributes),t.bindAttribLocation(o,0,s[0])),t.linkProgram(o),t.deleteShader(n),t.deleteShader(a),this._program=o,this.vertexCode=r,this.fragmentCode=i,!t.getProgramParameter(o,t.LINK_STATUS))return"Could not link program\n"+t.getProgramInfoLog(o);for(var l=0;l<e.uniforms.length;l++){var h=e.uniforms[l];this._locations[h]=t.getUniformLocation(o,h)}}});var Lt=/for\s*?\(int\s*?_idx_\s*\=\s*([\w-]+)\;\s*_idx_\s*<\s*([\w-]+);\s*_idx_\s*\+\+\s*\)\s*\{\{([\s\S]+?)(?=\}\})\}\}/g;function Pt(t,a,e){var r,s={};for(r in e)s[r+"_COUNT"]=e[r];return t.replace(Lt,function(t,e,r,i){var n="";isNaN(e)&&(e=(e in a?a:s)[e]),isNaN(r)&&(r=(r in a?a:s)[r]);for(var o=parseInt(e);o<parseInt(r);o++)n+="{"+i.replace(/float\s*\(\s*_idx_\s*\)/g,o.toFixed(1)).replace(/_idx_/g,o)+"}";return n})}function Nt(t,e,r){var i=[];if(e)for(var n in e){var o=e[n];0<o&&i.push("#define "+n.toUpperCase()+"_COUNT "+o)}if(r)for(var a=0;a<r.length;a++){var s=r[a];i.push("#define "+s.toUpperCase()+"_ENABLED")}for(s in t){var l=t[s];i.push(null===l?"#define "+s:"#define "+s+" "+l.toString())}return i.join("\n")}function Rt(t){this._renderer=t,this._cache={}}Rt.prototype.getProgram=function(t,e,r){var i,n,o,a,s=this._cache,l=t.isSkinnedMesh&&t.isSkinnedMesh(),h=t.isInstancedMesh&&t.isInstancedMesh(),u="s"+e.shader.shaderID+"m"+e.getProgramKey(),c=(r&&(u+="se"+r.getProgramKey(t.lightGroup)),l&&(u+=",sk"+t.joints.length),h&&(u+=",is"),s[u]);return c||(r=r?r.getLightsNumbers(t.lightGroup):{},n=(i=this._renderer).gl,a=e.getEnabledTextures(),o="",l&&(l={SKINNING:null,JOINT_COUNT:t.joints.length},t.joints.length>i.getMaxJointNumber()&&(l.USE_SKIN_MATRICES_TEXTURE=null),o+="\n"+Nt(l)+"\n"),h&&(o+="\n#define INSTANCING\n"),t=o+Nt(e.vertexDefines,r,a),l=o+Nt(e.fragmentDefines,r,a),h=t+"\n"+e.shader.vertex,0<=(o=["OES_standard_derivatives","EXT_shader_texture_lod"].filter(function(t){return null!=i.getGLExtension(t)})).indexOf("EXT_shader_texture_lod")&&(l+="\n#define SUPPORT_TEXTURE_LOD"),0<=o.indexOf("OES_standard_derivatives")&&(l+="\n#define SUPPORT_STANDARD_DERIVATIVES"),t=function(t){for(var e=[],r=0;r<t.length;r++)e.push("#extension GL_"+t[r]+" : enable");return e.join("\n")}(o)+"\n"+["precision",a=e.precision,"float"].join(" ")+";\n"+["precision",a,"int"].join(" ")+";\n"+["precision",a,"sampler2D"].join(" ")+";\n\n"+l+"\n"+e.shader.fragment,o=Pt(h,e.vertexDefines,r),a=Pt(t,e.fragmentDefines,r),(c=new Dt).uniformSemantics=e.shader.uniformSemantics,c.attributes=e.shader.attributes,l=c.buildProgram(n,e.shader,o,a),c.__error=l,s[u]=c),c};const It=Rt;var Ot=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+([\s\S]*?);/g,Bt=/attribute\s+(float|int|vec2|vec3|vec4)\s+([\s\S]*?);/g,Ft=/#define\s+(\w+)?(\s+[\d-.]+)?\s*;?\s*\n/g,zt={bool:"1i",int:"1i",sampler2D:"t",samplerCube:"t",float:"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"};function Ut(t){for(var e=[],r=0;r<t;r++)e[r]=0;return e}var kt={bool:function(){return!0},int:function(){return 0},float:function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return Ut(2)},vec3:function(){return Ut(3)},vec4:function(){return Ut(4)},ivec2:function(){return Ut(2)},ivec3:function(){return Ut(3)},ivec4:function(){return Ut(4)},mat2:function(){return Ut(4)},mat3:function(){return Ut(9)},mat4:function(){return Ut(16)},array:function(){return[]}},Gt=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","JOINT","WEIGHT"],Ht=["SKIN_MATRIX","VIEWPORT_SIZE","VIEWPORT","DEVICEPIXELRATIO","WINDOW_SIZE","NEAR","FAR","TIME"],Vt=["WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],Wt={vec4:4,vec3:3,vec2:2,float:1},Xt={},jt={};function qt(t){return t.replace(/[ \t]*\/\/.*\n/g,"").replace(/[ \t]*\/\*[\s\S]*?\*\//g,"")}function Zt(){console.error("Wrong uniform/attributes syntax")}function Yt(t,e){for(var r=/[,=\(\):]/,i=e.replace(/:\s*\[\s*(.*)\s*\]/g,"="+t+"($1)").replace(/\s+/g,"").split(/(?=[,=\(\):])/g),n=[],o=0;o<i.length;o++)i[o].match(r)?n.push(i[o].charAt(0),i[o].slice(1)):n.push(i[o]);var a,s=0,l={},h=null;function u(t){t||Zt();var e=t.match(/\[(.*?)\]/);a=t.replace(/\[(.*?)\]/,""),l[a]={},e&&(l[a].isArray=!0,l[a].arraySize=e[1])}u((i=n)[0]);for(o=1;o<i.length;o++){var c,d=i[o];if(d)if("="===d){if(0!==s&&3!==s){Zt();break}s=1}else if(":"===d)s=4;else if(","===d)if(2===s){if(!(h instanceof Array)){Zt();break}h.push(+i[++o])}else s=5;else if(")"===d)l[a].value=new $.Float32Array(h),h=null,s=5;else if("("===d){if(2!==s){Zt();break}if(!(h instanceof Array)){Zt();break}h.push(+i[++o])}else if(0<=d.indexOf("vec")){if(1!==s&&4!==s){Zt();break}s=2,h=[]}else 1===s?(l[a].value="bool"===t?"true"===d:parseFloat(d),h=null):4===s?0<=Gt.indexOf(c=d)||0<=Ht.indexOf(c)||0<=Vt.indexOf(c)?l[a].semantic=c:"ignore"===c||"unconfigurable"===c?l[a].ignore=!0:l[a].value="bool"===t?"true"===c:parseFloat(c):(u(d),s=0)}return l}function Kt(t,e){var r,i,n,o;"object"==typeof t&&(e=t.fragment,t=t.vertex),t=qt(t),e=qt(e),this._shaderID=Xt[o="vertex:"+(r=t)+"fragment:"+(i=e)]||(n=W.genGUID(),Xt[o]=n,jt[n]={vertex:r,fragment:i},n),this._vertexCode=Kt.parseImport(t),this._fragmentCode=Kt.parseImport(e),this.attributeSemantics={},this.matrixSemantics={},this.uniformSemantics={},this.matrixSemanticKeys=[],this.uniformTemplates={},this.attributes={},this.textures={},this.vertexDefines={},this.fragmentDefines={},this._parseAttributes(),this._parseUniforms(),this._parseDefines()}Kt.prototype={constructor:Kt,createUniforms:function(){var t,e={};for(t in this.uniformTemplates){var r=this.uniformTemplates[t];e[t]={type:r.type,value:r.value()}}return e},_parseImport:function(){this._vertexCode=Kt.parseImport(this.vertex),this._fragmentCode=Kt.parseImport(this.fragment)},_addSemanticUniform:function(t,e,r){var i,n;0<=Gt.indexOf(r)?this.attributeSemantics[r]={symbol:t,type:e}:0<=Vt.indexOf(r)?(i=!1,(n=r).match(/TRANSPOSE$/)&&(i=!0,n=r.slice(0,-9)),this.matrixSemantics[r]={symbol:t,type:e,isTranspose:i,semanticNoTranspose:n}):0<=Ht.indexOf(r)&&(this.uniformSemantics[r]={symbol:t,type:e})},_addMaterialUniform:function(t,e,r,i,n,o){o[t]={type:r,value:n?kt.array:i||kt[e],semantic:null}},_parseUniforms:function(){var c={},d=this,f="vertex";function t(t,e,r){var i,n=Yt(e,r),o=[];for(i in n){var a=n[i],s=a.semantic,l=i,h=zt[e],u=function(t){return null!=t?function(){return t}:null}(n[i].value);n[i].isArray&&(l+="["+n[i].arraySize+"]",h+="v"),o.push(l),d._uniformList.push(i),a.ignore||("sampler2D"!==e&&"samplerCube"!==e||(d.textures[i]={shaderType:f,type:e}),s?d._addSemanticUniform(i,h,s):d._addMaterialUniform(i,e,h,u,n[i].isArray,c))}return 0<o.length?"uniform "+e+" "+o.join(",")+";\n":""}this._uniformList=[],this._vertexCode=this._vertexCode.replace(Ot,t),f="fragment",this._fragmentCode=this._fragmentCode.replace(Ot,t),d.matrixSemanticKeys=Object.keys(this.matrixSemantics),this.uniformTemplates=c},_parseAttributes:function(){var l={},h=this;this._vertexCode=this._vertexCode.replace(Bt,function(t,e,r){var i,n=Yt(e,r),o=Wt[e]||1,a=[];for(i in n){var s=n[i].semantic;if(l[i]={type:"float",size:o,semantic:s||null},s){if(Gt.indexOf(s)<0)throw new Error('Unkown semantic "'+s+'"');h.attributeSemantics[s]={symbol:i,type:e}}a.push(i)}return"attribute "+e+" "+a.join(",")+";\n"}),this.attributes=l},_parseDefines:function(){var n=this,o="vertex";function t(t,e,r){var i="vertex"===o?n.vertexDefines:n.fragmentDefines;return i[e]||(i[e]="false"!==r&&("true"===r||(r?isNaN(parseFloat(r))?r.trim():parseFloat(r):null))),""}this._vertexCode=this._vertexCode.replace(Ft,t),o="fragment",this._fragmentCode=this._fragmentCode.replace(Ft,t)},clone:function(){var t=jt[this._shaderID];return new Kt(t.vertex,t.fragment)}},Object.defineProperty&&(Object.defineProperty(Kt.prototype,"shaderID",{get:function(){return this._shaderID}}),Object.defineProperty(Kt.prototype,"vertex",{get:function(){return this._vertexCode}}),Object.defineProperty(Kt.prototype,"fragment",{get:function(){return this._fragmentCode}}),Object.defineProperty(Kt.prototype,"uniforms",{get:function(){return this._uniformList}}));var Qt=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g,Jt=(Kt.parseImport=function(t){return t=t.replace(Qt,function(t,e,r){return(t=Kt.source(r))?Kt.parseImport(t):(console.error('Shader chunk "'+r+'" not existed in library'),"")})},/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g);Kt.import=function(t){t.replace(Jt,function(t,e,r,i){if(i=i.replace(/(^[\s\t\xa0\u3000]+)|([\u3000\xa0\s\t]+\x24)/g,"")){for(var n,o=r.split("."),a=Kt.codes,s=0;s<o.length-1;)a[n=o[s++]]||(a[n]={}),a=a[n];a[n=o[s]]=i}return i})},Kt.codes={},Kt.source=function(t){for(var e=t.split("."),r=Kt.codes,i=0;r&&i<e.length;)r=r[e[i++]];return"string"!=typeof r?(console.error('Shader "'+t+'" not existed in library'),""):r};const S=Kt;var Q="@export clay.prez.vertex\nuniform mat4 WVP : WORLDVIEWPROJECTION;\nattribute vec3 pos : POSITION;\nattribute vec2 uv : TEXCOORD_0;\nuniform vec2 uvRepeat : [1.0, 1.0];\nuniform vec2 uvOffset : [0.0, 0.0];\n@import clay.chunk.skinning_header\n@import clay.chunk.instancing_header\nvarying vec2 v_Texcoord;\nvoid main()\n{\n vec4 P = vec4(pos, 1.0);\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n P = skinMatrixWS * P;\n#endif\n#ifdef INSTANCING\n @import clay.chunk.instancing_matrix\n P = instanceMat * P;\n#endif\n gl_Position = WVP * P;\n v_Texcoord = uv * uvRepeat + uvOffset;\n}\n@end\n@export clay.prez.fragment\nuniform sampler2D alphaMap;\nuniform float alphaCutoff: 0.0;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n if (alphaCutoff > 0.0) {\n if (texture2D(alphaMap, v_Texcoord).a <= alphaCutoff) {\n discard;\n }\n }\n gl_FragColor = vec4(0.0,0.0,0.0,1.0);\n}\n@end",$t={create:function(){var t=new wt(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},clone:function(t){var e=new wt(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transpose:function(t,e){var r,i,n,o,a,s;return t===e?(r=e[1],i=e[2],n=e[3],o=e[6],a=e[7],s=e[11],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=o,t[11]=e[14],t[12]=n,t[13]=a,t[14]=s):(t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]),t},invert:function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],p=e[12],m=e[13],g=e[14],e=e[15],_=r*s-i*a,y=r*l-n*a,v=r*h-o*a,x=i*l-n*s,T=i*h-o*s,b=n*h-o*l,w=u*m-c*p,S=u*g-d*p,E=u*e-f*p,M=c*g-d*m,A=c*e-f*m,C=d*e-f*g,D=_*C-y*A+v*M+x*E-T*S+b*w;return D?(t[0]=(s*C-l*A+h*M)*(D=1/D),t[1]=(n*A-i*C-o*M)*D,t[2]=(m*b-g*T+e*x)*D,t[3]=(d*T-c*b-f*x)*D,t[4]=(l*E-a*C-h*S)*D,t[5]=(r*C-n*E+o*S)*D,t[6]=(g*v-p*b-e*y)*D,t[7]=(u*b-d*v+f*y)*D,t[8]=(a*A-s*E+h*w)*D,t[9]=(i*E-r*A-o*w)*D,t[10]=(p*T-m*v+e*_)*D,t[11]=(c*v-u*T-f*_)*D,t[12]=(s*S-a*M-l*w)*D,t[13]=(r*M-i*S+n*w)*D,t[14]=(m*y-p*x-g*_)*D,t[15]=(u*x-c*y+d*_)*D,t):null},adjoint:function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],p=e[12],m=e[13],g=e[14],e=e[15];return t[0]=s*(d*e-f*g)-c*(l*e-h*g)+m*(l*f-h*d),t[1]=-(i*(d*e-f*g)-c*(n*e-o*g)+m*(n*f-o*d)),t[2]=i*(l*e-h*g)-s*(n*e-o*g)+m*(n*h-o*l),t[3]=-(i*(l*f-h*d)-s*(n*f-o*d)+c*(n*h-o*l)),t[4]=-(a*(d*e-f*g)-u*(l*e-h*g)+p*(l*f-h*d)),t[5]=r*(d*e-f*g)-u*(n*e-o*g)+p*(n*f-o*d),t[6]=-(r*(l*e-h*g)-a*(n*e-o*g)+p*(n*h-o*l)),t[7]=r*(l*f-h*d)-a*(n*f-o*d)+u*(n*h-o*l),t[8]=a*(c*e-f*m)-u*(s*e-h*m)+p*(s*f-h*c),t[9]=-(r*(c*e-f*m)-u*(i*e-o*m)+p*(i*f-o*c)),t[10]=r*(s*e-h*m)-a*(i*e-o*m)+p*(i*h-o*s),t[11]=-(r*(s*f-h*c)-a*(i*f-o*c)+u*(i*h-o*s)),t[12]=-(a*(c*g-d*m)-u*(s*g-l*m)+p*(s*d-l*c)),t[13]=r*(c*g-d*m)-u*(i*g-n*m)+p*(i*d-n*c),t[14]=-(r*(s*g-l*m)-a*(i*g-n*m)+p*(i*l-n*s)),t[15]=r*(s*d-l*c)-a*(i*d-n*c)+u*(i*l-n*s),t},determinant:function(t){var e=t[0],r=t[1],i=t[2],n=t[3],o=t[4],a=t[5],s=t[6],l=t[7],h=t[8],u=t[9],c=t[10],d=t[11],f=t[12],p=t[13],m=t[14],t=t[15];return(e*a-r*o)*(c*t-d*m)-(e*s-i*o)*(u*t-d*p)+(e*l-n*o)*(u*m-c*p)+(r*s-i*a)*(h*t-d*f)-(r*l-n*a)*(h*m-c*f)+(i*l-n*s)*(h*p-u*f)},multiply:function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],p=e[11],m=e[12],g=e[13],_=e[14],e=e[15],y=r[0],v=r[1],x=r[2],T=r[3];return t[0]=y*i+v*s+x*c+T*m,t[1]=y*n+v*l+x*d+T*g,t[2]=y*o+v*h+x*f+T*_,t[3]=y*a+v*u+x*p+T*e,y=r[4],v=r[5],x=r[6],T=r[7],t[4]=y*i+v*s+x*c+T*m,t[5]=y*n+v*l+x*d+T*g,t[6]=y*o+v*h+x*f+T*_,t[7]=y*a+v*u+x*p+T*e,y=r[8],v=r[9],x=r[10],T=r[11],t[8]=y*i+v*s+x*c+T*m,t[9]=y*n+v*l+x*d+T*g,t[10]=y*o+v*h+x*f+T*_,t[11]=y*a+v*u+x*p+T*e,y=r[12],v=r[13],x=r[14],T=r[15],t[12]=y*i+v*s+x*c+T*m,t[13]=y*n+v*l+x*d+T*g,t[14]=y*o+v*h+x*f+T*_,t[15]=y*a+v*u+x*p+T*e,t},multiplyAffine:function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[4],s=e[5],l=e[6],h=e[8],u=e[9],c=e[10],d=e[12],f=e[13],e=e[14],p=r[0],m=r[1],g=r[2];return t[0]=p*i+m*a+g*h,t[1]=p*n+m*s+g*u,t[2]=p*o+m*l+g*c,p=r[4],m=r[5],g=r[6],t[4]=p*i+m*a+g*h,t[5]=p*n+m*s+g*u,t[6]=p*o+m*l+g*c,p=r[8],m=r[9],g=r[10],t[8]=p*i+m*a+g*h,t[9]=p*n+m*s+g*u,t[10]=p*o+m*l+g*c,p=r[12],m=r[13],g=r[14],t[12]=p*i+m*a+g*h+d,t[13]=p*n+m*s+g*u+f,t[14]=p*o+m*l+g*c+e,t}};$t.mul=$t.multiply,$t.mulAffine=$t.multiplyAffine,$t.translate=function(t,e,r){var i,n,o,a,s,l,h,u,c,d,f,p,m=r[0],g=r[1],r=r[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*r+e[12],t[13]=e[1]*m+e[5]*g+e[9]*r+e[13],t[14]=e[2]*m+e[6]*g+e[10]*r+e[14],t[15]=e[3]*m+e[7]*g+e[11]*r+e[15]):(i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],p=e[11],t[0]=i,t[1]=n,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=d,t[10]=f,t[11]=p,t[12]=i*m+s*g+c*r+e[12],t[13]=n*m+l*g+d*r+e[13],t[14]=o*m+h*g+f*r+e[14],t[15]=a*m+u*g+p*r+e[15]),t},$t.scale=function(t,e,r){var i=r[0],n=r[1],r=r[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},$t.rotate=function(t,e,r,i){var n,o,a,s,l,h,u,c,d,f,p,m,g,_,y,v,x,T,b,w,S=i[0],E=i[1],i=i[2],M=Math.sqrt(S*S+E*E+i*i);return Math.abs(M)<1e-6?null:(S*=M=1/M,E*=M,i*=M,M=Math.sin(r),r=Math.cos(r),o=e[0],a=e[1],s=e[2],l=e[3],h=e[4],u=e[5],c=e[6],d=e[7],f=e[8],p=e[9],m=e[10],g=e[11],y=S*E*(n=1-r)-i*M,v=E*E*n+r,x=i*E*n+S*M,T=S*i*n+E*M,b=E*i*n-S*M,w=i*i*n+r,t[0]=o*(r=S*S*n+r)+h*(_=E*S*n+i*M)+f*(i=i*S*n-E*M),t[1]=a*r+u*_+p*i,t[2]=s*r+c*_+m*i,t[3]=l*r+d*_+g*i,t[4]=o*y+h*v+f*x,t[5]=a*y+u*v+p*x,t[6]=s*y+c*v+m*x,t[7]=l*y+d*v+g*x,t[8]=o*T+h*b+f*w,t[9]=a*T+u*b+p*w,t[10]=s*T+c*b+m*w,t[11]=l*T+d*b+g*w,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},$t.rotateX=function(t,e,r){var i=Math.sin(r),r=Math.cos(r),n=e[4],o=e[5],a=e[6],s=e[7],l=e[8],h=e[9],u=e[10],c=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*r+l*i,t[5]=o*r+h*i,t[6]=a*r+u*i,t[7]=s*r+c*i,t[8]=l*r-n*i,t[9]=h*r-o*i,t[10]=u*r-a*i,t[11]=c*r-s*i,t},$t.rotateY=function(t,e,r){var i=Math.sin(r),r=Math.cos(r),n=e[0],o=e[1],a=e[2],s=e[3],l=e[8],h=e[9],u=e[10],c=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r-l*i,t[1]=o*r-h*i,t[2]=a*r-u*i,t[3]=s*r-c*i,t[8]=n*i+l*r,t[9]=o*i+h*r,t[10]=a*i+u*r,t[11]=s*i+c*r,t},$t.rotateZ=function(t,e,r){var i=Math.sin(r),r=Math.cos(r),n=e[0],o=e[1],a=e[2],s=e[3],l=e[4],h=e[5],u=e[6],c=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r+l*i,t[1]=o*r+h*i,t[2]=a*r+u*i,t[3]=s*r+c*i,t[4]=l*r-n*i,t[5]=h*r-o*i,t[6]=u*r-a*i,t[7]=c*r-s*i,t},$t.fromRotationTranslation=function(t,e,r){var i=e[0],n=e[1],o=e[2],e=e[3],a=i+i,s=n+n,l=o+o,h=i*a,u=i*s,i=i*l,c=n*s,n=n*l,o=o*l,a=e*a,s=e*s,e=e*l;return t[0]=1-(c+o),t[1]=u+e,t[2]=i-s,t[3]=0,t[4]=u-e,t[5]=1-(h+o),t[6]=n+a,t[7]=0,t[8]=i+s,t[9]=n-a,t[10]=1-(h+c),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},$t.fromQuat=function(t,e){var r=e[0],i=e[1],n=e[2],e=e[3],o=r+r,a=i+i,s=n+n,r=r*o,l=i*o,i=i*a,h=n*o,u=n*a,n=n*s,o=e*o,a=e*a,e=e*s;return t[0]=1-i-n,t[1]=l+e,t[2]=h-a,t[3]=0,t[4]=l-e,t[5]=1-r-n,t[6]=u+o,t[7]=0,t[8]=h+a,t[9]=u-o,t[10]=1-r-i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},$t.frustum=function(t,e,r,i,n,o,a){var s=1/(r-e),l=1/(n-i),h=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*l,t[6]=0,t[7]=0,t[8]=(r+e)*s,t[9]=(n+i)*l,t[10]=(a+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*h,t[15]=0,t},$t.perspective=function(t,e,r,i,n){var e=1/Math.tan(e/2),o=1/(i-n);return t[0]=e/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(n+i)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*n*i*o,t[15]=0,t},$t.ortho=function(t,e,r,i,n,o,a){var s=1/(e-r),l=1/(i-n),h=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+r)*s,t[13]=(n+i)*l,t[14]=(a+o)*h,t[15]=1,t},$t.lookAt=function(t,e,r,i){var n,o,a,s,l=e[0],h=e[1],e=e[2],u=i[0],c=i[1],i=i[2],d=r[0],f=r[1],r=r[2];return Math.abs(l-d)<1e-6&&Math.abs(h-f)<1e-6&&Math.abs(e-r)<1e-6?$t.identity(t):(d=l-d,f=h-f,r=e-r,n=c*(r*=s=1/Math.sqrt(d*d+f*f+r*r))-i*(f*=s),i=i*(d*=s)-u*r,u=u*f-c*d,(s=Math.sqrt(n*n+i*i+u*u))?(n*=s=1/s,i*=s,u*=s):u=i=n=0,c=f*u-r*i,o=r*n-d*u,a=d*i-f*n,(s=Math.sqrt(c*c+o*o+a*a))?(c*=s=1/s,o*=s,a*=s):a=o=c=0,t[0]=n,t[1]=c,t[2]=d,t[3]=0,t[4]=i,t[5]=o,t[6]=f,t[7]=0,t[8]=u,t[9]=a,t[10]=r,t[11]=0,t[12]=-(n*l+i*h+u*e),t[13]=-(c*l+o*h+a*e),t[14]=-(d*l+f*h+r*e),t[15]=1,t)},$t.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))};const k=$t;var te,i={create:function(){var t=new wt(3);return t[0]=0,t[1]=0,t[2]=0,t},clone:function(t){var e=new wt(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},fromValues:function(t,e,r){var i=new wt(3);return i[0]=t,i[1]=e,i[2]=r,i},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,r,i){return t[0]=e,t[1]=r,t[2]=i,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}};i.sub=i.subtract,i.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t},i.mul=i.multiply,i.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t},i.div=i.divide,i.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},i.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},i.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},i.scaleAndAdd=function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t},i.distance=function(t,e){var r=e[0]-t[0],i=e[1]-t[1],e=e[2]-t[2];return Math.sqrt(r*r+i*i+e*e)},i.dist=i.distance,i.squaredDistance=function(t,e){var r=e[0]-t[0],i=e[1]-t[1],e=e[2]-t[2];return r*r+i*i+e*e},i.sqrDist=i.squaredDistance,i.length=function(t){var e=t[0],r=t[1],t=t[2];return Math.sqrt(e*e+r*r+t*t)},i.len=i.length,i.squaredLength=function(t){var e=t[0],r=t[1],t=t[2];return e*e+r*r+t*t},i.sqrLen=i.squaredLength,i.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},i.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},i.normalize=function(t,e){var r=e[0],i=e[1],n=e[2],r=r*r+i*i+n*n;return 0<r&&(r=1/Math.sqrt(r),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r),t},i.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},i.cross=function(t,e,r){var i=e[0],n=e[1],e=e[2],o=r[0],a=r[1],r=r[2];return t[0]=n*r-e*a,t[1]=e*o-i*r,t[2]=i*a-n*o,t},i.lerp=function(t,e,r,i){var n=e[0],o=e[1],e=e[2];return t[0]=n+i*(r[0]-n),t[1]=o+i*(r[1]-o),t[2]=e+i*(r[2]-e),t},i.random=function(t,e){e=e||1;var r=2*St()*Math.PI,i=2*St()-1,n=Math.sqrt(1-i*i)*e;return t[0]=Math.cos(r)*n,t[1]=Math.sin(r)*n,t[2]=i*e,t},i.transformMat4=function(t,e,r){var i=e[0],n=e[1],e=e[2],o=r[3]*i+r[7]*n+r[11]*e+r[15];return t[0]=(r[0]*i+r[4]*n+r[8]*e+r[12])/(o=o||1),t[1]=(r[1]*i+r[5]*n+r[9]*e+r[13])/o,t[2]=(r[2]*i+r[6]*n+r[10]*e+r[14])/o,t},i.transformMat3=function(t,e,r){var i=e[0],n=e[1],e=e[2];return t[0]=i*r[0]+n*r[3]+e*r[6],t[1]=i*r[1]+n*r[4]+e*r[7],t[2]=i*r[2]+n*r[5]+e*r[8],t},i.transformQuat=function(t,e,r){var i=e[0],n=e[1],e=e[2],o=r[0],a=r[1],s=r[2],r=r[3],l=r*i+a*e-s*n,h=r*n+s*i-o*e,u=r*e+o*n-a*i,i=-o*i-a*n-s*e;return t[0]=l*r+i*-o+h*-s-u*-a,t[1]=h*r+i*-a+u*-o-l*-s,t[2]=u*r+i*-s+l*-a-h*-o,t},i.rotateX=function(t,e,r,i){var n=[],o=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},i.rotateY=function(t,e,r,i){var n=[],o=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},i.rotateZ=function(t,e,r,i){var n=[],o=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},i.forEach=(te=i.create(),function(t,e,r,i,n,o){var a,s;for(e=e||3,r=r||0,s=i?Math.min(i*e+r,t.length):t.length,a=r;a<s;a+=e)te[0]=t[a],te[1]=t[a+1],te[2]=t[a+2],n(te,te,o),t[a]=te[0],t[a+1]=te[1],t[a+2]=te[2];return t}),i.angle=function(t,e){t=i.fromValues(t[0],t[1],t[2]),e=i.fromValues(e[0],e[1],e[2]),i.normalize(t,t),i.normalize(e,e),t=i.dot(t,e);return 1<t?0:Math.acos(t)};const I=i;S.import(Q);var ee=k.create,re={};function ie(t){return t.material}function ne(t,e,r){return e.uniforms[r].value}function oe(t,e,r,i){return r!==i}function ae(t){return!0}function se(){}var le={float:E.FLOAT,byte:E.BYTE,ubyte:E.UNSIGNED_BYTE,short:E.SHORT,ushort:E.UNSIGNED_SHORT};function he(t,e,r){this.availableAttributes=t,this.availableAttributeSymbols=e,this.indicesBuffer=r,this.vao=null}function ue(t){var r,i;this.bind=function(t){r||((r=$.createCanvas()).width=r.height=1,r.getContext("2d"));var t=t.gl,e=!i;e&&(i=t.createTexture()),t.bindTexture(t.TEXTURE_2D,i),e&&t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)},this.unbind=function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,null)},this.isRenderable=function(){return!0}}var t=P.extend(function(){return{canvas:null,_width:100,_height:100,devicePixelRatio:"undefined"!=typeof window&&window.devicePixelRatio||1,clearColor:[0,0,0,0],clearBit:17664,alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,throwError:!0,gl:null,viewport:{},maxJointNumber:20,__currentFrameBuffer:null,_viewportStack:[],_clearStack:[],_sceneRendering:null}},function(){this.canvas||(this.canvas=$.createCanvas());var t=this.canvas;try{var e={alpha:this.alpha,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=t.getContext("webgl",e)||t.getContext("experimental-webgl",e),!this.gl)throw new Error;this._glinfo=new Y(this.gl),this.gl.targetRenderer&&console.error("Already created a renderer"),(this.gl.targetRenderer=this).resize()}catch(t){throw"Error creating WebGL Context "+t}this._programMgr=new It(this),this._placeholderTexture=new ue},{resize:function(t,e){var r=this.canvas,i=this.devicePixelRatio;null!=t?(r.style&&(r.style.width=t+"px",r.style.height=e+"px"),r.width=t*i,r.height=e*i,this._width=t,this._height=e):(this._width=r.width/i,this._height=r.height/i),this.setViewport(0,0,this._width,this._height)},getWidth:function(){return this._width},getHeight:function(){return this._height},getViewportAspect:function(){var t=this.viewport;return t.width/t.height},setDevicePixelRatio:function(t){this.devicePixelRatio=t,this.resize(this._width,this._height)},getDevicePixelRatio:function(){return this.devicePixelRatio},getGLExtension:function(t){return this._glinfo.getExtension(t)},getGLParameter:function(t){return this._glinfo.getParameter(t)},setViewport:function(t,e,r,i,n){var o;"object"==typeof t&&(t=(o=t).x,e=o.y,r=o.width,i=o.height,n=o.devicePixelRatio),n=n||this.devicePixelRatio,this.gl.viewport(t*n,e*n,r*n,i*n),this.viewport={x:t,y:e,width:r,height:i,devicePixelRatio:n}},saveViewport:function(){this._viewportStack.push(this.viewport)},restoreViewport:function(){0<this._viewportStack.length&&this.setViewport(this._viewportStack.pop())},saveClear:function(){this._clearStack.push({clearBit:this.clearBit,clearColor:this.clearColor})},restoreClear:function(){var t;0<this._clearStack.length&&(t=this._clearStack.pop(),this.clearColor=t.clearColor,this.clearBit=t.clearBit)},bindSceneRendering:function(t){this._sceneRendering=t},render:function(t,e,r,i){var n,o=this.gl,a=this.clearColor;if(this.clearBit&&(o.colorMask(!0,!0,!0,!0),o.depthMask(!0),n=!1,l=(s=this.viewport).devicePixelRatio,(s.width!==this._width||s.height!==this._height||l&&l!==this.devicePixelRatio||s.x||s.y)&&(n=!0,o.enable(o.SCISSOR_TEST),o.scissor(s.x*l,s.y*l,s.width*l,s.height*l)),o.clearColor(a[0],a[1],a[2],a[3]),o.clear(this.clearBit),n)&&o.disable(o.SCISSOR_TEST),r||t.update(!1),t.updateLights(),e=e||t.getMainCamera()){e.update();for(var s=t.updateRenderList(e,!0),l=(this._sceneRendering=t,s.opaque),h=s.transparent,u=t.material,c=(t.trigger("beforerender",this,t,e,s),i?(this.renderPreZ(l,t,e),o.depthFunc(o.LEQUAL)):o.depthFunc(o.LESS),ee()),d=I.create(),f=0;f<h.length;f++){var p=h[f];k.multiplyAffine(c,e.viewMatrix.array,p.worldTransform.array),I.transformMat4(d,p.position.array,c),p.__depth=d[2]}this.renderPass(l,e,{getMaterial:function(t){return u||t.material},sortCompare:this.opaqueSortCompare}),this.renderPass(h,e,{getMaterial:function(t){return u||t.material},sortCompare:this.transparentSortCompare}),t.trigger("afterrender",this,t,e,s),this._sceneRendering=null}else console.error("Can't find camera in the scene.")},getProgram:function(t,e,r){return e=e||t.material,this._programMgr.getProgram(t,e,r)},validateProgram:function(t){if(t.__error){var e=t.__error;if(!re[t.__uid__]){if(re[t.__uid__]=!0,this.throwError)throw new Error(e);this.trigger("error",e)}}},updatePrograms:function(t,e,r){var i=r&&r.getMaterial||ie;e=e||null;for(var n=0;n<t.length;n++){var o=t[n],a=i.call(this,o);if(0<n){var s=t[n-1],l=s.joints?s.joints.length:0;if((o.joints?o.joints.length:0)===l&&o.material===s.material&&o.lightGroup===s.lightGroup){o.__program=s.__program;continue}}l=this._programMgr.getProgram(o,a,e);this.validateProgram(l),o.__program=l}},renderPass:function(t,e,r){this.trigger("beforerenderpass",this,t,e,r),(r=r||{}).getMaterial=r.getMaterial||ie,r.getUniform=r.getUniform||ne,r.isMaterialChanged=r.isMaterialChanged||oe,r.beforeRender=r.beforeRender||se,r.afterRender=r.afterRender||se;for(var i,n,o,a,s,l,h,u,c,d,f,p=r.ifRender||ae,m=(this.updatePrograms(t,this._sceneRendering,r),r.sortCompare&&t.sort(r.sortCompare),this.viewport),g=m.devicePixelRatio,_=[m.x*g,m.y*g,m.width*g,m.height*g],m=this.devicePixelRatio,y=this.__currentFrameBuffer?[this.__currentFrameBuffer.getTextureWidth(),this.__currentFrameBuffer.getTextureHeight()]:[this._width*m,this._height*m],v=[_[2],_[3]],B=Date.now(),x=(e?(k.copy(ce.VIEW,e.viewMatrix.array),k.copy(ce.PROJECTION,e.projectionMatrix.array),k.copy(ce.VIEWINVERSE,e.worldTransform.array)):(k.identity(ce.VIEW),k.identity(ce.PROJECTION),k.identity(ce.VIEWINVERSE)),k.multiply(ce.VIEWPROJECTION,ce.PROJECTION,ce.VIEW),k.invert(ce.PROJECTIONINVERSE,ce.PROJECTION),k.invert(ce.VIEWPROJECTIONINVERSE,ce.VIEWPROJECTION),this.gl),T=this._sceneRendering,F=null,b=0;b<t.length;b++){var w,S=t[b],E=null!=S.worldTransform;if(p(S)){E&&(w=S.isSkinnedMesh&&S.isSkinnedMesh()?S.offsetMatrix?S.offsetMatrix.array:ce.IDENTITY:S.worldTransform.array);var M=S.geometry,A=r.getMaterial.call(this,S),C=S.__program,D=A.shader,L=M.__uid__+"-"+C.__uid__,z=L!==U,U=L,L=(E&&(k.copy(ce.WORLD,w),k.multiply(ce.WORLDVIEWPROJECTION,ce.VIEWPROJECTION,w),k.multiplyAffine(ce.WORLDVIEW,ce.VIEW,w),(D.matrixSemantics.WORLDINVERSE||D.matrixSemantics.WORLDINVERSETRANSPOSE)&&k.invert(ce.WORLDINVERSE,w),(D.matrixSemantics.WORLDVIEWINVERSE||D.matrixSemantics.WORLDVIEWINVERSETRANSPOSE)&&k.invert(ce.WORLDVIEWINVERSE,ce.WORLDVIEW),D.matrixSemantics.WORLDVIEWPROJECTIONINVERSE||D.matrixSemantics.WORLDVIEWPROJECTIONINVERSETRANSPOSE)&&k.invert(ce.WORLDVIEWPROJECTIONINVERSE,ce.WORLDVIEWPROJECTION),S.beforeRender&&S.beforeRender(this),r.beforeRender.call(this,S,A,i),C!==n),P=(L?(C.bind(this),C.setUniformOfSemantic(x,"VIEWPORT",_),C.setUniformOfSemantic(x,"WINDOW_SIZE",y),e&&(C.setUniformOfSemantic(x,"NEAR",e.near),C.setUniformOfSemantic(x,"FAR",e.far)),C.setUniformOfSemantic(x,"DEVICEPIXELRATIO",g),C.setUniformOfSemantic(x,"TIME",B),C.setUniformOfSemantic(x,"VIEWPORT_SIZE",v),T&&T.setLightUniforms(C,S.lightGroup,this)):C=n,(L||r.isMaterialChanged(S,o,A,i))&&(A.depthTest!==a&&(A.depthTest?x.enable(x.DEPTH_TEST):x.disable(x.DEPTH_TEST),a=A.depthTest),A.depthMask!==s&&(x.depthMask(A.depthMask),s=A.depthMask),A.transparent!==c&&(A.transparent?x.enable(x.BLEND):x.disable(x.BLEND),c=A.transparent),A.transparent&&(A.blend?A.blend(x):(x.blendEquationSeparate(x.FUNC_ADD,x.FUNC_ADD),x.blendFuncSeparate(x.SRC_ALPHA,x.ONE_MINUS_SRC_ALPHA,x.ONE,x.ONE_MINUS_SRC_ALPHA))),f=this._bindMaterial(S,A,C,o||null,i||null,n||null,r.getUniform),i=A),D.matrixSemanticKeys);if(E)for(var N=0;N<P.length;N++){var R,I=P[N],O=D.matrixSemantics[I],I=ce[I];O.isTranspose&&(R=ce[O.semanticNoTranspose],k.transpose(I,R)),C.setUniform(x,O.type,O.symbol,I)}S.cullFace!==h&&(h=S.cullFace,x.cullFace(h)),S.frontFace!==u&&(u=S.frontFace,x.frontFace(u)),S.culling!==l&&((l=S.culling)?x.enable(x.CULL_FACE):x.disable(x.CULL_FACE)),this._updateSkeleton(S,C,f),z&&(d=this._bindVAO(F,D,M,C)),this._renderObject(S,d,C),r.afterRender(this,S),S.afterRender&&S.afterRender(this),n=C,o=S}}this.trigger("afterrenderpass",this,t,e,r)},getMaxJointNumber:function(){return this.maxJointNumber},_updateSkeleton:function(t,e,r){var i,n=this.gl,o=t.skeleton;o&&(o.update(),t.joints.length>this.getMaxJointNumber()?(i=o.getSubSkinMatricesTexture(t.__uid__,t.joints),e.useTextureSlot(this,i,r),e.setUniform(n,"1i","skinMatricesTexture",r),e.setUniform(n,"1f","skinMatricesTextureSize",i.width)):(r=o.getSubSkinMatrices(t.__uid__,t.joints),e.setUniformOfSemantic(n,"SKIN_MATRIX",r)))},_renderObject:function(t,e,r){var i,n=this.gl,o=t.geometry,a=t.mode,s=(null==a&&(a=4),null),l=t.isInstancedMesh&&t.isInstancedMesh();if(l&&!(s=this.getGLExtension("ANGLE_instanced_arrays")))console.warn("Device not support ANGLE_instanced_arrays extension");else if(l&&(i=this._bindInstancedAttributes(t,r,s)),e.indicesBuffer?(r=this.getGLExtension("OES_element_index_uint")&&o.indices instanceof Uint32Array?n.UNSIGNED_INT:n.UNSIGNED_SHORT,l?s.drawElementsInstancedANGLE(a,e.indicesBuffer.count,r,0,t.getInstanceCount()):n.drawElements(a,e.indicesBuffer.count,r,0)):l?s.drawArraysInstancedANGLE(a,0,o.vertexCount,t.getInstanceCount()):n.drawArrays(a,0,o.vertexCount),l)for(var h=0;h<i.length;h++)n.disableVertexAttribArray(i[h])},_bindInstancedAttributes:function(t,e,r){for(var i=this.gl,n=t.getInstancedAttributesBuffers(this),o=[],a=0;a<n.length;a++){var s,l=n[a],h=e.getAttribLocation(i,l.symbol);h<0||(s=le[l.type]||i.FLOAT,i.enableVertexAttribArray(h),i.bindBuffer(i.ARRAY_BUFFER,l.buffer),i.vertexAttribPointer(h,l.size,s,!1,0,0),r.vertexAttribDivisorANGLE(h,l.divisor),o.push(h))}return o},_bindMaterial:function(t,e,r,i,n,o,a){for(var s=this.gl,l=o===r,o=r.currentTextureSlot(),h=e.getEnabledUniforms(),u=e.getTextureUniforms(),c=this._placeholderTexture,d=0;d<u.length;d++){var f=a(t,e,g=u[d]);if("t"===(m=e.uniforms[g].type)&&f)f.__slot=-1;else if("tv"===m)for(var p=0;p<f.length;p++)f[p]&&(f[p].__slot=-1)}c.__slot=-1;for(d=0;d<h.length;d++){var m,g=h[d],_=e.uniforms[g],f=a(t,e,g),y="t"===(m=_.type);if(!y||f&&f.isRenderable()||(f=c),n&&l){var v=a(i,n,g);if((v=!y||v&&v.isRenderable()?v:c)===f){if(y)r.takeCurrentTextureSlot(this,null);else if("tv"===m&&f)for(p=0;p<f.length;p++)r.takeCurrentTextureSlot(this,null);continue}}if(null!=f)if(y)f.__slot<0?(T=r.currentTextureSlot(),r.setUniform(s,"1i",g,T)&&(r.takeCurrentTextureSlot(this,f),f.__slot=T)):r.setUniform(s,"1i",g,f.__slot);else if(Array.isArray(f)){if(0!==f.length)if("tv"===m){if(r.hasUniform(g)){for(var x=[],p=0;p<f.length;p++){var T,b=f[p];b.__slot<0?(T=r.currentTextureSlot(),x.push(T),r.takeCurrentTextureSlot(this,b),b.__slot=T):x.push(b.__slot)}r.setUniform(s,"1iv",g,x)}}else r.setUniform(s,_.type,g,f)}else r.setUniform(s,_.type,g,f)}var w=r.currentTextureSlot();return r.resetTextureSlot(o),w},_bindVAO:function(t,e,r,i){var n=!r.dynamic,o=this.gl,a=this.__uid__+"-"+i.__uid__,s=r.__vaoCache[a];if(!s){var l=r.getBufferChunks(this);if(!l||!l.length)return;for(var l=l[0],h=l.attributeBuffers,l=l.indicesBuffer,u=[],c=[],d=0;d<h.length;d++){var f=(g=h[d]).name,p=g.semantic;(p=p?(p=e.attributeSemantics[p])&&p.symbol:f)&&i.attributes[p]&&(u.push(g),c.push(p))}s=new he(u,c,l),n&&(r.__vaoCache[a]=s)}a=!0,t&&n&&(null==s.vao?s.vao=t.createVertexArrayOES():a=!1,t.bindVertexArrayOES(s.vao)),u=s.availableAttributes,l=s.indicesBuffer;if(a){for(var m=i.enableAttributes(this,s.availableAttributeSymbols,t&&n&&s),d=0;d<u.length;d++){var g,_,y,v,x=m[d];-1!==x&&(_=(g=u[d]).buffer,y=g.size,v=le[g.type]||o.FLOAT,o.bindBuffer(o.ARRAY_BUFFER,_),o.vertexAttribPointer(x,y,v,!1,0,0))}r.isUseIndices()&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,l.buffer)}return s},renderPreZ:function(t,e,r){var i=this.gl,n=this._prezMaterial||new Tt({shader:new S(S.source("clay.prez.vertex"),S.source("clay.prez.fragment"))});this._prezMaterial=n,i.colorMask(!1,!1,!1,!1),i.depthMask(!0),this.renderPass(t,r,{ifRender:function(t){return!t.ignorePreZ},isMaterialChanged:function(t,e){t=t.material,e=e.material;return t.get("diffuseMap")!==e.get("diffuseMap")||(t.get("alphaCutoff")||0)!==(e.get("alphaCutoff")||0)},getUniform:function(t,e,r){return"alphaMap"===r?t.material.get("diffuseMap"):"alphaCutoff"===r?t.material.isDefined("fragment","ALPHA_TEST")&&t.material.get("diffuseMap")&&t.material.get("alphaCutoff")||0:"uvRepeat"===r?t.material.get("uvRepeat"):"uvOffset"===r?t.material.get("uvOffset"):e.get(r)},getMaterial:function(){return n},sort:this.opaqueSortCompare}),i.colorMask(!0,!0,!0,!0),i.depthMask(!0)},disposeScene:function(t){this.disposeNode(t,!0,!0),t.dispose()},disposeNode:function(t,s,l){t.getParent()&&t.getParent().remove(t);var h={};t.traverse(function(t){var e=t.material;if(t.geometry&&s&&t.geometry.dispose(this),l&&e&&!h[e.__uid__]){for(var r=e.getTextureUniforms(),i=0;i<r.length;i++){var n=r[i],o=e.uniforms[n].value,n=e.uniforms[n].type;if(o)if("t"===n)o.dispose&&o.dispose(this);else if("tv"===n)for(var a=0;a<o.length;a++)o[a]&&o[a].dispose&&o[a].dispose(this)}h[e.__uid__]=!0}t.dispose&&t.dispose(this)},this)},disposeGeometry:function(t){t.dispose(this)},disposeTexture:function(t){t.dispose(this)},disposeFrameBuffer:function(t){t.dispose(this)},dispose:function(){},screenToNDC:function(t,e,r){r=r||new Et,e=this._height-e;var i=this.viewport,n=r.array;return n[0]=(t-i.x)/i.width,n[0]=2*n[0]-1,n[1]=(e-i.y)/i.height,n[1]=2*n[1]-1,r}}),ce=(t.opaqueSortCompare=t.prototype.opaqueSortCompare=function(t,e){return t.renderOrder===e.renderOrder?t.__program===e.__program?t.material===e.material?t.geometry.__uid__-e.geometry.__uid__:t.material.__uid__-e.material.__uid__:t.__program&&e.__program?t.__program.__uid__-e.__program.__uid__:0:t.renderOrder-e.renderOrder},t.transparentSortCompare=t.prototype.transparentSortCompare=function(t,e){return t.renderOrder===e.renderOrder?t.__depth===e.__depth?t.__program===e.__program?t.material===e.material?t.geometry.__uid__-e.geometry.__uid__:t.material.__uid__-e.material.__uid__:t.__program&&e.__program?t.__program.__uid__-e.__program.__uid__:0:t.__depth-e.__depth:t.renderOrder-e.renderOrder},{IDENTITY:ee(),WORLD:ee(),VIEW:ee(),PROJECTION:ee(),WORLDVIEW:ee(),VIEWPROJECTION:ee(),WORLDVIEWPROJECTION:ee(),WORLDINVERSE:ee(),VIEWINVERSE:ee(),PROJECTIONINVERSE:ee(),WORLDVIEWINVERSE:ee(),VIEWPROJECTIONINVERSE:ee(),WORLDVIEWPROJECTIONINVERSE:ee(),WORLDTRANSPOSE:ee(),VIEWTRANSPOSE:ee(),PROJECTIONTRANSPOSE:ee(),WORLDVIEWTRANSPOSE:ee(),VIEWPROJECTIONTRANSPOSE:ee(),WORLDVIEWPROJECTIONTRANSPOSE:ee(),WORLDINVERSETRANSPOSE:ee(),VIEWINVERSETRANSPOSE:ee(),PROJECTIONINVERSETRANSPOSE:ee(),WORLDVIEWINVERSETRANSPOSE:ee(),VIEWPROJECTIONINVERSETRANSPOSE:ee(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:ee()});t.COLOR_BUFFER_BIT=E.COLOR_BUFFER_BIT,t.DEPTH_BUFFER_BIT=E.DEPTH_BUFFER_BIT,t.STENCIL_BUFFER_BIT=E.STENCIL_BUFFER_BIT;const de=t;function o(t,e,r){t=t||0,e=e||0,r=r||0,this.array=I.fromValues(t,e,r),this._dirty=!0}o.prototype={constructor:o,add:function(t){return I.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e,r){return this.array[0]=t,this.array[1]=e,this.array[2]=r,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this.array[2]=t[2],this._dirty=!0,this},clone:function(){return new o(this.x,this.y,this.z)},copy:function(t){return I.copy(this.array,t.array),this._dirty=!0,this},cross:function(t,e){return I.cross(this.array,t.array,e.array),this._dirty=!0,this},dist:function(t){return I.dist(this.array,t.array)},distance:function(t){return I.distance(this.array,t.array)},div:function(t){return I.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return I.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return I.dot(this.array,t.array)},len:function(){return I.len(this.array)},length:function(){return I.length(this.array)},lerp:function(t,e,r){return I.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return I.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return I.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return I.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return I.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return I.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return I.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return I.random(this.array,t),this._dirty=!0,this},scale:function(t){return I.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return I.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return I.sqrDist(this.array,t.array)},squaredDistance:function(t){return I.squaredDistance(this.array,t.array)},sqrLen:function(){return I.sqrLen(this.array)},squaredLength:function(){return I.squaredLength(this.array)},sub:function(t){return I.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return I.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat3:function(t){return I.transformMat3(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return I.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},transformQuat:function(t){return I.transformQuat(this.array,this.array,t.array),this._dirty=!0,this},applyProjection:function(t){var e,r=this.array;return 0===(t=t.array)[15]?(e=-1/r[2],r[0]=t[0]*r[0]*e,r[1]=t[5]*r[1]*e,r[2]=(t[10]*r[2]+t[14])*e):(r[0]=t[0]*r[0]+t[12],r[1]=t[5]*r[1]+t[13],r[2]=t[10]*r[2]+t[14]),this._dirty=!0,this},eulerFromQuat:function(t,e){o.eulerFromQuat(this,t,e)},eulerFromMat3:function(t,e){o.eulerFromMat3(this,t,e)},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};e=Object.defineProperty;function fe(t,e,r){return t<e?e:r<t?r:t}e&&(e(t=o.prototype,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),e(t,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}}),e(t,"z",{get:function(){return this.array[2]},set:function(t){this.array[2]=t,this._dirty=!0}})),o.add=function(t,e,r){return I.add(t.array,e.array,r.array),t._dirty=!0,t},o.set=function(t,e,r,i){I.set(t.array,e,r,i),t._dirty=!0},o.copy=function(t,e){return I.copy(t.array,e.array),t._dirty=!0,t},o.cross=function(t,e,r){return I.cross(t.array,e.array,r.array),t._dirty=!0,t},o.distance=o.dist=function(t,e){return I.distance(t.array,e.array)},o.divide=o.div=function(t,e,r){return I.divide(t.array,e.array,r.array),t._dirty=!0,t},o.dot=function(t,e){return I.dot(t.array,e.array)},o.len=function(t){return I.length(t.array)},o.lerp=function(t,e,r,i){return I.lerp(t.array,e.array,r.array,i),t._dirty=!0,t},o.min=function(t,e,r){return I.min(t.array,e.array,r.array),t._dirty=!0,t},o.max=function(t,e,r){return I.max(t.array,e.array,r.array),t._dirty=!0,t},o.multiply=o.mul=function(t,e,r){return I.multiply(t.array,e.array,r.array),t._dirty=!0,t},o.negate=function(t,e){return I.negate(t.array,e.array),t._dirty=!0,t},o.normalize=function(t,e){return I.normalize(t.array,e.array),t._dirty=!0,t},o.random=function(t,e){return I.random(t.array,e),t._dirty=!0,t},o.scale=function(t,e,r){return I.scale(t.array,e.array,r),t._dirty=!0,t},o.scaleAndAdd=function(t,e,r,i){return I.scaleAndAdd(t.array,e.array,r.array,i),t._dirty=!0,t},o.squaredDistance=o.sqrDist=function(t,e){return I.sqrDist(t.array,e.array)},o.squaredLength=o.sqrLen=function(t){return I.sqrLen(t.array)},o.subtract=o.sub=function(t,e,r){return I.subtract(t.array,e.array,r.array),t._dirty=!0,t},o.transformMat3=function(t,e,r){return I.transformMat3(t.array,e.array,r.array),t._dirty=!0,t},o.transformMat4=function(t,e,r){return I.transformMat4(t.array,e.array,r.array),t._dirty=!0,t},o.transformQuat=function(t,e,r){return I.transformQuat(t.array,e.array,r.array),t._dirty=!0,t};var f=Math.atan2,pe=Math.asin,me=Math.abs;o.eulerFromQuat=function(t,e,r){t._dirty=!0,e=e.array;var i=t.array,n=e[0],o=e[1],a=e[2],s=e[3],l=n*n,h=o*o,u=a*a,c=s*s;switch(r=(r||"XYZ").toUpperCase()){case"XYZ":i[0]=f(2*(n*s-o*a),c-l-h+u),i[1]=pe(fe(2*(n*a+o*s),-1,1)),i[2]=f(2*(a*s-n*o),c+l-h-u);break;case"YXZ":i[0]=pe(fe(2*(n*s-o*a),-1,1)),i[1]=f(2*(n*a+o*s),c-l-h+u),i[2]=f(2*(n*o+a*s),c-l+h-u);break;case"ZXY":i[0]=pe(fe(2*(n*s+o*a),-1,1)),i[1]=f(2*(o*s-a*n),c-l-h+u),i[2]=f(2*(a*s-n*o),c-l+h-u);break;case"ZYX":i[0]=f(2*(n*s+a*o),c-l-h+u),i[1]=pe(fe(2*(o*s-n*a),-1,1)),i[2]=f(2*(n*o+a*s),c+l-h-u);break;case"YZX":i[0]=f(2*(n*s-a*o),c-l+h-u),i[1]=f(2*(o*s-n*a),c+l-h-u),i[2]=pe(fe(2*(n*o+a*s),-1,1));break;case"XZY":i[0]=f(2*(n*s+o*a),c-l+h-u),i[1]=f(2*(n*a+o*s),c+l-h-u),i[2]=pe(fe(2*(a*s-n*o),-1,1));break;default:console.warn("Unkown order: "+r)}return t},o.eulerFromMat3=function(t,e,r){var e=e.array,i=e[0],n=e[3],o=e[6],a=e[1],s=e[4],l=e[7],h=e[2],u=e[5],c=e[8],d=t.array;switch(r=(r||"XYZ").toUpperCase()){case"XYZ":d[1]=pe(fe(o,-1,1)),me(o)<.99999?(d[0]=f(-l,c),d[2]=f(-n,i)):(d[0]=f(u,s),d[2]=0);break;case"YXZ":d[0]=pe(-fe(l,-1,1)),me(l)<.99999?(d[1]=f(o,c),d[2]=f(a,s)):(d[1]=f(-h,i),d[2]=0);break;case"ZXY":d[0]=pe(fe(u,-1,1)),me(u)<.99999?(d[1]=f(-h,c),d[2]=f(-n,s)):(d[1]=0,d[2]=f(a,i));break;case"ZYX":d[1]=pe(-fe(h,-1,1)),me(h)<.99999?(d[0]=f(u,c),d[2]=f(a,i)):(d[0]=0,d[2]=f(-n,s));break;case"YZX":d[2]=pe(fe(a,-1,1)),me(a)<.99999?(d[0]=f(-l,s),d[1]=f(-h,i)):(d[0]=0,d[1]=f(o,c));break;case"XZY":d[2]=pe(-fe(n,-1,1)),me(n)<.99999?(d[0]=f(u,s),d[1]=f(o,i)):(d[0]=f(-l,c),d[1]=0);break;default:console.warn("Unkown order: "+r)}return t._dirty=!0,t},Object.defineProperties(o,{POSITIVE_X:{get:function(){return new o(1,0,0)}},NEGATIVE_X:{get:function(){return new o(-1,0,0)}},POSITIVE_Y:{get:function(){return new o(0,1,0)}},NEGATIVE_Y:{get:function(){return new o(0,-1,0)}},POSITIVE_Z:{get:function(){return new o(0,0,1)}},NEGATIVE_Z:{get:function(){return new o(0,0,-1)}},UP:{get:function(){return new o(0,1,0)}},ZERO:{get:function(){return new o}}});const C=o;function ge(t,e){this.origin=t||new C,this.direction=e||new C}var _e,ye,ve,xe,Te,be;ge.prototype={constructor:ge,intersectPlane:function(t,e){var r=t.normal.array,t=t.distance,i=this.origin.array,n=this.direction.array,o=I.dot(r,n);if(0===o)return null;e=e||new C;r=(I.dot(r,i)-t)/o;return I.scaleAndAdd(e.array,i,n,-r),e._dirty=!0,e},mirrorAgainstPlane:function(t){var e=I.dot(t.normal.array,this.direction.array);I.scaleAndAdd(this.direction.array,this.direction.array,t.normal.array,2*-e),this.direction._dirty=!0},distanceToPoint:(be=I.create(),function(t){I.sub(be,t,this.origin.array);var e=I.dot(be,this.direction.array);return e<0?I.distance(this.origin.array,t):(t=I.lenSquared(be),Math.sqrt(t-e*e))}),intersectSphere:(Te=I.create(),function(t,e,r){var i=this.origin.array,n=this.direction.array,t=(t=t.array,I.sub(Te,t,i),I.dot(Te,n)),o=I.squaredLength(Te)-t*t,e=e*e;if(!(e<o))return o=t-(e=Math.sqrt(e-o)),t=t+e,r=r||new C,o<0?t<0?null:(I.scaleAndAdd(r.array,i,n,t),r):(I.scaleAndAdd(r.array,i,n,o),r)}),intersectBoundingBox:function(t,e){var r,i,n,o,a,s,l=this.direction.array,h=this.origin.array,u=t.min.array,t=t.max.array,c=1/l[0],d=1/l[1],f=1/l[2];return 0<=c?(r=(u[0]-h[0])*c,i=(t[0]-h[0])*c):(i=(u[0]-h[0])*c,r=(t[0]-h[0])*c),0<=d?(n=(u[1]-h[1])*d,o=(t[1]-h[1])*d):(o=(u[1]-h[1])*d,n=(t[1]-h[1])*d),o<r||i<n||((r<n||r!=r)&&(r=n),(o<i||i!=i)&&(i=o),0<=f?(a=(u[2]-h[2])*f,s=(t[2]-h[2])*f):(s=(u[2]-h[2])*f,a=(t[2]-h[2])*f),s<r)||i<a||(i=s<i||i!=i?s:i)<0?null:(c=0<=(r=r<a||r!=r?a:r)?r:i,e=e||new C,I.scaleAndAdd(e.array,h,l,c),e)},intersectTriangle:(_e=I.create(),ye=I.create(),ve=I.create(),xe=I.create(),function(t,e,r,i,n,o){var a=this.direction.array,s=this.origin.array,e=(t=t.array,e=e.array,r=r.array,I.sub(_e,e,t),I.sub(ye,r,t),I.cross(xe,ye,a),I.dot(_e,xe));if(i){if(-1e-5<e)return null}else if(-1e-5<e&&e<1e-5)return null;I.sub(ve,s,t);r=I.dot(xe,ve)/e;if(r<0||1<r)return null;I.cross(xe,_e,ve);i=I.dot(a,xe)/e;if(i<0||1<i||1<r+i)return null;I.cross(xe,_e,ye);t=-I.dot(ve,xe)/e;return t<0?null:(n=n||new C,o&&C.set(o,1-r-i,r,i),I.scaleAndAdd(n.array,s,a,t),n)}),applyTransform:function(t){C.add(this.direction,this.direction,this.origin),C.transformMat4(this.origin,this.origin,t),C.transformMat4(this.direction,this.direction,t),C.sub(this.direction,this.direction,this.origin),C.normalize(this.direction,this.direction)},copy:function(t){C.copy(this.origin,t.origin),C.copy(this.direction,t.direction)},clone:function(){var t=new ge;return t.copy(this),t}};const we=ge;var Se,a={create:function(){var t=new wt(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},clone:function(t){var e=new wt(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},fromValues:function(t,e,r,i){var n=new wt(4);return n[0]=t,n[1]=e,n[2]=r,n[3]=i,n},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},set:function(t,e,r,i,n){return t[0]=e,t[1]=r,t[2]=i,t[3]=n,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}};a.sub=a.subtract,a.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t},a.mul=a.multiply,a.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t},a.div=a.divide,a.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},a.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},a.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},a.scaleAndAdd=function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t},a.distance=function(t,e){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],e=e[3]-t[3];return Math.sqrt(r*r+i*i+n*n+e*e)},a.dist=a.distance,a.squaredDistance=function(t,e){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],e=e[3]-t[3];return r*r+i*i+n*n+e*e},a.sqrDist=a.squaredDistance,a.length=function(t){var e=t[0],r=t[1],i=t[2],t=t[3];return Math.sqrt(e*e+r*r+i*i+t*t)},a.len=a.length,a.squaredLength=function(t){var e=t[0],r=t[1],i=t[2],t=t[3];return e*e+r*r+i*i+t*t},a.sqrLen=a.squaredLength,a.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},a.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},a.normalize=function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],r=r*r+i*i+n*n+o*o;return 0<r&&(r=1/Math.sqrt(r),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r),t},a.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},a.lerp=function(t,e,r,i){var n=e[0],o=e[1],a=e[2],e=e[3];return t[0]=n+i*(r[0]-n),t[1]=o+i*(r[1]-o),t[2]=a+i*(r[2]-a),t[3]=e+i*(r[3]-e),t},a.random=function(t,e){return e=e||1,t[0]=St(),t[1]=St(),t[2]=St(),t[3]=St(),a.normalize(t,t),a.scale(t,t,e),t},a.transformMat4=function(t,e,r){var i=e[0],n=e[1],o=e[2],e=e[3];return t[0]=r[0]*i+r[4]*n+r[8]*o+r[12]*e,t[1]=r[1]*i+r[5]*n+r[9]*o+r[13]*e,t[2]=r[2]*i+r[6]*n+r[10]*o+r[14]*e,t[3]=r[3]*i+r[7]*n+r[11]*o+r[15]*e,t},a.transformQuat=function(t,e,r){var i=e[0],n=e[1],e=e[2],o=r[0],a=r[1],s=r[2],r=r[3],l=r*i+a*e-s*n,h=r*n+s*i-o*e,u=r*e+o*n-a*i,i=-o*i-a*n-s*e;return t[0]=l*r+i*-o+h*-s-u*-a,t[1]=h*r+i*-a+u*-o-l*-s,t[2]=u*r+i*-s+l*-a-h*-o,t},a.forEach=(Se=a.create(),function(t,e,r,i,n,o){var a,s;for(e=e||4,r=r||0,s=i?Math.min(i*e+r,t.length):t.length,a=r;a<s;a+=e)Se[0]=t[a],Se[1]=t[a+1],Se[2]=t[a+2],Se[3]=t[a+3],n(Se,Se,o),t[a]=Se[0],t[a+1]=Se[1],t[a+2]=Se[2],t[a+3]=Se[3];return t});const s=a;e={create:function(){var t=new wt(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new wt(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){var r,i,n;return t===e?(r=e[1],i=e[2],n=e[5],t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=i,t[7]=n):(t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]),t},invert:function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],e=e[8],u=e*a-s*h,c=-e*o+s*l,d=h*o-a*l,f=r*u+i*c+n*d;return f?(t[0]=u*(f=1/f),t[1]=(-e*i+n*h)*f,t[2]=(s*i-n*a)*f,t[3]=c*f,t[4]=(e*r-n*l)*f,t[5]=(-s*r+n*o)*f,t[6]=d*f,t[7]=(-h*r+i*l)*f,t[8]=(a*r-i*o)*f,t):null},adjoint:function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],e=e[8];return t[0]=a*e-s*h,t[1]=n*h-i*e,t[2]=i*s-n*a,t[3]=s*l-o*e,t[4]=r*e-n*l,t[5]=n*o-r*s,t[6]=o*h-a*l,t[7]=i*l-r*h,t[8]=r*a-i*o,t},determinant:function(t){var e=t[0],r=t[1],i=t[2],n=t[3],o=t[4],a=t[5],s=t[6],l=t[7],t=t[8];return e*(t*o-a*l)+r*(-t*n+a*s)+i*(l*n-o*s)},multiply:function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],e=e[8],c=r[0],d=r[1],f=r[2],p=r[3],m=r[4],g=r[5],_=r[6],y=r[7],r=r[8];return t[0]=c*i+d*a+f*h,t[1]=c*n+d*s+f*u,t[2]=c*o+d*l+f*e,t[3]=p*i+m*a+g*h,t[4]=p*n+m*s+g*u,t[5]=p*o+m*l+g*e,t[6]=_*i+y*a+r*h,t[7]=_*n+y*s+r*u,t[8]=_*o+y*l+r*e,t}};e.mul=e.multiply,e.translate=function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],e=e[8],c=r[0],r=r[1];return t[0]=i,t[1]=n,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=c*i+r*a+h,t[7]=c*n+r*s+u,t[8]=c*o+r*l+e,t},e.rotate=function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],e=e[8],c=Math.sin(r),r=Math.cos(r);return t[0]=r*i+c*a,t[1]=r*n+c*s,t[2]=r*o+c*l,t[3]=r*a-c*i,t[4]=r*s-c*n,t[5]=r*l-c*o,t[6]=h,t[7]=u,t[8]=e,t},e.scale=function(t,e,r){var i=r[0],r=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},e.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},e.fromQuat=function(t,e){var r=e[0],i=e[1],n=e[2],e=e[3],o=r+r,a=i+i,s=n+n,r=r*o,l=i*o,i=i*a,h=n*o,u=n*a,n=n*s,o=e*o,a=e*a,e=e*s;return t[0]=1-i-n,t[3]=l-e,t[6]=h+a,t[1]=l+e,t[4]=1-r-n,t[7]=u-o,t[2]=h-a,t[5]=u+o,t[8]=1-r-i,t},e.normalFromMat4=function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],p=e[12],m=e[13],g=e[14],e=e[15],_=r*s-i*a,y=r*l-n*a,v=r*h-o*a,x=i*l-n*s,T=i*h-o*s,b=n*h-o*l,w=u*m-c*p,S=u*g-d*p,u=u*e-f*p,E=c*g-d*m,c=c*e-f*m,d=d*e-f*g,f=_*d-y*c+v*E+x*u-T*S+b*w;return f?(t[0]=(s*d-l*c+h*E)*(f=1/f),t[1]=(l*u-a*d-h*S)*f,t[2]=(a*c-s*u+h*w)*f,t[3]=(n*c-i*d-o*E)*f,t[4]=(r*d-n*u+o*S)*f,t[5]=(i*u-r*c-o*w)*f,t[6]=(m*b-g*T+e*x)*f,t[7]=(g*v-p*b-e*y)*f,t[8]=(p*T-m*v+e*_)*f,t):null},e.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))};const l=e;var Ee,Me,Ae,Ce,h={create:function(){var t=new wt(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}};h.rotationTo=(Ee=I.create(),Me=I.fromValues(1,0,0),Ae=I.fromValues(0,1,0),function(t,e,r){var i=I.dot(e,r);return i<-.999999?(I.cross(Ee,Me,e),I.length(Ee)<1e-6&&I.cross(Ee,Ae,e),I.normalize(Ee,Ee),h.setAxisAngle(t,Ee,Math.PI),t):.999999<i?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(I.cross(Ee,e,r),t[0]=Ee[0],t[1]=Ee[1],t[2]=Ee[2],t[3]=1+i,h.normalize(t,t))}),h.setAxes=(Ce=l.create(),function(t,e,r,i){return Ce[0]=r[0],Ce[3]=r[1],Ce[6]=r[2],Ce[1]=i[0],Ce[4]=i[1],Ce[7]=i[2],Ce[2]=-e[0],Ce[5]=-e[1],Ce[8]=-e[2],h.normalize(t,h.fromMat3(t,Ce))}),h.clone=s.clone,h.fromValues=s.fromValues,h.copy=s.copy,h.set=s.set,h.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},h.setAxisAngle=function(t,e,r){r*=.5;var i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t},h.add=s.add,h.multiply=function(t,e,r){var i=e[0],n=e[1],o=e[2],e=e[3],a=r[0],s=r[1],l=r[2],r=r[3];return t[0]=i*r+e*a+n*l-o*s,t[1]=n*r+e*s+o*a-i*l,t[2]=o*r+e*l+i*s-n*a,t[3]=e*r-i*a-n*s-o*l,t},h.mul=h.multiply,h.scale=s.scale,h.rotateX=function(t,e,r){r*=.5;var i=e[0],n=e[1],o=e[2],e=e[3],a=Math.sin(r),r=Math.cos(r);return t[0]=i*r+e*a,t[1]=n*r+o*a,t[2]=o*r-n*a,t[3]=e*r-i*a,t},h.rotateY=function(t,e,r){r*=.5;var i=e[0],n=e[1],o=e[2],e=e[3],a=Math.sin(r),r=Math.cos(r);return t[0]=i*r-o*a,t[1]=n*r+e*a,t[2]=o*r+i*a,t[3]=e*r-n*a,t},h.rotateZ=function(t,e,r){r*=.5;var i=e[0],n=e[1],o=e[2],e=e[3],a=Math.sin(r),r=Math.cos(r);return t[0]=i*r+n*a,t[1]=n*r-i*a,t[2]=o*r+e*a,t[3]=e*r-o*a,t},h.calculateW=function(t,e){var r=e[0],i=e[1],e=e[2];return t[0]=r,t[1]=i,t[2]=e,t[3]=Math.sqrt(Math.abs(1-r*r-i*i-e*e)),t},h.dot=s.dot,h.lerp=s.lerp,h.slerp=function(t,e,r,i){var n,o,a=e[0],s=e[1],l=e[2],e=e[3],h=r[0],u=r[1],c=r[2],r=r[3],d=a*h+s*u+l*c+e*r;return d<0&&(d=-d,h=-h,u=-u,c=-c,r=-r),d=1e-6<1-d?(d=Math.acos(d),n=Math.sin(d),o=Math.sin((1-i)*d)/n,Math.sin(i*d)/n):(o=1-i,i),t[0]=o*a+d*h,t[1]=o*s+d*u,t[2]=o*l+d*c,t[3]=o*e+d*r,t},h.invert=function(t,e){var r=e[0],i=e[1],n=e[2],e=e[3],o=r*r+i*i+n*n+e*e,o=o?1/o:0;return t[0]=-r*o,t[1]=-i*o,t[2]=-n*o,t[3]=e*o,t},h.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},h.length=s.length,h.len=h.length,h.squaredLength=s.squaredLength,h.sqrLen=h.squaredLength,h.normalize=s.normalize,h.fromMat3=function(t,e){var r,i,n,o=e[0]+e[4]+e[8];return 0<o?(n=Math.sqrt(o+1),t[3]=.5*n,t[0]=(e[5]-e[7])*(n=.5/n),t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n):(e[4]>e[o=0]&&(o=1),r=((o=e[8]>e[3*o+o]?2:o)+1)%3,i=(o+2)%3,n=Math.sqrt(e[3*o+o]-e[3*r+r]-e[3*i+i]+1),t[o]=.5*n,t[3]=(e[3*r+i]-e[3*i+r])*(n=.5/n),t[r]=(e[3*r+o]+e[3*o+r])*n,t[i]=(e[3*i+o]+e[3*o+i])*n),t};const u=h;function De(){this._axisX=new C,this._axisY=new C,this._axisZ=new C,this.array=k.create(),this._dirty=!0}De.prototype={constructor:De,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},adjoint:function(){return k.adjoint(this.array,this.array),this._dirty=!0,this},clone:function(){return(new De).copy(this)},copy:function(t){return k.copy(this.array,t.array),this._dirty=!0,this},determinant:function(){return k.determinant(this.array)},fromQuat:function(t){return k.fromQuat(this.array,t.array),this._dirty=!0,this},fromRotationTranslation:function(t,e){return k.fromRotationTranslation(this.array,t.array,e.array),this._dirty=!0,this},fromMat2d:function(t){return De.fromMat2d(this,t),this},frustum:function(t,e,r,i,n,o){return k.frustum(this.array,t,e,r,i,n,o),this._dirty=!0,this},identity:function(){return k.identity(this.array),this._dirty=!0,this},invert:function(){return k.invert(this.array,this.array),this._dirty=!0,this},lookAt:function(t,e,r){return k.lookAt(this.array,t.array,e.array,r.array),this._dirty=!0,this},mul:function(t){return k.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return k.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return k.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return k.multiply(this.array,t.array,this.array),this._dirty=!0,this},ortho:function(t,e,r,i,n,o){return k.ortho(this.array,t,e,r,i,n,o),this._dirty=!0,this},perspective:function(t,e,r,i){return k.perspective(this.array,t,e,r,i),this._dirty=!0,this},rotate:function(t,e){return k.rotate(this.array,this.array,t,e.array),this._dirty=!0,this},rotateX:function(t){return k.rotateX(this.array,this.array,t),this._dirty=!0,this},rotateY:function(t){return k.rotateY(this.array,this.array,t),this._dirty=!0,this},rotateZ:function(t){return k.rotateZ(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return k.scale(this.array,this.array,t.array),this._dirty=!0,this},translate:function(t){return k.translate(this.array,this.array,t.array),this._dirty=!0,this},transpose:function(){return k.transpose(this.array,this.array),this._dirty=!0,this},decomposeMatrix:(Le=I.create(),Pe=I.create(),Ne=I.create(),Re=l.create(),function(t,e,r){var i=this.array,n=(I.set(Le,i[0],i[1],i[2]),I.set(Pe,i[4],i[5],i[6]),I.set(Ne,i[8],i[9],i[10]),I.length(Le)),o=I.length(Pe),a=I.length(Ne);this.determinant()<0&&(n=-n),t&&t.set(n,o,a),r.set(i[12],i[13],i[14]),l.fromMat4(Re,i),Re[0]/=n,Re[1]/=n,Re[2]/=n,Re[3]/=o,Re[4]/=o,Re[5]/=o,Re[6]/=a,Re[7]/=a,Re[8]/=a,u.fromMat3(e.array,Re),u.normalize(e.array,e.array),e._dirty=!0,r._dirty=!0}),toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};var Le,Pe,Ne,Re,t=Object.defineProperty;t&&(t(e=De.prototype,"z",{get:function(){var t=this.array;return this._axisZ.set(t[8],t[9],t[10]),this._axisZ},set:function(t){var e=this.array;t=t.array,e[8]=t[0],e[9]=t[1],e[10]=t[2],this._dirty=!0}}),t(e,"y",{get:function(){var t=this.array;return this._axisY.set(t[4],t[5],t[6]),this._axisY},set:function(t){var e=this.array;t=t.array,e[4]=t[0],e[5]=t[1],e[6]=t[2],this._dirty=!0}}),t(e,"x",{get:function(){var t=this.array;return this._axisX.set(t[0],t[1],t[2]),this._axisX},set:function(t){var e=this.array;t=t.array,e[0]=t[0],e[1]=t[1],e[2]=t[2],this._dirty=!0}})),De.adjoint=function(t,e){return k.adjoint(t.array,e.array),t._dirty=!0,t},De.copy=function(t,e){return k.copy(t.array,e.array),t._dirty=!0,t},De.determinant=function(t){return k.determinant(t.array)},De.identity=function(t){return k.identity(t.array),t._dirty=!0,t},De.ortho=function(t,e,r,i,n,o,a){return k.ortho(t.array,e,r,i,n,o,a),t._dirty=!0,t},De.perspective=function(t,e,r,i,n){return k.perspective(t.array,e,r,i,n),t._dirty=!0,t},De.lookAt=function(t,e,r,i){return k.lookAt(t.array,e.array,r.array,i.array),t._dirty=!0,t},De.invert=function(t,e){return k.invert(t.array,e.array),t._dirty=!0,t},De.multiply=De.mul=function(t,e,r){return k.mul(t.array,e.array,r.array),t._dirty=!0,t},De.fromQuat=function(t,e){return k.fromQuat(t.array,e.array),t._dirty=!0,t},De.fromRotationTranslation=function(t,e,r){return k.fromRotationTranslation(t.array,e.array,r.array),t._dirty=!0,t},De.fromMat2d=function(t,e){t._dirty=!0;e=e.array;return(t=t.array)[0]=e[0],t[4]=e[2],t[12]=e[4],t[1]=e[1],t[5]=e[3],t[13]=e[5],t},De.rotate=function(t,e,r,i){return k.rotate(t.array,e.array,r,i.array),t._dirty=!0,t},De.rotateX=function(t,e,r){return k.rotateX(t.array,e.array,r),t._dirty=!0,t},De.rotateY=function(t,e,r){return k.rotateY(t.array,e.array,r),t._dirty=!0,t},De.rotateZ=function(t,e,r){return k.rotateZ(t.array,e.array,r),t._dirty=!0,t},De.scale=function(t,e,r){return k.scale(t.array,e.array,r.array),t._dirty=!0,t},De.transpose=function(t,e){return k.transpose(t.array,e.array),t._dirty=!0,t},De.translate=function(t,e,r){return k.translate(t.array,e.array,r.array),t._dirty=!0,t};const M=De;function Ie(t,e,r,i){t=t||0,e=e||0,r=r||0,i=void 0===i?1:i,this.array=u.fromValues(t,e,r,i),this._dirty=!0}Ie.prototype={constructor:Ie,add:function(t){return u.add(this.array,this.array,t.array),this._dirty=!0,this},calculateW:function(){return u.calculateW(this.array,this.array),this._dirty=!0,this},set:function(t,e,r,i){return this.array[0]=t,this.array[1]=e,this.array[2]=r,this.array[3]=i,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this.array[2]=t[2],this.array[3]=t[3],this._dirty=!0,this},clone:function(){return new Ie(this.x,this.y,this.z,this.w)},conjugate:function(){return u.conjugate(this.array,this.array),this._dirty=!0,this},copy:function(t){return u.copy(this.array,t.array),this._dirty=!0,this},dot:function(t){return u.dot(this.array,t.array)},fromMat3:function(t){return u.fromMat3(this.array,t.array),this._dirty=!0,this},fromMat4:(Oe=l.create(),function(t){return l.fromMat4(Oe,t.array),l.transpose(Oe,Oe),u.fromMat3(this.array,Oe),this._dirty=!0,this}),identity:function(){return u.identity(this.array),this._dirty=!0,this},invert:function(){return u.invert(this.array,this.array),this._dirty=!0,this},len:function(){return u.len(this.array)},length:function(){return u.length(this.array)},lerp:function(t,e,r){return u.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},mul:function(t){return u.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return u.multiply(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return u.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return u.multiply(this.array,t.array,this.array),this._dirty=!0,this},normalize:function(){return u.normalize(this.array,this.array),this._dirty=!0,this},rotateX:function(t){return u.rotateX(this.array,this.array,t),this._dirty=!0,this},rotateY:function(t){return u.rotateY(this.array,this.array,t),this._dirty=!0,this},rotateZ:function(t){return u.rotateZ(this.array,this.array,t),this._dirty=!0,this},rotationTo:function(t,e){return u.rotationTo(this.array,t.array,e.array),this._dirty=!0,this},setAxes:function(t,e,r){return u.setAxes(this.array,t.array,e.array,r.array),this._dirty=!0,this},setAxisAngle:function(t,e){return u.setAxisAngle(this.array,t.array,e),this._dirty=!0,this},slerp:function(t,e,r){return u.slerp(this.array,t.array,e.array,r),this._dirty=!0,this},sqrLen:function(){return u.sqrLen(this.array)},squaredLength:function(){return u.squaredLength(this.array)},fromEuler:function(t,e){return Ie.fromEuler(this,t,e)},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};var Oe,t=Object.defineProperty;t&&(t(e=Ie.prototype,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),t(e,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}}),t(e,"z",{get:function(){return this.array[2]},set:function(t){this.array[2]=t,this._dirty=!0}}),t(e,"w",{get:function(){return this.array[3]},set:function(t){this.array[3]=t,this._dirty=!0}})),Ie.add=function(t,e,r){return u.add(t.array,e.array,r.array),t._dirty=!0,t},Ie.set=function(t,e,r,i,n){u.set(t.array,e,r,i,n),t._dirty=!0},Ie.copy=function(t,e){return u.copy(t.array,e.array),t._dirty=!0,t},Ie.calculateW=function(t,e){return u.calculateW(t.array,e.array),t._dirty=!0,t},Ie.conjugate=function(t,e){return u.conjugate(t.array,e.array),t._dirty=!0,t},Ie.identity=function(t){return u.identity(t.array),t._dirty=!0,t},Ie.invert=function(t,e){return u.invert(t.array,e.array),t._dirty=!0,t},Ie.dot=function(t,e){return u.dot(t.array,e.array)},Ie.len=function(t){return u.length(t.array)},Ie.lerp=function(t,e,r,i){return u.lerp(t.array,e.array,r.array,i),t._dirty=!0,t},Ie.slerp=function(t,e,r,i){return u.slerp(t.array,e.array,r.array,i),t._dirty=!0,t},Ie.multiply=Ie.mul=function(t,e,r){return u.multiply(t.array,e.array,r.array),t._dirty=!0,t},Ie.rotateX=function(t,e,r){return u.rotateX(t.array,e.array,r),t._dirty=!0,t},Ie.rotateY=function(t,e,r){return u.rotateY(t.array,e.array,r),t._dirty=!0,t},Ie.rotateZ=function(t,e,r){return u.rotateZ(t.array,e.array,r),t._dirty=!0,t},Ie.setAxisAngle=function(t,e,r){return u.setAxisAngle(t.array,e.array,r),t._dirty=!0,t},Ie.normalize=function(t,e){return u.normalize(t.array,e.array),t._dirty=!0,t},Ie.squaredLength=Ie.sqrLen=function(t){return u.sqrLen(t.array)},Ie.fromMat3=function(t,e){return u.fromMat3(t.array,e.array),t._dirty=!0,t},Ie.setAxes=function(t,e,r,i){return u.setAxes(t.array,e.array,r.array,i.array),t._dirty=!0,t},Ie.rotationTo=function(t,e,r){return u.rotationTo(t.array,e.array,r.array),t._dirty=!0,t},Ie.fromEuler=function(t,e,r){t._dirty=!0,e=e.array;var i=t.array,n=Math.cos(e[0]/2),o=Math.cos(e[1]/2),a=Math.cos(e[2]/2),s=Math.sin(e[0]/2),l=Math.sin(e[1]/2),h=Math.sin(e[2]/2);switch(r=(r||"XYZ").toUpperCase()){case"XYZ":i[0]=s*o*a+n*l*h,i[1]=n*l*a-s*o*h,i[2]=n*o*h+s*l*a,i[3]=n*o*a-s*l*h;break;case"YXZ":i[0]=s*o*a+n*l*h,i[1]=n*l*a-s*o*h,i[2]=n*o*h-s*l*a,i[3]=n*o*a+s*l*h;break;case"ZXY":i[0]=s*o*a-n*l*h,i[1]=n*l*a+s*o*h,i[2]=n*o*h+s*l*a,i[3]=n*o*a-s*l*h;break;case"ZYX":i[0]=s*o*a-n*l*h,i[1]=n*l*a+s*o*h,i[2]=n*o*h-s*l*a,i[3]=n*o*a+s*l*h;break;case"YZX":i[0]=s*o*a+n*l*h,i[1]=n*l*a+s*o*h,i[2]=n*o*h-s*l*a,i[3]=n*o*a-s*l*h;break;case"XZY":i[0]=s*o*a-n*l*h,i[1]=n*l*a-s*o*h,i[2]=n*o*h+s*l*a,i[3]=n*o*a+s*l*h}};const Be=Ie;function Fe(t,e){this.min=t||new C(1/0,1/0,1/0),this.max=e||new C(-1/0,-1/0,-1/0),this.vertices=null}var ze,Ue,ke,Ge,He,Ve,We=I.set,Xe=I.copy;Fe.prototype={constructor:Fe,updateFromVertices:function(t){if(0<t.length){var e=this.min,r=this.max,i=e.array,n=r.array;Xe(i,t[0]),Xe(n,t[0]);for(var o=1;o<t.length;o++){var a=t[o];a[0]<i[0]&&(i[0]=a[0]),a[1]<i[1]&&(i[1]=a[1]),a[2]<i[2]&&(i[2]=a[2]),a[0]>n[0]&&(n[0]=a[0]),a[1]>n[1]&&(n[1]=a[1]),a[2]>n[2]&&(n[2]=a[2])}e._dirty=!0,r._dirty=!0}},union:function(t){var e=this.min,r=this.max;return I.min(e.array,e.array,t.min.array),I.max(r.array,r.array,t.max.array),e._dirty=!0,r._dirty=!0,this},intersection:function(t){var e=this.min,r=this.max;return I.max(e.array,e.array,t.min.array),I.min(r.array,r.array,t.max.array),e._dirty=!0,r._dirty=!0,this},intersectBoundingBox:function(t){var e=this.min.array,r=this.max.array,i=t.min.array,t=t.max.array;return!(e[0]>t[0]||e[1]>t[1]||e[2]>t[2]||r[0]<i[0]||r[1]<i[1]||r[2]<i[2])},containBoundingBox:function(t){var e=this.min.array,r=this.max.array,i=t.min.array,t=t.max.array;return e[0]<=i[0]&&e[1]<=i[1]&&e[2]<=i[2]&&r[0]>=t[0]&&r[1]>=t[1]&&r[2]>=t[2]},containPoint:function(t){var e=this.min.array,r=this.max.array,t=t.array;return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&r[0]>=t[0]&&r[1]>=t[1]&&r[2]>=t[2]},isFinite:function(){var t=this.min.array,e=this.max.array;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])},applyTransform:function(t){this.transformFrom(this,t)},transformFrom:(ze=I.create(),Ue=I.create(),ke=I.create(),Ge=I.create(),He=I.create(),Ve=I.create(),function(t,e){var r=t.min.array,t=t.max.array,e=e.array;return ze[0]=e[0]*r[0],ze[1]=e[1]*r[0],ze[2]=e[2]*r[0],Ue[0]=e[0]*t[0],Ue[1]=e[1]*t[0],Ue[2]=e[2]*t[0],ke[0]=e[4]*r[1],ke[1]=e[5]*r[1],ke[2]=e[6]*r[1],Ge[0]=e[4]*t[1],Ge[1]=e[5]*t[1],Ge[2]=e[6]*t[1],He[0]=e[8]*r[2],He[1]=e[9]*r[2],He[2]=e[10]*r[2],Ve[0]=e[8]*t[2],Ve[1]=e[9]*t[2],Ve[2]=e[10]*t[2],r=this.min.array,t=this.max.array,r[0]=Math.min(ze[0],Ue[0])+Math.min(ke[0],Ge[0])+Math.min(He[0],Ve[0])+e[12],r[1]=Math.min(ze[1],Ue[1])+Math.min(ke[1],Ge[1])+Math.min(He[1],Ve[1])+e[13],r[2]=Math.min(ze[2],Ue[2])+Math.min(ke[2],Ge[2])+Math.min(He[2],Ve[2])+e[14],t[0]=Math.max(ze[0],Ue[0])+Math.max(ke[0],Ge[0])+Math.max(He[0],Ve[0])+e[12],t[1]=Math.max(ze[1],Ue[1])+Math.max(ke[1],Ge[1])+Math.max(He[1],Ve[1])+e[13],t[2]=Math.max(ze[2],Ue[2])+Math.max(ke[2],Ge[2])+Math.max(He[2],Ve[2])+e[14],this.min._dirty=!0,this.max._dirty=!0,this}),applyProjection:function(t){var e=this.min.array,r=this.max.array,t=t.array,i=e[0],n=e[1],o=e[2],a=r[0],s=r[1],l=e[2],h=r[0],u=r[1],c=r[2];return 1===t[15]?(e[0]=t[0]*i+t[12],e[1]=t[5]*n+t[13],r[2]=t[10]*o+t[14],r[0]=t[0]*h+t[12],r[1]=t[5]*u+t[13],e[2]=t[10]*c+t[14]):(e[0]=t[0]*i*(h=-1/o),e[1]=t[5]*n*h,r[2]=(t[10]*o+t[14])*h,r[0]=t[0]*a*(h=-1/l),r[1]=t[5]*s*h,e[2]=(t[10]*c+t[14])*(h=-1/c)),this.min._dirty=!0,this.max._dirty=!0,this},updateVertices:function(){if(!(t=this.vertices)){for(var t=[],e=0;e<8;e++)t[e]=I.fromValues(0,0,0);this.vertices=t}var r=this.min.array,i=this.max.array;return We(t[0],r[0],r[1],r[2]),We(t[1],r[0],i[1],r[2]),We(t[2],i[0],r[1],r[2]),We(t[3],i[0],i[1],r[2]),We(t[4],r[0],r[1],i[2]),We(t[5],r[0],i[1],i[2]),We(t[6],i[0],r[1],i[2]),We(t[7],i[0],i[1],i[2]),this},copy:function(t){var e=this.min,r=this.max;return Xe(e.array,t.min.array),Xe(r.array,t.max.array),e._dirty=!0,r._dirty=!0,this},clone:function(){var t=new Fe;return t.copy(this),t}};const je=Fe;var qe,Ze,Ye,Ke,Qe,Je,$e,tr=0;function er(t){return!t.invisible&&t.geometry}const rr=P.extend({name:"",position:null,rotation:null,scale:null,worldTransform:null,localTransform:null,autoUpdateLocalTransform:!0,_parent:null,_scene:null,_needsUpdateWorldTransform:!0,_inIterating:!1,__depth:0},function(){this.name||(this.name=(this.type||"NODE")+"_"+tr++),this.position||(this.position=new C),this.rotation||(this.rotation=new Be),this.scale||(this.scale=new C(1,1,1)),this.worldTransform=new M,this.localTransform=new M,this._children=[]},{target:null,invisible:!1,isSkinnedMesh:function(){return!1},isRenderable:function(){return!1},setName:function(t){var e=this._scene;e&&(delete(e=e._nodeRepository)[this.name],e[t]=this),this.name=t},add:function(t){var e=t._parent;e!==this&&(e&&e.remove(t),(t._parent=this)._children.push(t),(e=this._scene)&&e!==t.scene&&t.traverse(this._addSelfToScene,this),t._needsUpdateWorldTransform=!0)},remove:function(t){var e=this._children,r=e.indexOf(t);r<0||(e.splice(r,1),t._parent=null,this._scene&&t.traverse(this._removeSelfFromScene,this))},removeAll:function(){for(var t=this._children,e=0;e<t.length;e++)t[e]._parent=null,this._scene&&t[e].traverse(this._removeSelfFromScene,this);this._children=[]},getScene:function(){return this._scene},getParent:function(){return this._parent},_removeSelfFromScene:function(t){t._scene.removeFromScene(t),t._scene=null},_addSelfToScene:function(t){this._scene.addToScene(t),t._scene=this._scene},isAncestor:function(t){for(var e=t._parent;e;){if(e===this)return!0;e=e._parent}return!1},children:function(){return this._children.slice()},childAt:function(t){return this._children[t]},getChildByName:function(t){for(var e=this._children,r=0;r<e.length;r++)if(e[r].name===t)return e[r]},getDescendantByName:function(t){for(var e=this._children,r=0;r<e.length;r++){var i=e[r];if(i.name===t)return i;i=i.getDescendantByName(t);if(i)return i}},queryNode:function(t){if(t){for(var e=t.split("/"),r=this,i=0;i<e.length;i++){var n=e[i];if(n){for(var o=!1,a=r._children,s=0;s<a.length;s++){var l=a[s];if(l.name===n){r=l,o=!0;break}}if(!o)return}}return r}},getPath:function(t){if(!this._parent)return"/";for(var e=this._parent,r=this.name;e._parent&&(r=e.name+"/"+r,e._parent!=t);)e=e._parent;return!e._parent&&t?null:r},traverse:function(t,e){t.call(e,this);for(var r=this._children,i=0,n=r.length;i<n;i++)r[i].traverse(t,e)},eachChild:function(t,e){for(var r=this._children,i=0,n=r.length;i<n;i++){var o=r[i];t.call(e,o,i)}},setLocalTransform:function(t){k.copy(this.localTransform.array,t.array),this.decomposeLocalTransform()},decomposeLocalTransform:function(t){t=t?null:this.scale;this.localTransform.decomposeMatrix(t,this.rotation,this.position)},setWorldTransform:function(t){k.copy(this.worldTransform.array,t.array),this.decomposeWorldTransform()},decomposeWorldTransform:($e=k.create(),function(t){var e=this.localTransform,r=this.worldTransform,r=(this._parent?(k.invert($e,this._parent.worldTransform.array),k.multiply(e.array,$e,r.array)):k.copy(e.array,r.array),t?null:this.scale);e.decomposeMatrix(r,this.rotation,this.position)}),transformNeedsUpdate:function(){return this.position._dirty||this.rotation._dirty||this.scale._dirty},updateLocalTransform:function(){var t,e=this.position,r=this.rotation,i=this.scale;this.transformNeedsUpdate()&&(t=this.localTransform.array,k.fromRotationTranslation(t,r.array,e.array),k.scale(t,t,i.array),r._dirty=!1,i._dirty=!1,e._dirty=!1,this._needsUpdateWorldTransform=!0)},_updateWorldTransformTopDown:function(){var t=this.localTransform.array,e=this.worldTransform.array;this._parent?k.multiplyAffine(e,this._parent.worldTransform.array,t):k.copy(e,t)},updateWorldTransform:function(){for(var t=this;t&&t.getParent()&&t.getParent().transformNeedsUpdate();)t=t.getParent();t.update()},update:function(t){this.autoUpdateLocalTransform?this.updateLocalTransform():t=!0,(t||this._needsUpdateWorldTransform)&&(this._updateWorldTransformTopDown(),this._needsUpdateWorldTransform=!(t=!0));for(var e=this._children,r=0,i=e.length;r<i;r++)e[r].update(t)},getBoundingBox:(Ke=new je,Qe=new M,Je=new M,function(t,e){return e=e||new je,this._parent?M.invert(Je,this._parent.worldTransform):M.identity(Je),this.traverse(function(t){t.geometry&&t.geometry.boundingBox&&(Ke.copy(t.geometry.boundingBox),M.multiply(Qe,Je,t.worldTransform),Ke.applyTransform(Qe),e.union(Ke))},this,er),e}),getWorldPosition:function(t){this.transformNeedsUpdate()&&this.updateWorldTransform();var e,r=this.worldTransform.array;return t?((e=t.array)[0]=r[12],e[1]=r[13],e[2]=r[14],t):new C(r[12],r[13],r[14])},clone:function(){var t=new this.constructor,e=this._children;t.setName(this.name),t.position.copy(this.position),t.rotation.copy(this.rotation),t.scale.copy(this.scale);for(var r=0;r<e.length;r++)t.add(e[r].clone());return t},rotateAround:(Ze=new C,Ye=new M,function(t,e,r){Ze.copy(this.position).subtract(t);var i=this.localTransform;i.identity(),i.translate(t),i.rotate(r,e),Ye.fromRotationTranslation(this.rotation,Ze),i.multiply(Ye),i.scale(this.scale),this.decomposeLocalTransform(),this._needsUpdateWorldTransform=!0}),lookAt:(qe=new M,function(t,e){qe.lookAt(this.position,t,e||this.localTransform.y).invert(),this.setLocalTransform(qe),this.target=t})});var ir,t=rr.extend({material:null,geometry:null,mode:E.TRIANGLES,_renderInfo:null},{__program:null,lightGroup:0,renderOrder:0,culling:!0,cullFace:E.BACK,frontFace:E.CCW,frustumCulling:!0,receiveShadow:!0,castShadow:!0,ignorePicking:!1,ignorePreZ:!1,ignoreGBuffer:!1,isRenderable:function(){return this.geometry&&this.material&&this.material.shader&&!this.invisible&&0<this.geometry.vertexCount},beforeRender:function(t){},afterRender:function(t,e){},getBoundingBox:function(t,e){return e=rr.prototype.getBoundingBox.call(this,t,e),this.geometry&&this.geometry.boundingBox&&e.union(this.geometry.boundingBox),e},clone:(ir=["castShadow","receiveShadow","mode","culling","cullFace","frontFace","frustumCulling","renderOrder","lineWidth","ignorePicking","ignorePreZ","ignoreGBuffer"],function(){var t=rr.prototype.clone.call(this);t.geometry=this.geometry,t.material=this.material;for(var e=0;e<ir.length;e++){var r=ir[e];t[r]!==this[r]&&(t[r]=this[r])}return t})});t.POINTS=E.POINTS,t.LINES=E.LINES,t.LINE_LOOP=E.LINE_LOOP,t.LINE_STRIP=E.LINE_STRIP,t.TRIANGLES=E.TRIANGLES,t.TRIANGLE_STRIP=E.TRIANGLE_STRIP,t.TRIANGLE_FAN=E.TRIANGLE_FAN,t.BACK=E.BACK,t.FRONT=E.FRONT,t.FRONT_AND_BACK=E.FRONT_AND_BACK,t.CW=E.CW,t.CCW=E.CCW;const nr=t;var or,ar,sr,lr,hr,ur=P.extend({scene:null,camera:null,renderer:null},function(){this._ray=new we,this._ndc=new Et},{pick:function(t,e,r){return this.pickAll(t,e,[],r)[0]||null},pickAll:function(t,e,r,i){return this.renderer.screenToNDC(t,e,this._ndc),this.camera.castRay(this._ndc,this._ray),this._intersectNode(this.scene,r=r||[],i||!1),r.sort(this._intersectionCompareFunc),r},_intersectNode:function(t,e,r){t instanceof nr&&t.isRenderable()&&(t.ignorePicking&&!r||!(t.mode===E.TRIANGLES&&t.geometry.isUseIndices()||t.geometry.pickByRay||t.geometry.pick)||this._intersectRenderable(t,e));for(var i=0;i<t._children.length;i++)this._intersectNode(t._children[i],e,r)},_intersectRenderable:(or=new C,ar=new C,sr=new C,lr=new we,hr=new M,function(t,e){var r=t.isSkinnedMesh(),i=(lr.copy(this._ray),M.invert(hr,t.worldTransform),r||lr.applyTransform(hr),t.geometry),n=(r?t.skeleton:i).boundingBox;if(!n||lr.intersectBoundingBox(n))if(i.pick)i.pick(this._ndc.x,this._ndc.y,this.renderer,this.camera,t,e);else if(i.pickByRay)i.pickByRay(lr,t,e);else{var o=t.cullFace===E.BACK&&t.frontFace===E.CCW||t.cullFace===E.FRONT&&t.frontFace===E.CW,a=i.indices,s=i.attributes.position,l=i.attributes.weight,h=i.attributes.joint,u=[];if(s&&s.value&&a){if(r){for(var c=t.skeleton.getSubSkinMatrices(t.__uid__,t.joints),d=0;d<t.joints.length;d++){u[d]=u[d]||[];for(var f=0;f<16;f++)u[d][f]=c[16*d+f]}var p=[],m=[],g=[],_=[],y=[],v=i.attributes.skinnedPosition;v&&v.value||(i.createAttribute("skinnedPosition","f",3),(v=i.attributes.skinnedPosition).init(i.vertexCount));for(d=0;d<i.vertexCount;d++){s.get(d,p),l.get(d,m),h.get(d,g),m[3]=1-m[0]-m[1]-m[2],I.set(_,0,0,0);for(f=0;f<4;f++)0<=g[f]&&1e-4<m[f]&&(I.transformMat4(y,p,u[g[f]]),I.scaleAndAdd(_,_,y,m[f]));v.set(d,_)}}for(d=0;d<a.length;d+=3){var x,T=a[d],b=a[d+1],w=a[d+2],S=r?i.attributes.skinnedPosition:s;S.get(T,or.array),S.get(b,ar.array),S.get(w,sr.array),(S=o?lr.intersectTriangle(or,ar,sr,t.culling):lr.intersectTriangle(or,sr,ar,t.culling))&&(x=new C,r?C.copy(x,S):C.transformMat4(x,S,t.worldTransform),e.push(new ur.Intersection(S,x,t,[T,b,w],d/3,C.dist(x,this._ray.origin))))}}}}),_intersectionCompareFunc:function(t,e){return t.distance-e.distance}});ur.Intersection=function(t,e,r,i,n,o){this.point=t,this.pointWorld=e,this.target=r,this.triangle=i,this.triangleIndex=n,this.distance=o};const cr=ur;function dr(){this._contextId=0,this._caches=[],this._context={}}var fr="__dt__";const pr=(dr.prototype={use:function(t,e){var r=this._caches;r[t]||(r[t]={},e&&(r[t]=e())),this._contextId=t,this._context=r[t]},put:function(t,e){this._context[t]=e},get:function(t){return this._context[t]},dirty:function(t){this.put(fr+(t=t||""),!0)},dirtyAll:function(t){for(var e=fr+(t=t||""),r=this._caches,i=0;i<r.length;i++)r[i]&&(r[i][e]=!0)},fresh:function(t){this.put(fr+(t=t||""),!1)},freshAll:function(t){for(var e=fr+(t=t||""),r=this._caches,i=0;i<r.length;i++)r[i]&&(r[i][e]=!1)},isDirty:function(t){var t=fr+(t=t||""),e=this._context;return!e.hasOwnProperty(t)||!0===e[t]},deleteContext:function(t){delete this._caches[t],this._context={}},delete:function(t){delete this._context[t]},clearAll:function(){this._caches={}},getContext:function(){return this._context},eachContext:function(e,r){Object.keys(this._caches).forEach(function(t){e&&e.call(r,t)})},miss:function(t){return!this._context.hasOwnProperty(t)}}).constructor=dr;var c=P.extend({width:512,height:512,type:E.UNSIGNED_BYTE,format:E.RGBA,wrapS:E.REPEAT,wrapT:E.REPEAT,minFilter:E.LINEAR_MIPMAP_LINEAR,magFilter:E.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,sRGB:!0,unpackAlignment:4,premultiplyAlpha:!1,dynamic:!1,NPOT:!1,__used:0},function(){this._cache=new pr},{getWebGLTexture:function(t){var e=t.gl,r=this._cache;return r.use(t.__uid__),r.miss("webgl_texture")&&r.put("webgl_texture",e.createTexture()),this.dynamic?this.update(t):r.isDirty()&&(this.update(t),r.fresh()),r.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){this._cache&&this._cache.dirtyAll()},update:function(t){},updateCommon:function(t){var e=t.gl,e=(e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),this.format===E.DEPTH_COMPONENT&&(this.useMipmap=!1),t.getGLExtension("EXT_sRGB"));this.format!==c.SRGB||e||(this.format=c.RGB),this.format!==c.SRGB_ALPHA||e||(this.format=c.RGBA),this.NPOT=!this.isPowerOfTwo()},getAvailableWrapS:function(){return this.NPOT?E.CLAMP_TO_EDGE:this.wrapS},getAvailableWrapT:function(){return this.NPOT?E.CLAMP_TO_EDGE:this.wrapT},getAvailableMinFilter:function(){var t=this.minFilter;return this.NPOT||!this.useMipmap?t===E.NEAREST_MIPMAP_NEAREST||t===E.NEAREST_MIPMAP_LINEAR?E.NEAREST:t===E.LINEAR_MIPMAP_LINEAR||t===E.LINEAR_MIPMAP_NEAREST?E.LINEAR:t:t},getAvailableMagFilter:function(){return this.magFilter},nextHighestPowerOfTwo:function(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1},dispose:function(t){var e=this._cache,r=(e.use(t.__uid__),e.get("webgl_texture"));r&&t.gl.deleteTexture(r),e.deleteContext(t.__uid__)},isRenderable:function(){},isPowerOfTwo:function(){}});Object.defineProperty(c.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t}}),Object.defineProperty(c.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t}}),c.BYTE=E.BYTE,c.UNSIGNED_BYTE=E.UNSIGNED_BYTE,c.SHORT=E.SHORT,c.UNSIGNED_SHORT=E.UNSIGNED_SHORT,c.INT=E.INT,c.UNSIGNED_INT=E.UNSIGNED_INT,c.FLOAT=E.FLOAT,c.HALF_FLOAT=36193,c.UNSIGNED_INT_24_8_WEBGL=34042,c.DEPTH_COMPONENT=E.DEPTH_COMPONENT,c.DEPTH_STENCIL=E.DEPTH_STENCIL,c.ALPHA=E.ALPHA,c.RGB=E.RGB,c.RGBA=E.RGBA,c.LUMINANCE=E.LUMINANCE,c.LUMINANCE_ALPHA=E.LUMINANCE_ALPHA,c.SRGB=35904,c.SRGB_ALPHA=35906,c.COMPRESSED_RGB_S3TC_DXT1_EXT=33776,c.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777,c.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778,c.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779,c.NEAREST=E.NEAREST,c.LINEAR=E.LINEAR,c.NEAREST_MIPMAP_NEAREST=E.NEAREST_MIPMAP_NEAREST,c.LINEAR_MIPMAP_NEAREST=E.LINEAR_MIPMAP_NEAREST,c.NEAREST_MIPMAP_LINEAR=E.NEAREST_MIPMAP_LINEAR,c.LINEAR_MIPMAP_LINEAR=E.LINEAR_MIPMAP_LINEAR,c.REPEAT=E.REPEAT,c.CLAMP_TO_EDGE=E.CLAMP_TO_EDGE,c.MIRRORED_REPEAT=E.MIRRORED_REPEAT;const B=c;e=nr.extend({skeleton:null,joints:null},function(){this.joints||(this.joints=[])},{offsetMatrix:null,isInstancedMesh:function(){return!1},isSkinnedMesh:function(){return!!(this.skeleton&&this.joints&&0<this.joints.length)},clone:function(){var t=nr.prototype.clone.call(this);return t.skeleton=this.skeleton,this.joints&&(t.joints=this.joints.slice()),t}});e.POINTS=E.POINTS,e.LINES=E.LINES,e.LINE_LOOP=E.LINE_LOOP,e.LINE_STRIP=E.LINE_STRIP,e.TRIANGLES=E.TRIANGLES,e.TRIANGLE_STRIP=E.TRIANGLE_STRIP,e.TRIANGLE_FAN=E.TRIANGLE_FAN,e.BACK=E.BACK,e.FRONT=E.FRONT,e.FRONT_AND_BACK=E.FRONT_AND_BACK,e.CW=E.CW,e.CCW=E.CCW;const mr=e;var t={isPowerOfTwo:function(t){return 0==(t&t-1)},nextPowerOfTwo:function(t){return t--,t=(t=(t=(t=(t|=t>>1)|t>>2)|t>>4)|t>>8)|t>>16,++t},nearestPowerOfTwo:function(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}},e=t,gr=e.isPowerOfTwo;function _r(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}t=B.extend(function(){return{image:null,pixels:null,mipmaps:[],convertToPOT:!1}},{textureType:"texture2D",update:function(t){var e=t.gl,r=(e.bindTexture(e.TEXTURE_2D,this._cache.get("webgl_texture")),this.updateCommon(t),this.format),i=this.type,n=!(!this.convertToPOT||this.mipmaps.length||!this.image||this.wrapS!==B.REPEAT&&this.wrapT!==B.REPEAT||!this.NPOT),o=(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,n?this.wrapS:this.getAvailableWrapS()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,n?this.wrapT:this.getAvailableWrapT()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n?this.magFilter:this.getAvailableMagFilter()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n?this.minFilter:this.getAvailableMinFilter()),t.getGLExtension("EXT_texture_filter_anisotropic"));if(o&&1<this.anisotropic&&e.texParameterf(e.TEXTURE_2D,o.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),36193!==i||t.getGLExtension("OES_texture_half_float")||(i=E.FLOAT),this.mipmaps.length)for(var a=this.width,s=this.height,l=0;l<this.mipmaps.length;l++){var h=this.mipmaps[l];this._updateTextureData(e,h,l,a,s,r,i,!1),a/=2,s/=2}else this._updateTextureData(e,this,0,this.width,this.height,r,i,n),!this.useMipmap||this.NPOT&&!n||e.generateMipmap(e.TEXTURE_2D);e.bindTexture(e.TEXTURE_2D,null)},_updateTextureData:function(t,e,r,i,n,o,a,s){var l,h,u,c;e.image?(l=e.image,s&&(this._potCanvas=(h=(s=this)._potCanvas,u=_r(s.width),c=_r(s.height),(h=h||document.createElement("canvas")).width=u,h.height=c,h.getContext("2d").drawImage(s.image,0,0,u,c),h),l=this._potCanvas),t.texImage2D(t.TEXTURE_2D,r,o,o,a,l)):o<=B.COMPRESSED_RGBA_S3TC_DXT5_EXT&&o>=B.COMPRESSED_RGB_S3TC_DXT1_EXT?t.compressedTexImage2D(t.TEXTURE_2D,r,o,i,n,0,e.pixels):t.texImage2D(t.TEXTURE_2D,r,o,i,n,0,o,a,e.pixels)},generateMipmap:function(t){t=t.gl;this.useMipmap&&!this.NPOT&&(t.bindTexture(t.TEXTURE_2D,this._cache.get("webgl_texture")),t.generateMipmap(t.TEXTURE_2D))},isPowerOfTwo:function(){return gr(this.width)&&gr(this.height)},isRenderable:function(){return this.image?0<this.image.width&&0<this.image.height:!(!this.width||!this.height)},bind:function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,this.getWebGLTexture(t))},unbind:function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,null)},load:function(t,e){var r=$.createImage(),i=(e&&(r.crossOrigin=e),this);return r.onload=function(){i.dirty(),i.trigger("success",i)},r.onerror=function(){i.trigger("error",i)},r.src=t,this.image=r,this}});Object.defineProperty(t.prototype,"width",{get:function(){return this.image?this.image.width:this._width},set:function(t){this.image?console.warn("Texture from image can't set width"):(this._width!==t&&this.dirty(),this._width=t)}}),Object.defineProperty(t.prototype,"height",{get:function(){return this.image?this.image.height:this._height},set:function(t){this.image?console.warn("Texture from image can't set height"):(this._height!==t&&this.dirty(),this._height=t)}});const F=t;function yr(t){return{byte:$.Int8Array,ubyte:$.Uint8Array,short:$.Int16Array,ushort:$.Uint16Array}[t]||$.Float32Array}function vr(t){return"attr_"+t}function xr(t,e,r,i){switch(this.name=t,this.type=e,this.size=r,this.semantic=i||"",this.value=null,r){case 1:this.get=function(t){return this.value[t]},this.set=function(t,e){this.value[t]=e},this.copy=function(t,e){this.value[t]=this.value[t]};break;case 2:this.get=function(t,e){var r=this.value;return e[0]=r[2*t],e[1]=r[2*t+1],e},this.set=function(t,e){var r=this.value;r[2*t]=e[0],r[2*t+1]=e[1]},this.copy=function(t,e){var r=this.value;r[t*=2]=r[e*=2],r[t+1]=r[e+1]};break;case 3:this.get=function(t,e){var t=3*t,r=this.value;return e[0]=r[t],e[1]=r[1+t],e[2]=r[2+t],e},this.set=function(t,e){var t=3*t,r=this.value;r[t]=e[0],r[1+t]=e[1],r[2+t]=e[2]},this.copy=function(t,e){var r=this.value;r[t*=3]=r[e*=3],r[t+1]=r[e+1],r[t+2]=r[e+2]};break;case 4:this.get=function(t,e){var r=this.value,t=4*t;return e[0]=r[t],e[1]=r[1+t],e[2]=r[2+t],e[3]=r[3+t],e},this.set=function(t,e){var r=this.value,t=4*t;r[t]=e[0],r[1+t]=e[1],r[2+t]=e[2],r[3+t]=e[3]},this.copy=function(t,e){var r=this.value;r[t*=4]=r[e*=4],r[t+1]=r[e+1],r[t+2]=r[e+2],r[t+3]=r[e+3]}}}function Tr(t,e,r,i,n){this.name=t,this.type=e,this.buffer=r,this.size=i,this.semantic=n,this.symbol="",this.needsRemove=!1}function br(t){this.buffer=t,this.count=0}xr.prototype.init=function(t){var e;this.value&&this.value.length===t*this.size||(e=yr(this.type),this.value=new e(t*this.size))},xr.prototype.fromArray=function(t){var e=yr(this.type);if(t[0]&&t[0].length)for(var r=0,i=this.size,n=new e(t.length*i),o=0;o<t.length;o++)for(var a=0;a<i;a++)n[r++]=t[o][a];else n=new e(t);this.value=n},xr.prototype.clone=function(t){var e=new xr(this.name,this.type,this.size,this.semantic);return t&&console.warn("todo"),e};var t=P.extend(function(){return{attributes:{},indices:null,dynamic:!0,_enabledAttributes:null,__used:0}},function(){this._cache=new pr,this._attributeList=Object.keys(this.attributes),this.__vaoCache={}},{mainAttribute:"",pick:null,pickByRay:null,dirty:function(){for(var t=this.getEnabledAttributes(),e=0;e<t.length;e++)this.dirtyAttribute(t[e]);this.dirtyIndices(),this._enabledAttributes=null,this._cache.dirty("any")},dirtyIndices:function(){this._cache.dirtyAll("indices")},dirtyAttribute:function(t){this._cache.dirtyAll(vr(t)),this._cache.dirtyAll("attributes")},getTriangleIndices:function(t,e){var r;if(t<this.triangleCount&&0<=t)return r=this.indices,(e=e||[])[0]=r[3*t],e[1]=r[3*t+1],e[2]=r[3*t+2],e},setTriangleIndices:function(t,e){var r=this.indices;r[3*t]=e[0],r[3*t+1]=e[1],r[3*t+2]=e[2]},isUseIndices:function(){return!!this.indices},initIndicesFromArray:function(t){var e=65535<this.vertexCount?$.Uint32Array:$.Uint16Array;if(t[0]&&t[0].length)for(var r=0,i=new e(3*t.length),n=0;n<t.length;n++)for(var o=0;o<3;o++)i[r++]=t[n][o];else i=new e(t);this.indices=i},createAttribute:function(t,e,r,i){e=new xr(t,e,r,i);return this.attributes[t]&&this.removeAttribute(t),this.attributes[t]=e,this._attributeList.push(t),e},removeAttribute:function(t){var e=this._attributeList,r=e.indexOf(t);return 0<=r&&(e.splice(r,1),delete this.attributes[t],!0)},getAttribute:function(t){return this.attributes[t]},getEnabledAttributes:function(){var t=this._enabledAttributes,e=this._attributeList;if(t)return t;for(var r=[],i=this.vertexCount,n=0;n<e.length;n++){var o=e[n],a=this.attributes[o];a.value&&a.value.length===i*a.size&&r.push(o)}return this._enabledAttributes=r},getBufferChunks:function(t){var e=this._cache,r=(e.use(t.__uid__),e.isDirty("attributes")),i=e.isDirty("indices");if(r||i){this._updateBuffer(t.gl,r,i);for(var n=this.getEnabledAttributes(),o=0;o<n.length;o++)e.fresh(vr(n[o]));e.fresh("attributes"),e.fresh("indices")}return e.fresh("any"),e.get("chunks")},_updateBuffer:function(t,e,r){var i=this._cache,n=i.get("chunks"),o=!1,n=(n||((n=[])[0]={attributeBuffers:[],indicesBuffer:null},i.put("chunks",n),o=!0),n[0]),a=n.attributeBuffers,s=n.indicesBuffer;if(e||o){var l=this.getEnabledAttributes(),h={};if(!o)for(var u=0;u<a.length;u++)h[a[u].name]=a[u];for(var c=0;c<l.length;c++){var d,f=l[c],p=this.attributes[f],m=(d=o?d:h[f])?d.buffer:t.createBuffer();i.isDirty(vr(f))&&(t.bindBuffer(t.ARRAY_BUFFER,m),t.bufferData(t.ARRAY_BUFFER,p.value,this.dynamic?t.DYNAMIC_DRAW:t.STATIC_DRAW)),a[c]=new Tr(f,p.type,m,p.size,p.semantic)}for(u=c;u<a.length;u++)t.deleteBuffer(a[u].buffer);a.length=c}this.isUseIndices()&&(r||o)&&(s||(s=new br(t.createBuffer()),n.indicesBuffer=s),s.count=this.indices.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,this.dynamic?t.DYNAMIC_DRAW:t.STATIC_DRAW))},dispose:function(t){var e=this._cache,r=(e.use(t.__uid__),e.get("chunks"));if(r)for(var i=0;i<r.length;i++){for(var n=r[i],o=0;o<n.attributeBuffers.length;o++){var a=n.attributeBuffers[o];t.gl.deleteBuffer(a.buffer)}n.indicesBuffer&&t.gl.deleteBuffer(n.indicesBuffer.buffer)}if(this.__vaoCache){var s,l=t.getGLExtension("OES_vertex_array_object");for(s in this.__vaoCache){var h=this.__vaoCache[s].vao;h&&l.deleteVertexArrayOES(h)}}this.__vaoCache={},e.deleteContext(t.__uid__)}}),wr=(Object.defineProperty&&(Object.defineProperty(t.prototype,"vertexCount",{enumerable:!1,get:function(){var t=this.attributes[this.mainAttribute];return(t=t||this.attributes[this._attributeList[0]])&&t.value?t.value.length/t.size:0}}),Object.defineProperty(t.prototype,"triangleCount",{enumerable:!1,get:function(){var t=this.indices;return t?t.length/3:0}})),t.STATIC_DRAW=E.STATIC_DRAW,t.DYNAMIC_DRAW=E.DYNAMIC_DRAW,t.STREAM_DRAW=E.STREAM_DRAW,t.AttributeBuffer=Tr,t.IndicesBuffer=br,t.Attribute=xr,I.create),Sr=I.add,Er=I.set,Mr=t.Attribute,d=t.extend(function(){return{attributes:{position:new Mr("position","float",3,"POSITION"),texcoord0:new Mr("texcoord0","float",2,"TEXCOORD_0"),texcoord1:new Mr("texcoord1","float",2,"TEXCOORD_1"),normal:new Mr("normal","float",3,"NORMAL"),tangent:new Mr("tangent","float",4,"TANGENT"),color:new Mr("color","float",4,"COLOR"),weight:new Mr("weight","float",3,"WEIGHT"),joint:new Mr("joint","float",4,"JOINT"),barycentric:new Mr("barycentric","float",3,null)},boundingBox:null}},{mainAttribute:"position",updateBoundingBox:function(){var t=(t=this.boundingBox)||(this.boundingBox=new je),e=this.attributes.position.value;if(e&&e.length){var r=t.min,t=t.max,i=r.array,n=t.array;I.set(i,e[0],e[1],e[2]),I.set(n,e[0],e[1],e[2]);for(var o=3;o<e.length;){var a=e[o++],s=e[o++],l=e[o++];a<i[0]&&(i[0]=a),s<i[1]&&(i[1]=s),l<i[2]&&(i[2]=l),a>n[0]&&(n[0]=a),s>n[1]&&(n[1]=s),l>n[2]&&(n[2]=l)}r._dirty=!0,t._dirty=!0}},generateVertexNormals:function(){if(this.vertexCount){var t=this.indices,e=this.attributes,r=e.position.value,i=e.normal.value;if(i&&i.length===r.length)for(var n=0;n<i.length;n++)i[n]=0;else i=e.normal.value=new $.Float32Array(r.length);for(var o,a,s,l=wr(),h=wr(),u=wr(),c=wr(),d=wr(),f=wr(),p=t?t.length:this.vertexCount,m=0;m<p;){s=t?(o=t[m++],a=t[m++],t[m++]):(o=m++,a=m++,m++),Er(l,r[3*o],r[3*o+1],r[3*o+2]),Er(h,r[3*a],r[3*a+1],r[3*a+2]),Er(u,r[3*s],r[3*s+1],r[3*s+2]),I.sub(c,l,h),I.sub(d,h,u),I.cross(f,c,d);for(n=0;n<3;n++)i[3*o+n]=i[3*o+n]+f[n],i[3*a+n]=i[3*a+n]+f[n],i[3*s+n]=i[3*s+n]+f[n]}for(n=0;n<i.length;)Er(f,i[n],i[n+1],i[n+2]),I.normalize(f,f),i[n++]=f[0],i[n++]=f[1],i[n++]=f[2];this.dirty()}},generateFaceNormals:function(){if(this.vertexCount){this.isUniqueVertex()||this.generateUniqueVertex();for(var t,e,r,i=this.indices,n=this.attributes,o=n.position.value,a=n.normal.value,s=wr(),l=wr(),h=wr(),u=wr(),c=wr(),d=wr(),a=a||(n.normal.value=new Float32Array(o.length)),f=i?i.length:this.vertexCount,p=0;p<f;){r=i?(t=i[p++],e=i[p++],i[p++]):(t=p++,e=p++,p++),Er(s,o[3*t],o[3*t+1],o[3*t+2]),Er(l,o[3*e],o[3*e+1],o[3*e+2]),Er(h,o[3*r],o[3*r+1],o[3*r+2]),I.sub(u,s,l),I.sub(c,l,h),I.cross(d,u,c),I.normalize(d,d);for(var m=0;m<3;m++)a[3*t+m]=d[m],a[3*e+m]=d[m],a[3*r+m]=d[m]}this.dirty()}},generateTangents:function(){if(this.vertexCount){var t=this.vertexCount,e=this.attributes,r=(e.tangent.value||(e.tangent.value=new Float32Array(4*t)),e.texcoord0.value),i=e.position.value,n=e.tangent.value,o=e.normal.value;if(r){for(var a=[],s=[],l=0;l<t;l++)a[l]=[0,0,0],s[l]=[0,0,0];for(var h,u,c=[0,0,0],d=[0,0,0],f=this.indices,p=f?f.length:this.vertexCount,l=0;l<p;){var m=f?(h=f[l++],u=f[l++],f[l++]):(h=l++,u=l++,l++),g=r[2*h],_=r[2*u],y=r[2*m],v=r[2*h+1],x=r[2*u+1],T=r[2*m+1],b=i[3*h],w=i[3*u],S=i[3*m],E=i[3*h+1],M=i[3*u+1],A=i[3*m+1],C=i[3*h+2],w=w-b,S=S-b,b=M-E,M=A-E,A=i[3*u+2]-C,E=i[3*m+2]-C,C=_-g,_=y-g,y=x-v,g=T-v,x=1/(C*g-y*_);c[0]=(g*w-y*S)*x,c[1]=(g*b-y*M)*x,c[2]=(g*A-y*E)*x,d[0]=(C*S-_*w)*x,d[1]=(C*M-_*b)*x,d[2]=(C*E-_*A)*x,Sr(a[h],a[h],c),Sr(a[u],a[u],c),Sr(a[m],a[m],c),Sr(s[h],s[h],d),Sr(s[u],s[u],d),Sr(s[m],s[m],d)}for(var D=wr(),L=wr(),P=wr(),l=0;l<t;l++){P[0]=o[3*l],P[1]=o[3*l+1],P[2]=o[3*l+2];var N=a[l];I.scale(D,P,I.dot(P,N)),I.sub(D,N,D),I.normalize(D,D),I.cross(L,P,N),n[4*l]=D[0],n[4*l+1]=D[1],n[4*l+2]=D[2],n[4*l+3]=I.dot(L,s[l])<0?-1:1}this.dirty()}else console.warn("Geometry without texcoords can't generate tangents.")}},isUniqueVertex:function(){return!this.isUseIndices()||this.vertexCount===this.indices.length},generateUniqueVertex:function(){if(this.vertexCount&&this.indices){65535<this.indices.length&&(this.indices=new $.Uint32Array(this.indices));for(var t=this.attributes,e=this.indices,r=this.getEnabledAttributes(),i={},n=0;n<r.length;n++)i[l=r[n]]=t[l].value,t[l].init(this.indices.length);for(var o=0,a=0;a<e.length;a++){for(var s=e[a],n=0;n<r.length;n++)for(var l,h=t[l=r[n]].value,u=t[l].size,c=0;c<u;c++)h[o*u+c]=i[l][s*u+c];e[a]=o,o++}this.dirty()}},generateBarycentric:function(){if(this.vertexCount){this.isUniqueVertex()||this.generateUniqueVertex();var t=this.attributes,e=t.barycentric.value,r=this.indices;if(!e||e.length!==3*r.length){for(var e=t.barycentric.value=new Float32Array(3*r.length),i=0;i<(r?r.length:this.vertexCount/3);)for(var n=0;n<3;n++)e[3*(r?r[i++]:3*i+n)+n]=1;this.dirty()}}},applyTransform:function(t){var e=this.attributes,r=e.position.value,i=e.normal.value,e=e.tangent.value,n=(t=t.array,k.create()),o=(k.invert(n,t),k.transpose(n,n),I.transformMat4),a=I.forEach;a(r,3,0,null,o,t),i&&a(i,3,0,null,o,n),e&&a(e,4,0,null,o,n),this.boundingBox&&this.updateBoundingBox()},dispose:function(t){var e=this._cache,r=(e.use(t.__uid__),e.get("chunks"));if(r)for(var i=0;i<r.length;i++){for(var n=r[i],o=0;o<n.attributeBuffers.length;o++){var a=n.attributeBuffers[o];t.gl.deleteBuffer(a.buffer)}n.indicesBuffer&&t.gl.deleteBuffer(n.indicesBuffer.buffer)}if(this.__vaoCache){var s,l=t.getGLExtension("OES_vertex_array_object");for(s in this.__vaoCache){var h=this.__vaoCache[s].vao;h&&l.deleteVertexArrayOES(h)}}this.__vaoCache={},e.deleteContext(t.__uid__)}});d.STATIC_DRAW=t.STATIC_DRAW,d.DYNAMIC_DRAW=t.DYNAMIC_DRAW,d.STREAM_DRAW=t.STREAM_DRAW,d.AttributeBuffer=t.AttributeBuffer,d.IndicesBuffer=t.IndicesBuffer,d.Attribute=Mr;const p=d;var t="uniform vec3 ",d="uniform float ",Ar="@export clay.header.",m="@end",g=":unconfigurable;",Ar=[Ar+"directional_light",t+"directionalLightDirection[DIRECTIONAL_LIGHT_COUNT]"+g,t+"directionalLightColor[DIRECTIONAL_LIGHT_COUNT]"+g,m,Ar+"ambient_light",t+"ambientLightColor[AMBIENT_LIGHT_COUNT]"+g,m,Ar+"ambient_sh_light",t+"ambientSHLightColor[AMBIENT_SH_LIGHT_COUNT]"+g,t+"ambientSHLightCoefficients[AMBIENT_SH_LIGHT_COUNT * 9]"+g,"vec3 calcAmbientSHLight(int idx, vec3 N) {\n int offset = 9 * idx;\n return ambientSHLightCoefficients[0]\n + ambientSHLightCoefficients[1] * N.x\n + ambientSHLightCoefficients[2] * N.y\n + ambientSHLightCoefficients[3] * N.z\n + ambientSHLightCoefficients[4] * N.x * N.z\n + ambientSHLightCoefficients[5] * N.z * N.y\n + ambientSHLightCoefficients[6] * N.y * N.x\n + ambientSHLightCoefficients[7] * (3.0 * N.z * N.z - 1.0)\n + ambientSHLightCoefficients[8] * (N.x * N.x - N.y * N.y);\n}",m,Ar+"ambient_cubemap_light",t+"ambientCubemapLightColor[AMBIENT_CUBEMAP_LIGHT_COUNT]"+g,"uniform samplerCube ambientCubemapLightCubemap[AMBIENT_CUBEMAP_LIGHT_COUNT]"+g,"uniform sampler2D ambientCubemapLightBRDFLookup[AMBIENT_CUBEMAP_LIGHT_COUNT]"+g,m,Ar+"point_light",t+"pointLightPosition[POINT_LIGHT_COUNT]"+g,d+"pointLightRange[POINT_LIGHT_COUNT]"+g,t+"pointLightColor[POINT_LIGHT_COUNT]"+g,m,Ar+"spot_light",t+"spotLightPosition[SPOT_LIGHT_COUNT]"+g,t+"spotLightDirection[SPOT_LIGHT_COUNT]"+g,d+"spotLightRange[SPOT_LIGHT_COUNT]"+g,d+"spotLightUmbraAngleCosine[SPOT_LIGHT_COUNT]"+g,d+"spotLightPenumbraAngleCosine[SPOT_LIGHT_COUNT]"+g,d+"spotLightFalloffFactor[SPOT_LIGHT_COUNT]"+g,t+"spotLightColor[SPOT_LIGHT_COUNT]"+g,m].join("\n");S.import(Ar);const Cr=rr.extend(function(){return{color:[1,1,1],intensity:1,castShadow:!0,shadowResolution:512,group:0}},{type:"",clone:function(){var t=rr.prototype.clone.call(this);return t.color=Array.prototype.slice.call(this.color),t.intensity=this.intensity,t.castShadow=this.castShadow,t.shadowResolution=this.shadowResolution,t}});function Dr(t,e){this.normal=t||new C(0,1,0),this.distance=e||0}var Lr,Pr,Nr,Rr;Dr.prototype={constructor:Dr,distanceToPoint:function(t){return I.dot(t.array,this.normal.array)-this.distance},projectPoint:function(t,e){e=e||new C;var r=this.distanceToPoint(t);return I.scaleAndAdd(e.array,t.array,this.normal.array,-r),e._dirty=!0,e},normalize:function(){var t=1/I.len(this.normal.array);I.scale(this.normal.array,t),this.distance*=t},intersectFrustum:function(t){for(var e=t.vertices,r=this.normal.array,i=I.dot(e[0].array,r)>this.distance,n=1;n<8;n++)if(I.dot(e[n].array,r)>this.distance!=i)return!0},intersectLine:(Rr=I.create(),function(t,e,r){var i=this.distanceToPoint(t),n=this.distanceToPoint(e);if(0<i&&0<n||i<0&&n<0)return null;var i=this.normal.array,n=this.distance,o=t.array,e=(I.sub(Rr,e.array,t.array),I.normalize(Rr,Rr),I.dot(i,Rr));if(0===e)return null;r=r||new C;t=(I.dot(i,o)-n)/e;return I.scaleAndAdd(r.array,o,Rr,-t),r._dirty=!0,r}),applyTransform:(Lr=k.create(),Pr=s.create(),(Nr=s.create())[3]=1,function(t){t=t.array,I.scale(Nr,this.normal.array,this.distance),s.transformMat4(Nr,Nr,t),this.distance=I.dot(Nr,this.normal.array),k.invert(Lr,t),k.transpose(Lr,Lr),Pr[3]=0,I.copy(Pr,this.normal.array),s.transformMat4(Pr,Pr,Lr),I.copy(this.normal.array,Pr)}),copy:function(t){I.copy(this.normal.array,t.normal.array),this.normal._dirty=!0,this.distance=t.distance},clone:function(){var t=new Dr;return t.copy(this),t}};const Ir=Dr;function Or(){this.planes=[];for(var t=0;t<6;t++)this.planes.push(new Ir);for(this.boundingBox=new je,this.vertices=[],t=0;t<8;t++)this.vertices[t]=I.fromValues(0,0,0)}var Br,Fr,zr=I.set,Ur=I.copy,kr=I.transformMat4,Gr=Math.min,Hr=Math.max;Or.prototype={setFromProjection:function(t){var e=this.planes,t=t.array,r=t[0],i=t[1],n=t[2],o=t[3],a=t[4],s=t[5],l=t[6],h=t[7],u=t[8],c=t[9],d=t[10],f=t[11],p=t[12],m=t[13],g=t[14],t=t[15],a=(zr(e[0].normal.array,o-r,h-a,f-u),e[0].distance=-(t-p),e[0].normalize(),zr(e[1].normal.array,o+r,h+a,f+u),e[1].distance=-(t+p),e[1].normalize(),zr(e[2].normal.array,o+i,h+s,f+c),e[2].distance=-(t+m),e[2].normalize(),zr(e[3].normal.array,o-i,h-s,f-c),e[3].distance=-(t-m),e[3].normalize(),zr(e[4].normal.array,o-n,h-l,f-d),e[4].distance=-(t-g),e[4].normalize(),zr(e[5].normal.array,o+n,h+l,f+d),e[5].distance=-(t+g),e[5].normalize(),this.boundingBox),u=this.vertices;0===t?(c=-(i=-g/(d-1))/s,a.min.set(-(n=-(o=-g/(d+1))/s)*(h=s/r),-n,o),a.max.set(n*h,n,i),zr(u[0],-n*h,-n,o),zr(u[1],-n*h,n,o),zr(u[2],n*h,-n,o),zr(u[3],n*h,n,o),zr(u[4],-c*h,-c,i),zr(u[5],-c*h,c,i),zr(u[6],c*h,-c,i),zr(u[7],c*h,c,i)):(l=(-1-p)/r,f=(1-p)/r,e=(1-m)/s,t=(-1-m)/s,n=(-1-g)/d,o=(1-g)/d,a.min.set(Math.min(l,f),Math.min(t,e),Math.min(o,n)),a.max.set(Math.max(f,l),Math.max(e,t),Math.max(n,o)),h=a.min.array,c=a.max.array,zr(u[0],h[0],h[1],h[2]),zr(u[1],h[0],c[1],h[2]),zr(u[2],c[0],h[1],h[2]),zr(u[3],c[0],c[1],h[2]),zr(u[4],h[0],h[1],c[2]),zr(u[5],h[0],c[1],c[2]),zr(u[6],c[0],h[1],c[2]),zr(u[7],c[0],c[1],c[2]))},getTransformedBoundingBox:(Br=I.create(),function(t,e){var r=this.vertices,i=e.array,e=t.min,n=t.max,o=e.array,a=n.array,s=r[0];kr(Br,s,i),Ur(o,Br),Ur(a,Br);for(var l=1;l<8;l++)s=r[l],kr(Br,s,i),o[0]=Gr(Br[0],o[0]),o[1]=Gr(Br[1],o[1]),o[2]=Gr(Br[2],o[2]),a[0]=Hr(Br[0],a[0]),a[1]=Hr(Br[1],a[1]),a[2]=Hr(Br[2],a[2]);return e._dirty=!0,n._dirty=!0,t})};const Vr=Or,Wr=rr.extend(function(){return{projectionMatrix:new M,invProjectionMatrix:new M,viewMatrix:new M,frustum:new Vr}},function(){this.update(!0)},{update:function(t){rr.prototype.update.call(this,t),M.invert(this.viewMatrix,this.worldTransform),this.updateProjectionMatrix(),M.invert(this.invProjectionMatrix,this.projectionMatrix),this.frustum.setFromProjection(this.projectionMatrix)},setViewMatrix:function(t){M.copy(this.viewMatrix,t),M.invert(this.worldTransform,t),this.decomposeWorldTransform()},decomposeProjectionMatrix:function(){},setProjectionMatrix:function(t){M.copy(this.projectionMatrix,t),M.invert(this.invProjectionMatrix,t),this.decomposeProjectionMatrix()},updateProjectionMatrix:function(){},castRay:(Fr=s.create(),function(t,e){var e=void 0!==e?e:new we,r=t.array[0],t=t.array[1];return s.set(Fr,r,t,-1,1),s.transformMat4(Fr,Fr,this.invProjectionMatrix.array),s.transformMat4(Fr,Fr,this.worldTransform.array),I.scale(e.origin.array,Fr,1/Fr[3]),s.set(Fr,r,t,1,1),s.transformMat4(Fr,Fr,this.invProjectionMatrix.array),s.transformMat4(Fr,Fr,this.worldTransform.array),I.scale(Fr,Fr,1/Fr[3]),I.sub(e.direction.array,Fr,e.origin.array),I.normalize(e.direction.array,e.direction.array),e.direction._dirty=!0,e.origin._dirty=!0,e})});var Xr,jr,qr=k.create(),Zr=k.create(),Yr={};function Kr(){this.opaque=[],this.transparent=[],this._opaqueCount=0,this._transparentCount=0}function Qr(t,e,r){for(var i in t){var n=t[i];if("tv"===n.type){if(e.hasUniform(i)){for(var o=[],a=0;a<n.value.length;a++){var s=n.value[a],s=e.takeCurrentTextureSlot(r,s);o.push(s)}e.setUniform(r.gl,"1iv",i,o)}}else e.setUniform(r.gl,n.type,i,n.value)}}function Jr(t,e){if(e.castShadow&&!t.castShadow)return!0}Kr.prototype.startCount=function(){this._opaqueCount=0,this._transparentCount=0},Kr.prototype.add=function(t,e){e?this.transparent[this._transparentCount++]=t:this.opaque[this._opaqueCount++]=t},Kr.prototype.endCount=function(){this.transparent.length=this._transparentCount,this.opaque.length=this._opaqueCount};const $r=rr.extend(function(){return{material:null,lights:[],viewBoundingBoxLastFrame:new je,shadowUniforms:{},_cameraList:[],_lightUniforms:{},_previousLightNumber:{},_lightNumber:{},_lightProgramKeys:{},_nodeRepository:{},_renderLists:new it(20)}},function(){this._scene=this},{addToScene:function(t){t instanceof Wr?(0<this._cameraList.length&&console.warn("Found multiple camera in one scene. Use the fist one."),this._cameraList.push(t)):t instanceof Cr&&this.lights.push(t),t.name&&(this._nodeRepository[t.name]=t)},removeFromScene:function(t){var e;t instanceof Wr?0<=(e=this._cameraList.indexOf(t))&&this._cameraList.splice(e,1):t instanceof Cr&&0<=(e=this.lights.indexOf(t))&&this.lights.splice(e,1),t.name&&delete this._nodeRepository[t.name]},getNode:function(t){return this._nodeRepository[t]},setMainCamera:function(t){var e=this._cameraList.indexOf(t);0<=e&&this._cameraList.splice(e,1),this._cameraList.unshift(t)},getMainCamera:function(){return this._cameraList[0]},getLights:function(){return this.lights},updateLights:function(){for(var t,e=this.lights,r=(this._previousLightNumber=this._lightNumber,{}),i=0;i<e.length;i++){var n,o=e[i];o.invisible||(r[n=o.group]||(r[n]={}),r[n][o.type]=r[n][o.type]||0,r[n][o.type]++)}for(t in this._lightNumber=r)this._lightProgramKeys[t]=function(t){var e=[],r=Object.keys(t);r.sort();for(var i=0;i<r.length;i++){var n=r[i];e.push(n+" "+t[n])}var o,a=e.join("\n");return Yr[a]||(o=W.genGUID(),Yr[a]=o)}(r[t]);this._updateLightUniforms()},cloneNode:function(t){var e=t.clone(),n={};return function t(e,r){n[e.__uid__]=r;for(var i=0;i<e._children.length;i++)t(e._children[i],r._children[i])}(t,e),e.traverse(function(t){t.skeleton&&(t.skeleton=t.skeleton.clone(n)),t.material&&(t.material=t.material.clone())}),e},updateRenderList:function(t,e){var r=t.__uid__,i=this._renderLists.get(r),r=(i||(i=new Kr,this._renderLists.put(r,i)),i.startCount(),e&&(this.viewBoundingBoxLastFrame.min.set(1/0,1/0,1/0),this.viewBoundingBoxLastFrame.max.set(-1/0,-1/0,-1/0)),this.material&&this.material.transparent||!1);return this._doUpdateRenderList(this,t,r,i,e),i.endCount(),i},getRenderList:function(t){return this._renderLists.get(t.__uid__)},_doUpdateRenderList:function(t,e,r,i,n){if(!t.invisible)for(var o=0;o<t._children.length;o++){var a,s,l=t._children[o];l.isRenderable()&&(a=l.isSkinnedMesh()?qr:l.worldTransform.array,s=l.geometry,k.multiplyAffine(Zr,e.viewMatrix.array,a),(!n||s.boundingBox)&&this.isFrustumCulled(l,e,Zr)||i.add(l,l.material.transparent||r)),0<l._children.length&&this._doUpdateRenderList(l,e,r,i,n)}},isFrustumCulled:(Xr=new je,jr=new M,function(t,e,r){var i=(i=t.boundingBox)||(t.skeleton&&t.skeleton.boundingBox?t.skeleton:t.geometry).boundingBox;if(i&&(jr.array=r,Xr.transformFrom(i,jr),t.castShadow&&this.viewBoundingBoxLastFrame.union(Xr),t.frustumCulling)){if(!Xr.intersectBoundingBox(e.frustum.boundingBox))return!0;jr.array=e.projectionMatrix.array,0<Xr.max.array[2]&&Xr.min.array[2]<0&&(Xr.max.array[2]=-1e-20),Xr.applyProjection(jr);r=Xr.min.array,i=Xr.max.array;if(i[0]<-1||1<r[0]||i[1]<-1||1<r[1]||i[2]<-1||1<r[2])return!0}return!1}),_updateLightUniforms:function(){var t=this.lights,e=(t.sort(Jr),this._lightUniforms);for(o in e)for(var r in e[o])e[o][r].value.length=0;for(var i=0;i<t.length;i++){var n=t[i];if(!n.invisible){var o=n.group;for(r in n.uniformTemplates){var a=n.uniformTemplates[r],s=a.value(n);if(null!=s){e[o]||(e[o]={}),e[o][r]||(e[o][r]={type:"",value:[]});var l=e[o][r];switch(l.type=a.type+"v",a.type){case"1i":case"1f":case"t":l.value.push(s);break;case"2f":case"3f":case"4f":for(var h=0;h<s.length;h++)l.value.push(s[h]);break;default:console.error("Unkown light uniform type "+a.type)}}}}}},getLightGroups:function(){var t,e=[];for(t in this._lightNumber)e.push(t);return e},getNumberChangedLightGroups:function(){var t,e=[];for(t in this._lightNumber)this.isLightNumberChanged(t)&&e.push(t);return e},isLightNumberChanged:function(t){var e,r=this._previousLightNumber,i=this._lightNumber;for(e in i[t]){if(!r[t])return!0;if(i[t][e]!==r[t][e])return!0}for(e in r[t]){if(!i[t])return!0;if(i[t][e]!==r[t][e])return!0}return!1},getLightsNumbers:function(t){return this._lightNumber[t]},getProgramKey:function(t){return this._lightProgramKeys[t]},setLightUniforms:function(t,e,r){Qr(this._lightUniforms[e],t,r),Qr(this.shadowUniforms,t,r)},dispose:function(){this.material=null,this._opaqueList=[],this._transparentList=[],this.lights=[],this._lightUniforms={},this._lightNumber={},this._nodeRepository={}}});var ti=function(t){this.value=t},ei=(ri.prototype.insert=function(t){t=new ti(t);return this.insertEntry(t),t},ri.prototype.insertEntry=function(t){this.head?((this.tail.next=t).prev=this.tail,t.next=null,this.tail=t):this.head=this.tail=t,this._len++},ri.prototype.remove=function(t){var e=t.prev,r=t.next;e?e.next=r:this.head=r,r?r.prev=e:this.tail=e,t.next=t.prev=null,this._len--},ri.prototype.len=function(){return this._len},ri.prototype.clear=function(){this.head=this.tail=null,this._len=0},ri);function ri(){this._len=0}function ii(t){this._list=new ei,this._maxSize=10,this._map={},this._maxSize=t}ii.prototype.put=function(t,e){var r,i,n=this._list,o=this._map,a=null;return null==o[t]&&(i=n.len(),r=this._lastRemovedEntry,i>=this._maxSize&&0<i&&(i=n.head,n.remove(i),delete o[i.key],a=i.value,this._lastRemovedEntry=i),r?r.value=e:r=new ti(e),r.key=t,n.insertEntry(r),o[t]=r),a},ii.prototype.get=function(t){var t=this._map[t],e=this._list;if(null!=t)return t!==e.tail&&(e.remove(t),e.insertEntry(t)),t.value},ii.prototype.clear=function(){this._list.clear(),this._map={}},ii.prototype.len=function(){return this._list.len()};const ni=ii;var oi=e.isPowerOfTwo,ai=["px","nx","py","ny","pz","nz"],d=B.extend(function(){return{image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},mipmaps:[]}},{textureType:"textureCube",update:function(t){var e=t.gl,r=(e.bindTexture(e.TEXTURE_CUBE_MAP,this._cache.get("webgl_texture")),this.updateCommon(t),this.format),i=this.type,n=(e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,this.getAvailableWrapS()),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,this.getAvailableWrapT()),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,this.getAvailableMagFilter()),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,this.getAvailableMinFilter()),t.getGLExtension("EXT_texture_filter_anisotropic"));if(n&&1<this.anisotropic&&e.texParameterf(e.TEXTURE_CUBE_MAP,n.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),36193!==i||t.getGLExtension("OES_texture_half_float")||(i=E.FLOAT),this.mipmaps.length)for(var o=this.width,a=this.height,s=0;s<this.mipmaps.length;s++){var l=this.mipmaps[s];this._updateTextureData(e,l,s,o,a,r,i),o/=2,a/=2}else this._updateTextureData(e,this,0,this.width,this.height,r,i),!this.NPOT&&this.useMipmap&&e.generateMipmap(e.TEXTURE_CUBE_MAP);e.bindTexture(e.TEXTURE_CUBE_MAP,null)},_updateTextureData:function(t,e,r,i,n,o,a){for(var s=0;s<6;s++){var l=ai[s],h=e.image&&e.image[l];h?t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+s,r,o,o,a,h):t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+s,r,o,i,n,0,o,a,e.pixels&&e.pixels[l])}},generateMipmap:function(t){t=t.gl;this.useMipmap&&!this.NPOT&&(t.bindTexture(t.TEXTURE_CUBE_MAP,this._cache.get("webgl_texture")),t.generateMipmap(t.TEXTURE_CUBE_MAP))},bind:function(t){t.gl.bindTexture(t.gl.TEXTURE_CUBE_MAP,this.getWebGLTexture(t))},unbind:function(t){t.gl.bindTexture(t.gl.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(){return this.image.px?oi(this.image.px.width)&&oi(this.image.px.height):oi(this.width)&&oi(this.height)},isRenderable:function(){return this.image.px?si(this.image.px)&&si(this.image.nx)&&si(this.image.py)&&si(this.image.ny)&&si(this.image.pz)&&si(this.image.nz):!(!this.width||!this.height)},load:function(t,i){var n=0,o=this;return W.each(t,function(t,e){var r=$.createImage();i&&(r.crossOrigin=i),r.onload=function(){0===--n&&(o.dirty(),o.trigger("success",o))},r.onerror=function(){n--},n++,r.src=t,o.image[e]=r}),this}});function si(t){return 0<t.width&&0<t.height}Object.defineProperty(d.prototype,"width",{get:function(){return this.image&&this.image.px?this.image.px.width:this._width},set:function(t){this.image&&this.image.px?console.warn("Texture from image can't set width"):(this._width!==t&&this.dirty(),this._width=t)}}),Object.defineProperty(d.prototype,"height",{get:function(){return this.image&&this.image.px?this.image.px.height:this._height},set:function(t){this.image&&this.image.px?console.warn("Texture from image can't set height"):(this._height!==t&&this.dirty(),this._height=t)}});const li=d,hi=Wr.extend({fov:50,aspect:1,near:.1,far:2e3},{updateProjectionMatrix:function(){var t=this.fov/180*Math.PI;this.projectionMatrix.perspective(t,this.aspect,this.near,this.far)},decomposeProjectionMatrix:function(){var t=this.projectionMatrix.array,e=2*Math.atan(1/t[5]);this.fov=e/Math.PI*180,this.aspect=t[5]/t[0],this.near=t[14]/(t[10]-1),this.far=t[14]/(t[10]+1)},clone:function(){var t=Wr.prototype.clone.call(this);return t.fov=this.fov,t.aspect=this.aspect,t.near=this.near,t.far=this.far,t}});var ui="framebuffer",ci="renderbuffer",di=ci+"_width",fi=ci+"_height",pi=ci+"_attached",mi="depthtexture_attached",gi=E.FRAMEBUFFER,_i=E.RENDERBUFFER,yi=E.DEPTH_ATTACHMENT,vi=E.COLOR_ATTACHMENT0,t=P.extend({depthBuffer:!0,viewport:null,_width:0,_height:0,_textures:null,_boundRenderer:null},function(){this._cache=new pr,this._textures={}},{getTextureWidth:function(){return this._width},getTextureHeight:function(){return this._height},bind:function(t){if(t.__currentFrameBuffer){if(t.__currentFrameBuffer===this)return;console.warn("Renderer already bound with another framebuffer. Unbind it first")}t.__currentFrameBuffer=this;var e,r,i=t.gl,n=(i.bindFramebuffer(gi,this._getFrameBufferGL(t)),this._boundRenderer=t,this._cache),o=(n.put("viewport",t.viewport),!1);for(u in this._textures){var o=!0,a=this._textures[u];a&&(e=a.texture.width,r=a.texture.height,this._doAttach(t,a.texture,u,a.target))}this._width=e,this._height=r,!o&&this.depthBuffer&&console.error("Must attach texture before bind, or renderbuffer may have incorrect width and height."),this.viewport?t.setViewport(this.viewport):t.setViewport(0,0,e,r,1);var s,l,h=n.get("attached_textures");if(h)for(var u in h)this._textures[u]||(s=h[u],this._doDetach(i,u,s));!n.get(mi)&&this.depthBuffer&&(n.miss(ci)&&n.put(ci,i.createRenderbuffer()),l=n.get(ci),e===n.get(di)&&r===n.get(fi)||(i.bindRenderbuffer(_i,l),i.renderbufferStorage(_i,i.DEPTH_COMPONENT16,e,r),n.put(di,e),n.put(fi,r),i.bindRenderbuffer(_i,null)),n.get(pi)||(i.framebufferRenderbuffer(gi,yi,_i,l),n.put(pi,!0)))},unbind:function(t){t.__currentFrameBuffer=null;t.gl.bindFramebuffer(gi,null),this._boundRenderer=null,this._cache.use(t.__uid__);var e=this._cache.get("viewport");e&&t.setViewport(e),this.updateMipmap(t)},updateMipmap:function(t){var e,r=t.gl;for(e in this._textures){var i,n=this._textures[e];n&&!(n=n.texture).NPOT&&n.useMipmap&&n.minFilter===B.LINEAR_MIPMAP_LINEAR&&(i="textureCube"===n.textureType?E.TEXTURE_CUBE_MAP:E.TEXTURE_2D,r.bindTexture(i,n.getWebGLTexture(t)),r.generateMipmap(i),r.bindTexture(i,null))}},checkStatus:function(t){return t.checkFramebufferStatus(gi)},_getFrameBufferGL:function(t){var e=this._cache;return e.use(t.__uid__),e.miss(ui)&&e.put(ui,t.gl.createFramebuffer()),e.get(ui)},attach:function(t,e,r){if(!t.width)throw new Error("The texture attached to color buffer is not a valid.");e=e||vi,r=r||E.TEXTURE_2D;var i,n=this._boundRenderer,o=(n&&n.gl&&((i=this._cache).use(n.__uid__),i=i.get("attached_textures")),this._textures[e]);o&&o.target===r&&o.texture===t&&i&&null!=i[e]||(o=!0,n&&(o=this._doAttach(n,t,e,r),this.viewport||n.setViewport(0,0,t.width,t.height,1)),o&&(this._textures[e]=this._textures[e]||{},this._textures[e].texture=t,this._textures[e].target=r))},_doAttach:function(t,e,r,i){var n=t.gl,o=e.getWebGLTexture(t),a=this._cache.get("attached_textures");if(a&&a[r]){var s=a[r];if(s.texture===e&&s.target===i)return}s=!0;return(r=+r)!==yi&&r!==E.DEPTH_STENCIL_ATTACHMENT||(t.getGLExtension("WEBGL_depth_texture")||(console.error("Depth texture is not supported by the browser"),s=!1),e.format!==E.DEPTH_COMPONENT&&e.format!==E.DEPTH_STENCIL&&(console.error("The texture attached to depth buffer is not a valid."),s=!1),s&&((t=this._cache.get(ci))&&(n.framebufferRenderbuffer(gi,yi,_i,null),n.deleteRenderbuffer(t),this._cache.put(ci,!1)),this._cache.put(pi,!1),this._cache.put(mi,!0))),n.framebufferTexture2D(gi,r,i,o,0),a||this._cache.put("attached_textures",a={}),a[r]=a[r]||{},a[r].texture=e,a[r].target=i,s},_doDetach:function(t,e,r){t.framebufferTexture2D(gi,e,r,null,0);t=this._cache.get("attached_textures");t&&t[e]&&(t[e]=null),e!==yi&&e!==E.DEPTH_STENCIL_ATTACHMENT||this._cache.put(mi,!1)},detach:function(t,e){this._textures[t]=null,this._boundRenderer&&(this._cache.use(this._boundRenderer.__uid__),this._doDetach(this._boundRenderer.gl,t,e))},dispose:function(t){var e=t.gl,r=this._cache,i=(r.use(t.__uid__),r.get(ci)),i=(i&&e.deleteRenderbuffer(i),r.get(ui));i&&e.deleteFramebuffer(i),r.deleteContext(t.__uid__),this._textures={}}});t.DEPTH_ATTACHMENT=yi,t.COLOR_ATTACHMENT0=vi,t.STENCIL_ATTACHMENT=E.STENCIL_ATTACHMENT,t.DEPTH_STENCIL_ATTACHMENT=E.DEPTH_STENCIL_ATTACHMENT;const xi=t;var Ti=["px","nx","py","ny","pz","nz"];const bi=P.extend(function(){var t={position:new C,far:1e3,near:.1,texture:null,shadowMapPass:null},e=t._cameras={px:new hi({fov:90}),nx:new hi({fov:90}),py:new hi({fov:90}),ny:new hi({fov:90}),pz:new hi({fov:90}),nz:new hi({fov:90})};return e.px.lookAt(C.POSITIVE_X,C.NEGATIVE_Y),e.nx.lookAt(C.NEGATIVE_X,C.NEGATIVE_Y),e.py.lookAt(C.POSITIVE_Y,C.POSITIVE_Z),e.ny.lookAt(C.NEGATIVE_Y,C.NEGATIVE_Z),e.pz.lookAt(C.POSITIVE_Z,C.NEGATIVE_Y),e.nz.lookAt(C.NEGATIVE_Z,C.NEGATIVE_Y),t._frameBuffer=new xi,t},{getCamera:function(t){return this._cameras[t]},render:function(t,e,r){for(var i=t.gl,r=(r||e.update(),this.texture.width),n=2*Math.atan(r/(r-.5))/Math.PI*180,o=0;o<6;o++){var a,s=this._cameras[Ti[o]];C.copy(s.position,this.position),s.far=this.far,s.near=this.near,s.fov=n,this.shadowMapPass&&(s.update(),(a=e.getBoundingBox()).applyTransform(s.viewMatrix),e.viewBoundingBoxLastFrame.copy(a),this.shadowMapPass.render(t,e,s,!0)),this._frameBuffer.attach(this.texture,i.COLOR_ATTACHMENT0,i.TEXTURE_CUBE_MAP_POSITIVE_X+o),this._frameBuffer.bind(t),t.render(e,s,!0),this._frameBuffer.unbind(t)}},dispose:function(t){this._frameBuffer.dispose(t)}}),wi=p.extend({dynamic:!1,widthSegments:1,heightSegments:1},function(){this.build()},{build:function(){for(var t=this.heightSegments,e=this.widthSegments,r=this.attributes,i=[],n=[],o=[],a=[],s=0;s<=t;s++)for(var l=s/t,h=0;h<=e;h++){var u=h/e;i.push([2*u-1,2*l-1,0]),n&&n.push([u,l]),o&&o.push([0,0,1]),h<e&&s<t&&(a.push([u=h+s*(e+1),u+1,u+e+1]),a.push([u+e+1,u+1,u+e+2]))}r.position.fromArray(i),r.texcoord0.fromArray(n),r.normal.fromArray(o),this.initIndicesFromArray(a),this.boundingBox=new je,this.boundingBox.min.set(-1,-1,0),this.boundingBox.max.set(1,1,0)}});var Si=new M;function Ei(t,e,r){Si.identity();e=new wi({widthSegments:e,heightSegments:r});switch(t){case"px":M.translate(Si,Si,C.POSITIVE_X),M.rotateY(Si,Si,Math.PI/2);break;case"nx":M.translate(Si,Si,C.NEGATIVE_X),M.rotateY(Si,Si,-Math.PI/2);break;case"py":M.translate(Si,Si,C.POSITIVE_Y),M.rotateX(Si,Si,-Math.PI/2);break;case"ny":M.translate(Si,Si,C.NEGATIVE_Y),M.rotateX(Si,Si,Math.PI/2);break;case"pz":M.translate(Si,Si,C.POSITIVE_Z);break;case"nz":M.translate(Si,Si,C.NEGATIVE_Z),M.rotateY(Si,Si,Math.PI)}return e.applyTransform(Si),e}const Mi=p.extend({dynamic:!1,widthSegments:1,heightSegments:1,depthSegments:1,inside:!1},function(){this.build()},{build:function(){var t={px:Ei("px",this.depthSegments,this.heightSegments),nx:Ei("nx",this.depthSegments,this.heightSegments),py:Ei("py",this.widthSegments,this.depthSegments),ny:Ei("ny",this.widthSegments,this.depthSegments),pz:Ei("pz",this.widthSegments,this.heightSegments),nz:Ei("nz",this.widthSegments,this.heightSegments)},e=["position","texcoord0","normal"],r=0,i=0;for(o in t)r+=t[o].vertexCount,i+=t[o].indices.length;for(var n=0;n<e.length;n++)this.attributes[e[n]].init(r);this.indices=new $.Uint16Array(i);var o,a=0,s=0;for(o in t){for(var l=t[o],n=0;n<e.length;n++)for(var h=e[n],u=l.attributes[h].value,c=l.attributes[h].size,d="normal"===h,f=0;f<u.length;f++){var p=u[f];this.inside&&d&&(p=-p),this.attributes[h].value[f+c*s]=p}for(var m=l.indices.length,f=0;f<l.indices.length;f++)this.indices[f+a]=s+l.indices[this.inside?m-f-1:f];a+=l.indices.length,s+=l.vertexCount}this.boundingBox=new je,this.boundingBox.max.set(1,1,1),this.boundingBox.min.set(-1,-1,-1)}});S.import("@export clay.skybox.vertex\n#define SHADER_NAME skybox\nuniform mat4 world : WORLD;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nvarying vec3 v_WorldPosition;\nvoid main()\n{\n v_WorldPosition = (world * vec4(position, 1.0)).xyz;\n gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n@end\n@export clay.skybox.fragment\n#define PI 3.1415926\nuniform mat4 viewInverse : VIEWINVERSE;\n#ifdef EQUIRECTANGULAR\nuniform sampler2D environmentMap;\n#else\nuniform samplerCube environmentMap;\n#endif\nuniform float lod: 0.0;\nvarying vec3 v_WorldPosition;\n@import clay.util.rgbm\n@import clay.util.srgb\n@import clay.util.ACES\nvoid main()\n{\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(v_WorldPosition - eyePos);\n#ifdef EQUIRECTANGULAR\n float phi = acos(V.y);\n float theta = atan(-V.x, V.z) + PI * 0.5;\n vec2 uv = vec2(theta / 2.0 / PI, phi / PI);\n vec4 texel = decodeHDR(texture2D(environmentMap, fract(uv)));\n#else\n #if defined(LOD) || defined(SUPPORT_TEXTURE_LOD)\n vec4 texel = decodeHDR(textureCubeLodEXT(environmentMap, V, lod));\n #else\n vec4 texel = decodeHDR(textureCube(environmentMap, V));\n #endif\n#endif\n#ifdef SRGB_DECODE\n texel = sRGBToLinear(texel);\n#endif\n#ifdef TONEMAPPING\n texel.rgb = ACESToneMapping(texel.rgb);\n#endif\n#ifdef SRGB_ENCODE\n texel = linearTosRGB(texel);\n#endif\n gl_FragColor = encodeHDR(vec4(texel.rgb, 1.0));\n}\n@end");const Ai=mr.extend(function(){var t=new S({vertex:S.source("clay.skybox.vertex"),fragment:S.source("clay.skybox.fragment")}),t=new Tt({shader:t,depthMask:!1});return{scene:null,geometry:new Mi,material:t,environmentMap:null,culling:!1,_dummyCamera:new hi}},function(){var t=this.scene;t&&this.attachScene(t),this.environmentMap&&this.setEnvironmentMap(this.environmentMap)},{attachScene:function(t){this.scene&&this.detachScene(),((t.skybox=this).scene=t).on("beforerender",this._beforeRenderScene,this)},detachScene:function(){this.scene&&(this.scene.off("beforerender",this._beforeRenderScene),this.scene.skybox=null),this.scene=null},dispose:function(t){this.detachScene(),this.geometry.dispose(t)},setEnvironmentMap:function(t){"texture2D"===t.textureType?(this.material.define("EQUIRECTANGULAR"),t.minFilter=B.LINEAR):this.material.undefine("EQUIRECTANGULAR"),this.material.set("environmentMap",t)},getEnvironmentMap:function(){return this.material.get("environmentMap")},_beforeRenderScene:function(t,e,r){this.renderSkybox(t,r)},renderSkybox:function(t,e){var r=this._dummyCamera;r.aspect=t.getViewportAspect(),r.fov=e.fov||50,r.updateProjectionMatrix(),M.invert(r.invProjectionMatrix,r.projectionMatrix),r.worldTransform.copy(e.worldTransform),r.viewMatrix.copy(e.viewMatrix),this.position.copy(e.getWorldPosition()),this.update(),t.gl.disable(t.gl.BLEND),0<this.material.get("lod")?this.material.define("fragment","LOD"):this.material.undefine("fragment","LOD"),t.renderPass([this],r)}}),Ci=Ai;function Di(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var Li=Di("DXT1"),Pi=Di("DXT3"),Ni=Di("DXT5");const Ri={parse:function(t,e){var r=new Int32Array(t,0,31);if(542327876!==r[0])return null;if(4&!r(20))return null;var i,n,o=r(21),a=r[4],s=r[3],l=512&r[28],h=131072&r[2];switch(o){case Li:i=8,n=B.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Pi:i=16,n=B.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ni:i=16,n=B.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}for(var u=r[1]+4,c=l?6:1,d=1,f=(h&&(d=Math.max(1,r[7])),[]),p=0;p<c;p++){for(var m=a,g=s,_=(f[p]=new F({width:m,height:g,format:n}),[]),y=0;y<d;y++){var v=Math.max(4,m)/4*Math.max(4,g)/4*i,x=new Uint8Array(t,u,v);u+=v,m*=.5,g*=.5,_[y]=x}f[p].pixels=_[0],h&&(f[p].mipmaps=_)}if(!e)return f[0];e.width=f[0].width,e.height=f[0].height,e.format=f[0].format,e.pixels=f[0].pixels,e.mipmaps=f[0].mipmaps}};var Ii=String.fromCharCode;function Oi(t,e,r,i){for(var n,o,a=0,s=0,l=i;0<l;)if(t[s][0]=e[r++],t[s][1]=e[r++],t[s][2]=e[r++],t[s][3]=e[r++],1===t[s][0]&&1===t[s][1]&&1===t[s][2]){for(var h=t[s][3]<<a>>>0;0<h;h--)n=t[s-1],(o=t[s])[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],s++,l--;a+=8}else s++,l--,a=0;return r}const Bi={parseRGBE:function(t,e,r){null==r&&(r=0);var i=new Uint8Array(t),n=i.length;if("#?"===function(t,e,r){for(var i="",n=e;n<r;n++)i+=Ii(t[n]);return i}(i,0,2)){for(var o=2;o<n&&("\n"!==Ii(i[o])||"\n"!==Ii(i[o+1]));o++);if(!(n<=o)){o+=2;for(var a="";o<n;o++){var s=Ii(i[o]);if("\n"===s)break;a+=s}var t=a.split(" "),l=parseInt(t[1]),h=parseInt(t[3]);if(h&&l){for(var u=o+1,c=[],d=0;d<h;d++){c[d]=[];for(var f=0;f<4;f++)c[d][f]=0}for(var p,m,g,_,y=new Float32Array(h*l*4),v=0,x=0;x<l;x++){if(!(u=function(t,e,r,i){if(i<8|32767<i)return Oi(t,e,r,i);if(2!=(n=e[r++]))return Oi(t,e,r-1,i);if(t[0][1]=e[r++],t[0][2]=e[r++],n=e[r++],(t[0][2]<<8>>>0|n)>>>0!==i)return null;for(var n=0;n<4;n++)for(var o=0;o<i;)if(128<(a=e[r++]))for(var a=(127&a)>>>0,s=e[r++];a--;)t[o++][n]=s;else for(;a--;)t[o++][n]=e[r++];return r}(c,i,u,h)))return null;for(d=0;d<h;d++)m=y,g=v,_=r,0<(p=c[d])[3]?(_=Math.pow(2,p[3]-128-8+_),m[g+0]=p[0]*_,m[g+1]=p[1]*_,m[g+2]=p[2]*_):(m[g+0]=0,m[g+1]=0,m[g+2]=0),m[g+3]=1,v+=4}return(e=e||new F).width=h,e.height=l,e.pixels=y,e.type=B.FLOAT,e}}}},parseRGBEFromPNG:function(t){}};var Fi={loadTexture:function(t,e,r,i){var n;if(e="function"==typeof e?(i=r=e,{}):e||{},"string"==typeof t){if(t.match(/.hdr$/)||"hdr"===e.fileType)return n=new F({width:0,height:0,sRGB:!1}),Fi._fetchTexture(t,function(t){Bi.parseRGBE(t,n,e.exposure),n.dirty(),r&&r(n)},i),n;t.match(/.dds$/)||"dds"===e.fileType?(n=new F({width:0,height:0}),Fi._fetchTexture(t,function(t){Ri.parse(t,n),n.dirty(),r&&r(n)},i)):((n=new F).load(t),n.success(r),n.error(i))}else"object"==typeof t&&void 0!==t.px&&((n=new li).load(t),n.success(r),n.error(i));return n},loadPanorama:function(e,t,r,i,n,o){var a=this;i="function"==typeof i?(o=n=i,{}):i||{},Fi.loadTexture(t,i,function(t){t.flipY=i.flipY||!1,a.panoramaToCubeMap(e,t,r,i),t.dispose(e),n&&n(r)},o)},panoramaToCubeMap:function(t,e,r,i){var n=new bi,o=new Ci({scene:new $r});return o.setEnvironmentMap(e),(i=i||{}).encodeRGBM&&o.material.define("fragment","RGBM_ENCODE"),r.sRGB=e.sRGB,n.texture=r,n.render(t,o.scene),n.texture=null,n.dispose(t),r},heightToNormal:function(t,e){for(var r=document.createElement("canvas"),i=r.width=t.width,n=r.height=t.height,o=r.getContext("2d"),a=(o.drawImage(t,0,0,i,n),e=e||!1,o.getImageData(0,0,i,n)),s=o.createImageData(i,n),l=0;l<a.data.length;l+=4){if(e){var h=a.data[l],u=a.data[l+1],c=a.data[l+2];if(20<Math.abs(h-u)+Math.abs(u-c))return console.warn("Given image is not a height map"),t}var d,f,h=l%(4*i)==0?(d=a.data[l],a.data[l+4]):l%(4*i)==4*(i-1)?(d=a.data[l-4],a.data[l]):(d=a.data[l-4],a.data[l+4]),u=l<4*i?(f=a.data[l],a.data[l+4*i]):i*(n-1)*4<l?(f=a.data[l-4*i],a.data[l]):(f=a.data[l-4*i],a.data[l+4*i]);s.data[l]=d-h+127,s.data[l+1]=f-u+127,s.data[l+2]=255,s.data[l+3]=255}return o.putImageData(s,0,0),r},isHeightImage:function(t,e,r){if(!t||!t.width||!t.height)return!1;for(var i=document.createElement("canvas"),n=i.getContext("2d"),e=e||32,o=(r=r||20,i.width=i.height=e,n.drawImage(t,0,0,e,e),n.getImageData(0,0,e,e)),a=0;a<o.data.length;a+=4){var s=o.data[a],l=o.data[a+1],h=o.data[a+2];if(r<Math.abs(s-l)+Math.abs(l-h))return!1}return!0},_fetchTexture:function(t,e,r){$.request.get({url:t,responseType:"arraybuffer",onload:e,onerror:r})},createChessboard:function(t,e,r,i){t=t||512,e=e||64,r=r||"black",i=i||"white";var n=Math.ceil(t/e),o=document.createElement("canvas"),a=(o.width=t,o.height=t,o.getContext("2d"));a.fillStyle=i,a.fillRect(0,0,t,t),a.fillStyle=r;for(var s=0;s<n;s++)for(var l=0;l<n;l++)(l%2?s%2:s%2-1)&&a.fillRect(s*e,l*e,e,e);return new F({image:o,anisotropic:8})},createBlank:function(t){var e=document.createElement("canvas"),r=(e.width=1,e.height=1,e.getContext("2d"));return r.fillStyle=t,r.fillRect(0,0,1,1),new F({image:e})}};const zi=Fi;var Ui=["mousedown","mouseup","mousemove","mouseover","mouseout","click","dblclick","contextmenu"];function ki(t){return"_on"+t}function Gi(t){var e=this;this._texture=new F({anisotropic:32,flipY:!1,surface:this,dispose:function(t){e.dispose(),F.prototype.dispose.call(this,t)}}),Ui.forEach(function(r){this[ki(r)]=function(e){e.triangle&&this._meshes.forEach(function(t){this.dispatchEvent(r,t,e.triangle,e.point)},this)}},this),this._meshes=[],t&&this.setECharts(t),this.onupdate=null}var Hi,Vi,Wi,Xi,ji,qi,Zi,Yi;Gi.prototype={constructor:Gi,getTexture:function(){return this._texture},setECharts:function(t){var e,r,i=(this._chart=t).getDom();i instanceof HTMLCanvasElement?(e=this,t=t.getZr(),r=t.__oldRefreshImmediately||t.refreshImmediately,t.refreshImmediately=function(){r.call(this),e._texture.dirty(),e.onupdate&&e.onupdate()},t.__oldRefreshImmediately=r):(console.error("ECharts must init on canvas if it is used as texture."),i=document.createElement("canvas")),this._texture.image=i,this._texture.dirty(),this.onupdate&&this.onupdate()},dispatchEvent:(Hi=new C,Vi=new C,Wi=new C,Xi=new Et,ji=new Et,qi=new Et,Zi=new Et,Yi=new C,function(t,e,r,i){var e=e.geometry,n=e.attributes.position,e=e.attributes.texcoord0,o=C.dot,a=C.cross,n=(n.get(r[0],Hi.array),n.get(r[1],Vi.array),n.get(r[2],Wi.array),e.get(r[0],Xi.array),e.get(r[1],ji.array),e.get(r[2],qi.array),a(Yi,Vi,Wi),o(Hi,Yi)),e=o(i,Yi)/n,r=(a(Yi,Wi,Hi),o(i,Yi)/n),a=(a(Yi,Hi,Vi),o(i,Yi)/n),o=(Et.scale(Zi,Xi,e),Et.scaleAndAdd(Zi,Zi,ji,r),Et.scaleAndAdd(Zi,Zi,qi,a),Zi.x*this._chart.getWidth()),i=Zi.y*this._chart.getHeight();this._chart.getZr().handler.dispatch(t,{zrX:o,zrY:i})}),attachToMesh:function(e){0<=this._meshes.indexOf(e)||(Ui.forEach(function(t){e.on(t,this[ki(t)],this)},this),this._meshes.push(e))},detachFromMesh:function(e){var t=this._meshes.indexOf(e);0<=t&&this._meshes.splice(t,1),Ui.forEach(function(t){e.off(t,this[ki(t)])},this)},dispose:function(){this._meshes.forEach(function(t){this.detachFromMesh(t)},this)}};const Ki=Gi,Qi=Wr.extend({left:-1,right:1,near:-1,far:1,top:1,bottom:-1},{updateProjectionMatrix:function(){this.projectionMatrix.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far)},decomposeProjectionMatrix:function(){var t=this.projectionMatrix.array;this.left=(-1-t[12])/t[0],this.right=(1-t[12])/t[0],this.top=(1-t[13])/t[5],this.bottom=(-1-t[13])/t[5],this.near=-(-1-t[14])/t[10],this.far=-(1-t[14])/t[10]},clone:function(){var t=Wr.prototype.clone.call(this);return t.left=this.left,t.right=this.right,t.near=this.near,t.far=this.far,t.top=this.top,t.bottom=this.bottom,t}});S.import("\n@export clay.compositor.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n v_Texcoord = texcoord;\n gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n@end");var g=new wi,Ji=new mr({geometry:g,frustumCulling:!1}),$i=new Qi;const tn=P.extend(function(){return{fragment:"",outputs:null,material:null,blendWithPrevious:!1,clearColor:!1,clearDepth:!0}},function(){var t=new S(S.source("clay.compositor.vertex"),this.fragment),t=new Tt({shader:t});t.enableTexturesAll(),this.material=t},{setUniform:function(t,e){this.material.setUniform(t,e)},getUniform:function(t){t=this.material.uniforms[t];if(t)return t.value},attachOutput:function(t,e){this.outputs||(this.outputs={}),e=e||E.COLOR_ATTACHMENT0,this.outputs[e]=t},detachOutput:function(t){for(var e in this.outputs)this.outputs[e]===t&&(this.outputs[e]=null)},bind:function(t,e){if(this.outputs)for(var r in this.outputs){var i=this.outputs[r];i&&e.attach(i,r)}e&&e.bind(t)},unbind:function(t,e){e.unbind(t)},render:function(t,e){var r=t.gl;if(e){this.bind(t,e);var i=t.getGLExtension("EXT_draw_buffers");if(i&&this.outputs){var n,o=[];for(n in this.outputs)(n=+n)>=r.COLOR_ATTACHMENT0&&n<=r.COLOR_ATTACHMENT0+8&&o.push(n);i.drawBuffersEXT(o)}}this.trigger("beforerender",this,t);var a,i=this.clearDepth?r.DEPTH_BUFFER_BIT:0;r.depthMask(!0),this.clearColor&&(i|=r.COLOR_BUFFER_BIT,r.colorMask(!0,!0,!0,!0),a=this.clearColor,Array.isArray(a))&&r.clearColor(a[0],a[1],a[2],a[3]),r.clear(i),this.blendWithPrevious?(r.enable(r.BLEND),this.material.transparent=!0):(r.disable(r.BLEND),this.material.transparent=!1),this.renderQuad(t),this.trigger("afterrender",this,t),e&&this.unbind(t,e)},renderQuad:function(t){Ji.material=this.material,t.renderPass([Ji],$i)},dispose:function(t){}});var en={},rn=["px","nx","py","ny","pz","nz"];en.prefilterEnvironmentMap=function(t,e,r,i,n){n&&i||(i=en.generateNormalDistribution(),n=en.integrateBRDF(t,i));for(var o,a,s=(r=r||{}).width||64,l=r.height||64,h=r.type||e.type,u=new li({width:s,height:l,type:h,flipY:!1,mipmaps:[]}),c=(u.isPowerOfTwo()||console.warn("Width and height must be power of two to enable mipmap."),Math.min(s,l)),d=Math.log(c)/Math.log(2)+1,c=new Tt({shader:new S({vertex:S.source("clay.skybox.vertex"),fragment:"#define SHADER_NAME prefilter\n#define SAMPLE_NUMBER 1024\n#define PI 3.14159265358979\nuniform mat4 viewInverse : VIEWINVERSE;\nuniform samplerCube environmentMap;\nuniform sampler2D normalDistribution;\nuniform float roughness : 0.5;\nvarying vec2 v_Texcoord;\nvarying vec3 v_WorldPosition;\n@import clay.util.rgbm\nvec3 importanceSampleNormal(float i, float roughness, vec3 N) {\n vec3 H = texture2D(normalDistribution, vec2(roughness, i)).rgb;\n vec3 upVector = abs(N.y) > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n vec3 tangentX = normalize(cross(N, upVector));\n vec3 tangentZ = cross(N, tangentX);\n return normalize(tangentX * H.x + N * H.y + tangentZ * H.z);\n}\nvoid main() {\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(v_WorldPosition - eyePos);\n vec3 N = V;\n vec3 prefilteredColor = vec3(0.0);\n float totalWeight = 0.0;\n float fMaxSampleNumber = float(SAMPLE_NUMBER);\n for (int i = 0; i < SAMPLE_NUMBER; i++) {\n vec3 H = importanceSampleNormal(float(i) / fMaxSampleNumber, roughness, N);\n vec3 L = reflect(-V, H);\n float NoL = clamp(dot(N, L), 0.0, 1.0);\n if (NoL > 0.0) {\n prefilteredColor += decodeHDR(textureCube(environmentMap, L)).rgb * NoL;\n totalWeight += NoL;\n }\n }\n gl_FragColor = encodeHDR(vec4(prefilteredColor / totalWeight, 1.0));\n}\n"})}),f=(c.set("normalDistribution",i),r.encodeRGBM&&c.define("fragment","RGBM_ENCODE"),r.decodeRGBM&&c.define("fragment","RGBM_DECODE"),new $r),p=("texture2D"===e.textureType&&(a=new li({width:s,height:l,type:h===B.FLOAT?B.HALF_FLOAT:h}),zi.panoramaToCubeMap(t,e,a,{encodeRGBM:r.decodeRGBM}),e=a),(o=new Ai({scene:f,material:c})).material.set("environmentMap",e),new bi({texture:u})),m=(r.encodeRGBM&&(h=u.type=B.UNSIGNED_BYTE),new F({width:s,height:l,type:h})),g=new xi({depthBuffer:!1}),_=$[h===B.UNSIGNED_BYTE?"Uint8Array":"Float32Array"],y=0;y<d;y++){u.mipmaps[y]={pixels:{}},o.material.set("roughness",y/(d-1));for(var v=m.width,x=2*Math.atan(v/(v-.5))/Math.PI*180,T=0;T<rn.length;T++){var b=new _(m.width*m.height*4),w=(g.attach(m),g.bind(t),p.getCamera(rn[T]));w.fov=x,t.render(f,w),t.gl.readPixels(0,0,m.width,m.height,B.RGBA,h,b),g.unbind(t),u.mipmaps[y].pixels[rn[T]]=b}m.width/=2,m.height/=2,m.dirty()}return g.dispose(t),m.dispose(t),o.dispose(t),i.dispose(t),{environmentMap:u,brdfLookup:n,normalDistribution:i,maxMipmapLevel:d}},en.integrateBRDF=function(t,e){e=e||en.generateNormalDistribution();var r=new xi({depthBuffer:!1}),i=new tn({fragment:"#define SAMPLE_NUMBER 1024\n#define PI 3.14159265358979\nuniform sampler2D normalDistribution;\nuniform vec2 viewportSize : [512, 256];\nconst vec3 N = vec3(0.0, 0.0, 1.0);\nconst float fSampleNumber = float(SAMPLE_NUMBER);\nvec3 importanceSampleNormal(float i, float roughness, vec3 N) {\n vec3 H = texture2D(normalDistribution, vec2(roughness, i)).rgb;\n vec3 upVector = abs(N.y) > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n vec3 tangentX = normalize(cross(N, upVector));\n vec3 tangentZ = cross(N, tangentX);\n return normalize(tangentX * H.x + N * H.y + tangentZ * H.z);\n}\nfloat G_Smith(float roughness, float NoV, float NoL) {\n float k = roughness * roughness / 2.0;\n float G1V = NoV / (NoV * (1.0 - k) + k);\n float G1L = NoL / (NoL * (1.0 - k) + k);\n return G1L * G1V;\n}\nvoid main() {\n vec2 uv = gl_FragCoord.xy / viewportSize;\n float NoV = uv.x;\n float roughness = uv.y;\n vec3 V;\n V.x = sqrt(1.0 - NoV * NoV);\n V.y = 0.0;\n V.z = NoV;\n float A = 0.0;\n float B = 0.0;\n for (int i = 0; i < SAMPLE_NUMBER; i++) {\n vec3 H = importanceSampleNormal(float(i) / fSampleNumber, roughness, N);\n vec3 L = reflect(-V, H);\n float NoL = clamp(L.z, 0.0, 1.0);\n float NoH = clamp(H.z, 0.0, 1.0);\n float VoH = clamp(dot(V, H), 0.0, 1.0);\n if (NoL > 0.0) {\n float G = G_Smith(roughness, NoV, NoL);\n float G_Vis = G * VoH / (NoH * NoV);\n float Fc = pow(1.0 - VoH, 5.0);\n A += (1.0 - Fc) * G_Vis;\n B += Fc * G_Vis;\n }\n }\n gl_FragColor = vec4(vec2(A, B) / fSampleNumber, 0.0, 1.0);\n}\n"}),n=new F({width:512,height:256,type:B.HALF_FLOAT,wrapS:B.CLAMP_TO_EDGE,wrapT:B.CLAMP_TO_EDGE,minFilter:B.NEAREST,magFilter:B.NEAREST,useMipmap:!1});return i.setUniform("normalDistribution",e),i.setUniform("viewportSize",[512,256]),i.attachOutput(n),i.render(t,r),r.dispose(t),n},en.generateNormalDistribution=function(t,e){for(var t=t||256,e=e||1024,r=new F({width:t,height:e,type:B.FLOAT,minFilter:B.NEAREST,magFilter:B.NEAREST,wrapS:B.CLAMP_TO_EDGE,wrapT:B.CLAMP_TO_EDGE,useMipmap:!1}),i=new Float32Array(e*t*4),n=[],o=0;o<t;o++){for(var a=o/t,s=a*a,l=0;l<e;l++){var h=(l<<16|l>>>16)>>>0,u=(h=(((16711935&(h=((252645135&(h=((858993459&(h=((1431655765&h)<<1|(2863311530&h)>>>1)>>>0))<<2|(3435973836&h)>>>2)>>>0))<<4|(4042322160&h)>>>4)>>>0))<<8|(4278255360&h)>>>8)>>>0)/4294967296,Math.sqrt((1-h)/(1+(s*s-1)*h)));n[l]=u}for(l=0;l<e;l++){var c=4*(l*t+o),u=n[l],d=Math.sqrt(1-u*u),f=2*Math.PI*(l/e);i[c]=d*Math.cos(f),i[1+c]=u,i[2+c]=d*Math.sin(f),i[3+c]=1}}return r.pixels=i,r};const nn=en,on=Cr.extend({cubemap:null,castShadow:!1,_normalDistribution:null,_brdfLookup:null},{type:"AMBIENT_CUBEMAP_LIGHT",prefilter:function(t,e){var r;t.getGLExtension("EXT_shader_texture_lod")?(this._brdfLookup||(this._normalDistribution=nn.generateNormalDistribution(),this._brdfLookup=nn.integrateBRDF(t,this._normalDistribution)),(r=this.cubemap).__prefiltered||(e=nn.prefilterEnvironmentMap(t,r,{encodeRGBM:!0,width:e,height:e},this._normalDistribution,this._brdfLookup),this.cubemap=e.environmentMap,this.cubemap.__prefiltered=!0,r.dispose(t))):console.warn("Device not support textureCubeLodEXT")},getBRDFLookup:function(){return this._brdfLookup},uniformTemplates:{ambientCubemapLightColor:{type:"3f",value:function(t){var e=t.color,t=t.intensity;return[e[0]*t,e[1]*t,e[2]*t]}},ambientCubemapLightCubemap:{type:"t",value:function(t){return t.cubemap}},ambientCubemapLightBRDFLookup:{type:"t",value:function(t){return t._brdfLookup}}}}),an=Cr.extend({castShadow:!1,coefficients:[]},function(){this._coefficientsTmpArr=new $.Float32Array(27)},{type:"AMBIENT_SH_LIGHT",uniformTemplates:{ambientSHLightColor:{type:"3f",value:function(t){var e=t.color,t=t.intensity;return[e[0]*t,e[1]*t,e[2]*t]}},ambientSHLightCoefficients:{type:"3f",value:function(t){for(var e=t._coefficientsTmpArr,r=0;r<t.coefficients.length;r++)e[r]=t.coefficients[r];return e}}}});var m={},sn=["px","nx","py","ny","pz","nz"];var ln={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]};m.projectEnvironmentMap=function(t,e,r){(r=r||{}).lod=r.lod||0;for(var i=new $r,n=64,e=new("texture2D"===e.textureType?Ci:(n=(e.image&&e.image.px?e.image.px:e).width,Ai))({scene:i,environmentMap:e}),o=Math.ceil(n/Math.pow(2,r.lod)),a=Math.ceil(n/Math.pow(2,r.lod)),s=new F({width:o,height:a}),l=new xi,h=(e.material.define("fragment","RGBM_ENCODE"),r.decodeRGBM&&e.material.define("fragment","RGBM_DECODE"),e.material.set("lod",r.lod),new bi({texture:s})),u={},c=0;c<sn.length;c++){u[sn[c]]=new Uint8Array(o*a*4);var d=h.getCamera(sn[c]);d.fov=90,l.attach(s),l.bind(t),t.render(i,d),t.gl.readPixels(0,0,o,a,B.RGBA,B.UNSIGNED_BYTE,u[sn[c]]),l.unbind(t)}e.dispose(t),l.dispose(t),s.dispose(t);for(var f,p,m,g=u,_=o,y=a,v=new $.Float32Array(27),x=I.create(),T=I.create(),b=I.create(),w=0;w<9;w++){for(var S=I.create(),E=0;E<sn.length;E++){for(var M=g[sn[E]],A=I.create(),C=0,D=0,L=ln[sn[E]],P=0;P<y;P++)for(var N=0;N<_;N++){x[0]=N/(_-1)*2-1,x[1]=P/(y-1)*2-1,x[2]=-1,I.normalize(x,x),b[0]=x[L[0]]*L[3],b[1]=x[L[1]]*L[4],b[2]=x[L[2]]*L[5],T[0]=M[D++]/255,T[1]=M[D++]/255,T[2]=M[D++]/255;var R=M[D++]/255*8.12;T[0]*=R,T[1]*=R,T[2]*=R,I.scaleAndAdd(A,A,T,(R=w,m=p=void 0,p=(f=b)[0],m=f[1],f=f[2],(0===R?1:1===R?p:2===R?m:3===R?f:4===R?p*f:5===R?m*f:6===R?p*m:7===R?3*f*f-1:p*p-m*m)*-x[2])),C+=-x[2]}I.scaleAndAdd(S,S,A,1/C)}v[3*w]=S[0]/6,v[3*w+1]=S[1]/6,v[3*w+2]=S[2]/6}return v};const hn=m,A={firstNotNull:function(){for(var t=0,e=arguments.length;t<e;t++)if(null!=arguments[t])return arguments[t]},queryDataIndex:function(e,t){return null!=t.dataIndexInside?t.dataIndexInside:null!=t.dataIndex?O.util.isArray(t.dataIndex)?O.util.map(t.dataIndex,function(t){return e.indexOfRawIndex(t)}):e.indexOfRawIndex(t.dataIndex):null!=t.name?O.util.isArray(t.name)?O.util.map(t.name,function(t){return e.indexOfName(t)}):e.indexOfName(t.name):void 0}};function _(t,e,r,i){t=t||0,e=e||0,r=r||0,i=i||0,this.array=s.fromValues(t,e,r,i),this._dirty=!0}var Ar=p.extend({dynamic:!1,widthSegments:40,heightSegments:20,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:Math.PI,radius:1},function(){this.build()},{build:function(){for(var t,e,r,i,n,o,a,s,l,h,u=this.heightSegments,c=this.widthSegments,d=this.attributes.position,f=this.attributes.texcoord0,p=this.attributes.normal,m=(c+1)*(u+1),m=(d.init(m),f.init(m),p.init(m),65535<m?Uint32Array:Uint16Array),g=this.indices=new m(c*u*6),_=(this.radius,this.phiStart),y=this.phiLength,v=this.thetaStart,x=this.thetaLength,T=[],b=[],w=0,S=1/(a=this.radius),E=0;E<=u;E++)for(o=0;o<=c;o++)i=o/c,n=E/u,t=-a*Math.cos(_+i*y)*Math.sin(v+n*x),e=a*Math.cos(v+n*x),r=a*Math.sin(_+i*y)*Math.sin(v+n*x),T[0]=t,T[1]=e,T[2]=r,b[0]=i,b[1]=n,d.set(w,T),f.set(w,b),T[0]*=S,T[1]*=S,T[2]*=S,p.set(w,T),w++;var M=c+1,A=0;for(E=0;E<u;E++)for(o=0;o<c;o++)h=(E+1)*M+o+1,l=(E+1)*M+o,g[A++]=(s=E*M+o)+1,g[A++]=s,g[A++]=h,g[A++]=s,g[A++]=l,g[A++]=h;this.boundingBox=new je,this.boundingBox.max.set(a,a,a),this.boundingBox.min.set(-a,-a,-a)}}),e=Cr.extend({castShadow:!1},{type:"AMBIENT_LIGHT",uniformTemplates:{ambientLightColor:{type:"3f",value:function(t){var e=t.color,t=t.intensity;return[e[0]*t,e[1]*t,e[2]*t]}}}}),d=Cr.extend({shadowBias:.001,shadowSlopeScale:2,shadowCascade:1,cascadeSplitLogFactor:.2},{type:"DIRECTIONAL_LIGHT",uniformTemplates:{directionalLightDirection:{type:"3f",value:function(t){return t.__dir=t.__dir||new C,t.__dir.copy(t.worldTransform.z).normalize().negate().array}},directionalLightColor:{type:"3f",value:function(t){var e=t.color,t=t.intensity;return[e[0]*t,e[1]*t,e[2]*t]}}},clone:function(){var t=Cr.prototype.clone.call(this);return t.shadowBias=this.shadowBias,t.shadowSlopeScale=this.shadowSlopeScale,t}}),t=Cr.extend({range:100,castShadow:!1},{type:"POINT_LIGHT",uniformTemplates:{pointLightPosition:{type:"3f",value:function(t){return t.getWorldPosition().array}},pointLightRange:{type:"1f",value:function(t){return t.range}},pointLightColor:{type:"3f",value:function(t){var e=t.color,t=t.intensity;return[e[0]*t,e[1]*t,e[2]*t]}}},clone:function(){var t=Cr.prototype.clone.call(this);return t.range=this.range,t}}),g=Cr.extend({range:20,umbraAngle:30,penumbraAngle:45,falloffFactor:2,shadowBias:.001,shadowSlopeScale:2},{type:"SPOT_LIGHT",uniformTemplates:{spotLightPosition:{type:"3f",value:function(t){return t.getWorldPosition().array}},spotLightRange:{type:"1f",value:function(t){return t.range}},spotLightUmbraAngleCosine:{type:"1f",value:function(t){return Math.cos(t.umbraAngle*Math.PI/180)}},spotLightPenumbraAngleCosine:{type:"1f",value:function(t){return Math.cos(t.penumbraAngle*Math.PI/180)}},spotLightFalloffFactor:{type:"1f",value:function(t){return t.falloffFactor}},spotLightDirection:{type:"3f",value:function(t){return t.__dir=t.__dir||new C,t.__dir.copy(t.worldTransform.z).negate().array}},spotLightColor:{type:"3f",value:function(t){var e=t.color,t=t.intensity;return[e[0]*t,e[1]*t,e[2]*t]}}},clone:function(){var t=Cr.prototype.clone.call(this);return t.range=this.range,t.umbraAngle=this.umbraAngle,t.penumbraAngle=this.penumbraAngle,t.falloffFactor=this.falloffFactor,t.shadowBias=this.shadowBias,t.shadowSlopeScale=this.shadowSlopeScale,t}}),m=(_.prototype={constructor:_,add:function(t){return s.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e,r,i){return this.array[0]=t,this.array[1]=e,this.array[2]=r,this.array[3]=i,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this.array[2]=t[2],this.array[3]=t[3],this._dirty=!0,this},clone:function(){return new _(this.x,this.y,this.z,this.w)},copy:function(t){return s.copy(this.array,t.array),this._dirty=!0,this},dist:function(t){return s.dist(this.array,t.array)},distance:function(t){return s.distance(this.array,t.array)},div:function(t){return s.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return s.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return s.dot(this.array,t.array)},len:function(){return s.len(this.array)},length:function(){return s.length(this.array)},lerp:function(t,e,r){return s.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return s.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return s.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return s.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return s.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return s.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return s.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return s.random(this.array,t),this._dirty=!0,this},scale:function(t){return s.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return s.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return s.sqrDist(this.array,t.array)},squaredDistance:function(t){return s.squaredDistance(this.array,t.array)},sqrLen:function(){return s.sqrLen(this.array)},squaredLength:function(){return s.squaredLength(this.array)},sub:function(t){return s.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return s.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return s.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},transformQuat:function(t){return s.transformQuat(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Object.defineProperty),m=(m&&(m(un=_.prototype,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),m(un,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}}),m(un,"z",{get:function(){return this.array[2]},set:function(t){this.array[2]=t,this._dirty=!0}}),m(un,"w",{get:function(){return this.array[3]},set:function(t){this.array[3]=t,this._dirty=!0}})),_.add=function(t,e,r){return s.add(t.array,e.array,r.array),t._dirty=!0,t},_.set=function(t,e,r,i,n){s.set(t.array,e,r,i,n),t._dirty=!0},_.copy=function(t,e){return s.copy(t.array,e.array),t._dirty=!0,t},_.distance=_.dist=function(t,e){return s.distance(t.array,e.array)},_.divide=_.div=function(t,e,r){return s.divide(t.array,e.array,r.array),t._dirty=!0,t},_.dot=function(t,e){return s.dot(t.array,e.array)},_.len=function(t){return s.length(t.array)},_.lerp=function(t,e,r,i){return s.lerp(t.array,e.array,r.array,i),t._dirty=!0,t},_.min=function(t,e,r){return s.min(t.array,e.array,r.array),t._dirty=!0,t},_.max=function(t,e,r){return s.max(t.array,e.array,r.array),t._dirty=!0,t},_.multiply=_.mul=function(t,e,r){return s.multiply(t.array,e.array,r.array),t._dirty=!0,t},_.negate=function(t,e){return s.negate(t.array,e.array),t._dirty=!0,t},_.normalize=function(t,e){return s.normalize(t.array,e.array),t._dirty=!0,t},_.random=function(t,e){return s.random(t.array,e),t._dirty=!0,t},_.scale=function(t,e,r){return s.scale(t.array,e.array,r),t._dirty=!0,t},_.scaleAndAdd=function(t,e,r,i){return s.scaleAndAdd(t.array,e.array,r.array,i),t._dirty=!0,t},_.squaredDistance=_.sqrDist=function(t,e){return s.sqrDist(t.array,e.array)},_.squaredLength=_.sqrLen=function(t){return s.sqrLen(t.array)},_.subtract=_.sub=function(t,e,r){return s.subtract(t.array,e.array,r.array),t._dirty=!0,t},_.transformMat4=function(t,e,r){return s.transformMat4(t.array,e.array,r.array),t._dirty=!0,t},_.transformQuat=function(t,e,r){return s.transformQuat(t.array,e.array,r.array),t._dirty=!0,t},_),un={create:function(){var t=new wt(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},clone:function(t){var e=new wt(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},transpose:function(t,e){var r;return t===e?(r=e[1],t[1]=e[2],t[2]=r):(t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3]),t},invert:function(t,e){var r=e[0],i=e[1],n=e[2],e=e[3],o=r*e-n*i;return o?(t[0]=e*(o=1/o),t[1]=-i*o,t[2]=-n*o,t[3]=r*o,t):null},adjoint:function(t,e){var r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:function(t,e,r){var i=e[0],n=e[1],o=e[2],e=e[3],a=r[0],s=r[1],l=r[2],r=r[3];return t[0]=i*a+o*s,t[1]=n*a+e*s,t[2]=i*l+o*r,t[3]=n*l+e*r,t}};un.mul=un.multiply,un.rotate=function(t,e,r){var i=e[0],n=e[1],o=e[2],e=e[3],a=Math.sin(r),r=Math.cos(r);return t[0]=i*r+o*a,t[1]=n*r+e*a,t[2]=i*-a+o*r,t[3]=n*-a+e*r,t},un.scale=function(t,e,r){var i=e[0],n=e[1],o=e[2],e=e[3],a=r[0],r=r[1];return t[0]=i*a,t[1]=n*a,t[2]=o*r,t[3]=e*r,t},un.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},un.LDU=function(t,e,r,i){return t[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-t[2]*r[1],[t,e,r]};const cn=un;function dn(){this.array=cn.create(),this._dirty=!0}dn.prototype={constructor:dn,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},clone:function(){return(new dn).copy(this)},copy:function(t){return cn.copy(this.array,t.array),this._dirty=!0,this},adjoint:function(){return cn.adjoint(this.array,this.array),this._dirty=!0,this},determinant:function(){return cn.determinant(this.array)},identity:function(){return cn.identity(this.array),this._dirty=!0,this},invert:function(){return cn.invert(this.array,this.array),this._dirty=!0,this},mul:function(t){return cn.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return cn.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return cn.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return cn.multiply(this.array,t.array,this.array),this._dirty=!0,this},rotate:function(t){return cn.rotate(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return cn.scale(this.array,this.array,t.array),this._dirty=!0,this},transpose:function(){return cn.transpose(this.array,this.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},dn.adjoint=function(t,e){return cn.adjoint(t.array,e.array),t._dirty=!0,t},dn.copy=function(t,e){return cn.copy(t.array,e.array),t._dirty=!0,t},dn.determinant=function(t){return cn.determinant(t.array)},dn.identity=function(t){return cn.identity(t.array),t._dirty=!0,t},dn.invert=function(t,e){return cn.invert(t.array,e.array),t._dirty=!0,t},dn.multiply=dn.mul=function(t,e,r){return cn.mul(t.array,e.array,r.array),t._dirty=!0,t},dn.rotate=function(t,e,r){return cn.rotate(t.array,e.array,r),t._dirty=!0,t},dn.scale=function(t,e,r){return cn.scale(t.array,e.array,r.array),t._dirty=!0,t},dn.transpose=function(t,e){return cn.transpose(t.array,e.array),t._dirty=!0,t};var un=dn,y={create:function(){var t=new wt(6);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},clone:function(t){var e=new wt(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},invert:function(t,e){var r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],e=e[5],s=r*o-i*n;return s?(t[0]=o*(s=1/s),t[1]=-i*s,t[2]=-n*s,t[3]=r*s,t[4]=(n*e-o*a)*s,t[5]=(i*a-r*e)*s,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],e=e[5],l=r[0],h=r[1],u=r[2],c=r[3],d=r[4],r=r[5];return t[0]=i*l+o*h,t[1]=n*l+a*h,t[2]=i*u+o*c,t[3]=n*u+a*c,t[4]=i*d+o*r+s,t[5]=n*d+a*r+e,t}};y.mul=y.multiply,y.rotate=function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],e=e[5],l=Math.sin(r),r=Math.cos(r);return t[0]=i*r+o*l,t[1]=n*r+a*l,t[2]=i*-l+o*r,t[3]=n*-l+a*r,t[4]=s,t[5]=e,t},y.scale=function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],e=e[5],l=r[0],r=r[1];return t[0]=i*l,t[1]=n*l,t[2]=o*r,t[3]=a*r,t[4]=s,t[5]=e,t},y.translate=function(t,e,r){var i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],e=e[5],l=r[0],r=r[1];return t[0]=i,t[1]=n,t[2]=o,t[3]=a,t[4]=i*l+o*r+s,t[5]=n*l+a*r+e,t},y.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)};const fn=y;function pn(){this.array=fn.create(),this._dirty=!0}function mn(){this.array=l.create(),this._dirty=!0}pn.prototype={constructor:pn,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},clone:function(){return(new pn).copy(this)},copy:function(t){return fn.copy(this.array,t.array),this._dirty=!0,this},determinant:function(){return fn.determinant(this.array)},identity:function(){return fn.identity(this.array),this._dirty=!0,this},invert:function(){return fn.invert(this.array,this.array),this._dirty=!0,this},mul:function(t){return fn.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return fn.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return fn.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return fn.multiply(this.array,t.array,this.array),this._dirty=!0,this},rotate:function(t){return fn.rotate(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return fn.scale(this.array,this.array,t.array),this._dirty=!0,this},translate:function(t){return fn.translate(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},pn.copy=function(t,e){return fn.copy(t.array,e.array),t._dirty=!0,t},pn.determinant=function(t){return fn.determinant(t.array)},pn.identity=function(t){return fn.identity(t.array),t._dirty=!0,t},pn.invert=function(t,e){return fn.invert(t.array,e.array),t._dirty=!0,t},pn.multiply=pn.mul=function(t,e,r){return fn.mul(t.array,e.array,r.array),t._dirty=!0,t},pn.rotate=function(t,e,r){return fn.rotate(t.array,e.array,r),t._dirty=!0,t},pn.scale=function(t,e,r){return fn.scale(t.array,e.array,r.array),t._dirty=!0,t},pn.translate=function(t,e,r){return fn.translate(t.array,e.array,r.array),t._dirty=!0,t};var y=pn,gn=(mn.prototype={constructor:mn,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},adjoint:function(){return l.adjoint(this.array,this.array),this._dirty=!0,this},clone:function(){return(new mn).copy(this)},copy:function(t){return l.copy(this.array,t.array),this._dirty=!0,this},determinant:function(){return l.determinant(this.array)},fromMat2d:function(t){return l.fromMat2d(this.array,t.array),this._dirty=!0,this},fromMat4:function(t){return l.fromMat4(this.array,t.array),this._dirty=!0,this},fromQuat:function(t){return l.fromQuat(this.array,t.array),this._dirty=!0,this},identity:function(){return l.identity(this.array),this._dirty=!0,this},invert:function(){return l.invert(this.array,this.array),this._dirty=!0,this},mul:function(t){return l.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return l.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return l.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return l.multiply(this.array,t.array,this.array),this._dirty=!0,this},rotate:function(t){return l.rotate(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return l.scale(this.array,this.array,t.array),this._dirty=!0,this},translate:function(t){return l.translate(this.array,this.array,t.array),this._dirty=!0,this},normalFromMat4:function(t){return l.normalFromMat4(this.array,t.array),this._dirty=!0,this},transpose:function(){return l.transpose(this.array,this.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},mn.adjoint=function(t,e){return l.adjoint(t.array,e.array),t._dirty=!0,t},mn.copy=function(t,e){return l.copy(t.array,e.array),t._dirty=!0,t},mn.determinant=function(t){return l.determinant(t.array)},mn.identity=function(t){return l.identity(t.array),t._dirty=!0,t},mn.invert=function(t,e){return l.invert(t.array,e.array),t},mn.multiply=mn.mul=function(t,e,r){return l.mul(t.array,e.array,r.array),t._dirty=!0,t},mn.fromMat2d=function(t,e){return l.fromMat2d(t.array,e.array),t._dirty=!0,t},mn.fromMat4=function(t,e){return l.fromMat4(t.array,e.array),t._dirty=!0,t},mn.fromQuat=function(t,e){return l.fromQuat(t.array,e.array),t._dirty=!0,t},mn.normalFromMat4=function(t,e){return l.normalFromMat4(t.array,e.array),t._dirty=!0,t},mn.rotate=function(t,e,r){return l.rotate(t.array,e.array,r),t._dirty=!0,t},mn.scale=function(t,e,r){return l.scale(t.array,e.array,r.array),t._dirty=!0,t},mn.transpose=function(t,e){return l.transpose(t.array,e.array),t._dirty=!0,t},mn.translate=function(t,e,r){return l.translate(t.array,e.array,r.array),t._dirty=!0,t},mn),_n={linear:function(t){return t},quadraticIn:function(t){return t*t},quadraticOut:function(t){return t*(2-t)},quadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:function(t){return t*t*t},cubicOut:function(t){return--t*t*t+1},cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quarticIn:function(t){return t*t*t*t},quarticOut:function(t){return 1- --t*t*t*t},quarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quinticIn:function(t){return t*t*t*t*t},quinticOut:function(t){return--t*t*t*t*t+1},quinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sinusoidalIn:function(t){return 1-Math.cos(t*Math.PI/2)},sinusoidalOut:function(t){return Math.sin(t*Math.PI/2)},sinusoidalInOut:function(t){return.5*(1-Math.cos(Math.PI*t))},exponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},exponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},exponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},circularIn:function(t){return 1-Math.sqrt(1-t*t)},circularOut:function(t){return Math.sqrt(1- --t*t)},circularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:function(t){var e,r=.1;return 0===t?0:1===t?1:(e=!r||r<1?(r=1,.1):.4*Math.asin(1/r)/(2*Math.PI),-(r*Math.pow(2,10*--t)*Math.sin((t-e)*(2*Math.PI)/.4)))},elasticOut:function(t){var e,r=.1;return 0===t?0:1===t?1:(e=!r||r<1?(r=1,.1):.4*Math.asin(1/r)/(2*Math.PI),r*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/.4)+1)},elasticInOut:function(t){var e,r=.1;return 0===t?0:1===t?1:(e=!r||r<1?(r=1,.1):.4*Math.asin(1/r)/(2*Math.PI),(t*=2)<1?r*Math.pow(2,10*--t)*Math.sin((t-e)*(2*Math.PI)/.4)*-.5:r*Math.pow(2,-10*--t)*Math.sin((t-e)*(2*Math.PI)/.4)*.5+1)},backIn:function(t){return t*t*(2.70158*t-1.70158)},backOut:function(t){return--t*t*(2.70158*t+1.70158)+1},backInOut:function(t){var e=2.5949095;return(t*=2)<1?t*t*((1+e)*t-e)*.5:.5*((t-=2)*t*((1+e)*t+e)+2)},bounceIn:function(t){return 1-_n.bounceOut(1-t)},bounceOut:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},bounceInOut:function(t){return t<.5?.5*_n.bounceIn(2*t):.5*_n.bounceOut(2*t-1)+.5}};const yn=_n;function vn(t){this._initialized=!1,this._startTime=0,this._pausedTime=0,this._paused=!1,this._life=t.life||1e3,this._delay=t.delay||0,this.loop=null!=t.loop&&t.loop,this.gap=t.gap||0,this.easing=t.easing||"linear",this.onframe=t.onframe,this.ondestroy=t.ondestroy,this.onrestart=t.onrestart}vn.prototype.step=function(t,e){if(this._initialized||(this._startTime=t+this._delay,this._initialized=!0),!this._paused){var r=(t-this._startTime-this._pausedTime)/this._life,i=(r<0&&(r=0),r=Math.min(r,1),this.easing),i="string"==typeof i?yn[i]:i,i="function"==typeof i?i(r):r;if(this.onframe&&this.onframe(i),1===r){if(!this.loop)return!0;this._restart(t),this.onrestart&&this.onrestart()}return!1}this._pausedTime+=e},vn.prototype._restart=function(t){var e=(t-this._startTime-this._pausedTime)%this._life;this._startTime=t-e+this.gap,this._pausedTime=0},vn.prototype.pause=function(){this._paused=!0},vn.prototype.resume=function(){this._paused=!1};const xn=vn;var Tn={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function bn(t){return(t=Math.round(t))<0?0:255<t?255:t}function wn(t){return t<0?0:1<t?1:t}function Sn(t){return t.length&&"%"===t.charAt(t.length-1)?bn(parseFloat(t)/100*255):bn(parseInt(t,10))}function En(t){return t.length&&"%"===t.charAt(t.length-1)?wn(parseFloat(t)/100):wn(parseFloat(t))}function Mn(t,e,r){return r<0?r+=1:1<r&&--r,6*r<1?t+(e-t)*r*6:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function An(t,e,r,i,n){return t[0]=e,t[1]=r,t[2]=i,t[3]=n,t}function Cn(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}var Dn=new ni(20),Ln=null;function Pn(t,e){Ln&&Cn(Ln,e),Ln=Dn.put(t,Ln||e.slice())}function Nn(t,e){if(t){e=e||[];var r=Dn.get(t);if(r)return Cn(e,r);r=(t+="").replace(/ /g,"").toLowerCase();if(r in Tn)return Cn(e,Tn[r]),Pn(t,e),e;var i=r.length;if("#"===r.charAt(0))return 4===i||5===i?0<=(n=parseInt(r.slice(1,4),16))&&n<=4095?(An(e,(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,5===i?parseInt(r.slice(4),16)/15:1),Pn(t,e),e):void An(e,0,0,0,1):7===i||9===i?0<=(n=parseInt(r.slice(1,7),16))&&n<=16777215?(An(e,(16711680&n)>>16,(65280&n)>>8,255&n,9===i?parseInt(r.slice(7),16)/255:1),Pn(t,e),e):void An(e,0,0,0,1):void 0;var n=r.indexOf("("),o=r.indexOf(")");if(-1!==n&&o+1===i){var i=r.substr(0,n),a=r.substr(n+1,o-(n+1)).split(","),s=1;switch(i){case"rgba":if(4!==a.length)return 3===a.length?An(e,+a[0],+a[1],+a[2],1):An(e,0,0,0,1);s=En(a.pop());case"rgb":return 3!==a.length?void An(e,0,0,0,1):(An(e,Sn(a[0]),Sn(a[1]),Sn(a[2]),s),Pn(t,e),e);case"hsla":return 4!==a.length?void An(e,0,0,0,1):(a[3]=En(a[3]),Rn(a,e),Pn(t,e),e);case"hsl":return 3!==a.length?void An(e,0,0,0,1):(Rn(a,e),Pn(t,e),e);default:return}}An(e,0,0,0,1)}}function Rn(t,e){var r=(parseFloat(t[0])%360+360)%360/360,i=En(t[1]),n=En(t[2]),i=n<=.5?n*(i+1):n+i-n*i,n=2*n-i;return An(e=e||[],bn(255*Mn(n,i,r+1/3)),bn(255*Mn(n,i,r)),bn(255*Mn(n,i,r-1/3)),1),4===t.length&&(e[3]=t[3]),e}function In(t,e){var r;if(t&&t.length)return r=t[0]+","+t[1]+","+t[2],"rgba"!==e&&"hsva"!==e&&"hsla"!==e||(r+=","+t[3]),e+"("+r+")"}function On(t,e){t=Nn(t);return t?(.299*t[0]+.587*t[1]+.114*t[2])*t[3]/255+(1-t[3])*e:0}var Bn={"[object Function]":!0,"[object RegExp]":!0,"[object Date]":!0,"[object Error]":!0,"[object CanvasGradient]":!0,"[object CanvasPattern]":!0,"[object Image]":!0,"[object Canvas]":!0},Fn={"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0},zn=Object.prototype.toString,Un=Array.prototype,kn=Un.forEach,Gn=Un.filter,Hn=Un.slice,Vn=Un.map,Un=function(){}.constructor,Un=Un?Un.prototype:null,Wn={};var Xn=2311;function jn(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];"undefined"!=typeof console&&console.error.apply(console,t)}function qn(t){if(null==t||"object"!=typeof t)return t;var e=t,r=zn.call(t);if("[object Array]"===r){if(!vo(t))for(var e=[],i=0,n=t.length;i<n;i++)e[i]=qn(t[i])}else if(Fn[r]){if(!vo(t)){var o=t.constructor;if(o.from)e=o.from(t);else{e=new o(t.length);for(i=0,n=t.length;i<n;i++)e[i]=qn(t[i])}}}else if(!Bn[r]&&!vo(t)&&!uo(t))for(var a in e={},t)t.hasOwnProperty(a)&&(e[a]=qn(t[a]));return e}function Zn(t,e,r){if(!lo(e)||!lo(t))return r?qn(e):t;for(var i in e){var n,o;e.hasOwnProperty(i)&&(n=t[i],!lo(o=e[i])||!lo(n)||oo(o)||oo(n)||uo(o)||uo(n)||ho(o)||ho(n)||vo(o)||vo(n)?!r&&i in t||(t[i]=qn(e[i])):Zn(n,o,r))}return t}function Yn(t,e){if(Object.assign)Object.assign(t,e);else for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function Kn(t,e,r){for(var i=io(e),n=0;n<i.length;n++){var o=i[n];(r?null!=e[o]:null==t[o])&&(t[o]=e[o])}return t}function Qn(t,e){if(t){if(t.indexOf)return t.indexOf(e);for(var r=0,i=t.length;r<i;r++)if(t[r]===e)return r}return-1}function Jn(t,e,r){if(t="prototype"in t?t.prototype:t,e="prototype"in e?e.prototype:e,Object.getOwnPropertyNames)for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var o=i[n];"constructor"!==o&&(r?null!=e[o]:null==t[o])&&(t[o]=e[o])}else Kn(t,e,r)}function $n(t){return!!t&&"string"!=typeof t&&"number"==typeof t.length}function to(t,e,r){if(t&&e)if(t.forEach&&t.forEach===kn)t.forEach(e,r);else if(t.length===+t.length)for(var i=0,n=t.length;i<n;i++)e.call(r,t[i],i,t);else for(var o in t)t.hasOwnProperty(o)&&e.call(r,t[o],o,t)}function eo(t,e,r){if(!t)return[];if(!e)return po(t);if(t.map&&t.map===Vn)return t.map(e,r);for(var i=[],n=0,o=t.length;n<o;n++)i.push(e.call(r,t[n],n,t));return i}function ro(t,e,r,i){if(t&&e){for(var n=0,o=t.length;n<o;n++)r=e.call(i,r,t[n],n,t);return r}}function io(t){if(!t)return[];if(Object.keys)return Object.keys(t);var e,r=[];for(e in t)t.hasOwnProperty(e)&&r.push(e);return r}Wn.createCanvas=function(){return document.createElement("canvas")};Un&&ao(Un.bind)&&Un.call.bind(Un.bind);function no(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return function(){return t.apply(this,e.concat(Hn.call(arguments)))}}function oo(t){return Array.isArray?Array.isArray(t):"[object Array]"===zn.call(t)}function ao(t){return"function"==typeof t}function so(t){return"string"==typeof t}function lo(t){var e=typeof t;return"function"==e||!!t&&"object"==e}function ho(t){return Bn[zn.call(t)]}function uo(t){return"object"==typeof t&&"number"==typeof t.nodeType&&"object"==typeof t.ownerDocument}function co(t,e){return null!=t?t:e}function fo(t,e,r){return null!=t?t:null!=e?e:r}function po(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return Hn.apply(t,e)}function mo(t){var e;return"number"==typeof t?[t,t,t,t]:2===(e=t.length)?[t[0],t[1],t[0],t[1]]:3===e?[t[0],t[1],t[2],t[1]]:t}function go(t,e){if(!t)throw new Error(e)}function _o(t){return null==t?null:"function"==typeof t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}var yo="__ec_primitive__";function vo(t){return t[yo]}To.prototype.get=function(t){return this.data.hasOwnProperty(t)?this.data[t]:null},To.prototype.set=function(t,e){return this.data[t]=e},To.prototype.each=function(t,e){for(var r in this.data)this.data.hasOwnProperty(r)&&t.call(e,this.data[r],r)},To.prototype.keys=function(){return io(this.data)},To.prototype.removeKey=function(t){delete this.data[t]};var xo=To;function To(t){this.data={};var r=oo(t),i=(this.data={},this);function e(t,e){r?i.set(t,e):i.set(e,t)}t instanceof To?t.each(e):t&&to(t,e)}function bo(t){return new xo(t)}function wo(t,e){for(var r=new t.constructor(t.length+e.length),i=0;i<t.length;i++)r[i]=t[i];for(var n=t.length,i=0;i<e.length;i++)r[i+n]=e[i];return r}function So(t,e){var r,t=Object.create?Object.create(t):((r=function(){}).prototype=t,new r);return e&&Yn(t,e),t}var Eo=Array.prototype.slice;function Mo(t,e,r){return(e-t)*r+t}function Ao(t,e,r,i){for(var n=e.length,o=0;o<n;o++)t[o]=Mo(e[o],r[o],i)}function Co(t,e,r,i){for(var n=e.length,o=0;o<n;o++)t[o]=e[o]+r[o]*i;return t}function Do(t,e,r,i){for(var n=e.length,o=n&&e[0].length,a=0;a<n;a++){t[a]||(t[a]=[]);for(var s=0;s<o;s++)t[a][s]=e[a][s]+r[a][s]*i}return t}function Lo(t,e){var r=t.length;if(r===e.length){for(var i=0;i<r;i++)if(t[i]!==e[i])return;return 1}}function Po(t,e,r,i,n,o,a){t=.5*(r-t),i=.5*(i-e);return(2*(e-r)+t+i)*a+(-3*(e-r)-2*t-i)*o+t*n+e}function No(t,e,r,i,n,o,a,s){for(var l=e.length,h=0;h<l;h++)t[h]=Po(e[h],r[h],i[h],n[h],o,a,s)}function Ro(t){if($n(t)){var e=t.length;if($n(t[0])){for(var r=[],i=0;i<e;i++)r.push(Eo.call(t[i]));return r}return Eo.call(t)}return t}function Io(t){return t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),"rgba("+t.join(",")+")"}var Oo=[0,0,0,0],Bo=(Fo.prototype.isFinished=function(){return this._finished},Fo.prototype.setFinished=function(){this._finished=!0,this._additiveTrack&&this._additiveTrack.setFinished()},Fo.prototype.needsAnimate=function(){return!this._isAllValueEqual&&2<=this.keyframes.length&&this.interpolable},Fo.prototype.getAdditiveTrack=function(){return this._additiveTrack},Fo.prototype.addKeyframe=function(t,e){t>=this.maxTime?this.maxTime=t:this._needsSort=!0;var r=this.keyframes,i=r.length;if(this.interpolable)if($n(e)){var n,o=$n((o=e)&&o[0])?2:1;if(0<i&&this.arrDim!==o)return void(this.interpolable=!1);if(1==o&&"number"!=typeof e[0]||2==o&&"number"!=typeof e[0][0])return void(this.interpolable=!1);0<i&&(n=r[i-1],!this._isAllValueEqual||1==o&&Lo(e,n.value)||(this._isAllValueEqual=!1)),this.arrDim=o}else{if(0<this.arrDim)return void(this.interpolable=!1);if("string"==typeof e){o=Nn(e);o?(e=o,this.isValueColor=!0):this.interpolable=!1}else if("number"!=typeof e||isNaN(e))return void(this.interpolable=!1);this._isAllValueEqual&&0<i&&(n=r[i-1],this.isValueColor&&!Lo(n.value,e)||n.value!==e)&&(this._isAllValueEqual=!1)}r={time:t,value:e,percent:0};return this.keyframes.push(r),r},Fo.prototype.prepare=function(t){for(var e=this.keyframes,r=(this._needsSort&&e.sort(function(t,e){return t.time-e.time}),this.arrDim),i=e.length,n=e[i-1],o=0;o<i;o++)if(e[o].percent=e[o].time/this.maxTime,0<r&&o!==i-1){p=f=d=c=u=h=l=s=a=void 0;var a=e[o].value,s=n.value,l=r,h=a,u=s;if(h.push&&u.push){var a=h.length,c=u.length;if(a!==c)if(c<a)h.length=c;else for(var d=a;d<c;d++)h.push(1===l?u[d]:Eo.call(u[d]));for(var f=h[0]&&h[0].length,d=0;d<h.length;d++)if(1===l)isNaN(h[d])&&(h[d]=u[d]);else for(var p=0;p<f;p++)isNaN(h[d][p])&&(h[d][p]=u[d][p])}}if(t&&this.needsAnimate()&&t.needsAnimate()&&r===t.arrDim&&this.isValueColor===t.isValueColor&&!t._finished){this._additiveTrack=t;for(var m=e[0].value,o=0;o<i;o++)0===r?this.isValueColor?e[o].additiveValue=Co([],e[o].value,m,-1):e[o].additiveValue=e[o].value-m:1===r?e[o].additiveValue=Co([],e[o].value,m,-1):2===r&&(e[o].additiveValue=Do([],e[o].value,m,-1))}},Fo.prototype.step=function(t,e){if(!this._finished){this._additiveTrack&&this._additiveTrack._finished&&(this._additiveTrack=null);var r=null!=this._additiveTrack,i=r?"additiveValue":"value",n=this.keyframes,o=this.keyframes.length,a=this.propName,s=this.arrDim,l=this.isValueColor;if(e<0)h=0;else if(e<this._lastFramePercent){for(var h=Math.min(this._lastFrame+1,o-1);0<=h&&!(n[h].percent<=e);h--);h=Math.min(h,o-2)}else{for(h=this._lastFrame;h<o&&!(n[h].percent>e);h++);h=Math.min(h-1,o-2)}var u,c,d,f,p,m,g,_=n[h+1],y=n[h];y&&_&&(this._lastFrame=h,this._lastFramePercent=e,0!=(u=_.percent-y.percent))&&(u=(e-y.percent)/u,c=r?this._additiveValue:l?Oo:t[a],(0<s||l)&&!c&&(c=this._additiveValue=[]),this.useSpline?(g=n[h][i],m=n[0===h?h:h-1][i],d=n[o-2<h?o-1:h+1][i],f=n[o-3<h?o-1:h+2][i],0<s?(1===s?No:function(t,e,r,i,n,o,a,s){for(var l=e.length,h=e[0].length,u=0;u<l;u++){t[u]||(t[1]=[]);for(var c=0;c<h;c++)t[u][c]=Po(e[u][c],r[u][c],i[u][c],n[u][c],o,a,s)}})(c,m,g,d,f,u,u*u,u*u*u):l?(No(c,m,g,d,f,u,u*u,u*u*u),r||(t[a]=Io(c))):(p=void 0,p=this.interpolable?Po(m,g,d,f,u,u*u,u*u*u):d,r?this._additiveValue=p:t[a]=p)):0<s?(1===s?Ao:function(t,e,r,i){for(var n=e.length,o=n&&e[0].length,a=0;a<n;a++){t[a]||(t[a]=[]);for(var s=0;s<o;s++)t[a][s]=Mo(e[a][s],r[a][s],i)}})(c,y[i],_[i],u):l?(Ao(c,y[i],_[i],u),r||(t[a]=Io(c))):(p=void 0,p=this.interpolable?Mo(y[i],_[i],u):(m=y[i],g=_[i],.5<u?g:m),r?this._additiveValue=p:t[a]=p),r)&&this._addToTarget(t)}},Fo.prototype._addToTarget=function(t){var e=this.arrDim,r=this.propName,i=this._additiveValue;0===e?this.isValueColor?(Nn(t[r],Oo),Co(Oo,Oo,i,1),t[r]=Io(Oo)):t[r]=t[r]+i:1===e?Co(t[r],t[r],i,1):2===e&&Do(t[r],t[r],i,1)},Fo);function Fo(t){this.keyframes=[],this.maxTime=0,this.arrDim=0,this.interpolable=!0,this._needsSort=!1,this._isAllValueEqual=!0,this._lastFrame=0,this._lastFramePercent=0,this.propName=t}function zo(t,e,r){this._tracks={},this._trackKeys=[],this._delay=0,this._maxTime=0,this._paused=!1,this._started=0,this._clip=null,this._target=t,(this._loop=e)&&r?jn("Can' use additive animation on looped animation."):this._additiveAnimators=r}zo.prototype.getTarget=function(){return this._target},zo.prototype.changeTarget=function(t){this._target=t},zo.prototype.when=function(t,e){return this.whenWithKeys(t,e,io(e))},zo.prototype.whenWithKeys=function(t,e,r){for(var i=this._tracks,n=0;n<r.length;n++){var o=r[n];if(!(s=i[o])){var a,s=i[o]=new Bo(o),l=void 0,h=this._getAdditiveTrack(o);if(h?(l=(a=h.keyframes[h.keyframes.length-1])&&a.value,h.isValueColor&&(l=l&&Io(l))):l=this._target[o],null==l)continue;0!==t&&s.addKeyframe(0,Ro(l)),this._trackKeys.push(o)}s.addKeyframe(t,Ro(e[o]))}return this._maxTime=Math.max(this._maxTime,t),this},zo.prototype.pause=function(){this._clip.pause(),this._paused=!0},zo.prototype.resume=function(){this._clip.resume(),this._paused=!1},zo.prototype.isPaused=function(){return!!this._paused},zo.prototype._doneCallback=function(){this._setTracksFinished(),this._clip=null;var t=this._doneList;if(t)for(var e=t.length,r=0;r<e;r++)t[r].call(this)},zo.prototype._abortedCallback=function(){this._setTracksFinished();var t=this.animation,e=this._abortedList;if(t&&t.removeClip(this._clip),this._clip=null,e)for(var r=0;r<e.length;r++)e[r].call(this)},zo.prototype._setTracksFinished=function(){for(var t=this._tracks,e=this._trackKeys,r=0;r<e.length;r++)t[e[r]].setFinished()},zo.prototype._getAdditiveTrack=function(t){var e,r=this._additiveAnimators;if(r)for(var i=0;i<r.length;i++){var n=r[i].getTrack(t);n&&(e=n)}return e},zo.prototype.start=function(t,e){if(!(0<this._started)){this._started=1;for(var o=this,a=[],r=0;r<this._trackKeys.length;r++){var i=this._trackKeys[r],n=this._tracks[i],i=this._getAdditiveTrack(i),s=n.keyframes;n.prepare(i),n.needsAnimate()?a.push(n):n.interpolable||(i=s[s.length-1])&&(o._target[n.propName]=i.value)}return a.length||e?(e=new xn({life:this._maxTime,loop:this._loop,delay:this._delay,onframe:function(t){o._started=2;var e=o._additiveAnimators;if(e){for(var r=!1,i=0;i<e.length;i++)if(e[i]._clip){r=!0;break}r||(o._additiveAnimators=null)}for(i=0;i<a.length;i++)a[i].step(o._target,t);var n=o._onframeList;if(n)for(i=0;i<n.length;i++)n[i](o._target,t)},ondestroy:function(){o._doneCallback()}}),this._clip=e,this.animation&&this.animation.addClip(e),t&&"spline"!==t&&(e.easing=t)):this._doneCallback(),this}},zo.prototype.stop=function(t){var e;this._clip&&(e=this._clip,t&&e.onframe(1),this._abortedCallback())},zo.prototype.delay=function(t){return this._delay=t,this},zo.prototype.during=function(t){return t&&(this._onframeList||(this._onframeList=[]),this._onframeList.push(t)),this},zo.prototype.done=function(t){return t&&(this._doneList||(this._doneList=[]),this._doneList.push(t)),this},zo.prototype.aborted=function(t){return t&&(this._abortedList||(this._abortedList=[]),this._abortedList.push(t)),this},zo.prototype.getClip=function(){return this._clip},zo.prototype.getTrack=function(t){return this._tracks[t]},zo.prototype.stopTracks=function(t,e){if(!t.length||!this._clip)return!0;for(var r=this._tracks,i=this._trackKeys,n=0;n<t.length;n++){var o=r[t[n]];o&&(e?o.step(this._target,1):1===this._started&&o.step(this._target,0),o.setFinished())}for(var a=!0,n=0;n<i.length;n++)if(!r[i[n]].isFinished()){a=!1;break}return a&&this._abortedCallback(),a},zo.prototype.saveFinalToTarget=function(t,e){if(t){e=e||this._trackKeys;for(var r=0;r<e.length;r++){var i,n=e[r],o=this._tracks[n];o&&!o.isFinished()&&(i=(i=o.keyframes)[i.length-1])&&(i=Ro(i.value),o.isValueColor&&(i=Io(i)),t[n]=i)}}},zo.prototype.__changeFinalValue=function(t,e){e=e||io(t);for(var r=0;r<e.length;r++){var i,n=e[r],o=this._tracks[n];o&&1<(i=o.keyframes).length&&(i=i.pop(),o.addKeyframe(i.time,t[n]),o.prepare(o.getAdditiveTrack()))}};const Uo=zo;Un="\n@export clay.util.rand\nhighp float rand(vec2 uv) {\n const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n highp float dt = dot(uv.xy, vec2(a,b)), sn = mod(dt, 3.141592653589793);\n return fract(sin(sn) * c);\n}\n@end\n@export clay.util.calculate_attenuation\nuniform float attenuationFactor : 5.0;\nfloat lightAttenuation(float dist, float range)\n{\n float attenuation = 1.0;\n attenuation = dist*dist/(range*range+1.0);\n float att_s = attenuationFactor;\n attenuation = 1.0/(attenuation*att_s+1.0);\n att_s = 1.0/(att_s+1.0);\n attenuation = attenuation - att_s;\n attenuation /= 1.0 - att_s;\n return clamp(attenuation, 0.0, 1.0);\n}\n@end\n@export clay.util.edge_factor\n#ifdef SUPPORT_STANDARD_DERIVATIVES\nfloat edgeFactor(float width)\n{\n vec3 d = fwidth(v_Barycentric);\n vec3 a3 = smoothstep(vec3(0.0), d * width, v_Barycentric);\n return min(min(a3.x, a3.y), a3.z);\n}\n#else\nfloat edgeFactor(float width)\n{\n return 1.0;\n}\n#endif\n@end\n@export clay.util.encode_float\nvec4 encodeFloat(const in float depth)\n{\n const vec4 bitShifts = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n const vec4 bit_mask = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n vec4 res = fract(depth * bitShifts);\n res -= res.xxyz * bit_mask;\n return res;\n}\n@end\n@export clay.util.decode_float\nfloat decodeFloat(const in vec4 color)\n{\n const vec4 bitShifts = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n return dot(color, bitShifts);\n}\n@end\n@export clay.util.float\n@import clay.util.encode_float\n@import clay.util.decode_float\n@end\n@export clay.util.rgbm_decode\nvec3 RGBMDecode(vec4 rgbm, float range) {\n return range * rgbm.rgb * rgbm.a;\n}\n@end\n@export clay.util.rgbm_encode\nvec4 RGBMEncode(vec3 color, float range) {\n if (dot(color, color) == 0.0) {\n return vec4(0.0);\n }\n vec4 rgbm;\n color /= range;\n rgbm.a = clamp(max(max(color.r, color.g), max(color.b, 1e-6)), 0.0, 1.0);\n rgbm.a = ceil(rgbm.a * 255.0) / 255.0;\n rgbm.rgb = color / rgbm.a;\n return rgbm;\n}\n@end\n@export clay.util.rgbm\n@import clay.util.rgbm_decode\n@import clay.util.rgbm_encode\nvec4 decodeHDR(vec4 color)\n{\n#if defined(RGBM_DECODE) || defined(RGBM)\n return vec4(RGBMDecode(color, 8.12), 1.0);\n#else\n return color;\n#endif\n}\nvec4 encodeHDR(vec4 color)\n{\n#if defined(RGBM_ENCODE) || defined(RGBM)\n return RGBMEncode(color.xyz, 8.12);\n#else\n return color;\n#endif\n}\n@end\n@export clay.util.srgb\nvec4 sRGBToLinear(in vec4 value) {\n return vec4(mix(pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), value.rgb * 0.0773993808, vec3(lessThanEqual(value.rgb, vec3(0.04045)))), value.w);\n}\nvec4 linearTosRGB(in vec4 value) {\n return vec4(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))), value.w);\n}\n@end\n@export clay.chunk.skinning_header\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n#ifdef USE_SKIN_MATRICES_TEXTURE\nuniform sampler2D skinMatricesTexture : ignore;\nuniform float skinMatricesTextureSize: ignore;\nmat4 getSkinMatrix(sampler2D tex, float idx) {\n float j = idx * 4.0;\n float x = mod(j, skinMatricesTextureSize);\n float y = floor(j / skinMatricesTextureSize) + 0.5;\n vec2 scale = vec2(skinMatricesTextureSize);\n return mat4(\n texture2D(tex, vec2(x + 0.5, y) / scale),\n texture2D(tex, vec2(x + 1.5, y) / scale),\n texture2D(tex, vec2(x + 2.5, y) / scale),\n texture2D(tex, vec2(x + 3.5, y) / scale)\n );\n}\nmat4 getSkinMatrix(float idx) {\n return getSkinMatrix(skinMatricesTexture, idx);\n}\n#else\nuniform mat4 skinMatrix[JOINT_COUNT] : SKIN_MATRIX;\nmat4 getSkinMatrix(float idx) {\n return skinMatrix[int(idx)];\n}\n#endif\n#endif\n@end\n@export clay.chunk.skin_matrix\nmat4 skinMatrixWS = getSkinMatrix(joint.x) * weight.x;\nif (weight.y > 1e-4)\n{\n skinMatrixWS += getSkinMatrix(joint.y) * weight.y;\n}\nif (weight.z > 1e-4)\n{\n skinMatrixWS += getSkinMatrix(joint.z) * weight.z;\n}\nfloat weightW = 1.0-weight.x-weight.y-weight.z;\nif (weightW > 1e-4)\n{\n skinMatrixWS += getSkinMatrix(joint.w) * weightW;\n}\n@end\n@export clay.chunk.instancing_header\n#ifdef INSTANCING\nattribute vec4 instanceMat1;\nattribute vec4 instanceMat2;\nattribute vec4 instanceMat3;\n#endif\n@end\n@export clay.chunk.instancing_matrix\nmat4 instanceMat = mat4(\n vec4(instanceMat1.xyz, 0.0),\n vec4(instanceMat2.xyz, 0.0),\n vec4(instanceMat3.xyz, 0.0),\n vec4(instanceMat1.w, instanceMat2.w, instanceMat3.w, 1.0)\n);\n@end\n@export clay.util.parallax_correct\nvec3 parallaxCorrect(in vec3 dir, in vec3 pos, in vec3 boxMin, in vec3 boxMax) {\n vec3 first = (boxMax - pos) / dir;\n vec3 second = (boxMin - pos) / dir;\n vec3 further = max(first, second);\n float dist = min(further.x, min(further.y, further.z));\n vec3 fixedPos = pos + dir * dist;\n vec3 boxCenter = (boxMax + boxMin) * 0.5;\n return normalize(fixedPos - boxCenter);\n}\n@end\n@export clay.util.clamp_sample\nvec4 clampSample(const in sampler2D texture, const in vec2 coord)\n{\n#ifdef STEREO\n float eye = step(0.5, coord.x) * 0.5;\n vec2 coordClamped = clamp(coord, vec2(eye, 0.0), vec2(0.5 + eye, 1.0));\n#else\n vec2 coordClamped = clamp(coord, vec2(0.0), vec2(1.0));\n#endif\n return texture2D(texture, coordClamped);\n}\n@end\n@export clay.util.ACES\nvec3 ACESToneMapping(vec3 color)\n{\n const float A = 2.51;\n const float B = 0.03;\n const float C = 2.43;\n const float D = 0.59;\n const float E = 0.14;\n return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n@end";function ko(t){return t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof Image}Object.assign(rr.prototype,{_animators:null,getAnimators:function(){return this._animators=this._animators||[],this._animators},animate:function(t,e){this._animators=this._animators||[];var r;if(t){for(var i=t.split("."),n=this,o=0,a=i.length;o<a;o++)n=n&&n[i[o]];n&&(r=n)}else r=this;if(null==r)throw new Error("Target "+t+" not exists");var s=this._animators,l=new Uo(r,e),h=this;return l.during(function(){h.__zr&&h.__zr.refresh()}).done(function(){var t=s.indexOf(l);0<=t&&s.splice(t,1)}),s.push(l),this.__zr&&this.__zr.animation.addAnimator(l),l},stopAnimation:function(t){this._animators=this._animators||[];for(var e=this._animators,r=e.length,i=0;i<r;i++)e[i].stop(t);return e.length=0,this},addAnimatorsToZr:function(t){if(this._animators)for(var e=0;e<this._animators.length;e++)t.animation.addAnimator(this._animators[e])},removeAnimatorsFromZr:function(t){if(this._animators)for(var e=0;e<this._animators.length;e++)t.animation.removeAnimator(this._animators[e])}}),S.import(Un),S.import(Q),S.import("\n@export ecgl.common.transformUniforms\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\n@end\n\n@export ecgl.common.attributes\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\n@end\n\n@export ecgl.common.uv.header\nuniform vec2 uvRepeat : [1.0, 1.0];\nuniform vec2 uvOffset : [0.0, 0.0];\nuniform vec2 detailUvRepeat : [1.0, 1.0];\nuniform vec2 detailUvOffset : [0.0, 0.0];\n\nvarying vec2 v_Texcoord;\nvarying vec2 v_DetailTexcoord;\n@end\n\n@export ecgl.common.uv.main\nv_Texcoord = texcoord * uvRepeat + uvOffset;\nv_DetailTexcoord = texcoord * detailUvRepeat + detailUvOffset;\n@end\n\n@export ecgl.common.uv.fragmentHeader\nvarying vec2 v_Texcoord;\nvarying vec2 v_DetailTexcoord;\n@end\n\n\n@export ecgl.common.albedo.main\n\n vec4 albedoTexel = vec4(1.0);\n#ifdef DIFFUSEMAP_ENABLED\n albedoTexel = texture2D(diffuseMap, v_Texcoord);\n #ifdef SRGB_DECODE\n albedoTexel = sRGBToLinear(albedoTexel);\n #endif\n#endif\n\n#ifdef DETAILMAP_ENABLED\n vec4 detailTexel = texture2D(detailMap, v_DetailTexcoord);\n #ifdef SRGB_DECODE\n detailTexel = sRGBToLinear(detailTexel);\n #endif\n albedoTexel.rgb = mix(albedoTexel.rgb, detailTexel.rgb, detailTexel.a);\n albedoTexel.a = detailTexel.a + (1.0 - detailTexel.a) * albedoTexel.a;\n#endif\n\n@end\n\n@export ecgl.common.wireframe.vertexHeader\n\n#ifdef WIREFRAME_QUAD\nattribute vec4 barycentric;\nvarying vec4 v_Barycentric;\n#elif defined(WIREFRAME_TRIANGLE)\nattribute vec3 barycentric;\nvarying vec3 v_Barycentric;\n#endif\n\n@end\n\n@export ecgl.common.wireframe.vertexMain\n\n#if defined(WIREFRAME_QUAD) || defined(WIREFRAME_TRIANGLE)\n v_Barycentric = barycentric;\n#endif\n\n@end\n\n\n@export ecgl.common.wireframe.fragmentHeader\n\nuniform float wireframeLineWidth : 1;\nuniform vec4 wireframeLineColor: [0, 0, 0, 0.5];\n\n#ifdef WIREFRAME_QUAD\nvarying vec4 v_Barycentric;\nfloat edgeFactor () {\n vec4 d = fwidth(v_Barycentric);\n vec4 a4 = smoothstep(vec4(0.0), d * wireframeLineWidth, v_Barycentric);\n return min(min(min(a4.x, a4.y), a4.z), a4.w);\n}\n#elif defined(WIREFRAME_TRIANGLE)\nvarying vec3 v_Barycentric;\nfloat edgeFactor () {\n vec3 d = fwidth(v_Barycentric);\n vec3 a3 = smoothstep(vec3(0.0), d * wireframeLineWidth, v_Barycentric);\n return min(min(a3.x, a3.y), a3.z);\n}\n#endif\n\n@end\n\n\n@export ecgl.common.wireframe.fragmentMain\n\n#if defined(WIREFRAME_QUAD) || defined(WIREFRAME_TRIANGLE)\n if (wireframeLineWidth > 0.) {\n vec4 lineColor = wireframeLineColor;\n#ifdef SRGB_DECODE\n lineColor = sRGBToLinear(lineColor);\n#endif\n\n gl_FragColor.rgb = mix(gl_FragColor.rgb, lineColor.rgb, (1.0 - edgeFactor()) * lineColor.a);\n }\n#endif\n@end\n\n\n\n\n@export ecgl.common.bumpMap.header\n\n#ifdef BUMPMAP_ENABLED\nuniform sampler2D bumpMap;\nuniform float bumpScale : 1.0;\n\n\nvec3 bumpNormal(vec3 surfPos, vec3 surfNormal, vec3 baseNormal)\n{\n vec2 dSTdx = dFdx(v_Texcoord);\n vec2 dSTdy = dFdy(v_Texcoord);\n\n float Hll = bumpScale * texture2D(bumpMap, v_Texcoord).x;\n float dHx = bumpScale * texture2D(bumpMap, v_Texcoord + dSTdx).x - Hll;\n float dHy = bumpScale * texture2D(bumpMap, v_Texcoord + dSTdy).x - Hll;\n\n vec3 vSigmaX = dFdx(surfPos);\n vec3 vSigmaY = dFdy(surfPos);\n vec3 vN = surfNormal;\n\n vec3 R1 = cross(vSigmaY, vN);\n vec3 R2 = cross(vN, vSigmaX);\n\n float fDet = dot(vSigmaX, R1);\n\n vec3 vGrad = sign(fDet) * (dHx * R1 + dHy * R2);\n return normalize(abs(fDet) * baseNormal - vGrad);\n\n}\n#endif\n\n@end\n\n@export ecgl.common.normalMap.vertexHeader\n\n#ifdef NORMALMAP_ENABLED\nattribute vec4 tangent : TANGENT;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n#endif\n\n@end\n\n@export ecgl.common.normalMap.vertexMain\n\n#ifdef NORMALMAP_ENABLED\n if (dot(tangent, tangent) > 0.0) {\n v_Tangent = normalize((worldInverseTranspose * vec4(tangent.xyz, 0.0)).xyz);\n v_Bitangent = normalize(cross(v_Normal, v_Tangent) * tangent.w);\n }\n#endif\n\n@end\n\n\n@export ecgl.common.normalMap.fragmentHeader\n\n#ifdef NORMALMAP_ENABLED\nuniform sampler2D normalMap;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n#endif\n\n@end\n\n@export ecgl.common.normalMap.fragmentMain\n#ifdef NORMALMAP_ENABLED\n if (dot(v_Tangent, v_Tangent) > 0.0) {\n vec3 normalTexel = texture2D(normalMap, v_DetailTexcoord).xyz;\n if (dot(normalTexel, normalTexel) > 0.0) { N = normalTexel * 2.0 - 1.0;\n mat3 tbn = mat3(v_Tangent, v_Bitangent, v_Normal);\n N = normalize(tbn * N);\n }\n }\n#endif\n@end\n\n\n\n@export ecgl.common.vertexAnimation.header\n\n#ifdef VERTEX_ANIMATION\nattribute vec3 prevPosition;\nattribute vec3 prevNormal;\nuniform float percent;\n#endif\n\n@end\n\n@export ecgl.common.vertexAnimation.main\n\n#ifdef VERTEX_ANIMATION\n vec3 pos = mix(prevPosition, position, percent);\n vec3 norm = mix(prevNormal, normal, percent);\n#else\n vec3 pos = position;\n vec3 norm = normal;\n#endif\n\n@end\n\n\n@export ecgl.common.ssaoMap.header\n#ifdef SSAOMAP_ENABLED\nuniform sampler2D ssaoMap;\nuniform vec4 viewport : VIEWPORT;\n#endif\n@end\n\n@export ecgl.common.ssaoMap.main\n float ao = 1.0;\n#ifdef SSAOMAP_ENABLED\n ao = texture2D(ssaoMap, (gl_FragCoord.xy - viewport.xy) / viewport.zw).r;\n#endif\n@end\n\n\n\n\n@export ecgl.common.diffuseLayer.header\n\n#if (LAYER_DIFFUSEMAP_COUNT > 0)\nuniform float layerDiffuseIntensity[LAYER_DIFFUSEMAP_COUNT];\nuniform sampler2D layerDiffuseMap[LAYER_DIFFUSEMAP_COUNT];\n#endif\n\n@end\n\n@export ecgl.common.emissiveLayer.header\n\n#if (LAYER_EMISSIVEMAP_COUNT > 0)\nuniform float layerEmissionIntensity[LAYER_EMISSIVEMAP_COUNT];\nuniform sampler2D layerEmissiveMap[LAYER_EMISSIVEMAP_COUNT];\n#endif\n\n@end\n\n@export ecgl.common.layers.header\n@import ecgl.common.diffuseLayer.header\n@import ecgl.common.emissiveLayer.header\n@end\n\n@export ecgl.common.diffuseLayer.main\n\n#if (LAYER_DIFFUSEMAP_COUNT > 0)\n for (int _idx_ = 0; _idx_ < LAYER_DIFFUSEMAP_COUNT; _idx_++) {{\n float intensity = layerDiffuseIntensity[_idx_];\n vec4 texel2 = texture2D(layerDiffuseMap[_idx_], v_Texcoord);\n #ifdef SRGB_DECODE\n texel2 = sRGBToLinear(texel2);\n #endif\n albedoTexel.rgb = mix(albedoTexel.rgb, texel2.rgb * intensity, texel2.a);\n albedoTexel.a = texel2.a + (1.0 - texel2.a) * albedoTexel.a;\n }}\n#endif\n\n@end\n\n@export ecgl.common.emissiveLayer.main\n\n#if (LAYER_EMISSIVEMAP_COUNT > 0)\n for (int _idx_ = 0; _idx_ < LAYER_EMISSIVEMAP_COUNT; _idx_++)\n {{\n vec4 texel2 = texture2D(layerEmissiveMap[_idx_], v_Texcoord) * layerEmissionIntensity[_idx_];\n #ifdef SRGB_DECODE\n texel2 = sRGBToLinear(texel2);\n #endif\n float intensity = layerEmissionIntensity[_idx_];\n gl_FragColor.rgb += texel2.rgb * texel2.a * intensity;\n }}\n#endif\n\n@end\n"),S.import("@export ecgl.color.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\n@import ecgl.common.uv.header\n\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 position: POSITION;\n\n@import ecgl.common.wireframe.vertexHeader\n\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n#endif\n\n#ifdef VERTEX_ANIMATION\nattribute vec3 prevPosition;\nuniform float percent : 1.0;\n#endif\n\n#ifdef ATMOSPHERE_ENABLED\nattribute vec3 normal: NORMAL;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nvarying vec3 v_Normal;\n#endif\n\nvoid main()\n{\n#ifdef VERTEX_ANIMATION\n vec3 pos = mix(prevPosition, position, percent);\n#else\n vec3 pos = position;\n#endif\n\n gl_Position = worldViewProjection * vec4(pos, 1.0);\n\n @import ecgl.common.uv.main\n\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n\n#ifdef ATMOSPHERE_ENABLED\n v_Normal = normalize((worldInverseTranspose * vec4(normal, 0.0)).xyz);\n#endif\n\n @import ecgl.common.wireframe.vertexMain\n\n}\n\n@end\n\n@export ecgl.color.fragment\n\n#define LAYER_DIFFUSEMAP_COUNT 0\n#define LAYER_EMISSIVEMAP_COUNT 0\n\nuniform sampler2D diffuseMap;\nuniform sampler2D detailMap;\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\n#ifdef ATMOSPHERE_ENABLED\nuniform mat4 viewTranspose: VIEWTRANSPOSE;\nuniform vec3 glowColor;\nuniform float glowPower;\nvarying vec3 v_Normal;\n#endif\n\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n\n@import ecgl.common.layers.header\n\n@import ecgl.common.uv.fragmentHeader\n\n@import ecgl.common.wireframe.fragmentHeader\n\n@import clay.util.srgb\n\nvoid main()\n{\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(color);\n#else\n gl_FragColor = color;\n#endif\n\n#ifdef VERTEX_COLOR\n gl_FragColor *= v_Color;\n#endif\n\n @import ecgl.common.albedo.main\n\n @import ecgl.common.diffuseLayer.main\n\n gl_FragColor *= albedoTexel;\n\n#ifdef ATMOSPHERE_ENABLED\n float atmoIntensity = pow(1.0 - dot(v_Normal, (viewTranspose * vec4(0.0, 0.0, 1.0, 0.0)).xyz), glowPower);\n gl_FragColor.rgb += glowColor * atmoIntensity;\n#endif\n\n @import ecgl.common.emissiveLayer.main\n\n @import ecgl.common.wireframe.fragmentMain\n\n}\n@end"),S.import("/**\n * http: */\n\n@export ecgl.lambert.vertex\n\n@import ecgl.common.transformUniforms\n\n@import ecgl.common.uv.header\n\n\n@import ecgl.common.attributes\n\n@import ecgl.common.wireframe.vertexHeader\n\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n#endif\n\n\n@import ecgl.common.vertexAnimation.header\n\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nvoid main()\n{\n @import ecgl.common.uv.main\n\n @import ecgl.common.vertexAnimation.main\n\n\n gl_Position = worldViewProjection * vec4(pos, 1.0);\n\n v_Normal = normalize((worldInverseTranspose * vec4(norm, 0.0)).xyz);\n v_WorldPosition = (world * vec4(pos, 1.0)).xyz;\n\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n\n @import ecgl.common.wireframe.vertexMain\n}\n\n@end\n\n\n@export ecgl.lambert.fragment\n\n#define LAYER_DIFFUSEMAP_COUNT 0\n#define LAYER_EMISSIVEMAP_COUNT 0\n\n#define NORMAL_UP_AXIS 1\n#define NORMAL_FRONT_AXIS 2\n\n@import ecgl.common.uv.fragmentHeader\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nuniform sampler2D diffuseMap;\nuniform sampler2D detailMap;\n\n@import ecgl.common.layers.header\n\nuniform float emissionIntensity: 1.0;\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nuniform mat4 viewInverse : VIEWINVERSE;\n\n#ifdef ATMOSPHERE_ENABLED\nuniform mat4 viewTranspose: VIEWTRANSPOSE;\nuniform vec3 glowColor;\nuniform float glowPower;\n#endif\n\n#ifdef AMBIENT_LIGHT_COUNT\n@import clay.header.ambient_light\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n@import clay.header.ambient_sh_light\n#endif\n\n#ifdef DIRECTIONAL_LIGHT_COUNT\n@import clay.header.directional_light\n#endif\n\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n\n\n@import ecgl.common.ssaoMap.header\n\n@import ecgl.common.bumpMap.header\n\n@import clay.util.srgb\n\n@import ecgl.common.wireframe.fragmentHeader\n\n@import clay.plugin.compute_shadow_map\n\nvoid main()\n{\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(color);\n#else\n gl_FragColor = color;\n#endif\n\n#ifdef VERTEX_COLOR\n #ifdef SRGB_DECODE\n gl_FragColor *= sRGBToLinear(v_Color);\n #else\n gl_FragColor *= v_Color;\n #endif\n#endif\n\n @import ecgl.common.albedo.main\n\n @import ecgl.common.diffuseLayer.main\n\n gl_FragColor *= albedoTexel;\n\n vec3 N = v_Normal;\n#ifdef DOUBLE_SIDED\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(eyePos - v_WorldPosition);\n\n if (dot(N, V) < 0.0) {\n N = -N;\n }\n#endif\n\n float ambientFactor = 1.0;\n\n#ifdef BUMPMAP_ENABLED\n N = bumpNormal(v_WorldPosition, v_Normal, N);\n ambientFactor = dot(v_Normal, N);\n#endif\n\n vec3 N2 = vec3(N.x, N[NORMAL_UP_AXIS], N[NORMAL_FRONT_AXIS]);\n\n vec3 diffuseColor = vec3(0.0, 0.0, 0.0);\n\n @import ecgl.common.ssaoMap.main\n\n#ifdef AMBIENT_LIGHT_COUNT\n for(int i = 0; i < AMBIENT_LIGHT_COUNT; i++)\n {\n diffuseColor += ambientLightColor[i] * ambientFactor * ao;\n }\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_SH_LIGHT_COUNT; _idx_++)\n {{\n diffuseColor += calcAmbientSHLight(_idx_, N2) * ambientSHLightColor[_idx_] * ao;\n }}\n#endif\n#ifdef DIRECTIONAL_LIGHT_COUNT\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsDir[DIRECTIONAL_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfDirectionalLights(v_WorldPosition, shadowContribsDir);\n }\n#endif\n for(int i = 0; i < DIRECTIONAL_LIGHT_COUNT; i++)\n {\n vec3 lightDirection = -directionalLightDirection[i];\n vec3 lightColor = directionalLightColor[i];\n\n float shadowContrib = 1.0;\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n if (shadowEnabled)\n {\n shadowContrib = shadowContribsDir[i];\n }\n#endif\n\n float ndl = dot(N, normalize(lightDirection)) * shadowContrib;\n\n diffuseColor += lightColor * clamp(ndl, 0.0, 1.0);\n }\n#endif\n\n gl_FragColor.rgb *= diffuseColor;\n\n#ifdef ATMOSPHERE_ENABLED\n float atmoIntensity = pow(1.0 - dot(v_Normal, (viewTranspose * vec4(0.0, 0.0, 1.0, 0.0)).xyz), glowPower);\n gl_FragColor.rgb += glowColor * atmoIntensity;\n#endif\n\n @import ecgl.common.emissiveLayer.main\n\n @import ecgl.common.wireframe.fragmentMain\n}\n\n@end"),S.import("@export ecgl.realistic.vertex\n\n@import ecgl.common.transformUniforms\n\n@import ecgl.common.uv.header\n\n@import ecgl.common.attributes\n\n\n@import ecgl.common.wireframe.vertexHeader\n\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n#endif\n\n#ifdef NORMALMAP_ENABLED\nattribute vec4 tangent : TANGENT;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n#endif\n\n@import ecgl.common.vertexAnimation.header\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nvoid main()\n{\n\n @import ecgl.common.uv.main\n\n @import ecgl.common.vertexAnimation.main\n\n gl_Position = worldViewProjection * vec4(pos, 1.0);\n\n v_Normal = normalize((worldInverseTranspose * vec4(norm, 0.0)).xyz);\n v_WorldPosition = (world * vec4(pos, 1.0)).xyz;\n\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n\n#ifdef NORMALMAP_ENABLED\n v_Tangent = normalize((worldInverseTranspose * vec4(tangent.xyz, 0.0)).xyz);\n v_Bitangent = normalize(cross(v_Normal, v_Tangent) * tangent.w);\n#endif\n\n @import ecgl.common.wireframe.vertexMain\n\n}\n\n@end\n\n\n\n@export ecgl.realistic.fragment\n\n#define LAYER_DIFFUSEMAP_COUNT 0\n#define LAYER_EMISSIVEMAP_COUNT 0\n#define PI 3.14159265358979\n#define ROUGHNESS_CHANEL 0\n#define METALNESS_CHANEL 1\n\n#define NORMAL_UP_AXIS 1\n#define NORMAL_FRONT_AXIS 2\n\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n\n@import ecgl.common.uv.fragmentHeader\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nuniform sampler2D diffuseMap;\n\nuniform sampler2D detailMap;\nuniform sampler2D metalnessMap;\nuniform sampler2D roughnessMap;\n\n@import ecgl.common.layers.header\n\nuniform float emissionIntensity: 1.0;\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nuniform float metalness : 0.0;\nuniform float roughness : 0.5;\n\nuniform mat4 viewInverse : VIEWINVERSE;\n\n#ifdef ATMOSPHERE_ENABLED\nuniform mat4 viewTranspose: VIEWTRANSPOSE;\nuniform vec3 glowColor;\nuniform float glowPower;\n#endif\n\n#ifdef AMBIENT_LIGHT_COUNT\n@import clay.header.ambient_light\n#endif\n\n#ifdef AMBIENT_SH_LIGHT_COUNT\n@import clay.header.ambient_sh_light\n#endif\n\n#ifdef AMBIENT_CUBEMAP_LIGHT_COUNT\n@import clay.header.ambient_cubemap_light\n#endif\n\n#ifdef DIRECTIONAL_LIGHT_COUNT\n@import clay.header.directional_light\n#endif\n\n@import ecgl.common.normalMap.fragmentHeader\n\n@import ecgl.common.ssaoMap.header\n\n@import ecgl.common.bumpMap.header\n\n@import clay.util.srgb\n\n@import clay.util.rgbm\n\n@import ecgl.common.wireframe.fragmentHeader\n\n@import clay.plugin.compute_shadow_map\n\nvec3 F_Schlick(float ndv, vec3 spec) {\n return spec + (1.0 - spec) * pow(1.0 - ndv, 5.0);\n}\n\nfloat D_Phong(float g, float ndh) {\n float a = pow(8192.0, g);\n return (a + 2.0) / 8.0 * pow(ndh, a);\n}\n\nvoid main()\n{\n vec4 albedoColor = color;\n\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(eyePos - v_WorldPosition);\n#ifdef VERTEX_COLOR\n #ifdef SRGB_DECODE\n albedoColor *= sRGBToLinear(v_Color);\n #else\n albedoColor *= v_Color;\n #endif\n#endif\n\n @import ecgl.common.albedo.main\n\n @import ecgl.common.diffuseLayer.main\n\n albedoColor *= albedoTexel;\n\n float m = metalness;\n\n#ifdef METALNESSMAP_ENABLED\n float m2 = texture2D(metalnessMap, v_DetailTexcoord)[METALNESS_CHANEL];\n m = clamp(m2 + (m - 0.5) * 2.0, 0.0, 1.0);\n#endif\n\n vec3 baseColor = albedoColor.rgb;\n albedoColor.rgb = baseColor * (1.0 - m);\n vec3 specFactor = mix(vec3(0.04), baseColor, m);\n\n float g = 1.0 - roughness;\n\n#ifdef ROUGHNESSMAP_ENABLED\n float g2 = 1.0 - texture2D(roughnessMap, v_DetailTexcoord)[ROUGHNESS_CHANEL];\n g = clamp(g2 + (g - 0.5) * 2.0, 0.0, 1.0);\n#endif\n\n vec3 N = v_Normal;\n\n#ifdef DOUBLE_SIDED\n if (dot(N, V) < 0.0) {\n N = -N;\n }\n#endif\n\n float ambientFactor = 1.0;\n\n#ifdef BUMPMAP_ENABLED\n N = bumpNormal(v_WorldPosition, v_Normal, N);\n ambientFactor = dot(v_Normal, N);\n#endif\n\n@import ecgl.common.normalMap.fragmentMain\n\n vec3 N2 = vec3(N.x, N[NORMAL_UP_AXIS], N[NORMAL_FRONT_AXIS]);\n\n vec3 diffuseTerm = vec3(0.0);\n vec3 specularTerm = vec3(0.0);\n\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n vec3 fresnelTerm = F_Schlick(ndv, specFactor);\n\n @import ecgl.common.ssaoMap.main\n\n#ifdef AMBIENT_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_LIGHT_COUNT; _idx_++)\n {{\n diffuseTerm += ambientLightColor[_idx_] * ambientFactor * ao;\n }}\n#endif\n\n#ifdef AMBIENT_SH_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_SH_LIGHT_COUNT; _idx_++)\n {{\n diffuseTerm += calcAmbientSHLight(_idx_, N2) * ambientSHLightColor[_idx_] * ao;\n }}\n#endif\n\n#ifdef DIRECTIONAL_LIGHT_COUNT\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsDir[DIRECTIONAL_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfDirectionalLights(v_WorldPosition, shadowContribsDir);\n }\n#endif\n for(int _idx_ = 0; _idx_ < DIRECTIONAL_LIGHT_COUNT; _idx_++)\n {{\n vec3 L = -directionalLightDirection[_idx_];\n vec3 lc = directionalLightColor[_idx_];\n\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, normalize(L)), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n\n float shadowContrib = 1.0;\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n if (shadowEnabled)\n {\n shadowContrib = shadowContribsDir[_idx_];\n }\n#endif\n\n vec3 li = lc * ndl * shadowContrib;\n\n diffuseTerm += li;\n specularTerm += li * fresnelTerm * D_Phong(g, ndh);\n }}\n#endif\n\n\n#ifdef AMBIENT_CUBEMAP_LIGHT_COUNT\n vec3 L = reflect(-V, N);\n L = vec3(L.x, L[NORMAL_UP_AXIS], L[NORMAL_FRONT_AXIS]);\n float rough2 = clamp(1.0 - g, 0.0, 1.0);\n float bias2 = rough2 * 5.0;\n vec2 brdfParam2 = texture2D(ambientCubemapLightBRDFLookup[0], vec2(rough2, ndv)).xy;\n vec3 envWeight2 = specFactor * brdfParam2.x + brdfParam2.y;\n vec3 envTexel2;\n for(int _idx_ = 0; _idx_ < AMBIENT_CUBEMAP_LIGHT_COUNT; _idx_++)\n {{\n envTexel2 = RGBMDecode(textureCubeLodEXT(ambientCubemapLightCubemap[_idx_], L, bias2), 8.12);\n specularTerm += ambientCubemapLightColor[_idx_] * envTexel2 * envWeight2 * ao;\n }}\n#endif\n\n gl_FragColor.rgb = albedoColor.rgb * diffuseTerm + specularTerm;\n gl_FragColor.a = albedoColor.a;\n\n#ifdef ATMOSPHERE_ENABLED\n float atmoIntensity = pow(1.0 - dot(v_Normal, (viewTranspose * vec4(0.0, 0.0, 1.0, 0.0)).xyz), glowPower);\n gl_FragColor.rgb += glowColor * atmoIntensity;\n#endif\n\n#ifdef SRGB_ENCODE\n gl_FragColor = linearTosRGB(gl_FragColor);\n#endif\n\n @import ecgl.common.emissiveLayer.main\n\n @import ecgl.common.wireframe.fragmentMain\n}\n\n@end"),S.import("@export ecgl.hatching.vertex\n\n@import ecgl.realistic.vertex\n\n@end\n\n\n@export ecgl.hatching.fragment\n\n#define NORMAL_UP_AXIS 1\n#define NORMAL_FRONT_AXIS 2\n\n@import ecgl.common.uv.fragmentHeader\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nuniform vec4 color : [0.0, 0.0, 0.0, 1.0];\nuniform vec4 paperColor : [1.0, 1.0, 1.0, 1.0];\n\nuniform mat4 viewInverse : VIEWINVERSE;\n\n#ifdef AMBIENT_LIGHT_COUNT\n@import clay.header.ambient_light\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n@import clay.header.ambient_sh_light\n#endif\n\n#ifdef DIRECTIONAL_LIGHT_COUNT\n@import clay.header.directional_light\n#endif\n\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n\n\n@import ecgl.common.ssaoMap.header\n\n@import ecgl.common.bumpMap.header\n\n@import clay.util.srgb\n\n@import ecgl.common.wireframe.fragmentHeader\n\n@import clay.plugin.compute_shadow_map\n\nuniform sampler2D hatch1;\nuniform sampler2D hatch2;\nuniform sampler2D hatch3;\nuniform sampler2D hatch4;\nuniform sampler2D hatch5;\nuniform sampler2D hatch6;\n\nfloat shade(in float tone) {\n vec4 c = vec4(1. ,1., 1., 1.);\n float step = 1. / 6.;\n vec2 uv = v_DetailTexcoord;\n if (tone <= step / 2.0) {\n c = mix(vec4(0.), texture2D(hatch6, uv), 12. * tone);\n }\n else if (tone <= step) {\n c = mix(texture2D(hatch6, uv), texture2D(hatch5, uv), 6. * tone);\n }\n if(tone > step && tone <= 2. * step){\n c = mix(texture2D(hatch5, uv), texture2D(hatch4, uv) , 6. * (tone - step));\n }\n if(tone > 2. * step && tone <= 3. * step){\n c = mix(texture2D(hatch4, uv), texture2D(hatch3, uv), 6. * (tone - 2. * step));\n }\n if(tone > 3. * step && tone <= 4. * step){\n c = mix(texture2D(hatch3, uv), texture2D(hatch2, uv), 6. * (tone - 3. * step));\n }\n if(tone > 4. * step && tone <= 5. * step){\n c = mix(texture2D(hatch2, uv), texture2D(hatch1, uv), 6. * (tone - 4. * step));\n }\n if(tone > 5. * step){\n c = mix(texture2D(hatch1, uv), vec4(1.), 6. * (tone - 5. * step));\n }\n\n return c.r;\n}\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n#ifdef SRGB_DECODE\n vec4 inkColor = sRGBToLinear(color);\n#else\n vec4 inkColor = color;\n#endif\n\n#ifdef VERTEX_COLOR\n #ifdef SRGB_DECODE\n inkColor *= sRGBToLinear(v_Color);\n #else\n inkColor *= v_Color;\n #endif\n#endif\n\n vec3 N = v_Normal;\n#ifdef DOUBLE_SIDED\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(eyePos - v_WorldPosition);\n\n if (dot(N, V) < 0.0) {\n N = -N;\n }\n#endif\n\n float tone = 0.0;\n\n float ambientFactor = 1.0;\n\n#ifdef BUMPMAP_ENABLED\n N = bumpNormal(v_WorldPosition, v_Normal, N);\n ambientFactor = dot(v_Normal, N);\n#endif\n\n vec3 N2 = vec3(N.x, N[NORMAL_UP_AXIS], N[NORMAL_FRONT_AXIS]);\n\n @import ecgl.common.ssaoMap.main\n\n#ifdef AMBIENT_LIGHT_COUNT\n for(int i = 0; i < AMBIENT_LIGHT_COUNT; i++)\n {\n tone += dot(ambientLightColor[i], w) * ambientFactor * ao;\n }\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_SH_LIGHT_COUNT; _idx_++)\n {{\n tone += dot(calcAmbientSHLight(_idx_, N2) * ambientSHLightColor[_idx_], w) * ao;\n }}\n#endif\n#ifdef DIRECTIONAL_LIGHT_COUNT\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsDir[DIRECTIONAL_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfDirectionalLights(v_WorldPosition, shadowContribsDir);\n }\n#endif\n for(int i = 0; i < DIRECTIONAL_LIGHT_COUNT; i++)\n {\n vec3 lightDirection = -directionalLightDirection[i];\n float lightTone = dot(directionalLightColor[i], w);\n\n float shadowContrib = 1.0;\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n if (shadowEnabled)\n {\n shadowContrib = shadowContribsDir[i];\n }\n#endif\n\n float ndl = dot(N, normalize(lightDirection)) * shadowContrib;\n\n tone += lightTone * clamp(ndl, 0.0, 1.0);\n }\n#endif\n\n gl_FragColor = mix(inkColor, paperColor, shade(clamp(tone, 0.0, 1.0)));\n }\n@end\n"),S.import("@export ecgl.sm.depth.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n\n#ifdef VERTEX_ANIMATION\nattribute vec3 prevPosition;\nuniform float percent : 1.0;\n#endif\n\nvarying vec4 v_ViewPosition;\nvarying vec2 v_Texcoord;\n\nvoid main(){\n\n#ifdef VERTEX_ANIMATION\n vec3 pos = mix(prevPosition, position, percent);\n#else\n vec3 pos = position;\n#endif\n\n v_ViewPosition = worldViewProjection * vec4(pos, 1.0);\n gl_Position = v_ViewPosition;\n\n v_Texcoord = texcoord;\n\n}\n@end\n\n\n\n@export ecgl.sm.depth.fragment\n\n@import clay.sm.depth.fragment\n\n@end");var Go=$r.prototype.addToScene,Ho=$r.prototype.removeFromScene,v=($r.prototype.addToScene=function(t){var e;Go.call(this,t),this.__zr&&(e=this.__zr,t.traverse(function(t){t.__zr=e,t.addAnimatorsToZr&&t.addAnimatorsToZr(e)}))},$r.prototype.removeFromScene=function(t){Ho.call(this,t),t.traverse(function(t){var e=t.__zr;t.__zr=null,e&&t.removeAnimatorsFromZr&&t.removeAnimatorsFromZr(e)})},Tt.prototype.setTextureImage=function(e,t,r,i){var n,o,a,s;if(this.shader)return n=r.getZr(),(o=this).autoUpdateTextureStatus=!1,o.disableTexture(e),(s=t)&&"none"!==s&&(a=v.loadTexture(t,r,i,function(t){o.enableTexture(e),n&&n.refresh()}),o.set(e,a)),a},{}),Vo=(v.Renderer=de,v.Node=rr,v.Mesh=mr,v.Shader=S,v.Material=Tt,v.Texture=B,v.Texture2D=F,v.Geometry=p,v.SphereGeometry=Ar,v.PlaneGeometry=wi,v.CubeGeometry=Mi,v.AmbientLight=e,v.DirectionalLight=d,v.PointLight=t,v.SpotLight=g,v.PerspectiveCamera=hi,v.OrthographicCamera=Qi,v.Vector2=Et,v.Vector3=C,v.Vector4=m,v.Quaternion=Be,v.Matrix2=un,v.Matrix2d=y,v.Matrix3=gn,v.Matrix4=M,v.Plane=Ir,v.Ray=we,v.BoundingBox=je,v.Frustum=Vr,null);function Wo(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}function Xo(t){var e,r,i;t.wrapS!==B.REPEAT&&t.wrapT!==B.REPEAT||!t.image||(e=Wo(t.width),r=Wo(t.height),e===t.width&&r===t.height)||((i=document.createElement("canvas")).width=e,i.height=r,i.getContext("2d").drawImage(t.image,0,0,e,r),t.image=i)}v.loadTexture=function(t,e,r,i){"function"==typeof r&&(i=r,r={}),r=r||{};for(var n=Object.keys(r).sort(),o="",a=0;a<n.length;a++)o+=n[a]+"_"+r[n[a]]+"_";var s=e.__textureCache=e.__textureCache||new ni(20);if((h=t).getZr&&h.setOption){var l=t.__textureid__;if(u=s.get(o+l))u.texture.surface.setECharts(t);else{var h=new Ki(t);h.onupdate=function(){e.getZr().refresh()},u={texture:h.getTexture()};for(a=0;a<n.length;a++)u.texture[n[a]]=r[n[a]];l=t.__textureid__||"__ecgl_ec__"+u.texture.__uid__,t.__textureid__=l,s.put(o+l,u)}i&&i(u.texture)}else if(ko(t)){var u,l=t.__textureid__;if(!(u=s.get(o+l))){u={texture:new v.Texture2D({image:t})};for(a=0;a<n.length;a++)u.texture[n[a]]=r[n[a]];l=t.__textureid__||"__ecgl_image__"+u.texture.__uid__,t.__textureid__=l,s.put(o+l,u),Xo(u.texture),i&&i(u.texture)}}else if(u=s.get(o+t))u.callbacks?u.callbacks.push(i):i&&i(u.texture);else{if(t.match(/.hdr$|^data:application\/octet-stream/)){u={callbacks:[i]};var c=zi.loadTexture(t,{exposure:r.exposure,fileType:"hdr"},function(){c.dirty(),u.callbacks.forEach(function(t){t&&t(c)}),u.callbacks=null});u.texture=c}else{for(c=new v.Texture2D({image:new Image}),a=0;a<n.length;a++)c[n[a]]=r[n[a]];u={texture:c,callbacks:[i]};var d=c.image;d.onload=function(){c.image=d,Xo(c),c.dirty(),u.callbacks.forEach(function(t){t&&t(c)}),u.callbacks=null},d.crossOrigin="Anonymous",d.src=t,c.image=Vo=null===Vo?zi.createBlank("rgba(255,255,255,0)").image:Vo}s.put(o+t,u)}return u.texture},v.createAmbientCubemap=function(t,e,r,i){var n=(t=t||{}).texture,o=A.firstNotNull(t.exposure,1),a=new on({intensity:A.firstNotNull(t.specularIntensity,1)}),s=new an({intensity:A.firstNotNull(t.diffuseIntensity,1),coefficients:[.844,.712,.691,-.037,.083,.167,.343,.288,.299,-.041,-.021,-.009,-.003,-.041,-.064,-.011,-.007,-.004,-.031,.034,.081,-.06,-.049,-.06,.046,.056,.05]});return a.cubemap=v.loadTexture(n,r,{exposure:o},function(){a.cubemap.flipY=!1;var t=Date.now(),t=(a.prefilter(e,32),Date.now()-t);console.log("Prefilter environment map: "+t+"ms"),s.coefficients=hn.projectEnvironmentMap(e,a.cubemap,{lod:1}),i&&i()}),{specular:a,diffuse:s}},v.createBlankTexture=zi.createBlank,v.isImage=ko,v.additiveBlend=function(t){t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE)},v.parseColor=function(t,e){return t instanceof Array?((e=e||[])[0]=t[0],e[1]=t[1],e[2]=t[2],3<t.length?e[3]=t[3]:e[3]=1):((e=O.color.parse(t||"#000",e)||[0,0,0,0])[0]/=255,e[1]/=255,e[2]/=255),e},v.directionFromAlphaBeta=function(t,e){var t=t/180*Math.PI+Math.PI/2,e=-e/180*Math.PI+Math.PI/2,r=[],i=Math.sin(t);return r[0]=i*Math.cos(e),r[1]=-Math.cos(t),r[2]=i*Math.sin(e),r},v.getShadowResolution=function(t){var e=1024;switch(t){case"low":e=512;break;case"medium":break;case"high":e=2048;break;case"ultra":e=4096}return e},v.COMMON_SHADERS=["lambert","color","realistic","hatching","shadow"],v.createShader=function(t){"ecgl.shadow"===t&&(t="ecgl.displayShadow");var e=S.source(t+".vertex"),r=S.source(t+".fragment"),e=(e||console.error("Vertex shader of '%s' not exits",t),r||console.error("Fragment shader of '%s' not exits",t),new S(e,r));return e.name=t,e},v.createMaterial=function(t,e){e instanceof Array||(e=[e]);var t=v.createShader(t),r=new Tt({shader:t});return e.forEach(function(t){"string"==typeof t&&r.define(t)}),r},v.setMaterialFromModel=function(t,e,r,i){e.autoUpdateTextureStatus=!1;var r=r.getModel(t+"Material"),n=r.get("detailTexture"),o=A.firstNotNull(r.get("textureTiling"),1),a=A.firstNotNull(r.get("textureOffset"),0),s=("number"==typeof a&&(a=[a,a]),1<(o="number"==typeof o?[o,o]:o)[0]||1<o[1]?v.Texture.REPEAT:v.Texture.CLAMP_TO_EDGE),s={anisotropic:8,wrapS:s,wrapT:s};if("realistic"===t){var l=r.get("roughness"),h=r.get("metalness"),u=(null!=h?isNaN(h)&&(e.setTextureImage("metalnessMap",h,i,s),h=A.firstNotNull(r.get("metalnessAdjust"),.5)):h=0,null!=l?isNaN(l)&&(e.setTextureImage("roughnessMap",l,i,s),l=A.firstNotNull(r.get("roughnessAdjust"),.5)):l=.5,r.get("normalTexture"));e.setTextureImage("detailMap",n,i,s),e.setTextureImage("normalMap",u,i,s),e.set({roughness:l,metalness:h,detailUvRepeat:o,detailUvOffset:a})}else if("lambert"===t)e.setTextureImage("detailMap",n,i,s),e.set({detailUvRepeat:o,detailUvOffset:a});else if("color"===t)e.setTextureImage("detailMap",n,i,s),e.set({detailUvRepeat:o,detailUvOffset:a});else if("hatching"===t){var c=r.get("hatchingTextures")||[];c.length<6&&console.error("Invalid hatchingTextures.");for(var d=0;d<6;d++)e.setTextureImage("hatch"+(d+1),c[d],i,{anisotropic:8,wrapS:v.Texture.REPEAT,wrapT:v.Texture.REPEAT});e.set({detailUvRepeat:o,detailUvOffset:a})}},v.updateVertexAnimation=function(t,e,r,i){var n=i.get("animation"),o=i.get("animationDurationUpdate"),i=i.get("animationEasingUpdate"),a=r.shadowDepthMaterial;if(n&&e&&0<o&&e.geometry.vertexCount===r.geometry.vertexCount){r.material.define("vertex","VERTEX_ANIMATION"),r.ignorePreZ=!0,a&&a.define("vertex","VERTEX_ANIMATION");for(var s=0;s<t.length;s++)r.geometry.attributes[t[s][0]].value=e.geometry.attributes[t[s][1]].value;r.geometry.dirty(),r.__percent=0,r.material.set("percent",0),r.stopAnimation(),r.animate().when(o,{__percent:1}).during(function(){r.material.set("percent",r.__percent),a&&a.set("percent",r.__percent)}).done(function(){r.ignorePreZ=!1,r.material.undefine("vertex","VERTEX_ANIMATION"),a&&a.undefine("vertex","VERTEX_ANIMATION")}).start(i)}else r.material.undefine("vertex","VERTEX_ANIMATION"),a&&a.undefine("vertex","VERTEX_ANIMATION")};const q=v,jo="undefined"!=typeof window&&(window.requestAnimationFrame&&window.requestAnimationFrame.bind(window)||window.msRequestAnimationFrame&&window.msRequestAnimationFrame.bind(window)||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(t){return setTimeout(t,16)};function qo(t,e){this.id=t,this.zr=e;try{this.renderer=new de({clearBit:0,devicePixelRatio:e.painter.dpr,preserveDrawingBuffer:!0,premultipliedAlpha:!0}),this.renderer.resize(e.painter.getWidth(),e.painter.getHeight())}catch(t){return this.renderer=null,this.dom=document.createElement("div"),this.dom.style.cssText="position:absolute; left: 0; top: 0; right: 0; bottom: 0;",this.dom.className="ecgl-nowebgl",this.dom.innerHTML="Sorry, your browser does not support WebGL",void console.error(t)}this.onglobalout=this.onglobalout.bind(this),e.on("globalout",this.onglobalout),this.dom=this.renderer.canvas,(t=this.dom.style).position="absolute",t.left="0",t.top="0",this.views=[],this._picking=new cr({renderer:this.renderer}),this._viewsToDispose=[],this._accumulatingId=0,this._zrEventProxy=new O.graphic.Rect({shape:{x:-1,y:-1,width:2,height:2},__isGLToZRProxy:!0}),this._backgroundColor=null,this._disposed=!1}function Zo(t){var e=t.__zr;t.__zr=null,e&&t.removeAnimatorsFromZr&&t.removeAnimatorsFromZr(e)}qo.prototype.setUnpainted=function(){},qo.prototype.addView=function(t){var e,r;t.layer!==this&&(0<=(e=this._viewsToDispose.indexOf(t))&&this._viewsToDispose.splice(e,1),this.views.push(t),r=(t.layer=this).zr,t.scene.traverse(function(t){t.__zr=r,t.addAnimatorsToZr&&t.addAnimatorsToZr(r)}))},qo.prototype.removeView=function(t){var e;t.layer===this&&0<=(e=this.views.indexOf(t))&&(this.views.splice(e,1),t.scene.traverse(Zo,this),t.layer=null,this._viewsToDispose.push(t))},qo.prototype.removeViewsAll=function(){this.views.forEach(function(t){t.scene.traverse(Zo,this),t.layer=null,this._viewsToDispose.push(t)},this),this.views.length=0},qo.prototype.resize=function(t,e){this.renderer.resize(t,e)},qo.prototype.clear=function(){var t=this.renderer.gl,e=this._backgroundColor||[0,0,0,0];t.clearColor(e[0],e[1],e[2],e[3]),t.depthMask(!0),t.colorMask(!0,!0,!0,!0),t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT)},qo.prototype.clearDepth=function(){var t=this.renderer.gl;t.clear(t.DEPTH_BUFFER_BIT)},qo.prototype.clearColor=function(){var t=this.renderer.gl;t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)},qo.prototype.needsRefresh=function(){this.zr.refresh()},qo.prototype.refresh=function(t){this._backgroundColor=t?q.parseColor(t):[0,0,0,0],this.renderer.clearColor=this._backgroundColor;for(var e=0;e<this.views.length;e++)this.views[e].prepareRender(this.renderer);this._doRender(!1),this._trackAndClean();for(e=0;e<this._viewsToDispose.length;e++)this._viewsToDispose[e].dispose(this.renderer);this._viewsToDispose.length=0,this._startAccumulating()},qo.prototype.renderToCanvas=function(t){this._startAccumulating(!0),t.drawImage(this.dom,0,0,t.canvas.width,t.canvas.height)},qo.prototype._doRender=function(t){this.clear(),this.renderer.saveViewport();for(var e=0;e<this.views.length;e++)this.views[e].render(this.renderer,t);this.renderer.restoreViewport()},qo.prototype._stopAccumulating=function(){this._accumulatingId=0,clearTimeout(this._accumulatingTimeout)};var Yo=1;function Ko(t){for(var e=0;e<t.length;e++)t[e].__used__=0}function Qo(t,e){for(var r=0;r<e.length;r++)e[r].__used__||e[r].dispose(t)}function Jo(t,e){t.__used__=t.__used__||0,t.__used__++,1===t.__used__&&e.push(t)}qo.prototype._startAccumulating=function(i){for(var n=this,o=(this._stopAccumulating(),!1),t=0;t<this.views.length;t++)o=this.views[t].needsAccumulate()||o;function a(t){if(n._accumulatingId&&t===n._accumulatingId){for(var e=!0,r=0;r<n.views.length;r++)e=n.views[r].isAccumulateFinished()&&o;e||(n._doRender(!0),i?a(t):jo(function(){a(t)}))}}o&&(this._accumulatingId=Yo++,i?a(n._accumulatingId):this._accumulatingTimeout=setTimeout(function(){a(n._accumulatingId)},50))},qo.prototype._trackAndClean=function(){var t=[],e=[];this._textureList&&(Ko(this._textureList),Ko(this._geometriesList));for(var r=0;r<this.views.length;r++)!function(t,l,h){var u,c;t.traverse(function(t){if(t.isRenderable()){var e=t.geometry,r=t.material;if(r!==u)for(var i=r.getTextureUniforms(),n=0;n<i.length;n++){var o=i[n],a=r.uniforms[o].value;if(a)if(a instanceof B)Jo(a,l);else if(a instanceof Array)for(var s=0;s<a.length;s++)a[s]instanceof B&&Jo(a[s],l)}e!==c&&Jo(e,h),u=r,c=e}});for(var e=0;e<t.lights.length;e++)t.lights[e].cubemap&&Jo(t.lights[e].cubemap,l)}(this.views[r].scene,t,e);this._textureList&&(Qo(this.renderer,this._textureList),Qo(this.renderer,this._geometriesList)),this._textureList=t,this._geometriesList=e},qo.prototype.dispose=function(){this._disposed||(this._stopAccumulating(),this._textureList&&(Ko(this._textureList),Ko(this._geometriesList),Qo(this.renderer,this._textureList),Qo(this.renderer,this._geometriesList)),this.zr.off("globalout",this.onglobalout),this._disposed=!0)},qo.prototype.onmousedown=function(t){var e;t.target&&t.target.__isGLToZRProxy||(t=t.event,(e=this.pickObject(t.offsetX,t.offsetY))&&(this._dispatchEvent("mousedown",t,e),this._dispatchDataEvent("mousedown",t,e)),this._downX=t.offsetX,this._downY=t.offsetY)},qo.prototype.onmousemove=function(t){var e,r,i;t.target&&t.target.__isGLToZRProxy||(t=t.event,r=(e=this.pickObject(t.offsetX,t.offsetY))&&e.target,i=this._hovered,this._hovered=e,i&&r!==i.target&&(i.relatedTarget=r,this._dispatchEvent("mouseout",t,i),this.zr.setCursorStyle("default")),this._dispatchEvent("mousemove",t,e),e&&(this.zr.setCursorStyle("pointer"),i&&r===i.target||this._dispatchEvent("mouseover",t,e)),this._dispatchDataEvent("mousemove",t,e))},qo.prototype.onmouseup=function(t){var e;t.target&&t.target.__isGLToZRProxy||(t=t.event,(e=this.pickObject(t.offsetX,t.offsetY))&&(this._dispatchEvent("mouseup",t,e),this._dispatchDataEvent("mouseup",t,e)),this._upX=t.offsetX,this._upY=t.offsetY)},qo.prototype.onclick=qo.prototype.dblclick=function(t){var e,r;t.target&&t.target.__isGLToZRProxy||(e=this._upX-this._downX,r=this._upY-this._downY,20<Math.sqrt(e*e+r*r))||(t=t.event,(e=this.pickObject(t.offsetX,t.offsetY))&&(this._dispatchEvent(t.type,t,e),this._dispatchDataEvent(t.type,t,e)),(r=this._clickToSetFocusPoint(t))&&r.view.setDOFFocusOnPoint(r.distance)&&this.zr.refresh())},qo.prototype._clickToSetFocusPoint=function(t){for(var e=this.renderer,r=e.viewport,i=this.views.length-1;0<=i;i--){var n=this.views[i];if(n.hasDOF()&&n.containPoint(t.offsetX,t.offsetY)){this._picking.scene=n.scene,this._picking.camera=n.camera,e.viewport=n.viewport;var o=this._picking.pick(t.offsetX,t.offsetY,!0);if(o)return o.view=n,o}}e.viewport=r},qo.prototype.onglobalout=function(t){var e=this._hovered;e&&this._dispatchEvent("mouseout",t,{target:e.target})},qo.prototype.pickObject=function(t,e){for(var r=[],i=this.renderer,n=i.viewport,o=0;o<this.views.length;o++){var a=this.views[o];a.containPoint(t,e)&&(this._picking.scene=a.scene,this._picking.camera=a.camera,i.viewport=a.viewport,this._picking.pickAll(t,e,r))}return i.viewport=n,r.sort(function(t,e){return t.distance-e.distance}),r[0]},qo.prototype._dispatchEvent=function(t,e,r){var i=(r=r||{}).target;for(r.cancelBubble=!1,r.event=e,r.type=t,r.offsetX=e.offsetX,r.offsetY=e.offsetY;i&&(i.trigger(t,r),i=i.getParent(),!r.cancelBubble););this._dispatchToView(t,r)},qo.prototype._dispatchDataEvent=function(t,e,r){var r=r&&r.target,i=r&&r.dataIndex,n=r&&r.seriesIndex,r=r&&r.eventData,o=!1,a=this._zrEventProxy,s=(a.x=e.offsetX,a.y=e.offsetY,a.update(),{target:a}),a=O.helper.getECData(a);"mousemove"===t&&(null!=i?i!==this._lastDataIndex&&(0<=parseInt(this._lastDataIndex,10)&&(a.dataIndex=this._lastDataIndex,a.seriesIndex=this._lastSeriesIndex,this.zr.handler.dispatchToElement(s,"mouseout",e)),o=!0):null!=r&&r!==this._lastEventData&&(null!=this._lastEventData&&(a.eventData=this._lastEventData,this.zr.handler.dispatchToElement(s,"mouseout",e)),o=!0),this._lastEventData=r,this._lastDataIndex=i,this._lastSeriesIndex=n),a.eventData=r,a.dataIndex=i,a.seriesIndex=n,(null!=r||0<=parseInt(i,10)&&0<=parseInt(n,10))&&(this.zr.handler.dispatchToElement(s,t,e),o)&&this.zr.handler.dispatchToElement(s,"mouseover",e)},qo.prototype._dispatchToView=function(t,e){for(var r=0;r<this.views.length;r++)this.views[r].containPoint(e.offsetX,e.offsetY)&&this.views[r].trigger(t,e)},Object.assign(qo.prototype,U);const $o=qo;var ta=["bar3D","line3D","map3D","scatter3D","surface","lines3D","scatterGL","scatter3D"];function ea(t,e){var r,i;t&&t[e]&&(t[e].normal||t[e].emphasis)&&(r=t[e].normal,i=t[e].emphasis,r&&(t[e]=r),i)&&(t.emphasis=t.emphasis||{},t.emphasis[e]=i)}function ra(t){t&&(t instanceof Array||(t=[t]),O.util.each(t,function(t){t.axisLabel&&(t=t.axisLabel,Object.assign(t,t.textStyle),t.textStyle=null)}))}function ia(t){this._layers={},this._zr=t}ia.prototype.update=function(n,o){var i=this,a=o.getZr();if(a.getWidth()&&a.getHeight()){for(var t in this._layers)this._layers[t].removeViewsAll();n.eachComponent(function(t,e){if("series"!==t){var t=o.getViewOfComponentModel(e),r=e.coordinateSystem;if(t.__ecgl__){if(r){if(!r.viewGL)return void console.error("Can't find viewGL in coordinateSystem of component "+e.id)}else if(!e.viewGL)return void console.error("Can't find viewGL of component "+e.id);i=r.viewGL;var i=r.viewGL,r=s(e);r.addView(i),t.afterRender&&t.afterRender(e,n,o,r),l(t.groupGL,e.get("silent"))}}}),n.eachSeries(function(t){var e,r=o.getViewOfSeriesModel(t),i=t.coordinateSystem;r.__ecgl__&&(!i||i.viewGL||r.viewGL?(i=i&&i.viewGL||r.viewGL,(e=s(t)).addView(i),r.afterRender&&r.afterRender(t,n,o,e),l(r.groupGL,t.get("silent"))):console.error("Can't find viewGL of series "+r.id))})}else console.warn("Dom has no width or height");function s(t){a.setSleepAfterStill(0),t=(t.coordinateSystem&&t.coordinateSystem.model,t.get("zlevel"));var e=i._layers,r=e[t];return r||(r=e[t]=new $o("gl-"+t,a),a.painter.isSingleCanvas()&&(r.virtual=!0,e=new O.graphic.Image({z:1e4,style:{image:r.renderer.canvas},silent:!0}),r.__hostImage=e,a.add(e)),a.painter.insertLayer(t,r)),r.__hostImage&&r.__hostImage.setStyle({width:r.renderer.getWidth(),height:r.renderer.getHeight()}),r}function l(t,e){t&&t.traverse(function(t){t.isRenderable&&t.isRenderable()&&(t.ignorePicking=null!=t.$ignorePicking?t.$ignorePicking:e)})}},O.registerPostInit(function(t){var t=t.getZr(),e=t.painter.dispose;t.painter.dispose=function(){"function"==typeof this.eachOtherLayer&&this.eachOtherLayer(function(t){t instanceof $o&&t.dispose()}),e.call(this)},t.painter.getRenderedCanvas=function(t){if(t=t||{},this._singleCanvas)return this._layers[0].dom;var e,r=document.createElement("canvas"),i=t.pixelRatio||this.dpr,s=(r.width=this.getWidth()*i,r.height=this.getHeight()*i,r.getContext("2d")),n=(s.dpr=i,s.clearRect(0,0,r.width,r.height),t.backgroundColor&&(s.fillStyle=t.backgroundColor,s.fillRect(0,0,r.width,r.height)),this.storage.getDisplayList(!0)),o={},l=this;function a(t,e){var r,i=l._zlevelList;null==t&&(t=-1/0);for(var n=0;n<i.length;n++){var o=i[n],a=l._layers[o];if(!a.__builtin__&&t<o&&o<e){r=a;break}}r&&r.renderToCanvas&&(s.save(),r.renderToCanvas(s),s.restore())}for(var h={ctx:s},u=0;u<n.length;u++){var c=n[u];c.zlevel!==e&&(a(e,c.zlevel),e=c.zlevel),this._doPaintEl(c,h,!0,null,o)}return a(e,1/0),r}}),O.registerPostUpdate(function(t,e){var r=e.getZr();(r.__egl=r.__egl||new ia(r)).update(t,e)}),O.registerPreprocessor(function(r){O.util.each(r.series,function(t){var e;0<=O.util.indexOf(ta,t.type)&&(ea(e=t,"itemStyle"),ea(e,"lineStyle"),ea(e,"areaStyle"),ea(e,"label"),"mapbox"===t.coordinateSystem)&&(t.coordinateSystem="mapbox3D",r.mapbox3D=r.mapbox)}),ra(r.xAxis3D),ra(r.yAxis3D),ra(r.zAxis3D),ra(r.grid3D),ea(r.geo3D)});Q={defaultOption:{viewControl:{projection:"perspective",autoRotate:!1,autoRotateDirection:"cw",autoRotateSpeed:10,autoRotateAfterStill:3,damping:.8,rotateSensitivity:1,zoomSensitivity:1,panSensitivity:1,panMouseButton:"middle",rotateMouseButton:"left",distance:150,minDistance:40,maxDistance:400,orthographicSize:150,maxOrthographicSize:400,minOrthographicSize:20,center:[0,0,0],alpha:0,beta:0,minAlpha:-90,maxAlpha:90}},setView:function(t){t=t||{},this.option.viewControl=this.option.viewControl||{},null!=t.alpha&&(this.option.viewControl.alpha=t.alpha),null!=t.beta&&(this.option.viewControl.beta=t.beta),null!=t.distance&&(this.option.viewControl.distance=t.distance),null!=t.center&&(this.option.viewControl.center=t.center)}},Ar={defaultOption:{postEffect:{enable:!1,bloom:{enable:!0,intensity:.1},depthOfField:{enable:!1,focalRange:20,focalDistance:50,blurRadius:10,fstop:2.8,quality:"medium"},screenSpaceAmbientOcclusion:{enable:!1,radius:2,quality:"medium",intensity:1},screenSpaceReflection:{enable:!1,quality:"medium",maxRoughness:.8},colorCorrection:{enable:!0,exposure:0,brightness:0,contrast:1,saturation:1,lookupTexture:""},edge:{enable:!1},FXAA:{enable:!1}},temporalSuperSampling:{enable:"auto"}}},e={defaultOption:{light:{main:{shadow:!1,shadowQuality:"high",color:"#fff",intensity:1,alpha:0,beta:0},ambient:{color:"#fff",intensity:.2},ambientCubemap:{texture:null,exposure:1,diffuseIntensity:.5,specularIntensity:.5}}}},d=O.ComponentModel.extend({type:"grid3D",dependencies:["xAxis3D","yAxis3D","zAxis3D"],defaultOption:{show:!0,zlevel:-10,left:0,top:0,width:"100%",height:"100%",environment:"auto",boxWidth:100,boxHeight:100,boxDepth:100,axisPointer:{show:!0,lineStyle:{color:"rgba(0, 0, 0, 0.8)",width:1},label:{show:!0,formatter:null,margin:8,textStyle:{fontSize:14,color:"#fff",backgroundColor:"rgba(0,0,0,0.5)",padding:3,borderRadius:3}}},axisLine:{show:!0,lineStyle:{color:"#333",width:2,type:"solid"}},axisTick:{show:!0,inside:!1,length:3,lineStyle:{width:1}},axisLabel:{show:!0,inside:!1,rotate:0,margin:8,textStyle:{fontSize:12}},splitLine:{show:!0,lineStyle:{color:["#ccc"],width:1,type:"solid"}},splitArea:{show:!1,areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]}},light:{main:{alpha:30,beta:40},ambient:{intensity:.4}},viewControl:{alpha:20,beta:40,autoRotate:!1,distance:200,minDistance:40,maxDistance:400}}});O.util.merge(d.prototype,Q),O.util.merge(d.prototype,Ar),O.util.merge(d.prototype,e);const na=d;var oa=function(t,e){return(oa=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}))(t,e)};function aa(t,e){function r(){this.constructor=t}oa(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}Object.create;Object.create;var sa=new ni(50);function la(t){return t&&t.width&&t.height}function ha(){return[1,0,0,1,0,0]}function ua(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function ca(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5]}function da(t,e,r){var i=e[0]*r[0]+e[2]*r[1],n=e[1]*r[0]+e[3]*r[1],o=e[0]*r[2]+e[2]*r[3],a=e[1]*r[2]+e[3]*r[3],s=e[0]*r[4]+e[2]*r[5]+e[4],r=e[1]*r[4]+e[3]*r[5]+e[5];t[0]=i,t[1]=n,t[2]=o,t[3]=a,t[4]=s,t[5]=r}function fa(t,e,r){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4]+r[0],t[5]=e[5]+r[1]}function pa(t,e){var r=e[0],i=e[2],n=e[4],o=e[1],a=e[3],e=e[5],s=r*a-o*i;return s?(t[0]=a*(s=1/s),t[1]=-o*s,t[2]=-i*s,t[3]=r*s,t[4]=(i*e-a*n)*s,t[5]=(o*n-r*e)*s,t):null}function ma(t,e){this.x=t||0,this.y=e||0}ma.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},ma.prototype.clone=function(){return new ma(this.x,this.y)},ma.prototype.set=function(t,e){return this.x=t,this.y=e,this},ma.prototype.equal=function(t){return t.x===this.x&&t.y===this.y},ma.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},ma.prototype.scale=function(t){this.x*=t,this.y*=t},ma.prototype.scaleAndAdd=function(t,e){this.x+=t.x*e,this.y+=t.y*e},ma.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},ma.prototype.dot=function(t){return this.x*t.x+this.y*t.y},ma.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},ma.prototype.lenSquare=function(){return this.x*this.x+this.y*this.y},ma.prototype.normalize=function(){var t=this.len();return this.x/=t,this.y/=t,this},ma.prototype.distance=function(t){var e=this.x-t.x,t=this.y-t.y;return Math.sqrt(e*e+t*t)},ma.prototype.distanceSquare=function(t){var e=this.x-t.x,t=this.y-t.y;return e*e+t*t},ma.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},ma.prototype.transform=function(t){var e,r;if(t)return e=this.x,r=this.y,this.x=t[0]*e+t[2]*r+t[4],this.y=t[1]*e+t[3]*r+t[5],this},ma.prototype.toArray=function(t){return t[0]=this.x,t[1]=this.y,t},ma.prototype.fromArray=function(t){this.x=t[0],this.y=t[1]},ma.set=function(t,e,r){t.x=e,t.y=r},ma.copy=function(t,e){t.x=e.x,t.y=e.y},ma.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},ma.lenSquare=function(t){return t.x*t.x+t.y*t.y},ma.dot=function(t,e){return t.x*e.x+t.y*e.y},ma.add=function(t,e,r){t.x=e.x+r.x,t.y=e.y+r.y},ma.sub=function(t,e,r){t.x=e.x-r.x,t.y=e.y-r.y},ma.scale=function(t,e,r){t.x=e.x*r,t.y=e.y*r},ma.scaleAndAdd=function(t,e,r,i){t.x=e.x+r.x*i,t.y=e.y+r.y*i},ma.lerp=function(t,e,r,i){var n=1-i;t.x=n*e.x+i*r.x,t.y=n*e.y+i*r.y};const ga=ma;var _a=Math.min,ya=Math.max,va=new ga,xa=new ga,Ta=new ga,ba=new ga,wa=new ga,Sa=new ga;function Ea(t,e,r,i){r<0&&(t+=r,r=-r),i<0&&(e+=i,i=-i),this.x=t,this.y=e,this.width=r,this.height=i}Ea.prototype.union=function(t){var e=_a(t.x,this.x),r=_a(t.y,this.y);isFinite(this.x)&&isFinite(this.width)?this.width=ya(t.x+t.width,this.x+this.width)-e:this.width=t.width,isFinite(this.y)&&isFinite(this.height)?this.height=ya(t.y+t.height,this.y+this.height)-r:this.height=t.height,this.x=e,this.y=r},Ea.prototype.applyTransform=function(t){Ea.applyTransform(this,this,t)},Ea.prototype.calculateTransform=function(t){var e,r,i=t.width/this.width,n=t.height/this.height,o=ha();return fa(o,o,[-this.x,-this.y]),r=e=o,n=(i=[i,n])[0],i=i[1],e[0]=r[0]*n,e[1]=r[1]*i,e[2]=r[2]*n,e[3]=r[3]*i,e[4]=r[4]*n,e[5]=r[5]*i,fa(o,o,[t.x,t.y]),o},Ea.prototype.intersect=function(t,e){if(!t)return!1;t instanceof Ea||(t=Ea.create(t));var r,i,n,o,a,s,l,h,u=this.x,c=this.x+this.width,d=this.y,f=this.y+this.height,p=t.x,m=t.x+t.width,g=t.y,t=t.y+t.height,_=!(c<p||m<u||f<g||t<d);return e&&(r=1/0,i=0,n=Math.abs(c-p),o=Math.abs(m-u),a=Math.abs(f-g),s=Math.abs(t-d),l=Math.min(n,o),h=Math.min(a,s),c<p||m<u?i<l&&(i=l,n<o?ga.set(Sa,-n,0):ga.set(Sa,o,0)):l<r&&(r=l,n<o?ga.set(wa,n,0):ga.set(wa,-o,0)),f<g||t<d?i<h&&(i=h,a<s?ga.set(Sa,0,-a):ga.set(Sa,0,s)):l<r&&(r=l,a<s?ga.set(wa,0,a):ga.set(wa,0,-s))),e&&ga.copy(e,_?wa:Sa),_},Ea.prototype.contain=function(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height},Ea.prototype.clone=function(){return new Ea(this.x,this.y,this.width,this.height)},Ea.prototype.copy=function(t){Ea.copy(this,t)},Ea.prototype.plain=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},Ea.prototype.isFinite=function(){return isFinite(this.x)&&isFinite(this.y)&&isFinite(this.width)&&isFinite(this.height)},Ea.prototype.isZero=function(){return 0===this.width||0===this.height},Ea.create=function(t){return new Ea(t.x,t.y,t.width,t.height)},Ea.copy=function(t,e){t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height},Ea.applyTransform=function(t,e,r){var i,n,o,a;r?r[1]<1e-5&&-1e-5<r[1]&&r[2]<1e-5&&-1e-5<r[2]?(i=r[0],n=r[3],o=r[4],a=r[5],t.x=e.x*i+o,t.y=e.y*n+a,t.width=e.width*i,t.height=e.height*n,t.width<0&&(t.x+=t.width,t.width=-t.width),t.height<0&&(t.y+=t.height,t.height=-t.height)):(va.x=Ta.x=e.x,va.y=ba.y=e.y,xa.x=ba.x=e.x+e.width,xa.y=Ta.y=e.y+e.height,va.transform(r),ba.transform(r),xa.transform(r),Ta.transform(r),t.x=_a(va.x,xa.x,Ta.x,ba.x),t.y=_a(va.y,xa.y,Ta.y,ba.y),o=ya(va.x,xa.x,Ta.x,ba.x),a=ya(va.y,xa.y,Ta.y,ba.y),t.width=o-t.x,t.height=a-t.y):t!==e&&Ea.copy(t,e)};const Ma=Ea;var Aa,Ca,Da={},La="12px sans-serif";var Pa={measureText:function(t,e){return Aa=Aa||Wn.createCanvas().getContext("2d"),Ca!==e&&(Ca=Aa.font=e||La),Aa.measureText(t)}};function Na(t,e){var r=Da[e=e||La],i=(r=r||(Da[e]=new ni(500))).get(t);return null==i&&(i=Pa.measureText(t,e).width,r.put(t,i)),i}function Ra(t,e,r,i){t=Na(t,e),e=Ba(e),r=Ia(0,t,r),i=Oa(0,e,i);return new Ma(r,i,t,e)}function Ia(t,e,r){return"right"===r?t-=e:"center"===r&&(t-=e/2),t}function Oa(t,e,r){return"middle"===r?t-=e/2:"bottom"===r&&(t-=e),t}function Ba(t){return Na("",t)}function Fa(t,e){return"string"==typeof t?0<=t.lastIndexOf("%")?parseFloat(t)/100*e:parseFloat(t):t}var za=/\{([a-zA-Z0-9_]+)\|([^}]*)\}/g;function Ua(t,e,r,i){for(var n=Yn({},i=i||{}),o=(n.font=e,r=co(r,"..."),n.maxIterations=co(i.maxIterations,2),n.minChar=co(i.minChar,0)),a=(n.cnCharWidth=Na("",e),n.ascCharWidth=Na("a",e)),s=(n.placeholder=co(i.placeholder,""),t=Math.max(0,t-1)),l=0;l<o&&a<=s;l++)s-=a;i=Na(r,e);return s<i&&(r="",i=0),s=t-i,n.ellipsis=r,n.ellipsisWidth=i,n.contentWidth=s,n.containerWidth=t,n}function ka(t,e){var r=e.containerWidth,i=e.font,n=e.contentWidth;if(!r)return"";var o=Na(t,i);if(!(o<=r)){for(var a=0;;a++){if(o<=n||a>=e.maxIterations){t+=e.ellipsis;break}var s=0===a?function(t,e,r,i){for(var n=0,o=0,a=t.length;o<a&&n<e;o++){var s=t.charCodeAt(o);n+=0<=s&&s<=127?r:i}return o}(t,n,e.ascCharWidth,e.cnCharWidth):0<o?Math.floor(t.length*n/o):0,o=Na(t=t.substr(0,s),i)}""===t&&(t=e.placeholder)}return t}var Ga=function(){},Ha=function(t){this.tokens=[],t&&(this.tokens=t)},Va=function(){this.width=0,this.height=0,this.contentWidth=0,this.contentHeight=0,this.outerWidth=0,this.outerHeight=0,this.lines=[]};function Wa(t,e){var r=new Va;if(null!=t&&(t+=""),t){for(var i,n=e.width,o=e.height,a=e.overflow,s="break"!==a&&"breakAll"!==a||null==n?null:{width:n,accumWidth:0,breakAll:"breakAll"===a},l=za.lastIndex=0;null!=(i=za.exec(t));){var h=i.index;l<h&&Xa(r,t.substring(l,h),e,s),Xa(r,i[2],e,s,i[1]),l=za.lastIndex}l<t.length&&Xa(r,t.substring(l,t.length),e,s);var u,c=[],d=0,f=0,p=e.padding,m="truncate"===a,g="truncate"===e.lineOverflow;t:for(var _=0;_<r.lines.length;_++){for(var y=r.lines[_],v=0,x=0,T=0;T<y.tokens.length;T++){var b=(D=y.tokens[T]).styleName&&e.rich[D.styleName]||{},w=D.textPadding=b.padding,S=w?w[1]+w[3]:0,E=D.font=b.font||e.font,M=(D.contentHeight=Ba(E),co(b.height,D.contentHeight));if(D.innerHeight=M,w&&(M+=w[0]+w[2]),D.height=M,D.lineHeight=fo(b.lineHeight,e.lineHeight,M),D.align=b&&b.align||e.align,D.verticalAlign=b&&b.verticalAlign||"middle",g&&null!=o&&d+D.lineHeight>o){0<T?(y.tokens=y.tokens.slice(0,T),P(y,x,v),r.lines=r.lines.slice(0,_+1)):r.lines=r.lines.slice(0,_);break t}var A,w=b.width,C=null==w||"auto"===w;"string"==typeof w&&"%"===w.charAt(w.length-1)?(D.percentWidth=w,c.push(D),D.contentWidth=Na(D.text,E)):(C&&(w=(w=b.backgroundColor)&&w.image)&&(A=void 0,la(w="string"==typeof(u=w)?(A=sa.get(u))&&A.image:u))&&(D.width=Math.max(D.width,w.width*M/w.height)),null!=(A=m&&null!=n?n-x:null)&&A<D.width?!C||A<S?(D.text="",D.width=D.contentWidth=0):(D.text=function(t,e,r,i,n){if(!e)return"";var o=(t+"").split("\n");n=Ua(e,r,i,n);for(var a=0,s=o.length;a<s;a++)o[a]=ka(o[a],n);return o.join("\n")}(D.text,A-S,E,e.ellipsis,{minChar:e.truncateMinChar}),D.width=D.contentWidth=Na(D.text,E)):D.contentWidth=Na(D.text,E)),D.width+=S,x+=D.width,b&&(v=Math.max(v,D.lineHeight))}P(y,x,v)}r.outerWidth=r.width=co(n,f),r.outerHeight=r.height=co(o,d),r.contentHeight=d,r.contentWidth=f,p&&(r.outerWidth+=p[1]+p[3],r.outerHeight+=p[0]+p[2]);for(_=0;_<c.length;_++){var D,L=(D=c[_]).percentWidth;D.width=parseInt(L,10)/100*r.width}}return r;function P(t,e,r){t.width=e,t.lineHeight=r,d+=r,f=Math.max(f,e)}}function Xa(t,e,r,i,n){var o,a,s=""===e,l=n&&r.rich[n]||{},h=t.lines,u=l.font||r.font,c=!1;i?(r=(t=l.padding)?t[1]+t[3]:0,null!=l.width&&"auto"!==l.width?(t=Fa(l.width,i.width)+r,0<h.length&&t+i.accumWidth>i.width&&(o=e.split("\n"),c=!0),i.accumWidth=t):(t=qa(e,u,i.width,i.breakAll,i.accumWidth),i.accumWidth=t.accumWidth+r,a=t.linesWidths,o=t.lines)):o=e.split("\n");for(var d=0;d<o.length;d++){var f,p,m=o[d],g=new Ga;g.styleName=n,g.text=m,g.isLineHolder=!m&&!s,"number"==typeof l.width?g.width=l.width:g.width=a?a[d]:Na(m,u),d||c?h.push(new Ha([g])):1===(p=(f=(h[h.length-1]||(h[0]=new Ha)).tokens).length)&&f[0].isLineHolder?f[0]=g:!m&&p&&!s||f.push(g)}}var ja=ro(",&?/;] ".split(""),function(t,e){return t[e]=!0,t},{});function qa(t,e,r,i,n){for(var o,a=[],s=[],l="",h="",u=0,c=0,d=0;d<t.length;d++){var f,p,m=t.charAt(d);"\n"===m?(h&&(l+=h,c+=u),a.push(l),s.push(c),h=l="",c=u=0):(f=Na(m,e),p=!i&&(p=void 0,!!(33<=(p=(p=o=m).charCodeAt(0))&&p<=255&&!ja[o])),(a.length?r<c+f:r<n+c+f)?c?(l||h)&&(c=p?(l||(l=h,h="",c=u=0),a.push(l),s.push(c-u),h+=m,l="",u+=f):(h&&(l+=h,c+=u,h="",u=0),a.push(l),s.push(c),l=m,f)):p?(a.push(h),s.push(u),h=m,u=f):(a.push(m),s.push(f)):(c+=f,p?(h+=m,u+=f):(h&&(l+=h,h="",u=0),l+=m)))}return a.length||l||(l=t,h="",u=0),h&&(l+=h),l&&(a.push(l),s.push(c)),1===a.length&&(c+=n),{accumWidth:c,lines:a,linesWidths:s}}function Za(t,e){return[t=null==t?0:t,e=null==e?0:e]}function Ya(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function Ka(t){return Math.sqrt(Qa(t))}function Qa(t){return t[0]*t[0]+t[1]*t[1]}function Ja(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r}function $a(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}var ts=function(t,e){return(t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])};function es(t,e,r){var i=e[0],e=e[1];return t[0]=r[0]*i+r[2]*e+r[4],t[1]=r[1]*i+r[3]*e+r[5],t}function rs(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t}function is(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t}var ns=ua;function os(t){return 5e-5<t||t<-5e-5}var as=[],ss=[],ls=ha(),hs=Math.abs;function us(){}us.prototype.setPosition=function(t){this.x=t[0],this.y=t[1]},us.prototype.setScale=function(t){this.scaleX=t[0],this.scaleY=t[1]},us.prototype.setSkew=function(t){this.skewX=t[0],this.skewY=t[1]},us.prototype.setOrigin=function(t){this.originX=t[0],this.originY=t[1]},us.prototype.needLocalTransform=function(){return os(this.rotation)||os(this.x)||os(this.y)||os(this.scaleX-1)||os(this.scaleY-1)},us.prototype.updateTransform=function(){var t=this.parent,e=t&&t.transform,r=this.needLocalTransform(),i=this.transform;r||e?(i=i||ha(),r?this.getLocalTransform(i):ns(i),e&&(r?da(i,t.transform,i):ca(i,t.transform)),this.transform=i,this._resolveGlobalScaleRatio(i)):i&&ns(i)},us.prototype._resolveGlobalScaleRatio=function(t){var e,r,i=this.globalScaleRatio;null!=i&&1!==i&&(this.getGlobalScale(as),r=((as[1]-(r=as[1]<0?-1:1))*i+r)/as[1]||0,t[0]*=i=((as[0]-(e=as[0]<0?-1:1))*i+e)/as[0]||0,t[1]*=i,t[2]*=r,t[3]*=r),this.invTransform=this.invTransform||ha(),pa(this.invTransform,t)},us.prototype.getLocalTransform=function(t){return us.getLocalTransform(this,t)},us.prototype.getComputedTransform=function(){for(var t=this,e=[];t;)e.push(t),t=t.parent;for(;t=e.pop();)t.updateTransform();return this.transform},us.prototype.setLocalTransform=function(t){var e,r,i,n;t&&(n=t[0]*t[0]+t[1]*t[1],i=t[2]*t[2]+t[3]*t[3],e=Math.atan2(t[1],t[0]),r=Math.PI/2+e-Math.atan2(t[3],t[2]),i=Math.sqrt(i)*Math.cos(r),n=Math.sqrt(n),this.skewX=r,this.skewY=0,this.rotation=-e,this.x=+t[4],this.y=+t[5],this.scaleX=n,this.scaleY=i,this.originX=0,this.originY=0)},us.prototype.decomposeTransform=function(){var t,e,r;this.transform&&(e=this.parent,t=this.transform,e&&e.transform&&(da(ss,e.invTransform,t),t=ss),e=this.originX,r=this.originY,(e||r)&&(ls[4]=e,ls[5]=r,da(ss,t,ls),ss[4]-=e,ss[5]-=r,t=ss),this.setLocalTransform(t))},us.prototype.getGlobalScale=function(t){var e=this.transform;return t=t||[],e?(t[0]=Math.sqrt(e[0]*e[0]+e[1]*e[1]),t[1]=Math.sqrt(e[2]*e[2]+e[3]*e[3]),e[0]<0&&(t[0]=-t[0]),e[3]<0&&(t[1]=-t[1])):(t[0]=1,t[1]=1),t},us.prototype.transformCoordToLocal=function(t,e){t=[t,e],e=this.invTransform;return e&&es(t,t,e),t},us.prototype.transformCoordToGlobal=function(t,e){t=[t,e],e=this.transform;return e&&es(t,t,e),t},us.prototype.getLineScale=function(){var t=this.transform;return t&&1e-10<hs(t[0]-1)&&1e-10<hs(t[3]-1)?Math.sqrt(hs(t[0]*t[3]-t[2]*t[1])):1},us.getLocalTransform=function(t,e){e=e||[];var r,i,n,o,a=t.originX||0,s=t.originY||0,l=t.scaleX,h=t.scaleY,u=t.rotation||0,c=t.x,d=t.y,f=t.skewX?Math.tan(t.skewX):0,t=t.skewY?Math.tan(-t.skewY):0;return a||s?(e[4]=-a*l-f*s*h,e[5]=-s*h-t*a*l):e[4]=e[5]=0,e[0]=l,e[3]=h,e[1]=t*l,e[2]=f*h,u&&(t=u,h=(f=l=e)[0],u=f[2],r=f[4],i=f[1],n=f[3],f=f[5],o=Math.sin(t),t=Math.cos(t),l[0]=h*t+i*o,l[1]=-h*o+i*t,l[2]=u*t+n*o,l[3]=-u*o+t*n,l[4]=t*r+o*f,l[5]=t*f-o*r),e[4]+=a+c,e[5]+=s+d,e},us.initDefaultProps=((t=us.prototype).x=0,t.y=0,t.scaleX=1,t.scaleY=1,t.originX=0,t.originY=0,t.skewX=0,t.skewY=0,t.rotation=0,void(t.globalScaleRatio=1));const cs=us;function ds(t){t&&(this._$eventProcessor=t)}ds.prototype.on=function(t,e,r,i){this._$handlers||(this._$handlers={});var n=this._$handlers;if("function"==typeof e&&(i=r,r=e,e=null),r&&t){var o=this._$eventProcessor;null!=e&&o&&o.normalizeQuery&&(e=o.normalizeQuery(e)),n[t]||(n[t]=[]);for(var a=0;a<n[t].length;a++)if(n[t][a].h===r)return this;o={h:r,query:e,ctx:i||this,callAtLast:r.zrEventfulCallAtLast},e=n[t].length-1,i=n[t][e];i&&i.callAtLast?n[t].splice(e,0,o):n[t].push(o)}return this},ds.prototype.isSilent=function(t){var e=this._$handlers;return!e||!e[t]||!e[t].length},ds.prototype.off=function(t,e){var r=this._$handlers;if(r)if(t)if(e){if(r[t]){for(var i=[],n=0,o=r[t].length;n<o;n++)r[t][n].h!==e&&i.push(r[t][n]);r[t]=i}r[t]&&0===r[t].length&&delete r[t]}else delete r[t];else this._$handlers={};return this},ds.prototype.trigger=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(this._$handlers){var i=this._$handlers[t],n=this._$eventProcessor;if(i)for(var o=e.length,a=i.length,s=0;s<a;s++){var l=i[s];if(!n||!n.filter||null==l.query||n.filter(t,l.query))switch(o){case 0:l.h.call(l.ctx);break;case 1:l.h.call(l.ctx,e[0]);break;case 2:l.h.call(l.ctx,e[0],e[1]);break;default:l.h.apply(l.ctx,e)}}n&&n.afterTrigger&&n.afterTrigger(t)}return this},ds.prototype.triggerWithContext=function(t){if(this._$handlers){var e=this._$handlers[t],r=this._$eventProcessor;if(e)for(var i=arguments,n=i.length,o=i[n-1],a=e.length,s=0;s<a;s++){var l=e[s];if(!r||!r.filter||null==l.query||r.filter(t,l.query))switch(n){case 0:l.h.call(o);break;case 1:l.h.call(o,i[0]);break;case 2:l.h.call(o,i[0],i[1]);break;default:l.h.apply(o,i.slice(1,n-1))}}r&&r.afterTrigger&&r.afterTrigger(t)}return this};var g=ds,m=1,fs=m="undefined"!=typeof window?Math.max(window.devicePixelRatio||window.screen&&window.screen.deviceXDPI/window.screen.logicalXDPI||1,1):m,ps="#333",ms="#ccc",gs=function(){this.firefox=!1,this.ie=!1,this.edge=!1,this.newEdge=!1,this.weChat=!1},un=new function(){this.browser=new gs,this.node=!1,this.wxa=!1,this.worker=!1,this.canvasSupported=!1,this.svgSupported=!1,this.touchEventsSupported=!1,this.pointerEventsSupported=!1,this.domSupported=!1,this.transformSupported=!1,this.transform3dSupported=!1};"object"==typeof wx&&"function"==typeof wx.getSystemInfoSync?(un.wxa=!0,un.canvasSupported=!0,un.touchEventsSupported=!0):"undefined"==typeof document&&"undefined"!=typeof self?(un.worker=!0,un.canvasSupported=!0):"undefined"==typeof navigator?(un.node=!0,un.canvasSupported=!0,un.svgSupported=!0):(y=navigator.userAgent,d=(gn=un).browser,t=y.match(/Firefox\/([\d.]+)/),m=y.match(/MSIE\s([\d.]+)/)||y.match(/Trident\/.+?rv:(([\d.]+))/),Ps=y.match(/Edge?\/([\d.]+)/),y=/micromessenger/i.test(y),t&&(d.firefox=!0,d.version=t[1]),m&&(d.ie=!0,d.version=m[1]),Ps&&(d.edge=!0,d.version=Ps[1],d.newEdge=18<+Ps[1].split(".")[0]),y&&(d.weChat=!0),gn.canvasSupported=!!document.createElement("canvas").getContext,gn.svgSupported="undefined"!=typeof SVGRect,gn.touchEventsSupported="ontouchstart"in window&&!d.ie&&!d.edge,gn.pointerEventsSupported="onpointerdown"in window&&(d.edge||d.ie&&11<=+d.version),gn.domSupported="undefined"!=typeof document,t=document.documentElement.style,gn.transform3dSupported=(d.ie&&"transition"in t||d.edge||"WebKitCSSMatrix"in window&&"m11"in new WebKitCSSMatrix||"MozPerspective"in t)&&!("OTransition"in t),gn.transformSupported=gn.transform3dSupported||d.ie&&9<=+d.version);const _s=un;var ys,vs,xs="__zr_normal__",Ts=["x","y","scaleX","scaleY","originX","originY","rotation","ignore"],bs={x:!0,y:!0,scaleX:!0,scaleY:!0,originX:!0,originY:!0,rotation:!0,ignore:!1},ws={},Ss=new Ma(0,0,0,0),m=(x.prototype._init=function(t){this.attr(t)},x.prototype.drift=function(t,e,r){switch(this.draggable){case"horizontal":e=0;break;case"vertical":t=0}var i=this.transform;(i=i||(this.transform=[1,0,0,1,0,0]))[4]+=t,i[5]+=e,this.decomposeTransform(),this.markRedraw()},x.prototype.beforeUpdate=function(){},x.prototype.afterUpdate=function(){},x.prototype.update=function(){this.updateTransform(),this.__dirty&&this.updateInnerText()},x.prototype.updateInnerText=function(t){var e=this._textContent;if(e&&(!e.ignore||t)){this.textConfig||(this.textConfig={});var t=this.textConfig,r=t.local,i=e.attachedTransform,n=void 0,o=void 0,a=!1,s=(i.parent=r?this:null,!1);if(i.x=e.x,i.y=e.y,i.originX=e.originX,i.originY=e.originY,i.rotation=e.rotation,i.scaleX=e.scaleX,i.scaleY=e.scaleY,null!=t.position){var l=Ss;if(t.layoutRect?l.copy(t.layoutRect):l.copy(this.getBoundingRect()),r||l.applyTransform(this.transform),this.calculateTextPosition)this.calculateTextPosition(ws,t,l);else{var h=ws,u=t,c=l,d=u.position||"inside",f=null!=u.distance?u.distance:5,p=c.height,m=c.width,g=p/2,_=c.x,y=c.y,v="left",x="top";if(d instanceof Array)_+=Fa(d[0],c.width),y+=Fa(d[1],c.height),x=v=null;else switch(d){case"left":_-=f,y+=g,v="right",x="middle";break;case"right":_+=f+m,y+=g,x="middle";break;case"top":_+=m/2,y-=f,v="center",x="bottom";break;case"bottom":_+=m/2,y+=p+f,v="center";break;case"inside":_+=m/2,y+=g,v="center",x="middle";break;case"insideLeft":_+=f,y+=g,x="middle";break;case"insideRight":_+=m-f,y+=g,v="right",x="middle";break;case"insideTop":_+=m/2,y+=f,v="center";break;case"insideBottom":_+=m/2,y+=p-f,v="center",x="bottom";break;case"insideTopLeft":_+=f,y+=f;break;case"insideTopRight":_+=m-f,y+=f,v="right";break;case"insideBottomLeft":_+=f,y+=p-f,x="bottom";break;case"insideBottomRight":_+=m-f,y+=p-f,v="right",x="bottom"}(h=h||{}).x=_,h.y=y,h.align=v,h.verticalAlign=x}i.x=ws.x,i.y=ws.y;n=ws.align,o=ws.verticalAlign,u=t.origin;u&&null!=t.rotation&&(d=c=void 0,d="center"===u?(c=.5*l.width,.5*l.height):(c=Fa(u[0],l.width),Fa(u[1],l.height)),s=!0,i.originX=-i.x+c+(r?0:l.x),i.originY=-i.y+d+(r?0:l.y))}null!=t.rotation&&(i.rotation=t.rotation);var h=t.offset,r=(h&&(i.x+=h[0],i.y+=h[1],s||(i.originX=-h[0],i.originY=-h[1])),null==t.inside?"string"==typeof t.position&&0<=t.position.indexOf("inside"):t.inside),l=this._innerTextDefaultStyle||(this._innerTextDefaultStyle={}),s=void 0,i=void 0,T=void 0;r&&this.canBeInsideText()?(s=t.insideFill,i=t.insideStroke,null!=s&&"auto"!==s||(s=this.getInsideTextFill()),null!=i&&"auto"!==i||(i=this.getInsideTextStroke(s),T=!0)):(s=t.outsideFill,i=t.outsideStroke,null!=s&&"auto"!==s||(s=this.getOutsideFill()),null!=i&&"auto"!==i||(i=this.getOutsideStroke(s),T=!0)),(s=s||"#000")===l.fill&&i===l.stroke&&T===l.autoStroke&&n===l.align&&o===l.verticalAlign||(a=!0,l.fill=s,l.stroke=i,l.autoStroke=T,l.align=n,l.verticalAlign=o,e.setDefaultTextStyle(l)),e.__dirty|=1,a&&e.dirtyStyle(!0)}},x.prototype.canBeInsideText=function(){return!0},x.prototype.getInsideTextFill=function(){return"#fff"},x.prototype.getInsideTextStroke=function(t){return"#000"},x.prototype.getOutsideFill=function(){return this.__zr&&this.__zr.isDarkMode()?ms:ps},x.prototype.getOutsideStroke=function(t){for(var e=this.__zr&&this.__zr.getBackgroundColor(),r="string"==typeof e&&Nn(e),i=(r=r||[255,255,255,1])[3],n=this.__zr.isDarkMode(),o=0;o<3;o++)r[o]=r[o]*i+(n?0:255)*(1-i);return r[3]=1,In(r,"rgba")},x.prototype.traverse=function(t,e){},x.prototype.attrKV=function(t,e){"textConfig"===t?this.setTextConfig(e):"textContent"===t?this.setTextContent(e):"clipPath"===t?this.setClipPath(e):"extra"===t?(this.extra=this.extra||{},Yn(this.extra,e)):this[t]=e},x.prototype.hide=function(){this.ignore=!0,this.markRedraw()},x.prototype.show=function(){this.ignore=!1,this.markRedraw()},x.prototype.attr=function(t,e){if("string"==typeof t)this.attrKV(t,e);else if(lo(t))for(var r=io(t),i=0;i<r.length;i++){var n=r[i];this.attrKV(n,t[n])}return this.markRedraw(),this},x.prototype.saveCurrentToNormalState=function(t){this._innerSaveToNormal(t);for(var e=this._normalState,r=0;r<this.animators.length;r++){var i=this.animators[r],n=i.__fromStateTransition;n&&n!==xs||(n=(n=i.targetName)?e[n]:e,i.saveFinalToTarget(n))}},x.prototype._innerSaveToNormal=function(t){var e=(e=this._normalState)||(this._normalState={});t.textConfig&&!e.textConfig&&(e.textConfig=this.textConfig),this._savePrimaryToNormal(t,e,Ts)},x.prototype._savePrimaryToNormal=function(t,e,r){for(var i=0;i<r.length;i++){var n=r[i];null==t[n]||n in e||(e[n]=this[n])}},x.prototype.hasState=function(){return 0<this.currentStates.length},x.prototype.getState=function(t){return this.states[t]},x.prototype.ensureState=function(t){var e=this.states;return e[t]||(e[t]={}),e[t]},x.prototype.clearStates=function(t){this.useState(xs,!1,t)},x.prototype.useState=function(t,e,r,i){var n=t===xs,o=this.hasState();if(o||!n){var a,o=this.currentStates,s=this.stateTransition;if(!(0<=Qn(o,t))||!e&&1!==o.length){if((a=(a=this.stateProxy&&!n?this.stateProxy(t):a)||this.states&&this.states[t])||n)return n||this.saveCurrentToNormalState(a),(o=!!(a&&a.hoverLayer||i))&&this._toggleHoverLayerFlag(!0),this._applyStateObj(t,a,this._normalState,e,!r&&!this.__inHover&&s&&0<s.duration,s),i=this._textContent,s=this._textGuide,i&&i.useState(t,e,r,o),s&&s.useState(t,e,r,o),n?(this.currentStates=[],this._normalState={}):e?this.currentStates.push(t):this.currentStates=[t],this._updateAnimationTargets(),this.markRedraw(),!o&&this.__inHover&&(this._toggleHoverLayerFlag(!1),this.__dirty&=-2),a;jn("State "+t+" not exists.")}}},x.prototype.useStates=function(t,e,r){if(t.length){var i=[],n=this.currentStates,o=t.length,a=o===n.length;if(a)for(var s=0;s<o;s++)if(t[s]!==n[s]){a=!1;break}if(!a){for(s=0;s<o;s++){var l=t[s],h=void 0;(h=(h=this.stateProxy?this.stateProxy(l,t):h)||this.states[l])&&i.push(h)}var u=i[o-1],u=!!(u&&u.hoverLayer||r),r=(u&&this._toggleHoverLayerFlag(!0),this._mergeStates(i)),c=this.stateTransition,r=(this.saveCurrentToNormalState(r),this._applyStateObj(t.join(","),r,this._normalState,!1,!e&&!this.__inHover&&c&&0<c.duration,c),this._textContent),c=this._textGuide;r&&r.useStates(t,e,u),c&&c.useStates(t,e,u),this._updateAnimationTargets(),this.currentStates=t.slice(),this.markRedraw(),!u&&this.__inHover&&(this._toggleHoverLayerFlag(!1),this.__dirty&=-2)}}else this.clearStates()},x.prototype._updateAnimationTargets=function(){for(var t=0;t<this.animators.length;t++){var e=this.animators[t];e.targetName&&e.changeTarget(this[e.targetName])}},x.prototype.removeState=function(t){var e,t=Qn(this.currentStates,t);0<=t&&((e=this.currentStates.slice()).splice(t,1),this.useStates(e))},x.prototype.replaceState=function(t,e,r){var i=this.currentStates.slice(),t=Qn(i,t),n=0<=Qn(i,e);0<=t?n?i.splice(t,1):i[t]=e:r&&!n&&i.push(e),this.useStates(i)},x.prototype.toggleState=function(t,e){e?this.useState(t,!0):this.removeState(t)},x.prototype._mergeStates=function(t){for(var e,r={},i=0;i<t.length;i++){var n=t[i];Yn(r,n),n.textConfig&&Yn(e=e||{},n.textConfig)}return e&&(r.textConfig=e),r},x.prototype._applyStateObj=function(t,e,r,i,n,o){for(var a=!(e&&i),s=(e&&e.textConfig?(this.textConfig=Yn({},(i?this:r).textConfig),Yn(this.textConfig,e.textConfig)):a&&r.textConfig&&(this.textConfig=r.textConfig),{}),l=!1,h=0;h<Ts.length;h++){var u=Ts[h],c=n&&bs[u];e&&null!=e[u]?c?(l=!0,s[u]=e[u]):this[u]=e[u]:a&&null!=r[u]&&(c?(l=!0,s[u]=r[u]):this[u]=r[u])}if(!n)for(h=0;h<this.animators.length;h++){var d=this.animators[h],f=d.targetName;d.__changeFinalValue(f?(e||r)[f]:e||r)}l&&this._transitionState(t,s,o)},x.prototype._attachComponent=function(t){if(t.__zr&&!t.__hostTarget)throw new Error("Text element has been added to zrender.");if(t===this)throw new Error("Recursive component attachment.");var e=this.__zr;e&&t.addSelfToZr(e),t.__zr=e,t.__hostTarget=this},x.prototype._detachComponent=function(t){t.__zr&&t.removeSelfFromZr(t.__zr),t.__zr=null,t.__hostTarget=null},x.prototype.getClipPath=function(){return this._clipPath},x.prototype.setClipPath=function(t){this._clipPath&&this._clipPath!==t&&this.removeClipPath(),this._attachComponent(t),this._clipPath=t,this.markRedraw()},x.prototype.removeClipPath=function(){var t=this._clipPath;t&&(this._detachComponent(t),this._clipPath=null,this.markRedraw())},x.prototype.getTextContent=function(){return this._textContent},x.prototype.setTextContent=function(t){var e=this._textContent;if(e!==t){if(e&&e!==t&&this.removeTextContent(),t.__zr&&!t.__hostTarget)throw new Error("Text element has been added to zrender.");t.attachedTransform=new cs,this._attachComponent(t),this._textContent=t,this.markRedraw()}},x.prototype.setTextConfig=function(t){this.textConfig||(this.textConfig={}),Yn(this.textConfig,t),this.markRedraw()},x.prototype.removeTextConfig=function(){this.textConfig=null,this.markRedraw()},x.prototype.removeTextContent=function(){var t=this._textContent;t&&(t.attachedTransform=null,this._detachComponent(t),this._textContent=null,this._innerTextDefaultStyle=null,this.markRedraw())},x.prototype.getTextGuideLine=function(){return this._textGuide},x.prototype.setTextGuideLine=function(t){this._textGuide&&this._textGuide!==t&&this.removeTextGuideLine(),this._attachComponent(t),this._textGuide=t,this.markRedraw()},x.prototype.removeTextGuideLine=function(){var t=this._textGuide;t&&(this._detachComponent(t),this._textGuide=null,this.markRedraw())},x.prototype.markRedraw=function(){this.__dirty|=1;var t=this.__zr;t&&(this.__inHover?t.refreshHover():t.refresh()),this.__hostTarget&&this.__hostTarget.markRedraw()},x.prototype.dirty=function(){this.markRedraw()},x.prototype._toggleHoverLayerFlag=function(t){this.__inHover=t;var e=this._textContent,r=this._textGuide;e&&(e.__inHover=t),r&&(r.__inHover=t)},x.prototype.addSelfToZr=function(t){this.__zr=t;var e=this.animators;if(e)for(var r=0;r<e.length;r++)t.animation.addAnimator(e[r]);this._clipPath&&this._clipPath.addSelfToZr(t),this._textContent&&this._textContent.addSelfToZr(t),this._textGuide&&this._textGuide.addSelfToZr(t)},x.prototype.removeSelfFromZr=function(t){this.__zr=null;var e=this.animators;if(e)for(var r=0;r<e.length;r++)t.animation.removeAnimator(e[r]);this._clipPath&&this._clipPath.removeSelfFromZr(t),this._textContent&&this._textContent.removeSelfFromZr(t),this._textGuide&&this._textGuide.removeSelfFromZr(t)},x.prototype.animate=function(t,e){var r=t?this[t]:this;if(r)return r=new Uo(r,e),this.addAnimator(r,t),r;jn('Property "'+t+'" is not existed in element '+this.id)},x.prototype.addAnimator=function(r,t){var e=this.__zr,i=this;r.during(function(){i.updateDuringAnimation(t)}).done(function(){var t=i.animators,e=Qn(t,r);0<=e&&t.splice(e,1)}),this.animators.push(r),e&&e.animation.addAnimator(r),e&&e.wakeUp()},x.prototype.updateDuringAnimation=function(t){this.markRedraw()},x.prototype.stopAnimation=function(t,e){for(var r=this.animators,i=r.length,n=[],o=0;o<i;o++){var a=r[o];t&&t!==a.scope?n.push(a):a.stop(e)}return this.animators=n,this},x.prototype.animateTo=function(t,e,r){As(this,t,e,r)},x.prototype.animateFrom=function(t,e,r){As(this,t,e,r,!0)},x.prototype._transitionState=function(t,e,r,i){for(var n=As(this,e,r,i),o=0;o<n.length;o++)n[o].__fromStateTransition=t},x.prototype.getBoundingRect=function(){return null},x.prototype.getPaintRect=function(){return null},x.initDefaultProps=((ys=x.prototype).type="element",ys.name="",ys.ignore=!1,ys.silent=!1,ys.isGroup=!1,ys.draggable=!1,ys.dragging=!1,ys.ignoreClip=!1,ys.__inHover=!1,ys.__dirty=1,vs={},void(Object.defineProperty&&(!_s.browser.ie||8<_s.browser.version)&&(Ms("position","_legacyPos","x","y"),Ms("scale","_legacyScale","scaleX","scaleY"),Ms("origin","_legacyOrigin","originX","originY")))),x);function x(t){this.id=Xn++,this.animators=[],this.currentStates=[],this.states={},this._init(t)}function Es(t,e,r){vs[t+e+r]||(console.warn("DEPRECATED: '"+t+"' has been deprecated. use '"+e+"', '"+r+"' instead"),vs[t+e+r]=!0)}function Ms(e,r,i,n){function o(e,t){Object.defineProperty(t,0,{get:function(){return e[i]},set:function(t){e[i]=t}}),Object.defineProperty(t,1,{get:function(){return e[n]},set:function(t){e[n]=t}})}Object.defineProperty(ys,e,{get:function(){var t;return Es(e,i,n),this[r]||(t=this[r]=[],o(this,t)),this[r]},set:function(t){Es(e,i,n),this[i]=t[0],this[n]=t[1],this[r]=t,o(this,t)}})}function As(t,e,r,i,n){function o(){h=!0,--l<=0&&(h?u&&u():c&&c())}function a(){--l<=0&&(h?u&&u():c&&c())}var s=[],l=(!function t(e,r,i,n,o,a,s,l){var h=[];var u=[];var c=io(n);var d=o.duration;var f=o.delay;var p=o.additive;var m=o.setToFinal;var g=!lo(a);for(var _=0;_<c.length;_++){var y=c[_];null!=i[y]&&null!=n[y]&&(g||a[y])?lo(n[y])&&!$n(n[y])?r?l||(i[y]=n[y],e.updateDuringAnimation(r)):t(e,y,i[y],n[y],o,a&&a[y],s,l):(h.push(y),u.push(y)):l||(i[y]=n[y],e.updateDuringAnimation(r),u.push(y))}var v=h.length;if(0<v||o.force&&!s.length){for(var x=e.animators,T=[],b=0;b<x.length;b++)x[b].targetName===r&&T.push(x[b]);if(!p&&T.length)for(b=0;b<T.length;b++){var w=T[b].stopTracks(u);w&&(w=Qn(x,T[b]),x.splice(w,1))}var S=void 0,E=void 0,M=void 0;if(l){E={},m&&(S={});for(b=0;b<v;b++)E[y=h[b]]=i[y],m?S[y]=n[y]:i[y]=n[y]}else if(m){M={};for(b=0;b<v;b++)M[y=h[b]]=Ro(i[y]),Ds(i,n,y)}p=new Uo(i,!1,p?T:null);p.targetName=r,o.scope&&(p.scope=o.scope),m&&S&&p.whenWithKeys(0,S,h),M&&p.whenWithKeys(0,M,h),p.whenWithKeys(null==d?500:d,l?E:n,h).delay(f||0),e.addAnimator(p,r),s.push(p)}}(t,"",t,e,r=r||{},i,s,n),s.length),h=!1,u=r.done,c=r.aborted;l||u&&u(),0<s.length&&r.during&&s[0].during(function(t,e){r.during(e)});for(var d=0;d<s.length;d++){var f=s[d];f.done(o),f.aborted(a),f.start(r.easing,r.force)}return s}function Cs(t,e,r){for(var i=0;i<r;i++)t[i]=e[i]}function Ds(t,e,r){if($n(e[r]))if($n(t[r])||(t[r]=[]),l=e[r],Fn[zn.call(l)]){l=e[r].length;t[r].length!==l&&(t[r]=new e[r].constructor(l),Cs(t[r],e[r],l))}else{var i=e[r],n=t[r],o=i.length;if($n(i[0]))for(var a=i[0].length,s=0;s<o;s++)n[s]?Cs(n[s],i[s],a):n[s]=Array.prototype.slice.call(i[s]);else Cs(n,i,o);n.length=i.length}else t[r]=e[r];var l}Jn(m,g),Jn(m,cs);var Ls,Ps=m,Ns="__zr_style_"+Math.round(10*Math.random()),Rs={shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,shadowColor:"#000",opacity:1,blend:"source-over"},Is={style:{shadowBlur:!0,shadowOffsetX:!0,shadowOffsetY:!0,shadowColor:!0,opacity:!0}},Os=(Rs[Ns]=!0,["z","z2","invisible"]),Bs=["invisible"],t=(aa(T,Ls=Ps),T.prototype._init=function(t){for(var e=io(t),r=0;r<e.length;r++){var i=e[r];"style"===i?this.useStyle(t[i]):Ls.prototype.attrKV.call(this,i,t[i])}this.style||this.useStyle({})},T.prototype.beforeBrush=function(){},T.prototype.afterBrush=function(){},T.prototype.innerBeforeBrush=function(){},T.prototype.innerAfterBrush=function(){},T.prototype.shouldBePainted=function(t,e,r,i){var n=this.transform;if(this.ignore||this.invisible||0===this.style.opacity||this.culling&&function(t,e,r){Fs.copy(t.getBoundingRect()),t.transform&&Fs.applyTransform(t.transform);return zs.width=e,zs.height=r,!Fs.intersect(zs)}(this,t,e)||n&&!n[0]&&!n[3])return!1;if(r&&this.__clipPaths)for(var o=0;o<this.__clipPaths.length;++o)if(this.__clipPaths[o].isZeroArea())return!1;if(i&&this.parent)for(var a=this.parent;a;){if(a.ignore)return!1;a=a.parent}return!0},T.prototype.contain=function(t,e){return this.rectContain(t,e)},T.prototype.traverse=function(t,e){t.call(e,this)},T.prototype.rectContain=function(t,e){t=this.transformCoordToLocal(t,e);return this.getBoundingRect().contain(t[0],t[1])},T.prototype.getPaintRect=function(){var t,e,r,i,n,o=this._paintRect;return this._paintRect&&!this.__dirty||(n=this.transform,t=this.getBoundingRect(),e=(i=this.style).shadowBlur||0,r=i.shadowOffsetX||0,i=i.shadowOffsetY||0,o=this._paintRect||(this._paintRect=new Ma(0,0,0,0)),n?Ma.applyTransform(o,t,n):o.copy(t),(e||r||i)&&(o.width+=2*e+Math.abs(r),o.height+=2*e+Math.abs(i),o.x=Math.min(o.x,o.x+r-e),o.y=Math.min(o.y,o.y+i-e)),n=this.dirtyRectTolerance,o.isZero())||(o.x=Math.floor(o.x-n),o.y=Math.floor(o.y-n),o.width=Math.ceil(o.width+1+2*n),o.height=Math.ceil(o.height+1+2*n)),o},T.prototype.setPrevPaintRect=function(t){t?(this._prevPaintRect=this._prevPaintRect||new Ma(0,0,0,0),this._prevPaintRect.copy(t)):this._prevPaintRect=null},T.prototype.getPrevPaintRect=function(){return this._prevPaintRect},T.prototype.animateStyle=function(t){return this.animate("style",t)},T.prototype.updateDuringAnimation=function(t){"style"===t?this.dirtyStyle():this.markRedraw()},T.prototype.attrKV=function(t,e){"style"!==t?Ls.prototype.attrKV.call(this,t,e):this.style?this.setStyle(e):this.useStyle(e)},T.prototype.setStyle=function(t,e){return"string"==typeof t?this.style[t]=e:Yn(this.style,t),this.dirtyStyle(),this},T.prototype.dirtyStyle=function(t){t||this.markRedraw(),this.__dirty|=2,this._rect&&(this._rect=null)},T.prototype.dirty=function(){this.dirtyStyle()},T.prototype.styleChanged=function(){return!!(2&this.__dirty)},T.prototype.styleUpdated=function(){this.__dirty&=-3},T.prototype.createStyle=function(t){return So(Rs,t)},T.prototype.useStyle=function(t){t[Ns]||(t=this.createStyle(t)),this.__inHover?this.__hoverStyle=t:this.style=t,this.dirtyStyle()},T.prototype.isStyleObject=function(t){return t[Ns]},T.prototype._innerSaveToNormal=function(t){Ls.prototype._innerSaveToNormal.call(this,t);var e=this._normalState;t.style&&!e.style&&(e.style=this._mergeStyle(this.createStyle(),this.style)),this._savePrimaryToNormal(t,e,Os)},T.prototype._applyStateObj=function(t,e,r,i,n,o){Ls.prototype._applyStateObj.call(this,t,e,r,i,n,o);var a,s=!(e&&i);if(e&&e.style?n?i?a=e.style:(a=this._mergeStyle(this.createStyle(),r.style),this._mergeStyle(a,e.style)):(a=this._mergeStyle(this.createStyle(),(i?this:r).style),this._mergeStyle(a,e.style)):s&&(a=r.style),a)if(n){var l=this.style;if(this.style=this.createStyle(s?{}:l),s)for(var h=io(l),u=0;u<h.length;u++)(d=h[u])in a&&(a[d]=a[d],this.style[d]=l[d]);for(var c=io(a),u=0;u<c.length;u++){var d=c[u];this.style[d]=this.style[d]}this._transitionState(t,{style:a},o,this.getAnimationStyleProps())}else this.useStyle(a);for(var f=this.__inHover?Bs:Os,u=0;u<f.length;u++){d=f[u];e&&null!=e[d]?this[d]=e[d]:s&&null!=r[d]&&(this[d]=r[d])}},T.prototype._mergeStates=function(t){for(var e,r=Ls.prototype._mergeStates.call(this,t),i=0;i<t.length;i++){var n=t[i];n.style&&this._mergeStyle(e=e||{},n.style)}return e&&(r.style=e),r},T.prototype._mergeStyle=function(t,e){return Yn(t,e),t},T.prototype.getAnimationStyleProps=function(){return Is},T.initDefaultProps=((y=T.prototype).type="displayable",y.invisible=!1,y.z=0,y.z2=0,y.zlevel=0,y.culling=!1,y.cursor="pointer",y.rectHover=!1,y.incremental=!1,y._rect=null,y.dirtyRectTolerance=0,void(y.__dirty=3)),T);function T(t){return Ls.call(this,t)||this}var Fs=new Ma(0,0,0,0),zs=new Ma(0,0,0,0);var gn=t,Us=Math.pow,ks=Math.sqrt,Gs=1e-8,Hs=ks(3),Vs=Za(),Ws=Za(),Xs=Za();function js(t){return-Gs<t&&t<Gs}function qs(t){return Gs<t||t<-Gs}function Zs(t,e,r,i,n){var o=1-n;return o*o*(o*t+3*n*e)+n*n*(n*i+3*o*r)}function Ys(t,e,r,i,n){var o=1-n;return 3*(((e-t)*o+2*(r-e)*n)*o+(i-r)*n*n)}function Ks(t,e,r,i,n){var o,a=6*r-12*e+6*t,i=9*e+3*i-3*t-9*r,r=3*e-3*t,e=0;return js(i)?qs(a)&&0<=(o=-r/a)&&o<=1&&(n[e++]=o):js(t=a*a-4*i*r)?n[0]=-a/(2*i):0<t&&(t=(-a-(r=ks(t)))/(2*i),0<=(o=(-a+r)/(2*i))&&o<=1&&(n[e++]=o),0<=t)&&t<=1&&(n[e++]=t),e}function Qs(t,e,r,i,n,o){var a=(e-t)*n+t,e=(r-e)*n+e,r=(i-r)*n+r,s=(e-a)*n+a,e=(r-e)*n+e,n=(e-s)*n+s;o[0]=t,o[1]=a,o[2]=s,o[3]=n,o[4]=n,o[5]=e,o[6]=r,o[7]=i}function Js(t,e,r,i){var n=1-i;return n*(n*t+2*i*e)+i*i*r}function $s(t,e,r,i){return 2*((1-i)*(e-t)+i*(r-e))}function tl(t,e,r){r=t+r-2*e;return 0==r?.5:(t-e)/r}function el(t,e,r,i,n){var o=(e-t)*i+t,e=(r-e)*i+e,i=(e-o)*i+o;n[0]=t,n[1]=o,n[2]=i,n[3]=i,n[4]=e,n[5]=r}var rl=Math.min,il=Math.max,nl=Math.sin,ol=Math.cos,al=2*Math.PI,sl=Za(),ll=Za(),hl=Za();function ul(t,e,r,i,n,o){n[0]=rl(t,r),n[1]=rl(e,i),o[0]=il(t,r),o[1]=il(e,i)}var cl=[],dl=[];var fl={M:1,L:2,C:3,Q:4,A:5,Z:6,R:7},pl=[],ml=[],gl=[],_l=[],yl=[],vl=[],xl=Math.min,Tl=Math.max,bl=Math.cos,wl=Math.sin,Sl=Math.sqrt,El=Math.abs,Ml=Math.PI,Al=2*Ml,Cl="undefined"!=typeof Float32Array,Dl=[];function Ll(t){return Math.round(t/Ml*1e8)/1e8%2*Ml}function Pl(t,e){var r=Ll(t[0]),i=(r<0&&(r+=Al),r-t[0]),n=t[1];n+=i,!e&&Al<=n-r?n=r+Al:e&&Al<=r-n?n=r-Al:!e&&n<r?n=r+(Al-Ll(r-n)):e&&r<n&&(n=r-(Al-Ll(n-r))),t[0]=r,t[1]=n}function b(t){this.dpr=1,this._xi=0,this._yi=0,this._x0=0,this._y0=0,this._len=0,t&&(this._saveData=!1),this._saveData&&(this.data=[])}b.prototype.increaseVersion=function(){this._version++},b.prototype.getVersion=function(){return this._version},b.prototype.setScale=function(t,e,r){0<(r=r||0)&&(this._ux=El(r/fs/t)||0,this._uy=El(r/fs/e)||0)},b.prototype.setDPR=function(t){this.dpr=t},b.prototype.setContext=function(t){this._ctx=t},b.prototype.getContext=function(){return this._ctx},b.prototype.beginPath=function(){return this._ctx&&this._ctx.beginPath(),this.reset(),this},b.prototype.reset=function(){this._saveData&&(this._len=0),this._lineDash&&(this._lineDash=null,this._dashOffset=0),this._pathSegLen&&(this._pathSegLen=null,this._pathLen=0),this._version++},b.prototype.moveTo=function(t,e){return this._drawPendingPt(),this.addData(fl.M,t,e),this._ctx&&this._ctx.moveTo(t,e),this._x0=t,this._y0=e,this._xi=t,this._yi=e,this},b.prototype.lineTo=function(t,e){var r=El(t-this._xi),i=El(e-this._yi),n=r>this._ux||i>this._uy;return this.addData(fl.L,t,e),this._ctx&&n&&(this._needsDash?this._dashedLineTo(t,e):this._ctx.lineTo(t,e)),n?(this._xi=t,this._yi=e,this._pendingPtDist=0):(n=r*r+i*i)>this._pendingPtDist&&(this._pendingPtX=t,this._pendingPtY=e,this._pendingPtDist=n),this},b.prototype.bezierCurveTo=function(t,e,r,i,n,o){return this.addData(fl.C,t,e,r,i,n,o),this._ctx&&(this._needsDash?this._dashedBezierTo(t,e,r,i,n,o):this._ctx.bezierCurveTo(t,e,r,i,n,o)),this._xi=n,this._yi=o,this},b.prototype.quadraticCurveTo=function(t,e,r,i){return this.addData(fl.Q,t,e,r,i),this._ctx&&(this._needsDash?this._dashedQuadraticTo(t,e,r,i):this._ctx.quadraticCurveTo(t,e,r,i)),this._xi=r,this._yi=i,this},b.prototype.arc=function(t,e,r,i,n,o){return Dl[0]=i,Dl[1]=n,Pl(Dl,o),this.addData(fl.A,t,e,r,r,i=Dl[0],(n=Dl[1])-i,0,o?0:1),this._ctx&&this._ctx.arc(t,e,r,i,n,o),this._xi=bl(n)*r+t,this._yi=wl(n)*r+e,this},b.prototype.arcTo=function(t,e,r,i,n){return this._ctx&&this._ctx.arcTo(t,e,r,i,n),this},b.prototype.rect=function(t,e,r,i){return this._ctx&&this._ctx.rect(t,e,r,i),this.addData(fl.R,t,e,r,i),this},b.prototype.closePath=function(){this._drawPendingPt(),this.addData(fl.Z);var t=this._ctx,e=this._x0,r=this._y0;return t&&(this._needsDash&&this._dashedLineTo(e,r),t.closePath()),this._xi=e,this._yi=r,this},b.prototype.fill=function(t){t&&t.fill(),this.toStatic()},b.prototype.stroke=function(t){t&&t.stroke(),this.toStatic()},b.prototype.setLineDash=function(t){if(t instanceof Array){this._lineDash=t;for(var e=this._dashIdx=0,r=0;r<t.length;r++)e+=t[r];this._dashSum=e,this._needsDash=!0}else this._lineDash=null,this._needsDash=!1;return this},b.prototype.setLineDashOffset=function(t){return this._dashOffset=t,this},b.prototype.len=function(){return this._len},b.prototype.setData=function(t){var e=t.length;this.data&&this.data.length===e||!Cl||(this.data=new Float32Array(e));for(var r=0;r<e;r++)this.data[r]=t[r];this._len=e},b.prototype.appendPath=function(t){for(var e=(t=t instanceof Array?t:[t]).length,r=0,i=this._len,n=0;n<e;n++)r+=t[n].len();Cl&&this.data instanceof Float32Array&&(this.data=new Float32Array(i+r));for(n=0;n<e;n++)for(var o=t[n].data,a=0;a<o.length;a++)this.data[i++]=o[a];this._len=i},b.prototype.addData=function(t,e,r,i,n,o,a,s,l){if(this._saveData){var h=this.data;this._len+arguments.length>h.length&&(this._expandData(),h=this.data);for(var u=0;u<arguments.length;u++)h[this._len++]=arguments[u]}},b.prototype._drawPendingPt=function(){0<this._pendingPtDist&&(this._ctx&&this._ctx.lineTo(this._pendingPtX,this._pendingPtY),this._pendingPtDist=0)},b.prototype._expandData=function(){if(!(this.data instanceof Array)){for(var t=[],e=0;e<this._len;e++)t[e]=this.data[e];this.data=t}},b.prototype._dashedLineTo=function(t,e){var r,i,n=this._dashSum,o=this._lineDash,a=this._ctx,s=this._dashOffset,l=this._xi,h=this._yi,u=t-l,c=e-h,d=Sl(u*u+c*c),f=l,p=h,m=o.length;for(s<0&&(s=n+s),f-=(s%=n)*(u/=d),p-=s*(c/=d);0<u&&f<=t||u<0&&t<=f||0===u&&(0<c&&p<=e||c<0&&e<=p);)f+=u*(r=o[i=this._dashIdx]),p+=c*r,this._dashIdx=(i+1)%m,0<u&&f<l||u<0&&l<f||0<c&&p<h||c<0&&h<p||a[i%2?"moveTo":"lineTo"]((0<=u?xl:Tl)(f,t),(0<=c?xl:Tl)(p,e));this._dashOffset=-Sl((u=f-t)*u+(c=p-e)*c)},b.prototype._dashedBezierTo=function(t,e,r,i,n,o){var a,s,l,h,u,c=this._ctx,d=this._dashSum,f=this._dashOffset,p=this._lineDash,m=this._xi,g=this._yi,_=0,y=this._dashIdx,v=p.length,x=0;for(f<0&&(f=d+f),f%=d,a=0;a<1;a+=.1)s=Zs(m,t,r,n,a+.1)-Zs(m,t,r,n,a),l=Zs(g,e,i,o,a+.1)-Zs(g,e,i,o,a),_+=Sl(s*s+l*l);for(;y<v&&!(f<(x+=p[y]));y++);for(a=(x-f)/_;a<=1;)h=Zs(m,t,r,n,a),u=Zs(g,e,i,o,a),y%2?c.moveTo(h,u):c.lineTo(h,u),a+=p[y]/_,y=(y+1)%v;y%2!=0&&c.lineTo(n,o),this._dashOffset=-Sl((s=n-h)*s+(l=o-u)*l)},b.prototype._dashedQuadraticTo=function(t,e,r,i){var n=r,o=i;r=(r+2*t)/3,i=(i+2*e)/3,t=(this._xi+2*t)/3,e=(this._yi+2*e)/3,this._dashedBezierTo(t,e,r,i,n,o)},b.prototype.toStatic=function(){var t;this._saveData&&(this._drawPendingPt(),(t=this.data)instanceof Array)&&(t.length=this._len,Cl)&&11<this._len&&(this.data=new Float32Array(t))},b.prototype.getBoundingRect=function(){gl[0]=gl[1]=yl[0]=yl[1]=Number.MAX_VALUE,_l[0]=_l[1]=vl[0]=vl[1]=-Number.MAX_VALUE;for(var t,e=this.data,r=0,i=0,n=0,o=0,a=0;a<this._len;){var B=e[a++],F=1===a;switch(F&&(n=r=e[a],o=i=e[a+1]),B){case fl.M:r=n=e[a++],i=o=e[a++],yl[0]=n,yl[1]=o,vl[0]=n,vl[1]=o;break;case fl.L:ul(r,i,e[a],e[a+1],yl,vl),r=e[a++],i=e[a++];break;case fl.C:H=G=_=g=k=m=p=f=d=c=U=z=u=h=l=s=void 0;var s=r,l=i,h=e[a++],u=e[a++],z=e[a++],U=e[a++],c=e[a],d=e[a+1],f=yl,p=vl,m=Ks,k=Zs,g=m(s,h,z,c,cl);f[0]=1/0,f[1]=1/0,p[0]=-1/0,p[1]=-1/0;for(var _=0;_<g;_++){var G=k(s,h,z,c,cl[_]);f[0]=rl(G,f[0]),p[0]=il(G,p[0])}for(g=m(l,u,U,d,dl),_=0;_<g;_++){var H=k(l,u,U,d,dl[_]);f[1]=rl(H,f[1]),p[1]=il(H,p[1])}f[0]=rl(s,f[0]),p[0]=il(s,p[0]),f[0]=rl(c,f[0]),p[0]=il(c,p[0]),f[1]=rl(l,f[1]),p[1]=il(l,p[1]),f[1]=rl(d,f[1]),p[1]=il(d,p[1]),r=e[a++],i=e[a++];break;case fl.Q:m=r,N=i,S=e[a++],x=e[a++],w=e[a],y=e[a+1],b=yl,E=vl,t=T=t=v=void 0,v=Js,t=il(rl((T=tl)(m,S,w),1),0),T=il(rl(T(N,x,y),1),0),S=v(m,S,w,t),t=v(N,x,y,T),b[0]=rl(m,w,S),b[1]=rl(N,y,t),E[0]=il(m,w,S),E[1]=il(N,y,t),r=e[a++],i=e[a++];break;case fl.A:var y,v=e[a++],x=e[a++],T=e[a++],b=e[a++],w=e[a++],S=e[a++]+w,E=(a+=1,!e[a++]),M=(F&&(n=bl(w)*T+v,o=wl(w)*b+x),O=y=W=V=I=R=N=P=L=D=C=A=M=void 0,v),A=x,C=T,D=b,L=w,P=S,N=E,R=yl,I=vl,V=rs,W=is;if((y=Math.abs(L-P))%al<1e-4&&1e-4<y)R[0]=M-C,R[1]=A-D,I[0]=M+C,I[1]=A+D;else{sl[0]=ol(L)*C+M,sl[1]=nl(L)*D+A,ll[0]=ol(P)*C+M,ll[1]=nl(P)*D+A,V(R,sl,ll),W(I,sl,ll),(L%=al)<0&&(L+=al),(P%=al)<0&&(P+=al),P<L&&!N?P+=al:L<P&&N&&(L+=al),N&&(y=P,P=L,L=y);for(var O=0;O<P;O+=Math.PI/2)L<O&&(hl[0]=ol(O)*C+M,hl[1]=nl(O)*D+A,V(R,hl,R),W(I,hl,I))}r=bl(S)*T+v,i=wl(S)*b+x;break;case fl.R:ul(n=r=e[a++],o=i=e[a++],n+e[a++],o+e[a++],yl,vl);break;case fl.Z:r=n,i=o}rs(gl,gl,yl),is(_l,_l,vl)}return 0===a&&(gl[0]=gl[1]=_l[0]=_l[1]=0),new Ma(gl[0],gl[1],_l[0]-gl[0],_l[1]-gl[1])},b.prototype._calculateLength=function(){for(var t=this.data,e=this._len,r=this._ux,i=this._uy,n=0,o=0,a=0,s=0,l=(this._pathSegLen||(this._pathSegLen=[]),this._pathSegLen),h=0,u=0,c=0;c<e;){var d=t[c++],f=1===c,p=(f&&(a=n=t[c],s=o=t[c+1]),-1);switch(d){case fl.M:n=a=t[c++],o=s=t[c++];break;case fl.L:var m=t[c++],g=(v=t[c++])-o;(El(A=m-n)>r||El(g)>i||c===e-1)&&(p=Math.sqrt(A*A+g*g),n=m,o=v);break;case fl.C:var _=t[c++],y=t[c++],m=t[c++],v=t[c++],x=t[c++],T=t[c++],p=function(t,e,r,i,n,o,a,s,l){for(var h=t,u=e,c=0,d=1/l,f=1;f<=l;f++){var p=f*d,m=Zs(t,r,n,a,p),p=Zs(e,i,o,s,p),g=m-h,_=p-u;c+=Math.sqrt(g*g+_*_),h=m,u=p}return c}(n,o,_,y,m,v,x,T,10),n=x,o=T;break;case fl.Q:p=function(t,e,r,i,n,o,a){for(var s=t,l=e,h=0,u=1/a,c=1;c<=a;c++){var d=c*u,f=Js(t,r,n,d),d=Js(e,i,o,d),p=f-s,m=d-l;h+=Math.sqrt(p*p+m*m),s=f,l=d}return h}(n,o,_=t[c++],y=t[c++],m=t[c++],v=t[c++],10),n=m,o=v;break;case fl.A:var x=t[c++],T=t[c++],b=t[c++],w=t[c++],S=t[c++],E=t[c++],M=E+S;c+=1,t[c++];f&&(a=bl(S)*b+x,s=wl(S)*w+T),p=Tl(b,w)*xl(Al,Math.abs(E)),n=bl(M)*b+x,o=wl(M)*w+T;break;case fl.R:a=n=t[c++],s=o=t[c++];p=2*t[c++]+2*t[c++];break;case fl.Z:var A=a-n,g=s-o;p=Math.sqrt(A*A+g*g),n=a,o=s}0<=p&&(h+=l[u++]=p)}return this._pathLen=h},b.prototype.rebuildPath=function(t,e){var r,i,n,o,a,s,l,h,u=this.data,B=this._ux,F=this._uy,z=this._len,c=e<1,d=0,f=0,p=0;if(!c||(this._pathSegLen||this._calculateLength(),a=this._pathSegLen,s=e*this._pathLen))t:for(var m=0;m<z;){var U=u[m++],g=1===m;switch(g&&(r=n=u[m],i=o=u[m+1]),U){case fl.M:0<p&&(t.lineTo(l,h),p=0),r=n=u[m++],i=o=u[m++],t.moveTo(n,o);break;case fl.L:var _=u[m++],y=u[m++],v=El(_-n),x=El(y-o);if(B<v||F<x){if(c){if(s<d+(O=a[f++])){var T=(s-d)/O;t.lineTo(n*(1-T)+_*T,o*(1-T)+y*T);break t}d+=O}t.lineTo(_,y),n=_,o=y,p=0}else{v=v*v+x*x;p<v&&(l=_,h=y,p=v)}break;case fl.C:var b=u[m++],w=u[m++],S=u[m++],E=u[m++],x=u[m++],v=u[m++];if(c){if(s<d+(O=a[f++])){Qs(n,b,S,x,T=(s-d)/O,pl),Qs(o,w,E,v,T,ml),t.bezierCurveTo(pl[1],ml[1],pl[2],ml[2],pl[3],ml[3]);break t}d+=O}t.bezierCurveTo(b,w,S,E,x,v),n=x,o=v;break;case fl.Q:b=u[m++],w=u[m++],S=u[m++],E=u[m++];if(c){if(s<d+(O=a[f++])){el(n,b,S,T=(s-d)/O,pl),el(o,w,E,T,ml),t.quadraticCurveTo(pl[1],ml[1],pl[2],ml[2]);break t}d+=O}t.quadraticCurveTo(b,w,S,E),n=S,o=E;break;case fl.A:var M=u[m++],A=u[m++],C=u[m++],D=u[m++],L=u[m++],P=u[m++],N=u[m++],k=!u[m++],G=D<C?C:D,R=.001<El(C-D),I=L+P,H=!1;if(c&&(s<d+(O=a[f++])&&(I=L+P*(s-d)/O,H=!0),d+=O),R&&t.ellipse?t.ellipse(M,A,C,D,N,L,I,k):t.arc(M,A,G,L,I,k),H)break t;g&&(r=bl(L)*C+M,i=wl(L)*D+A),n=bl(I)*C+M,o=wl(I)*D+A;break;case fl.R:r=n=u[m],i=o=u[m+1],_=u[m++],y=u[m++];var O,P=u[m++],R=u[m++];if(c){if(s<d+(O=a[f++])){N=s-d;t.moveTo(_,y),t.lineTo(_+xl(N,P),y),0<(N-=P)&&t.lineTo(_+P,y+xl(N,R)),0<(N-=R)&&t.lineTo(_+Tl(P-N,0),y+R),0<(N-=P)&&t.lineTo(_,y+Tl(R-N,0));break t}d+=O}t.rect(_,y,P,R);break;case fl.Z:if(0<p&&(t.lineTo(l,h),p=0),c){if(s<d+(O=a[f++])){T=(s-d)/O;t.lineTo(n*(1-T)+r*T,o*(1-T)+i*T);break t}d+=O}t.closePath(),n=r,o=i}}},b.CMD=fl,b.initDefaultProps=((d=b.prototype)._saveData=!0,d._needsDash=!1,d._dashOffset=0,d._dashIdx=0,d._dashSum=0,d._ux=0,d._uy=0,d._pendingPtDist=0,void(d._version=0));const Nl=b;function Rl(t,e,r,i,n,o,a){var s;if(0!==n)return s=0,!(e+(n=n)<a&&i+n<a||a<e-n&&a<i-n||t+n<o&&r+n<o||o<t-n&&o<r-n)&&(t===r?Math.abs(o-t)<=n/2:(o=(s=(e-i)/(t-r))*o-a+(t*i-r*e)/(t-r))*o/(s*s+1)<=n/2*n/2)}function Il(t,e,r,i,n,o,a,s,l,h,u){if(0!==l)return!(e+(l=l)<u&&i+l<u&&o+l<u&&s+l<u||u<e-l&&u<i-l&&u<o-l&&u<s-l||t+l<h&&r+l<h&&n+l<h&&a+l<h||h<t-l&&h<r-l&&h<n-l&&h<a-l)&&function(t,e,r,i,n,o,a,s,l,h,u){var c,d,f,p,m=.005,g=1/0;Vs[0]=l,Vs[1]=h;for(var _=0;_<1;_+=.05)Ws[0]=Zs(t,r,n,a,_),Ws[1]=Zs(e,i,o,s,_),(f=ts(Vs,Ws))<g&&(c=_,g=f);for(var g=1/0,y=0;y<32&&!(m<1e-4);y++)d=c+m,Ws[0]=Zs(t,r,n,a,p=c-m),Ws[1]=Zs(e,i,o,s,p),f=ts(Ws,Vs),0<=p&&f<g?(c=p,g=f):(Xs[0]=Zs(t,r,n,a,d),Xs[1]=Zs(e,i,o,s,d),p=ts(Xs,Vs),d<=1&&p<g?(c=d,g=p):m*=.5);return u&&(u[0]=Zs(t,r,n,a,c),u[1]=Zs(e,i,o,s,c)),ks(g)}(t,e,r,i,n,o,a,s,h,u,null)<=l/2}function Ol(t,e,r,i,n,o,a,s,l){if(0!==a)return!(e+(a=a)<l&&i+a<l&&o+a<l||l<e-a&&l<i-a&&l<o-a||t+a<s&&r+a<s&&n+a<s||s<t-a&&s<r-a&&s<n-a)&&function(t,e,r,i,n,o,a,s,l){var h,u=.005,c=1/0;Vs[0]=a,Vs[1]=s;for(var d=0;d<1;d+=.05)Ws[0]=Js(t,r,n,d),Ws[1]=Js(e,i,o,d),(g=ts(Vs,Ws))<c&&(h=d,c=g);for(var c=1/0,f=0;f<32&&!(u<1e-4);f++){var p=h-u,m=h+u,g=(Ws[0]=Js(t,r,n,p),Ws[1]=Js(e,i,o,p),ts(Ws,Vs));0<=p&&g<c?(h=p,c=g):(Xs[0]=Js(t,r,n,m),Xs[1]=Js(e,i,o,m),p=ts(Xs,Vs),m<=1&&p<c?(h=m,c=p):u*=.5)}return l&&(l[0]=Js(t,r,n,h),l[1]=Js(e,i,o,h)),ks(c)}(t,e,r,i,n,o,s,l,null)<=a/2}var Bl=2*Math.PI;function Fl(t){return(t%=Bl)<0&&(t+=Bl),t}var zl=2*Math.PI;function Ul(t,e,r,i,n,o){return e<o&&i<o||o<e&&o<i||i===e?0:(r=(o=(o-e)/(i-e))*(r-t)+t)===n?1/0:n<r?1!=o&&0!=o?i<e?1:-1:i<e?.5:-.5:0}var kl=Nl.CMD,Gl=2*Math.PI,Hl=1e-4;var Vl=[-1,-1,-1],Wl=[-1,-1];function Xl(t,e,r,i,n,o,a,s,l,h){if(e<h&&i<h&&o<h&&s<h||h<e&&h<i&&h<o&&h<s)return 0;p=Vl,f=(f=s)+3*((c=i)-(d=o))-(u=e),_=(d=3*(d-2*c+u))*(c=3*(c-u))-9*f*(u=u-(h=h)),u=c*c-3*d*u,y=0,js(h=d*d-3*f*c)&&js(_)?js(d)?p[0]=0:0<=(m=-c/d)&&m<=1&&(p[y++]=m):js(c=_*_-4*h*u)?(g=-(u=_/h)/2,0<=(m=-d/f+u)&&m<=1&&(p[y++]=m),0<=g&&g<=1&&(p[y++]=g)):0<c?(c=h*d+1.5*f*(-_-(u=ks(c))),0<=(m=(-d-((u=(u=h*d+1.5*f*(-_+u))<0?-Us(-u,1/3):Us(u,1/3))+(c=c<0?-Us(-c,1/3):Us(c,1/3))))/(3*f))&&m<=1&&(p[y++]=m)):(u=(2*h*d-3*f*_)/(2*ks(h*h*h)),c=Math.acos(u)/3,m=(-d-2*(_=ks(h))*(u=Math.cos(c)))/(3*f),g=(-d+_*(u+Hs*Math.sin(c)))/(3*f),h=(-d+_*(u-Hs*Math.sin(c)))/(3*f),0<=m&&m<=1&&(p[y++]=m),0<=g&&g<=1&&(p[y++]=g),0<=h&&h<=1&&(p[y++]=h));var u,c,d,f,p,m,g,_,y,v=y;if(0===v)return 0;for(var x,T=0,b=-1,w=void 0,S=void 0,E=0;E<v;E++){var M=Vl[E],A=0===M||1===M?.5:1;Zs(t,r,n,a,M)<l||(b<0&&(b=Ks(e,i,o,s,Wl),Wl[1]<Wl[0]&&1<b&&(x=void 0,x=Wl[0],Wl[0]=Wl[1],Wl[1]=x),w=Zs(e,i,o,s,Wl[0]),1<b)&&(S=Zs(e,i,o,s,Wl[1])),2===b?M<Wl[0]?T+=w<e?A:-A:M<Wl[1]?T+=S<w?A:-A:T+=s<S?A:-A:M<Wl[0]?T+=w<e?A:-A:T+=s<w?A:-A)}return T}function jl(t,e,r,i,n,o,a,s){if(e<s&&i<s&&o<s||s<e&&s<i&&s<o)return 0;c=Vl,u=(l=e)-2*(h=i)+(u=o),h=2*(h-l),l-=s=s,s=0,js(u)?qs(h)&&0<=(d=-l/h)&&d<=1&&(c[s++]=d):js(l=h*h-4*u*l)?0<=(d=-h/(2*u))&&d<=1&&(c[s++]=d):0<l&&(f=(-h-(l=ks(l)))/(2*u),0<=(d=(-h+l)/(2*u))&&d<=1&&(c[s++]=d),0<=f)&&f<=1&&(c[s++]=f);var l,h,u,c,d,f,p=s;if(0===p)return 0;var m=tl(e,i,o);if(0<=m&&m<=1){for(var g=0,_=Js(e,i,o,m),y=0;y<p;y++){var v=0===Vl[y]||1===Vl[y]?.5:1;Js(t,r,n,Vl[y])<a||(Vl[y]<m?g+=_<e?v:-v:g+=o<_?v:-v)}return g}return v=0===Vl[0]||1===Vl[0]?.5:1,Js(t,r,n,Vl[0])<a?0:o<e?v:-v}function ql(t,e,r,i,n){for(var o,a=t.data,s=t.len(),l=0,h=0,u=0,c=0,d=0,f=0;f<s;){var p=a[f++],m=1===f;switch(p===kl.M&&1<f&&(r||(l+=Ul(h,u,c,d,i,n))),m&&(c=h=a[f],d=u=a[f+1]),p){case kl.M:h=c=a[f++],u=d=a[f++];break;case kl.L:if(r){if(Rl(h,u,a[f],a[f+1],e,i,n))return!0}else l+=Ul(h,u,a[f],a[f+1],i,n)||0;h=a[f++],u=a[f++];break;case kl.C:if(r){if(Il(h,u,a[f++],a[f++],a[f++],a[f++],a[f],a[f+1],e,i,n))return!0}else l+=Xl(h,u,a[f++],a[f++],a[f++],a[f++],a[f],a[f+1],i,n)||0;h=a[f++],u=a[f++];break;case kl.Q:if(r){if(Ol(h,u,a[f++],a[f++],a[f],a[f+1],e,i,n))return!0}else l+=jl(h,u,a[f++],a[f++],a[f],a[f+1],i,n)||0;h=a[f++],u=a[f++];break;case kl.A:var g=a[f++],_=a[f++],y=a[f++],v=a[f++],x=a[f++],T=a[f++],b=(f+=1,!!(1-a[f++])),w=Math.cos(x)*y+g,S=Math.sin(x)*v+_,E=(m?(c=w,d=S):l+=Ul(h,u,w,S,i,n),(i-g)*v/y+g);if(r){if(function(t,e,r,i,n,o,a,s,l){if(0!==a)return a=a,s-=t,l-=e,!(r<(t=Math.sqrt(s*s+l*l))-a||t+a<r)&&(Math.abs(i-n)%zl<1e-4||((n=o?(e=i,i=Fl(n),Fl(e)):(i=Fl(i),Fl(n)))<i&&(n+=zl),(t=Math.atan2(l,s))<0&&(t+=zl),i<=t&&t<=n)||i<=t+zl&&t+zl<=n)}(g,_,v,x,x+T,b,e,E,n))return!0}else l+=function(t,e,r,i,n,o,a,s){if(r<(s-=e)||s<-r)return 0;var e=Math.sqrt(r*r-s*s);if(Vl[0]=-e,Vl[1]=e,(r=Math.abs(i-n))<1e-4)return 0;if(Gl-1e-4<=r)return n=Gl,u=o?1:-1,a>=Vl[i=0]+t&&a<=Vl[1]+t?u:0;n<i&&(e=i,i=n,n=e),i<0&&(i+=Gl,n+=Gl);for(var l=0,h=0;h<2;h++){var u,c=Vl[h];a<c+t&&(u=o?1:-1,i<=(c=(c=Math.atan2(s,c))<0?Gl+c:c)&&c<=n||i<=c+Gl&&c+Gl<=n)&&(l+=u=c>Math.PI/2&&c<1.5*Math.PI?-u:u)}return l}(g,_,v,x,x+T,b,E,n);h=Math.cos(x+T)*y+g,u=Math.sin(x+T)*v+_;break;case kl.R:c=h=a[f++],d=u=a[f++];if(w=c+a[f++],S=d+a[f++],r){if(Rl(c,d,w,d,e,i,n)||Rl(w,d,w,S,e,i,n)||Rl(w,S,c,S,e,i,n)||Rl(c,S,c,d,e,i,n))return!0}else l=(l+=Ul(w,d,w,S,i,n))+Ul(c,S,c,d,i,n);break;case kl.Z:if(r){if(Rl(h,u,c,d,e,i,n))return!0}else l+=Ul(h,u,c,d,i,n);h=c,u=d}}return r||(t=u,o=d,Math.abs(t-o)<Hl)||(l+=Ul(h,u,c,d,i,n)||0),0!==l}var Zl,Yl=Kn({fill:"#000",stroke:null,strokePercent:1,fillOpacity:1,strokeOpacity:1,lineDashOffset:0,lineWidth:1,lineCap:"butt",miterLimit:10,strokeNoScale:!1,strokeFirst:!1},Rs),Kl={style:Kn({fill:!0,stroke:!0,strokePercent:!0,fillOpacity:!0,strokeOpacity:!0,lineDashOffset:!0,lineWidth:!0,miterLimit:!0},Is.style)},Ql=["x","y","rotation","scaleX","scaleY","originX","originY","invisible","culling","z","z2","zlevel","parent"];function w(t){return Zl.call(this,t)||this}aa(w,Zl=gn),w.prototype.update=function(){var e=this,t=(Zl.prototype.update.call(this),this.style);if(t.decal){var r,i=this._decalEl=this._decalEl||new w,n=(i.buildPath===w.prototype.buildPath&&(i.buildPath=function(t){e.buildPath(t,e.shape)}),i.silent=!0,i.style);for(r in t)n[r]!==t[r]&&(n[r]=t[r]);n.fill=t.fill?t.decal:null,n.decal=null,n.shadowColor=null,t.strokeFirst&&(n.stroke=null);for(var o=0;o<Ql.length;++o)i[Ql[o]]=this[Ql[o]];i.__dirty|=1}else this._decalEl&&(this._decalEl=null)},w.prototype.getDecalElement=function(){return this._decalEl},w.prototype._init=function(t){var e=io(t),r=(this.shape=this.getDefaultShape(),this.getDefaultStyle());r&&this.useStyle(r);for(var i=0;i<e.length;i++){var n=e[i],o=t[n];"style"===n?this.style?Yn(this.style,o):this.useStyle(o):"shape"===n?Yn(this.shape,o):Zl.prototype.attrKV.call(this,n,o)}this.style||this.useStyle({})},w.prototype.getDefaultStyle=function(){return null},w.prototype.getDefaultShape=function(){return{}},w.prototype.canBeInsideText=function(){return this.hasFill()},w.prototype.getInsideTextFill=function(){var t,e=this.style.fill;if("none"!==e){if(so(e))return.5<(t=On(e,0))?ps:.2<t?"#eee":ms;if(e)return ms}return ps},w.prototype.getInsideTextStroke=function(t){var e=this.style.fill;if(so(e)){var r=this.__zr;if(!(!r||!r.isDarkMode())==On(t,0)<.4)return e}},w.prototype.buildPath=function(t,e,r){},w.prototype.pathUpdated=function(){this.__dirty&=-5},w.prototype.createPathProxy=function(){this.path=new Nl(!1)},w.prototype.hasStroke=function(){var t=this.style,e=t.stroke;return!(null==e||"none"===e||!(0<t.lineWidth))},w.prototype.hasFill=function(){var t=this.style.fill;return null!=t&&"none"!==t},w.prototype.getBoundingRect=function(){var t,e,r=this._rect,i=this.style,n=!r;return n&&(t=!1,this.path||(t=!0,this.createPathProxy()),e=this.path,(t||4&this.__dirty)&&(e.beginPath(),this.buildPath(e,this.shape,!1),this.pathUpdated()),r=e.getBoundingRect()),this._rect=r,this.hasStroke()&&this.path&&0<this.path.len()?(t=this._rectWithStroke||(this._rectWithStroke=r.clone()),(this.__dirty||n)&&(t.copy(r),e=i.strokeNoScale?this.getLineScale():1,n=i.lineWidth,this.hasFill()||(i=this.strokeContainThreshold,n=Math.max(n,null==i?4:i)),1e-10<e)&&(t.width+=n/e,t.height+=n/e,t.x-=n/e/2,t.y-=n/e/2),t):r},w.prototype.contain=function(t,e){var r=this.transformCoordToLocal(t,e),i=this.getBoundingRect(),n=this.style;if(t=r[0],e=r[1],i.contain(t,e)){r=this.path;if(this.hasStroke()){i=n.lineWidth,n=n.strokeNoScale?this.getLineScale():1;if(1e-10<n&&(this.hasFill()||(i=Math.max(i,this.strokeContainThreshold)),ql(r,i/n,!0,t,e)))return!0}if(this.hasFill())return ql(r,0,!1,t,e)}return!1},w.prototype.dirtyShape=function(){this.__dirty|=4,this._rect&&(this._rect=null),this._decalEl&&this._decalEl.dirtyShape(),this.markRedraw()},w.prototype.dirty=function(){this.dirtyStyle(),this.dirtyShape()},w.prototype.animateShape=function(t){return this.animate("shape",t)},w.prototype.updateDuringAnimation=function(t){"style"===t?this.dirtyStyle():"shape"===t?this.dirtyShape():this.markRedraw()},w.prototype.attrKV=function(t,e){"shape"===t?this.setShape(e):Zl.prototype.attrKV.call(this,t,e)},w.prototype.setShape=function(t,e){var r=(r=this.shape)||(this.shape={});return"string"==typeof t?r[t]=e:Yn(r,t),this.dirtyShape(),this},w.prototype.shapeChanged=function(){return!!(4&this.__dirty)},w.prototype.createStyle=function(t){return So(Yl,t)},w.prototype._innerSaveToNormal=function(t){Zl.prototype._innerSaveToNormal.call(this,t);var e=this._normalState;t.shape&&!e.shape&&(e.shape=Yn({},this.shape))},w.prototype._applyStateObj=function(t,e,r,i,n,o){Zl.prototype._applyStateObj.call(this,t,e,r,i,n,o);var a,s=!(e&&i);if(e&&e.shape?n?i?a=e.shape:(a=Yn({},r.shape),Yn(a,e.shape)):(a=Yn({},(i?this:r).shape),Yn(a,e.shape)):s&&(a=r.shape),a)if(n){this.shape=Yn({},this.shape);for(var l={},h=io(a),u=0;u<h.length;u++){var c=h[u];"object"==typeof a[c]?this.shape[c]=a[c]:l[c]=a[c]}this._transitionState(t,{shape:l},o)}else this.shape=a,this.dirtyShape()},w.prototype._mergeStates=function(t){for(var e,r=Zl.prototype._mergeStates.call(this,t),i=0;i<t.length;i++){var n=t[i];n.shape&&this._mergeStyle(e=e||{},n.shape)}return e&&(r.shape=e),r},w.prototype.getAnimationStyleProps=function(){return Kl},w.prototype.isZeroArea=function(){return!1},w.extend=function(r){aa(n,i=w),n.prototype.getDefaultStyle=function(){return qn(r.style)},n.prototype.getDefaultShape=function(){return qn(r.shape)};var i,t,e=n;function n(t){var e=i.call(this,t)||this;return r.init&&r.init.call(e,t),e}for(t in r)"function"==typeof r[t]&&(e.prototype[t]=r[t]);return e},w.initDefaultProps=((g=w.prototype).type="path",g.strokeContainThreshold=5,g.segmentIgnoreThreshold=0,g.subPixelOptimize=!1,g.autoBatch=!1,void(g.__dirty=7));const Jl=w;var $l,th=Kn({strokeFirst:!0,font:La,x:0,y:0,textAlign:"left",textBaseline:"top",miterLimit:2},Yl),m=(aa(eh,$l=gn),eh.prototype.hasStroke=function(){var t=this.style,e=t.stroke;return null!=e&&"none"!==e&&0<t.lineWidth},eh.prototype.hasFill=function(){var t=this.style.fill;return null!=t&&"none"!==t},eh.prototype.createStyle=function(t){return So(th,t)},eh.prototype.setBoundingRect=function(t){this._rect=t},eh.prototype.getBoundingRect=function(){var t,e=this.style;return this._rect||(null!=(t=e.text)?t+="":t="",(t=function(t,e,r,i){var n=((t||"")+"").split("\n");if(1===n.length)return Ra(n[0],e,r,i);for(var o=new Ma(0,0,0,0),a=0;a<n.length;a++){var s=Ra(n[a],e,r,i);0===a?o.copy(s):o.union(s)}return o}(t,e.font,e.textAlign,e.textBaseline)).x+=e.x||0,t.y+=e.y||0,this.hasStroke()&&(e=e.lineWidth,t.x-=e/2,t.y-=e/2,t.width+=e,t.height+=e),this._rect=t),this._rect},eh.initDefaultProps=void(eh.prototype.dirtyRectTolerance=10),eh);function eh(){return null!==$l&&$l.apply(this,arguments)||this}m.prototype.type="tspan";const rh=m;var ih=Kn({x:0,y:0},Rs),nh={style:Kn({x:!0,y:!0,width:!0,height:!0,sx:!0,sy:!0,sWidth:!0,sHeight:!0},Is.style)};aa(ah,oh=gn),ah.prototype.createStyle=function(t){return So(ih,t)},ah.prototype._getSize=function(t){var e,r=this.style,i=r[t];return null!=i?i:(i=(i=r.image)&&"string"!=typeof i&&i.width&&i.height?r.image:this.__image)?null==(e=r[r="width"===t?"height":"width"])?i[t]:i[t]/i[r]*e:0},ah.prototype.getWidth=function(){return this._getSize("width")},ah.prototype.getHeight=function(){return this._getSize("height")},ah.prototype.getAnimationStyleProps=function(){return nh},ah.prototype.getBoundingRect=function(){var t=this.style;return this._rect||(this._rect=new Ma(t.x||0,t.y||0,this.getWidth(),this.getHeight())),this._rect};var oh,y=ah;function ah(){return null!==oh&&oh.apply(this,arguments)||this}y.prototype.type="image";const sh=y;var lh=Math.round;function hh(t,e,r){var i,n,o;if(e)return i=e.x1,n=e.x2,o=e.y1,e=e.y2,t.x1=i,t.x2=n,t.y1=o,t.y2=e,(r=r&&r.lineWidth)&&(lh(2*i)===lh(2*n)&&(t.x1=t.x2=ch(i,r,!0)),lh(2*o)===lh(2*e))&&(t.y1=t.y2=ch(o,r,!0)),t}function uh(t,e,r){var i,n,o;if(e)return i=e.x,n=e.y,o=e.width,e=e.height,t.x=i,t.y=n,t.width=o,t.height=e,(r=r&&r.lineWidth)&&(t.x=ch(i,r,!0),t.y=ch(n,r,!0),t.width=Math.max(ch(i+o,r,!1)-t.x,0===o?0:1),t.height=Math.max(ch(n+e,r,!1)-t.y,0===e?0:1)),t}function ch(t,e,r){var i;return e?((i=lh(2*t))+lh(e))%2==0?i/2:(i+(r?1:-1))/2:t}var dh,fh=function(){this.x=0,this.y=0,this.width=0,this.height=0},ph={},t=(aa(mh,dh=Jl),mh.prototype.getDefaultShape=function(){return new fh},mh.prototype.buildPath=function(t,e){var r,i,n,o,a,s,l,h,u,c,d,f,p,m;this.subPixelOptimize?(r=(a=uh(ph,e,this.style)).x,i=a.y,n=a.width,o=a.height,a.r=e.r,e=a):(r=e.x,i=e.y,n=e.width,o=e.height),e.r?(a=t,d=(e=e).x,f=e.y,p=e.width,m=e.height,e=e.r,p<0&&(d+=p,p=-p),m<0&&(f+=m,m=-m),"number"==typeof e?s=l=h=u=e:e instanceof Array?1===e.length?s=l=h=u=e[0]:2===e.length?(s=h=e[0],l=u=e[1]):3===e.length?(s=e[0],l=u=e[1],h=e[2]):(s=e[0],l=e[1],h=e[2],u=e[3]):s=l=h=u=0,p<s+l&&(s*=p/(c=s+l),l*=p/c),p<h+u&&(h*=p/(c=h+u),u*=p/c),m<l+h&&(l*=m/(c=l+h),h*=m/c),m<s+u&&(s*=m/(c=s+u),u*=m/c),a.moveTo(d+s,f),a.lineTo(d+p-l,f),0!==l&&a.arc(d+p-l,f+l,l,-Math.PI/2,0),a.lineTo(d+p,f+m-h),0!==h&&a.arc(d+p-h,f+m-h,h,0,Math.PI/2),a.lineTo(d+u,f+m),0!==u&&a.arc(d+u,f+m-u,u,Math.PI/2,Math.PI),a.lineTo(d,f+s),0!==s&&a.arc(d+s,f+s,s,Math.PI,1.5*Math.PI)):t.rect(r,i,n,o)},mh.prototype.isZeroArea=function(){return!this.shape.width||!this.shape.height},mh);function mh(t){return dh.call(this,t)||this}t.prototype.type="rect";const gh=t;var _h,yh={fill:"#000"},vh={style:Kn({fill:!0,stroke:!0,fillOpacity:!0,strokeOpacity:!0,lineWidth:!0,fontSize:!0,lineHeight:!0,width:!0,height:!0,textShadowColor:!0,textShadowBlur:!0,textShadowOffsetX:!0,textShadowOffsetY:!0,backgroundColor:!0,padding:!0,borderColor:!0,borderWidth:!0,borderRadius:!0},Is.style)},xh=(aa(Th,_h=gn),Th.prototype.childrenRef=function(){return this._children},Th.prototype.update=function(){this.styleChanged()&&this._updateSubTexts();for(var t=0;t<this._children.length;t++){var e=this._children[t];e.zlevel=this.zlevel,e.z=this.z,e.z2=this.z2,e.culling=this.culling,e.cursor=this.cursor,e.invisible=this.invisible}var r=this.attachedTransform;r?(r.updateTransform(),(r=r.transform)?(this.transform=this.transform||[],ca(this.transform,r)):this.transform=null):_h.prototype.update.call(this)},Th.prototype.getComputedTransform=function(){return this.__hostTarget&&(this.__hostTarget.getComputedTransform(),this.__hostTarget.updateInnerText(!0)),this.attachedTransform?this.attachedTransform.getComputedTransform():_h.prototype.getComputedTransform.call(this)},Th.prototype._updateSubTexts=function(){var t;this._childCursor=0,Sh(t=this.style),to(t.rich,Sh),this.style.rich?this._updateRichTexts():this._updatePlainTexts(),this._children.length=this._childCursor,this.styleUpdated()},Th.prototype.addSelfToZr=function(t){_h.prototype.addSelfToZr.call(this,t);for(var e=0;e<this._children.length;e++)this._children[e].__zr=t},Th.prototype.removeSelfFromZr=function(t){_h.prototype.removeSelfFromZr.call(this,t);for(var e=0;e<this._children.length;e++)this._children[e].__zr=null},Th.prototype.getBoundingRect=function(){if(this.styleChanged()&&this._updateSubTexts(),!this._rect){for(var t=new Ma(0,0,0,0),e=this._children,r=[],i=null,n=0;n<e.length;n++){var o=e[n],a=o.getBoundingRect(),o=o.getLocalTransform(r);o?(t.copy(a),t.applyTransform(o),(i=i||t.clone()).union(t)):(i=i||a.clone()).union(a)}this._rect=i||t}return this._rect},Th.prototype.setDefaultTextStyle=function(t){this._defaultStyle=t||yh},Th.prototype.setTextContent=function(t){throw new Error("Can't attach text on another text")},Th.prototype._mergeStyle=function(t,e){var r,i;return e&&(r=e.rich,i=t.rich||r&&{},Yn(t,e),r&&i?(this._mergeRich(i,r),t.rich=i):i&&(t.rich=i)),t},Th.prototype._mergeRich=function(t,e){for(var r=io(e),i=0;i<r.length;i++){var n=r[i];t[n]=t[n]||{},Yn(t[n],e[n])}},Th.prototype.getAnimationStyleProps=function(){return vh},Th.prototype._getOrCreateChild=function(t){var e=this._children[this._childCursor];return e&&e instanceof t||(e=new t),(this._children[this._childCursor++]=e).__zr=this.__zr,e.parent=this,e},Th.prototype._updatePlainTexts=function(){for(var t,e,r=this.style,i=r.font||La,n=r.padding,o=function(t,e){null!=t&&(t+="");var r,i=e.overflow,n=e.padding,o=e.font,a="truncate"===i,s=Ba(o),l=co(e.lineHeight,s),h="truncate"===e.lineOverflow,u=e.width,i=(r=null!=u&&"break"===i||"breakAll"===i?t?qa(t,e.font,u,"breakAll"===i,0).lines:[]:t?t.split("\n"):[]).length*l,c=co(e.height,i),h=(c<i&&h&&(h=Math.floor(c/l),r=r.slice(0,h)),c),d=u;if(n&&(h+=n[0]+n[2],null!=d)&&(d+=n[1]+n[3]),t&&a&&null!=d)for(var f=Ua(u,o,e.ellipsis,{minChar:e.truncateMinChar,placeholder:e.placeholder}),p=0;p<r.length;p++)r[p]=ka(r[p],f);if(null==u){for(var m=0,p=0;p<r.length;p++)m=Math.max(Na(r[p],o),m);u=m}return{lines:r,height:c,outerHeight:h,lineHeight:l,calculatedLineHeight:s,contentHeight:i,width:u}}(Ah(r),r),a=Ch(r),s=!!r.backgroundColor,l=o.outerHeight,h=o.lines,u=o.lineHeight,c=this._defaultStyle,d=r.x||0,f=r.y||0,p=r.align||c.align||"left",m=r.verticalAlign||c.verticalAlign||"top",g=d,_=Oa(f,o.contentHeight,m),y=((a||n)&&(t=o.width,n&&(t+=n[1]+n[3]),e=Ia(d,t,p),f=Oa(f,l,m),a)&&this._renderBackground(r,r,e,f,t,l),_+=u/2,n&&(g=Mh(d,p,n),"top"===m?_+=n[0]:"bottom"===m&&(_-=n[2])),0),a=!1,v=(null==(e=("fill"in r?r:(a=!0,c)).fill)||"none"===e?null:e.image||e.colorStops?"#000":e),x=(Eh("stroke"in r?r.stroke:s||c.autoStroke&&!a?null:(y=2,c.stroke))),T=0<r.textShadowBlur,b=null!=r.width&&("truncate"===r.overflow||"break"===r.overflow||"breakAll"===r.overflow),w=o.calculatedLineHeight,S=0;S<h.length;S++){var E=this._getOrCreateChild(rh),M=E.createStyle();E.useStyle(M),M.text=h[S],M.x=g,M.y=_,p&&(M.textAlign=p),M.textBaseline="middle",M.opacity=r.opacity,M.strokeFirst=!0,T&&(M.shadowBlur=r.textShadowBlur||0,M.shadowColor=r.textShadowColor||"transparent",M.shadowOffsetX=r.textShadowOffsetX||0,M.shadowOffsetY=r.textShadowOffsetY||0),x&&(M.stroke=x,M.lineWidth=r.lineWidth||y,M.lineDash=r.lineDash,M.lineDashOffset=r.lineDashOffset||0),v&&(M.fill=v),M.font=i,_+=u,b&&E.setBoundingRect(new Ma(Ia(M.x,r.width,M.textAlign),Oa(M.y,w,M.textBaseline),r.width,w))}},Th.prototype._updateRichTexts=function(){for(var t=this.style,e=Wa(Ah(t),t),r=e.width,i=e.outerWidth,n=e.outerHeight,o=t.padding,a=t.x||0,s=t.y||0,l=this._defaultStyle,h=t.align||l.align,l=t.verticalAlign||l.verticalAlign,a=Ia(a,i,h),h=Oa(s,n,l),u=a,c=h,d=(o&&(u+=o[3],c+=o[0]),u+r),f=(Ch(t)&&this._renderBackground(t,t,a,h,i,n),!!t.backgroundColor),p=0;p<e.lines.length;p++){for(var m=e.lines[p],g=m.tokens,_=g.length,y=m.lineHeight,v=m.width,x=0,T=u,b=d,w=_-1,S=void 0;x<_&&(!(S=g[x]).align||"left"===S.align);)this._placeToken(S,t,y,c,T,"left",f),v-=S.width,T+=S.width,x++;for(;0<=w&&"right"===(S=g[w]).align;)this._placeToken(S,t,y,c,b,"right",f),v-=S.width,b-=S.width,w--;for(T+=(r-(T-u)-(d-b)-v)/2;x<=w;)S=g[x],this._placeToken(S,t,y,c,T+S.width/2,"center",f),T+=S.width,x++;c+=y}},Th.prototype._placeToken=function(t,e,r,i,n,o,a){var s=e.rich[t.styleName]||{},l=(s.text=t.text,t.verticalAlign),h=i+r/2;"top"===l?h=i+t.height/2:"bottom"===l&&(h=i+r-t.height/2);!t.isLineHolder&&Ch(s)&&this._renderBackground(s,e,"right"===o?n-t.width:"center"===o?n-t.width/2:n,h-t.height/2,t.width,t.height);var l=!!s.backgroundColor,i=t.textPadding,r=(i&&(n=Mh(n,o,i),h-=t.height/2-i[0]-t.innerHeight/2),this._getOrCreateChild(rh)),i=r.createStyle(),u=(r.useStyle(i),this._defaultStyle),c=!1,d=0,f=Eh(("fill"in s?s:"fill"in e?e:(c=!0,u)).fill),l=Eh("stroke"in s?s.stroke:"stroke"in e?e.stroke:l||a||u.autoStroke&&!c?null:(d=2,u.stroke)),a=0<s.textShadowBlur||0<e.textShadowBlur,c=(i.text=t.text,i.x=n,i.y=h,a&&(i.shadowBlur=s.textShadowBlur||e.textShadowBlur||0,i.shadowColor=s.textShadowColor||e.textShadowColor||"transparent",i.shadowOffsetX=s.textShadowOffsetX||e.textShadowOffsetX||0,i.shadowOffsetY=s.textShadowOffsetY||e.textShadowOffsetY||0),i.textAlign=o,i.textBaseline="middle",i.font=t.font||La,i.opacity=fo(s.opacity,e.opacity,1),l&&(i.lineWidth=fo(s.lineWidth,e.lineWidth,d),i.lineDash=co(s.lineDash,e.lineDash),i.lineDashOffset=e.lineDashOffset||0,i.stroke=l),f&&(i.fill=f),t.contentWidth),u=t.contentHeight;r.setBoundingRect(new Ma(Ia(i.x,c,i.textAlign),Oa(i.y,u,i.textBaseline),c,u))},Th.prototype._renderBackground=function(t,e,r,i,n,o){var a,s,l,h,u=t.backgroundColor,c=t.borderWidth,d=t.borderColor,f=u&&u.image,p=u&&!f,m=t.borderRadius,g=this,m=((p||c&&d)&&((a=this._getOrCreateChild(gh)).useStyle(a.createStyle()),a.style.fill=null,(l=a.shape).x=r,l.y=i,l.width=n,l.height=o,l.r=m,a.dirtyShape()),p?((h=a.style).fill=u||null,h.fillOpacity=co(t.fillOpacity,1)):f&&((s=this._getOrCreateChild(sh)).onload=function(){g.dirtyStyle()},(l=s.style).image=u.image,l.x=r,l.y=i,l.width=n,l.height=o),c&&d&&((h=a.style).lineWidth=c,h.stroke=d,h.strokeOpacity=co(t.strokeOpacity,1),h.lineDash=t.borderDash,h.lineDashOffset=t.borderDashOffset||0,a.strokeContainThreshold=0,a.hasFill())&&a.hasStroke()&&(h.strokeFirst=!0,h.lineWidth*=2),(a||s).style);m.shadowBlur=t.shadowBlur||0,m.shadowColor=t.shadowColor||"transparent",m.shadowOffsetX=t.shadowOffsetX||0,m.shadowOffsetY=t.shadowOffsetY||0,m.opacity=fo(t.opacity,e.opacity,1)},Th.makeFont=function(t){var e,r="";return(t.fontSize||t.fontFamily||t.fontWeight)&&(e="",e="string"!=typeof t.fontSize||-1===t.fontSize.indexOf("px")&&-1===t.fontSize.indexOf("rem")&&-1===t.fontSize.indexOf("em")?isNaN(+t.fontSize)?"12px":t.fontSize+"px":t.fontSize,r=[t.fontStyle,t.fontWeight,e,t.fontFamily||"sans-serif"].join(" ")),r&&_o(r)||t.textFont||t.font},Th);function Th(t){var e=_h.call(this)||this;return e.type="text",e._children=[],e._defaultStyle=yh,e.attr(t),e}var bh={left:!0,right:1,center:1},wh={top:1,bottom:1,middle:1};function Sh(t){var e;t&&(t.font=xh.makeFont(t),e=t.align,t.align=null==(e="middle"===e?"center":e)||bh[e]?e:"left",e=t.verticalAlign,t.verticalAlign=null==(e="center"===e?"middle":e)||wh[e]?e:"top",t.padding)&&(t.padding=mo(t.padding))}function Eh(t,e){return null==t||e<=0||"transparent"===t||"none"===t?null:t.image||t.colorStops?"#000":t}function Mh(t,e,r){return"right"===e?t-r[1]:"center"===e?t+r[3]/2-r[1]/2:t+r[3]}function Ah(t){t=t.text;return null!=t&&(t+=""),t}function Ch(t){return!!(t.backgroundColor||t.borderWidth&&t.borderColor)}const Dh=xh;function Lh(t,e){switch(t){case"center":case"middle":t="50%";break;case"left":case"top":t="0%";break;case"right":case"bottom":t="100%"}return"string"==typeof t?t.replace(/^\s+|\s+$/g,"").match(/%$/)?parseFloat(t)/100*e:parseFloat(t):null==t?NaN:+t}var Ph="[ECharts] ",Nh={},Rh="undefined"!=typeof console&&console.warn&&console.log;function Ih(t){Nh[t]||Rh&&(Nh[t]=!0,console.warn(Ph+"DEPRECATED: "+t))}function Oh(t,e,r){Ih((r?"["+r+"]":"")+t+" is deprecated, use "+e+" instead.")}function Bh(){var e="__ec_inner_"+Fh++;return function(t){return t[e]||(t[e]={})}}var Fh=Math.round(9*Math.random());Bh(),Bh();new ni(100);Nl.CMD,Math.sqrt,Math.atan2;Math.sqrt,Math.sin,Math.cos,Math.PI;var zh;aa(Uh,zh=Jl),Uh.prototype.applyTransform=function(t){};function Uh(){return null!==zh&&zh.apply(this,arguments)||this}aa(Gh,kh=Ps),Gh.prototype.childrenRef=function(){return this._children},Gh.prototype.children=function(){return this._children.slice()},Gh.prototype.childAt=function(t){return this._children[t]},Gh.prototype.childOfName=function(t){for(var e=this._children,r=0;r<e.length;r++)if(e[r].name===t)return e[r]},Gh.prototype.childCount=function(){return this._children.length},Gh.prototype.add=function(t){if(t&&(t!==this&&t.parent!==this&&(this._children.push(t),this._doAdd(t)),t.__hostTarget))throw"This elemenet has been used as an attachment";return this},Gh.prototype.addBefore=function(t,e){var r;return t&&t!==this&&t.parent!==this&&e&&e.parent===this&&0<=(e=(r=this._children).indexOf(e))&&(r.splice(e,0,t),this._doAdd(t)),this},Gh.prototype.replaceAt=function(t,e){var r=this._children,i=r[e];return t&&t!==this&&t.parent!==this&&t!==i&&(r[e]=t,i.parent=null,(r=this.__zr)&&i.removeSelfFromZr(r),this._doAdd(t)),this},Gh.prototype._doAdd=function(t){t.parent&&t.parent.remove(t);var e=(t.parent=this).__zr;e&&e!==t.__zr&&t.addSelfToZr(e),e&&e.refresh()},Gh.prototype.remove=function(t){var e=this.__zr,r=this._children,i=Qn(r,t);return i<0||(r.splice(i,1),t.parent=null,e&&t.removeSelfFromZr(e),e&&e.refresh()),this},Gh.prototype.removeAll=function(){for(var t=this._children,e=this.__zr,r=0;r<t.length;r++){var i=t[r];e&&i.removeSelfFromZr(e),i.parent=null}return t.length=0,this},Gh.prototype.eachChild=function(t,e){for(var r=this._children,i=0;i<r.length;i++){var n=r[i];t.call(e,n,i)}return this},Gh.prototype.traverse=function(t,e){for(var r=0;r<this._children.length;r++){var i=this._children[r],n=t.call(e,i);i.isGroup&&!n&&i.traverse(t,e)}return this},Gh.prototype.addSelfToZr=function(t){kh.prototype.addSelfToZr.call(this,t);for(var e=0;e<this._children.length;e++)this._children[e].addSelfToZr(t)},Gh.prototype.removeSelfFromZr=function(t){kh.prototype.removeSelfFromZr.call(this,t);for(var e=0;e<this._children.length;e++)this._children[e].removeSelfFromZr(t)},Gh.prototype.getBoundingRect=function(t){for(var e=new Ma(0,0,0,0),r=t||this._children,i=[],n=null,o=0;o<r.length;o++){var a,s=r[o];s.ignore||s.invisible||(a=s.getBoundingRect(),(s=s.getLocalTransform(i))?(Ma.applyTransform(e,a,s),(n=n||e.clone()).union(e)):(n=n||a.clone()).union(a))}return n||e};var kh,d=Gh;function Gh(t){var e=kh.call(this)||this;return e.isGroup=!0,e._children=[],e.attr(t),e}d.prototype.type="group";var Hh,Vh=function(){this.cx=0,this.cy=0,this.r=0},g=(aa(Wh,Hh=Jl),Wh.prototype.getDefaultShape=function(){return new Vh},Wh.prototype.buildPath=function(t,e,r){r&&t.moveTo(e.cx+e.r,e.cy),t.arc(e.cx,e.cy,e.r,0,2*Math.PI)},Wh);function Wh(t){return Hh.call(this,t)||this}g.prototype.type="circle";var Xh,m=g,jh=function(){this.cx=0,this.cy=0,this.rx=0,this.ry=0},y=(aa(qh,Xh=Jl),qh.prototype.getDefaultShape=function(){return new jh},qh.prototype.buildPath=function(t,e){var r=e.cx,i=e.cy,n=e.rx,e=e.ry,o=.5522848*n,a=.5522848*e;t.moveTo(r-n,i),t.bezierCurveTo(r-n,i-a,r-o,i-e,r,i-e),t.bezierCurveTo(r+o,i-e,r+n,i-a,r+n,i),t.bezierCurveTo(r+n,i+a,r+o,i+e,r,i+e),t.bezierCurveTo(r-o,i+e,r-n,i+a,r-n,i),t.closePath()},qh);function qh(t){return Xh.call(this,t)||this}y.prototype.type="ellipse";var t=y,Zh=Math.PI,Yh=2*Zh,Kh=Math.sin,Qh=Math.cos,Jh=Math.acos,$h=Math.atan2,tu=Math.abs,eu=Math.sqrt,ru=Math.max,iu=Math.min,nu=1e-4;function ou(t,e,r,i,n,o,a){var s=t-r,l=e-i,a=(a?o:-o)/eu(s*s+l*l),l=a*l,a=-a*s,s=t+l,t=e+a,e=r+l,r=i+a,i=(s+e)/2,h=(t+r)/2,u=e-s,c=r-t,d=u*u+c*c,o=n-o,s=s*r-e*t,r=(c<0?-1:1)*eu(ru(0,o*o*d-s*s)),e=(s*c-u*r)/d,t=(-s*u-c*r)/d,f=(s*c+u*r)/d,s=(-s*u+c*r)/d,u=e-i,c=t-h,r=f-i,d=s-h;return r*r+d*d<u*u+c*c&&(e=f,t=s),{cx:e,cy:t,x01:-l,y01:-a,x11:e*(n/o-1),y11:t*(n/o-1)}}function au(t,e){var r,i,n,o,a,s,l,h,u,c,d,f,p,m,g,_,y,v,x,T,b,w,S,E=ru(e.r,0),M=ru(e.r0||0,0),A=0<E;(A||0<M)&&(A||(E=M,M=0),E<M&&(A=E,E=M,M=A),A=!!e.clockwise,n=(r=e.startAngle)===(i=e.endAngle)?0:(Pl(n=[r,i],!A),tu(n[0]-n[1])),o=e.cx,a=e.cy,s=e.cornerRadius||0,e=e.innerCornerRadius||0,nu<E?Yh-nu<n?(t.moveTo(o+E*Qh(r),a+E*Kh(r)),t.arc(o,a,E,r,i,!A),nu<M&&(t.moveTo(o+M*Qh(i),a+M*Kh(i)),t.arc(o,a,M,i,r,A))):(l=tu(E-M)/2,s=iu(l,s),e=l=iu(l,e),y=s,h=E*Qh(r),u=E*Kh(r),c=M*Qh(i),d=M*Kh(i),b=T=x=v=void 0,(nu<s||nu<l)&&(v=E*Qh(i),x=E*Kh(i),T=M*Qh(r),b=M*Kh(r),n<Zh)&&(f=function(t,e,r,i,n,o,a,s){var l=(s=s-o)*(r=r-t)-(a=a-n)*(i=i-e);if(!(l*l<nu))return[t+(l=(a*(e-o)-s*(t-n))/l)*r,e+l*i]}(h,u,T,b,v,x,c,d))&&(g=h-f[0],_=u-f[1],p=v-f[0],m=x-f[1],g=1/Kh(Jh((g*p+_*m)/(eu(g*g+_*_)*eu(p*p+m*m)))/2),_=eu(f[0]*f[0]+f[1]*f[1]),e=iu(l,(M-_)/(g-1)),y=iu(s,(E-_)/(1+g))),nu<n?nu<y?(w=ou(T,b,h,u,E,y,A),S=ou(v,x,c,d,E,y,A),t.moveTo(o+w.cx+w.x01,a+w.cy+w.y01),y<s?t.arc(o+w.cx,a+w.cy,y,$h(w.y01,w.x01),$h(S.y01,S.x01),!A):(t.arc(o+w.cx,a+w.cy,y,$h(w.y01,w.x01),$h(w.y11,w.x11),!A),t.arc(o,a,E,$h(w.cy+w.y11,w.cx+w.x11),$h(S.cy+S.y11,S.cx+S.x11),!A),t.arc(o+S.cx,a+S.cy,y,$h(S.y11,S.x11),$h(S.y01,S.x01),!A))):(t.moveTo(o+h,a+u),t.arc(o,a,E,r,i,!A)):t.moveTo(o+h,a+u),nu<M&&nu<n?nu<e?(w=ou(c,d,v,x,M,-e,A),S=ou(h,u,T,b,M,-e,A),t.lineTo(o+w.cx+w.x01,a+w.cy+w.y01),e<l?t.arc(o+w.cx,a+w.cy,e,$h(w.y01,w.x01),$h(S.y01,S.x01),!A):(t.arc(o+w.cx,a+w.cy,e,$h(w.y01,w.x01),$h(w.y11,w.x11),!A),t.arc(o,a,M,$h(w.cy+w.y11,w.cx+w.x11),$h(S.cy+S.y11,S.cx+S.x11),A),t.arc(o+S.cx,a+S.cy,e,$h(S.y11,S.x11),$h(S.y01,S.x01),!A))):(t.lineTo(o+c,a+d),t.arc(o,a,M,i,r,A)):t.lineTo(o+c,a+d)):t.moveTo(o,a),t.closePath())}var su,lu=function(){this.cx=0,this.cy=0,this.r0=0,this.r=0,this.startAngle=0,this.endAngle=2*Math.PI,this.clockwise=!0,this.cornerRadius=0,this.innerCornerRadius=0},d=(aa(hu,su=Jl),hu.prototype.getDefaultShape=function(){return new lu},hu.prototype.buildPath=function(t,e){au(t,e)},hu.prototype.isZeroArea=function(){return this.shape.startAngle===this.shape.endAngle||this.shape.r===this.shape.r0},hu);function hu(t){return su.call(this,t)||this}d.prototype.type="sector";var uu,g=d,cu=function(){this.cx=0,this.cy=0,this.r=0,this.r0=0},y=(aa(du,uu=Jl),du.prototype.getDefaultShape=function(){return new cu},du.prototype.buildPath=function(t,e){var r=e.cx,i=e.cy,n=2*Math.PI;t.moveTo(r+e.r,i),t.arc(r,i,e.r,0,n,!1),t.moveTo(r+e.r0,i),t.arc(r,i,e.r0,0,n,!0)},du);function du(t){return uu.call(this,t)||this}y.prototype.type="ring";d=y;function fu(t,e,r,i,n,o,a){t=.5*(r-t),i=.5*(i-e);return(2*(e-r)+t+i)*a+(-3*(e-r)-2*t-i)*o+t*n+e}function pu(t,e,r){var i=e.smooth,n=e.points;if(n&&2<=n.length){if(i&&"spline"!==i)for(var o=function(t,e,r,i){var n,o,a=[],s=[],l=[],h=[];if(i){for(var u=[1/0,1/0],c=[-1/0,-1/0],d=0,f=t.length;d<f;d++)rs(u,u,t[d]),is(c,c,t[d]);rs(u,u,i[0]),is(c,c,i[1])}for(var p,d=0,f=t.length;d<f;d++){var m=t[d];if(r)n=t[d?d-1:f-1],o=t[(d+1)%f];else{if(0===d||d===f-1){a.push([(p=t[d])[0],p[1]]);continue}n=t[d-1],o=t[d+1]}p=o,_=n,(g=s)[0]=p[0]-_[0],g[1]=p[1]-_[1],Ja(s,s,e);var g=$a(m,n),_=$a(m,o),y=g+_,y=(0!==y&&(g/=y,_/=y),Ja(l,s,-g),Ja(h,s,_),Ya([],m,l)),g=Ya([],m,h);i&&(is(y,y,u),rs(y,y,c),is(g,g,u),rs(g,g,c)),a.push(y),a.push(g)}return r&&a.push(a.shift()),a}(n,i,r,e.smoothConstraint),a=(t.moveTo(n[0][0],n[0][1]),n.length),s=0;s<(r?a:a-1);s++){var l=o[2*s],h=o[2*s+1],u=n[(s+1)%a];t.bezierCurveTo(l[0],l[1],h[0],h[1],u[0],u[1])}else{"spline"===i&&(n=function(t,e){for(var r=t.length,i=[],n=0,o=1;o<r;o++)n+=$a(t[o-1],t[o]);for(var a=(a=n/2)<r?r:a,o=0;o<a;o++){var s=o/(a-1)*(e?r:r-1),l=Math.floor(s),s=s-l,h=void 0,u=t[l%r],c=void 0,d=void 0,d=e?(h=t[(l-1+r)%r],c=t[(l+1)%r],t[(l+2)%r]):(h=t[0===l?l:l-1],c=t[r-2<l?r-1:l+1],t[r-3<l?r-1:l+2]),l=s*s,f=s*l;i.push([fu(h[0],u[0],c[0],d[0],s,l,f),fu(h[1],u[1],c[1],d[1],s,l,f)])}return i}(n,r)),t.moveTo(n[0][0],n[0][1]);for(var s=1,c=n.length;s<c;s++)t.lineTo(n[s][0],n[s][1])}r&&t.closePath()}}var mu,gu=function(){this.points=null,this.smooth=0,this.smoothConstraint=null},y=(aa(_u,mu=Jl),_u.prototype.getDefaultShape=function(){return new gu},_u.prototype.buildPath=function(t,e){pu(t,e,!0)},_u);function _u(t){return mu.call(this,t)||this}y.prototype.type="polygon";var yu,vu=function(){this.points=null,this.percent=1,this.smooth=0,this.smoothConstraint=null},xu=(aa(Tu,yu=Jl),Tu.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},Tu.prototype.getDefaultShape=function(){return new vu},Tu.prototype.buildPath=function(t,e){pu(t,e,!1)},Tu);function Tu(t){return yu.call(this,t)||this}xu.prototype.type="polyline";var bu,wu={},Su=function(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.percent=1},Eu=(aa(Mu,bu=Jl),Mu.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},Mu.prototype.getDefaultShape=function(){return new Su},Mu.prototype.buildPath=function(t,e){o=(this.subPixelOptimize?(r=(o=hh(wu,e,this.style)).x1,i=o.y1,n=o.x2,o):(r=e.x1,i=e.y1,n=e.x2,e)).y2;var r,i,n,o,e=e.percent;0!==e&&(t.moveTo(r,i),e<1&&(n=r*(1-e)+n*e,o=i*(1-e)+o*e),t.lineTo(n,o))},Mu.prototype.pointAt=function(t){var e=this.shape;return[e.x1*(1-t)+e.x2*t,e.y1*(1-t)+e.y2*t]},Mu);function Mu(t){return bu.call(this,t)||this}Eu.prototype.type="line";var Au=[],Cu=function(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.cpx1=0,this.cpy1=0,this.percent=1};function Du(t,e,r){var i=t.cpx2,n=t.cpy2;return null===i||null===n?[(r?Ys:Zs)(t.x1,t.cpx1,t.cpx2,t.x2,e),(r?Ys:Zs)(t.y1,t.cpy1,t.cpy2,t.y2,e)]:[(r?$s:Js)(t.x1,t.cpx1,t.x2,e),(r?$s:Js)(t.y1,t.cpy1,t.y2,e)]}aa(Nu,Lu=Jl),Nu.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},Nu.prototype.getDefaultShape=function(){return new Cu},Nu.prototype.buildPath=function(t,e){var r=e.x1,i=e.y1,n=e.x2,o=e.y2,a=e.cpx1,s=e.cpy1,l=e.cpx2,h=e.cpy2,e=e.percent;0!==e&&(t.moveTo(r,i),null==l||null==h?(e<1&&(el(r,a,n,e,Au),a=Au[1],n=Au[2],el(i,s,o,e,Au),s=Au[1],o=Au[2]),t.quadraticCurveTo(a,s,n,o)):(e<1&&(Qs(r,a,l,n,e,Au),a=Au[1],l=Au[2],n=Au[3],Qs(i,s,h,o,e,Au),s=Au[1],h=Au[2],o=Au[3]),t.bezierCurveTo(a,s,l,h,n,o)))},Nu.prototype.pointAt=function(t){return Du(this.shape,t,!1)},Nu.prototype.tangentAt=function(t){var e,r,t=Du(this.shape,t,!0);return 0===(r=Ka(e=t=t))?(t[0]=0,t[1]=0):(t[0]=e[0]/r,t[1]=e[1]/r),t};var Lu,Pu=Nu;function Nu(t){return Lu.call(this,t)||this}Pu.prototype.type="bezier-curve";var Ru,Iu=function(){this.cx=0,this.cy=0,this.r=0,this.startAngle=0,this.endAngle=2*Math.PI,this.clockwise=!0},Ou=(aa(Bu,Ru=Jl),Bu.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},Bu.prototype.getDefaultShape=function(){return new Iu},Bu.prototype.buildPath=function(t,e){var r=e.cx,i=e.cy,n=Math.max(e.r,0),o=e.startAngle,a=e.endAngle,e=e.clockwise,s=Math.cos(o),l=Math.sin(o);t.moveTo(s*n+r,l*n+i),t.arc(r,i,n,o,a,!e)},Bu);function Bu(t){return Ru.call(this,t)||this}Ou.prototype.type="arc";var Fu;function zu(){var t=null!==Fu&&Fu.apply(this,arguments)||this;return t.type="compound",t}aa(zu,Fu=Jl),zu.prototype._updatePathDirty=function(){for(var t=this.shape.paths,e=this.shapeChanged(),r=0;r<t.length;r++)e=e||t[r].shapeChanged();e&&this.dirtyShape()},zu.prototype.beforeBrush=function(){this._updatePathDirty();for(var t=this.shape.paths||[],e=this.getGlobalScale(),r=0;r<t.length;r++)t[r].path||t[r].createPathProxy(),t[r].path.setScale(e[0],e[1],t[r].segmentIgnoreThreshold)},zu.prototype.buildPath=function(t,e){for(var r=e.paths||[],i=0;i<r.length;i++)r[i].buildPath(t,r[i].shape,!0)},zu.prototype.afterBrush=function(){for(var t=this.shape.paths||[],e=0;e<t.length;e++)t[e].pathUpdated()},zu.prototype.getBoundingRect=function(){return this._updatePathDirty.call(this),Jl.prototype.getBoundingRect.call(this)};function Uu(t){this.colorStops=t||[]}Uu.prototype.addColorStop=function(t,e){this.colorStops.push({offset:t,color:e})};var ku,Gu=Uu;function Hu(t,e,r,i,n,o){n=ku.call(this,n)||this;return n.x=null==t?0:t,n.y=null==e?0:e,n.x2=null==r?1:r,n.y2=null==i?0:i,n.type="linear",n.global=o||!1,n}aa(Hu,ku=Gu);var Vu;function Wu(t,e,r,i,n){i=Vu.call(this,i)||this;return i.x=null==t?.5:t,i.y=null==e?.5:e,i.r=null==r?.5:r,i.type="radial",i.global=n||!1,i}aa(Wu,Vu=Gu);new ga,new ga;var Xu,ju=[];function qu(){var t=null!==Xu&&Xu.apply(this,arguments)||this;return t.notClear=!0,t.incremental=!0,t._displayables=[],t._temporaryDisplayables=[],t._cursor=0,t}aa(qu,Xu=gn),qu.prototype.traverse=function(t,e){t.call(e,this)},qu.prototype.useStyle=function(){this.style={}},qu.prototype.getCursor=function(){return this._cursor},qu.prototype.innerAfterBrush=function(){this._cursor=this._displayables.length},qu.prototype.clearDisplaybles=function(){this._displayables=[],this._temporaryDisplayables=[],this._cursor=0,this.markRedraw(),this.notClear=!1},qu.prototype.clearTemporalDisplayables=function(){this._temporaryDisplayables=[]},qu.prototype.addDisplayable=function(t,e){(e?this._temporaryDisplayables:this._displayables).push(t),this.markRedraw()},qu.prototype.addDisplayables=function(t,e){e=e||!1;for(var r=0;r<t.length;r++)this.addDisplayable(t[r],e)},qu.prototype.getDisplayables=function(){return this._displayables},qu.prototype.getTemporalDisplayables=function(){return this._temporaryDisplayables},qu.prototype.eachPendingDisplayable=function(t){for(var e=this._cursor;e<this._displayables.length;e++)t&&t(this._displayables[e]);for(e=0;e<this._temporaryDisplayables.length;e++)t&&t(this._temporaryDisplayables[e])},qu.prototype.update=function(){this.updateTransform();for(var t=this._cursor;t<this._displayables.length;t++)(e=this._displayables[t]).parent=this,e.update(),e.parent=null;for(var e,t=0;t<this._temporaryDisplayables.length;t++)(e=this._temporaryDisplayables[t]).parent=this,e.update(),e.parent=null},qu.prototype.getBoundingRect=function(){if(!this._rect){for(var t=new Ma(1/0,1/0,-1/0,-1/0),e=0;e<this._displayables.length;e++){var r=this._displayables[e],i=r.getBoundingRect().clone();r.needLocalTransform()&&i.applyTransform(r.getLocalTransform(ju)),t.union(i)}this._rect=t}return this._rect},qu.prototype.contain=function(t,e){var r=this.transformCoordToLocal(t,e);if(this.getBoundingRect().contain(r[0],r[1]))for(var i=0;i<this._displayables.length;i++)if(this._displayables[i].contain(t,e))return!0;return!1};Math.max,Math.min;function Zu(t){t,0}Zu("circle"),Zu("ellipse"),Zu("sector"),Zu("ring"),Zu("polygon"),Zu("polyline"),Zu("rect",gh),Zu("line"),Zu("bezierCurve"),Zu("arc");var Yu={};function Ku(t,e,r,i,n){var o,a={},s=a,l=t,h=r,u=i,c=n;h=h||Yu;var d,t=l.ecModel,f=t&&t.option.textStyle,p=function(t){var e;for(;t&&t!==t.ecModel;){var r=(t.option||Yu).rich;if(r){e=e||{};for(var i=io(r),n=0;n<i.length;n++){var o=i[n];e[o]=1}}t=t.parentModel}return e}(l);if(p)for(var m in d={},p)p.hasOwnProperty(m)&&(o=l.getModel(["rich",m]),tc(d[m]={},o,f,h,u,c,!1,!0));return d&&(s.rich=d),(t=l.get("overflow"))&&(s.overflow=t),null!=(t=l.get("minMargin"))&&(s.margin=t),tc(s,l,f,h,u,c,!0,!1),e&&Yn(a,e),a}var Qu=["fontStyle","fontWeight","fontSize","fontFamily","textShadowColor","textShadowBlur","textShadowOffsetX","textShadowOffsetY"],Ju=["align","lineHeight","width","height","tag","verticalAlign"],$u=["padding","borderWidth","borderRadius","borderDashOffset","backgroundColor","borderColor","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY"];function tc(t,e,r,i,n,o,a,s){r=!n&&r||Yu;var l=i&&i.inheritColor,h=e.getShallow("color"),u=e.getShallow("textBorderColor"),c=co(e.getShallow("opacity"),r.opacity),h=("inherit"!==h&&"auto"!==h||("auto"===h&&Oh("color: 'auto'","color: 'inherit'"),h=l||null),"inherit"!==u&&"auto"!==u||("auto"===u&&Oh("color: 'auto'","color: 'inherit'"),u=l||null),o||(h=h||r.color,u=u||r.textBorderColor),null!=h&&(t.fill=h),null!=u&&(t.stroke=u),co(e.getShallow("textBorderWidth"),r.textBorderWidth)),u=(null!=h&&(t.lineWidth=h),co(e.getShallow("textBorderType"),r.textBorderType)),h=(null!=u&&(t.lineDash=u),co(e.getShallow("textBorderDashOffset"),r.textBorderDashOffset));null!=h&&(t.lineDashOffset=h),null!=(c=n||null!=c||s?c:i&&i.defaultOpacity)&&(t.opacity=c),n||o||null==t.fill&&i.inheritColor&&(t.fill=i.inheritColor);for(var d=0;d<Qu.length;d++){var f=Qu[d];null!=(p=co(e.getShallow(f),r[f]))&&(t[f]=p)}for(var d=0;d<Ju.length;d++){f=Ju[d];null!=(p=e.getShallow(f))&&(t[f]=p)}if(null==t.verticalAlign&&null!=(u=e.getShallow("baseline"))&&(t.verticalAlign=u),!a||!i.disableBox){for(d=0;d<$u.length;d++){var p,f=$u[d];null!=(p=e.getShallow(f))&&(t[f]=p)}h=e.getShallow("borderType");null!=h&&(t.borderDash=h),"auto"!==t.backgroundColor&&"inherit"!==t.backgroundColor||!l||("auto"===t.backgroundColor&&Oh("backgroundColor: 'auto'","backgroundColor: 'inherit'"),t.backgroundColor=l),"auto"!==t.borderColor&&"inherit"!==t.borderColor||!l||("auto"===t.borderColor&&Oh("borderColor: 'auto'","borderColor: 'inherit'"),t.borderColor=l)}}Bh();var ec=A.firstNotNull,rc={left:0,middle:1,right:2};function ic(t){return t=t instanceof Array?t:[t,t]}Gu=P.extend(function(){return{zr:null,viewGL:null,_center:new C,minDistance:.5,maxDistance:1.5,maxOrthographicSize:300,minOrthographicSize:30,minAlpha:-90,maxAlpha:90,minBeta:-1/0,maxBeta:1/0,autoRotateAfterStill:0,autoRotateDirection:"cw",autoRotateSpeed:60,damping:.8,rotateSensitivity:1,zoomSensitivity:1,panSensitivity:1,panMouseButton:"middle",rotateMouseButton:"left",_mode:"rotate",_camera:null,_needsUpdate:!1,_rotating:!1,_phi:0,_theta:0,_mouseX:0,_mouseY:0,_rotateVelocity:new Et,_panVelocity:new Et,_distance:500,_zoomSpeed:0,_stillTimeout:0,_animators:[]}},function(){["_mouseDownHandler","_mouseWheelHandler","_mouseMoveHandler","_mouseUpHandler","_pinchHandler","_contextMenuHandler","_update"].forEach(function(t){this[t]=this[t].bind(this)},this)},{init:function(){var t=this.zr;t&&(t.on("mousedown",this._mouseDownHandler),t.on("globalout",this._mouseUpHandler),t.on("mousewheel",this._mouseWheelHandler),t.on("pinch",this._pinchHandler),t.animation.on("frame",this._update),t.dom.addEventListener("contextmenu",this._contextMenuHandler))},dispose:function(){var t=this.zr;t&&(t.off("mousedown",this._mouseDownHandler),t.off("mousemove",this._mouseMoveHandler),t.off("mouseup",this._mouseUpHandler),t.off("mousewheel",this._mouseWheelHandler),t.off("pinch",this._pinchHandler),t.off("globalout",this._mouseUpHandler),t.dom.removeEventListener("contextmenu",this._contextMenuHandler),t.animation.off("frame",this._update)),this.stopAllAnimation()},getDistance:function(){return this._distance},setDistance:function(t){this._distance=t,this._needsUpdate=!0},getOrthographicSize:function(){return this._orthoSize},setOrthographicSize:function(t){this._orthoSize=t,this._needsUpdate=!0},getAlpha:function(){return this._theta/Math.PI*180},getBeta:function(){return-this._phi/Math.PI*180},getCenter:function(){return this._center.toArray()},setAlpha:function(t){t=Math.max(Math.min(this.maxAlpha,t),this.minAlpha),this._theta=t/180*Math.PI,this._needsUpdate=!0},setBeta:function(t){t=Math.max(Math.min(this.maxBeta,t),this.minBeta),this._phi=-t/180*Math.PI,this._needsUpdate=!0},setCenter:function(t){this._center.setArray(t)},setViewGL:function(t){this.viewGL=t},getCamera:function(){return this.viewGL.camera},setFromViewControlModel:function(e,t){var r=(t=t||{}).baseDistance||0,i=t.baseOrthoSize||1,n=e.get("projection"),n=("perspective"!==n&&"orthographic"!==n&&"isometric"!==n&&(console.error("Unkown projection type %s, use perspective projection instead.",n),n="perspective"),this._projection=n,this.viewGL.setProjection(n),e.get("distance")+r),o=e.get("orthographicSize")+i,a=([["damping",.8],["autoRotate",!1],["autoRotateAfterStill",3],["autoRotateDirection","cw"],["autoRotateSpeed",10],["minDistance",30],["maxDistance",400],["minOrthographicSize",30],["maxOrthographicSize",300],["minAlpha",-90],["maxAlpha",90],["minBeta",-1/0],["maxBeta",1/0],["rotateSensitivity",1],["zoomSensitivity",1],["panSensitivity",1],["panMouseButton","left"],["rotateMouseButton","middle"]].forEach(function(t){this[t[0]]=ec(e.get(t[0]),t[1])},this),this.minDistance+=r,this.maxDistance+=r,this.minOrthographicSize+=i,this.maxOrthographicSize+=i,e.ecModel),s={},r=(["animation","animationDurationUpdate","animationEasingUpdate"].forEach(function(t){s[t]=ec(e.get(t),a&&a.get(t))}),ec(t.alpha,e.get("alpha"))||0),i=ec(t.beta,e.get("beta"))||0,t=ec(t.center,e.get("center"))||[0,0,0];s.animation&&0<s.animationDurationUpdate&&this._notFirst?this.animateTo({alpha:r,beta:i,center:t,distance:n,orthographicSize:o,easing:s.animationEasingUpdate,duration:s.animationDurationUpdate}):(this.setDistance(n),this.setAlpha(r),this.setBeta(i),this.setCenter(t),this.setOrthographicSize(o)),this._notFirst=!0,this._validateProperties()},_validateProperties:function(){null==rc[this.panMouseButton]&&console.error("Unkown panMouseButton %s. It should be left|middle|right",this.panMouseButton),null==rc[this.rotateMouseButton]&&console.error("Unkown rotateMouseButton %s. It should be left|middle|right",this.rotateMouseButton),"cw"!==this.autoRotateDirection&&"ccw"!==this.autoRotateDirection&&console.error("Unkown autoRotateDirection %s. It should be cw|ccw",this.autoRotateDirection)},animateTo:function(t){var e=this.zr,r=this,i={},n={};return null!=t.distance&&(i.distance=this.getDistance(),n.distance=t.distance),null!=t.orthographicSize&&(i.orthographicSize=this.getOrthographicSize(),n.orthographicSize=t.orthographicSize),null!=t.alpha&&(i.alpha=this.getAlpha(),n.alpha=t.alpha),null!=t.beta&&(i.beta=this.getBeta(),n.beta=t.beta),null!=t.center&&(i.center=this.getCenter(),n.center=t.center),this._addAnimator(e.animation.animate(i).when(t.duration||1e3,n).during(function(){null!=i.alpha&&r.setAlpha(i.alpha),null!=i.beta&&r.setBeta(i.beta),null!=i.distance&&r.setDistance(i.distance),null!=i.center&&r.setCenter(i.center),null!=i.orthographicSize&&r.setOrthographicSize(i.orthographicSize),r._needsUpdate=!0})).start(t.easing||"linear")},stopAllAnimation:function(){for(var t=0;t<this._animators.length;t++)this._animators[t].stop();this._animators.length=0},update:function(){this._needsUpdate=!0,this._update(20)},_isAnimating:function(){return 0<this._animators.length},_update:function(t){var e;this._rotating?(e=("cw"===this.autoRotateDirection?1:-1)*this.autoRotateSpeed/180*Math.PI,this._phi-=e*t/1e3,this._needsUpdate=!0):0<this._rotateVelocity.len()&&(this._needsUpdate=!0),(.1<Math.abs(this._zoomSpeed)||0<this._panVelocity.len())&&(this._needsUpdate=!0),this._needsUpdate&&(t=Math.min(t,50),this._updateDistanceOrSize(t),this._updatePan(t),this._updateRotate(t),this._updateTransform(),this.getCamera().update(),this.zr&&this.zr.refresh(),this.trigger("update"),this._needsUpdate=!1)},_updateRotate:function(t){var e=this._rotateVelocity;this._phi=e.y*t/20+this._phi,this._theta=e.x*t/20+this._theta,this.setAlpha(this.getAlpha()),this.setBeta(this.getBeta()),this._vectorDamping(e,Math.pow(this.damping,t/16))},_updateDistanceOrSize:function(t){"perspective"===this._projection?this._setDistance(this._distance+this._zoomSpeed*t/20):this._setOrthoSize(this._orthoSize+this._zoomSpeed*t/20),this._zoomSpeed*=Math.pow(this.damping,t/16)},_setDistance:function(t){this._distance=Math.max(Math.min(t,this.maxDistance),this.minDistance)},_setOrthoSize:function(t){this._orthoSize=Math.max(Math.min(t,this.maxOrthographicSize),this.minOrthographicSize);var t=this.getCamera(),e=this._orthoSize,r=e/this.viewGL.viewport.height*this.viewGL.viewport.width;t.left=-r/2,t.right=r/2,t.top=e/2,t.bottom=-e/2},_updatePan:function(t){var e=this._panVelocity,r=this._distance,i=this.getCamera(),n=i.worldTransform.y,i=i.worldTransform.x;this._center.scaleAndAdd(i,-e.x*r/200).scaleAndAdd(n,-e.y*r/200),this._vectorDamping(e,0)},_updateTransform:function(){var t=this.getCamera(),e=new C,r=this._theta+Math.PI/2,i=this._phi+Math.PI/2,n=Math.sin(r);e.x=n*Math.cos(i),e.y=-Math.cos(r),e.z=n*Math.sin(i),t.position.copy(this._center).scaleAndAdd(e,this._distance),t.rotation.identity().rotateY(-this._phi).rotateX(-this._theta)},_startCountingStill:function(){clearTimeout(this._stillTimeout);var t=this.autoRotateAfterStill,e=this;!isNaN(t)&&0<t&&(this._stillTimeout=setTimeout(function(){e._rotating=!0},1e3*t))},_vectorDamping:function(t,e){var r=t.len();(r*=e)<1e-4&&(r=0),t.normalize().scale(r)},_decomposeTransform:function(){var t,e;this.getCamera()&&(this.getCamera().updateWorldTransform(),e=this.getCamera().worldTransform.z,t=Math.asin(e.y),e=Math.atan2(e.x,e.z),this._theta=t,this._phi=-e,this.setBeta(this.getBeta()),this.setAlpha(this.getAlpha()),this.getCamera().aspect?this._setDistance(this.getCamera().position.dist(this._center)):this._setOrthoSize(this.getCamera().top-this.getCamera().bottom))},_mouseDownHandler:function(t){var e,r;t.target||this._isAnimating()||(e=t.offsetX,r=t.offsetY,this.viewGL&&!this.viewGL.containPoint(e,r))||(this.zr.on("mousemove",this._mouseMoveHandler),this.zr.on("mouseup",this._mouseUpHandler),t.event.targetTouches?1===t.event.targetTouches.length&&(this._mode="rotate"):t.event.button===rc[this.rotateMouseButton]?this._mode="rotate":t.event.button===rc[this.panMouseButton]?this._mode="pan":this._mode="",this._rotateVelocity.set(0,0),this._rotating=!1,this.autoRotate&&this._startCountingStill(),this._mouseX=t.offsetX,this._mouseY=t.offsetY)},_mouseMoveHandler:function(t){var e,r;t.target&&t.target.__isGLToZRProxy||this._isAnimating()||(e=ic(this.panSensitivity),r=ic(this.rotateSensitivity),"rotate"===this._mode?(this._rotateVelocity.y=(t.offsetX-this._mouseX)/this.zr.getHeight()*2*r[0],this._rotateVelocity.x=(t.offsetY-this._mouseY)/this.zr.getWidth()*2*r[1]):"pan"===this._mode&&(this._panVelocity.x=(t.offsetX-this._mouseX)/this.zr.getWidth()*e[0]*400,this._panVelocity.y=(-t.offsetY+this._mouseY)/this.zr.getHeight()*e[1]*400),this._mouseX=t.offsetX,this._mouseY=t.offsetY,t.event.preventDefault())},_mouseWheelHandler:function(t){var e;this._isAnimating()||(e=t.event.wheelDelta||-t.event.detail,this._zoomHandler(t,e))},_pinchHandler:function(t){this._isAnimating()||(this._zoomHandler(t,1<t.pinchScale?1:-1),this._mode="")},_zoomHandler:function(t,e){var r,i;0!==e&&(i=t.offsetX,r=t.offsetY,!this.viewGL||this.viewGL.containPoint(i,r))&&(i="perspective"===this._projection?Math.max(Math.max(Math.min(this._distance-this.minDistance,this.maxDistance-this._distance))/20,.5):Math.max(Math.max(Math.min(this._orthoSize-this.minOrthographicSize,this.maxOrthographicSize-this._orthoSize))/20,.5),this._zoomSpeed=(0<e?-1:1)*i*this.zoomSensitivity,this._rotating=!1,this.autoRotate&&"rotate"===this._mode&&this._startCountingStill(),t.event.preventDefault())},_mouseUpHandler:function(){this.zr.off("mousemove",this._mouseMoveHandler),this.zr.off("mouseup",this._mouseUpHandler)},_isRightMouseButtonUsed:function(){return"right"===this.rotateMouseButton||"right"===this.panMouseButton},_contextMenuHandler:function(t){this._isRightMouseButtonUsed()&&t.preventDefault()},_addAnimator:function(e){var r=this._animators;return r.push(e),e.done(function(){var t=r.indexOf(e);0<=t&&r.splice(t,1)}),e}});Object.defineProperty(Gu.prototype,"autoRotate",{get:function(t){return this._autoRotate},set:function(t){this._autoRotate=t,this._rotating=t}});const nc=Gu;var gn={convertToDynamicArray:function(t){t&&this.resetOffset();var e,r=this.attributes;for(e in r)t||!r[e].value?r[e].value=[]:r[e].value=Array.prototype.slice.call(r[e].value);t||!this.indices?this.indices=[]:this.indices=Array.prototype.slice.call(this.indices)},convertToTypedArray:function(){var t,e=this.attributes;for(t in e)e[t].value&&0<e[t].value.length?e[t].value=new Float32Array(e[t].value):e[t].value=null;this.indices&&0<this.indices.length&&(this.indices=new(65535<this.vertexCount?Uint32Array:Uint16Array)(this.indices)),this.dirty()}},m={vec2:n,vec3:I,vec4:s,mat2:cn,mat2d:fn,mat3:l,mat4:k,quat:u},oc=m.vec3,ac=[[0,0],[1,1]],t=p.extend(function(){return{segmentScale:1,dynamic:!0,useNativeLine:!0,attributes:{position:new p.Attribute("position","float",3,"POSITION"),positionPrev:new p.Attribute("positionPrev","float",3),positionNext:new p.Attribute("positionNext","float",3),prevPositionPrev:new p.Attribute("prevPositionPrev","float",3),prevPosition:new p.Attribute("prevPosition","float",3),prevPositionNext:new p.Attribute("prevPositionNext","float",3),offset:new p.Attribute("offset","float",1),color:new p.Attribute("color","float",4,"COLOR")}}},{resetOffset:function(){this._vertexOffset=0,this._triangleOffset=0,this._itemVertexOffsets=[]},setVertexCount:function(t){var e=this.attributes;this.vertexCount!==t&&(e.position.init(t),e.color.init(t),this.useNativeLine||(e.positionPrev.init(t),e.positionNext.init(t),e.offset.init(t)),65535<t?this.indices instanceof Uint16Array&&(this.indices=new Uint32Array(this.indices)):this.indices instanceof Uint32Array&&(this.indices=new Uint16Array(this.indices)))},setTriangleCount:function(t){this.triangleCount!==t&&(this.indices=0===t?null:new(65535<this.vertexCount?Uint32Array:Uint16Array)(3*t))},_getCubicCurveApproxStep:function(t,e,r,i){return 1/(oc.dist(t,e)+oc.dist(r,e)+oc.dist(i,r)+1)*this.segmentScale},getCubicCurveVertexCount:function(t,e,r,i){t=this._getCubicCurveApproxStep(t,e,r,i),e=Math.ceil(1/t);return this.useNativeLine?2*e:2*e+2},getCubicCurveTriangleCount:function(t,e,r,i){t=this._getCubicCurveApproxStep(t,e,r,i),e=Math.ceil(1/t);return this.useNativeLine?0:2*e},getLineVertexCount:function(){return this.getPolylineVertexCount(ac)},getLineTriangleCount:function(){return this.getPolylineTriangleCount(ac)},getPolylineVertexCount:function(t){return t="number"==typeof t?t:"number"!=typeof t[0]?t.length:t.length/3,this.useNativeLine?2*(t-1):2*(t-1)+2},getPolylineTriangleCount:function(t){return t="number"==typeof t?t:"number"!=typeof t[0]?t.length:t.length/3,this.useNativeLine?0:2*Math.max(t-1,0)},addCubicCurve:function(t,e,r,i,n,o){null==o&&(o=1);for(var a=t[0],s=t[1],l=t[2],h=e[0],u=e[1],c=e[2],d=r[0],f=r[1],p=r[2],m=i[0],g=i[1],_=i[2],y=this._getCubicCurveApproxStep(t,e,r,i),t=y*y,e=t*y,r=3*y,i=3*t,t=6*t,v=6*e,x=a-2*h+d,T=s-2*u+f,b=l-2*c+p,d=3*(h-d)-a+m,f=3*(u-f)-s+g,p=3*(c-p)-l+_,w=a,S=s,E=l,M=(h-a)*r+x*i+d*e,A=(u-s)*r+T*i+f*e,C=(c-l)*r+b*i+p*e,D=x*t+d*v,L=T*t+f*v,P=b*t+p*v,B=d*v,F=f*v,z=p*v,U=0,N=0,R=Math.ceil(1/y),I=new Float32Array(3*(R+1)),I=[],O=0,N=0;N<R+1;N++)I[O++]=w,I[O++]=S,I[O++]=E,w+=M,S+=A,E+=C,M+=D,A+=L,C+=P,D+=B,L+=F,P+=z,1<(U+=y)&&(w=0<M?Math.min(w,m):Math.max(w,m),S=0<A?Math.min(S,g):Math.max(S,g),E=0<C?Math.min(E,_):Math.max(E,_));return this.addPolyline(I,n,o)},addLine:function(t,e,r,i){return this.addPolyline([t,e],r,i)},addPolyline:function(t,e,r,i,n){if(t.length){var o="number"!=typeof t[0];if(!((n=null==n?o?t.length:t.length/3:n)<2)){null==i&&(i=0),null==r&&(r=1),this._itemVertexOffsets.push(this._vertexOffset);var a=(o="number"!=typeof t[0])?"number"!=typeof e[0]:e.length/4===n,s=this.attributes.position,l=this.attributes.positionPrev,h=this.attributes.positionNext,u=this.attributes.color,c=this.attributes.offset,d=this.indices,f=this._vertexOffset;r=Math.max(r,.01);for(var p,m,g,_,y=i;y<n;y++)o?(m=t[y],p=a?e[y]:e):((m=m||[])[0]=t[g=3*y],m[1]=t[1+g],m[2]=t[2+g],a?((p=p||[])[0]=e[g=4*y],p[1]=e[1+g],p[2]=e[2+g],p[3]=e[3+g]):p=e),this.useNativeLine?1<y&&(s.copy(f,f-1),u.copy(f,f-1),f++):(y<n-1&&(l.set(f+2,m),l.set(f+3,m)),0<y&&(h.set(f-2,m),h.set(f-1,m)),s.set(f,m),s.set(f+1,m),u.set(f,p),u.set(f+1,p),c.set(f,r/2),c.set(f+1,-r/2),f+=2),this.useNativeLine?(u.set(f,p),s.set(f,m),f++):0<y&&(g=3*this._triangleOffset,(d=this.indices)[g]=f-4,d[1+g]=f-3,d[2+g]=f-2,d[3+g]=f-3,d[4+g]=f-1,d[5+g]=f-2,this._triangleOffset+=2);return this.useNativeLine||(i=this._vertexOffset,_=this._vertexOffset+2*n,l.copy(i,i+2),l.copy(i+1,i+3),h.copy(_-1,_-3),h.copy(_-2,_-4)),this._vertexOffset=f,this._vertexOffset}}},setItemColor:function(t,e){for(var r=this._itemVertexOffsets[t],i=t<this._itemVertexOffsets.length-1?this._itemVertexOffsets[t+1]:this._vertexOffset,n=r;n<i;n++)this.attributes.color.set(n,e);this.dirty("color")},currentTriangleOffset:function(){return this._triangleOffset},currentVertexOffset:function(){return this._vertexOffset}});O.util.defaults(t.prototype,gn);const sc=t;function lc(t,e,r,i,n,o,a){this._zr=t,this._x=0,this._y=0,this._rowHeight=0,this.width=i,this.height=n,this.offsetX=e,this.offsetY=r,this.dpr=a,this.gap=o}function hc(t){(t=t||{}).width=t.width||512,t.height=t.height||512,t.devicePixelRatio=t.devicePixelRatio||1,t.gap=null==t.gap?2:t.gap;var e=document.createElement("canvas"),r=(e.width=t.width*t.devicePixelRatio,e.height=t.height*t.devicePixelRatio,this._canvas=e,this._texture=new F({image:e,flipY:!1}),this),i=(this._zr=O.zrender.init(e),this._zr.refreshImmediately);this._zr.refreshImmediately=function(){i.call(this),r._texture.dirty(),r.onupdate&&r.onupdate()},this._dpr=t.devicePixelRatio,this._coords={},this.onupdate=t.onupdate,this._gap=t.gap,this._textureAtlasNodes=[new lc(this._zr,0,0,t.width,t.height,this._gap,this._dpr)],this._nodeWidth=t.width,this._nodeHeight=t.height,this._currentNodeIdx=0}lc.prototype={constructor:lc,clear:function(){this._x=0,this._y=0,this._rowHeight=0},add:function(t,e,r){var i=t.getBoundingRect(),i=(null==e&&(e=i.width),null==r&&(r=i.height),e*=this.dpr,r*=this.dpr,this._fitElement(t,e,r),this._x),n=this._y,o=this.width*this.dpr,a=this.height*this.dpr,s=this.gap;if(o<i+e+s&&(i=this._x=0,n+=this._rowHeight+s,this._y=n,this._rowHeight=0),this._x+=e+s,this._rowHeight=Math.max(this._rowHeight,r),a<n+r+s)return null;t.x+=this.offsetX*this.dpr+i,t.y+=this.offsetY*this.dpr+n,this._zr.add(t);s=[this.offsetX/this.width,this.offsetY/this.height];return[[i/o+s[0],n/a+s[1]],[(i+e)/o+s[0],(n+r)/a+s[1]]]},_fitElement:function(t,e,r){var i=t.getBoundingRect(),e=e/i.width,r=r/i.height;t.x=-i.x*e,t.y=-i.y*r,t.scaleX=e,t.scaleY=r,t.update()}},hc.prototype={clear:function(){for(var t=0;t<this._textureAtlasNodes.length;t++)this._textureAtlasNodes[t].clear();this._currentNodeIdx=0,this._zr.clear(),this._coords={}},getWidth:function(){return this._width},getHeight:function(){return this._height},getTexture:function(){return this._texture},getDevicePixelRatio:function(){return this._dpr},getZr:function(){return this._zr},_getCurrentNode:function(){return this._textureAtlasNodes[this._currentNodeIdx]},_expand:function(){if(this._currentNodeIdx++,this._textureAtlasNodes[this._currentNodeIdx])return this._textureAtlasNodes[this._currentNodeIdx];var e=4096/this._dpr,t=this._textureAtlasNodes.length,r=t*this._nodeWidth%e,t=Math.floor(t*this._nodeWidth/e)*this._nodeHeight;if(!(e<=t)){var e=(r+this._nodeWidth)*this._dpr,i=(t+this._nodeHeight)*this._dpr;try{this._zr.resize({width:e,height:i})}catch(t){this._canvas.width=e,this._canvas.height=i}e=new lc(this._zr,r,t,this._nodeWidth,this._nodeHeight,this._gap,this._dpr);return this._textureAtlasNodes.push(e),e}console.error("Too much labels. Some will be ignored.")},add:function(t,e,r){if(this._coords[t.id])return console.warn("Element already been add"),this._coords[t.id];var i=this._getCurrentNode().add(t,e,r);if(!i){var n=this._expand();if(!n)return;i=n.add(t,e,r)}return this._coords[t.id]=i},getCoordsScale:function(){var t=this._dpr;return[this._nodeWidth/this._canvas.width*t,this._nodeHeight/this._canvas.height*t]},getCoords:function(t){return this._coords[t]},dispose:function(){this._zr.dispose()}};const uc=hc;function cc(){}cc.prototype={constructor:cc,setScene:function(t){this._scene=t,this._skybox&&this._skybox.attachScene(this._scene)},initLight:function(t){this._lightRoot=t,this.mainLight=new q.DirectionalLight({shadowBias:.005}),this.ambientLight=new q.AmbientLight,t.add(this.mainLight),t.add(this.ambientLight)},dispose:function(){this._lightRoot&&(this._lightRoot.remove(this.mainLight),this._lightRoot.remove(this.ambientLight))},updateLight:function(t){var e=this.mainLight,r=this.ambientLight,t=t.getModel("light"),i=t.getModel("main"),t=t.getModel("ambient"),r=(e.intensity=i.get("intensity"),r.intensity=t.get("intensity"),e.color=q.parseColor(i.get("color")).slice(0,3),r.color=q.parseColor(t.get("color")).slice(0,3),i.get("alpha")||0),t=i.get("beta")||0;e.position.setArray(q.directionFromAlphaBeta(r,t)),e.lookAt(q.Vector3.ZERO),e.castShadow=i.get("shadow"),e.shadowResolution=q.getShadowResolution(i.get("shadowQuality"))},updateAmbientCubemap:function(t,e,r){var i,n,e=e.getModel("light.ambientCubemap"),o=e.get("texture");o?(this._cubemapLightsCache=this._cubemapLightsCache||{},(n=this._cubemapLightsCache[o])||(n=(i=this)._cubemapLightsCache[o]=q.createAmbientCubemap(e.option,t,r,function(){i._isSkyboxFromAmbientCubemap&&i._skybox.setEnvironmentMap(n.specular.cubemap),r.getZr().refresh()})),this._lightRoot.add(n.diffuse),this._lightRoot.add(n.specular),this._currentCubemapLights=n):this._currentCubemapLights&&(this._lightRoot.remove(this._currentCubemapLights.diffuse),this._lightRoot.remove(this._currentCubemapLights.specular),this._currentCubemapLights=null)},updateSkybox:function(t,e,r){var i=e.get("environment"),n=this;n._skybox=n._skybox||new Ai;var o,a,n=n._skybox,s=(i&&"none"!==i?"auto"===i?(this._isSkyboxFromAmbientCubemap=!0,this._currentCubemapLights?(s=this._currentCubemapLights.specular.cubemap,n.setEnvironmentMap(s),this._scene&&n.attachScene(this._scene),n.material.set("lod",3)):this._skybox&&this._skybox.detachScene()):("object"==typeof i&&i.colorStops||"string"==typeof i&&O.color.parse(i)?(this._isSkyboxFromAmbientCubemap=!1,o=new q.Texture2D({anisotropic:8,flipY:!1}),n.setEnvironmentMap(o),(s=o.image=document.createElement("canvas")).width=s.height=16,s=s.getContext("2d"),a=new O.graphic.Rect({shape:{x:0,y:0,width:16,height:16},style:{fill:i}}),O.innerDrawElementOnCanvas(s,a)):(this._isSkyboxFromAmbientCubemap=!1,o=q.loadTexture(i,r,{anisotropic:8,flipY:!1}),n.setEnvironmentMap(o)),n.attachScene(this._scene)):(this._skybox&&this._skybox.detachScene(this._scene),this._skybox=null),e.coordinateSystem);this._skybox&&(!s||!s.viewGL||"auto"===i||i.match&&i.match(/.hdr$/)?this._skybox.material.undefine("fragment","SRGB_DECODE"):(a=s.viewGL.isLinearSpace()?"define":"undefine",this._skybox.material[a]("fragment","SRGB_DECODE")))}};const dc=cc;var fc,pc,mc,gc,_c=m.vec3,g=p.extend(function(){return{segmentScale:1,useNativeLine:!0,attributes:{position:new p.Attribute("position","float",3,"POSITION"),normal:new p.Attribute("normal","float",3,"NORMAL"),color:new p.Attribute("color","float",4,"COLOR")}}},{resetOffset:function(){this._vertexOffset=0,this._faceOffset=0},setQuadCount:function(t){var e=this.attributes,r=this.getQuadVertexCount()*t,t=this.getQuadTriangleCount()*t;this.vertexCount!==r&&(e.position.init(r),e.normal.init(r),e.color.init(r)),this.triangleCount!==t&&(this.indices=new(65535<r?Uint32Array:Uint16Array)(3*t))},getQuadVertexCount:function(){return 4},getQuadTriangleCount:function(){return 2},addQuad:(fc=_c.create(),pc=_c.create(),mc=_c.create(),gc=[0,3,1,3,2,1],function(t,e){var r=this.attributes.position,i=this.attributes.normal,n=this.attributes.color;_c.sub(fc,t[1],t[0]),_c.sub(pc,t[2],t[1]),_c.cross(mc,fc,pc),_c.normalize(mc,mc);for(var o=0;o<4;o++)r.set(this._vertexOffset+o,t[o]),n.set(this._vertexOffset+o,e),i.set(this._vertexOffset+o,mc);for(var a=3*this._faceOffset,o=0;o<6;o++)this.indices[a+o]=gc[o]+this._vertexOffset;this._vertexOffset+=4,this._faceOffset+=2})});O.util.defaults(g.prototype,gn);const yc=g;var vc=A.firstNotNull,xc={x:0,y:2,z:1};function Tc(t,e,r){this.rootNode=new q.Node;e=new q.Mesh({geometry:new sc({useNativeLine:!1}),material:e,castShadow:!1,ignorePicking:!0,$ignorePicking:!0,renderOrder:1}),r=new q.Mesh({geometry:new yc,material:r,castShadow:!1,culling:!1,ignorePicking:!0,$ignorePicking:!0,renderOrder:0});this.rootNode.add(r),this.rootNode.add(e),this.faceInfo=t,this.plane=new q.Plane,this.linesMesh=e,this.quadsMesh=r}Tc.prototype.update=function(t,e,r){var i=t.coordinateSystem,n=[i.getAxis(this.faceInfo[0]),i.getAxis(this.faceInfo[1])],o=this.linesMesh.geometry,a=this.quadsMesh.geometry,n=(o.convertToDynamicArray(!0),a.convertToDynamicArray(!0),this._updateSplitLines(o,n,t,r),this._udpateSplitAreas(a,n,t,r),o.convertToTypedArray(),a.convertToTypedArray(),i.getAxis(this.faceInfo[2]));t=this.rootNode,r=this.plane,o=n,a=this.faceInfo[3],i=[0,0,0],n=a<0?o.getExtentMin():o.getExtentMax(),i[xc[o.dim]]=n,t.position.setArray(i),t.rotation.identity(),r.distance=-Math.abs(n),r.normal.set(0,0,0),"x"===o.dim?(t.rotation.rotateY(a*Math.PI/2),r.normal.x=-a):"z"===o.dim?(t.rotation.rotateX(-a*Math.PI/2),r.normal.y=-a):(0<a&&t.rotation.rotateY(Math.PI),r.normal.z=-a)},Tc.prototype._updateSplitLines=function(m,g,_,t){var y=t.getDevicePixelRatio();g.forEach(function(t,e){var r=t.model,i=g[1-e].getExtent();if(!t.scale.isBlank()){r=r.getModel("splitLine",_.getModel("splitLine"));if(r.get("show"))for(var n=r.getModel("lineStyle"),o=n.get("color"),a=vc(n.get("opacity"),1),s=vc(n.get("width"),1),o=O.util.isArray(o)?o:[o],l=t.getTicksCoords({tickModel:r}),h=0,u=0;u<l.length;u++){var c=l[u].coord,d=q.parseColor(o[h%o.length]),f=(d[3]*=a,[0,0,0]),p=[0,0,0];f[e]=p[e]=c,f[1-e]=i[0],p[1-e]=i[1],m.addLine(f,p,d,s*y),h++}}})},Tc.prototype._udpateSplitAreas=function(m,g,_,t){g.forEach(function(t,e){var r=t.model,i=g[1-e].getExtent();if(!t.scale.isBlank()){r=r.getModel("splitArea",_.getModel("splitArea"));if(r.get("show"))for(var n=r.getModel("areaStyle"),o=n.get("color"),a=vc(n.get("opacity"),1),o=O.util.isArray(o)?o:[o],s=t.getTicksCoords({tickModel:r,clamp:!0}),l=0,h=[0,0,0],u=[0,0,0],c=0;c<s.length;c++){var d=s[c].coord,f=[0,0,0],p=[0,0,0];f[e]=p[e]=d,f[1-e]=i[0],p[1-e]=i[1],0===c?(h=f,u=p):((d=q.parseColor(o[l%o.length]))[3]*=a,m.addQuad([h,f,p,u],d),h=f,u=p,l++)}}})};const bc=Tc;var wc=[0,1,2,0,2,3],d=p.extend(function(){return{attributes:{position:new p.Attribute("position","float",3,"POSITION"),texcoord:new p.Attribute("texcoord","float",2,"TEXCOORD_0"),offset:new p.Attribute("offset","float",2),color:new p.Attribute("color","float",4,"COLOR")}}},{resetOffset:function(){this._vertexOffset=0,this._faceOffset=0},setSpriteCount:function(t){var e=4*(this._spriteCount=t),t=2*t;this.vertexCount!==e&&(this.attributes.position.init(e),this.attributes.offset.init(e),this.attributes.color.init(e)),this.triangleCount!==t&&(this.indices=new(65535<e?Uint32Array:Uint16Array)(3*t))},setSpriteAlign:function(t,e,r,i,n){var o,a,s,l;switch(null==i&&(i="top"),n=n||0,r=null==r?"left":r){case"left":o=n,s=e[0]+n;break;case"center":case"middle":o=-e[0]/2,s=e[0]/2;break;case"right":o=-e[0]-n,s=-n}switch(i){case"bottom":a=n,l=e[1]+n;break;case"middle":a=-e[1]/2,l=e[1]/2;break;case"top":a=-e[1]-n,l=-n}r=4*t,i=this.attributes.offset;i.set(r,[o,l]),i.set(1+r,[s,l]),i.set(2+r,[s,a]),i.set(3+r,[o,a])},addSprite:function(t,e,r,i,n,o){var a=this._vertexOffset;this.setSprite(this._vertexOffset/4,t,e,r,i,n,o);for(var s=0;s<wc.length;s++)this.indices[3*this._faceOffset+s]=wc[s]+a;return this._faceOffset+=2,this._vertexOffset+=4,a/4},setSprite:function(t,e,r,i,n,o,a){for(var s=4*t,l=this.attributes,h=0;h<4;h++)l.position.set(s+h,e);var u=l.texcoord;u.set(s,[i[0][0],i[0][1]]),u.set(1+s,[i[1][0],i[0][1]]),u.set(2+s,[i[1][0],i[1][1]]),u.set(3+s,[i[0][0],i[1][1]]),this.setSpriteAlign(t,r,n,o,a)}});O.util.defaults(d.prototype,gn);const Sc=d;q.Shader.import("@export ecgl.labels.vertex\n\nattribute vec3 position: POSITION;\nattribute vec2 texcoord: TEXCOORD_0;\nattribute vec2 offset;\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n#endif\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform vec4 viewport : VIEWPORT;\n\nvarying vec2 v_Texcoord;\n\nvoid main()\n{\n vec4 proj = worldViewProjection * vec4(position, 1.0);\n\n vec2 screen = (proj.xy / abs(proj.w) + 1.0) * 0.5 * viewport.zw;\n\n screen += offset;\n\n proj.xy = (screen / viewport.zw - 0.5) * 2.0 * abs(proj.w);\n gl_Position = proj;\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n v_Texcoord = texcoord;\n}\n@end\n\n\n@export ecgl.labels.fragment\n\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\nuniform sampler2D textureAtlas;\nuniform vec2 uvScale: [1.0, 1.0];\n\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\nvarying float v_Miter;\n\nvarying vec2 v_Texcoord;\n\nvoid main()\n{\n gl_FragColor = vec4(color, alpha) * texture2D(textureAtlas, v_Texcoord * uvScale);\n#ifdef VERTEX_COLOR\n gl_FragColor *= v_Color;\n#endif\n}\n\n@end");const Ec=q.Mesh.extend(function(){return{geometry:new Sc({dynamic:!0}),material:new q.Material({shader:q.createShader("ecgl.labels"),transparent:!0,depthMask:!1}),culling:!1,castShadow:!1,ignorePicking:!0}});var Mc=A.firstNotNull,Ac={x:0,y:2,z:1};function Cc(t,e){var e=new q.Mesh({geometry:new sc({useNativeLine:!1}),material:e,castShadow:!1,ignorePicking:!0,renderOrder:2}),r=new Ec,i=(r.material.depthMask=!1,new q.Node);i.add(e),i.add(r),this.rootNode=i,this.dim=t,this.linesMesh=e,this.labelsMesh=r,this.axisLineCoords=null,this.labelElements=[]}var Dc={x:"y",y:"x",z:"y"};Cc.prototype.update=function(t,e,r){var i=t.coordinateSystem.getAxis(this.dim),n=this.linesMesh.geometry,o=this.labelsMesh.geometry,a=(n.convertToDynamicArray(!0),o.convertToDynamicArray(!0),i.model),s=i.getExtent(),l=r.getDevicePixelRatio(),h=a.getModel("axisLine",t.getModel("axisLine")),u=a.getModel("axisTick",t.getModel("axisTick")),c=a.getModel("axisLabel",t.getModel("axisLabel")),d=h.get("lineStyle.color");if(h.get("show")&&(t=h.getModel("lineStyle"),x=[0,0,0],(v=[0,0,0])[T=Ac[i.dim]]=s[0],x[T]=s[1],this.axisLineCoords=[v,x],h=q.parseColor(d),p=Mc(t.get("width"),1),t=Mc(t.get("opacity"),1),h[3]*=t,n.addLine(v,x,h,p*l)),u.get("show"))for(var t=u.getModel("lineStyle"),f=q.parseColor(Mc(t.get("color"),d)),p=Mc(t.get("width"),1),m=(f[3]*=Mc(t.get("opacity"),1),i.getTicksCoords()),g=u.get("length"),_=0;_<m.length;_++){var y=m[_].coord,v=[0,0,0],x=[0,0,0],T=Ac[i.dim],b=Ac[Dc[i.dim]];v[T]=x[T]=y,x[b]=g,n.addLine(v,x,f,p*l)}this.labelElements=[];l=r.getDevicePixelRatio();if(c.get("show"))for(var m=i.getTicksCoords(),w=a.get("data"),S=c.get("margin"),E=i.getViewLabels(),_=0;_<E.length;_++){var M=E[_].tickValue,A=E[_].formattedLabel,C=E[_].rawLabel,y=i.dataToCoord(M),D=[0,0,0],T=Ac[i.dim],b=Ac[Dc[i.dim]],L=(D[T]=D[T]=y,D[b]=S,c),P=(w&&w[M]&&w[M].textStyle&&(L=new O.Model(w[M].textStyle,c,a.ecModel)),Mc(L.get("color"),d)),N=new O.graphic.Text({style:Ku(L,{text:A,fill:"function"==typeof P?P("category"===i.type?C:"value"===i.type?M+"":M,_):P,verticalAlign:"top",align:"left"})}),R=e.add(N),I=N.getBoundingRect();o.addSprite(D,[I.width*l,I.height*l],R),this.labelElements.push(N)}a.get("name")&&(h=a.getModel("nameTextStyle"),D=[0,0,0],T=Ac[i.dim],b=Ac[Dc[i.dim]],t=Mc(h.get("color"),d),u=h.get("borderColor"),p=h.get("borderWidth"),D[T]=D[T]=(s[0]+s[1])/2,D[b]=a.get("nameGap"),N=new O.graphic.Text({style:Ku(h,{text:a.get("name"),fill:t,stroke:u,lineWidth:p})}),R=e.add(N),I=N.getBoundingRect(),o.addSprite(D,[I.width*l,I.height*l],R),N.__idx=this.labelElements.length,this.nameLabelElement=N),this.labelsMesh.material.set("textureAtlas",e.getTexture()),this.labelsMesh.material.set("uvScale",e.getCoordsScale()),n.convertToTypedArray(),o.convertToTypedArray()},Cc.prototype.setSpriteAlign=function(t,e,r){for(var i=r.getDevicePixelRatio(),n=this.labelsMesh.geometry,o=0;o<this.labelElements.length;o++){var a=this.labelElements[o].getBoundingRect();n.setSpriteAlign(o,[a.width*i,a.height*i],t,e)}r=this.nameLabelElement;r&&(a=r.getBoundingRect(),n.setSpriteAlign(r.__idx,[a.width*i,a.height*i],t,e),n.dirty()),this.textAlign=t,this.textVerticalAlign=e};const Lc=Cc;var y="@export ecgl.lines3D.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position: POSITION;\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n\nvoid main()\n{\n gl_Position = worldViewProjection * vec4(position, 1.0);\n v_Color = a_Color;\n}\n\n@end\n\n@export ecgl.lines3D.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nvarying vec4 v_Color;\n\n@import clay.util.srgb\n\nvoid main()\n{\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(color * v_Color);\n#else\n gl_FragColor = color * v_Color;\n#endif\n}\n@end\n\n\n\n@export ecgl.lines3D.clipNear\n\nvec4 clipNear(vec4 p1, vec4 p2) {\n float n = (p1.w - near) / (p1.w - p2.w);\n return vec4(mix(p1.xy, p2.xy, n), -near, near);\n}\n\n@end\n\n@export ecgl.lines3D.expandLine\n#ifdef VERTEX_ANIMATION\n vec4 prevProj = worldViewProjection * vec4(mix(prevPositionPrev, positionPrev, percent), 1.0);\n vec4 currProj = worldViewProjection * vec4(mix(prevPosition, position, percent), 1.0);\n vec4 nextProj = worldViewProjection * vec4(mix(prevPositionNext, positionNext, percent), 1.0);\n#else\n vec4 prevProj = worldViewProjection * vec4(positionPrev, 1.0);\n vec4 currProj = worldViewProjection * vec4(position, 1.0);\n vec4 nextProj = worldViewProjection * vec4(positionNext, 1.0);\n#endif\n\n if (currProj.w < 0.0) {\n if (nextProj.w > 0.0) {\n currProj = clipNear(currProj, nextProj);\n }\n else if (prevProj.w > 0.0) {\n currProj = clipNear(currProj, prevProj);\n }\n }\n\n vec2 prevScreen = (prevProj.xy / abs(prevProj.w) + 1.0) * 0.5 * viewport.zw;\n vec2 currScreen = (currProj.xy / abs(currProj.w) + 1.0) * 0.5 * viewport.zw;\n vec2 nextScreen = (nextProj.xy / abs(nextProj.w) + 1.0) * 0.5 * viewport.zw;\n\n vec2 dir;\n float len = offset;\n if (position == positionPrev) {\n dir = normalize(nextScreen - currScreen);\n }\n else if (position == positionNext) {\n dir = normalize(currScreen - prevScreen);\n }\n else {\n vec2 dirA = normalize(currScreen - prevScreen);\n vec2 dirB = normalize(nextScreen - currScreen);\n\n vec2 tanget = normalize(dirA + dirB);\n\n float miter = 1.0 / max(dot(tanget, dirA), 0.5);\n len *= miter;\n dir = tanget;\n }\n\n dir = vec2(-dir.y, dir.x) * len;\n currScreen += dir;\n\n currProj.xy = (currScreen / viewport.zw - 0.5) * 2.0 * abs(currProj.w);\n@end\n\n\n@export ecgl.meshLines3D.vertex\n\nattribute vec3 position: POSITION;\nattribute vec3 positionPrev;\nattribute vec3 positionNext;\nattribute float offset;\nattribute vec4 a_Color : COLOR;\n\n#ifdef VERTEX_ANIMATION\nattribute vec3 prevPosition;\nattribute vec3 prevPositionPrev;\nattribute vec3 prevPositionNext;\nuniform float percent : 1.0;\n#endif\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform vec4 viewport : VIEWPORT;\nuniform float near : NEAR;\n\nvarying vec4 v_Color;\n\n@import ecgl.common.wireframe.vertexHeader\n\n@import ecgl.lines3D.clipNear\n\nvoid main()\n{\n @import ecgl.lines3D.expandLine\n\n gl_Position = currProj;\n\n v_Color = a_Color;\n\n @import ecgl.common.wireframe.vertexMain\n}\n@end\n\n\n@export ecgl.meshLines3D.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nvarying vec4 v_Color;\n\n@import ecgl.common.wireframe.fragmentHeader\n\n@import clay.util.srgb\n\nvoid main()\n{\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(color * v_Color);\n#else\n gl_FragColor = color * v_Color;\n#endif\n\n @import ecgl.common.wireframe.fragmentMain\n}\n\n@end",Pc=A.firstNotNull,Nc=(q.Shader.import(y),{x:0,y:2,z:1});const Rc=O.ComponentView.extend({type:"grid3D",__ecgl__:!0,init:function(t,e){var r=new q.Material({shader:q.createShader("ecgl.color"),depthMask:!1,transparent:!0}),i=new q.Material({shader:q.createShader("ecgl.meshLines3D"),depthMask:!1,transparent:!0}),n=(r.define("fragment","DOUBLE_SIDED"),r.define("both","VERTEX_COLOR"),this.groupGL=new q.Node,this._control=new nc({zr:e.getZr()}),this._control.init(),this._faces=[["y","z","x",-1,"left"],["y","z","x",1,"right"],["x","y","z",-1,"bottom"],["x","y","z",1,"top"],["x","z","y",-1,"far"],["x","z","y",1,"near"]].map(function(t){t=new bc(t,i,r);return this.groupGL.add(t.rootNode),t},this),this._axes=["x","y","z"].map(function(t){t=new Lc(t,i);return this.groupGL.add(t.rootNode),t},this),e.getDevicePixelRatio());this._axisLabelSurface=new uc({width:256,height:256,devicePixelRatio:n}),this._axisLabelSurface.onupdate=function(){e.getZr().refresh()},this._axisPointerLineMesh=new q.Mesh({geometry:new sc({useNativeLine:!1}),material:i,castShadow:!1,ignorePicking:!0,renderOrder:3}),this.groupGL.add(this._axisPointerLineMesh),this._axisPointerLabelsSurface=new uc({width:128,height:128,devicePixelRatio:n}),this._axisPointerLabelsMesh=new Ec({ignorePicking:!0,renderOrder:4,castShadow:!1}),this._axisPointerLabelsMesh.material.set("textureAtlas",this._axisPointerLabelsSurface.getTexture()),this.groupGL.add(this._axisPointerLabelsMesh),this._lightRoot=new q.Node,this._sceneHelper=new dc,this._sceneHelper.initLight(this._lightRoot)},render:function(e,r,i){this._model=e,this._api=i;var t=e.coordinateSystem,n=(t.viewGL.add(this._lightRoot),e.get("show")?t.viewGL.add(this.groupGL):t.viewGL.remove(this.groupGL),this._control),o=(n.setViewGL(t.viewGL),e.getModel("viewControl"));n.setFromViewControlModel(o,0),this._axisLabelSurface.clear(),n.off("update"),e.get("show")&&(this._faces.forEach(function(t){t.update(e,r,i)},this),this._axes.forEach(function(t){t.update(e,this._axisLabelSurface,i)},this)),n.on("update",this._onCameraChange.bind(this,e,i),this),this._sceneHelper.setScene(t.viewGL.scene),this._sceneHelper.updateLight(e),t.viewGL.setPostEffect(e.getModel("postEffect"),i),t.viewGL.setTemporalSuperSampling(e.getModel("temporalSuperSampling")),this._initMouseHandler(e)},afterRender:function(t,e,r,i){i=i.renderer;this._sceneHelper.updateAmbientCubemap(i,t,r),this._sceneHelper.updateSkybox(i,t,r)},showAxisPointer:function(t,e,r,i){this._doShowAxisPointer(),this._updateAxisPointer(i.value)},hideAxisPointer:function(t,e,r,i){this._doHideAxisPointer()},_initMouseHandler:function(t){var e=t.coordinateSystem.viewGL;t.get("show")&&t.get("axisPointer.show")?e.on("mousemove",this._updateAxisPointerOnMousePosition,this):e.off("mousemove",this._updateAxisPointerOnMousePosition)},_updateAxisPointerOnMousePosition:function(t){if(!t.target){for(var e,r=this._model.coordinateSystem,i=r.viewGL,n=i.castRay(t.offsetX,t.offsetY,new q.Ray),o=0;o<this._faces.length;o++){var a,s,l,h,u=this._faces[o];u.rootNode.invisible||(u.plane.normal.dot(i.camera.worldTransform.z)<0&&u.plane.normal.negate(),(a=n.intersectPlane(u.plane))&&(s=r.getAxis(u.faceInfo[0]),l=r.getAxis(u.faceInfo[1]),h=Nc[u.faceInfo[0]],u=Nc[u.faceInfo[1]],s.contain(a.array[h]))&&l.contain(a.array[u])&&(e=a))}e?(t=r.pointToData(e.array,[],!0),this._updateAxisPointer(t),this._doShowAxisPointer()):this._doHideAxisPointer()}},_onCameraChange:function(t,e){t.get("show")&&(this._updateFaceVisibility(),this._updateAxisLinePosition());var r=this._control;e.dispatchAction({type:"grid3DChangeCamera",alpha:r.getAlpha(),beta:r.getBeta(),distance:r.getDistance(),center:r.getCenter(),from:this.uid,grid3DId:t.id})},_updateFaceVisibility:function(){var t=this._control.getCamera(),e=new q.Vector3;t.update();for(var r=0;r<this._faces.length/2;r++){for(var i=[],n=0;n<2;n++)this._faces[2*r+n].rootNode.getWorldPosition(e),e.transformMat4(t.viewMatrix),i[n]=e.z;var o=i[1]<i[0]?0:1,a=this._faces[2*r+o],o=this._faces[2*r+1-o];a.rootNode.invisible=!0,o.rootNode.invisible=!1}},_updateAxisLinePosition:function(){var t=this._model.coordinateSystem,e=t.getAxis("x"),r=t.getAxis("y"),t=t.getAxis("z"),i=t.getExtentMax(),t=t.getExtentMin(),n=e.getExtentMin(),e=e.getExtentMax(),o=r.getExtentMax(),r=r.getExtentMin(),a=this._axes[0].rootNode,s=this._axes[1].rootNode,l=this._axes[2].rootNode,h=this._faces,u=h[4].rootNode.invisible?r:o,c=h[2].rootNode.invisible?i:t,d=h[0].rootNode.invisible?n:e,i=h[2].rootNode.invisible?i:t,t=h[0].rootNode.invisible?e:n,e=h[4].rootNode.invisible?r:o;a.rotation.identity(),s.rotation.identity(),l.rotation.identity(),h[4].rootNode.invisible&&(this._axes[0].flipped=!0,a.rotation.rotateX(Math.PI)),h[0].rootNode.invisible&&(this._axes[1].flipped=!0,s.rotation.rotateZ(Math.PI)),h[4].rootNode.invisible&&(this._axes[2].flipped=!0,l.rotation.rotateY(Math.PI)),a.position.set(0,c,u),s.position.set(d,i,0),l.position.set(t,0,e),a.update(),s.update(),l.update(),this._updateAxisLabelAlign()},_updateAxisLabelAlign:function(){var h=this._control.getCamera(),u=[new q.Vector4,new q.Vector4],c=new q.Vector4;this.groupGL.getWorldPosition(c),c.w=1,c.transformMat4(h.viewMatrix).transformMat4(h.projectionMatrix),c.x/=c.w,c.y/=c.w,this._axes.forEach(function(t){for(var e=t.axisLineCoords,r=(t.labelsMesh.geometry,0);r<u.length;r++)u[r].setArray(e[r]),u[r].w=1,u[r].transformMat4(t.rootNode.worldTransform).transformMat4(h.viewMatrix).transformMat4(h.projectionMatrix),u[r].x/=u[r].w,u[r].y/=u[r].w;var i,n,o=u[1].x-u[0].x,a=u[1].y-u[0].y,s=(u[1].x+u[0].x)/2,l=(u[1].y+u[0].y)/2;Math.abs(a/o)<.5?(i="center",n=l>c.y?"bottom":"top"):(n="middle",i=s>c.x?"left":"right"),t.setSpriteAlign(i,n,this._api)},this)},_doShowAxisPointer:function(){this._axisPointerLineMesh.invisible&&(this._axisPointerLineMesh.invisible=!1,this._axisPointerLabelsMesh.invisible=!1,this._api.getZr().refresh())},_doHideAxisPointer:function(){this._axisPointerLineMesh.invisible||(this._axisPointerLineMesh.invisible=!0,this._axisPointerLabelsMesh.invisible=!0,this._api.getZr().refresh())},_updateAxisPointer:function(t){var e=this._model.coordinateSystem,r=e.dataToPoint(t),i=this._axisPointerLineMesh.geometry,n=this._model.getModel("axisPointer"),o=this._api.getDevicePixelRatio();function a(t){return A.firstNotNull(t.model.get("axisPointer.show"),n.get("show"))}function s(t){var t=t.model.getModel("axisPointer",n).getModel("lineStyle"),e=q.parseColor(t.get("color")),r=Pc(t.get("width"),1),t=Pc(t.get("opacity"),1);return e[3]*=t,{color:e,lineWidth:r}}i.convertToDynamicArray(!0);for(var l=0;l<this._faces.length;l++){var h=this._faces[l];if(!h.rootNode.invisible){for(var u=h.faceInfo,c=u[3]<0?e.getAxis(u[2]).getExtentMin():e.getAxis(u[2]).getExtentMax(),d=Nc[u[2]],f=0;f<2;f++){var p,m,g,_=u[f],y=u[1-f],v=e.getAxis(_),x=e.getAxis(y);a(v)&&(y=Nc[y],(p=[0,0,0])[_=Nc[_]]=(m=[0,0,0])[_]=r[_],p[d]=m[d]=c,p[y]=x.getExtentMin(),m[y]=x.getExtentMax(),g=s(v),i.addLine(p,m,g.color,g.lineWidth*o))}a(e.getAxis(u[2]))&&(p=r.slice(),(m=r.slice())[d]=c,g=s(e.getAxis(u[2])),i.addLine(p,m,g.color,g.lineWidth*o))}}i.convertToTypedArray(),this._updateAxisPointerLabelsMesh(t),this._api.getZr().refresh()},_updateAxisPointerLabelsMesh:function(l){var t=this._model,h=this._axisPointerLabelsMesh,u=this._axisPointerLabelsSurface,c=t.coordinateSystem,d=t.getModel("axisPointer"),f=(h.geometry.convertToDynamicArray(!0),u.clear(),{x:"y",y:"x",z:"y"});this._axes.forEach(function(t,e){var r,i,n=c.getAxis(t.dim),o=n.model.getModel("axisPointer",d),a=o.getModel("label"),s=o.get("lineStyle.color");a.get("show")&&o.get("show")&&(o=l[e],i=a.get("formatter"),r=n.scale.getLabel({value:o}),null!=i?r=i(r,l):"interval"!==n.scale.type&&"log"!==n.scale.type||(i=O.number.getPrecisionSafe(n.scale.getTicks()[0]),r=o.toFixed(i+2)),o=a.get("color"),i=new O.graphic.Text({style:Ku(a,{text:r,fill:o||s,align:"left",verticalAlign:"top"})}),r=u.add(i),o=i.getBoundingRect(),s=this._api.getDevicePixelRatio(),(i=t.rootNode.position.toArray())[Nc[f[t.dim]]]+=(t.flipped?-1:1)*a.get("margin"),i[Nc[t.dim]]=n.dataToCoord(l[e]),h.geometry.addSprite(i,[o.width*s,o.height*s],r,t.textAlign,t.textVerticalAlign))},this),u.getZr().refreshImmediately(),h.material.set("uvScale",u.getCoordsScale()),h.geometry.convertToTypedArray()},dispose:function(){this.groupGL.removeAll(),this._control.dispose(),this._axisLabelSurface.dispose(),this._axisPointerLabelsSurface.dispose()}});function Ic(t){this.type="cartesian",this._dimList=[],this._axes={},this.name=t||""}Ic.prototype.getAxis=function(t){return this._axes[t]},Ic.prototype.getAxes=function(){return eo(this._dimList,function(t){return this._axes[t]},this)},Ic.prototype.getAxesByScale=function(e){e=e.toLowerCase();var t=this.getAxes(),r=function(t){return t.scale.type===e},i=void 0;if(!t)return[];if(!r)return po(t);if(t.filter&&t.filter===Gn)return t.filter(r,i);for(var n=[],o=0,a=t.length;o<a;o++)r.call(i,t[o],o,t)&&n.push(t[o]);return n},Ic.prototype.addAxis=function(t){var e=t.dim;this._axes[e]=t,this._dimList.push(e)};const Oc=Ic;function Bc(t){Oc.call(this,t),this.type="cartesian3D",this.dimensions=["x","y","z"],this.size=[0,0,0]}Bc.prototype={constructor:Bc,model:null,containPoint:function(t){return this.getAxis("x").contain(t[0])&&this.getAxis("y").contain(t[2])&&this.getAxis("z").contain(t[1])},containData:function(t){return this.getAxis("x").containData(t[0])&&this.getAxis("y").containData(t[1])&&this.getAxis("z").containData(t[2])},dataToPoint:function(t,e,r){return(e=e||[])[0]=this.getAxis("x").dataToCoord(t[0],r),e[2]=this.getAxis("y").dataToCoord(t[1],r),e[1]=this.getAxis("z").dataToCoord(t[2],r),e},pointToData:function(t,e,r){return(e=e||[])[0]=this.getAxis("x").coordToData(t[0],r),e[1]=this.getAxis("y").coordToData(t[2],r),e[2]=this.getAxis("z").coordToData(t[1],r),e}},O.util.inherits(Bc,Oc);const Fc=Bc;function zc(t,e,r){O.Axis.call(this,t,e,r)}zc.prototype={constructor:zc,getExtentMin:function(){var t=this._extent;return Math.min(t[0],t[1])},getExtentMax:function(){var t=this._extent;return Math.max(t[0],t[1])},calculateCategoryInterval:function(){return Math.floor(this.scale.count()/8)}},O.util.inherits(zc,O.Axis);const Uc=zc;Object.create;Object.create;var kc="___EC__EXTENDED_CLASS___";xu=Math.round(10*Math.random());function Gc(t,e){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return this.superClass.prototype[e].apply(t,r)}function Hc(t,e,r){return this.superClass.prototype[e].apply(t,r)}function Vc(a,s){for(var t=0;t<a.length;t++)a[t][1]||(a[t][1]=a[t][0]);return s=s||!1,function(t,e,r){for(var i={},n=0;n<a.length;n++){var o=a[n][1];e&&0<=Qn(e,o)||r&&Qn(r,o)<0||null!=(o=t.getShallow(o,s))&&(i[a[n][0]]=o)}return i}}var Wc=Vc([["fill","color"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["opacity"],["shadowColor"]]),Eu=(Xc.prototype.getAreaStyle=function(t,e){return Wc(this,t,e)},Xc);function Xc(){}var jc=["textStyle","color"],qc=new Dh;function Zc(){}Zc.prototype.getTextColor=function(t){var e=this.ecModel;return this.getShallow("color")||(!t&&e?e.get(jc):null)},Zc.prototype.getFont=function(){return t={fontStyle:this.getShallow("fontStyle"),fontWeight:this.getShallow("fontWeight"),fontSize:this.getShallow("fontSize"),fontFamily:this.getShallow("fontFamily")},e=(e=this.ecModel)&&e.getModel("textStyle"),_o([t.fontStyle||e&&e.getShallow("fontStyle")||"",t.fontWeight||e&&e.getShallow("fontWeight")||"",(t.fontSize||e&&e.getShallow("fontSize")||12)+"px",t.fontFamily||e&&e.getShallow("fontFamily")||"sans-serif"].join(" "));var t,e},Zc.prototype.getTextRect=function(t){return qc.useStyle({text:t,fontStyle:this.getShallow("fontStyle"),fontWeight:this.getShallow("fontWeight"),fontSize:this.getShallow("fontSize"),fontFamily:this.getShallow("fontFamily"),verticalAlign:this.getShallow("verticalAlign")||this.getShallow("baseline"),padding:this.getShallow("padding"),lineHeight:this.getShallow("lineHeight"),rich:this.getShallow("rich")}),qc.update(),qc.getBoundingRect()};var Pu=Zc,Yc=Vc([["lineWidth","width"],["stroke","color"],["opacity"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["shadowColor"],["lineDash","type"],["lineDashOffset","dashOffset"],["lineCap","cap"],["lineJoin","join"],["miterLimit"]]),Ou=(Kc.prototype.getLineStyle=function(t){return Yc(this,t)},Kc);function Kc(){}var Qc=Vc([["fill","color"],["stroke","borderColor"],["lineWidth","borderWidth"],["opacity"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["shadowColor"],["lineDash","borderType"],["lineDashOffset","borderDashOffset"],["lineCap","borderCap"],["lineJoin","borderJoin"],["miterLimit","borderMiterLimit"]]),Gu=(Jc.prototype.getItemStyle=function(t,e){return Qc(this,t,e)},Jc);function Jc(){}ed.prototype.init=function(t,e,r){for(var i=3;i<arguments.length;i++)i-3,0},ed.prototype.mergeOption=function(t,e){Zn(this.option,t,!0)},ed.prototype.get=function(t,e){return null==t?this.option:this._doGet(this.parsePath(t),!e&&this.parentModel)},ed.prototype.getShallow=function(t,e){var r=this.option,r=null==r?r:r[t];return null!=r||e||(e=this.parentModel)&&(r=e.getShallow(t)),r},ed.prototype.getModel=function(t,e){var r=null!=t,t=r?this.parsePath(t):null;return new ed(r?this._doGet(t):this.option,e=e||this.parentModel&&this.parentModel.getModel(this.resolveParentPath(t)),this.ecModel)},ed.prototype.isEmpty=function(){return null==this.option},ed.prototype.restoreData=function(){},ed.prototype.clone=function(){return new this.constructor(qn(this.option))},ed.prototype.parsePath=function(t){return"string"==typeof t?t.split("."):t},ed.prototype.resolveParentPath=function(t){return t},ed.prototype.isAnimationEnabled=function(){if(!_s.node&&this.option)return null!=this.option.animation?!!this.option.animation:this.parentModel?this.parentModel.isAnimationEnabled():void 0},ed.prototype._doGet=function(t,e){var r=this.option;if(t){for(var i=0;i<t.length&&(!t[i]||null!=(r=r&&"object"==typeof r?r[t[i]]:null));i++);null==r&&e&&(r=e._doGet(this.resolveParentPath(t),e.parentModel))}return r};var $c,td,t=ed;function ed(t,e,r){this.parentModel=e,this.ecModel=r,this.option=t}((g=t).$constructor=g).extend=function(i){to($c,function(t){i[t]||console.warn("Method `"+t+"` should be implemented"+(i.type?" in "+i.type:"")+".")});var n=this;function o(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];if(i.$constructor)i.$constructor.apply(this,arguments);else{if("function"==typeof(t=n)&&/^class\s/.test(Function.prototype.toString.call(t)))return So(o.prototype,new(n.bind.apply(n,function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var i=Array(t),n=0,e=0;e<r;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,n++)i[n]=o[a];return i}([void 0],e))));n.apply(this,arguments)}}o[kc]=!0,Yn(o.prototype,i),o.extend=this.extend,o.superCall=Gc,o.superApply=Hc;var t,e=o,r=this,a=e.prototype;function s(){}for(t in s.prototype=r.prototype,e.prototype=new s,a)a.hasOwnProperty(t)&&(e.prototype[t]=a[t]);return(e.prototype.constructor=e).superClass=r,o.superClass=n,o},d=t,td=["__\0is_clz",xu++].join("_"),d.prototype[td]=!0,go(!d.isInstance,'The method "is" can not be defined.'),d.isInstance=function(t){return!(!t||!t[td])},Jn(t,Ou),Jn(t,Gu),Jn(t,Eu),Jn(t,Pu);const rd=t;_s.domSupported&&(document.documentElement.lang||navigator.language||navigator.browserLanguage).toUpperCase().indexOf("ZH");function id(t,e){t=t.toUpperCase(),t,new rd(e),t,0}id("EN",{time:{month:["January","February","March","April","May","June","July","August","September","October","November","December"],monthAbbr:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayOfWeek:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayOfWeekAbbr:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},legend:{selector:{all:"All",inverse:"Inv"}},toolbox:{brush:{title:{rect:"Box Select",polygon:"Lasso Select",lineX:"Horizontally Select",lineY:"Vertically Select",keep:"Keep Selections",clear:"Clear Selections"}},dataView:{title:"Data View",lang:["Data View","Close","Refresh"]},dataZoom:{title:{zoom:"Zoom",back:"Zoom Reset"}},magicType:{title:{line:"Switch to Line Chart",bar:"Switch to Bar Chart",stack:"Stack",tiled:"Tile"}},restore:{title:"Restore"},saveAsImage:{title:"Save as Image",lang:["Right Click to Save Image"]}},series:{typeNames:{pie:"Pie chart",bar:"Bar chart",line:"Line chart",scatter:"Scatter plot",effectScatter:"Ripple scatter plot",radar:"Radar chart",tree:"Tree",treemap:"Treemap",boxplot:"Boxplot",candlestick:"Candlestick",k:"K line chart",heatmap:"Heat map",map:"Map",parallel:"Parallel coordinate map",lines:"Line graph",graph:"Relationship graph",sankey:"Sankey diagram",funnel:"Funnel chart",gauge:"Gauge",pictorialBar:"Pictorial bar",themeRiver:"Theme River Map",sunburst:"Sunburst"}},aria:{general:{withTitle:'This is a chart about "{title}"',withoutTitle:"This is a chart"},series:{single:{prefix:"",withName:" with type {seriesType} named {seriesName}.",withoutName:" with type {seriesType}."},multiple:{prefix:". It consists of {seriesCount} series count.",withName:" The {seriesId} series is a {seriesType} representing {seriesName}.",withoutName:" The {seriesId} series is a {seriesType}.",separator:{middle:"",end:""}}},data:{allData:"The data is as follows: ",partialData:"The first {displayCnt} items are: ",withName:"the data for {name} is {value}",withoutName:"{value}",separator:{middle:", ",end:". "}}}}),id("ZH",{time:{month:["","","","","","","","","","","",""],monthAbbr:["1","2","3","4","5","6","7","8","9","10","11","12"],dayOfWeek:["","","","","","",""],dayOfWeekAbbr:["","","","","","",""]},legend:{selector:{all:"",inverse:""}},toolbox:{brush:{title:{rect:"",polygon:"",lineX:"",lineY:"",keep:"",clear:""}},dataView:{title:"",lang:["","",""]},dataZoom:{title:{zoom:"",back:""}},magicType:{title:{line:"",bar:"",stack:"",tiled:""}},restore:{title:""},saveAsImage:{title:"",lang:[""]}},series:{typeNames:{pie:"",bar:"",line:"",scatter:"",effectScatter:"",radar:"",tree:"",treemap:"",boxplot:"",candlestick:"K",k:"K",heatmap:"",map:"",parallel:"",lines:"",graph:"",sankey:"",funnel:"",gauge:"",pictorialBar:"",themeRiver:"",sunburst:""}},aria:{general:{withTitle:"{title}",withoutTitle:""},series:{single:{prefix:"",withName:"{seriesType}{seriesName}",withoutName:"{seriesType}"},multiple:{prefix:"{seriesCount}",withName:"{seriesId}{seriesName}{seriesType}",withoutName:"{seriesId}{seriesType}",separator:{middle:"",end:""}}},data:{allData:"",partialData:"{displayCnt}",withName:"{name}{value}",withoutName:"{value}",separator:{middle:"",end:""}}}});var nd=mo;function od(a,s,l,h,u){var c=0,d=0,f=(null==h&&(h=1/0),null==u&&(u=1/0),0);s.eachChild(function(t,e){var r,i,n,o=t.getBoundingRect(),e=s.childAt(e+1),e=e&&e.getBoundingRect();f="horizontal"===a?(i=o.width+(e?-e.x+o.x:0),h<(r=c+i)||t.newline?(c=0,r=i,d+=f+l,o.height):Math.max(f,o.height)):(i=o.height+(e?-e.y+o.y:0),u<(n=d+i)||t.newline?(c+=f+l,d=0,n=i,o.width):Math.max(f,o.width)),t.newline||(t.x=c,t.y=d,t.markRedraw(),"horizontal"===a?c=r+l:d=n+l)})}no(od,"vertical"),no(od,"horizontal");function ad(t,e,r){r=nd(r||0);var i=e.width,n=e.height,o=Lh(t.left,i),a=Lh(t.top,n),e=Lh(t.right,i),s=Lh(t.bottom,n),l=Lh(t.width,i),h=Lh(t.height,n),u=r[2]+r[0],c=r[1]+r[3],d=t.aspect;switch(isNaN(l)&&(l=i-e-c-o),isNaN(h)&&(h=n-s-u-a),null!=d&&(isNaN(l)&&isNaN(h)&&(i/n<d?l=.8*i:h=.8*n),isNaN(l)&&(l=d*h),isNaN(h))&&(h=l/d),isNaN(o)&&(o=i-e-l-c),isNaN(a)&&(a=n-s-h-u),t.left||t.right){case"center":o=i/2-l/2-r[3];break;case"right":o=i-l-c}switch(t.top||t.bottom){case"middle":case"center":a=n/2-h/2-r[0];break;case"bottom":a=n-h-u}o=o||0,a=a||0,isNaN(l)&&(l=i-c-o-(e||0)),isNaN(h)&&(h=n-u-a-(s||0));d=new Ma(o+r[3],a+r[0],l,h);return d.margin=r,d}function sd(){this._pool={},this._allocatedTextures=[]}sd.prototype={constructor:sd,get:function(t){var e=ud(t),e=(this._pool.hasOwnProperty(e)||(this._pool[e]=[]),this._pool[e]);return e.length?e.pop():(e=new F(t),this._allocatedTextures.push(e),e)},put:function(t){var e=ud(t);this._pool.hasOwnProperty(e)||(this._pool[e]=[]),this._pool[e].push(t)},clear:function(t){for(var e=0;e<this._allocatedTextures.length;e++)this._allocatedTextures[e].dispose(t);this._pool={},this._allocatedTextures=[]}};var ld={width:512,height:512,type:E.UNSIGNED_BYTE,format:E.RGBA,wrapS:E.CLAMP_TO_EDGE,wrapT:E.CLAMP_TO_EDGE,minFilter:E.LINEAR_MIPMAP_LINEAR,magFilter:E.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1},hd=Object.keys(ld);function ud(t){W.defaultsWithPropList(t,ld,hd);var e=t,r=function(t,e){return 0==(t&t-1)&&0==(e&e-1)}(e.width,e.height);e.format===E.DEPTH_COMPONENT&&(e.useMipmap=!1),r&&e.useMipmap||(e.minFilter==E.NEAREST_MIPMAP_NEAREST||e.minFilter==E.NEAREST_MIPMAP_LINEAR?e.minFilter=E.NEAREST:e.minFilter!=E.LINEAR_MIPMAP_LINEAR&&e.minFilter!=E.LINEAR_MIPMAP_NEAREST||(e.minFilter=E.LINEAR)),r||(e.wrapS=E.CLAMP_TO_EDGE,e.wrapT=E.CLAMP_TO_EDGE);for(var i="",n=0;n<hd.length;n++)i+=t[hd[n]].toString();return i}const cd=sd;var dd=["px","nx","py","ny","pz","nz"];function fd(t,e,r){return"alphaMap"===r?t.material.get("diffuseMap"):"alphaCutoff"===r?t.material.isDefined("fragment","ALPHA_TEST")&&t.material.get("diffuseMap")&&t.material.get("alphaCutoff")||0:"uvRepeat"===r?t.material.get("uvRepeat"):"uvOffset"===r?t.material.get("uvOffset"):e.get(r)}function pd(t,e){t=t.material,e=e.material;return t.get("diffuseMap")!==e.get("diffuseMap")||(t.get("alphaCutoff")||0)!==(e.get("alphaCutoff")||0)}S.import("@export clay.sm.depth.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nuniform vec2 uvRepeat = vec2(1.0, 1.0);\nuniform vec2 uvOffset = vec2(0.0, 0.0);\n@import clay.chunk.skinning_header\n@import clay.chunk.instancing_header\nvarying vec4 v_ViewPosition;\nvarying vec2 v_Texcoord;\nvoid main(){\n vec4 P = vec4(position, 1.0);\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n P = skinMatrixWS * P;\n#endif\n#ifdef INSTANCING\n @import clay.chunk.instancing_matrix\n P = instanceMat * P;\n#endif\n v_ViewPosition = worldViewProjection * P;\n gl_Position = v_ViewPosition;\n v_Texcoord = texcoord * uvRepeat + uvOffset;\n}\n@end\n@export clay.sm.depth.fragment\nvarying vec4 v_ViewPosition;\nvarying vec2 v_Texcoord;\nuniform float bias : 0.001;\nuniform float slopeScale : 1.0;\nuniform sampler2D alphaMap;\nuniform float alphaCutoff: 0.0;\n@import clay.util.encode_float\nvoid main(){\n float depth = v_ViewPosition.z / v_ViewPosition.w;\n if (alphaCutoff > 0.0) {\n if (texture2D(alphaMap, v_Texcoord).a <= alphaCutoff) {\n discard;\n }\n }\n#ifdef USE_VSM\n depth = depth * 0.5 + 0.5;\n float moment1 = depth;\n float moment2 = depth * depth;\n #ifdef SUPPORT_STANDARD_DERIVATIVES\n float dx = dFdx(depth);\n float dy = dFdy(depth);\n moment2 += 0.25*(dx*dx+dy*dy);\n #endif\n gl_FragColor = vec4(moment1, moment2, 0.0, 1.0);\n#else\n #ifdef SUPPORT_STANDARD_DERIVATIVES\n float dx = dFdx(depth);\n float dy = dFdy(depth);\n depth += sqrt(dx*dx + dy*dy) * slopeScale + bias;\n #else\n depth += bias;\n #endif\n gl_FragColor = encodeFloat(depth * 0.5 + 0.5);\n#endif\n}\n@end\n@export clay.sm.debug_depth\nuniform sampler2D depthMap;\nvarying vec2 v_Texcoord;\n@import clay.util.decode_float\nvoid main() {\n vec4 tex = texture2D(depthMap, v_Texcoord);\n#ifdef USE_VSM\n gl_FragColor = vec4(tex.rgb, 1.0);\n#else\n float depth = decodeFloat(tex);\n gl_FragColor = vec4(depth, depth, depth, 1.0);\n#endif\n}\n@end\n@export clay.sm.distance.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world : WORLD;\nattribute vec3 position : POSITION;\n@import clay.chunk.skinning_header\nvarying vec3 v_WorldPosition;\nvoid main (){\n vec4 P = vec4(position, 1.0);\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n P = skinMatrixWS * P;\n#endif\n#ifdef INSTANCING\n @import clay.chunk.instancing_matrix\n P = instanceMat * P;\n#endif\n gl_Position = worldViewProjection * P;\n v_WorldPosition = (world * P).xyz;\n}\n@end\n@export clay.sm.distance.fragment\nuniform vec3 lightPosition;\nuniform float range : 100;\nvarying vec3 v_WorldPosition;\n@import clay.util.encode_float\nvoid main(){\n float dist = distance(lightPosition, v_WorldPosition);\n#ifdef USE_VSM\n gl_FragColor = vec4(dist, dist * dist, 0.0, 0.0);\n#else\n dist = dist / range;\n gl_FragColor = encodeFloat(dist);\n#endif\n}\n@end\n@export clay.plugin.shadow_map_common\n@import clay.util.decode_float\nfloat tapShadowMap(sampler2D map, vec2 uv, float z){\n vec4 tex = texture2D(map, uv);\n return step(z, decodeFloat(tex) * 2.0 - 1.0);\n}\nfloat pcf(sampler2D map, vec2 uv, float z, float textureSize, vec2 scale) {\n float shadowContrib = tapShadowMap(map, uv, z);\n vec2 offset = vec2(1.0 / textureSize) * scale;\n#ifdef PCF_KERNEL_SIZE\n for (int _idx_ = 0; _idx_ < PCF_KERNEL_SIZE; _idx_++) {{\n shadowContrib += tapShadowMap(map, uv + offset * pcfKernel[_idx_], z);\n }}\n return shadowContrib / float(PCF_KERNEL_SIZE + 1);\n#else\n shadowContrib += tapShadowMap(map, uv+vec2(offset.x, 0.0), z);\n shadowContrib += tapShadowMap(map, uv+vec2(offset.x, offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(-offset.x, offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(0.0, offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(-offset.x, 0.0), z);\n shadowContrib += tapShadowMap(map, uv+vec2(-offset.x, -offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(offset.x, -offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(0.0, -offset.y), z);\n return shadowContrib / 9.0;\n#endif\n}\nfloat pcf(sampler2D map, vec2 uv, float z, float textureSize) {\n return pcf(map, uv, z, textureSize, vec2(1.0));\n}\nfloat chebyshevUpperBound(vec2 moments, float z){\n float p = 0.0;\n z = z * 0.5 + 0.5;\n if (z <= moments.x) {\n p = 1.0;\n }\n float variance = moments.y - moments.x * moments.x;\n variance = max(variance, 0.0000001);\n float mD = moments.x - z;\n float pMax = variance / (variance + mD * mD);\n pMax = clamp((pMax-0.4)/(1.0-0.4), 0.0, 1.0);\n return max(p, pMax);\n}\nfloat computeShadowContrib(\n sampler2D map, mat4 lightVPM, vec3 position, float textureSize, vec2 scale, vec2 offset\n) {\n vec4 posInLightSpace = lightVPM * vec4(position, 1.0);\n posInLightSpace.xyz /= posInLightSpace.w;\n float z = posInLightSpace.z;\n if(all(greaterThan(posInLightSpace.xyz, vec3(-0.99, -0.99, -1.0))) &&\n all(lessThan(posInLightSpace.xyz, vec3(0.99, 0.99, 1.0)))){\n vec2 uv = (posInLightSpace.xy+1.0) / 2.0;\n #ifdef USE_VSM\n vec2 moments = texture2D(map, uv * scale + offset).xy;\n return chebyshevUpperBound(moments, z);\n #else\n return pcf(map, uv * scale + offset, z, textureSize, scale);\n #endif\n }\n return 1.0;\n}\nfloat computeShadowContrib(sampler2D map, mat4 lightVPM, vec3 position, float textureSize) {\n return computeShadowContrib(map, lightVPM, position, textureSize, vec2(1.0), vec2(0.0));\n}\nfloat computeShadowContribOmni(samplerCube map, vec3 direction, float range)\n{\n float dist = length(direction);\n vec4 shadowTex = textureCube(map, direction);\n#ifdef USE_VSM\n vec2 moments = shadowTex.xy;\n float variance = moments.y - moments.x * moments.x;\n float mD = moments.x - dist;\n float p = variance / (variance + mD * mD);\n if(moments.x + 0.001 < dist){\n return clamp(p, 0.0, 1.0);\n }else{\n return 1.0;\n }\n#else\n return step(dist, (decodeFloat(shadowTex) + 0.0002) * range);\n#endif\n}\n@end\n@export clay.plugin.compute_shadow_map\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT) || defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT) || defined(POINT_LIGHT_SHADOWMAP_COUNT)\n#ifdef SPOT_LIGHT_SHADOWMAP_COUNT\nuniform sampler2D spotLightShadowMaps[SPOT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform mat4 spotLightMatrices[SPOT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform float spotLightShadowMapSizes[SPOT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\n#endif\n#ifdef DIRECTIONAL_LIGHT_SHADOWMAP_COUNT\n#if defined(SHADOW_CASCADE)\nuniform sampler2D directionalLightShadowMaps[1]:unconfigurable;\nuniform mat4 directionalLightMatrices[SHADOW_CASCADE]:unconfigurable;\nuniform float directionalLightShadowMapSizes[1]:unconfigurable;\nuniform float shadowCascadeClipsNear[SHADOW_CASCADE]:unconfigurable;\nuniform float shadowCascadeClipsFar[SHADOW_CASCADE]:unconfigurable;\n#else\nuniform sampler2D directionalLightShadowMaps[DIRECTIONAL_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform mat4 directionalLightMatrices[DIRECTIONAL_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform float directionalLightShadowMapSizes[DIRECTIONAL_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\n#endif\n#endif\n#ifdef POINT_LIGHT_SHADOWMAP_COUNT\nuniform samplerCube pointLightShadowMaps[POINT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\n#endif\nuniform bool shadowEnabled : true;\n#ifdef PCF_KERNEL_SIZE\nuniform vec2 pcfKernel[PCF_KERNEL_SIZE];\n#endif\n@import clay.plugin.shadow_map_common\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT)\nvoid computeShadowOfSpotLights(vec3 position, inout float shadowContribs[SPOT_LIGHT_COUNT] ) {\n float shadowContrib;\n for(int _idx_ = 0; _idx_ < SPOT_LIGHT_SHADOWMAP_COUNT; _idx_++) {{\n shadowContrib = computeShadowContrib(\n spotLightShadowMaps[_idx_], spotLightMatrices[_idx_], position,\n spotLightShadowMapSizes[_idx_]\n );\n shadowContribs[_idx_] = shadowContrib;\n }}\n for(int _idx_ = SPOT_LIGHT_SHADOWMAP_COUNT; _idx_ < SPOT_LIGHT_COUNT; _idx_++){{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#endif\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n#ifdef SHADOW_CASCADE\nvoid computeShadowOfDirectionalLights(vec3 position, inout float shadowContribs[DIRECTIONAL_LIGHT_COUNT]){\n float depth = (2.0 * gl_FragCoord.z - gl_DepthRange.near - gl_DepthRange.far)\n / (gl_DepthRange.far - gl_DepthRange.near);\n float shadowContrib;\n shadowContribs[0] = 1.0;\n for (int _idx_ = 0; _idx_ < SHADOW_CASCADE; _idx_++) {{\n if (\n depth >= shadowCascadeClipsNear[_idx_] &&\n depth <= shadowCascadeClipsFar[_idx_]\n ) {\n shadowContrib = computeShadowContrib(\n directionalLightShadowMaps[0], directionalLightMatrices[_idx_], position,\n directionalLightShadowMapSizes[0],\n vec2(1.0 / float(SHADOW_CASCADE), 1.0),\n vec2(float(_idx_) / float(SHADOW_CASCADE), 0.0)\n );\n shadowContribs[0] = shadowContrib;\n }\n }}\n for(int _idx_ = DIRECTIONAL_LIGHT_SHADOWMAP_COUNT; _idx_ < DIRECTIONAL_LIGHT_COUNT; _idx_++) {{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#else\nvoid computeShadowOfDirectionalLights(vec3 position, inout float shadowContribs[DIRECTIONAL_LIGHT_COUNT]){\n float shadowContrib;\n for(int _idx_ = 0; _idx_ < DIRECTIONAL_LIGHT_SHADOWMAP_COUNT; _idx_++) {{\n shadowContrib = computeShadowContrib(\n directionalLightShadowMaps[_idx_], directionalLightMatrices[_idx_], position,\n directionalLightShadowMapSizes[_idx_]\n );\n shadowContribs[_idx_] = shadowContrib;\n }}\n for(int _idx_ = DIRECTIONAL_LIGHT_SHADOWMAP_COUNT; _idx_ < DIRECTIONAL_LIGHT_COUNT; _idx_++) {{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#endif\n#endif\n#if defined(POINT_LIGHT_SHADOWMAP_COUNT)\nvoid computeShadowOfPointLights(vec3 position, inout float shadowContribs[POINT_LIGHT_COUNT] ){\n vec3 lightPosition;\n vec3 direction;\n for(int _idx_ = 0; _idx_ < POINT_LIGHT_SHADOWMAP_COUNT; _idx_++) {{\n lightPosition = pointLightPosition[_idx_];\n direction = position - lightPosition;\n shadowContribs[_idx_] = computeShadowContribOmni(pointLightShadowMaps[_idx_], direction, pointLightRange[_idx_]);\n }}\n for(int _idx_ = POINT_LIGHT_SHADOWMAP_COUNT; _idx_ < POINT_LIGHT_COUNT; _idx_++) {{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#endif\n#endif\n@end");var md,gd,_d,yd,vd,xd,Td,bd,wd,Sd,Ed=P.extend(function(){return{softShadow:Ed.PCF,shadowBlur:1,lightFrustumBias:"auto",kernelPCF:new Float32Array([1,0,1,1,-1,1,0,1,-1,0,-1,-1,1,-1,0,-1]),precision:"highp",_lastRenderNotCastShadow:!1,_frameBuffer:new xi,_textures:{},_shadowMapNumber:{POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},_depthMaterials:{},_distanceMaterials:{},_receivers:[],_lightsCastShadow:[],_lightCameras:{},_lightMaterials:{},_texturePool:new cd}},function(){this._gaussianPassH=new tn({fragment:S.source("clay.compositor.gaussian_blur")}),this._gaussianPassV=new tn({fragment:S.source("clay.compositor.gaussian_blur")}),this._gaussianPassH.setUniform("blurSize",this.shadowBlur),this._gaussianPassH.setUniform("blurDir",0),this._gaussianPassV.setUniform("blurSize",this.shadowBlur),this._gaussianPassV.setUniform("blurDir",1),this._outputDepthPass=new tn({fragment:S.source("clay.sm.debug_depth")})},{render:function(t,e,r,i){r=r||e.getMainCamera(),this.trigger("beforerender",this,t,e,r),this._renderShadowPass(t,e,r,i),this.trigger("afterrender",this,t,e,r)},renderDebug:function(t,e){t.saveClear();var r,i=t.viewport,n=0,o=e||i.width/4,a=o;for(r in this.softShadow===Ed.VSM?this._outputDepthPass.material.define("fragment","USE_VSM"):this._outputDepthPass.material.undefine("fragment","USE_VSM"),this._textures){var s=this._textures[r];t.setViewport(n,0,o*s.width/s.height,a),this._outputDepthPass.setUniform("depthMap",s),this._outputDepthPass.render(t),n+=o*s.width/s.height}t.setViewport(i),t.restoreClear()},_updateReceivers:function(t,e){var r;e.receiveShadow?(this._receivers.push(e),e.material.set("shadowEnabled",1),e.material.set("pcfKernel",this.kernelPCF)):e.material.set("shadowEnabled",0),this.softShadow===Ed.VSM?(e.material.define("fragment","USE_VSM"),e.material.undefine("fragment","PCF_KERNEL_SIZE")):(e.material.undefine("fragment","USE_VSM"),(r=this.kernelPCF)&&r.length?e.material.define("fragment","PCF_KERNEL_SIZE",r.length/2):e.material.undefine("fragment","PCF_KERNEL_SIZE"))},_update:function(e,t){var r=this;t.traverse(function(t){t.isRenderable()&&r._updateReceivers(e,t)});for(var i=0;i<t.lights.length;i++){var n=t.lights[i];n.castShadow&&!n.invisible&&this._lightsCastShadow.push(n)}},_renderShadowPass:function(t,e,r,i){for(var n in this._shadowMapNumber)this._shadowMapNumber[n]=0;this._lightsCastShadow.length=0,this._receivers.length=0;var o=t.gl;if(i||e.update(),r&&r.update(),e.updateLights(),this._update(t,e),this._lightsCastShadow.length||!this._lastRenderNotCastShadow){this._lastRenderNotCastShadow=0===this._lightsCastShadow,o.enable(o.DEPTH_TEST),o.depthMask(!0),o.disable(o.BLEND),o.clearColor(1,1,1,1);for(var a,s,l=[],h=[],u=[],c=[],d=[],f=[],p=0;p<this._lightsCastShadow.length;p++){var m=this._lightsCastShadow[p];if("DIRECTIONAL_LIGHT"===m.type){if(a){console.warn("Only one direectional light supported with shadow cascade");continue}if(4<m.shadowCascade){console.warn("Support at most 4 cascade");continue}1<m.shadowCascade&&(a=m),this.renderDirectionalLightShadow(t,e,r,m,d,c,u)}else"SPOT_LIGHT"===m.type?this.renderSpotLightShadow(t,e,m,h,l):"POINT_LIGHT"===m.type&&this.renderPointLightShadow(t,e,m,f);this._shadowMapNumber[m.type]++}for(s in this._shadowMapNumber)for(var g=this._shadowMapNumber[s],_=s+"_SHADOWMAP_COUNT",p=0;p<this._receivers.length;p++)(y=this._receivers[p].material).fragmentDefines[_]!==g&&(0<g?y.define("fragment",_,g):y.isDefined("fragment",_)&&y.undefine("fragment",_));for(p=0;p<this._receivers.length;p++){var y=this._receivers[p].material;a?y.define("fragment","SHADOW_CASCADE",a.shadowCascade):y.undefine("fragment","SHADOW_CASCADE")}var v,i=e.shadowUniforms;0<u.length&&(o=u.map(x),i.directionalLightShadowMaps={value:u,type:"tv"},i.directionalLightMatrices={value:c,type:"m4v"},i.directionalLightShadowMapSizes={value:o,type:"1fv"},a)&&(o=d.slice(),v=d.slice(),o.pop(),v.shift(),o.reverse(),v.reverse(),c.reverse(),i.shadowCascadeClipsNear={value:o,type:"1fv"},i.shadowCascadeClipsFar={value:v,type:"1fv"}),0<l.length&&(o=l.map(x),(i=e.shadowUniforms).spotLightShadowMaps={value:l,type:"tv"},i.spotLightMatrices={value:h,type:"m4v"},i.spotLightShadowMapSizes={value:o,type:"1fv"}),0<f.length&&(i.pointLightShadowMaps={value:f,type:"tv"})}function x(t){return t.height}},renderDirectionalLightShadow:(yd=new Vr,vd=new M,xd=new je,Td=new M,bd=new M,wd=new M,Sd=new M,function(t,e,r,i,n,o,a){for(var s=this._getDepthMaterial(i),l={getMaterial:function(t){return t.shadowDepthMaterial||s},isMaterialChanged:pd,getUniform:fd,ifRender:function(t){return t.castShadow},sortCompare:de.opaqueSortCompare},h=(e.viewBoundingBoxLastFrame.isFinite()||(d=e.getBoundingBox(),e.viewBoundingBoxLastFrame.copy(d).applyTransform(r.viewMatrix)),Math.min(-e.viewBoundingBoxLastFrame.min.z,r.far)),u=Math.max(-e.viewBoundingBoxLastFrame.max.z,r.near),c=this._getDirectionalLightCamera(i,e,r),d=wd.array,f=(Sd.copy(c.projectionMatrix),k.invert(bd.array,c.worldTransform.array),k.multiply(bd.array,bd.array,r.worldTransform.array),k.multiply(d,Sd.array,bd.array),[]),p=r instanceof hi,m=(r.near+r.far)/(r.near-r.far),g=2*r.near*r.far/(r.near-r.far),_=0;_<=i.shadowCascade;_++){var y=u*Math.pow(h/u,_/i.shadowCascade),v=u+(h-u)*_/i.shadowCascade,y=y*i.cascadeSplitLogFactor+v*(1-i.cascadeSplitLogFactor);f.push(y),n.push(-(-y*m+g)/-y)}var x=this._getTexture(i,i.shadowCascade),d=(a.push(x),t.viewport),a=t.gl;this._frameBuffer.attach(x),this._frameBuffer.bind(t),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(_=0;_<i.shadowCascade;_++){var T=f[_],b=f[_+1],T=(p?k.perspective(vd.array,r.fov/180*Math.PI,r.aspect,T,b):k.ortho(vd.array,r.left,r.right,r.bottom,r.top,T,b),yd.setFromProjection(vd),yd.getTransformedBoundingBox(xd,bd),xd.applyProjection(Sd),xd.min.array),b=xd.max.array,T=(T[0]=Math.max(T[0],-1),T[1]=Math.max(T[1],-1),b[0]=Math.min(b[0],1),b[1]=Math.min(b[1],1),Td.ortho(T[0],b[0],T[1],b[1],1,-1),c.projectionMatrix.multiplyLeft(Td),i.shadowResolution||512),b=(t.setViewport((i.shadowCascade-_-1)*T,0,T,T,1),e.updateRenderList(c)),T=(t.renderPass(b.opaque,c,l),this.softShadow===Ed.VSM&&this._gaussianFilter(t,x,x.width),new M);T.copy(c.viewMatrix).multiplyLeft(c.projectionMatrix),o.push(T.array),c.projectionMatrix.copy(Sd)}this._frameBuffer.unbind(t),t.setViewport(d)}),renderSpotLightShadow:function(t,e,r,i,n){var o=this._getTexture(r),a=this._getSpotLightCamera(r),s=t.gl,l=(this._frameBuffer.attach(o),this._frameBuffer.bind(t),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),this._getDepthMaterial(r)),s={getMaterial:function(t){return t.shadowDepthMaterial||l},isMaterialChanged:pd,getUniform:fd,ifRender:function(t){return t.castShadow},sortCompare:de.opaqueSortCompare},r=e.updateRenderList(a),e=(t.renderPass(r.opaque,a,s),this._frameBuffer.unbind(t),this.softShadow===Ed.VSM&&this._gaussianFilter(t,o,o.width),new M);e.copy(a.worldTransform).invert().multiplyLeft(a.projectionMatrix),n.push(o),i.push(e.array)},renderPointLightShadow:function(t,e,r,i){var n=this._getTexture(r),o=t.gl,a=(i.push(n),this._getDepthMaterial(r)),s={getMaterial:function(t){return t.shadowDepthMaterial||a},getUniform:fd,sortCompare:de.opaqueSortCompare},h={px:[],py:[],pz:[],nx:[],ny:[],nz:[]},u=new je,c=r.getWorldPosition().array,d=new je,i=r.range,i=(d.min.setArray(c),d.max.setArray(c),new C(i,i,i)),f=(d.max.add(i),d.min.sub(i),{px:!1,py:!1,pz:!1,nx:!1,ny:!1,nz:!1});e.traverse(function(t){if(t.isRenderable()&&t.castShadow){var e=t.geometry;if(e.boundingBox){if(u.transformFrom(e.boundingBox,t.worldTransform),u.intersectBoundingBox(d)){u.updateVertices();for(l=0;l<dd.length;l++)f[dd[l]]=!1;for(l=0;l<8;l++){var r=u.vertices[l],i=r[0]-c[0],n=r[1]-c[1],r=r[2]-c[2],o=Math.abs(i),a=Math.abs(n),s=Math.abs(r);a<o?s<o?f[0<i?"px":"nx"]=!0:f[0<r?"pz":"nz"]=!0:s<a?f[0<n?"py":"ny"]=!0:f[0<r?"pz":"nz"]=!0}for(l=0;l<dd.length;l++)f[dd[l]]&&h[dd[l]].push(t)}}else for(var l=0;l<dd.length;l++)h[dd[l]].push(t)}});for(var l=0;l<6;l++){var p=dd[l],m=this._getPointLightCamera(r,p);this._frameBuffer.attach(n,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+l),this._frameBuffer.bind(t),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),t.renderPass(h[p],m,s)}this._frameBuffer.unbind(t)},_getDepthMaterial:function(t){var e,r=this._lightMaterials[t.__uid__],i="POINT_LIGHT"===t.type;return r||(e=i?"clay.sm.distance.":"clay.sm.depth.",r=new Tt({precision:this.precision,shader:new S(S.source(e+"vertex"),S.source(e+"fragment"))}),this._lightMaterials[t.__uid__]=r),null!=t.shadowSlopeScale&&r.setUniform("slopeScale",t.shadowSlopeScale),null!=t.shadowBias&&r.setUniform("bias",t.shadowBias),this.softShadow===Ed.VSM?r.define("fragment","USE_VSM"):r.undefine("fragment","USE_VSM"),i&&(r.set("lightPosition",t.getWorldPosition().array),r.set("range",t.range)),r},_gaussianFilter:function(t,e,r){var i={width:r,height:r,type:B.FLOAT},i=this._texturePool.get(i);this._frameBuffer.attach(i),this._frameBuffer.bind(t),this._gaussianPassH.setUniform("texture",e),this._gaussianPassH.setUniform("textureWidth",r),this._gaussianPassH.render(t),this._frameBuffer.attach(e),this._gaussianPassV.setUniform("texture",i),this._gaussianPassV.setUniform("textureHeight",r),this._gaussianPassV.render(t),this._frameBuffer.unbind(t),this._texturePool.put(i)},_getTexture:function(t,e){var r=t.__uid__,i=this._textures[r],n=t.shadowResolution||512;return e=e||1,i||((i=new("POINT_LIGHT"===t.type?li:F)).width=n*e,i.height=n,this.softShadow===Ed.VSM?(i.type=B.FLOAT,i.anisotropic=4):(i.minFilter=E.NEAREST,i.magFilter=E.NEAREST,i.useMipmap=!1),this._textures[r]=i),i},_getPointLightCamera:function(t,e){this._lightCameras.point||(this._lightCameras.point={px:new hi,nx:new hi,py:new hi,ny:new hi,pz:new hi,nz:new hi});var r=this._lightCameras.point[e];switch(r.far=t.range,r.fov=90,r.position.set(0,0,0),e){case"px":r.lookAt(C.POSITIVE_X,C.NEGATIVE_Y);break;case"nx":r.lookAt(C.NEGATIVE_X,C.NEGATIVE_Y);break;case"py":r.lookAt(C.POSITIVE_Y,C.POSITIVE_Z);break;case"ny":r.lookAt(C.NEGATIVE_Y,C.NEGATIVE_Z);break;case"pz":r.lookAt(C.POSITIVE_Z,C.NEGATIVE_Y);break;case"nz":r.lookAt(C.NEGATIVE_Z,C.NEGATIVE_Y)}return t.getWorldPosition(r.position),r.update(),r},_getDirectionalLightCamera:(md=new M,gd=new je,_d=new je,function(t,e,r){this._lightCameras.directional||(this._lightCameras.directional=new Qi);var i=this._lightCameras.directional,e=(gd.copy(e.viewBoundingBoxLastFrame),gd.intersection(r.frustum.boundingBox),i.position.copy(gd.min).add(gd.max).scale(.5).transformMat4(r.worldTransform),i.rotation.copy(t.rotation),i.scale.copy(t.scale),i.updateWorldTransform(),M.invert(md,i.worldTransform),M.multiply(md,md,r.worldTransform),_d.copy(gd).applyTransform(md),_d.min.array),t=_d.max.array;return i.position.set((e[0]+t[0])/2,(e[1]+t[1])/2,t[2]).transformMat4(i.worldTransform),i.near=0,i.far=-e[2]+t[2],isNaN(this.lightFrustumBias)?i.far*=4:i.far+=this.lightFrustumBias,i.left=e[0],i.right=t[0],i.top=t[1],i.bottom=e[1],i.update(!0),i}),_getSpotLightCamera:function(t){this._lightCameras.spot||(this._lightCameras.spot=new hi);var e=this._lightCameras.spot;return e.fov=2*t.penumbraAngle,e.far=t.range,e.worldTransform.copy(t.worldTransform),e.updateProjectionMatrix(),k.invert(e.viewMatrix.array,e.worldTransform.array),e},dispose:function(t){var e,r=t.gl||t;for(e in this._frameBuffer&&this._frameBuffer.dispose(r),this._textures)this._textures[e].dispose(r);this._texturePool.clear(t.gl),this._depthMaterials={},this._distanceMaterials={},this._textures={},this._lightCameras={},this._shadowMapNumber={POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},this._meshMaterials={};for(var i=0;i<this._receivers.length;i++){var n=this._receivers[i];n.material&&((n=n.material).undefine("fragment","POINT_LIGHT_SHADOW_COUNT"),n.undefine("fragment","DIRECTIONAL_LIGHT_SHADOW_COUNT"),n.undefine("fragment","AMBIENT_LIGHT_SHADOW_COUNT"),n.set("shadowEnabled",0))}this._receivers=[],this._lightsCastShadow=[]}});Ed.VSM=1,Ed.PCF=2;const Md=Ed,Ad=P.extend(function(){return{name:"",inputLinks:{},outputLinks:{},_prevOutputTextures:{},_outputTextures:{},_outputReferences:{},_rendering:!1,_rendered:!1,_compositor:null}},{updateParameter:function(t,e){var r,i=this.outputs[t],n=i.parameters,o=(o=i._parametersCopy)||(i._parametersCopy={});if(n)for(var a in n)"width"!==a&&"height"!==a&&(o[a]=n[a]);return i=n.width instanceof Function?n.width.call(this,e):n.width,r=n.height instanceof Function?n.height.call(this,e):n.height,o.width===i&&o.height===r||this._outputTextures[t]&&this._outputTextures[t].dispose(e.gl),o.width=i,o.height=r,o},setParameter:function(t,e){},getParameter:function(t){},setParameters:function(t){for(var e in t)this.setParameter(e,t[e])},render:function(){},getOutput:function(t,e){var r;return null==e?this._outputTextures[e=t]:(r=this.outputs[e])?(this._rendered?r.outputLastFrame?this._prevOutputTextures:this._outputTextures:this._rendering?(this._prevOutputTextures[e]||(this._prevOutputTextures[e]=this._compositor.allocateTexture(r.parameters||{})),this._prevOutputTextures):(this.render(t),this._outputTextures))[e]:void 0},removeReference:function(t){this._outputReferences[t]--,0===this._outputReferences[t]&&(this.outputs[t].keepLastFrame?(this._prevOutputTextures[t]&&this._compositor.releaseTexture(this._prevOutputTextures[t]),this._prevOutputTextures[t]=this._outputTextures[t]):this._compositor.releaseTexture(this._outputTextures[t]))},link:function(t,e,r){this.inputLinks[t]={node:e,pin:r},e.outputLinks[r]||(e.outputLinks[r]=[]),e.outputLinks[r].push({node:this,pin:t}),this.pass.material.enableTexture(t)},clear:function(){this.inputLinks={},this.outputLinks={}},updateReference:function(t){if(!this._rendering){for(var e in this._rendering=!0,this.inputLinks){e=this.inputLinks[e];e.node.updateReference(e.pin)}this._rendering=!1}t&&this._outputReferences[t]++},beforeFrame:function(){for(var t in this._rendered=!1,this.outputLinks)this._outputReferences[t]=0},afterFrame:function(){for(var t in this.outputLinks)0<this._outputReferences[t]&&(this.outputs[t].keepLastFrame?(this._prevOutputTextures[t]&&this._compositor.releaseTexture(this._prevOutputTextures[t]),this._prevOutputTextures[t]=this._outputTextures[t]):this._compositor.releaseTexture(this._outputTextures[t]))}}),Cd=P.extend(function(){return{nodes:[]}},{dirty:function(){this._dirty=!0},addNode:function(t){0<=this.nodes.indexOf(t)||(this.nodes.push(t),this._dirty=!0)},removeNode:function(t){"string"==typeof t&&(t=this.getNodeByName(t));t=this.nodes.indexOf(t);0<=t&&(this.nodes.splice(t,1),this._dirty=!0)},getNodeByName:function(t){for(var e=0;e<this.nodes.length;e++)if(this.nodes[e].name===t)return this.nodes[e]},update:function(){for(var t=0;t<this.nodes.length;t++)this.nodes[t].clear();for(t=0;t<this.nodes.length;t++){var e,r,i=this.nodes[t];if(i.inputs)for(var n in i.inputs)i.inputs[n]&&(i.pass&&!i.pass.material.isUniformEnabled(n)?console.warn("Pin "+i.name+"."+n+" not used."):(e=i.inputs[n],(r=this.findPin(e))?i.link(n,r.node,r.pin):"string"==typeof e?console.warn("Node "+e+" not exist"):console.warn("Pin of "+e.node+"."+e.pin+" not exist")))}},findPin:function(t){var e;if("string"==typeof(t="string"==typeof t||t instanceof Ad?{node:t}:t).node)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r];i.name===t.node&&(e=i)}else e=t.node;if(e){var n=t.pin;if(n||e.outputs&&(n=Object.keys(e.outputs)[0]),e.outputs[n])return{node:e,pin:n}}}}),Dd=Cd.extend(function(){return{_outputs:[],_texturePool:new cd,_frameBuffer:new xi({depthBuffer:!1})}},{addNode:function(t){Cd.prototype.addNode.call(this,t),t._compositor=this},render:function(t,e){if(this._dirty){this.update(),this._dirty=!1;for(var r=this._outputs.length=0;r<this.nodes.length;r++)this.nodes[r].outputs||this._outputs.push(this.nodes[r])}for(r=0;r<this.nodes.length;r++)this.nodes[r].beforeFrame();for(r=0;r<this._outputs.length;r++)this._outputs[r].updateReference();for(r=0;r<this._outputs.length;r++)this._outputs[r].render(t,e);for(r=0;r<this.nodes.length;r++)this.nodes[r].afterFrame()},allocateTexture:function(t){return this._texturePool.get(t)},releaseTexture:function(t){this._texturePool.put(t)},getFrameBuffer:function(){return this._frameBuffer},dispose:function(t){this._texturePool.clear(t)}}),Ld=Ad.extend({name:"scene",scene:null,camera:null,autoUpdateScene:!0,preZ:!1},function(){this.frameBuffer=new xi},{render:function(t){this._rendering=!0;var e=t.gl;if(this.trigger("beforerender"),this.outputs){var r,i=this.frameBuffer;for(r in this.outputs){var n=this.updateParameter(r,t),o=this.outputs[r],n=this._compositor.allocateTexture(n);this._outputTextures[r]=n,"string"==typeof(s=o.attachment||e.COLOR_ATTACHMENT0)&&(s=e[s]),i.attach(n,s)}i.bind(t);var a=t.getGLExtension("EXT_draw_buffers");if(a){var s,l=[];for(s in this.outputs)(s=parseInt(s))>=e.COLOR_ATTACHMENT0&&s<=e.COLOR_ATTACHMENT0+8&&l.push(s);a.drawBuffersEXT(l)}t.saveClear(),t.clearBit=E.DEPTH_BUFFER_BIT|E.COLOR_BUFFER_BIT,a=t.render(this.scene,this.camera,!this.autoUpdateScene,this.preZ),t.restoreClear(),i.unbind(t)}else a=t.render(this.scene,this.camera,!this.autoUpdateScene,this.preZ);this.trigger("afterrender",a),this._rendering=!1,this._rendered=!0}}),Pd=Ad.extend(function(){return{texture:null,outputs:{color:{}}}},function(){},{getOutput:function(t,e){return this.texture},beforeFrame:function(){},afterFrame:function(){}}),Nd=Ad.extend(function(){return{name:"",inputs:{},outputs:null,shader:"",inputLinks:{},outputLinks:{},pass:null,_prevOutputTextures:{},_outputTextures:{},_outputReferences:{},_rendering:!1,_rendered:!1,_compositor:null}},function(){var t=new tn({fragment:this.shader});this.pass=t},{render:function(t,e){this.trigger("beforerender",t),this._rendering=!0;var r,i=t.gl;for(r in this.inputLinks){var n,o=(n=this.inputLinks[r]).node.getOutput(t,n.pin);this.pass.setUniform(r,o)}if(this.outputs){this.pass.outputs={};var a,s={};for(a in this.outputs){var l,h=this.updateParameter(a,t),u=(isNaN(h.width)&&this.updateParameter(a,t),this.outputs[a]),h=this._compositor.allocateTexture(h);this._outputTextures[a]=h,s[l="string"==typeof(l=u.attachment||i.COLOR_ATTACHMENT0)?i[l]:l]=h}for(l in this._compositor.getFrameBuffer().bind(t),s)this._compositor.getFrameBuffer().attach(s[l],l);this.pass.render(t),this._compositor.getFrameBuffer().updateMipmap(t)}else this.pass.outputs=null,this._compositor.getFrameBuffer().unbind(t),this.pass.render(t,e);for(r in this.inputLinks)(n=this.inputLinks[r]).node.removeReference(n.pin);this._rendering=!1,this._rendered=!0,this.trigger("afterrender",t)},updateParameter:function(t,e){var r,i=this.outputs[t],n=i.parameters,o=(o=i._parametersCopy)||(i._parametersCopy={});if(n)for(var a in n)"width"!==a&&"height"!==a&&(o[a]=n[a]);return i="function"==typeof n.width?n.width.call(this,e):n.width,r="function"==typeof n.height?n.height.call(this,e):n.height,i=Math.ceil(i),r=Math.ceil(r),o.width===i&&o.height===r||this._outputTextures[t]&&this._outputTextures[t].dispose(e),o.width=i,o.height=r,o},setParameter:function(t,e){this.pass.setUniform(t,e)},getParameter:function(t){return this.pass.getUniform(t)},setParameters:function(t){for(var e in t)this.setParameter(e,t[e])},define:function(t,e){this.pass.material.define("fragment",t,e)},undefine:function(t){this.pass.material.undefine("fragment",t)},removeReference:function(t){this._outputReferences[t]--,0===this._outputReferences[t]&&(this.outputs[t].keepLastFrame?(this._prevOutputTextures[t]&&this._compositor.releaseTexture(this._prevOutputTextures[t]),this._prevOutputTextures[t]=this._outputTextures[t]):this._compositor.releaseTexture(this._outputTextures[t]))},clear:function(){Ad.prototype.clear.call(this),this.pass.material.disableTexturesAll()}}),Rd="@export clay.compositor.kernel.gaussian_9\nfloat gaussianKernel[9];\ngaussianKernel[0] = 0.07;\ngaussianKernel[1] = 0.09;\ngaussianKernel[2] = 0.12;\ngaussianKernel[3] = 0.14;\ngaussianKernel[4] = 0.16;\ngaussianKernel[5] = 0.14;\ngaussianKernel[6] = 0.12;\ngaussianKernel[7] = 0.09;\ngaussianKernel[8] = 0.07;\n@end\n@export clay.compositor.kernel.gaussian_13\nfloat gaussianKernel[13];\ngaussianKernel[0] = 0.02;\ngaussianKernel[1] = 0.03;\ngaussianKernel[2] = 0.06;\ngaussianKernel[3] = 0.08;\ngaussianKernel[4] = 0.11;\ngaussianKernel[5] = 0.13;\ngaussianKernel[6] = 0.14;\ngaussianKernel[7] = 0.13;\ngaussianKernel[8] = 0.11;\ngaussianKernel[9] = 0.08;\ngaussianKernel[10] = 0.06;\ngaussianKernel[11] = 0.03;\ngaussianKernel[12] = 0.02;\n@end\n@export clay.compositor.gaussian_blur\n#define SHADER_NAME gaussian_blur\nuniform sampler2D texture;varying vec2 v_Texcoord;\nuniform float blurSize : 2.0;\nuniform vec2 textureSize : [512.0, 512.0];\nuniform float blurDir : 0.0;\n@import clay.util.rgbm\n@import clay.util.clamp_sample\nvoid main (void)\n{\n @import clay.compositor.kernel.gaussian_9\n vec2 off = blurSize / textureSize;\n off *= vec2(1.0 - blurDir, blurDir);\n vec4 sum = vec4(0.0);\n float weightAll = 0.0;\n for (int i = 0; i < 9; i++) {\n float w = gaussianKernel[i];\n vec4 texel = decodeHDR(clampSample(texture, v_Texcoord + float(i - 4) * off));\n sum += texel * w;\n weightAll += w;\n }\n gl_FragColor = encodeHDR(sum / max(weightAll, 0.01));\n}\n@end\n",Id="\n@export clay.compositor.lut\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform sampler2D lookup;\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n float blueColor = tex.b * 63.0;\n vec2 quad1;\n quad1.y = floor(floor(blueColor) / 8.0);\n quad1.x = floor(blueColor) - (quad1.y * 8.0);\n vec2 quad2;\n quad2.y = floor(ceil(blueColor) / 8.0);\n quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n vec2 texPos1;\n texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n vec2 texPos2;\n texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n vec4 newColor1 = texture2D(lookup, texPos1);\n vec4 newColor2 = texture2D(lookup, texPos2);\n vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n gl_FragColor = vec4(newColor.rgb, tex.w);\n}\n@end",Od="@export clay.compositor.output\n#define OUTPUT_ALPHA\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 tex = decodeHDR(texture2D(texture, v_Texcoord));\n gl_FragColor.rgb = tex.rgb;\n#ifdef OUTPUT_ALPHA\n gl_FragColor.a = tex.a;\n#else\n gl_FragColor.a = 1.0;\n#endif\n gl_FragColor = encodeHDR(gl_FragColor);\n#ifdef PREMULTIPLY_ALPHA\n gl_FragColor.rgb *= gl_FragColor.a;\n#endif\n}\n@end",Bd="@export clay.compositor.bright\nuniform sampler2D texture;\nuniform float threshold : 1;\nuniform float scale : 1.0;\nuniform vec2 textureSize: [512, 512];\nvarying vec2 v_Texcoord;\nconst vec3 lumWeight = vec3(0.2125, 0.7154, 0.0721);\n@import clay.util.rgbm\nvec4 median(vec4 a, vec4 b, vec4 c)\n{\n return a + b + c - min(min(a, b), c) - max(max(a, b), c);\n}\nvoid main()\n{\n vec4 texel = decodeHDR(texture2D(texture, v_Texcoord));\n#ifdef ANTI_FLICKER\n vec3 d = 1.0 / textureSize.xyx * vec3(1.0, 1.0, 0.0);\n vec4 s1 = decodeHDR(texture2D(texture, v_Texcoord - d.xz));\n vec4 s2 = decodeHDR(texture2D(texture, v_Texcoord + d.xz));\n vec4 s3 = decodeHDR(texture2D(texture, v_Texcoord - d.zy));\n vec4 s4 = decodeHDR(texture2D(texture, v_Texcoord + d.zy));\n texel = median(median(texel, s1, s2), s3, s4);\n#endif\n float lum = dot(texel.rgb , lumWeight);\n vec4 color;\n if (lum > threshold && texel.a > 0.0)\n {\n color = vec4(texel.rgb * scale, texel.a * scale);\n }\n else\n {\n color = vec4(0.0);\n }\n gl_FragColor = encodeHDR(color);\n}\n@end\n",Fd="@export clay.compositor.downsample\nuniform sampler2D texture;\nuniform vec2 textureSize : [512, 512];\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nfloat brightness(vec3 c)\n{\n return max(max(c.r, c.g), c.b);\n}\n@import clay.util.clamp_sample\nvoid main()\n{\n vec4 d = vec4(-1.0, -1.0, 1.0, 1.0) / textureSize.xyxy;\n#ifdef ANTI_FLICKER\n vec3 s1 = decodeHDR(clampSample(texture, v_Texcoord + d.xy)).rgb;\n vec3 s2 = decodeHDR(clampSample(texture, v_Texcoord + d.zy)).rgb;\n vec3 s3 = decodeHDR(clampSample(texture, v_Texcoord + d.xw)).rgb;\n vec3 s4 = decodeHDR(clampSample(texture, v_Texcoord + d.zw)).rgb;\n float s1w = 1.0 / (brightness(s1) + 1.0);\n float s2w = 1.0 / (brightness(s2) + 1.0);\n float s3w = 1.0 / (brightness(s3) + 1.0);\n float s4w = 1.0 / (brightness(s4) + 1.0);\n float oneDivideSum = 1.0 / (s1w + s2w + s3w + s4w);\n vec4 color = vec4(\n (s1 * s1w + s2 * s2w + s3 * s3w + s4 * s4w) * oneDivideSum,\n 1.0\n );\n#else\n vec4 color = decodeHDR(clampSample(texture, v_Texcoord + d.xy));\n color += decodeHDR(clampSample(texture, v_Texcoord + d.zy));\n color += decodeHDR(clampSample(texture, v_Texcoord + d.xw));\n color += decodeHDR(clampSample(texture, v_Texcoord + d.zw));\n color *= 0.25;\n#endif\n gl_FragColor = encodeHDR(color);\n}\n@end",zd="\n@export clay.compositor.upsample\n#define HIGH_QUALITY\nuniform sampler2D texture;\nuniform vec2 textureSize : [512, 512];\nuniform float sampleScale: 0.5;\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\n@import clay.util.clamp_sample\nvoid main()\n{\n#ifdef HIGH_QUALITY\n vec4 d = vec4(1.0, 1.0, -1.0, 0.0) / textureSize.xyxy * sampleScale;\n vec4 s;\n s = decodeHDR(clampSample(texture, v_Texcoord - d.xy));\n s += decodeHDR(clampSample(texture, v_Texcoord - d.wy)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord - d.zy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zw)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord )) * 4.0;\n s += decodeHDR(clampSample(texture, v_Texcoord + d.xw)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.wy)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord + d.xy));\n gl_FragColor = encodeHDR(s / 16.0);\n#else\n vec4 d = vec4(-1.0, -1.0, +1.0, +1.0) / textureSize.xyxy;\n vec4 s;\n s = decodeHDR(clampSample(texture, v_Texcoord + d.xy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.xw));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zw));\n gl_FragColor = encodeHDR(s / 4.0);\n#endif\n}\n@end",Ud="@export clay.compositor.hdr.composite\n#define TONEMAPPING\nuniform sampler2D texture;\n#ifdef BLOOM_ENABLED\nuniform sampler2D bloom;\n#endif\n#ifdef LENSFLARE_ENABLED\nuniform sampler2D lensflare;\nuniform sampler2D lensdirt;\n#endif\n#ifdef LUM_ENABLED\nuniform sampler2D lum;\n#endif\n#ifdef LUT_ENABLED\nuniform sampler2D lut;\n#endif\n#ifdef COLOR_CORRECTION\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float saturation : 1.0;\n#endif\n#ifdef VIGNETTE\nuniform float vignetteDarkness: 1.0;\nuniform float vignetteOffset: 1.0;\n#endif\nuniform float exposure : 1.0;\nuniform float bloomIntensity : 0.25;\nuniform float lensflareIntensity : 1;\nvarying vec2 v_Texcoord;\n@import clay.util.srgb\nvec3 ACESToneMapping(vec3 color)\n{\n const float A = 2.51;\n const float B = 0.03;\n const float C = 2.43;\n const float D = 0.59;\n const float E = 0.14;\n return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nfloat eyeAdaption(float fLum)\n{\n return mix(0.2, fLum, 0.5);\n}\n#ifdef LUT_ENABLED\nvec3 lutTransform(vec3 color) {\n float blueColor = color.b * 63.0;\n vec2 quad1;\n quad1.y = floor(floor(blueColor) / 8.0);\n quad1.x = floor(blueColor) - (quad1.y * 8.0);\n vec2 quad2;\n quad2.y = floor(ceil(blueColor) / 8.0);\n quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n vec2 texPos1;\n texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.r);\n texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.g);\n vec2 texPos2;\n texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.r);\n texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.g);\n vec4 newColor1 = texture2D(lut, texPos1);\n vec4 newColor2 = texture2D(lut, texPos2);\n vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n return newColor.rgb;\n}\n#endif\n@import clay.util.rgbm\nvoid main()\n{\n vec4 texel = vec4(0.0);\n vec4 originalTexel = vec4(0.0);\n#ifdef TEXTURE_ENABLED\n texel = decodeHDR(texture2D(texture, v_Texcoord));\n originalTexel = texel;\n#endif\n#ifdef BLOOM_ENABLED\n vec4 bloomTexel = decodeHDR(texture2D(bloom, v_Texcoord));\n texel.rgb += bloomTexel.rgb * bloomIntensity;\n texel.a += bloomTexel.a * bloomIntensity;\n#endif\n#ifdef LENSFLARE_ENABLED\n texel += decodeHDR(texture2D(lensflare, v_Texcoord)) * texture2D(lensdirt, v_Texcoord) * lensflareIntensity;\n#endif\n texel.a = min(texel.a, 1.0);\n#ifdef LUM_ENABLED\n float fLum = texture2D(lum, vec2(0.5, 0.5)).r;\n float adaptedLumDest = 3.0 / (max(0.1, 1.0 + 10.0*eyeAdaption(fLum)));\n float exposureBias = adaptedLumDest * exposure;\n#else\n float exposureBias = exposure;\n#endif\n#ifdef TONEMAPPING\n texel.rgb *= exposureBias;\n texel.rgb = ACESToneMapping(texel.rgb);\n#endif\n texel = linearTosRGB(texel);\n#ifdef LUT_ENABLED\n texel.rgb = lutTransform(clamp(texel.rgb,vec3(0.0),vec3(1.0)));\n#endif\n#ifdef COLOR_CORRECTION\n texel.rgb = clamp(texel.rgb + vec3(brightness), 0.0, 1.0);\n texel.rgb = clamp((texel.rgb - vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n float lum = dot(texel.rgb, vec3(0.2125, 0.7154, 0.0721));\n texel.rgb = mix(vec3(lum), texel.rgb, saturation);\n#endif\n#ifdef VIGNETTE\n vec2 uv = (v_Texcoord - vec2(0.5)) * vec2(vignetteOffset);\n texel.rgb = mix(texel.rgb, vec3(1.0 - vignetteDarkness), dot(uv, uv));\n#endif\n gl_FragColor = encodeHDR(texel);\n#ifdef DEBUG\n #if DEBUG == 1\n gl_FragColor = encodeHDR(decodeHDR(texture2D(texture, v_Texcoord)));\n #elif DEBUG == 2\n gl_FragColor = encodeHDR(decodeHDR(texture2D(bloom, v_Texcoord)) * bloomIntensity);\n #elif DEBUG == 3\n gl_FragColor = encodeHDR(decodeHDR(texture2D(lensflare, v_Texcoord) * lensflareIntensity));\n #endif\n#endif\n if (originalTexel.a <= 0.01 && gl_FragColor.a > 1e-5) {\n gl_FragColor.a = dot(gl_FragColor.rgb, vec3(0.2125, 0.7154, 0.0721));\n }\n#ifdef PREMULTIPLY_ALPHA\n gl_FragColor.rgb *= gl_FragColor.a;\n#endif\n}\n@end",kd="@export clay.compositor.blend\n#define SHADER_NAME blend\n#ifdef TEXTURE1_ENABLED\nuniform sampler2D texture1;\nuniform float weight1 : 1.0;\n#endif\n#ifdef TEXTURE2_ENABLED\nuniform sampler2D texture2;\nuniform float weight2 : 1.0;\n#endif\n#ifdef TEXTURE3_ENABLED\nuniform sampler2D texture3;\nuniform float weight3 : 1.0;\n#endif\n#ifdef TEXTURE4_ENABLED\nuniform sampler2D texture4;\nuniform float weight4 : 1.0;\n#endif\n#ifdef TEXTURE5_ENABLED\nuniform sampler2D texture5;\nuniform float weight5 : 1.0;\n#endif\n#ifdef TEXTURE6_ENABLED\nuniform sampler2D texture6;\nuniform float weight6 : 1.0;\n#endif\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 tex = vec4(0.0);\n#ifdef TEXTURE1_ENABLED\n tex += decodeHDR(texture2D(texture1, v_Texcoord)) * weight1;\n#endif\n#ifdef TEXTURE2_ENABLED\n tex += decodeHDR(texture2D(texture2, v_Texcoord)) * weight2;\n#endif\n#ifdef TEXTURE3_ENABLED\n tex += decodeHDR(texture2D(texture3, v_Texcoord)) * weight3;\n#endif\n#ifdef TEXTURE4_ENABLED\n tex += decodeHDR(texture2D(texture4, v_Texcoord)) * weight4;\n#endif\n#ifdef TEXTURE5_ENABLED\n tex += decodeHDR(texture2D(texture5, v_Texcoord)) * weight5;\n#endif\n#ifdef TEXTURE6_ENABLED\n tex += decodeHDR(texture2D(texture6, v_Texcoord)) * weight6;\n#endif\n gl_FragColor = encodeHDR(tex);\n}\n@end",Gd="@export clay.compositor.fxaa\nuniform sampler2D texture;\nuniform vec4 viewport : VIEWPORT;\nvarying vec2 v_Texcoord;\n#define FXAA_REDUCE_MIN (1.0/128.0)\n#define FXAA_REDUCE_MUL (1.0/8.0)\n#define FXAA_SPAN_MAX 8.0\n@import clay.util.rgbm\nvoid main()\n{\n vec2 resolution = 1.0 / viewport.zw;\n vec3 rgbNW = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ) ).xyz;\n vec3 rgbNE = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ) ).xyz;\n vec3 rgbSW = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ) ).xyz;\n vec3 rgbSE = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ) ).xyz;\n vec4 rgbaM = decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution ) );\n vec3 rgbM = rgbaM.xyz;\n float opacity = rgbaM.w;\n vec3 luma = vec3( 0.299, 0.587, 0.114 );\n float lumaNW = dot( rgbNW, luma );\n float lumaNE = dot( rgbNE, luma );\n float lumaSW = dot( rgbSW, luma );\n float lumaSE = dot( rgbSE, luma );\n float lumaM = dot( rgbM, luma );\n float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );\n float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );\n vec2 dir;\n dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );\n float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );\n dir = min( vec2( FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n dir * rcpDirMin)) * resolution;\n vec3 rgbA = decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ) ).xyz;\n rgbA += decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ) ).xyz;\n rgbA *= 0.5;\n vec3 rgbB = decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * -0.5 ) ).xyz;\n rgbB += decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * 0.5 ) ).xyz;\n rgbB *= 0.25;\n rgbB += rgbA * 0.5;\n float lumaB = dot( rgbB, luma );\n if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) )\n {\n gl_FragColor = vec4( rgbA, opacity );\n }\n else {\n gl_FragColor = vec4( rgbB, opacity );\n }\n}\n@end";(g=S).import("@export clay.compositor.coloradjust\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float exposure : 0.0;\nuniform float gamma : 1.0;\nuniform float saturation : 1.0;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord);\n vec3 color = clamp(tex.rgb + vec3(brightness), 0.0, 1.0);\n color = clamp( (color-vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n color = clamp( color * pow(2.0, exposure), 0.0, 1.0);\n color = clamp( pow(color, vec3(gamma)), 0.0, 1.0);\n float luminance = dot( color, w );\n color = mix(vec3(luminance), color, saturation);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.brightness\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float brightness : 0.0;\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord);\n vec3 color = tex.rgb + vec3(brightness);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.contrast\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float contrast : 1.0;\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord);\n vec3 color = (tex.rgb-vec3(0.5))*contrast+vec3(0.5);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.exposure\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float exposure : 0.0;\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n vec3 color = tex.rgb * pow(2.0, exposure);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.gamma\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float gamma : 1.0;\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n vec3 color = pow(tex.rgb, vec3(gamma));\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.saturation\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float saturation : 1.0;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n vec3 color = tex.rgb;\n float luminance = dot(color, w);\n color = mix(vec3(luminance), color, saturation);\n gl_FragColor = vec4(color, tex.a);\n}\n@end"),g.import(Rd),g.import("@export clay.compositor.hdr.log_lum\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n@import clay.util.rgbm\nvoid main()\n{\n vec4 tex = decodeHDR(texture2D(texture, v_Texcoord));\n float luminance = dot(tex.rgb, w);\n luminance = log(luminance + 0.001);\n gl_FragColor = encodeHDR(vec4(vec3(luminance), 1.0));\n}\n@end\n@export clay.compositor.hdr.lum_adaption\nvarying vec2 v_Texcoord;\nuniform sampler2D adaptedLum;\nuniform sampler2D currentLum;\nuniform float frameTime : 0.02;\n@import clay.util.rgbm\nvoid main()\n{\n float fAdaptedLum = decodeHDR(texture2D(adaptedLum, vec2(0.5, 0.5))).r;\n float fCurrentLum = exp(encodeHDR(texture2D(currentLum, vec2(0.5, 0.5))).r);\n fAdaptedLum += (fCurrentLum - fAdaptedLum) * (1.0 - pow(0.98, 30.0 * frameTime));\n gl_FragColor = encodeHDR(vec4(vec3(fAdaptedLum), 1.0));\n}\n@end\n@export clay.compositor.lum\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord );\n float luminance = dot(tex.rgb, w);\n gl_FragColor = vec4(vec3(luminance), 1.0);\n}\n@end"),g.import(Id),g.import("@export clay.compositor.vignette\n#define OUTPUT_ALPHA\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float darkness: 1;\nuniform float offset: 1;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 texel = decodeHDR(texture2D(texture, v_Texcoord));\n gl_FragColor.rgb = texel.rgb;\n vec2 uv = (v_Texcoord - vec2(0.5)) * vec2(offset);\n gl_FragColor = encodeHDR(vec4(mix(texel.rgb, vec3(1.0 - darkness), dot(uv, uv)), texel.a));\n}\n@end"),g.import(Od),g.import(Bd),g.import(Fd),g.import(zd),g.import(Ud),g.import("@export clay.compositor.lensflare\n#define SAMPLE_NUMBER 8\nuniform sampler2D texture;\nuniform sampler2D lenscolor;\nuniform vec2 textureSize : [512, 512];\nuniform float dispersal : 0.3;\nuniform float haloWidth : 0.4;\nuniform float distortion : 1.0;\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nvec4 textureDistorted(\n in vec2 texcoord,\n in vec2 direction,\n in vec3 distortion\n) {\n return vec4(\n decodeHDR(texture2D(texture, texcoord + direction * distortion.r)).r,\n decodeHDR(texture2D(texture, texcoord + direction * distortion.g)).g,\n decodeHDR(texture2D(texture, texcoord + direction * distortion.b)).b,\n 1.0\n );\n}\nvoid main()\n{\n vec2 texcoord = -v_Texcoord + vec2(1.0); vec2 textureOffset = 1.0 / textureSize;\n vec2 ghostVec = (vec2(0.5) - texcoord) * dispersal;\n vec2 haloVec = normalize(ghostVec) * haloWidth;\n vec3 distortion = vec3(-textureOffset.x * distortion, 0.0, textureOffset.x * distortion);\n vec4 result = vec4(0.0);\n for (int i = 0; i < SAMPLE_NUMBER; i++)\n {\n vec2 offset = fract(texcoord + ghostVec * float(i));\n float weight = length(vec2(0.5) - offset) / length(vec2(0.5));\n weight = pow(1.0 - weight, 10.0);\n result += textureDistorted(offset, normalize(ghostVec), distortion) * weight;\n }\n result *= texture2D(lenscolor, vec2(length(vec2(0.5) - texcoord)) / length(vec2(0.5)));\n float weight = length(vec2(0.5) - fract(texcoord + haloVec)) / length(vec2(0.5));\n weight = pow(1.0 - weight, 10.0);\n vec2 offset = fract(texcoord + haloVec);\n result += textureDistorted(offset, normalize(ghostVec), distortion) * weight;\n gl_FragColor = result;\n}\n@end"),g.import(kd),g.import(Gd);var Hd=/^#source\((.*?)\)/;function Vd(t,e){return t}function Wd(t,e){return e}function Xd(r){var o,a={};return r&&(["type","minFilter","magFilter","wrapS","wrapT","flipY","useMipmap"].forEach(function(t){var e=r[t];null!=e&&("string"==typeof e&&(e=B[e]),a[t]=e)}),o=r.scale||1,["width","height"].forEach(function(t){var e,i,n;null!=r[t]&&("string"==typeof(e=r[t])?(e=e.trim(),a[t]=(i=jd(e),n=(n=o)||1,function(t){var e=t.getDevicePixelRatio(),r=t.getWidth()*n,t=t.getHeight()*n;return i(r,t,e)})):a[t]=e)}),a.width||(a.width=Vd),a.height||(a.height=Wd),null!=r.useMipmap)&&(a.useMipmap=r.useMipmap),a}function jd(t){t=/^expr\((.*)\)$/.exec(t);if(t)try{var e=new Function("width","height","dpr","return "+t[1]);return e(1,1),e}catch(t){throw new Error("Invalid expression.")}}const qd=function(n,o){function e(t,e){for(var r=0;r<n.nodes.length;r++){var i=function(t,e,r){var i,n,o,a,s=t.type||"filter";if("filter"===s){var l=t.shader.trim(),h=Hd.exec(l);if(h?i=S.source(h[1].trim()):"#"===l.charAt(0)&&(i=e.shaders[l.substr(1)]),!(i=i||l))return}if(t.inputs)for(var u in n={},t.inputs)"string"==typeof t.inputs[u]?n[u]=t.inputs[u]:n[u]={node:t.inputs[u].node,pin:t.inputs[u].pin};if(t.outputs)for(var u in o={},t.outputs){var c=t.outputs[u];o[u]={},null!=c.attachment&&(o[u].attachment=c.attachment),null!=c.keepLastFrame&&(o[u].keepLastFrame=c.keepLastFrame),null!=c.outputLastFrame&&(o[u].outputLastFrame=c.outputLastFrame),c.parameters&&(o[u].parameters=Xd(c.parameters))}a="scene"===s?new Ld({name:t.name,scene:r.scene,camera:r.camera,outputs:o}):"texture"===s?new Pd({name:t.name,outputs:o}):new Nd({name:t.name,shader:i,inputs:n,outputs:o});if(a){if(t.parameters)for(var u in t.parameters)"string"==typeof(d=t.parameters[u])?"#"===(d=d.trim()).charAt(0)?d=e.textures[d.substr(1)]:a.on("beforerender",function(i,n){return function(t){var e=t.getDevicePixelRatio(),r=t.getWidth(),t=t.getHeight(),r=n(r,t,e);this.setParameter(i,r)}}(u,jd(d))):"function"==typeof d&&a.on("beforerender",d),a.setParameter(u,d);if(t.defines&&a.pass)for(var u in t.defines){var d=t.defines[u];a.pass.material.define("fragment",u,d)}}return a}(n.nodes[r],d,o);i&&c.addNode(i)}}var t,r,i,a,s,l,h,u,c=new Dd,d=(o=o||{},{textures:{},parameters:{}});for(t in n.parameters){var f=n.parameters[t];d.parameters[t]=Xd(f)}return i=o,a=function(t){d.textures=t,e()},(r=n).textures?(l=0,h=!(s={}),u=i.textureRootPath,W.each(r.textures,function(t,e){var r,i=t.path,t=Xd(t.parameters);if(Array.isArray(i)&&6===i.length)u&&(i=i.map(function(t){return W.relative2absolute(t,u)})),r=new li(t);else{if("string"!=typeof i)return;u&&(i=W.relative2absolute(i,u)),r=new F(t)}r.load(i),l++,r.once("success",function(){s[e]=r,0===--l&&(a(s),h=!0)})}),0!==l||h||a(s)):a({}),c};const Zd=function(t,e){for(var r=0,i=1/e,n=t;0<n;)r+=i*(n%e),n=Math.floor(n/e),i/=e;return r};function Yd(t){for(var e=new Uint8Array(t*t*4),r=0,i=new C,n=0;n<t;n++)for(var o=0;o<t;o++)i.set(2*Math.random()-1,2*Math.random()-1,0).normalize(),e[r++]=255*(.5*i.x+.5),e[r++]=255*(.5*i.y+.5),e[r++]=0,e[r++]=255;return e}function Kd(t){return new F({pixels:Yd(t),wrapS:B.REPEAT,wrapT:B.REPEAT,width:t,height:t})}function Qd(t){t=t||{},this._ssaoPass=new tn({fragment:S.source("ecgl.ssao.estimate")}),this._blurPass=new tn({fragment:S.source("ecgl.ssao.blur")}),this._framebuffer=new xi({depthBuffer:!1}),this._ssaoTexture=new F,this._blurTexture=new F,this._blurTexture2=new F,this._depthTex=t.depthTexture,this._normalTex=t.normalTexture,this.setNoiseSize(4),this.setKernelSize(t.kernelSize||12),null!=t.radius&&this.setParameter("radius",t.radius),null!=t.power&&this.setParameter("power",t.power),this._normalTex||(this._ssaoPass.material.disableTexture("normalTex"),this._blurPass.material.disableTexture("normalTex")),this._depthTex||this._blurPass.material.disableTexture("depthTex"),this._blurPass.material.setUniform("normalTex",this._normalTex),this._blurPass.material.setUniform("depthTex",this._depthTex)}S.import("@export ecgl.ssao.estimate\n\nuniform sampler2D depthTex;\n\nuniform sampler2D normalTex;\n\nuniform sampler2D noiseTex;\n\nuniform vec2 depthTexSize;\n\nuniform vec2 noiseTexSize;\n\nuniform mat4 projection;\n\nuniform mat4 projectionInv;\n\nuniform mat4 viewInverseTranspose;\n\nuniform vec3 kernel[KERNEL_SIZE];\n\nuniform float radius : 1;\n\nuniform float power : 1;\n\nuniform float bias: 1e-2;\n\nuniform float intensity: 1.0;\n\nvarying vec2 v_Texcoord;\n\nfloat ssaoEstimator(in vec3 originPos, in mat3 kernelBasis) {\n float occlusion = 0.0;\n\n for (int i = 0; i < KERNEL_SIZE; i++) {\n vec3 samplePos = kernel[i];\n#ifdef NORMALTEX_ENABLED\n samplePos = kernelBasis * samplePos;\n#endif\n samplePos = samplePos * radius + originPos;\n\n vec4 texCoord = projection * vec4(samplePos, 1.0);\n texCoord.xy /= texCoord.w;\n\n vec4 depthTexel = texture2D(depthTex, texCoord.xy * 0.5 + 0.5);\n\n float sampleDepth = depthTexel.r * 2.0 - 1.0;\n if (projection[3][3] == 0.0) {\n sampleDepth = projection[3][2] / (sampleDepth * projection[2][3] - projection[2][2]);\n }\n else {\n sampleDepth = (sampleDepth - projection[3][2]) / projection[2][2];\n }\n \n float rangeCheck = smoothstep(0.0, 1.0, radius / abs(originPos.z - sampleDepth));\n occlusion += rangeCheck * step(samplePos.z, sampleDepth - bias);\n }\n#ifdef NORMALTEX_ENABLED\n occlusion = 1.0 - occlusion / float(KERNEL_SIZE);\n#else\n occlusion = 1.0 - clamp((occlusion / float(KERNEL_SIZE) - 0.6) * 2.5, 0.0, 1.0);\n#endif\n return pow(occlusion, power);\n}\n\nvoid main()\n{\n\n vec4 depthTexel = texture2D(depthTex, v_Texcoord);\n\n#ifdef NORMALTEX_ENABLED\n vec4 tex = texture2D(normalTex, v_Texcoord);\n if (dot(tex.rgb, tex.rgb) == 0.0) {\n gl_FragColor = vec4(1.0);\n return;\n }\n vec3 N = tex.rgb * 2.0 - 1.0;\n N = (viewInverseTranspose * vec4(N, 0.0)).xyz;\n\n vec2 noiseTexCoord = depthTexSize / vec2(noiseTexSize) * v_Texcoord;\n vec3 rvec = texture2D(noiseTex, noiseTexCoord).rgb * 2.0 - 1.0;\n vec3 T = normalize(rvec - N * dot(rvec, N));\n vec3 BT = normalize(cross(N, T));\n mat3 kernelBasis = mat3(T, BT, N);\n#else\n if (depthTexel.r > 0.99999) {\n gl_FragColor = vec4(1.0);\n return;\n }\n mat3 kernelBasis;\n#endif\n\n float z = depthTexel.r * 2.0 - 1.0;\n\n vec4 projectedPos = vec4(v_Texcoord * 2.0 - 1.0, z, 1.0);\n vec4 p4 = projectionInv * projectedPos;\n\n vec3 position = p4.xyz / p4.w;\n\n float ao = ssaoEstimator(position, kernelBasis);\n ao = clamp(1.0 - (1.0 - ao) * intensity, 0.0, 1.0);\n gl_FragColor = vec4(vec3(ao), 1.0);\n}\n\n@end\n\n\n@export ecgl.ssao.blur\n#define SHADER_NAME SSAO_BLUR\n\nuniform sampler2D ssaoTexture;\n\n#ifdef NORMALTEX_ENABLED\nuniform sampler2D normalTex;\n#endif\n\nvarying vec2 v_Texcoord;\n\nuniform vec2 textureSize;\nuniform float blurSize : 1.0;\n\nuniform int direction: 0.0;\n\n#ifdef DEPTHTEX_ENABLED\nuniform sampler2D depthTex;\nuniform mat4 projection;\nuniform float depthRange : 0.5;\n\nfloat getLinearDepth(vec2 coord)\n{\n float depth = texture2D(depthTex, coord).r * 2.0 - 1.0;\n return projection[3][2] / (depth * projection[2][3] - projection[2][2]);\n}\n#endif\n\nvoid main()\n{\n float kernel[5];\n kernel[0] = 0.122581;\n kernel[1] = 0.233062;\n kernel[2] = 0.288713;\n kernel[3] = 0.233062;\n kernel[4] = 0.122581;\n\n vec2 off = vec2(0.0);\n if (direction == 0) {\n off[0] = blurSize / textureSize.x;\n }\n else {\n off[1] = blurSize / textureSize.y;\n }\n\n vec2 coord = v_Texcoord;\n\n float sum = 0.0;\n float weightAll = 0.0;\n\n#ifdef NORMALTEX_ENABLED\n vec3 centerNormal = texture2D(normalTex, v_Texcoord).rgb * 2.0 - 1.0;\n#endif\n#if defined(DEPTHTEX_ENABLED)\n float centerDepth = getLinearDepth(v_Texcoord);\n#endif\n\n for (int i = 0; i < 5; i++) {\n vec2 coord = clamp(v_Texcoord + vec2(float(i) - 2.0) * off, vec2(0.0), vec2(1.0));\n\n float w = kernel[i];\n#ifdef NORMALTEX_ENABLED\n vec3 normal = texture2D(normalTex, coord).rgb * 2.0 - 1.0;\n w *= clamp(dot(normal, centerNormal), 0.0, 1.0);\n#endif\n#ifdef DEPTHTEX_ENABLED\n float d = getLinearDepth(coord);\n w *= (1.0 - smoothstep(abs(centerDepth - d) / depthRange, 0.0, 1.0));\n#endif\n\n weightAll += w;\n sum += texture2D(ssaoTexture, coord).r * w;\n }\n\n gl_FragColor = vec4(vec3(sum / weightAll), 1.0);\n}\n\n@end\n"),Qd.prototype.setDepthTexture=function(t){this._depthTex=t},Qd.prototype.setNormalTexture=function(t){this._normalTex=t,this._ssaoPass.material[t?"enableTexture":"disableTexture"]("normalTex"),this.setKernelSize(this._kernelSize)},Qd.prototype.update=function(t,e,r){var i=t.getWidth(),n=t.getHeight(),o=this._ssaoPass,a=this._blurPass,r=(o.setUniform("kernel",this._kernels[r%this._kernels.length]),o.setUniform("depthTex",this._depthTex),null!=this._normalTex&&o.setUniform("normalTex",this._normalTex),o.setUniform("depthTexSize",[this._depthTex.width,this._depthTex.height]),new M),r=(M.transpose(r,e.worldTransform),o.setUniform("projection",e.projectionMatrix.array),o.setUniform("projectionInv",e.invProjectionMatrix.array),o.setUniform("viewInverseTranspose",r.array),this._ssaoTexture),s=this._blurTexture,l=this._blurTexture2,o=(r.width=i/2,r.height=n/2,s.width=i,s.height=n,l.width=i,l.height=n,this._framebuffer.attach(r),this._framebuffer.bind(t),t.gl.clearColor(1,1,1,1),t.gl.clear(t.gl.COLOR_BUFFER_BIT),o.render(t),a.setUniform("textureSize",[i/2,n/2]),a.setUniform("projection",e.projectionMatrix.array),this._framebuffer.attach(s),a.setUniform("direction",0),a.setUniform("ssaoTexture",r),a.render(t),this._framebuffer.attach(l),a.setUniform("textureSize",[i,n]),a.setUniform("direction",1),a.setUniform("ssaoTexture",s),a.render(t),this._framebuffer.unbind(t),t.clearColor);t.gl.clearColor(o[0],o[1],o[2],o[3])},Qd.prototype.getTargetTexture=function(){return this._blurTexture2},Qd.prototype.setParameter=function(t,e){"noiseTexSize"===t?this.setNoiseSize(e):"kernelSize"===t?this.setKernelSize(e):"intensity"===t?this._ssaoPass.material.set("intensity",e):this._ssaoPass.setUniform(t,e)},Qd.prototype.setKernelSize=function(t){this._kernelSize=t,this._ssaoPass.material.define("fragment","KERNEL_SIZE",t),this._kernels=this._kernels||[];for(var e=0;e<30;e++)this._kernels[e]=function(t,e,r){var i=new Float32Array(3*t);e=e||0;for(var n=0;n<t;n++){var o=Zd(n+e,2)*(r?1:2)*Math.PI,a=Zd(n+e,3)*Math.PI,s=Math.random(),l=Math.cos(o)*Math.sin(a)*s,h=Math.cos(a)*s,o=Math.sin(o)*Math.sin(a)*s;i[3*n]=l,i[3*n+1]=h,i[3*n+2]=o}return i}(t,e*t,!!this._normalTex)},Qd.prototype.setNoiseSize=function(t){var e=this._ssaoPass.getUniform("noiseTex");e?(e.data=Yd(t),e.width=e.height=t,e.dirty()):(e=Kd(t),this._ssaoPass.setUniform("noiseTex",Kd(t))),this._ssaoPass.setUniform("noiseTexSize",[t,t])},Qd.prototype.dispose=function(t){this._blurTexture.dispose(t),this._ssaoTexture.dispose(t),this._blurTexture2.dispose(t)};const Jd=Qd;function $d(t){t=t||{},this._ssrPass=new tn({fragment:S.source("ecgl.ssr.main"),clearColor:[0,0,0,0]}),this._blurPass1=new tn({fragment:S.source("ecgl.ssr.blur"),clearColor:[0,0,0,0]}),this._blurPass2=new tn({fragment:S.source("ecgl.ssr.blur"),clearColor:[0,0,0,0]}),this._blendPass=new tn({fragment:S.source("clay.compositor.blend")}),this._blendPass.material.disableTexturesAll(),this._blendPass.material.enableTexture(["texture1","texture2"]),this._ssrPass.setUniform("gBufferTexture1",t.normalTexture),this._ssrPass.setUniform("gBufferTexture2",t.depthTexture),this._blurPass1.setUniform("gBufferTexture1",t.normalTexture),this._blurPass1.setUniform("gBufferTexture2",t.depthTexture),this._blurPass2.setUniform("gBufferTexture1",t.normalTexture),this._blurPass2.setUniform("gBufferTexture2",t.depthTexture),this._blurPass2.material.define("fragment","VERTICAL"),this._blurPass2.material.define("fragment","BLEND"),this._ssrTexture=new F({type:B.HALF_FLOAT}),this._texture2=new F({type:B.HALF_FLOAT}),this._texture3=new F({type:B.HALF_FLOAT}),this._prevTexture=new F({type:B.HALF_FLOAT}),this._currentTexture=new F({type:B.HALF_FLOAT}),this._frameBuffer=new xi({depthBuffer:!1}),this._normalDistribution=null,this._totalSamples=256,this._samplePerFrame=4,this._ssrPass.material.define("fragment","SAMPLE_PER_FRAME",this._samplePerFrame),this._ssrPass.material.define("fragment","TOTAL_SAMPLES",this._totalSamples),this._downScale=1}S.import("@export ecgl.ssr.main\n\n#define SHADER_NAME SSR\n#define MAX_ITERATION 20;\n#define SAMPLE_PER_FRAME 5;\n#define TOTAL_SAMPLES 128;\n\nuniform sampler2D sourceTexture;\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture2;\nuniform sampler2D gBufferTexture3;\nuniform samplerCube specularCubemap;\nuniform float specularIntensity: 1;\n\nuniform mat4 projection;\nuniform mat4 projectionInv;\nuniform mat4 toViewSpace;\nuniform mat4 toWorldSpace;\n\nuniform float maxRayDistance: 200;\n\nuniform float pixelStride: 16;\nuniform float pixelStrideZCutoff: 50; \nuniform float screenEdgeFadeStart: 0.9; \nuniform float eyeFadeStart : 0.2; uniform float eyeFadeEnd: 0.8; \nuniform float minGlossiness: 0.2; uniform float zThicknessThreshold: 1;\n\nuniform float nearZ;\nuniform vec2 viewportSize : VIEWPORT_SIZE;\n\nuniform float jitterOffset: 0;\n\nvarying vec2 v_Texcoord;\n\n#ifdef DEPTH_DECODE\n@import clay.util.decode_float\n#endif\n\n#ifdef PHYSICALLY_CORRECT\nuniform sampler2D normalDistribution;\nuniform float sampleOffset: 0;\nuniform vec2 normalDistributionSize;\n\nvec3 transformNormal(vec3 H, vec3 N) {\n vec3 upVector = N.y > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n vec3 tangentX = normalize(cross(N, upVector));\n vec3 tangentZ = cross(N, tangentX);\n return normalize(tangentX * H.x + N * H.y + tangentZ * H.z);\n}\nvec3 importanceSampleNormalGGX(float i, float roughness, vec3 N) {\n float p = fract((i + sampleOffset) / float(TOTAL_SAMPLES));\n vec3 H = texture2D(normalDistribution,vec2(roughness, p)).rgb;\n return transformNormal(H, N);\n}\nfloat G_Smith(float g, float ndv, float ndl) {\n float roughness = 1.0 - g;\n float k = roughness * roughness / 2.0;\n float G1V = ndv / (ndv * (1.0 - k) + k);\n float G1L = ndl / (ndl * (1.0 - k) + k);\n return G1L * G1V;\n}\nvec3 F_Schlick(float ndv, vec3 spec) {\n return spec + (1.0 - spec) * pow(1.0 - ndv, 5.0);\n}\n#endif\n\nfloat fetchDepth(sampler2D depthTexture, vec2 uv)\n{\n vec4 depthTexel = texture2D(depthTexture, uv);\n return depthTexel.r * 2.0 - 1.0;\n}\n\nfloat linearDepth(float depth)\n{\n if (projection[3][3] == 0.0) {\n return projection[3][2] / (depth * projection[2][3] - projection[2][2]);\n }\n else {\n return (depth - projection[3][2]) / projection[2][2];\n }\n}\n\nbool rayIntersectDepth(float rayZNear, float rayZFar, vec2 hitPixel)\n{\n if (rayZFar > rayZNear)\n {\n float t = rayZFar; rayZFar = rayZNear; rayZNear = t;\n }\n float cameraZ = linearDepth(fetchDepth(gBufferTexture2, hitPixel));\n return rayZFar <= cameraZ && rayZNear >= cameraZ - zThicknessThreshold;\n}\n\n\nbool traceScreenSpaceRay(\n vec3 rayOrigin, vec3 rayDir, float jitter,\n out vec2 hitPixel, out vec3 hitPoint, out float iterationCount\n)\n{\n float rayLength = ((rayOrigin.z + rayDir.z * maxRayDistance) > -nearZ)\n ? (-nearZ - rayOrigin.z) / rayDir.z : maxRayDistance;\n\n vec3 rayEnd = rayOrigin + rayDir * rayLength;\n\n vec4 H0 = projection * vec4(rayOrigin, 1.0);\n vec4 H1 = projection * vec4(rayEnd, 1.0);\n\n float k0 = 1.0 / H0.w, k1 = 1.0 / H1.w;\n\n vec3 Q0 = rayOrigin * k0, Q1 = rayEnd * k1;\n\n vec2 P0 = (H0.xy * k0 * 0.5 + 0.5) * viewportSize;\n vec2 P1 = (H1.xy * k1 * 0.5 + 0.5) * viewportSize;\n\n P1 += dot(P1 - P0, P1 - P0) < 0.0001 ? 0.01 : 0.0;\n vec2 delta = P1 - P0;\n\n bool permute = false;\n if (abs(delta.x) < abs(delta.y)) {\n permute = true;\n delta = delta.yx;\n P0 = P0.yx;\n P1 = P1.yx;\n }\n float stepDir = sign(delta.x);\n float invdx = stepDir / delta.x;\n\n vec3 dQ = (Q1 - Q0) * invdx;\n float dk = (k1 - k0) * invdx;\n\n vec2 dP = vec2(stepDir, delta.y * invdx);\n\n float strideScaler = 1.0 - min(1.0, -rayOrigin.z / pixelStrideZCutoff);\n float pixStride = 1.0 + strideScaler * pixelStride;\n\n dP *= pixStride; dQ *= pixStride; dk *= pixStride;\n\n vec4 pqk = vec4(P0, Q0.z, k0);\n vec4 dPQK = vec4(dP, dQ.z, dk);\n\n pqk += dPQK * jitter;\n float rayZFar = (dPQK.z * 0.5 + pqk.z) / (dPQK.w * 0.5 + pqk.w);\n float rayZNear;\n\n bool intersect = false;\n\n vec2 texelSize = 1.0 / viewportSize;\n\n iterationCount = 0.0;\n\n for (int i = 0; i < MAX_ITERATION; i++)\n {\n pqk += dPQK;\n\n rayZNear = rayZFar;\n rayZFar = (dPQK.z * 0.5 + pqk.z) / (dPQK.w * 0.5 + pqk.w);\n\n hitPixel = permute ? pqk.yx : pqk.xy;\n hitPixel *= texelSize;\n\n intersect = rayIntersectDepth(rayZNear, rayZFar, hitPixel);\n\n iterationCount += 1.0;\n\n dPQK *= 1.2;\n\n if (intersect) {\n break;\n }\n }\n\n Q0.xy += dQ.xy * iterationCount;\n Q0.z = pqk.z;\n hitPoint = Q0 / pqk.w;\n\n return intersect;\n}\n\nfloat calculateAlpha(\n float iterationCount, float reflectivity,\n vec2 hitPixel, vec3 hitPoint, float dist, vec3 rayDir\n)\n{\n float alpha = clamp(reflectivity, 0.0, 1.0);\n alpha *= 1.0 - (iterationCount / float(MAX_ITERATION));\n vec2 hitPixelNDC = hitPixel * 2.0 - 1.0;\n float maxDimension = min(1.0, max(abs(hitPixelNDC.x), abs(hitPixelNDC.y)));\n alpha *= 1.0 - max(0.0, maxDimension - screenEdgeFadeStart) / (1.0 - screenEdgeFadeStart);\n\n float _eyeFadeStart = eyeFadeStart;\n float _eyeFadeEnd = eyeFadeEnd;\n if (_eyeFadeStart > _eyeFadeEnd) {\n float tmp = _eyeFadeEnd;\n _eyeFadeEnd = _eyeFadeStart;\n _eyeFadeStart = tmp;\n }\n\n float eyeDir = clamp(rayDir.z, _eyeFadeStart, _eyeFadeEnd);\n alpha *= 1.0 - (eyeDir - _eyeFadeStart) / (_eyeFadeEnd - _eyeFadeStart);\n\n alpha *= 1.0 - clamp(dist / maxRayDistance, 0.0, 1.0);\n\n return alpha;\n}\n\n@import clay.util.rand\n\n@import clay.util.rgbm\n\nvoid main()\n{\n vec4 normalAndGloss = texture2D(gBufferTexture1, v_Texcoord);\n\n if (dot(normalAndGloss.rgb, vec3(1.0)) == 0.0) {\n discard;\n }\n\n float g = normalAndGloss.a;\n#if !defined(PHYSICALLY_CORRECT)\n if (g <= minGlossiness) {\n discard;\n }\n#endif\n\n float reflectivity = (g - minGlossiness) / (1.0 - minGlossiness);\n\n vec3 N = normalize(normalAndGloss.rgb * 2.0 - 1.0);\n N = normalize((toViewSpace * vec4(N, 0.0)).xyz);\n\n vec4 projectedPos = vec4(v_Texcoord * 2.0 - 1.0, fetchDepth(gBufferTexture2, v_Texcoord), 1.0);\n vec4 pos = projectionInv * projectedPos;\n vec3 rayOrigin = pos.xyz / pos.w;\n vec3 V = -normalize(rayOrigin);\n\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n float iterationCount;\n float jitter = rand(fract(v_Texcoord + jitterOffset));\n\n#ifdef PHYSICALLY_CORRECT\n vec4 color = vec4(vec3(0.0), 1.0);\n vec4 albedoMetalness = texture2D(gBufferTexture3, v_Texcoord);\n vec3 albedo = albedoMetalness.rgb;\n float m = albedoMetalness.a;\n vec3 diffuseColor = albedo * (1.0 - m);\n vec3 spec = mix(vec3(0.04), albedo, m);\n\n float jitter2 = rand(fract(v_Texcoord)) * float(TOTAL_SAMPLES);\n\n for (int i = 0; i < SAMPLE_PER_FRAME; i++) {\n vec3 H = importanceSampleNormalGGX(float(i) + jitter2, 1.0 - g, N);\n vec3 rayDir = normalize(reflect(-V, H));\n#else\n vec3 rayDir = normalize(reflect(-V, N));\n#endif\n vec2 hitPixel;\n vec3 hitPoint;\n\n bool intersect = traceScreenSpaceRay(rayOrigin, rayDir, jitter, hitPixel, hitPoint, iterationCount);\n\n float dist = distance(rayOrigin, hitPoint);\n\n vec3 hitNormal = texture2D(gBufferTexture1, hitPixel).rgb * 2.0 - 1.0;\n hitNormal = normalize((toViewSpace * vec4(hitNormal, 0.0)).xyz);\n#ifdef PHYSICALLY_CORRECT\n float ndl = clamp(dot(N, rayDir), 0.0, 1.0);\n float vdh = clamp(dot(V, H), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n vec3 litTexel = vec3(0.0);\n if (dot(hitNormal, rayDir) < 0.0 && intersect) {\n litTexel = texture2D(sourceTexture, hitPixel).rgb;\n litTexel *= pow(clamp(1.0 - dist / 200.0, 0.0, 1.0), 3.0);\n\n }\n else {\n #ifdef SPECULARCUBEMAP_ENABLED\n vec3 rayDirW = normalize(toWorldSpace * vec4(rayDir, 0.0)).rgb;\n litTexel = RGBMDecode(textureCubeLodEXT(specularCubemap, rayDirW, 0.0), 8.12).rgb * specularIntensity;\n#endif\n }\n color.rgb += ndl * litTexel * (\n F_Schlick(ndl, spec) * G_Smith(g, ndv, ndl) * vdh / (ndh * ndv + 0.001)\n );\n }\n color.rgb /= float(SAMPLE_PER_FRAME);\n#else\n #if !defined(SPECULARCUBEMAP_ENABLED)\n if (dot(hitNormal, rayDir) >= 0.0) {\n discard;\n }\n if (!intersect) {\n discard;\n }\n#endif\n float alpha = clamp(calculateAlpha(iterationCount, reflectivity, hitPixel, hitPoint, dist, rayDir), 0.0, 1.0);\n vec4 color = texture2D(sourceTexture, hitPixel);\n color.rgb *= alpha;\n\n#ifdef SPECULARCUBEMAP_ENABLED\n vec3 rayDirW = normalize(toWorldSpace * vec4(rayDir, 0.0)).rgb;\n alpha = alpha * (intersect ? 1.0 : 0.0);\n float bias = (1.0 -g) * 5.0;\n color.rgb += (1.0 - alpha)\n * RGBMDecode(textureCubeLodEXT(specularCubemap, rayDirW, bias), 8.12).rgb\n * specularIntensity;\n#endif\n\n#endif\n\n gl_FragColor = encodeHDR(color);\n}\n@end\n\n@export ecgl.ssr.blur\n\nuniform sampler2D texture;\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture2;\nuniform mat4 projection;\nuniform float depthRange : 0.05;\n\nvarying vec2 v_Texcoord;\n\nuniform vec2 textureSize;\nuniform float blurSize : 1.0;\n\n#ifdef BLEND\n #ifdef SSAOTEX_ENABLED\nuniform sampler2D ssaoTex;\n #endif\nuniform sampler2D sourceTexture;\n#endif\n\nfloat getLinearDepth(vec2 coord)\n{\n float depth = texture2D(gBufferTexture2, coord).r * 2.0 - 1.0;\n return projection[3][2] / (depth * projection[2][3] - projection[2][2]);\n}\n\n@import clay.util.rgbm\n\n\nvoid main()\n{\n @import clay.compositor.kernel.gaussian_9\n\n vec4 centerNTexel = texture2D(gBufferTexture1, v_Texcoord);\n float g = centerNTexel.a;\n float maxBlurSize = clamp(1.0 - g, 0.0, 1.0) * blurSize;\n#ifdef VERTICAL\n vec2 off = vec2(0.0, maxBlurSize / textureSize.y);\n#else\n vec2 off = vec2(maxBlurSize / textureSize.x, 0.0);\n#endif\n\n vec2 coord = v_Texcoord;\n\n vec4 sum = vec4(0.0);\n float weightAll = 0.0;\n\n vec3 cN = centerNTexel.rgb * 2.0 - 1.0;\n float cD = getLinearDepth(v_Texcoord);\n for (int i = 0; i < 9; i++) {\n vec2 coord = clamp((float(i) - 4.0) * off + v_Texcoord, vec2(0.0), vec2(1.0));\n float w = gaussianKernel[i]\n * clamp(dot(cN, texture2D(gBufferTexture1, coord).rgb * 2.0 - 1.0), 0.0, 1.0);\n float d = getLinearDepth(coord);\n w *= (1.0 - smoothstep(abs(cD - d) / depthRange, 0.0, 1.0));\n\n weightAll += w;\n sum += decodeHDR(texture2D(texture, coord)) * w;\n }\n\n#ifdef BLEND\n float aoFactor = 1.0;\n #ifdef SSAOTEX_ENABLED\n aoFactor = texture2D(ssaoTex, v_Texcoord).r;\n #endif\n gl_FragColor = encodeHDR(\n sum / weightAll * aoFactor + decodeHDR(texture2D(sourceTexture, v_Texcoord))\n );\n#else\n gl_FragColor = encodeHDR(sum / weightAll);\n#endif\n}\n\n@end"),$d.prototype.setAmbientCubemap=function(t,e){this._ssrPass.material.set("specularCubemap",t),this._ssrPass.material.set("specularIntensity",e),this._ssrPass.material[t&&e?"enableTexture":"disableTexture"]("specularCubemap")},$d.prototype.update=function(t,e,r,i){var n=t.getWidth(),o=t.getHeight(),a=this._ssrTexture,s=this._texture2,l=this._texture3,h=(a.width=this._prevTexture.width=this._currentTexture.width=n/this._downScale,a.height=this._prevTexture.height=this._currentTexture.height=o/this._downScale,s.width=l.width=n,s.height=l.height=o,this._frameBuffer),u=this._ssrPass,c=this._blurPass1,d=this._blurPass2,f=this._blendPass,p=new M,m=new M,p=(M.transpose(p,e.worldTransform),M.transpose(m,e.viewMatrix),u.setUniform("sourceTexture",r),u.setUniform("projection",e.projectionMatrix.array),u.setUniform("projectionInv",e.invProjectionMatrix.array),u.setUniform("toViewSpace",p.array),u.setUniform("toWorldSpace",m.array),u.setUniform("nearZ",e.near),i/this._totalSamples*this._samplePerFrame);u.setUniform("jitterOffset",p),u.setUniform("sampleOffset",i*this._samplePerFrame),c.setUniform("textureSize",[a.width,a.height]),d.setUniform("textureSize",[n,o]),d.setUniform("sourceTexture",r),c.setUniform("projection",e.projectionMatrix.array),d.setUniform("projection",e.projectionMatrix.array),h.attach(a),h.bind(t),u.render(t),this._physicallyCorrect&&(h.attach(this._currentTexture),f.setUniform("texture1",this._prevTexture),f.setUniform("texture2",a),f.material.set({weight1:1<=i?.95:0,weight2:1<=i?.05:1}),f.render(t)),h.attach(s),c.setUniform("texture",this._physicallyCorrect?this._currentTexture:a),c.render(t),h.attach(l),d.setUniform("texture",s),d.render(t),h.unbind(t),this._physicallyCorrect&&(m=this._prevTexture,this._prevTexture=this._currentTexture,this._currentTexture=m)},$d.prototype.getTargetTexture=function(){return this._texture3},$d.prototype.setParameter=function(t,e){"maxIteration"===t?this._ssrPass.material.define("fragment","MAX_ITERATION",e):this._ssrPass.setUniform(t,e)},$d.prototype.setPhysicallyCorrect=function(t){t?(this._normalDistribution||(this._normalDistribution=nn.generateNormalDistribution(64,this._totalSamples)),this._ssrPass.material.define("fragment","PHYSICALLY_CORRECT"),this._ssrPass.material.set("normalDistribution",this._normalDistribution),this._ssrPass.material.set("normalDistributionSize",[64,this._totalSamples])):this._ssrPass.material.undefine("fragment","PHYSICALLY_CORRECT"),this._physicallyCorrect=t},$d.prototype.setSSAOTexture=function(t){var e=this._blurPass2;t?(e.material.enableTexture("ssaoTex"),e.material.set("ssaoTex",t)):e.material.disableTexture("ssaoTex")},$d.prototype.isFinished=function(t){return!this._physicallyCorrect||t>this._totalSamples/this._samplePerFrame},$d.prototype.dispose=function(t){this._ssrTexture.dispose(t),this._texture2.dispose(t),this._texture3.dispose(t),this._prevTexture.dispose(t),this._currentTexture.dispose(t),this._frameBuffer.dispose(t)};const tf=$d,ef=[0,0,-.321585265978,-.154972575841,.458126042375,.188473391593,.842080129861,.527766490688,.147304551086,-.659453822776,-.331943915203,-.940619700594,.0479226680259,.54812163202,.701581552186,-.709825561388,-.295436780218,.940589268233,-.901489676764,.237713156085,.973570876096,-.109899459384,-.866792314779,-.451805525005,.330975007087,.800048655954,-.344275183665,.381779221166,-.386139432542,-.437418421534,-.576478634965,-.0148463392551,.385798197415,-.262426961053,-.666302061145,.682427250835,-.628010632582,-.732836215494,.10163141741,-.987658134403,.711995289051,-.320024291314,.0296005138058,.950296523438,.0130612307608,-.351024443122,-.879596633704,-.10478487883,.435712737232,.504254490347,.779203817497,.206477676721,.388264289969,-.896736162545,-.153106280781,-.629203242522,-.245517550697,.657969239148,.126830499058,.26862328493,-.634888119007,-.302301223431,.617074219636,.779817204925];function rf(t,e,r,i,n){var o=t.gl;e.setUniform(o,"1i",r,n),o.activeTexture(o.TEXTURE0+n),i.isRenderable()?i.bind(t):i.unbind(t)}function nf(t){this._depthTex=new F({format:B.DEPTH_COMPONENT,type:B.UNSIGNED_INT}),this._normalTex=new F({type:B.HALF_FLOAT}),this._framebuffer=new xi,this._framebuffer.attach(this._normalTex),this._framebuffer.attach(this._depthTex,xi.DEPTH_ATTACHMENT),this._normalMaterial=new Tt({shader:new S(S.source("ecgl.normal.vertex"),S.source("ecgl.normal.fragment"))}),this._normalMaterial.enableTexture(["normalMap","bumpMap","roughnessMap"]),this._defaultNormalMap=zi.createBlank("#000"),this._defaultBumpMap=zi.createBlank("#000"),this._defaultRoughessMap=zi.createBlank("#000"),this._debugPass=new tn({fragment:S.source("clay.compositor.output")}),this._debugPass.setUniform("texture",this._normalTex),this._debugPass.material.undefine("fragment","OUTPUT_ALPHA")}S.import("@export ecgl.normal.vertex\n\n@import ecgl.common.transformUniforms\n\n@import ecgl.common.uv.header\n\n@import ecgl.common.attributes\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\n@import ecgl.common.normalMap.vertexHeader\n\n@import ecgl.common.vertexAnimation.header\n\nvoid main()\n{\n\n @import ecgl.common.vertexAnimation.main\n\n @import ecgl.common.uv.main\n\n v_Normal = normalize((worldInverseTranspose * vec4(normal, 0.0)).xyz);\n v_WorldPosition = (world * vec4(pos, 1.0)).xyz;\n\n @import ecgl.common.normalMap.vertexMain\n\n gl_Position = worldViewProjection * vec4(pos, 1.0);\n\n}\n\n\n@end\n\n\n@export ecgl.normal.fragment\n\n#define ROUGHNESS_CHANEL 0\n\nuniform bool useBumpMap;\nuniform bool useRoughnessMap;\nuniform bool doubleSide;\nuniform float roughness;\n\n@import ecgl.common.uv.fragmentHeader\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nuniform mat4 viewInverse : VIEWINVERSE;\n\n@import ecgl.common.normalMap.fragmentHeader\n@import ecgl.common.bumpMap.header\n\nuniform sampler2D roughnessMap;\n\nvoid main()\n{\n vec3 N = v_Normal;\n \n bool flipNormal = false;\n if (doubleSide) {\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(eyePos - v_WorldPosition);\n\n if (dot(N, V) < 0.0) {\n flipNormal = true;\n }\n }\n\n @import ecgl.common.normalMap.fragmentMain\n\n if (useBumpMap) {\n N = bumpNormal(v_WorldPosition, v_Normal, N);\n }\n\n float g = 1.0 - roughness;\n\n if (useRoughnessMap) {\n float g2 = 1.0 - texture2D(roughnessMap, v_DetailTexcoord)[ROUGHNESS_CHANEL];\n g = clamp(g2 + (g - 0.5) * 2.0, 0.0, 1.0);\n }\n\n if (flipNormal) {\n N = -N;\n }\n\n gl_FragColor.rgb = (N.xyz + 1.0) * 0.5;\n gl_FragColor.a = g;\n}\n@end"),nf.prototype.getDepthTexture=function(){return this._depthTex},nf.prototype.getNormalTexture=function(){return this._normalTex},nf.prototype.update=function(t,e,r){var m,g,_,y,v,x,T,b,w,i=t.getWidth(),n=t.getHeight(),o=this._depthTex,a=this._normalTex,s=this._normalMaterial,o=(o.width=i,o.height=n,a.width=i,a.height=n,e.getRenderList(r).opaque);this._framebuffer.bind(t),t.gl.clearColor(0,0,0,0),t.gl.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT),t.gl.disable(t.gl.BLEND),t.renderPass(o,r,{getMaterial:function(){return s},ifRender:function(t){return t.renderNormal},beforeRender:(m=t,g=this._defaultNormalMap,_=this._defaultBumpMap,y=this._defaultRoughessMap,this._normalMaterial,w=m.gl,function(t,e,r){var i,n,o,a,s,l,h,u,c,d,f,p;b&&b.material===t.material||(d=t.material,i=t.__program,null==(n=d.get("roughness"))&&(n=1),o=d.get("normalMap")||g,p=d.get("roughnessMap"),f=d.get("bumpMap"),a=d.get("uvRepeat"),s=d.get("uvOffset"),l=d.get("detailUvRepeat"),h=d.get("detailUvOffset"),u=!!f&&d.isTextureEnabled("bumpMap"),c=!!p&&d.isTextureEnabled("roughnessMap"),d=d.isDefined("fragment","DOUBLE_SIDED"),f=f||_,p=p||y,r!==e?(e.set("normalMap",o),e.set("bumpMap",f),e.set("roughnessMap",p),e.set("useBumpMap",u),e.set("useRoughnessMap",c),e.set("doubleSide",d),null!=a&&e.set("uvRepeat",a),null!=s&&e.set("uvOffset",s),null!=l&&e.set("detailUvRepeat",l),null!=h&&e.set("detailUvOffset",h),e.set("roughness",n)):(i.setUniform(w,"1f","roughness",n),v!==o&&rf(m,i,"normalMap",o,0),x!==f&&f&&rf(m,i,"bumpMap",f,1),T!==p&&p&&rf(m,i,"roughnessMap",p,2),null!=a&&i.setUniform(w,"2f","uvRepeat",a),null!=s&&i.setUniform(w,"2f","uvOffset",s),null!=l&&i.setUniform(w,"2f","detailUvRepeat",l),null!=h&&i.setUniform(w,"2f","detailUvOffset",h),i.setUniform(w,"1i","useBumpMap",+u),i.setUniform(w,"1i","useRoughnessMap",+c),i.setUniform(w,"1i","doubleSide",+d)),v=o,x=f,T=p,b=t)}),sort:t.opaqueSortCompare}),this._framebuffer.unbind(t)},nf.prototype.renderDebug=function(t){this._debugPass.render(t)},nf.prototype.dispose=function(t){this._depthTex.dispose(t),this._normalTex.dispose(t)};const of=nf;function af(t){t=t||{},this._edgePass=new tn({fragment:S.source("ecgl.edge")}),this._edgePass.setUniform("normalTexture",t.normalTexture),this._edgePass.setUniform("depthTexture",t.depthTexture),this._targetTexture=new F({type:B.HALF_FLOAT}),this._frameBuffer=new xi,this._frameBuffer.attach(this._targetTexture)}af.prototype.update=function(t,e,r,i){var n=t.getWidth(),o=t.getHeight(),a=this._targetTexture,a=(a.width=n,a.height=o,this._frameBuffer);a.bind(t),this._edgePass.setUniform("projectionInv",e.invProjectionMatrix.array),this._edgePass.setUniform("textureSize",[n,o]),this._edgePass.setUniform("texture",r),this._edgePass.render(t),a.unbind(t)},af.prototype.getTargetTexture=function(){return this._targetTexture},af.prototype.setParameter=function(t,e){this._edgePass.setUniform(t,e)},af.prototype.dispose=function(t){this._targetTexture.dispose(t),this._frameBuffer.dispose(t)};const sf=af,lf={type:"compositor",nodes:[{name:"source",type:"texture",outputs:{color:{}}},{name:"source_half",shader:"#source(clay.compositor.downsample)",inputs:{texture:"source"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0, height * 1.0] )"}},{name:"bright",shader:"#source(clay.compositor.bright)",inputs:{texture:"source_half"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{threshold:2,scale:4,textureSize:"expr([width * 1.0 / 2, height / 2])"}},{name:"bright_downsample_4",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 2, height / 2] )"}},{name:"bright_downsample_8",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright_downsample_4"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 4, height / 4] )"}},{name:"bright_downsample_16",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright_downsample_8"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 16)",height:"expr(height * 1.0 / 16)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 8, height / 8] )"}},{name:"bright_downsample_32",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright_downsample_16"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 32)",height:"expr(height * 1.0 / 32)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 16, height / 16] )"}},{name:"bright_upsample_16_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_32"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 16)",height:"expr(height * 1.0 / 16)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 32, height / 32] )"}},{name:"bright_upsample_16_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_16_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 16)",height:"expr(height * 1.0 / 16)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 16, height * 1.0 / 16] )"}},{name:"bright_upsample_8_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_16"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 16, height * 1.0 / 16] )"}},{name:"bright_upsample_8_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_8_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 8, height * 1.0 / 8] )"}},{name:"bright_upsample_8_blend",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_8_blur_v",texture2:"bright_upsample_16_blur_v"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"bright_upsample_4_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_8"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 8, height * 1.0 / 8] )"}},{name:"bright_upsample_4_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_4_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 4, height * 1.0 / 4] )"}},{name:"bright_upsample_4_blend",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_4_blur_v",texture2:"bright_upsample_8_blend"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"bright_upsample_2_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_4"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 4, height * 1.0 / 4] )"}},{name:"bright_upsample_2_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_2_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 2, height * 1.0 / 2] )"}},{name:"bright_upsample_2_blend",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_2_blur_v",texture2:"bright_upsample_4_blend"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"bright_upsample_full_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 2, height * 1.0 / 2] )"}},{name:"bright_upsample_full_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_full_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0, height * 1.0] )"}},{name:"bloom_composite",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_full_blur_v",texture2:"bright_upsample_2_blend"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"coc",shader:"#source(ecgl.dof.coc)",outputs:{color:{parameters:{minFilter:"NEAREST",magFilter:"NEAREST",width:"expr(width * 1.0)",height:"expr(height * 1.0)"}}},parameters:{focalDist:50,focalRange:30}},{name:"dof_far_blur",shader:"#source(ecgl.dof.diskBlur)",inputs:{texture:"source",coc:"coc"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0, height * 1.0] )"}},{name:"dof_near_blur",shader:"#source(ecgl.dof.diskBlur)",inputs:{texture:"source",coc:"coc"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0, height * 1.0] )"},defines:{BLUR_NEARFIELD:null}},{name:"dof_coc_blur",shader:"#source(ecgl.dof.diskBlur)",inputs:{texture:"coc"},outputs:{color:{parameters:{minFilter:"NEAREST",magFilter:"NEAREST",width:"expr(width * 1.0)",height:"expr(height * 1.0)"}}},parameters:{textureSize:"expr( [width * 1.0, height * 1.0] )"},defines:{BLUR_COC:null}},{name:"dof_composite",shader:"#source(ecgl.dof.composite)",inputs:{original:"source",blurred:"dof_far_blur",nearfield:"dof_near_blur",coc:"coc",nearcoc:"dof_coc_blur"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}}},{name:"composite",shader:"#source(clay.compositor.hdr.composite)",inputs:{texture:"source",bloom:"bloom_composite"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)"}}},defines:{}},{name:"FXAA",shader:"#source(clay.compositor.fxaa)",inputs:{texture:"composite"}}]};function hf(t,e){return{color:{parameters:{width:t,height:e}}}}S.import(Rd),S.import(Id),S.import(Od),S.import(Bd),S.import(Fd),S.import(zd),S.import(Ud),S.import(kd),S.import(Gd),S.import("@export ecgl.dof.coc\n\nuniform sampler2D depth;\n\nuniform float zNear: 0.1;\nuniform float zFar: 2000;\n\nuniform float focalDistance: 3;\nuniform float focalRange: 1;\nuniform float focalLength: 30;\nuniform float fstop: 2.8;\n\nvarying vec2 v_Texcoord;\n\n@import clay.util.encode_float\n\nvoid main()\n{\n float z = texture2D(depth, v_Texcoord).r * 2.0 - 1.0;\n\n float dist = 2.0 * zNear * zFar / (zFar + zNear - z * (zFar - zNear));\n\n float aperture = focalLength / fstop;\n\n float coc;\n\n float uppper = focalDistance + focalRange;\n float lower = focalDistance - focalRange;\n if (dist <= uppper && dist >= lower) {\n coc = 0.5;\n }\n else {\n float focalAdjusted = dist > uppper ? uppper : lower;\n\n coc = abs(aperture * (focalLength * (dist - focalAdjusted)) / (dist * (focalAdjusted - focalLength)));\n coc = clamp(coc, 0.0, 2.0) / 2.00001;\n\n if (dist < lower) {\n coc = -coc;\n }\n coc = coc * 0.5 + 0.5;\n }\n\n gl_FragColor = encodeFloat(coc);\n}\n@end\n\n\n@export ecgl.dof.composite\n\n#define DEBUG 0\n\nuniform sampler2D original;\nuniform sampler2D blurred;\nuniform sampler2D nearfield;\nuniform sampler2D coc;\nuniform sampler2D nearcoc;\nvarying vec2 v_Texcoord;\n\n@import clay.util.rgbm\n@import clay.util.float\n\nvoid main()\n{\n vec4 blurredColor = texture2D(blurred, v_Texcoord);\n vec4 originalColor = texture2D(original, v_Texcoord);\n\n float fCoc = decodeFloat(texture2D(coc, v_Texcoord));\n\n fCoc = abs(fCoc * 2.0 - 1.0);\n\n float weight = smoothstep(0.0, 1.0, fCoc);\n \n#ifdef NEARFIELD_ENABLED\n vec4 nearfieldColor = texture2D(nearfield, v_Texcoord);\n float fNearCoc = decodeFloat(texture2D(nearcoc, v_Texcoord));\n fNearCoc = abs(fNearCoc * 2.0 - 1.0);\n\n gl_FragColor = encodeHDR(\n mix(\n nearfieldColor, mix(originalColor, blurredColor, weight),\n pow(1.0 - fNearCoc, 4.0)\n )\n );\n#else\n gl_FragColor = encodeHDR(mix(originalColor, blurredColor, weight));\n#endif\n\n}\n\n@end\n\n\n\n@export ecgl.dof.diskBlur\n\n#define POISSON_KERNEL_SIZE 16;\n\nuniform sampler2D texture;\nuniform sampler2D coc;\nvarying vec2 v_Texcoord;\n\nuniform float blurRadius : 10.0;\nuniform vec2 textureSize : [512.0, 512.0];\n\nuniform vec2 poissonKernel[POISSON_KERNEL_SIZE];\n\nuniform float percent;\n\nfloat nrand(const in vec2 n) {\n return fract(sin(dot(n.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\n@import clay.util.rgbm\n@import clay.util.float\n\n\nvoid main()\n{\n vec2 offset = blurRadius / textureSize;\n\n float rnd = 6.28318 * nrand(v_Texcoord + 0.07 * percent );\n float cosa = cos(rnd);\n float sina = sin(rnd);\n vec4 basis = vec4(cosa, -sina, sina, cosa);\n\n#if !defined(BLUR_NEARFIELD) && !defined(BLUR_COC)\n offset *= abs(decodeFloat(texture2D(coc, v_Texcoord)) * 2.0 - 1.0);\n#endif\n\n#ifdef BLUR_COC\n float cocSum = 0.0;\n#else\n vec4 color = vec4(0.0);\n#endif\n\n\n float weightSum = 0.0;\n\n for (int i = 0; i < POISSON_KERNEL_SIZE; i++) {\n vec2 ofs = poissonKernel[i];\n\n ofs = vec2(dot(ofs, basis.xy), dot(ofs, basis.zw));\n\n vec2 uv = v_Texcoord + ofs * offset;\n vec4 texel = texture2D(texture, uv);\n\n float w = 1.0;\n#ifdef BLUR_COC\n float fCoc = decodeFloat(texel) * 2.0 - 1.0;\n cocSum += clamp(fCoc, -1.0, 0.0) * w;\n#else\n texel = texel;\n #if !defined(BLUR_NEARFIELD)\n float fCoc = decodeFloat(texture2D(coc, uv)) * 2.0 - 1.0;\n w *= abs(fCoc);\n #endif\n texel.rgb *= texel.a;\n color += texel * w;\n#endif\n\n weightSum += w;\n }\n\n#ifdef BLUR_COC\n gl_FragColor = encodeFloat(clamp(cocSum / weightSum, -1.0, 0.0) * 0.5 + 0.5);\n#else\n color /= weightSum;\n color.rgb /= (color.a + 0.0001);\n gl_FragColor = color;\n#endif\n}\n\n@end"),S.import("@export ecgl.edge\n\nuniform sampler2D texture;\n\nuniform sampler2D normalTexture;\nuniform sampler2D depthTexture;\n\nuniform mat4 projectionInv;\n\nuniform vec2 textureSize;\n\nuniform vec4 edgeColor: [0,0,0,0.8];\n\nvarying vec2 v_Texcoord;\n\nvec3 packColor(vec2 coord) {\n float z = texture2D(depthTexture, coord).r * 2.0 - 1.0;\n vec4 p = vec4(v_Texcoord * 2.0 - 1.0, z, 1.0);\n vec4 p4 = projectionInv * p;\n\n return vec3(\n texture2D(normalTexture, coord).rg,\n -p4.z / p4.w / 5.0\n );\n}\n\nvoid main() {\n vec2 cc = v_Texcoord;\n vec3 center = packColor(cc);\n\n float size = clamp(1.0 - (center.z - 10.0) / 100.0, 0.0, 1.0) * 0.5;\n float dx = size / textureSize.x;\n float dy = size / textureSize.y;\n\n vec2 coord;\n vec3 topLeft = packColor(cc+vec2(-dx, -dy));\n vec3 top = packColor(cc+vec2(0.0, -dy));\n vec3 topRight = packColor(cc+vec2(dx, -dy));\n vec3 left = packColor(cc+vec2(-dx, 0.0));\n vec3 right = packColor(cc+vec2(dx, 0.0));\n vec3 bottomLeft = packColor(cc+vec2(-dx, dy));\n vec3 bottom = packColor(cc+vec2(0.0, dy));\n vec3 bottomRight = packColor(cc+vec2(dx, dy));\n\n vec3 v = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n vec3 h = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n float edge = sqrt(dot(h, h) + dot(v, v));\n\n edge = smoothstep(0.8, 1.0, edge);\n\n gl_FragColor = mix(texture2D(texture, v_Texcoord), vec4(edgeColor.rgb, 1.0), edgeColor.a * edge);\n}\n@end");var uf=["composite","FXAA"];function D(){this._width,this._height,this._dpr,this._sourceTexture=new F({type:B.HALF_FLOAT}),this._depthTexture=new F({format:B.DEPTH_COMPONENT,type:B.UNSIGNED_INT}),this._framebuffer=new xi,this._framebuffer.attach(this._sourceTexture),this._framebuffer.attach(this._depthTexture,xi.DEPTH_ATTACHMENT),this._normalPass=new of,this._compositor=qd(lf);var t=this._compositor.getNodeByName("source"),e=(t.texture=this._sourceTexture,this._compositor.getNodeByName("coc")),t=(this._sourceNode=t,this._cocNode=e,this._compositeNode=this._compositor.getNodeByName("composite"),this._fxaaNode=this._compositor.getNodeByName("FXAA"),this._dofBlurNodes=["dof_far_blur","dof_near_blur","dof_coc_blur"].map(function(t){return this._compositor.getNodeByName(t)},this),this._dofBlurKernel=0,this._dofBlurKernelSize=new Float32Array(0),this._finalNodesChain=uf.map(function(t){return this._compositor.getNodeByName(t)},this),{normalTexture:this._normalPass.getNormalTexture(),depthTexture:this._normalPass.getDepthTexture()});this._ssaoPass=new Jd(t),this._ssrPass=new tf(t),this._edgePass=new sf(t)}D.prototype.resize=function(t,e,r){var t=t*(r=r||1),e=e*r,i=this._sourceTexture,n=this._depthTexture,o=(i.width=t,i.height=e,n.width=t,n.height=e,{getWidth:function(){return t},getHeight:function(){return e},getDevicePixelRatio:function(){return r}});function a(t,e){var r;"function"==typeof t[e]&&(r=t[e].__original||t[e],t[e]=function(t){return r.call(this,o)},t[e].__original=r)}this._compositor.nodes.forEach(function(t){for(var e in t.outputs){e=t.outputs[e].parameters;e&&(a(e,"width"),a(e,"height"))}for(var r in t.parameters)a(t.parameters,r)}),this._width=t,this._height=e,this._dpr=r},D.prototype.getWidth=function(){return this._width},D.prototype.getHeight=function(){return this._height},D.prototype._ifRenderNormalPass=function(){return this._enableSSAO||this._enableEdge||this._enableSSR},D.prototype._getPrevNode=function(t){for(var e=uf.indexOf(t.name)-1,r=this._finalNodesChain[e];r&&!this._compositor.getNodeByName(r.name);)r=this._finalNodesChain[--e];return r},D.prototype._getNextNode=function(t){for(var e=uf.indexOf(t.name)+1,r=this._finalNodesChain[e];r&&!this._compositor.getNodeByName(r.name);)r=this._finalNodesChain[e+=1];return r},D.prototype._addChainNode=function(t){var e=this._getPrevNode(t),r=this._getNextNode(t);e&&(t.inputs.texture=e.name,r?(t.outputs=hf(this.getWidth.bind(this),this.getHeight.bind(this)),r.inputs.texture=t.name):t.outputs=null,this._compositor.addNode(t))},D.prototype._removeChainNode=function(t){var e=this._getPrevNode(t),r=this._getNextNode(t);e&&(r?(e.outputs=hf(this.getWidth.bind(this),this.getHeight.bind(this)),r.inputs.texture=e.name):e.outputs=null,this._compositor.removeNode(t))},D.prototype.updateNormal=function(t,e,r,i){this._ifRenderNormalPass()&&this._normalPass.update(t,e,r)},D.prototype.updateSSAO=function(t,e,r,i){this._ssaoPass.update(t,r,i)},D.prototype.enableSSAO=function(){this._enableSSAO=!0},D.prototype.disableSSAO=function(){this._enableSSAO=!1},D.prototype.enableSSR=function(){this._enableSSR=!0},D.prototype.disableSSR=function(){this._enableSSR=!1},D.prototype.getSSAOTexture=function(){return this._ssaoPass.getTargetTexture()},D.prototype.getSourceFrameBuffer=function(){return this._framebuffer},D.prototype.getSourceTexture=function(){return this._sourceTexture},D.prototype.disableFXAA=function(){this._removeChainNode(this._fxaaNode)},D.prototype.enableFXAA=function(){this._addChainNode(this._fxaaNode)},D.prototype.enableBloom=function(){this._compositeNode.inputs.bloom="bloom_composite",this._compositor.dirty()},D.prototype.disableBloom=function(){this._compositeNode.inputs.bloom=null,this._compositor.dirty()},D.prototype.enableDOF=function(){this._compositeNode.inputs.texture="dof_composite",this._compositor.dirty()},D.prototype.disableDOF=function(){this._compositeNode.inputs.texture="source",this._compositor.dirty()},D.prototype.enableColorCorrection=function(){this._compositeNode.define("COLOR_CORRECTION"),this._enableColorCorrection=!0},D.prototype.disableColorCorrection=function(){this._compositeNode.undefine("COLOR_CORRECTION"),this._enableColorCorrection=!1},D.prototype.enableEdge=function(){this._enableEdge=!0},D.prototype.disableEdge=function(){this._enableEdge=!1},D.prototype.setBloomIntensity=function(t){this._compositeNode.setParameter("bloomIntensity",t)},D.prototype.setSSAOParameter=function(t,e){switch(t){case"quality":this._ssaoPass.setParameter("kernelSize",{low:6,medium:12,high:32,ultra:62}[e]||12);break;case"radius":this._ssaoPass.setParameter(t,e),this._ssaoPass.setParameter("bias",e/200);break;case"intensity":this._ssaoPass.setParameter(t,e);break;default:console.warn("Unkown SSAO parameter "+t)}},D.prototype.setDOFParameter=function(t,e){switch(t){case"focalDistance":case"focalRange":case"fstop":this._cocNode.setParameter(t,e);break;case"blurRadius":for(var r=0;r<this._dofBlurNodes.length;r++)this._dofBlurNodes[r].setParameter("blurRadius",e);break;case"quality":var i={low:4,medium:8,high:16,ultra:32}[e]||8;this._dofBlurKernelSize=i;for(r=0;r<this._dofBlurNodes.length;r++)this._dofBlurNodes[r].pass.material.define("POISSON_KERNEL_SIZE",i);this._dofBlurKernel=new Float32Array(2*i);break;default:console.warn("Unkown DOF parameter "+t)}},D.prototype.setSSRParameter=function(t,e){if(null!=e)switch(t){case"quality":var r={low:32,medium:16,high:8,ultra:4}[e]||16;this._ssrPass.setParameter("maxIteration",{low:10,medium:15,high:30,ultra:80}[e]||20),this._ssrPass.setParameter("pixelStride",r);break;case"maxRoughness":this._ssrPass.setParameter("minGlossiness",Math.max(Math.min(1-e,1),0));break;case"physical":this.setPhysicallyCorrectSSR(e);break;default:console.warn("Unkown SSR parameter "+t)}},D.prototype.setPhysicallyCorrectSSR=function(t){this._ssrPass.setPhysicallyCorrect(t)},D.prototype.setEdgeColor=function(t){t=q.parseColor(t);this._edgePass.setParameter("edgeColor",t)},D.prototype.setExposure=function(t){this._compositeNode.setParameter("exposure",Math.pow(2,t))},D.prototype.setColorLookupTexture=function(t,e){this._compositeNode.pass.material.setTextureImage("lut",this._enableColorCorrection?t:"none",e,{minFilter:q.Texture.NEAREST,magFilter:q.Texture.NEAREST,flipY:!1})},D.prototype.setColorCorrection=function(t,e){this._compositeNode.setParameter(t,e)},D.prototype.isSSREnabled=function(){return this._enableSSR},D.prototype.composite=function(t,e,r,i,n){for(var o=this._sourceTexture,a=o,s=(this._enableEdge&&(this._edgePass.update(t,r,o,n),o=a=this._edgePass.getTargetTexture()),this._enableSSR&&(this._ssrPass.update(t,r,o,n),a=this._ssrPass.getTargetTexture(),this._ssrPass.setSSAOTexture(this._enableSSAO?this._ssaoPass.getTargetTexture():null)),this._sourceNode.texture=a,this._cocNode.setParameter("depth",this._depthTexture),this._dofBlurKernel),l=this._dofBlurKernelSize,h=n%Math.floor(ef.length/2/l),u=0;u<2*l;u++)s[u]=ef[u+h*l*2];for(u=0;u<this._dofBlurNodes.length;u++)this._dofBlurNodes[u].setParameter("percent",n/30),this._dofBlurNodes[u].setParameter("poissonKernel",s);this._cocNode.setParameter("zNear",r.near),this._cocNode.setParameter("zFar",r.far),this._compositor.render(t,i)},D.prototype.dispose=function(t){this._sourceTexture.dispose(t),this._depthTexture.dispose(t),this._framebuffer.dispose(t),this._compositor.dispose(t),this._normalPass.dispose(t),this._ssaoPass.dispose(t)};const cf=D;function df(t){for(var e=[],r=0;r<30;r++)e.push([Zd(r,2),Zd(r,3)]);this._haltonSequence=e,this._frame=0,this._sourceTex=new F,this._sourceFb=new xi,this._sourceFb.attach(this._sourceTex),this._prevFrameTex=new F,this._outputTex=new F;var i=this._blendPass=new tn({fragment:S.source("clay.compositor.blend")});i.material.disableTexturesAll(),i.material.enableTexture(["texture1","texture2"]),this._blendFb=new xi({depthBuffer:!1}),this._outputPass=new tn({fragment:S.source("clay.compositor.output"),blendWithPrevious:!0}),this._outputPass.material.define("fragment","OUTPUT_ALPHA"),this._outputPass.material.blend=function(t){t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA)}}df.prototype={constructor:df,jitterProjection:function(t,e){var r=t.viewport,t=r.devicePixelRatio||t.getDevicePixelRatio(),i=r.width*t,r=r.height*t,t=this._haltonSequence[this._frame%this._haltonSequence.length],n=new M;n.array[12]=(2*t[0]-1)/i,n.array[13]=(2*t[1]-1)/r,M.mul(e.projectionMatrix,n,e.projectionMatrix),M.invert(e.invProjectionMatrix,e.projectionMatrix)},resetFrame:function(){this._frame=0},getFrame:function(){return this._frame},getSourceFrameBuffer:function(){return this._sourceFb},getOutputTexture:function(){return this._outputTex},resize:function(t,e){this._prevFrameTex.width=t,this._prevFrameTex.height=e,this._outputTex.width=t,this._outputTex.height=e,this._sourceTex.width=t,this._sourceTex.height=e,this._prevFrameTex.dirty(),this._outputTex.dirty(),this._sourceTex.dirty()},isFinished:function(){return this._frame>=this._haltonSequence.length},render:function(t,e,r){var i=this._blendPass,e=(0===this._frame?(i.setUniform("weight1",0),i.setUniform("weight2",1)):(i.setUniform("weight1",.9),i.setUniform("weight2",.1)),i.setUniform("texture1",this._prevFrameTex),i.setUniform("texture2",e||this._sourceTex),this._blendFb.attach(this._outputTex),this._blendFb.bind(t),i.render(t),this._blendFb.unbind(t),r||(this._outputPass.setUniform("texture",this._outputTex),this._outputPass.render(t)),this._prevFrameTex);this._prevFrameTex=this._outputTex,this._outputTex=e,this._frame++},dispose:function(t){this._sourceFb.dispose(t),this._blendFb.dispose(t),this._prevFrameTex.dispose(t),this._outputTex.dispose(t),this._sourceTex.dispose(t),this._outputPass.dispose(t),this._blendPass.dispose(t)}};const ff=df;function pf(t){t=t||"perspective",this.layer=null,this.scene=new $r,this.rootNode=this.scene,this.viewport={x:0,y:0,width:0,height:0},this.setProjection(t),this._compositor=new cf,this._temporalSS=new ff,this._shadowMapPass=new Md;for(var e=[],r=0,i=0;i<30;i++){for(var n=[],o=0;o<6;o++)n.push(4*Zd(r,2)-2),n.push(4*Zd(r,3)-2),r++;e.push(n)}this._pcfKernels=e,this.scene.on("beforerender",function(t,e,r){this.needsTemporalSS()&&this._temporalSS.jitterProjection(t,r)},this)}pf.prototype.setProjection=function(t){var e=this.camera;e&&e.update(),"perspective"===t?this.camera instanceof hi||(this.camera=new hi,e&&this.camera.setLocalTransform(e.localTransform)):this.camera instanceof Qi||(this.camera=new Qi,e&&this.camera.setLocalTransform(e.localTransform)),this.camera.near=.1,this.camera.far=2e3},pf.prototype.setViewport=function(t,e,r,i,n){this.camera instanceof hi&&(this.camera.aspect=r/i),n=n||1,this.viewport.x=t,this.viewport.y=e,this.viewport.width=r,this.viewport.height=i,this.viewport.devicePixelRatio=n,this._compositor.resize(r*n,i*n),this._temporalSS.resize(r*n,i*n)},pf.prototype.containPoint=function(t,e){var r=this.viewport;return e=this.layer.renderer.getHeight()-e,t>=r.x&&e>=r.y&&t<=r.x+r.width&&e<=r.y+r.height};var mf=new Et;pf.prototype.castRay=function(t,e,r){var i=this.layer.renderer,n=i.viewport;return i.viewport=this.viewport,i.screenToNDC(t,e,mf),this.camera.castRay(mf,r),i.viewport=n,r},pf.prototype.prepareRender=function(){this.scene.update(),this.camera.update(),this.scene.updateLights();var t=this.scene.updateRenderList(this.camera);this._needsSortProgressively=!1;for(var e=0;e<t.transparent.length;e++){var r=t.transparent[e].geometry;r.needsSortVerticesProgressively&&r.needsSortVerticesProgressively()&&(this._needsSortProgressively=!0),r.needsSortTrianglesProgressively&&r.needsSortTrianglesProgressively()&&(this._needsSortProgressively=!0)}this._frame=0,this._temporalSS.resetFrame()},pf.prototype.render=function(t,e){this._doRender(t,e,this._frame),this._frame++},pf.prototype.needsAccumulate=function(){return this.needsTemporalSS()||this._needsSortProgressively},pf.prototype.needsTemporalSS=function(){var t=this._enableTemporalSS;return t="auto"===t?this._enablePostEffect:t},pf.prototype.hasDOF=function(){return this._enableDOF},pf.prototype.isAccumulateFinished=function(){return this.needsTemporalSS()?this._temporalSS.isFinished():30<this._frame},pf.prototype._doRender=function(t,e,r){var i,n=this.scene,o=this.camera,r=(this._updateTransparent(t,n,o,r=r||0),e||(this._shadowMapPass.kernelPCF=this._pcfKernels[0],this._shadowMapPass.render(t,n,o,!0)),this._updateShadowPCFKernel(r),t.clearColor);t.gl.clearColor(r[0],r[1],r[2],r[3]),this._enablePostEffect&&(this.needsTemporalSS()&&this._temporalSS.jitterProjection(t,o),this._compositor.updateNormal(t,n,o,this._temporalSS.getFrame())),this._updateSSAO(t,n,o,this._temporalSS.getFrame()),this._enablePostEffect?((i=this._compositor.getSourceFrameBuffer()).bind(t),t.gl.clear(t.gl.DEPTH_BUFFER_BIT|t.gl.COLOR_BUFFER_BIT),t.render(n,o,!0,!0),i.unbind(t),this.needsTemporalSS()&&e?(this._compositor.composite(t,n,o,this._temporalSS.getSourceFrameBuffer(),this._temporalSS.getFrame()),t.setViewport(this.viewport),this._temporalSS.render(t)):(t.setViewport(this.viewport),this._compositor.composite(t,n,o,null,0))):this.needsTemporalSS()&&e?((i=this._temporalSS.getSourceFrameBuffer()).bind(t),t.saveClear(),t.clearBit=t.gl.DEPTH_BUFFER_BIT|t.gl.COLOR_BUFFER_BIT,t.render(n,o,!0,!0),t.restoreClear(),i.unbind(t),t.setViewport(this.viewport),this._temporalSS.render(t)):(t.setViewport(this.viewport),t.render(n,o,!0,!0))},pf.prototype._updateTransparent=function(t,e,r,i){for(var n=new C,o=new M,a=r.getWorldPosition(),s=e.getRenderList(r).transparent,l=0;l<s.length;l++){var h=s[l],u=h.geometry;M.invert(o,h.worldTransform),C.transformMat4(n,a,o),u.needsSortTriangles&&u.needsSortTriangles()&&u.doSortTriangles(n,i),u.needsSortVertices&&u.needsSortVertices()&&u.doSortVertices(n,i)}},pf.prototype._updateSSAO=function(t,e,r){for(var i=this._enableSSAO&&this._enablePostEffect,n=(i&&this._compositor.updateSSAO(t,e,r,this._temporalSS.getFrame()),e.getRenderList(r)),o=0;o<n.opaque.length;o++){var a=n.opaque[o];a.renderNormal&&a.material[i?"enableTexture":"disableTexture"]("ssaoMap"),i&&a.material.set("ssaoMap",this._compositor.getSSAOTexture())}},pf.prototype._updateShadowPCFKernel=function(t){for(var e=this._pcfKernels[t%this._pcfKernels.length],r=this.scene.getRenderList(this.camera).opaque,i=0;i<r.length;i++)r[i].receiveShadow&&(r[i].material.set("pcfKernel",e),r[i].material.define("fragment","PCF_KERNEL_SIZE",e.length/2))},pf.prototype.dispose=function(t){this._compositor.dispose(t.gl),this._temporalSS.dispose(t.gl),this._shadowMapPass.dispose(t)},pf.prototype.setPostEffect=function(t,e){var r=this._compositor,i=(this._enablePostEffect=t.get("enable"),t.getModel("bloom")),n=t.getModel("edge"),o=t.getModel("DOF",t.getModel("depthOfField")),a=t.getModel("SSAO",t.getModel("screenSpaceAmbientOcclusion")),s=t.getModel("SSR",t.getModel("screenSpaceReflection")),l=t.getModel("FXAA"),h=t.getModel("colorCorrection");i.get("enable")?r.enableBloom():r.disableBloom(),o.get("enable")?r.enableDOF():r.disableDOF(),s.get("enable")?r.enableSSR():r.disableSSR(),h.get("enable")?r.enableColorCorrection():r.disableColorCorrection(),n.get("enable")?r.enableEdge():r.disableEdge(),l.get("enable")?r.enableFXAA():r.disableFXAA(),this._enableDOF=o.get("enable"),this._enableSSAO=a.get("enable"),this._enableSSAO?r.enableSSAO():r.disableSSAO(),r.setBloomIntensity(i.get("intensity")),r.setEdgeColor(n.get("color")),r.setColorLookupTexture(h.get("lookupTexture"),e),r.setExposure(h.get("exposure")),["radius","quality","intensity"].forEach(function(t){r.setSSAOParameter(t,a.get(t))}),["quality","maxRoughness","physical"].forEach(function(t){r.setSSRParameter(t,s.get(t))}),["quality","focalDistance","focalRange","blurRadius","fstop"].forEach(function(t){r.setDOFParameter(t,o.get(t))}),["brightness","contrast","saturation"].forEach(function(t){r.setColorCorrection(t,h.get(t))})},pf.prototype.setDOFFocusOnPoint=function(t){if(this._enablePostEffect&&!(t>this.camera.far||t<this.camera.near))return this._compositor.setDOFParameter("focalDistance",t),!0},pf.prototype.setTemporalSuperSampling=function(t){this._enableTemporalSS=t.get("enable")},pf.prototype.isLinearSpace=function(){return this._enablePostEffect},pf.prototype.setRootNode=function(t){if(this.rootNode!==t){for(var e=this.rootNode.children(),r=0;r<e.length;r++)t.add(e[r]);t!==this.scene&&this.scene.add(t),this.rootNode=t}},pf.prototype.add=function(t){this.rootNode.add(t)},pf.prototype.remove=function(t){this.rootNode.remove(t)},pf.prototype.removeAll=function(t){this.rootNode.removeAll(t)},Object.assign(pf.prototype,U);const gf=pf;function _f(e,t){var r=ad(e.getBoxLayoutParams(),{width:t.getWidth(),height:t.getHeight()}),r=(r.y=t.getHeight()-r.y-r.height,this.viewGL.setViewport(r.x,r.y,r.width,r.height,t.getDevicePixelRatio()),e.get("boxWidth")),t=e.get("boxHeight"),i=e.get("boxDepth");["x","y","z"].forEach(function(t){if(!this.getAxis(t))throw new Error("Grid"+e.id+" don't have "+t+"Axis")},this),this.getAxis("x").setExtent(-r/2,r/2),this.getAxis("y").setExtent(i/2,-i/2),this.getAxis("z").setExtent(-t/2,t/2),this.size=[r,t,i]}function yf(t,e){var s={};t.eachSeries(function(t){var i;t.coordinateSystem===this&&(i=t.getData(),["x","y","z"].forEach(function(r){i.mapDimensionsAll(r,!0).forEach(function(t){var e;e=r,t=i.getDataExtent(t,!0),s[e]=s[e]||[1/0,-1/0],s[e][0]=Math.min(t[0],s[e][0]),s[e][1]=Math.max(t[1],s[e][1])})}))},this),["xAxis3D","yAxis3D","zAxis3D"].forEach(function(a){t.eachComponent(a,function(t){var e,r,i=a.charAt(0),n=t.getReferringComponents("grid3D").models[0],o=n.coordinateSystem;o===this&&((r=o.getAxis(i))?console.warn("Can't have two %s in one grid3D",a):(e=O.helper.createScale(s[i]||[1/0,-1/0],t),(r=new Uc(i,e)).type=t.get("type"),i="category"===r.type,r.onBand=i&&t.get("boundaryGap"),r.inverse=t.get("inverse"),(t.axis=r).model=t,r.getLabelModel=function(){return t.getModel("axisLabel",n.getModel("axisLabel"))},r.getTickModel=function(){return t.getModel("axisTick",n.getModel("axisTick"))},o.addAxis(r)))},this)},this),this.resize(this.model,e)}const vf={dimensions:Fc.prototype.dimensions,create:function(o,t){var r=[],a=(o.eachComponent("grid3D",function(t){t.__viewGL=t.__viewGL||new gf;var e=new Fc;e.model=t,e.viewGL=t.__viewGL,t.coordinateSystem=e,r.push(e),e.resize=_f,e.update=yf}),["xAxis3D","yAxis3D","zAxis3D"]);return o.eachSeries(function(t){var r,i,n,e;"cartesian3D"===t.get("coordinateSystem")&&(null==(r=t.getReferringComponents("grid3D").models[0])&&(i=t,n=o,e=a.map(function(t){var e=i.getReferringComponents(t).models[0];if(e=null==e?n.getComponent(t):e)return e;throw new Error(t+' "'+A.firstNotNull(i.get(t+"Index"),i.get(t+"Id"),0)+'" not found')}),r=e[0].getCoordSysModel(),e.forEach(function(t){var e=t.getCoordSysModel();if(!e)throw new Error('grid3D "'+A.firstNotNull(t.get("gridIndex"),t.get("gridId"),0)+'" not found');if(e!==r)throw new Error("xAxis3D, yAxis3D, zAxis3D must use the same grid")})),e=r.coordinateSystem,t.coordinateSystem=e)}),r}};xu=O.ComponentModel.extend({type:"cartesian3DAxis",axis:null,getCoordSysModel:function(){return this.ecModel.queryComponents({mainType:"grid3D",index:this.option.gridIndex,id:this.option.gridId})[0]}});O.helper.mixinAxisModelCommonMethods(xu);const xf=xu;d={show:!0,grid3DIndex:0,inverse:!1,name:"",nameLocation:"middle",nameTextStyle:{fontSize:16},nameGap:20,axisPointer:{},axisLine:{},axisTick:{},axisLabel:{},splitArea:{}},Ou=O.util.merge({boundaryGap:!0,axisTick:{alignWithLabel:!1,interval:"auto"},axisLabel:{interval:"auto"},axisPointer:{label:{show:!1}}},d),Gu=O.util.merge({boundaryGap:[0,0],splitNumber:5,axisPointer:{label:{}}},d),Eu=O.util.defaults({scale:!0,min:"dataMin",max:"dataMax"},Gu),Pu=O.util.defaults({logBase:10},Gu);Pu.scale=!0;const Tf={categoryAxis3D:Ou,valueAxis3D:Gu,timeAxis3D:Eu,logAxis3D:Pu};function bf(t){this.categories=t.categories||[],this._needCollect=t.needCollect,this._deduplication=t.deduplication}function wf(t){return lo(t)&&null!=t.value?t.value:t+""}bf.createByAxisModel=function(t){var t=t.option,e=t.data,e=e&&eo(e,wf);return new bf({categories:e,needCollect:!e,deduplication:!1!==t.dedplication})},bf.prototype.getOrdinal=function(t){return this._getOrCreateMap().get(t)},bf.prototype.parseAndCollect=function(t){var e,r,i=this._needCollect;return"string"==typeof t||i?(i&&!this._deduplication?(r=this.categories.length,this.categories[r]=t):null==(r=(e=this._getOrCreateMap()).get(t))&&(i?(r=this.categories.length,this.categories[r]=t,e.set(t,r)):r=NaN),r):t},bf.prototype._getOrCreateMap=function(){return this._map||(this._map=bo(this.categories))};const Sf=bf;var Ef=["value","category","time","log"];function Mf(t,e){return e.type||(e.data?"category":"value")}(0,O.use)(function(r){r.registerComponentModel(na),r.registerComponentView(Rc),r.registerCoordinateSystem("grid3D",vf),["x","y","z"].forEach(function(t){e=r,i=t,n=xf,o=Mf,a={name:t.toUpperCase()},Ef.forEach(function(r){var t=n.extend({type:i+"Axis3D."+r,__ordinalMeta:null,mergeDefaultAndTheme:function(t,e){e=e.getTheme();O.util.merge(t,e.get(r+"Axis3D")),O.util.merge(t,this.getDefaultOption()),t.type=o(i,t)},optionUpdated:function(){"category"===this.option.type&&(this.__ordinalMeta=Sf.createByAxisModel(this))},getCategories:function(){if("category"===this.option.type)return this.__ordinalMeta.categories},getOrdinalMeta:function(){return this.__ordinalMeta},defaultOption:O.util.merge(O.util.clone(Tf[r+"Axis3D"]),a||{},!0)});e.registerComponentModel(t)}),e.registerSubTypeDefaulter(i+"Axis3D",O.util.curry(o,i));var e,i,n,o,a,t=r.ComponentView.extend({type:t+"Axis3D"});r.registerComponentView(t)}),r.registerAction({type:"grid3DChangeCamera",event:"grid3dcamerachanged",update:"series:updateCamera"},function(e,t){t.eachComponent({mainType:"grid3D",query:e},function(t){t.setView(e)})}),r.registerAction({type:"grid3DShowAxisPointer",event:"grid3dshowaxispointer",update:"grid3D:showAxisPointer"},function(t,e){}),r.registerAction({type:"grid3DHideAxisPointer",event:"grid3dhideaxispointer",update:"grid3D:hideAxisPointer"},function(t,e){})});t={defaultOption:{shading:null,realisticMaterial:{textureTiling:1,textureOffset:0,detailTexture:null},lambertMaterial:{textureTiling:1,textureOffset:0,detailTexture:null},colorMaterial:{textureTiling:1,textureOffset:0,detailTexture:null},hatchingMaterial:{textureTiling:1,textureOffset:0,paperColor:"#fff"}}},g={getFilledRegions:function(t,e){var r,i=(t||[]).slice();if("string"==typeof e?r=(e=O.getMap(e))&&e.geoJson:e&&e.features&&(r=e),!r)return console.error("Map "+e+" not exists. You can download map file on http://echarts.baidu.com/download-map.html"),r.features||console.error("Invalid GeoJSON for map3D"),[];for(var n={},o=r.features,a=0;a<i.length;a++)n[i[a].name]=i[a];for(a=0;a<o.length;a++){var s=o[a].properties.name;n[s]||i.push({name:s})}return i},defaultOption:{show:!0,zlevel:-10,map:"",left:0,top:0,width:"100%",height:"100%",boxWidth:100,boxHeight:10,boxDepth:"auto",regionHeight:3,environment:"auto",groundPlane:{show:!1,color:"#aaa"},shading:"lambert",light:{main:{alpha:40,beta:30}},viewControl:{alpha:40,beta:0,distance:100,orthographicSize:60,minAlpha:5,minBeta:-80,maxBeta:80},label:{show:!1,distance:2,textStyle:{fontSize:20,color:"#000",backgroundColor:"rgba(255,255,255,0.7)",padding:3,borderRadius:4}},itemStyle:{color:"#fff",borderWidth:0,borderColor:"#333"},emphasis:{itemStyle:{color:"#639fc0"},label:{show:!0}}}},U=O.ComponentModel.extend({type:"geo3D",layoutMode:"box",coordinateSystem:null,optionUpdated:function(){var t=this.option,e=(t.regions=this.getFilledRegions(t.regions,t.map),O.helper.createDimensions(t.data||[],{coordDimensions:["value"],encodeDefine:this.get("encode"),dimensionsDefine:this.get("dimensions")})),r=new O.List(e,this),i=(r.initData(t.regions),{});r.each(function(t){var e=r.getName(t),t=r.getItemModel(t);i[e]=t}),this._regionModelMap=i,this._data=r},getData:function(){return this._data},getRegionModel:function(t){t=this.getData().getName(t);return this._regionModelMap[t]||new O.Model(null,this)},getRegionPolygonCoords:function(t){t=this.getData().getName(t),t=this.coordinateSystem.getRegion(t);return t?t.geometries:[]},getFormattedLabel:function(t,e){var r=this._data.getName(t),t=this.getRegionModel(t),i=t.get("normal"===e?["label","formatter"]:["emphasis","label","formatter"]),n={name:r};return"function"==typeof(i=null==i?t.get(["label","formatter"]):i)?(n.status=e,i(n)):"string"==typeof i?i.replace("{a}",null!=(t=n.seriesName)?t:""):r},defaultOption:{regions:[]}});O.util.merge(U.prototype,g),O.util.merge(U.prototype,Q),O.util.merge(U.prototype,Ar),O.util.merge(U.prototype,e),O.util.merge(U.prototype,t);const Af=U,Cf=Df;function Df(t,e,r){r=r||2;var i,n,o,a,s,l=e&&e.length,h=l?e[0]*r:t.length,u=Lf(t,0,h,r,!0),c=[];if(u){if(l&&(u=function(t,e,r,i){var n,o,a,s,l=[];for(n=0,o=e.length;n<o;n++)s=e[n]*i,a=n<o-1?e[n+1]*i:t.length,(s=Lf(t,s,a,i,!1))===s.next&&(s.steiner=!0),l.push(function(t){var e=t,r=t;for(;e.x<r.x&&(r=e),e=e.next,e!==t;);return r}(s));for(l.sort(Rf),n=0;n<l.length;n++)!function(t,e){(e=function(t,e){var r,i=e,n=t.x,o=t.y,a=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var s=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&a<s){if((a=s)===n){if(o===i.y)return i;if(o===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}}while(i=i.next,i!==e);if(!r)return null;if(n===a)return r.prev;var l,h=r,u=r.x,c=r.y,d=1/0;i=r.next;for(;i!==h;)n>=i.x&&i.x>=u&&n!==i.x&&Of(o<c?n:a,o,u,c,o<c?a:n,o,i.x,i.y)&&((l=Math.abs(o-i.y)/(n-i.x))<d||l===d&&i.x>r.x)&&Uf(i,t)&&(r=i,d=l),i=i.next;return r}(t,e))&&Pf(e=kf(e,t),e.next)}(l[n],r),r=Pf(r,r.next);return r}(t,e,u,r)),t.length>80*r){for(var d=i=t[0],f=n=t[1],p=r;p<h;p+=r)(o=t[p])<d&&(d=o),(a=t[p+1])<f&&(f=a),i<o&&(i=o),n<a&&(n=a);s=Math.max(i-d,n-f)}Nf(u,c,r,d,f,s)}return c}function Lf(t,e,r,i,n){var o,a;if(n===0<Wf(t,e,r,i))for(o=e;o<r;o+=i)a=Gf(o,t[o],t[o+1],a);else for(o=r-i;e<=o;o-=i)a=Gf(o,t[o],t[o+1],a);return a&&Ff(a,a.next)&&(Hf(a),a=a.next),a}function Pf(t,e){if(!t)return t;e=e||t;var r,i=t;do{if(r=!1,i.steiner||!Ff(i,i.next)&&0!==Bf(i.prev,i,i.next))i=i.next;else{if(Hf(i),(i=e=i.prev)===i.next)return null;r=!0}}while(r||i!==e);return e}function Nf(t,e,r,i,n,o,a){if(t){if(!a&&o){for(var s=t,l=i,h=n,u=o,c=s;null===c.z&&(c.z=If(c.x,c.y,l,h,u)),c.prevZ=c.prev,c.nextZ=c.next,(c=c.next)!==s;);c.prevZ.nextZ=null,c.prevZ=null;var d,f,p,m,g,_,y,v,x=c,T=1;do{for(f=x,g=x=null,_=0;f;){for(_++,p=f,d=y=0;d<T&&(y++,p=p.nextZ);d++);for(v=T;0<y||0<v&&p;)0!==y&&(0===v||!p||f.z<=p.z)?(f=(m=f).nextZ,y--):(p=(m=p).nextZ,v--),g?g.nextZ=m:x=m,m.prevZ=g,g=m;f=p}}while(g.nextZ=null,T*=2,1<_)}for(var b,w,S=t;t.prev!==t.next;)if(b=t.prev,w=t.next,o?function(t,e,r,i){var n=t.prev,o=t,a=t.next;if(0<=Bf(n,o,a))return;var s=(n.x<o.x?n.x<a.x?n:a:o.x<a.x?o:a).x,l=(n.y<o.y?n.y<a.y?n:a:o.y<a.y?o:a).y,h=(n.x>o.x?n.x>a.x?n:a:o.x>a.x?o:a).x,u=(n.y>o.y?n.y>a.y?n:a:o.y>a.y?o:a).y,c=If(s,l,e,r,i),d=If(h,u,e,r,i),f=t.nextZ;for(;f&&f.z<=d;){if(f!==t.prev&&f!==t.next&&Of(n.x,n.y,o.x,o.y,a.x,a.y,f.x,f.y)&&0<=Bf(f.prev,f,f.next))return;f=f.nextZ}f=t.prevZ;for(;f&&f.z>=c;){if(f!==t.prev&&f!==t.next&&Of(n.x,n.y,o.x,o.y,a.x,a.y,f.x,f.y)&&0<=Bf(f.prev,f,f.next))return;f=f.prevZ}return 1}(t,i,n,o):function(t){var e=t.prev,r=t,i=t.next;if(0<=Bf(e,r,i))return;var n=t.next.next;for(;n!==t.prev;){if(Of(e.x,e.y,r.x,r.y,i.x,i.y,n.x,n.y)&&0<=Bf(n.prev,n,n.next))return;n=n.next}return 1}(t))e.push(b.i/r),e.push(t.i/r),e.push(w.i/r),Hf(t),t=w.next,S=w.next;else if((t=w)===S){a?1===a?Nf(t=function(t,e,r){var i=t;do{var n=i.prev,o=i.next.next}while(!Ff(n,o)&&zf(n,i,i.next,o)&&Uf(n,o)&&Uf(o,n)&&(e.push(n.i/r),e.push(i.i/r),e.push(o.i/r),Hf(i),Hf(i.next),i=t=o),i=i.next,i!==t);return i}(t,e,r),e,r,i,n,o,2):2===a&&function(t,e,r,i,n,o){var a=t;do{for(var s,l=a.next.next;l!==a.prev;){if(a.i!==l.i&&function(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&zf(r,r.next,t,e))return 1}while(r=r.next,r!==t);return}(t,e)&&Uf(t,e)&&Uf(e,t)&&function(t,e){var r=t,i=!1,n=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;r.y>o!=r.next.y>o&&r.next.y!==r.y&&n<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next,r!==t;);return i}(t,e)}(a,l))return s=kf(a,l),a=Pf(a,a.next),s=Pf(s,s.next),Nf(a,e,r,i,n,o),Nf(s,e,r,i,n,o);l=l.next}}while(a=a.next,a!==t)}(t,e,r,i,n,o):Nf(Pf(t),e,r,i,n,o,1);break}}}function Rf(t,e){return t.x-e.x}function If(t,e,r,i,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)/n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Of(t,e,r,i,n,o,a,s){return 0<=(n-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(i-s)-(r-a)*(e-s)&&0<=(r-a)*(o-s)-(n-a)*(i-s)}function Bf(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function Ff(t,e){return t.x===e.x&&t.y===e.y}function zf(t,e,r,i){return Ff(t,e)&&Ff(r,i)||Ff(t,i)&&Ff(r,e)||0<Bf(t,e,r)!=0<Bf(t,e,i)&&0<Bf(r,i,t)!=0<Bf(r,i,e)}function Uf(t,e){return Bf(t.prev,t,t.next)<0?0<=Bf(t,e,t.next)&&0<=Bf(t,t.prev,e):Bf(t,e,t.prev)<0||Bf(t,t.next,e)<0}function kf(t,e){var r=new Vf(t.i,t.x,t.y),i=new Vf(e.i,e.x,e.y),n=t.next,o=e.prev;return(t.next=e).prev=t,(r.next=n).prev=r,(i.next=r).prev=i,(o.next=i).prev=o,i}function Gf(t,e,r,i){t=new Vf(t,e,r);return i?(t.next=i.next,(t.prev=i).next.prev=t,i.next=t):(t.prev=t).next=t,t}function Hf(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Vf(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Wf(t,e,r,i){for(var n=0,o=e,a=r-i;o<r;o+=i)n+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return n}function Xf(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}function jf(t,e,r,i,n){var o=r,a=t[e];Xf(t,e,i);for(var s=r;s<i;s++)n(t[s],a)<0&&(Xf(t,s,o),o++);return Xf(t,i,o),o}function qf(t,e,r,i){r<i&&(qf(t,e,r,(r=jf(t,Math.floor((r+i)/2),r,i,e))-1),qf(t,e,r+1,i))}function Zf(){this._parts=[]}Df.deviation=function(t,e,r,i){var n=e&&e.length,o=n?e[0]*r:t.length,a=Math.abs(Wf(t,0,o,r));if(n)for(var s=0,l=e.length;s<l;s++){var h=e[s]*r,u=s<l-1?e[s+1]*r:t.length;a-=Math.abs(Wf(t,h,u,r))}for(var c=0,s=0;s<i.length;s+=3){var d=i[s]*r,f=i[s+1]*r,p=i[s+2]*r;c+=Math.abs((t[d]-t[p])*(t[1+f]-t[1+d])-(t[d]-t[f])*(t[1+p]-t[1+d]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},Zf.prototype.step=function(t,e,r){var i=t.length;if(0===r&&(this._parts=[],this._sorted=!1,r=Math.floor(i/2),this._parts.push({pivot:r,left:0,right:i-1}),this._currentSortPartIdx=0),!this._sorted){var n=this._parts;if(0===n.length)return this._sorted=!0;if(n.length<512){for(var o=0;o<n.length;o++)n[o].pivot=jf(t,n[o].pivot,n[o].left,n[o].right,e);for(var a=[],o=0;o<n.length;o++){var s=n[o].left,l=n[o].pivot-1;s<l&&a.push({pivot:Math.floor((l+s)/2),left:s,right:l}),(s=n[o].pivot+1)<(l=n[o].right)&&a.push({pivot:Math.floor((l+s)/2),left:s,right:l})}n=this._parts=a}else for(o=0;o<Math.floor(n.length/10);o++){var h=n.length-1-this._currentSortPartIdx;if(qf(t,e,n[h].left,n[h].right),this._currentSortPartIdx++,this._currentSortPartIdx===n.length)return this._sorted=!0}return!1}},Zf.sort=qf;const Yf=Zf;var Kf=m.vec3,Qf=Kf.create(),Jf=Kf.create(),$f=Kf.create();const tp={needsSortTriangles:function(){return this.indices&&this.sortTriangles},needsSortTrianglesProgressively:function(){return this.needsSortTriangles()&&2e4<=this.triangleCount},doSortTriangles:function(t,e){var r=this.indices;if(0===e)for(var i,n=this.attributes.position,t=t.array,o=(this._triangleZList&&this._triangleZList.length===this.triangleCount||(this._triangleZList=new Float32Array(this.triangleCount),this._sortedTriangleIndices=new Uint32Array(this.triangleCount),this._indicesTmp=new r.constructor(r.length),this._triangleZListTmp=new Float32Array(this.triangleCount)),0),a=0;a<r.length;){n.get(r[a++],Qf),n.get(r[a++],Jf),n.get(r[a++],$f);var s=Kf.sqrDist(Qf,t),l=Kf.sqrDist(Jf,t),h=Kf.sqrDist($f,t),s=Math.min(s,l),s=Math.min(s,h);3===a?(i=s,s=0):s-=i,this._triangleZList[o++]=s}for(var u=this._sortedTriangleIndices,a=0;a<u.length;a++)u[a]=a;if(this.triangleCount<2e4)0===e&&this._simpleSort(!0);else for(a=0;a<3;a++)this._progressiveQuickSort(3*e+a);for(var c=this._indicesTmp,d=this._triangleZListTmp,f=this._triangleZList,a=0;a<this.triangleCount;a++){var p=3*u[a],m=3*a;c[m++]=r[p++],c[m++]=r[p++],c[m]=r[p],d[a]=f[u[a]]}var g=this._indicesTmp,g=(this._indicesTmp=this.indices,this.indices=g,this._triangleZListTmp);this._triangleZListTmp=this._triangleZList,this._triangleZList=g,this.dirtyIndices()},_simpleSort:function(t){var r=this._triangleZList,e=this._sortedTriangleIndices;function i(t,e){return r[e]-r[t]}t?Array.prototype.sort.call(e,i):Yf.sort(e,i,0,e.length-1)},_progressiveQuickSort:function(t){var r=this._triangleZList,e=this._sortedTriangleIndices;this._quickSort=this._quickSort||new Yf,this._quickSort.step(e,function(t,e){return r[e]-r[t]},t)}};function ep(t,e){e=t.getItemVisual(e,"style");if(e)return e[t.getVisual("drawType")]}function rp(t,e){t=t.getItemVisual(e,"style");return t&&t.opacity}function ip(t,e,r){this._labelsMesh=new Ec,this._labelTextureSurface=new uc({width:512,height:512,devicePixelRatio:r.getDevicePixelRatio(),onupdate:function(){r.getZr().refresh()}}),this._api=r,this._labelsMesh.material.set("textureAtlas",this._labelTextureSurface.getTexture())}ip.prototype.getLabelPosition=function(t,e,r){return[0,0,0]},ip.prototype.getLabelDistance=function(t,e,r){return 0},ip.prototype.getMesh=function(){return this._labelsMesh},ip.prototype.updateData=function(t,e,r){null==e&&(e=0),null==r&&(r=t.count()),this._labelsVisibilitiesBits&&this._labelsVisibilitiesBits.length===r-e||(this._labelsVisibilitiesBits=new Uint8Array(r-e));for(var i=["label","show"],n=["emphasis","label","show"],o=e;o<r;o++){var a=t.getItemModel(o),s=a.get(i),a=a.get(n),s=(s?1:0)|((a=null==a?s:a)?2:0);this._labelsVisibilitiesBits[o-e]=s}this._start=e,this._end=r,this._data=t},ip.prototype.updateLabels=function(t){if(this._data){for(var e=0<(t=t||[]).length,r={},i=0;i<t.length;i++)r[t[i]]=!0;this._labelsMesh.geometry.convertToDynamicArray(!0),this._labelTextureSurface.clear();for(var n=["label"],o=["emphasis","label"],a=this._data.hostModel,s=this._data,l=a.getModel(n),h=a.getModel(o,l),u={left:"right",right:"left",top:"center",bottom:"center"},c={left:"middle",right:"middle",top:"bottom",bottom:"top"},d=this._start;d<this._end;d++){var f=!1;if(this._labelsVisibilitiesBits[d-this._start]&((f=e&&r[d]?!0:f)?2:1)){var p=s.getItemModel(d).getModel(f?o:n,f?h:l),m=p.get("distance")||0,g=p.get("position"),_=this._api.getDevicePixelRatio(),f=a.getFormattedLabel(d,f?"emphasis":"normal");if(null==f||""===f)return;var f=new O.graphic.Text({style:Ku(p,{text:f,fill:p.get("color")||ep(s,d)||"#000",align:"left",verticalAlign:"top",opacity:A.firstNotNull(p.get("opacity"),rp(s,d),1)})}),p=f.getBoundingRect(),f=(p.height*=1.2,this._labelTextureSurface.add(f)),y=u[g]||"center",v=c[g]||"bottom";this._labelsMesh.geometry.addSprite(this.getLabelPosition(d,g,m),[p.width*_,p.height*_],f,y,v,this.getLabelDistance(d,g,m)*_)}}this._labelsMesh.material.set("uvScale",this._labelTextureSurface.getCoordsScale()),this._labelTextureSurface.getZr().refreshImmediately(),this._labelsMesh.geometry.convertToTypedArray(),this._labelsMesh.geometry.dirty()}},ip.prototype.dispose=function(){this._labelTextureSurface.dispose()};const np=ip;var op=m.vec3;function ap(t){this.rootNode=new q.Node,this._triangulationResults={},this._shadersMap=q.COMMON_SHADERS.filter(function(t){return"shadow"!==t}).reduce(function(t,e){return t[e]=q.createShader("ecgl."+e),t},{}),this._linesShader=q.createShader("ecgl.meshLines3D");var e={};q.COMMON_SHADERS.forEach(function(t){e[t]=new q.Material({shader:q.createShader("ecgl."+t)})}),this._groundMaterials=e,this._groundMesh=new q.Mesh({geometry:new q.PlaneGeometry({dynamic:!0}),castShadow:!1,renderNormal:!0,$ignorePicking:!0}),this._groundMesh.rotation.rotateX(-Math.PI/2),this._labelsBuilder=new np(512,512,t),this._labelsBuilder.getMesh().renderOrder=100,this._labelsBuilder.getMesh().material.depthTest=!1,this.rootNode.add(this._labelsBuilder.getMesh()),this._initMeshes(),this._api=t}q.Shader.import(y),ap.prototype={constructor:ap,extrudeY:!0,update:function(t,e,r,i,n){var o=t.getData(),a=(null==i&&(i=0),null==n&&(n=o.count()),this._startIndex=i,this._endIndex=n-1,this._triangulation(t,i,n),this._getShader(t.get("shading"))),s=(this._prepareMesh(t,a,r,i,n),this.rootNode.updateWorldTransform(),this._updateRegionMesh(t,r,i,n),t.coordinateSystem),l=("geo3D"===s.type&&this._updateGroundPlane(t,s,r),this);this._labelsBuilder.updateData(o,i,n),this._labelsBuilder.getLabelPosition=function(t,e,r){var i,n=o.getName(t);if("geo3D"===s.type)return(n=s.getRegion(n))?(i=n.getCenter(),s.dataToPoint([i[0],i[1],r])):[NaN,NaN,NaN];n=l._triangulationResults[t-l._startIndex],i=l.extrudeY?[(n.max[0]+n.min[0])/2,n.max[1]+r,(n.max[2]+n.min[2])/2]:[(n.max[0]+n.min[0])/2,(n.max[1]+n.min[1])/2,n.max[2]+r]},this._data=o,this._labelsBuilder.updateLabels(),this._updateDebugWireframe(t),this._lastHoverDataIndex=0},_initMeshes:function(){var t=this;t=new q.Mesh({name:"Polygon",material:new q.Material({shader:t._shadersMap.lambert}),geometry:new q.Geometry({sortTriangles:!0,dynamic:!0}),culling:!1,ignorePicking:!0,renderNormal:!0}),Object.assign(t.geometry,tp);var e=new q.Mesh({material:new q.Material({shader:this._linesShader}),castShadow:!1,ignorePicking:!0,$ignorePicking:!0,geometry:new sc({useNativeLine:!1})});this.rootNode.add(t),this.rootNode.add(e),t.material.define("both","VERTEX_COLOR"),t.material.define("fragment","DOUBLE_SIDED"),this._polygonMesh=t,this._linesMesh=e,this.rootNode.add(this._groundMesh)},_getShader:function(t){var e=this._shadersMap[t];return e||(console.warn("Unkown shading "+t),e=this._shadersMap.lambert),e.__shading=t,e},_prepareMesh:function(t,e,r,i,n){for(var o=0,a=0,s=0,l=0,h=i;h<n;h++){var u=this._getRegionPolygonInfo(h),c=this._getRegionLinesInfo(h,t,this._linesMesh.geometry);o+=u.vertexCount,a+=u.triangleCount,s+=c.vertexCount,l+=c.triangleCount}var d=this._polygonMesh,f=d.geometry;["position","normal","texcoord0","color"].forEach(function(t){f.attributes[t].init(o)}),f.indices=new(65535<o?Uint32Array:Uint16Array)(3*a),d.material.shader!==e&&d.material.attachShader(e,!0),q.setMaterialFromModel(e.__shading,d.material,t,r),0<s&&(this._linesMesh.geometry.resetOffset(),this._linesMesh.geometry.setVertexCount(s),this._linesMesh.geometry.setTriangleCount(l)),this._dataIndexOfVertex=new Uint32Array(o),this._vertexRangeOfDataIndex=new Uint32Array(2*(n-i))},_updateRegionMesh:function(t,e,r,i){for(var n=t.getData(),o=0,a=0,s=!1,l=this._polygonMesh,h=this._linesMesh,u=r;u<i;u++){for(var c=t.getRegionModel(u),d=c.getModel("itemStyle"),f=A.firstNotNull(ep(n,u),d.get("color"),"#fff"),p=A.firstNotNull(rp(n,u),d.get("opacity"),1),f=q.parseColor(f),m=q.parseColor(d.get("borderColor")),p=(f[3]*=p,m[3]*=p,f[3]<.99),p=(l.material.set("color",[1,1,1,1]),s=s||p,A.firstNotNull(c.get("height",!0),t.get("regionHeight"))),g=this._updatePolygonGeometry(t,l.geometry,u,p,o,a,f),_=o;_<g.vertexOffset;_++)this._dataIndexOfVertex[_]=u;this._vertexRangeOfDataIndex[2*(u-r)]=o,this._vertexRangeOfDataIndex[2*(u-r)+1]=g.vertexOffset;o=g.vertexOffset,a=g.triangleOffset,c=d.get("borderWidth"),f=0<c;f&&(c*=e.getDevicePixelRatio(),this._updateLinesGeometry(h.geometry,t,u,p,c,t.coordinateSystem.transform)),h.invisible=!f,h.material.set({color:m})}(l=this._polygonMesh).material.transparent=s,l.material.depthMask=!s,l.geometry.updateBoundingBox(),l.frontFace=this.extrudeY?q.Mesh.CCW:q.Mesh.CW,l.material.get("normalMap")&&l.geometry.generateTangents(),l.seriesIndex=t.seriesIndex,l.on("mousemove",this._onmousemove,this),l.on("mouseout",this._onmouseout,this)},_updateDebugWireframe:function(t){var e,r,t=t.getModel("debug.wireframe");t.get("show")&&(e=q.parseColor(t.get("lineStyle.color")||"rgba(0,0,0,0.5)"),t=A.firstNotNull(t.get("lineStyle.width"),1),(r=this._polygonMesh).geometry.generateBarycentric(),r.material.define("both","WIREFRAME_TRIANGLE"),r.material.set("wireframeLineColor",e),r.material.set("wireframeLineWidth",t))},_onmousemove:function(t){t=this._dataIndexOfVertex[t.triangle[0]];(t=null==t?-1:t)!==this._lastHoverDataIndex&&(this.downplay(this._lastHoverDataIndex),this.highlight(t),this._labelsBuilder.updateLabels([t])),this._lastHoverDataIndex=t,this._polygonMesh.dataIndex=t},_onmouseout:function(t){t.target&&(this.downplay(this._lastHoverDataIndex),this._lastHoverDataIndex=-1,this._polygonMesh.dataIndex=-1),this._labelsBuilder.updateLabels([])},_updateGroundPlane:function(t,e,r){var i,n=t.getModel("groundPlane",t);this._groundMesh.invisible=!n.get("show",!0),this._groundMesh.invisible||(t=t.get("shading"),(i=this._groundMaterials[t])||(console.warn("Unkown shading "+t),i=this._groundMaterials.lambert),q.setMaterialFromModel(t,i,n,r),i.get("normalMap")&&this._groundMesh.geometry.generateTangents(),this._groundMesh.material=i,this._groundMesh.material.set("color",q.parseColor(n.get("color"))),this._groundMesh.scale.set(e.size[0],e.size[2],1))},_triangulation:function(t,e,r){this._triangulationResults=[];for(var i=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],o=t.coordinateSystem,a=e;a<r;a++){for(var s=[],l=t.getRegionPolygonCoords(a),h=0;h<l.length;h++){var u=l[h].exterior,c=l[h].interiors,d=[],f=[];if(!(u.length<3)){for(var p=0,m=0;m<u.length;m++){var g=u[m];d[p++]=g[0],d[p++]=g[1]}for(m=0;m<c.length;m++)if(!(c[m].length<3)){for(var _=d.length/2,y=0;y<c[m].length;y++){g=c[m][y];d.push(g[0]),d.push(g[1])}f.push(_)}for(var v=Cf(d,f),x=new Float64Array(d.length/2*3),T=[],b=[1/0,1/0,1/0],w=[-1/0,-1/0,-1/0],S=0,m=0;m<d.length;)op.set(T,d[m++],0,d[m++]),o&&o.transform&&op.transformMat4(T,T,o.transform),op.min(b,b,T),op.max(w,w,T),x[S++]=T[0],x[S++]=T[1],x[S++]=T[2];op.min(i,i,b),op.max(n,n,w),s.push({points:x,indices:v,min:b,max:w})}}this._triangulationResults.push(s)}this._geoBoundingBox=[i,n]},_getRegionPolygonInfo:function(t){for(var e=this._triangulationResults[t-this._startIndex],r=0,i=0,n=0;n<e.length;n++)r+=e[n].points.length/3,i+=e[n].indices.length/3;return{vertexCount:2*r+4*r,triangleCount:2*i+2*r}},_updatePolygonGeometry:function(t,e,B,r,c,d,f){var F=t.get("projectUVOnGround"),p=e.attributes.position,i=e.attributes.normal,m=e.attributes.texcoord0,g=e.attributes.color,n=this._triangulationResults[B-this._startIndex],_=g.value&&f,y=e.indices,v=this.extrudeY?1:2,x=this.extrudeY?2:1,T=[this.rootNode.worldTransform.x.len(),this.rootNode.worldTransform.y.len(),this.rootNode.worldTransform.z.len()],b=op.mul([],this._geoBoundingBox[0],T),t=op.mul([],this._geoBoundingBox[1],T),w=Math.max(t[0]-b[0],t[2]-b[2]);function o(t,e){for(var r=c,i=e,n=t.points,o=n.length,a=[],s=[],l=0;l<o;l+=3)a[0]=n[l],a[v]=i,a[x]=n[l+2],s[0]=(n[l]*T[0]-b[0])/w,s[1]=(n[l+2]*T[x]-b[2])/w,p.set(c,a),_&&g.set(c,f),m.set(c++,s);for(var h=t.indices.length,u=0;u<h;u++)y[3*d+u]=t.indices[u]+r;d+=t.indices.length/3}for(var a=this.extrudeY?[0,1,0]:[0,0,1],z=op.negate([],a),s=0;s<n.length;s++){for(var l=c,h=n[s],u=(o(h,0),o(h,r),h.points.length/3),S=0;S<u;S++)i.set(l+S,z),i.set(l+S+u,a);for(var U=[0,3,1,1,3,2],E=[[],[],[],[]],M=[],A=[],C=[],D=[],L=0,S=0;S<u;S++){for(var P=(S+1)%u,N=(h.points[3*P]-h.points[3*S])*T[0],R=(h.points[3*P+2]-h.points[3*S+2])*T[x],k=Math.sqrt(N*N+R*R),I=0;I<4;I++){var G=0===I||3===I,O=3*(G?S:P);E[I][0]=h.points[O],E[I][v]=1<I?r:0,E[I][x]=h.points[2+O],p.set(c+I,E[I]),F?(D[0]=(h.points[O]*T[0]-b[0])/w,D[1]=(h.points[2+O]*T[x]-b[x])/w):(D[0]=(G?L:L+k)/w,D[1]=(E[I][v]*T[v]-b[v])/w),m.set(c+I,D)}op.sub(M,E[1],E[0]),op.sub(A,E[3],E[0]),op.cross(C,M,A),op.normalize(C,C);for(I=0;I<4;I++)i.set(c+I,C),_&&g.set(c+I,f);for(I=0;I<6;I++)y[3*d+I]=U[I]+c;c+=4,d+=2,L+=k}}return e.dirty(),{vertexOffset:c,triangleOffset:d}},_getRegionLinesInfo:function(t,e,n){var o=0,a=0;return 0<e.getRegionModel(t).getModel("itemStyle").get("borderWidth")&&e.getRegionPolygonCoords(t).forEach(function(t){var e=t.exterior,r=t.interiors;o+=n.getPolylineVertexCount(e),a+=n.getPolylineTriangleCount(e);for(var i=0;i<r.length;i++)o+=n.getPolylineVertexCount(r[i]),a+=n.getPolylineTriangleCount(r[i])},this),{vertexCount:o,triangleCount:a}},_updateLinesGeometry:function(n,t,e,o,a,s){function l(t){for(var e=new Float64Array(3*t.length),r=0,i=[],n=0;n<t.length;n++)i[0]=t[n][0],i[1]=o+.1,i[2]=t[n][1],s&&op.transformMat4(i,i,s),e[r++]=i[0],e[r++]=i[1],e[r++]=i[2];return e}var h=[1,1,1,1];t.getRegionPolygonCoords(e).forEach(function(t){var e=t.exterior,r=t.interiors;n.addPolyline(l(e),h,a);for(var i=0;i<r.length;i++)n.addPolyline(l(r[i]),h,a)})},highlight:function(t){var e,r,i,n=this._data;n&&(r=(e=n.getItemModel(t).getModel(["emphasis","itemStyle"])).get("color"),e=A.firstNotNull(e.get("opacity"),rp(n,t),1),null==r&&(i=ep(n,t),r=O.color.lift(i,-.4)),null==e&&(e=rp(n,t)),(i=q.parseColor(r))[3]*=e,this._setColorOfDataIndex(n,t,i))},downplay:function(t){var e,r,i=this._data;i&&(e=i.getItemModel(t),r=A.firstNotNull(ep(i,t),e.get(["itemStyle","color"]),"#fff"),e=A.firstNotNull(rp(i,t),e.get(["itemStyle","opacity"]),1),(r=q.parseColor(r))[3]*=e,this._setColorOfDataIndex(i,t,r))},dispose:function(){this._labelsBuilder.dispose()},_setColorOfDataIndex:function(t,e,r){if(!(e<this._startIndex&&e>this._endIndex)){e-=this._startIndex;for(var i=this._vertexRangeOfDataIndex[2*e];i<this._vertexRangeOfDataIndex[2*e+1];i++)this._polygonMesh.geometry.attributes.color.set(i,r);this._polygonMesh.geometry.dirty(),this._api.getZr().refresh()}}};const sp=ap,lp=O.ComponentView.extend({type:"geo3D",__ecgl__:!0,init:function(t,e){this._geo3DBuilder=new sp(e),this.groupGL=new q.Node,this._lightRoot=new q.Node,this._sceneHelper=new dc(this._lightRoot),this._sceneHelper.initLight(this._lightRoot),this._control=new nc({zr:e.getZr()}),this._control.init()},render:function(t,e,r){this.groupGL.add(this._geo3DBuilder.rootNode);var i,n,o,a=t.coordinateSystem;a&&a.viewGL&&(a.viewGL.add(this._lightRoot),t.get("show")?a.viewGL.add(this.groupGL):a.viewGL.remove(this.groupGL),(i=this._control).setViewGL(a.viewGL),n=t.getModel("viewControl"),i.setFromViewControlModel(n,0),this._sceneHelper.setScene(a.viewGL.scene),this._sceneHelper.updateLight(t),a.viewGL.setPostEffect(t.getModel("postEffect"),r),a.viewGL.setTemporalSuperSampling(t.getModel("temporalSuperSampling")),this._geo3DBuilder.update(t,e,r,0,t.getData().count()),o=a.viewGL.isLinearSpace()?"define":"undefine",this._geo3DBuilder.rootNode.traverse(function(t){t.material&&t.material[o]("fragment","SRGB_DECODE")}),i.off("update"),i.on("update",function(){r.dispatchAction({type:"geo3DChangeCamera",alpha:i.getAlpha(),beta:i.getBeta(),distance:i.getDistance(),center:i.getCenter(),from:this.uid,geo3DId:t.id})}),i.update())},afterRender:function(t,e,r,i){i=i.renderer;this._sceneHelper.updateAmbientCubemap(i,t,r),this._sceneHelper.updateSkybox(i,t,r)},dispose:function(){this._control.dispose(),this._geo3DBuilder.dispose()}});var hp={"":[32,80],"":[0,-10],"":[10,5],"":[-10,10],"":[5,5]};var up={Russia:[100,60],"United States":[-99,38],"United States of America":[-99,38]};var cp=m.vec3,dp=m.mat4,fp=[function(t,e){var r;"china"===t&&(t=hp[e.name])&&((r=e.getCenter())[0]+=t[0]/10.5,r[1]+=-t[1]/14,e.setCenter(r))},function(t,e){"world"===t&&(t=up[e.name])&&(t=[t[0],t[1]],e.setCenter(t))}];function pp(t,e,r,i,n){this.name=t,this.map=e,this.regionHeight=0,this.regions=[],this._nameCoordMap={},this.loadGeoJson(r,i,n),this.transform=dp.identity(new Float64Array(16)),this.invTransform=dp.identity(new Float64Array(16)),this.extrudeY=!0,this.altitudeAxis}pp.prototype={constructor:pp,type:"geo3D",dimensions:["lng","lat","alt"],containPoint:function(){},loadGeoJson:function(t,e,r){var i=O.parseGeoJSON||O.parseGeoJson;try{this.regions=t?i(t):[]}catch(t){throw"Invalid geoJson format\n"+t}e=e||{},r=r||{};for(var n=this.regions,o={},a=0;a<n.length;a++){var s=r[s=n[a].name]||s,s=(o[n[a].name=s]=n[a],this.addGeoCoord(s,n[a].getCenter()),e[s]);s&&n[a].transformTo(s.left,s.top,s.width,s.height)}this._regionsMap=o,this._geoRect=null,fp.forEach(function(t){t(this)},this)},getGeoBoundingRect:function(){if(this._geoRect)return this._geoRect;for(var t=this.regions,e=0;e<t.length;e++){var r,i=t[e].getBoundingRect();(r=r||i.clone()).union(i)}return this._geoRect=r||new O.graphic.BoundingRect(0,0,0,0)},addGeoCoord:function(t,e){this._nameCoordMap[t]=e},getRegion:function(t){return this._regionsMap[t]},getRegionByCoord:function(t){for(var e=this.regions,r=0;r<e.length;r++)if(e[r].contain(t))return e[r]},setSize:function(t,e,r){this.size=[t,e,r];var e=this.getGeoBoundingRect(),i=t/e.width,n=-r/e.height,t=-t/2-e.x*i,r=r/2-e.y*n,e=this.extrudeY?[t,0,r]:[t,r,0],t=this.extrudeY?[i,1,n]:[i,n,1],r=this.transform;dp.identity(r),dp.translate(r,r,e),dp.scale(r,r,t),dp.invert(this.invTransform,r)},dataToPoint:function(t,e){e=e||[];var r=this.extrudeY?1:2,i=this.extrudeY?2:1,n=t[2];return isNaN(n)&&(n=0),e[0]=t[0],e[i]=t[1],this.altitudeAxis?e[r]=this.altitudeAxis.dataToCoord(n):e[r]=0,e[r]+=this.regionHeight,cp.transformMat4(e,e,this.transform),e},pointToData:function(t,e){}};const mp=pp;function gp(t,e){var r=ad(t.getBoxLayoutParams(),{width:e.getWidth(),height:e.getHeight()}),r=(r.y=e.getHeight()-r.y-r.height,this.viewGL.setViewport(r.x,r.y,r.width,r.height,e.getDevicePixelRatio()),this.getGeoBoundingRect()),e=r.width/r.height*(t.get("aspectScale")||.75),r=t.get("boxWidth"),i=t.get("boxDepth"),n=t.get("boxHeight");null==n&&(n=5),isNaN(r)&&isNaN(i)&&(r=100),isNaN(i)?i=r/e:isNaN(r)&&(r=i/e),this.setSize(r,n,i),this.regionHeight=t.get("regionHeight"),this.altitudeAxis&&this.altitudeAxis.setExtent(0,Math.max(n-this.regionHeight,0))}function _p(t,e){var r=[1/0,-1/0];t.eachSeries(function(t){var e;t.coordinateSystem===this&&"series.map3D"!==t.type&&(e=t.getData(),t=(t=t.coordDimToDataDim("alt"))&&t[0])&&(e=e.getDataExtent(t,!0),r[0]=Math.min(r[0],e[0]),r[1]=Math.max(r[1],e[1]))},this),r&&isFinite(r[1]-r[0])&&(t=O.helper.createScale(r,{type:"value",min:"dataMin",max:"dataMax"}),this.altitudeAxis=new O.Axis("altitude",t),this.resize(this.model,e))}var yp=function(t){console.error("Map "+t+" not exists. You can download map file on http://echarts.baidu.com/download-map.html")},vp=0,xp={dimensions:mp.prototype.dimensions,create:function(r,i){var n=[];if(O.getMap)return r.eachComponent("geo3D",function(t,e){o(t)}),r.eachSeriesByType("map3D",function(t,e){var r=t.get("coordinateSystem");"geo3D"===(r=null==r?"geo3D":r)&&o(t)}),r.eachSeries(function(t){if("geo3D"===t.get("coordinateSystem")&&"series.map3D"!==t.type){var e=t.getReferringComponents("geo3D").models[0];if(!(e=e||r.getComponent("geo3D")))throw new Error('geo "'+A.firstNotNull(t.get("geo3DIndex"),t.get("geo3DId"),0)+'" not found');t.coordinateSystem=e.coordinateSystem}}),n;throw new Error("geo3D component depends on geo component");function o(t){var e=xp.createGeo3D(t);t.__viewGL=t.__viewGL||new gf,e.viewGL=t.__viewGL,(t.coordinateSystem=e).model=t,n.push(e),e.resize=gp,e.resize(t,i),e.update=_p}},createGeo3D:function(t){var e,r=t.get("map");if("string"==typeof r?(e=r,r=O.getMap(r)):r&&r.features&&(r={geoJson:r}),r||yp(r),r.geoJson.features)return null==e&&(e="GEO_ANONYMOUS_"+vp++),new mp(e+vp++,e,r&&r.geoJson,r&&r.specialAreas,t.get("nameMap"));throw new Error("Invalid GeoJSON for map3D")}};const Tp=xp;function bp(t){t.registerComponentModel(Af),t.registerComponentView(lp),t.registerAction({type:"geo3DChangeCamera",event:"geo3dcamerachanged",update:"series:updateCamera"},function(e,t){t.eachComponent({mainType:"geo3D",query:e},function(t){t.setView(e)})}),t.registerCoordinateSystem("geo3D",Tp)}function wp(t,e){t.id=t.id||t.name||e+""}(0,O.use)(bp);var Sp=O.ComponentModel.extend({type:"globe",layoutMode:"box",coordinateSystem:null,init:function(){Sp.superApply(this,"init",arguments),O.util.each(this.option.layers,function(t,e){O.util.merge(t,this.defaultLayerOption),wp(t,e)},this)},mergeOption:function(t){var e=this.option.layers;function r(t){return O.util.reduce(t,function(t,e,r){return wp(e,r),t[e.id]=e,t},{})}if(this.option.layers=null,Sp.superApply(this,"mergeOption",arguments),e&&e.length){var i,n=r(t.layers),o=r(e);for(i in n)o[i]?O.util.merge(o[i],n[i],!0):e.push(t.layers[i]);this.option.layers=e}O.util.each(this.option.layers,function(t){O.util.merge(t,this.defaultLayerOption)},this)},optionUpdated:function(){this.updateDisplacementHash()},defaultLayerOption:{show:!0,type:"overlay"},defaultOption:{show:!0,zlevel:-10,left:0,top:0,width:"100%",height:"100%",environment:"auto",baseColor:"#fff",baseTexture:"",heightTexture:"",displacementTexture:"",displacementScale:0,displacementQuality:"medium",globeRadius:100,globeOuterRadius:150,shading:"lambert",light:{main:{time:""}},atmosphere:{show:!1,offset:5,color:"#ffffff",glowPower:6,innerGlowPower:2},viewControl:{autoRotate:!0,panSensitivity:0,targetCoord:null},layers:[]},setDisplacementData:function(t,e,r){this.displacementData=t,this.displacementWidth=e,this.displacementHeight=r},getDisplacementTexture:function(){return this.get("displacementTexture")||this.get("heightTexture")},getDisplacemenScale:function(){var t=this.getDisplacementTexture(),e=this.get("displacementScale");return e=t&&"none"!==t?e:0},hasDisplacement:function(){return 0<this.getDisplacemenScale()},_displacementChanged:!0,_displacementScale:0,updateDisplacementHash:function(){var t=this.getDisplacementTexture(),e=this.getDisplacemenScale();this._displacementChanged=this._displacementTexture!==t||this._displacementScale!==e,this._displacementTexture=t,this._displacementScale=e},isDisplacementChanged:function(){return this._displacementChanged}});O.util.merge(Sp.prototype,Q),O.util.merge(Sp.prototype,Ar),O.util.merge(Sp.prototype,e),O.util.merge(Sp.prototype,t);const Ep=Sp;var Mp=Math.PI,Ap=Math.sin,Cp=Math.cos,Dp=Math.tan,Lp=Math.asin,Pp=Math.atan2,Np=Mp/180,Rp=864e5,Ip=2440588;function Op(t){return t.valueOf()/Rp-.5+Ip-2451545}var Bp=23.4397*Np;function Fp(t){var e,r,t=(t=Np*(357.5291+.98560028*t))+Np*(1.9148*Ap(t)+.02*Ap(2*t)+3e-4*Ap(3*t))+102.9372*Np+Mp;return{dec:(e=t,Lp(Ap(r=0)*Cp(Bp)+Cp(r)*Ap(Bp)*Ap(e))),ra:(r=0,Pp(Ap(e=t)*Cp(Bp)-Dp(r)*Ap(Bp),Cp(e)))}}xu={};xu.getPosition=function(t,e,r){var i,n,r=Np*-r,e=Np*e,t=Op(t),o=Fp(t),t=Np*(280.16+360.9856235*t)-r-o.ra;return{azimuth:(r=t,i=e,n=o.dec,Pp(Ap(r),Cp(r)*Ap(i)-Dp(n)*Cp(i))),altitude:(r=t,n=e,i=o.dec,Lp(Ap(n)*Ap(i)+Cp(n)*Cp(i)*Cp(r)))}};const zp=xu;q.Shader.import(Un),q.Shader.import("@export ecgl.atmosphere.vertex\nattribute vec3 position: POSITION;\nattribute vec3 normal : NORMAL;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 normalMatrix : WORLDINVERSETRANSPOSE;\n\nvarying vec3 v_Normal;\n\nvoid main() {\n v_Normal = normalize((normalMatrix * vec4(normal, 0.0)).xyz);\n gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n@end\n\n\n@export ecgl.atmosphere.fragment\nuniform mat4 viewTranspose: VIEWTRANSPOSE;\nuniform float glowPower;\nuniform vec3 glowColor;\n\nvarying vec3 v_Normal;\n\nvoid main() {\n float intensity = pow(1.0 - dot(v_Normal, (viewTranspose * vec4(0.0, 0.0, 1.0, 0.0)).xyz), glowPower);\n gl_FragColor = vec4(glowColor, intensity * intensity);\n}\n@end");const Up=O.ComponentView.extend({type:"globe",__ecgl__:!0,_displacementScale:0,init:function(t,e){this.groupGL=new q.Node,this._sphereGeometry=new q.SphereGeometry({widthSegments:200,heightSegments:100,dynamic:!0}),this._overlayGeometry=new q.SphereGeometry({widthSegments:80,heightSegments:40}),this._planeGeometry=new q.PlaneGeometry,this._earthMesh=new q.Mesh({renderNormal:!0}),this._atmosphereMesh=new q.Mesh,this._atmosphereGeometry=new q.SphereGeometry({widthSegments:80,heightSegments:40}),this._atmosphereMaterial=new q.Material({shader:new q.Shader(q.Shader.source("ecgl.atmosphere.vertex"),q.Shader.source("ecgl.atmosphere.fragment")),transparent:!0}),this._atmosphereMesh.geometry=this._atmosphereGeometry,this._atmosphereMesh.material=this._atmosphereMaterial,this._atmosphereMesh.frontFace=q.Mesh.CW,this._lightRoot=new q.Node,this._sceneHelper=new dc,this._sceneHelper.initLight(this._lightRoot),this.groupGL.add(this._atmosphereMesh),this.groupGL.add(this._earthMesh),this._control=new nc({zr:e.getZr()}),this._control.init(),this._layerMeshes={}},render:function(t,e,r){var i=t.coordinateSystem,n=t.get("shading"),o=(i.viewGL.add(this._lightRoot),t.get("show")?i.viewGL.add(this.groupGL):i.viewGL.remove(this.groupGL),this._sceneHelper.setScene(i.viewGL.scene),i.viewGL.setPostEffect(t.getModel("postEffect"),r),i.viewGL.setTemporalSuperSampling(t.getModel("temporalSuperSampling")),this._earthMesh),a=(o.geometry=this._sphereGeometry,"ecgl."+n),a=(o.material&&o.material.shader.name===a||(o.material=q.createMaterial(a)),q.setMaterialFromModel(n,o.material,t,r),["roughnessMap","metalnessMap","detailMap","normalMap"].forEach(function(t){t=o.material.get(t);t&&(t.flipY=!1)}),o.material.set("color",q.parseColor(t.get("baseColor"))),.99*i.radius),i=(o.scale.set(a,a,a),t.get("atmosphere.show")?(o.material.define("both","ATMOSPHERE_ENABLED"),this._atmosphereMesh.invisible=!1,this._atmosphereMaterial.setUniforms({glowPower:t.get("atmosphere.glowPower")||6,glowColor:t.get("atmosphere.color")||"#ffffff"}),o.material.setUniforms({glowPower:t.get("atmosphere.innerGlowPower")||2,glowColor:t.get("atmosphere.color")||"#ffffff"}),n=t.get("atmosphere.offset")||5,this._atmosphereMesh.scale.set(a+n,a+n,a+n)):(o.material.undefine("both","ATMOSPHERE_ENABLED"),this._atmosphereMesh.invisible=!0),o.material.setTextureImage("diffuseMap",t.get("baseTexture"),r,{flipY:!1,anisotropic:8})),a=(i&&i.surface&&i.surface.attachToMesh(o),o.material.setTextureImage("bumpMap",t.get("heightTexture"),r,{flipY:!1,anisotropic:8}));a&&a.surface&&a.surface.attachToMesh(o),o.material[t.get("postEffect.enable")?"define":"undefine"]("fragment","SRGB_DECODE"),this._updateLight(t,r),this._displaceVertices(t,r),this._updateViewControl(t,r),this._updateLayers(t,r)},afterRender:function(t,e,r,i){i=i.renderer;this._sceneHelper.updateAmbientCubemap(i,t,r),this._sceneHelper.updateSkybox(i,t,r)},_updateLayers:function(t,o){var e,a=t.coordinateSystem,r=t.get("layers"),s=a.radius,l=[],h=[],u=[],c=[],r=(O.util.each(r,function(t){var e,r,t=new O.Model(t),i=t.get("type"),n=q.loadTexture(t.get("texture"),o,{flipY:!1,anisotropic:8});n.surface&&n.surface.attachToMesh(this._earthMesh),"blend"===i?(i=t.get("blendTo"),r=A.firstNotNull(t.get("intensity"),1),("emission"===i?(u.push(n),c):(l.push(n),h)).push(r)):(i=t.get("id"),e=(e=this._layerMeshes[i])||(this._layerMeshes[i]=new q.Mesh({geometry:this._overlayGeometry,castShadow:!1,ignorePicking:!0})),"lambert"===t.get("shading")?(e.material=e.__lambertMaterial||new q.Material({autoUpdateTextureStatus:!1,shader:q.createShader("ecgl.lambert"),transparent:!0,depthMask:!1}),e.__lambertMaterial=e.material):(e.material=e.__colorMaterial||new q.Material({autoUpdateTextureStatus:!1,shader:q.createShader("ecgl.color"),transparent:!0,depthMask:!1}),e.__colorMaterial=e.material),e.material.enableTexture("diffuseMap"),n=t.get("distance"),r=s+(null==n?a.radius/100:n),e.scale.set(r,r,r),s=r,i=this._blankTexture||(this._blankTexture=q.createBlankTexture("rgba(255, 255, 255, 0)")),e.material.set("diffuseMap",i),q.loadTexture(t.get("texture"),o,{flipY:!1,anisotropic:8},function(t){t.surface&&t.surface.attachToMesh(e),e.material.set("diffuseMap",t),o.getZr().refresh()}),t.get("show")?this.groupGL.add(e):this.groupGL.remove(e))},this),this._earthMesh.material),t=(r.define("fragment","LAYER_DIFFUSEMAP_COUNT",l.length),r.define("fragment","LAYER_EMISSIVEMAP_COUNT",u.length),r.set("layerDiffuseMap",l),r.set("layerDiffuseIntensity",h),r.set("layerEmissiveMap",u),r.set("layerEmissionIntensity",c),t.getModel("debug.wireframe"));t.get("show")?(r.define("both","WIREFRAME_TRIANGLE"),e=q.parseColor(t.get("lineStyle.color")||"rgba(0,0,0,0.5)"),t=A.firstNotNull(t.get("lineStyle.width"),1),r.set("wireframeLineWidth",t),r.set("wireframeLineColor",e)):r.undefine("both","WIREFRAME_TRIANGLE")},_updateViewControl:function(t,e){var r=t.coordinateSystem,i=t.getModel("viewControl"),n=(r.viewGL.camera,this);var o,a,s=this._control,l=(s.setViewGL(r.viewGL),i.get("targetCoord"));null!=l&&(a=l[0]+90,o=l[1]),s.setFromViewControlModel(i,{baseDistance:r.radius,alpha:o,beta:a}),s.off("update"),s.on("update",function(){e.dispatchAction({type:"globeChangeCamera",alpha:s.getAlpha(),beta:s.getBeta(),distance:s.getDistance()-r.radius,center:s.getCenter(),from:n.uid,globeId:t.id})})},_displaceVertices:function(t,e){var r,i=t.get("displacementQuality"),n=t.get("debug.wireframe.show"),o=t.coordinateSystem;(t.isDisplacementChanged()||i!==this._displacementQuality||n!==this._showDebugWireframe)&&(this._displacementQuality=i,this._showDebugWireframe=n,t=this._sphereGeometry,r=(i={low:100,medium:200,high:400,ultra:800}[i]||200)/2,t.widthSegments===i&&!n||(t.widthSegments=i,t.heightSegments=r,t.build()),this._doDisplaceVertices(t,o),n)&&t.generateBarycentric()},_doDisplaceVertices:function(t,e){for(var r=t.attributes.position.value,i=t.attributes.texcoord0.value,n=t.__originalPosition,o=(n&&n.length===r.length||((n=new Float32Array(r.length)).set(r),t.__originalPosition=n),e.displacementWidth),a=e.displacementHeight,s=e.displacementData,l=0;l<t.vertexCount;l++){var h=3*l,u=2*l,c=n[1+h],d=n[2+h],f=n[3+h],p=i[u++],u=i[+u],p=Math.round(p*(o-1)),u=Math.round(u*(a-1)),u=s?s[u*o+p]:0;r[1+h]=c+c*u,r[2+h]=d+d*u,r[3+h]=f+f*u}t.generateVertexNormals(),t.dirty(),t.updateBoundingBox()},_updateLight:function(t,e){var r=this._earthMesh,i=(this._sceneHelper.updateLight(t),this._sceneHelper.mainLight),t=t.get("light.main.time")||new Date,t=zp.getPosition(O.number.parseDate(t),0,0),n=Math.cos(t.altitude);i.position.y=-n*Math.cos(t.azimuth),i.position.x=Math.sin(t.altitude),i.position.z=n*Math.sin(t.azimuth),i.lookAt(r.getWorldPosition())},dispose:function(t,e){this.groupGL.removeAll(),this._control.dispose()}});var kp=m.vec3;function Gp(t){this.radius=t,this.viewGL=null,this.altitudeAxis,this.displacementData=null,this.displacementWidth,this.displacementHeight}Gp.prototype={constructor:Gp,dimensions:["lng","lat","alt"],type:"globe",containPoint:function(){},setDisplacementData:function(t,e,r){this.displacementData=t,this.displacementWidth=e,this.displacementHeight=r},_getDisplacementScale:function(t,e){t=(t+180)/360*(this.displacementWidth-1),e=(90-e)/180*(this.displacementHeight-1),t=Math.round(t)+Math.round(e)*this.displacementWidth;return this.displacementData[t]},dataToPoint:function(t,e){var r=t[0],i=t[1],t=t[2]||0,n=this.radius,t=(this.displacementData&&(n*=1+this._getDisplacementScale(r,i)),this.altitudeAxis&&(n+=this.altitudeAxis.dataToCoord(t)),r=r*Math.PI/180,i=i*Math.PI/180,Math.cos(i)*n);return(e=e||[])[0]=-t*Math.cos(r+Math.PI),e[1]=Math.sin(i)*n,e[2]=t*Math.sin(r+Math.PI),e},pointToData:function(t,e){var r=t[0],i=t[1],n=t[2],t=kp.len(t),i=(r/=t,i/=t,n/=t,Math.asin(i)),n=Math.atan2(n,-r),r=(n<0&&(n=2*Math.PI+n),180*i/Math.PI),i=180*n/Math.PI-180;return(e=e||[])[0]=i,e[1]=r,e[2]=t-this.radius,this.altitudeAxis&&(e[2]=this.altitudeAxis.coordToData(e[2])),e}};const Hp=Gp;function Vp(t,e){var r=ad(t.getBoxLayoutParams(),{width:e.getWidth(),height:e.getHeight()}),r=(r.y=e.getHeight()-r.y-r.height,this.viewGL.setViewport(r.x,r.y,r.width,r.height,e.getDevicePixelRatio()),this.radius=t.get("globeRadius"),t.get("globeOuterRadius"));this.altitudeAxis&&this.altitudeAxis.setExtent(0,r-this.radius)}function Wp(t,e){var r=[1/0,-1/0];t.eachSeries(function(t){var e;t.coordinateSystem===this&&(e=t.getData(),t=(t=t.coordDimToDataDim("alt"))&&t[0])&&(e=e.getDataExtent(t,!0),r[0]=Math.min(r[0],e[0]),r[1]=Math.max(r[1],e[1]))},this),r&&isFinite(r[1]-r[0])&&(t=O.helper.createScale(r,{type:"value",min:"dataMin",max:"dataMax"}),this.altitudeAxis=new O.Axis("altitude",t),this.resize(this.model,e))}const Xp={dimensions:Hp.prototype.dimensions,create:function(r,a){var i=[];return r.eachComponent("globe",function(t){t.__viewGL=t.__viewGL||new gf;var e=new Hp;e.viewGL=t.__viewGL,(t.coordinateSystem=e).model=t,i.push(e),e.resize=Vp,e.resize(t,a),e.update=Wp}),r.eachSeries(function(t){if("globe"===t.get("coordinateSystem")){var e=t.getReferringComponents("globe").models[0];if(!(e=e||r.getComponent("globe")))throw new Error('globe "'+A.firstNotNull(t.get("globe3DIndex"),t.get("globe3DId"),0)+'" not found');e=e.coordinateSystem;t.coordinateSystem=e}}),r.eachComponent("globe",function(e,t){var r,i=e.coordinateSystem,n=e.getDisplacementTexture(),o=e.getDisplacemenScale();e.isDisplacementChanged()&&(e.hasDisplacement()?(r=!0,q.loadTexture(n,a,function(t){t=function(t,e){for(var r=document.createElement("canvas"),i=r.getContext("2d"),n=t.width,o=t.height,a=(r.width=n,r.height=o,i.drawImage(t,0,0,n,o),i.getImageData(0,0,n,o).data),s=new Float32Array(a.length/4),l=0;l<a.length/4;l++){var h=a[4*l];s[l]=h/255*e}return{data:s,width:n,height:o}}(t.image,o);e.setDisplacementData(t.data,t.width,t.height),r||a.dispatchAction({type:"globeUpdateDisplacment"})}),r=!1):i.setDisplacementData(null,0,0),i.setDisplacementData(e.displacementData,e.displacementWidth,e.displacementHeight))}),i}};(0,O.use)(function(t){t.registerComponentModel(Ep),t.registerComponentView(Up),t.registerCoordinateSystem("globe",Xp),t.registerAction({type:"globeChangeCamera",event:"globecamerachanged",update:"series:updateCamera"},function(e,t){t.eachComponent({mainType:"globe",query:e},function(t){t.setView(e)})}),t.registerAction({type:"globeUpdateDisplacment",event:"globedisplacementupdated",update:"update"},function(t,e){})});var jp=["zoom","center","pitch","bearing"],d=O.ComponentModel.extend({type:"mapbox3D",layoutMode:"box",coordinateSystem:null,defaultOption:{zlevel:-10,style:"mapbox://styles/mapbox/light-v9",center:[0,0],zoom:0,pitch:0,bearing:0,light:{main:{alpha:20,beta:30}},altitudeScale:1,boxHeight:"auto"},getMapboxCameraOption:function(){var r=this;return jp.reduce(function(t,e){return t[e]=r.get(e),t},{})},setMapboxCameraOption:function(e){null!=e&&jp.forEach(function(t){null!=e[t]&&(this.option[t]=e[t])},this)},getMapbox:function(){return this._mapbox},setMapbox:function(t){this._mapbox=t}});O.util.merge(d.prototype,Ar),O.util.merge(d.prototype,e);const qp=d;function Zp(t,e){if(this.id=t,this.zr=e,this.dom=document.createElement("div"),this.dom.style.cssText="position:absolute;left:0;right:0;top:0;bottom:0;",!mapboxgl)throw new Error("Mapbox GL library must be included. See https://www.mapbox.com/mapbox-gl-js/api/");this._mapbox=new mapboxgl.Map({container:this.dom}),this._initEvents()}Zp.prototype.setUnpainted=function(){},Zp.prototype.resize=function(){this._mapbox.resize()},Zp.prototype.getMapbox=function(){return this._mapbox},Zp.prototype.clear=function(){},Zp.prototype.refresh=function(){this._mapbox.resize()};var Yp=["mousedown","mouseup","click","dblclick","mousemove","mousewheel","wheel","touchstart","touchend","touchmove","touchcancel"];Zp.prototype._initEvents=function(){var n=this._mapbox.getCanvasContainer();this._handlers=this._handlers||{contextmenu:function(t){return t.preventDefault(),!1}},Yp.forEach(function(t){this._handlers[t]=function(t){var e,r={};for(e in t)r[e]=t[e];r.bubbles=!1;var i=new t.constructor(t.type,r);n.dispatchEvent(i)},this.zr.dom.addEventListener(t,this._handlers[t])},this),this.zr.dom.addEventListener("contextmenu",this._handlers.contextmenu)},Zp.prototype.dispose=function(){Yp.forEach(function(t){this.zr.dom.removeEventListener(t,this._handlers[t])},this)};const Kp=Zp;Ou="\n@export ecgl.displayShadow.vertex\n\n@import ecgl.common.transformUniforms\n\n@import ecgl.common.uv.header\n\n@import ecgl.common.attributes\n\nvarying vec3 v_WorldPosition;\n\nvarying vec3 v_Normal;\n\nvoid main()\n{\n @import ecgl.common.uv.main\n v_Normal = normalize((worldInverseTranspose * vec4(normal, 0.0)).xyz);\n\n v_WorldPosition = (world * vec4(position, 1.0)).xyz;\n gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n\n@end\n\n\n@export ecgl.displayShadow.fragment\n\n@import ecgl.common.uv.fragmentHeader\n\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nuniform float roughness: 0.2;\n\n#ifdef DIRECTIONAL_LIGHT_COUNT\n@import clay.header.directional_light\n#endif\n\n@import ecgl.common.ssaoMap.header\n\n@import clay.plugin.compute_shadow_map\n\nvoid main()\n{\n float shadow = 1.0;\n\n @import ecgl.common.ssaoMap.main\n\n#if defined(DIRECTIONAL_LIGHT_COUNT) && defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsDir[DIRECTIONAL_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfDirectionalLights(v_WorldPosition, shadowContribsDir);\n }\n for (int i = 0; i < DIRECTIONAL_LIGHT_COUNT; i++) {\n shadow = min(shadow, shadowContribsDir[i] * 0.5 + 0.5);\n }\n#endif\n\n shadow *= 0.5 + ao * 0.5;\n shadow = clamp(shadow, 0.0, 1.0);\n\n gl_FragColor = vec4(vec3(0.0), 1.0 - shadow);\n}\n\n@end";q.Shader.import(Ou);const Qp=O.ComponentView.extend({type:"mapbox3D",__ecgl__:!0,init:function(t,e){var r=e.getZr(),i=(this._zrLayer=new Kp("mapbox3D",r),r.painter.insertLayer(-1e3,this._zrLayer),this._lightRoot=new q.Node,this._sceneHelper=new dc(this._lightRoot),this._sceneHelper.initLight(this._lightRoot),this._zrLayer.getMapbox()),n=this._dispatchInteractAction.bind(this,e,i);["zoom","rotate","drag","pitch","rotate","move"].forEach(function(t){i.on(t,n)}),this._groundMesh=new q.Mesh({geometry:new q.PlaneGeometry,material:new q.Material({shader:new q.Shader({vertex:q.Shader.source("ecgl.displayShadow.vertex"),fragment:q.Shader.source("ecgl.displayShadow.fragment")}),depthMask:!1}),renderOrder:-100,culling:!1,castShadow:!1,$ignorePicking:!0,renderNormal:!0})},render:function(t,e,r){var i=this._zrLayer.getMapbox(),n=t.get("style"),o=JSON.stringify(n),n=(o!==this._oldStyleStr&&n&&i.setStyle(n),this._oldStyleStr=o,i.setCenter(t.get("center")),i.setZoom(t.get("zoom")),i.setPitch(t.get("pitch")),i.setBearing(t.get("bearing")),t.setMapbox(i),t.coordinateSystem);n.viewGL.scene.add(this._lightRoot),n.viewGL.add(this._groundMesh),this._updateGroundMesh(),this._sceneHelper.setScene(n.viewGL.scene),this._sceneHelper.updateLight(t),n.viewGL.setPostEffect(t.getModel("postEffect"),r),n.viewGL.setTemporalSuperSampling(t.getModel("temporalSuperSampling")),this._mapbox3DModel=t},afterRender:function(t,e,r,i){i=i.renderer;this._sceneHelper.updateAmbientCubemap(i,t,r),this._sceneHelper.updateSkybox(i,t,r),t.coordinateSystem.viewGL.scene.traverse(function(t){t.material&&(t.material.define("fragment","NORMAL_UP_AXIS",2),t.material.define("fragment","NORMAL_FRONT_AXIS",1))})},updateCamera:function(t,e,r,i){t.coordinateSystem.setCameraOption(i),this._updateGroundMesh(),r.getZr().refresh()},_dispatchInteractAction:function(t,e,r){t.dispatchAction({type:"mapbox3DChangeCamera",pitch:e.getPitch(),zoom:e.getZoom(),center:e.getCenter().toArray(),bearing:e.getBearing(),mapbox3DId:this._mapbox3DModel&&this._mapbox3DModel.id})},_updateGroundMesh:function(){var t,e,r,i;this._mapbox3DModel&&(i=(t=this._mapbox3DModel.coordinateSystem).dataToPoint(t.center),this._groundMesh.position.set(i[0],i[1],-.001),i=new q.Plane(new q.Vector3(0,0,1),0),e=t.viewGL.camera.castRay(new q.Vector2(-1,-1)),r=t.viewGL.camera.castRay(new q.Vector2(1,1)),e=e.intersectPlane(i),r=r.intersectPlane(i),i=e.dist(r)/t.viewGL.rootNode.scale.x,this._groundMesh.scale.set(i,i,1))},dispose:function(t,e){this._zrLayer&&this._zrLayer.dispose(),e.getZr().painter.delLayer(-1e3)}});var Jp=m.mat4,$p=.6435011087932844,tm=Math.PI;function em(){this.width=0,this.height=0,this.altitudeScale=1,this.boxHeight="auto",this.altitudeExtent,this.bearing=0,this.pitch=0,this.center=[0,0],this._origin,this.zoom=0,this._initialZoom,this.maxPitch=60,this.zoomOffset=0}em.prototype={constructor:em,dimensions:["lng","lat","alt"],containPoint:function(){},setCameraOption:function(t){this.bearing=t.bearing,this.pitch=t.pitch,this.center=t.center,this.zoom=t.zoom,this._origin||(this._origin=this.projectOnTileWithScale(this.center,512)),null==this._initialZoom&&(this._initialZoom=this.zoom),this.updateTransform()},updateTransform:function(){var t,e,r,i;this.height&&(t=.5/Math.tan($p/2)*this.height*.1,e=Math.max(Math.min(this.pitch,this.maxPitch),0)/180*Math.PI,r=$p/2,i=Math.PI/2+e,i=Math.sin(r)*t/Math.sin(Math.PI-i-r),r=1.1*(Math.cos(Math.PI/2-e)*i+t),50<this.pitch&&(r=1e3),Jp.perspective(i=[],$p,this.width/this.height,1,r),this.viewGL.camera.projectionMatrix.setArray(i),this.viewGL.camera.decomposeProjectionMatrix(),i=Jp.identity([]),r=this.dataToPoint(this.center),Jp.scale(i,i,[1,-1,1]),Jp.translate(i,i,[0,0,-t]),Jp.rotateX(i,i,e),Jp.rotateZ(i,i,-this.bearing/180*Math.PI),Jp.translate(i,i,[-r[0]*this.getScale()*.1,-r[1]*this.getScale()*.1,0]),this.viewGL.camera.viewMatrix.array=i,Jp.invert(t=[],i),this.viewGL.camera.worldTransform.array=t,this.viewGL.camera.decomposeWorldTransform(),e=512*this.getScale(),i=this.altitudeExtent&&!isNaN(this.boxHeight)?(r=this.altitudeExtent[1]-this.altitudeExtent[0],this.boxHeight/r*this.getScale()/Math.pow(2,this._initialZoom-this.zoomOffset)):e/(2*Math.PI*6378e3*Math.abs(Math.cos(this.center[1]*(Math.PI/180))))*this.altitudeScale*.1,this.viewGL.rootNode.scale.set(.1*this.getScale(),.1*this.getScale(),i))},getScale:function(){return Math.pow(2,this.zoom-this.zoomOffset)},projectOnTile:function(t,e){return this.projectOnTileWithScale(t,512*this.getScale(),e)},projectOnTileWithScale:function(t,e,r){var i=t[0],t=t[1],i=e*(i*tm/180+tm)/(2*tm),e=e*(tm-Math.log(Math.tan(tm/4+.5*(t*tm/180))))/(2*tm);return(r=r||[])[0]=i,r[1]=e,r},unprojectFromTile:function(t,e){return this.unprojectOnTileWithScale(t,512*this.getScale(),e)},unprojectOnTileWithScale:function(t,e,r){var i=t[0],t=t[1],i=i/e*(2*tm)-tm,t=2*(Math.atan(Math.exp(tm-t/e*(2*tm)))-tm/4);return(r=r||[])[0]=180*i/tm,r[1]=180*t/tm,r},dataToPoint:function(t,e){return(e=this.projectOnTileWithScale(t,512,e))[0]-=this._origin[0],e[1]-=this._origin[1],e[2]=isNaN(t[2])?0:t[2],isNaN(t[2])||(e[2]=t[2],this.altitudeExtent&&(e[2]-=this.altitudeExtent[0])),e}};const rm=em;function im(){rm.apply(this,arguments)}function nm(o,a,t){function s(t,e){var r=e.getWidth(),i=e.getHeight(),e=e.getDevicePixelRatio();this.viewGL.setViewport(0,0,r,i,e),this.width=r,this.height=i,this.altitudeScale=t.get("altitudeScale"),this.boxHeight=t.get("boxHeight")}function l(t,e){var r;"auto"!==this.model.get("boxHeight")&&(r=[1/0,-1/0],t.eachSeries(function(t){var e;t.coordinateSystem===this&&(e=t.getData(),t=t.coordDimToDataDim("alt")[0])&&(e=e.getDataExtent(t,!0),r[0]=Math.min(r[0],e[0]),r[1]=Math.max(r[1],e[1]))},this),r)&&isFinite(r[1]-r[0])&&(this.altitudeExtent=r)}return{dimensions:a.prototype.dimensions,create:function(r,i){var n=[];return r.eachComponent(o,function(t){var e=t.__viewGL,e=(e||(e=t.__viewGL=new gf).setRootNode(new q.Node),new a);e.viewGL=t.__viewGL,e.resize=s,e.resize(t,i),n.push(e),(t.coordinateSystem=e).model=t,e.update=l}),r.eachSeries(function(t){if(t.get("coordinateSystem")===o){var e=t.getReferringComponents(o).models[0];if(!(e=e||r.getComponent(o)))throw new Error(o+' "'+A.firstNotNull(t.get(o+"Index"),t.get(o+"Id"),0)+'" not found');t.coordinateSystem=e.coordinateSystem}}),t&&t(n,r,i),n}}}const om=nm(((im.prototype=new rm).constructor=im).prototype.type="mapbox3D",im,function(t){t.forEach(function(t){t.setCameraOption(t.model.getMapboxCameraOption())})});(0,O.use)(function(t){t.registerComponentModel(qp),t.registerComponentView(Qp),t.registerCoordinateSystem("mapbox3D",om),t.registerAction({type:"mapbox3DChangeCamera",event:"mapbox3dcamerachanged",update:"mapbox3D:updateCamera"},function(e,t){t.eachComponent({mainType:"mapbox3D",query:e},function(t){t.setMapboxCameraOption(e)})})});var am=["zoom","center","pitch","bearing"],Gu=O.ComponentModel.extend({type:"maptalks3D",layoutMode:"box",coordinateSystem:null,defaultOption:{zlevel:-10,urlTemplate:"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>',center:[0,0],zoom:0,pitch:0,bearing:0,light:{main:{alpha:20,beta:30}},altitudeScale:1,boxHeight:"auto"},getMaptalksCameraOption:function(){var r=this;return am.reduce(function(t,e){return t[e]=r.get(e),t},{})},setMaptalksCameraOption:function(e){null!=e&&am.forEach(function(t){null!=e[t]&&(this.option[t]=e[t])},this)},getMaptalks:function(){return this._maptalks},setMaptalks:function(t){this._maptalks=t}});O.util.merge(Gu.prototype,Ar),O.util.merge(Gu.prototype,e);const sm=Gu;function lm(t,e,r,i){if(this.id=t,this.zr=e,this.dom=document.createElement("div"),this.dom.style.cssText="position:absolute;left:0;right:0;top:0;bottom:0;",!maptalks)throw new Error("Maptalks library must be included. See https://maptalks.org");this._maptalks=new maptalks.Map(this.dom,{center:r,zoom:i,doubleClickZoom:!1,fog:!1}),this._initEvents()}lm.prototype.setUnpainted=function(){},lm.prototype.resize=function(){this._maptalks.checkSize()},lm.prototype.getMaptalks=function(){return this._maptalks},lm.prototype.clear=function(){},lm.prototype.refresh=function(){this._maptalks.checkSize()};var hm=["mousedown","mouseup","click","dblclick","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchmove","touchcancel"];lm.prototype._initEvents=function(){var o=this.dom;this._handlers=this._handlers||{contextmenu:function(t){return t.preventDefault(),!1}},hm.forEach(function(n){this._handlers[n]=function(t){var e,r={};for(e in t)r[e]=t[e];r.bubbles=!1;var i=new t.constructor(t.type,r);("mousewheel"===n||"DOMMouseScroll"===n?o:o.firstElementChild).dispatchEvent(i)},this.zr.dom.addEventListener(n,this._handlers[n])},this),this.zr.dom.addEventListener("contextmenu",this._handlers.contextmenu)},lm.prototype.dispose=function(){hm.forEach(function(t){this.zr.dom.removeEventListener(t,this._handlers[t])},this),this._maptalks.remove()};const um=lm,cm=(q.Shader.import(Ou),O.ComponentView.extend({type:"maptalks3D",__ecgl__:!0,init:function(t,e){this._groundMesh=new q.Mesh({geometry:new q.PlaneGeometry,material:new q.Material({shader:new q.Shader({vertex:q.Shader.source("ecgl.displayShadow.vertex"),fragment:q.Shader.source("ecgl.displayShadow.fragment")}),depthMask:!1}),renderOrder:-100,culling:!1,castShadow:!1,$ignorePicking:!0,renderNormal:!0})},_initMaptalksLayer:function(t,e){var r=e.getZr(),i=(this._zrLayer=new um("maptalks3D",r,t.get("center"),t.get("zoom")),r.painter.insertLayer(-1e3,this._zrLayer),this._lightRoot=new q.Node,this._sceneHelper=new dc(this._lightRoot),this._sceneHelper.initLight(this._lightRoot),this._zrLayer.getMaptalks()),n=this._dispatchInteractAction.bind(this,e,i);["zoomend","zooming","zoomstart","dragrotating","pitch","pitchend","movestart","moving","moveend","resize","touchstart","touchmove","touchend","animating"].forEach(function(t){i.on(t,n)})},render:function(t,e,r){this._zrLayer||this._initMaptalksLayer(t,r);var i=this._zrLayer.getMaptalks(),n=t.get("urlTemplate"),o=i.getBaseLayer(),o=(n!==this._oldUrlTemplate&&(o?o.setOptions({urlTemplate:n,attribution:t.get("attribution")}):(o=new maptalks.TileLayer("maptalks-echarts-gl-baselayer",{urlTemplate:n,subdomains:["a","b","c"],attribution:t.get("attribution")}),i.setBaseLayer(o))),this._oldUrlTemplate=n,i.setCenter(t.get("center")),i.setZoom(t.get("zoom"),{animation:!1}),i.setPitch(t.get("pitch")),i.setBearing(t.get("bearing")),t.setMaptalks(i),t.coordinateSystem);o.viewGL.scene.add(this._lightRoot),o.viewGL.add(this._groundMesh),this._updateGroundMesh(),this._sceneHelper.setScene(o.viewGL.scene),this._sceneHelper.updateLight(t),o.viewGL.setPostEffect(t.getModel("postEffect"),r),o.viewGL.setTemporalSuperSampling(t.getModel("temporalSuperSampling")),this._maptalks3DModel=t},afterRender:function(t,e,r,i){i=i.renderer;this._sceneHelper.updateAmbientCubemap(i,t,r),this._sceneHelper.updateSkybox(i,t,r),t.coordinateSystem.viewGL.scene.traverse(function(t){t.material&&(t.material.define("fragment","NORMAL_UP_AXIS",2),t.material.define("fragment","NORMAL_FRONT_AXIS",1))})},updateCamera:function(t,e,r,i){t.coordinateSystem.setCameraOption(i),this._updateGroundMesh(),r.getZr().refresh()},_dispatchInteractAction:function(t,e,r){t.dispatchAction({type:"maptalks3DChangeCamera",pitch:e.getPitch(),zoom:(t=e.getResolution(),19-Math.log(t/dm)/Math.LN2+1),center:e.getCenter().toArray(),bearing:e.getBearing(),maptalks3DId:this._maptalks3DModel&&this._maptalks3DModel.id})},_updateGroundMesh:function(){var t,e,r,i;this._maptalks3DModel&&(i=(t=this._maptalks3DModel.coordinateSystem).dataToPoint(t.center),this._groundMesh.position.set(i[0],i[1],-.001),i=new q.Plane(new q.Vector3(0,0,1),0),e=t.viewGL.camera.castRay(new q.Vector2(-1,-1)),r=t.viewGL.camera.castRay(new q.Vector2(1,1)),e=e.intersectPlane(i),r=r.intersectPlane(i),i=e.dist(r)/t.viewGL.rootNode.scale.x,this._groundMesh.scale.set(i,i,1))},dispose:function(t,e){this._zrLayer&&this._zrLayer.dispose(),e.getZr().painter.delLayer(-1e3)}})),dm=12756274*Math.PI/(256*Math.pow(2,20));function fm(){rm.apply(this,arguments),this.maxPitch=85,this.zoomOffset=1}const pm=nm(((fm.prototype=new rm).constructor=fm).prototype.type="maptalks3D",fm,function(t){t.forEach(function(t){t.setCameraOption(t.model.getMaptalksCameraOption())})});(0,O.use)(function(t){t.registerComponentModel(sm),t.registerComponentView(cm),t.registerCoordinateSystem("maptalks3D",pm),t.registerAction({type:"maptalks3DChangeCamera",event:"maptalks3dcamerachanged",update:"maptalks3D:updateCamera"},function(e,t){t.eachComponent({mainType:"maptalks3D",query:e},function(t){t.setMaptalksCameraOption(e)})})});var mm=m.vec3,gm=O.helper.dataStack.isDimensionStacked;const _m=function(e,o){var t,r,a=e.getData(),s=e.get("barSize"),l=(null==s?(t=o.size,r=o.getAxis("x"),i=o.getAxis("y"),r="category"===r.type?.7*r.getBandWidth():.6*Math.round(t[0]/Math.sqrt(a.count())),i="category"===i.type?.7*i.getBandWidth():.6*Math.round(t[1]/Math.sqrt(a.count())),s=[r,i]):O.util.isArray(s)||(s=[s,s]),o.getAxis("z").scale.getExtent()),h=(r=(t=l)[0],t=t[1],!(0<r&&0<t||r<0&&t<0)),i=["x","y","z"].map(function(t){return e.coordDimToDataDim(t)[0]}),u=gm(a,i[2]),c=u?a.getCalculationInfo("stackResultDimension"):i[2];a.each(i,function(t,e,r,i){var n=a.get(c,i),r=u?n-r:h?0:l[0],r=o.dataToPoint([t,e,r]),t=o.dataToPoint([t,e,n]),e=mm.dist(r,t),n=[0,t[1]<r[1]?-1:1,0],t=(0===Math.abs(e)&&(e=.1),[s[0],e,s[1]]);a.setItemLayout(i,[r,n,t])}),a.setLayout("orient",[1,0,0])};function ym(t,e,r){for(var i=t.getDataExtent(e),n=t.getDataExtent(r),o=i[1]-i[0]||i[0],a=n[1]-n[0]||n[0],s=new Uint8Array(2500),l=0;l<t.count();l++){var h=t.get(e,l),u=t.get(r,l),h=Math.floor((h-i[0])/o*49),u=50*Math.floor((u-n[0])/a*49)+h;s[u]=s[u]||1}for(var c=0,l=0;l<s.length;l++)s[l]&&c++;return c/s.length}var vm=m.vec3,xm=O.helper.dataStack.isDimensionStacked;function Tm(t,e){var r=xm(t,e[2]);return{dimension:r?t.getCalculationInfo("stackResultDimension"):e[2],isStacked:r}}function bm(t){t.registerLayout(function(t,e){t.eachSeriesByType("bar3D",function(t){var o,e,r,a,i,s,l,h,u,n,c,d,f,p,m,g,_,y,v,x,T,b,w,S,E,M=t.coordinateSystem,A=M&&M.type;if("globe"===A)y=M,T=(_=t).getData(),b=_.get("minHeight")||0,w=_.get("barSize"),S=["lng","lat","alt"].map(function(t){return _.coordDimToDataDim(t)[0]}),null==w?(v=y.radius*Math.PI,x=ym(T,S[0],S[1]),w=[v/Math.sqrt(T.count()/x),v/Math.sqrt(T.count()/x)]):O.util.isArray(w)||(w=[w,w]),E=Tm(T,S),T.each(S,function(t,e,r,i){var n=T.get(E.dimension,i),o=E.isStacked?n-r:y.altitudeAxis.scale.getExtent()[0],r=Math.max(y.altitudeAxis.dataToCoord(r),b),o=y.dataToPoint([t,e,o]),t=y.dataToPoint([t,e,n]),e=vm.sub([],t,o),n=(vm.normalize(e,e),[w[0],r,w[1]]);T.setItemLayout(i,[o,e,n])}),T.setLayout("orient",C.UP.array);else if("cartesian3D"===A)_m(t,M);else if("geo3D"===A)c=M,d=(n=t).getData(),f=n.get("barSize"),p=n.get("minHeight")||0,v=["lng","lat","alt"].map(function(t){return n.coordDimToDataDim(t)[0]}),null==f?(x=Math.min(c.size[0],c.size[2]),S=ym(d,v[0],v[1]),f=[x/Math.sqrt(d.count()/S),x/Math.sqrt(d.count()/S)]):O.util.isArray(f)||(f=[f,f]),m=[0,1,0],g=Tm(d,v),d.each(v,function(t,e,r,i){var n=d.get(g.dimension,i),n=g.isStacked?n-r:c.altitudeAxis.scale.getExtent()[0],r=Math.max(c.altitudeAxis.dataToCoord(r),p),t=c.dataToPoint([t,e,n]),e=[f[0],r,f[1]];d.setItemLayout(i,[t,m,e])}),d.setLayout("orient",[1,0,0]);else{if("mapbox3D"!==A&&"maptalks3D"!==A)throw M?new Error("bar3D doesn't support coordinate system "+M.type):new Error("bar3D doesn't have coordinate system.");o=M,a=(A=t).getData(),M=A.coordDimToDataDim("lng")[0],t=A.coordDimToDataDim("lat")[0],i=A.coordDimToDataDim("alt")[0],s=A.get("barSize"),l=A.get("minHeight")||0,null==s?(A=a.getDataExtent(M),e=a.getDataExtent(t),r=o.dataToPoint([A[0],e[0]]),A=o.dataToPoint([A[1],e[1]]),e=Math.min(Math.abs(r[0]-A[0]),Math.abs(r[1]-A[1]))||1,r=ym(a,M,t),s=[e/Math.sqrt(a.count()/r),e/Math.sqrt(a.count()/r)]):((s=O.util.isArray(s)?s:[s,s])[0]/=o.getScale()/16,s[1]/=o.getScale()/16),h=[0,0,1],u=Tm(a,A=[M,t,i]),a.each(A,function(t,e,r,i){var n=a.get(u.dimension,i),r=u.isStacked?n-r:0,r=o.dataToPoint([t,e,r]),t=o.dataToPoint([t,e,n]),e=Math.max(t[2]-r[2],l),n=[s[0],e,s[1]];a.setItemLayout(i,[r,h,n])}),a.setLayout("orient",[1,0,0])}})})}Eu={getFormattedLabel:function(t,e,r,i,n){r=r||"normal";var o,a=t.getData(i).getItemModel(e),t=t.getDataParams(e,i),e=(null!=n&&t.value instanceof Array&&(t.value=t.value[n]),a.get("normal"===r?["label","formatter"]:["emphasis","label","formatter"]));return"function"==typeof(e=null==e?a.get(["label","formatter"]):e)?(t.status=r,o=e(t)):"string"==typeof e&&(o=O.format.formatTpl(e,t)),o},normalizeToArray:function(t){return t instanceof Array?t:null==t?[]:[t]}};const wm=Eu;function Sm(t,e,i){var r,n,o,a,s=t.getData(),l=t.getRawValue(e),h=O.util.isArray(l)?(c=l,a=[],r=s,n="tooltip",o=[],O.util.each(r.dimensions,function(t){var t=r.getDimensionInfo(t),e=t.otherDims[n];null!=e&&!1!==e&&(o[e]=t.name)}),(h=o).length?O.util.each(h,function(t){u(s.get(t,e),t)}):O.util.each(c,u),"<br/>"+a.join("<br/>")):O.format.encodeHTML(O.format.addCommas(l));function u(t,e){var r,e=s.getDimensionInfo(e);e&&!1!==e.otherDims.tooltip&&(r=e.type,e="- "+(e.tooltipName||e.name)+": "+("ordinal"===r?t+"":"time"===r?i?"":O.format.formatTime("yyyy/MM/dd hh:mm:ss",t):O.format.addCommas(t)))&&a.push(O.format.encodeHTML(e))}var c=s.getName(e),l=ep(s,e),l=(O.util.isObject(l)&&l.colorStops&&(l=(l.colorStops[0]||{}).color),O.format.getTooltipMarker(l=l||"transparent")),t=(t="\0-"===(t=t.name)?"":t)?O.format.encodeHTML(t)+(i?": ":"<br/>"):"";return i?l+t+h:t+l+(c?O.format.encodeHTML(c)+": "+h:h)}function Em(r,t,e){e=e||r.getSource();var i=t||O.getCoordinateSystemDimensions(r.get("coordinateSystem"))||["x","y","z"],t=O.helper.createDimensions(e,{dimensionsDefine:e.dimensionsDefine||r.get("dimensions"),encodeDefine:e.encodeDefine||r.get("encode"),coordDimensions:i.map(function(t){var e=r.getReferringComponents(t+"Axis3D").models[0];return{type:e&&"category"===e.get("type")?"ordinal":"float",name:t}})}),n=("cartesian3D"===r.get("coordinateSystem")&&t.forEach(function(t){var e;0<=i.indexOf(t.coordDim)&&(e=r.getReferringComponents(t.coordDim+"Axis3D").models[0])&&"category"===e.get("type")&&(t.ordinalMeta=e.getOrdinalMeta())}),O.helper.dataStack.enableDataStack(r,t,{byIndex:!0,stackedCoordDimension:"z"})),t=new O.List(t,r);return t.setCalculationInfo(n),t.initData(e),t}Pu=O.SeriesModel.extend({type:"series.bar3D",dependencies:["globe"],visualStyleAccessPathvisu:"itemStyle",getInitialData:function(t,e){return Em(this)},getFormattedLabel:function(t,e,r,i){e=wm.getFormattedLabel(this,t,e,r,i);return e=null==e?this.getData().get("z",t):e},formatTooltip:function(t){return Sm(this,t)},defaultOption:{coordinateSystem:"cartesian3D",globeIndex:0,grid3DIndex:0,zlevel:-10,bevelSize:0,bevelSmoothness:2,onGridPlane:"xy",shading:"color",minHeight:0,itemStyle:{opacity:1},label:{show:!1,distance:2,textStyle:{fontSize:14,color:"#000",backgroundColor:"rgba(255,255,255,0.7)",padding:3,borderRadius:3}},emphasis:{label:{show:!0}},animationDurationUpdate:500}});O.util.merge(Pu.prototype,t);const Mm=Pu;var Am,Cm,Dm,Lm,Pm,Nm,Rm,Im,Om=m.vec3,U=m.mat3,xu=p.extend(function(){return{attributes:{position:new p.Attribute("position","float",3,"POSITION"),normal:new p.Attribute("normal","float",3,"NORMAL"),color:new p.Attribute("color","float",4,"COLOR"),prevPosition:new p.Attribute("prevPosition","float",3),prevNormal:new p.Attribute("prevNormal","float",3)},dynamic:!0,enableNormal:!1,bevelSize:1,bevelSegments:0,_dataIndices:null,_vertexOffset:0,_triangleOffset:0}},{resetOffset:function(){this._vertexOffset=0,this._triangleOffset=0},setBarCount:function(t){var e=this.enableNormal,r=this.getBarVertexCount()*t,t=this.getBarTriangleCount()*t;this.vertexCount!==r&&(this.attributes.position.init(r),e?this.attributes.normal.init(r):this.attributes.normal.value=null,this.attributes.color.init(r)),this.triangleCount!==t&&(this.indices=new(65535<r?Uint32Array:Uint16Array)(3*t),this._dataIndices=new Uint32Array(r))},getBarVertexCount:function(){var t=0<this.bevelSize?this.bevelSegments:0;return 0<t?this._getBevelBarVertexCount(t):this.enableNormal?24:8},getBarTriangleCount:function(){var t=0<this.bevelSize?this.bevelSegments:0;return 0<t?this._getBevelBarTriangleCount(t):12},_getBevelBarVertexCount:function(t){return 4*(t+1)*(t+1)*2},_getBevelBarTriangleCount:function(t){return(1+(4*t+3))*(2*t+1)*2+4},setColor:function(t,e){for(var r=this.getBarVertexCount(),i=r*(t+1),n=r*t;n<i;n++)this.attributes.color.set(n,e);this.dirtyAttribute("color")},getDataIndexOfVertex:function(t){return this._dataIndices?this._dataIndices[t]:null},addBar:function(){for(var t=Om.create,m=Om.scaleAndAdd,g=t(),_=t(),y=t(),v=t(),x=t(),T=t(),b=t(),w=[],S=[],e=0;e<8;e++)w[e]=t();for(var E=[[0,1,5,4],[2,3,7,6],[4,5,6,7],[3,2,1,0],[0,4,7,3],[1,2,6,5]],M=[0,1,2,0,2,3],A=[],e=0;e<E.length;e++)for(var r=E[e],i=0;i<2;i++){for(var n=[],o=0;o<3;o++)n.push(r[M[3*i+o]]);A.push(n)}return function(t,e,r,i,n,o){var a=this._vertexOffset;if(0<this.bevelSize&&0<this.bevelSegments)this._addBevelBar(t,e,r,i,this.bevelSize,this.bevelSegments,n);else{Om.copy(y,e),Om.normalize(y,y),Om.cross(v,r,y),Om.normalize(v,v),Om.cross(_,y,v),Om.normalize(v,v),Om.negate(x,_),Om.negate(T,y),Om.negate(b,v),m(w[0],t,_,i[0]/2),m(w[0],w[0],v,i[2]/2),m(w[1],t,_,i[0]/2),m(w[1],w[1],b,i[2]/2),m(w[2],t,x,i[0]/2),m(w[2],w[2],b,i[2]/2),m(w[3],t,x,i[0]/2),m(w[3],w[3],v,i[2]/2),m(g,t,y,i[1]),m(w[4],g,_,i[0]/2),m(w[4],w[4],v,i[2]/2),m(w[5],g,_,i[0]/2),m(w[5],w[5],b,i[2]/2),m(w[6],g,x,i[0]/2),m(w[6],w[6],b,i[2]/2),m(w[7],g,x,i[0]/2),m(w[7],w[7],v,i[2]/2);var s=this.attributes;if(this.enableNormal){S[0]=_,S[1]=x,S[2]=y,S[3]=T,S[4]=v,S[5]=b;for(var l=this._vertexOffset,h=0;h<E.length;h++){for(var u=3*this._triangleOffset,c=0;c<6;c++)this.indices[u++]=l+M[c];l+=4,this._triangleOffset+=2}for(h=0;h<E.length;h++)for(var d=S[h],c=0;c<4;c++){var f=E[h][c];s.position.set(this._vertexOffset,w[f]),s.normal.set(this._vertexOffset,d),s.color.set(this._vertexOffset++,n)}}else{for(h=0;h<A.length;h++){for(u=3*this._triangleOffset,c=0;c<3;c++)this.indices[u+c]=A[h][c]+this._vertexOffset;this._triangleOffset++}for(h=0;h<w.length;h++)s.position.set(this._vertexOffset,w[h]),s.color.set(this._vertexOffset++,n)}}for(var p=this._vertexOffset,h=a;h<p;h++)this._dataIndices[h]=o}}(),_addBevelBar:(Am=Om.create(),Cm=Om.create(),Dm=Om.create(),Lm=U.create(),Pm=[],Nm=[1,-1,-1,1],Rm=[1,1,-1,-1],Im=[2,0],function(t,e,r,i,n,o,a){Om.copy(Cm,e),Om.normalize(Cm,Cm),Om.cross(Dm,r,Cm),Om.normalize(Dm,Dm),Om.cross(Am,Cm,Dm),Om.normalize(Dm,Dm),Lm[0]=Am[0],Lm[1]=Am[1],Lm[2]=Am[2],Lm[3]=Cm[0],Lm[4]=Cm[1],Lm[5]=Cm[2],Lm[6]=Dm[0],Lm[7]=Dm[1],Lm[8]=Dm[2],n=Math.min(i[0],i[2])/2*n;for(var s=0;s<3;s++)Pm[s]=Math.max(i[s]-2*n,0);for(var l=(i[0]-Pm[0])/2,h=(i[1]-Pm[1])/2,u=(i[2]-Pm[2])/2,c=[],d=[],f=this._vertexOffset,p=[],s=0;s<2;s++){p[s]=p[s]=[];for(var m=0;m<=o;m++)for(var g=0;g<4;g++){(0===m&&0===s||1===s&&m===o)&&p[s].push(f);for(var _=0;_<=o;_++){var y=_/o*Math.PI/2+Math.PI/2*g,v=m/o*Math.PI/2+Math.PI/2*s;d[0]=l*Math.cos(y)*Math.sin(v),d[1]=h*Math.cos(v),d[2]=u*Math.sin(y)*Math.sin(v),c[0]=d[0]+Nm[g]*Pm[0]/2,c[1]=d[1]+h+Im[s]*Pm[1]/2,c[2]=d[2]+Rm[g]*Pm[2]/2,Math.abs(l-h)<1e-6&&Math.abs(h-u)<1e-6||(d[0]/=l*l,d[1]/=h*h,d[2]/=u*u),Om.normalize(d,d),Om.transformMat3(c,c,Lm),Om.transformMat3(d,d,Lm),Om.add(c,c,t),this.attributes.position.set(f,c),this.enableNormal&&this.attributes.normal.set(f,d),this.attributes.color.set(f,a),f++}}}for(var x=4*o+3,T=2*o+1,b=1+x,g=0;g<T;g++)for(s=0;s<=x;s++){var w=g*b+s+this._vertexOffset,S=g*b+(s+1)%b+this._vertexOffset,E=(g+1)*b+(s+1)%b+this._vertexOffset,M=(g+1)*b+s+this._vertexOffset;this.setTriangleIndices(this._triangleOffset++,[E,w,S]),this.setTriangleIndices(this._triangleOffset++,[E,M,w])}this.setTriangleIndices(this._triangleOffset++,[p[0][0],p[0][2],p[0][1]]),this.setTriangleIndices(this._triangleOffset++,[p[0][0],p[0][3],p[0][2]]),this.setTriangleIndices(this._triangleOffset++,[p[1][0],p[1][1],p[1][2]]),this.setTriangleIndices(this._triangleOffset++,[p[1][0],p[1][2],p[1][3]]),this._vertexOffset=f})});O.util.defaults(xu.prototype,gn),O.util.defaults(xu.prototype,tp);const Bm=xu;var Fm=m.vec3;const zm=O.ChartView.extend({type:"bar3D",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this._api=e,this._labelsBuilder=new np(256,256,e);var o=this;this._labelsBuilder.getLabelPosition=function(t,e,r){var i,n;return o._data?(i=(t=o._data.getItemLayout(t))[0],n=t[1],t=t[2][1],Fm.scaleAndAdd([],i,n,r+t)):[0,0]},this._labelsBuilder.getMesh().renderOrder=100},render:function(t,e,r){var i=this._prevBarMesh,i=(this._prevBarMesh=this._barMesh,this._barMesh=i,this._barMesh||(this._barMesh=new q.Mesh({geometry:new Bm,shadowDepthMaterial:new q.Material({shader:new q.Shader(q.Shader.source("ecgl.sm.depth.vertex"),q.Shader.source("ecgl.sm.depth.fragment"))}),culling:"cartesian3D"===t.coordinateSystem.type,renderOrder:10,renderNormal:!0})),this.groupGL.remove(this._prevBarMesh),this.groupGL.add(this._barMesh),this.groupGL.add(this._labelsBuilder.getMesh()),t.coordinateSystem);this._doRender(t,r),i&&i.viewGL&&(i.viewGL.add(this.groupGL),r=i.viewGL.isLinearSpace()?"define":"undefine",this._barMesh.material[r]("fragment","SRGB_DECODE")),this._data=t.getData(),this._labelsBuilder.updateData(this._data),this._labelsBuilder.updateLabels(),this._updateAnimation(t)},_updateAnimation:function(t){q.updateVertexAnimation([["prevPosition","position"],["prevNormal","normal"]],this._prevBarMesh,this._barMesh,t)},_doRender:function(t,e){var o=t.getData(),r=t.get("shading"),i="color"!==r,a=this,n=this._barMesh,s="ecgl."+r,s=(n.material&&n.material.shader.name===s||(n.material=q.createMaterial(s,["VERTEX_COLOR"])),q.setMaterialFromModel(r,n.material,t,e),n.geometry.enableNormal=i,n.geometry.resetOffset(),t.get("bevelSize")),r=t.get("bevelSmoothness"),l=(n.geometry.bevelSegments=r,n.geometry.bevelSize=s,[]),h=new Float32Array(4*o.count()),u=0,c=0,d=!1,f=(o.each(function(t){var e;o.hasValue(t)&&(e=ep(o,t),null==(t=rp(o,t))&&(t=1),q.parseColor(e,l),l[3]*=t,h[u++]=l[0],h[u++]=l[1],h[u++]=l[2],h[u++]=l[3],0<l[3])&&(c++,l[3]<.99)&&(d=!0)}),n.geometry.setBarCount(c),o.getLayout("orient")),p=this._barIndexOfData=new Int32Array(o.count()),c=0,i=(o.each(function(t){var e,r,i,n;o.hasValue(t)?(e=(i=o.getItemLayout(t))[0],r=i[1],i=i[2],n=4*t,l[0]=h[n++],l[1]=h[n++],l[2]=h[n++],l[3]=h[n++],0<l[3]&&(a._barMesh.geometry.addBar(e,r,f,i,l,t),p[t]=c++)):p[t]=-1}),n.geometry.dirty(),n.geometry.updateBoundingBox(),n.material);i.transparent=d,i.depthMask=!d,n.geometry.sortTriangles=d,this._initHandler(t,e)},_initHandler:function(t,e){var r=t.getData(),i=this._barMesh,n="cartesian3D"===t.coordinateSystem.type,o=(i.seriesIndex=t.seriesIndex,-1);i.off("mousemove"),i.off("mouseout"),i.on("mousemove",function(t){t=i.geometry.getDataIndexOfVertex(t.triangle[0]);t!==o&&(this._downplay(o),this._highlight(t),this._labelsBuilder.updateLabels([t]),n)&&e.dispatchAction({type:"grid3DShowAxisPointer",value:[r.get("x",t),r.get("y",t),r.get("z",t,!0)]}),o=t,i.dataIndex=t},this),i.on("mouseout",function(t){this._downplay(o),this._labelsBuilder.updateLabels(),o=-1,i.dataIndex=-1,n&&e.dispatchAction({type:"grid3DHideAxisPointer"})},this)},_highlight:function(t){var e,r,i,n,o=this._data;!o||(e=this._barIndexOfData[t])<0||(i=(r=o.getItemModel(t).getModel("emphasis.itemStyle")).get("color"),r=r.get("opacity"),null==i&&(n=ep(o,t),i=O.color.lift(n,-.4)),null==r&&(r=rp(o,t)),(n=q.parseColor(i))[3]*=r,this._barMesh.geometry.setColor(e,n),this._api.getZr().refresh())},_downplay:function(t){var e,r,i=this._data;!i||(e=this._barIndexOfData[t])<0||(r=ep(i,t),i=rp(i,t),(t=q.parseColor(r))[3]*=i,this._barMesh.geometry.setColor(e,t),this._api.getZr().refresh())},highlight:function(t,e,r,i){this._toggleStatus("highlight",t,e,r,i)},downplay:function(t,e,r,i){this._toggleStatus("downplay",t,e,r,i)},_toggleStatus:function(e,t,r,i,n){var t=t.getData(),n=A.queryDataIndex(t,n),o=this;null!=n?O.util.each(wm.normalizeToArray(n),function(t){"highlight"===e?this._highlight(t):this._downplay(t)},this):t.each(function(t){"highlight"===e?o._highlight(t):o._downplay(t)})},remove:function(){this.groupGL.removeAll()},dispose:function(){this._labelsBuilder.dispose(),this.groupGL.removeAll()}});(0,O.use)(function(t){t.registerChartView(zm),t.registerSeriesModel(Mm),bm(t),t.registerProcessor(function(t,e){t.eachSeriesByType("bar3d",function(t){var e=t.getData();e.filterSelf(function(t){return e.hasValue(t)})})})});const Um=O.SeriesModel.extend({type:"series.line3D",dependencies:["grid3D"],visualStyleAccessPath:"lineStyle",visualDrawType:"stroke",getInitialData:function(t,e){return Em(this)},formatTooltip:function(t){return Sm(this,t)},defaultOption:{coordinateSystem:"cartesian3D",zlevel:-10,grid3DIndex:0,lineStyle:{width:2},animationDurationUpdate:500}});var km=m.vec3;q.Shader.import(y);const Gm=O.ChartView.extend({type:"line3D",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this._api=e},render:function(t,e,r){var i,n=this._prevLine3DMesh,n=(this._prevLine3DMesh=this._line3DMesh,this._line3DMesh=n,this._line3DMesh||(this._line3DMesh=new q.Mesh({geometry:new sc({useNativeLine:!1,sortTriangles:!0}),material:new q.Material({shader:q.createShader("ecgl.meshLines3D")}),renderOrder:10}),this._line3DMesh.geometry.pick=this._pick.bind(this)),this.groupGL.remove(this._prevLine3DMesh),this.groupGL.add(this._line3DMesh),t.coordinateSystem);n&&n.viewGL&&(n.viewGL.add(this.groupGL),i=n.viewGL.isLinearSpace()?"define":"undefine",this._line3DMesh.material[i]("fragment","SRGB_DECODE")),this._doRender(t,r),this._data=t.getData(),this._camera=n.viewGL.camera,this.updateCamera(),this._updateAnimation(t)},updateCamera:function(){this._updateNDCPosition()},_doRender:function(t,e){var r=t.getData(),i=this._line3DMesh,n=(i.geometry.resetOffset(),r.getLayout("points")),o=[],a=new Float32Array(n.length/3*4),s=0,l=!1,h=(r.each(function(t){var e=ep(r,t),t=rp(r,t);null==t&&(t=1),q.parseColor(e,o),o[3]*=t,a[s++]=o[0],a[s++]=o[1],a[s++]=o[2],a[s++]=o[3],o[3]<.99&&(l=!0)}),i.geometry.setVertexCount(i.geometry.getPolylineVertexCount(n)),i.geometry.setTriangleCount(i.geometry.getPolylineTriangleCount(n)),i.geometry.addPolyline(n,a,A.firstNotNull(t.get("lineStyle.width"),1)),i.geometry.dirty(),i.geometry.updateBoundingBox(),i.material),h=(h.transparent=l,h.depthMask=!l,t.getModel("debug.wireframe"));h.get("show")?(i.geometry.createAttribute("barycentric","float",3),i.geometry.generateBarycentric(),i.material.set("both","WIREFRAME_TRIANGLE"),i.material.set("wireframeLineColor",q.parseColor(h.get("lineStyle.color")||"rgba(0,0,0,0.5)")),i.material.set("wireframeLineWidth",A.firstNotNull(h.get("lineStyle.width"),1))):i.material.set("both","WIREFRAME_TRIANGLE"),this._points=n,this._initHandler(t,e)},_updateAnimation:function(t){q.updateVertexAnimation([["prevPosition","position"],["prevPositionPrev","positionPrev"],["prevPositionNext","positionNext"]],this._prevLine3DMesh,this._line3DMesh,t)},_initHandler:function(t,e){var r=t.getData(),i=t.coordinateSystem,n=this._line3DMesh,o=-1;n.seriesIndex=t.seriesIndex,n.off("mousemove"),n.off("mouseout"),n.on("mousemove",function(t){t=i.pointToData(t.point.array),t=r.indicesOfNearest("x",t[0])[0];t!==o&&(e.dispatchAction({type:"grid3DShowAxisPointer",value:[r.get("x",t),r.get("y",t),r.get("z",t)]}),n.dataIndex=t),o=t},this),n.on("mouseout",function(t){o=-1,n.dataIndex=-1,e.dispatchAction({type:"grid3DHideAxisPointer"})},this)},_updateNDCPosition:function(){for(var t=new M,e=this._camera,r=(M.multiply(t,e.projectionMatrix,e.viewMatrix),this._positionNDC),i=this._points,n=i.length/3,o=(r&&r.length/2==n||(r=this._positionNDC=new Float32Array(2*n)),[]),a=0;a<n;a++){var s=3*a,l=2*a;o[0]=i[s],o[1]=i[1+s],o[2]=i[2+s],o[3]=1,km.transformMat4(o,o,t.array),r[l]=o[0]/o[3],r[1+l]=o[1]/o[3]}},_pick:function(t,e,r,i,n,o){var a=this._positionNDC,s=this._data.hostModel.get("lineStyle.width"),l=-1,h=.5*r.viewport.width,u=.5*r.viewport.height;t=(t+1)*h,e=(e+1)*u;for(var c=1;c<a.length/2;c++){var d=(a[2*(c-1)]+1)*h,f=(a[2*(c-1)+1]+1)*u,p=(a[2*c]+1)*h,m=(a[2*c+1]+1)*u;Rl(d,f,p,m,s,t,e)&&(l=(d-t)*(d-t)+(f-e)*(f-e)<(p-t)*(p-t)+(m-e)*(m-e)?c-1:c)}0<=l&&(r=3*l,r=new C(this._points[r],this._points[1+r],this._points[2+r]),o.push({dataIndex:l,point:r,pointWorld:r.clone(),target:this._line3DMesh,distance:this._camera.getWorldPosition().dist(r)}))},remove:function(){this.groupGL.removeAll()},dispose:function(){this.groupGL.removeAll()}});(0,O.use)(function(t){t.registerChartView(Gm),t.registerSeriesModel(Um),t.registerLayout(function(t,e){t.eachSeriesByType("line3D",function(e){var n,o,a,t,r=e.getData(),s=e.coordinateSystem;s&&("cartesian3D"!==s.type?console.error("line3D needs cartesian3D coordinateSystem"):(n=new Float32Array(3*r.count()),o=[],a=[],t=s.dimensions.map(function(t){return e.coordDimToDataDim(t)[0]}),s&&r.each(t,function(t,e,r,i){o[0]=t,o[1]=e,o[2]=r,s.dataToPoint(o,a),n[3*i]=a[0],n[3*i+1]=a[1],n[3*i+2]=a[2]}),r.setLayout("points",n)))})})});const Hm=O.SeriesModel.extend({type:"series.scatter3D",dependencies:["globe","grid3D","geo3D"],visualStyleAccessPath:"itemStyle",hasSymbolVisual:!0,getInitialData:function(t,e){return Em(this)},getFormattedLabel:function(t,e,r,i){e=wm.getFormattedLabel(this,t,e,r,i);return null==e&&(i=(r=this.getData()).dimensions[r.dimensions.length-1],e=r.get(i,t)),e},formatTooltip:function(t){return Sm(this,t)},defaultOption:{coordinateSystem:"cartesian3D",zlevel:-10,progressive:1e5,progressiveThreshold:1e5,grid3DIndex:0,globeIndex:0,symbol:"circle",symbolSize:10,blendMode:"source-over",label:{show:!1,position:"right",distance:5,textStyle:{fontSize:14,color:"#000",backgroundColor:"rgba(255,255,255,0.7)",padding:3,borderRadius:3}},itemStyle:{opacity:.8},emphasis:{label:{show:!0}},animationDurationUpdate:500}});function Vm(t,e,r){(e=e||document.createElement("canvas")).width=t,e.height=t;t=e.getContext("2d");return r&&r(t),e}function Wm(t,h,u){var c=h.width,d=h.height,e=t.canvas.width,r=t.canvas.height,f=c/e,p=d/r;function m(t){return t<128?1:-1}for(var i=t.createImageData(e,r),n=0;n<r;n++)for(var o=0;o<e;o++){var a=function(t,e){for(var r=1/0,i=(t=Math.floor(t*f),(e=Math.floor(e*p))*c+t),n=m(h.data[4*i]),o=Math.max(e-u,0);o<Math.min(e+u,d);o++)for(var a=Math.max(t-u,0);a<Math.min(t+u,c);a++){var s=a-t,l=o-e;n!==m(h.data[4*(o*c+a)])&&(s=s*s+l*l)<r&&(r=s)}return n*Math.sqrt(r)}(o,n)/u*.5+.5,s=4*(n*e+o);i.data[s++]=255*(1-a),i.data[s++]=255*(1-a),i.data[s++]=255*(1-a),i.data[+s]=255}return i}var Xm={getMarginByStyle:function(t){var e=t.minMargin||0,r=0,i=(t.stroke&&"none"!==t.stroke&&(r=null==t.lineWidth?1:t.lineWidth),t.shadowBlur||0),n=t.shadowOffsetX||0,t=t.shadowOffsetY||0,o={};return o.left=Math.max(r/2,-n+i,e),o.right=Math.max(r/2,n+i,e),o.top=Math.max(r/2,-t+i,e),o.bottom=Math.max(r/2,t+i,e),o},createSymbolSprite:function(t,e,r,i){t=t,e=e,n=r,O.util.isArray(e)||(e=[e,e]),o=Xm.getMarginByStyle(n,o),a=e[0]+o.left+o.right,l=e[1]+o.top+o.bottom,t=O.helper.createSymbol(t,0,0,e[0],e[1]),e=Math.max(a,l),t.x=o.left,t.y=o.top,l<a?t.y+=(e-l)/2:t.x+=(e-a)/2,o=t.getBoundingRect(),t.x-=o.x,t.y-=o.y,t.setStyle(n),t.update(),t.__size=e;var n,o,a,s=t,l=Xm.getMarginByStyle(r);return{image:Vm(s.__size,i,function(t){O.innerDrawElementOnCanvas(t,s)}),margin:l}},createSDFFromCanvas:function(r,t,i,e){return Vm(t,e,function(t){var e=r.getContext("2d").getImageData(0,0,r.width,r.height);t.putImageData(Wm(t,e,i),0,0)})},createSimpleSprite:function(r,t){return Vm(r,t,function(t){var e=r/2,e=(t.beginPath(),t.arc(e,e,60,0,2*Math.PI,!1),t.closePath(),t.createRadialGradient(e,e,0,e,e,e));e.addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0.5)"),e.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=e,t.fill()})}};const jm=Xm;var qm=m.vec3;const Zm={needsSortVertices:function(){return this.sortVertices},needsSortVerticesProgressively:function(){return this.needsSortVertices()&&2e4<=this.vertexCount},doSortVertices:function(t,e){var r=this.indices,i=qm.create();if(!r)for(var r=this.indices=new(65535<this.vertexCount?Uint32Array:Uint16Array)(this.vertexCount),n=0;n<r.length;n++)r[n]=n;if(0===e){var o,a=this.attributes.position,t=t.array,s=0;this._zList&&this._zList.length===this.vertexCount||(this._zList=new Float32Array(this.vertexCount));for(n=0;n<this.vertexCount;n++){a.get(n,i);var l=qm.sqrDist(i,t);isNaN(l)&&(l=1e7,s++),0===n?(o=l,l=0):l-=o,this._zList[n]=l}this._noneCount=s}if(this.vertexCount<2e4)0===e&&this._simpleSort(.05<this._noneCount/this.vertexCount);else for(n=0;n<3;n++)this._progressiveQuickSort(3*e+n);this.dirtyIndices()},_simpleSort:function(t){var r=this._zList,e=this.indices;function i(t,e){return r[e]-r[t]}t?Array.prototype.sort.call(e,i):Yf.sort(e,i,0,e.length-1)},_progressiveQuickSort:function(t){var r=this._zList,e=this.indices;this._quickSort=this._quickSort||new Yf,this._quickSort.step(e,function(t,e){return r[e]-r[t]},t)}};var Ym=m.vec4;q.Shader.import("@export ecgl.sdfSprite.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform float elapsedTime : 0;\n\nattribute vec3 position : POSITION;\n\n#ifdef VERTEX_SIZE\nattribute float size;\n#else\nuniform float u_Size;\n#endif\n\n#ifdef VERTEX_COLOR\nattribute vec4 a_FillColor: COLOR;\nvarying vec4 v_Color;\n#endif\n\n#ifdef VERTEX_ANIMATION\nattribute vec3 prevPosition;\nattribute float prevSize;\nuniform float percent : 1.0;\n#endif\n\n\n#ifdef POSITIONTEXTURE_ENABLED\nuniform sampler2D positionTexture;\n#endif\n\nvarying float v_Size;\n\nvoid main()\n{\n\n#ifdef POSITIONTEXTURE_ENABLED\n gl_Position = worldViewProjection * vec4(texture2D(positionTexture, position.xy).xy, -10.0, 1.0);\n#else\n\n #ifdef VERTEX_ANIMATION\n vec3 pos = mix(prevPosition, position, percent);\n #else\n vec3 pos = position;\n #endif\n gl_Position = worldViewProjection * vec4(pos, 1.0);\n#endif\n\n#ifdef VERTEX_SIZE\n#ifdef VERTEX_ANIMATION\n v_Size = mix(prevSize, size, percent);\n#else\n v_Size = size;\n#endif\n#else\n v_Size = u_Size;\n#endif\n\n#ifdef VERTEX_COLOR\n v_Color = a_FillColor;\n #endif\n\n gl_PointSize = v_Size;\n}\n\n@end\n\n@export ecgl.sdfSprite.fragment\n\nuniform vec4 color: [1, 1, 1, 1];\nuniform vec4 strokeColor: [1, 1, 1, 1];\nuniform float smoothing: 0.07;\n\nuniform float lineWidth: 0.0;\n\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n\nvarying float v_Size;\n\nuniform sampler2D sprite;\n\n@import clay.util.srgb\n\nvoid main()\n{\n gl_FragColor = color;\n\n vec4 _strokeColor = strokeColor;\n\n#ifdef VERTEX_COLOR\n gl_FragColor *= v_Color;\n #endif\n\n#ifdef SPRITE_ENABLED\n float d = texture2D(sprite, gl_PointCoord).r;\n gl_FragColor.a *= smoothstep(0.5 - smoothing, 0.5 + smoothing, d);\n\n if (lineWidth > 0.0) {\n float sLineWidth = lineWidth / 2.0;\n\n float outlineMaxValue0 = 0.5 + sLineWidth;\n float outlineMaxValue1 = 0.5 + sLineWidth + smoothing;\n float outlineMinValue0 = 0.5 - sLineWidth - smoothing;\n float outlineMinValue1 = 0.5 - sLineWidth;\n\n if (d <= outlineMaxValue1 && d >= outlineMinValue0) {\n float a = _strokeColor.a;\n if (d <= outlineMinValue1) {\n a = a * smoothstep(outlineMinValue0, outlineMinValue1, d);\n }\n else {\n a = a * smoothstep(outlineMaxValue1, outlineMaxValue0, d);\n }\n gl_FragColor.rgb = mix(gl_FragColor.rgb * gl_FragColor.a, _strokeColor.rgb, a);\n gl_FragColor.a = gl_FragColor.a * (1.0 - a) + a;\n }\n }\n#endif\n\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(gl_FragColor);\n#endif\n}\n@end");const Km=q.Mesh.extend(function(){var t=new q.Geometry({dynamic:!0,attributes:{color:new q.Geometry.Attribute("color","float",4,"COLOR"),position:new q.Geometry.Attribute("position","float",3,"POSITION"),size:new q.Geometry.Attribute("size","float",1),prevPosition:new q.Geometry.Attribute("prevPosition","float",3),prevSize:new q.Geometry.Attribute("prevSize","float",1)}}),e=(Object.assign(t,Zm),new q.Material({shader:q.createShader("ecgl.sdfSprite"),transparent:!0,depthMask:!1})),r=(e.enableTexture("sprite"),e.define("both","VERTEX_COLOR"),e.define("both","VERTEX_SIZE"),new q.Texture2D({image:document.createElement("canvas"),flipY:!1}));return e.set("sprite",r),t.pick=this._pick.bind(this),{geometry:t,material:e,mode:q.Mesh.POINTS,sizeScale:1}},{_pick:function(t,e,r,i,n,o){var a=this._positionNDC;if(a)for(var r=r.viewport,s=2/r.width,l=2/r.height,h=this.geometry.vertexCount-1;0<=h;h--){var u=this.geometry.indices?this.geometry.indices[h]:h,c=a[2*u],d=a[2*u+1],f=this.geometry.attributes.size.get(u)/this.sizeScale/2;c-f*s<t&&t<c+f*s&&d-f*l<e&&e<d+f*l&&(c=new q.Vector3,d=new q.Vector3,this.geometry.attributes.position.get(u,c.array),q.Vector3.transformMat4(d,c,this.worldTransform),o.push({vertexIndex:u,point:c,pointWorld:d,target:this,distance:d.distance(i.getWorldPosition())}))}},updateNDCPosition:function(t,e,r){for(var i=this._positionNDC,n=this.geometry,o=(i&&i.length/2===n.vertexCount||(i=this._positionNDC=new Float32Array(2*n.vertexCount)),Ym.create()),a=0;a<n.vertexCount;a++)n.attributes.position.get(a,o),o[3]=1,Ym.transformMat4(o,o,t.array),Ym.scale(o,o,1/o[3]),i[2*a]=o[0],i[2*a+1]=o[1]}});function Qm(t,e){this.rootNode=new q.Node,this.is2D=t,this._labelsBuilder=new np(256,256,e),this._labelsBuilder.getMesh().renderOrder=100,this.rootNode.add(this._labelsBuilder.getMesh()),this._api=e,this._spriteImageCanvas=document.createElement("canvas"),this._startDataIndex=0,this._endDataIndex=0,this._sizeScale=1}Qm.prototype={constructor:Qm,highlightOnMouseover:!0,update:function(t,e,r,i,n){for(var o=this._prevMesh,a=(this._prevMesh=this._mesh,this._mesh=o,t.getData()),s=(null==i&&(i=0),null==n&&(n=a.count()),this._startDataIndex=i,this._endDataIndex=n-1,this._mesh||(s=this._prevMesh&&this._prevMesh.material,this._mesh=new Km({renderOrder:10,frustumCulling:!1}),s&&(this._mesh.material=s)),this._mesh.material),o=this._mesh.geometry,l=o.attributes,h=(this.rootNode.remove(this._prevMesh),this.rootNode.add(this._mesh),this._setPositionTextureToMesh(this._mesh,this._positionTexture),this._getSymbolInfo(t,i,n)),u=r.getDevicePixelRatio(),c=t.getModel("itemStyle").getItemStyle(),d=t.get("large"),f=1,p=(2<h.maxSize?(f=this._updateSymbolSprite(t,c,h,u),s.enableTexture("sprite")):s.disableTexture("sprite"),l.position.init(n-i),[]),m=(d?(s.undefine("VERTEX_SIZE"),s.undefine("VERTEX_COLOR"),y=function(t){var e=t.getVisual("style");if(e)return e[t.getVisual("drawType")]}(a),v=a.getVisual("style").opacity,q.parseColor(y,p),p[3]*=v,s.set({color:p,u_Size:h.maxSize*this._sizeScale})):(s.set({color:[1,1,1,1]}),s.define("VERTEX_SIZE"),s.define("VERTEX_COLOR"),l.size.init(n-i),l.color.init(n-i),this._originalOpacity=new Float32Array(n-i)),a.getLayout("points")),g=l.position.value,_=0;_<n-i;_++){var y,v,x=3*_,T=2*_;this.is2D?(g[x]=m[T],g[1+x]=m[1+T],g[2+x]=-10):(g[x]=m[x],g[1+x]=m[1+x],g[2+x]=m[2+x]),d||(y=ep(a,_),v=rp(a,_),q.parseColor(y,p),p[3]*=v,l.color.set(_,p),p[3],T=(T=a.getItemVisual(_,"symbolSize"))instanceof Array?Math.max(T[0],T[1]):T,isNaN(T)&&(T=0),l.size.value[_]=T*f*this._sizeScale,this._originalOpacity[_]=p[3])}this._mesh.sizeScale=f,o.updateBoundingBox(),o.dirty(),this._updateMaterial(t,c);u=t.coordinateSystem;u&&u.viewGL&&s[u.viewGL.isLinearSpace()?"define":"undefine"]("fragment","SRGB_DECODE"),d||this._updateLabelBuilder(t,i,n),this._updateHandler(t,e,r),this._updateAnimation(t),this._api=r},getPointsMesh:function(){return this._mesh},updateLabels:function(t){this._labelsBuilder.updateLabels(t)},hideLabels:function(){this.rootNode.remove(this._labelsBuilder.getMesh())},showLabels:function(){this.rootNode.add(this._labelsBuilder.getMesh())},dispose:function(){this._labelsBuilder.dispose()},_updateSymbolSprite:function(t,e,r,i){r.maxSize=Math.min(2*r.maxSize,200);var n,o,a=[];return 1<r.aspect?(a[0]=r.maxSize,a[1]=r.maxSize/r.aspect):(a[1]=r.maxSize,a[0]=r.maxSize*r.aspect),a[0]=a[0]||1,a[1]=a[1]||1,this._symbolType===r.type&&(n=this._symbolSize,o=a,n)&&o&&n[0]===o[0]&&n[1]===o[1]&&this._lineWidth===e.lineWidth||(jm.createSymbolSprite(r.type,a,{fill:"#fff",lineWidth:e.lineWidth,stroke:"transparent",shadowColor:"transparent",minMargin:Math.min(a[0]/2,10)},this._spriteImageCanvas),jm.createSDFFromCanvas(this._spriteImageCanvas,Math.min(this._spriteImageCanvas.width,32),20,this._mesh.material.get("sprite").image),this._symbolType=r.type,this._symbolSize=a,this._lineWidth=e.lineWidth),this._spriteImageCanvas.width/r.maxSize*i},_updateMaterial:function(t,e){var t="lighter"===t.get("blendMode")?q.additiveBlend:null,r=this._mesh.material,t=(r.blend=t,r.set("lineWidth",e.lineWidth/20),q.parseColor(e.stroke));r.set("strokeColor",t),r.transparent=!0,r.depthMask=!1,r.depthTest=!this.is2D,r.sortVertices=!this.is2D},_updateLabelBuilder:function(t,i,e){var t=t.getData(),n=this._mesh.geometry,o=n.attributes.position.value,i=this._startDataIndex,a=this._mesh.sizeScale;this._labelsBuilder.updateData(t,i,e),this._labelsBuilder.getLabelPosition=function(t,e,r){t=3*(t-i);return[o[t],o[1+t],o[2+t]]},this._labelsBuilder.getLabelDistance=function(t,e,r){return n.attributes.size.get(t-i)/a/2+r},this._labelsBuilder.updateLabels()},_updateAnimation:function(t){q.updateVertexAnimation([["prevPosition","position"],["prevSize","size"]],this._prevMesh,this._mesh,t)},_updateHandler:function(e,t,r){var i,n=e.getData(),o=this._mesh,a=this,s=-1,l=e.coordinateSystem&&"cartesian3D"===e.coordinateSystem.type;l&&(i=e.coordinateSystem.model),o.seriesIndex=e.seriesIndex,o.off("mousemove"),o.off("mouseout"),o.on("mousemove",function(t){t=t.vertexIndex+a._startDataIndex;t!==s&&(this.highlightOnMouseover&&(this.downplay(n,s),this.highlight(n,t),this._labelsBuilder.updateLabels([t])),l)&&r.dispatchAction({type:"grid3DShowAxisPointer",value:[n.get(e.coordDimToDataDim("x")[0],t),n.get(e.coordDimToDataDim("y")[0],t),n.get(e.coordDimToDataDim("z")[0],t)],grid3DIndex:i.componentIndex}),o.dataIndex=t,s=t},this),o.on("mouseout",function(t){t=t.vertexIndex+a._startDataIndex;this.highlightOnMouseover&&(this.downplay(n,t),this._labelsBuilder.updateLabels()),s=-1,o.dataIndex=-1,l&&r.dispatchAction({type:"grid3DHideAxisPointer",grid3DIndex:i.componentIndex})},this)},updateLayout:function(t,e,r){t=t.getData();if(this._mesh){var i=this._mesh.geometry.attributes.position.value,n=t.getLayout("points");if(this.is2D)for(var o=0;o<n.length/2;o++){var a=3*o,s=2*o;i[a]=n[s],i[1+a]=n[1+s],i[2+a]=-10}else for(o=0;o<n.length;o++)i[o]=n[o];this._mesh.geometry.dirty(),r.getZr().refresh()}},updateView:function(t){var e;this._mesh&&(e=new M,M.mul(e,t.viewMatrix,this._mesh.worldTransform),M.mul(e,t.projectionMatrix,e),this._mesh.updateNDCPosition(e,this.is2D,this._api))},highlight:function(t,e){var r,i,n;e>this._endDataIndex||e<this._startDataIndex||(i=(r=t.getItemModel(e).getModel("emphasis.itemStyle")).get("color"),r=r.get("opacity"),null==i&&(n=ep(t,e),i=O.color.lift(n,-.4)),null==r&&(r=rp(t,e)),(n=q.parseColor(i))[3]*=r,this._mesh.geometry.attributes.color.set(e-this._startDataIndex,n),this._mesh.geometry.dirtyAttribute("color"),this._api.getZr().refresh())},downplay:function(t,e){var r;e>this._endDataIndex||e<this._startDataIndex||(r=ep(t,e),t=rp(t,e),(r=q.parseColor(r))[3]*=t,this._mesh.geometry.attributes.color.set(e-this._startDataIndex,r),this._mesh.geometry.dirtyAttribute("color"),this._api.getZr().refresh())},fadeOutAll:function(t){if(this._originalOpacity){for(var e=this._mesh.geometry,r=0;r<e.vertexCount;r++){var i=this._originalOpacity[r]*t;e.attributes.color.value[4*r+3]=i}e.dirtyAttribute("color"),this._api.getZr().refresh()}},fadeInAll:function(){this.fadeOutAll(1)},setPositionTexture:function(t){this._mesh&&this._setPositionTextureToMesh(this._mesh,t),this._positionTexture=t},removePositionTexture:function(){this._positionTexture=null,this._mesh&&this._setPositionTextureToMesh(this._mesh,null)},setSizeScale:function(t){if(t!==this._sizeScale){if(this._mesh){var e=this._mesh.material.get("u_Size"),r=(this._mesh.material.set("u_Size",e/this._sizeScale*t),this._mesh.geometry.attributes);if(r.size.value)for(var i=0;i<r.size.value.length;i++)r.size.value[i]=r.size.value[i]/this._sizeScale*t}this._sizeScale=t}},_setPositionTextureToMesh:function(t,e){e&&t.material.set("positionTexture",e),t.material[e?"enableTexture":"disableTexture"]("positionTexture")},_getSymbolInfo:function(t,e,r){if(t.get("large"))return i=(c=A.firstNotNull(t.get("symbolSize"),1))instanceof Array?(l=Math.max(c[0],c[1]),c[0]/c[1]):(l=c,1),{maxSize:c,type:t.get("symbol"),aspect:i};for(var i,n=t.getData(),o=!1,a=n.getItemVisual(0,"symbol")||"circle",s=!1,l=0,h=e;h<r;h++){var u,c=n.getItemVisual(h,"symbolSize"),d=n.getItemVisual(h,"symbol");if(c instanceof Array)u=c[0]/c[1],l=Math.max(Math.max(c[0],c[1]),l);else{if(isNaN(c))continue;u=1,l=Math.max(c,l)}null!=i&&.05<Math.abs(u-i)&&(o=!0),d!==a&&(s=!0),a=d,i=u}return o&&console.warn("Different symbol width / height ratio will be ignored."),s&&console.warn("Different symbol type will be ignored."),{maxSize:l,type:a,aspect:i}}};const Jm=Qm,$m=O.ChartView.extend({type:"scatter3D",hasSymbolVisual:!0,__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this._pointsBuilderList=[],this._currentStep=0},render:function(t,e,r){if(this.groupGL.removeAll(),t.getData().count()){var i=t.coordinateSystem;if(!i||!i.viewGL)throw new Error("Invalid coordinate system");i.viewGL.add(this.groupGL),this._camera=i.viewGL.camera;var n=(n=this._pointsBuilderList[0])||(this._pointsBuilderList[0]=new Jm(!1,r));this._pointsBuilderList.length=1,this.groupGL.add(n.rootNode),n.update(t,e,r),n.updateView(i.viewGL.camera)}},incrementalPrepareRender:function(t,e,r){t=t.coordinateSystem;if(!t||!t.viewGL)throw new Error("Invalid coordinate system");t.viewGL.add(this.groupGL),this._camera=t.viewGL.camera,this.groupGL.removeAll(),this._currentStep=0},incrementalRender:function(t,e,r,i){var n;t.end<=t.start||((n=this._pointsBuilderList[this._currentStep])||(n=new Jm(!1,i),this._pointsBuilderList[this._currentStep]=n),this.groupGL.add(n.rootNode),n.update(e,r,i,t.start,t.end),n.updateView(e.coordinateSystem.viewGL.camera),this._currentStep++)},updateCamera:function(){this._pointsBuilderList.forEach(function(t){t.updateView(this._camera)},this)},highlight:function(t,e,r,i){this._toggleStatus("highlight",t,e,r,i)},downplay:function(t,e,r,i){this._toggleStatus("downplay",t,e,r,i)},_toggleStatus:function(t,e,r,i,n){var o=e.getData(),e=A.queryDataIndex(o,n),a="highlight"===t;null!=e?O.util.each(wm.normalizeToArray(e),function(t){for(var e=0;e<this._pointsBuilderList.length;e++){var r=this._pointsBuilderList[e];a?r.highlight(o,t):r.downplay(o,t)}},this):o.each(function(t){for(var e=0;e<this._pointsBuilderList.length;e++){var r=this._pointsBuilderList[e];a?r.highlight(o,t):r.downplay(o,t)}})},dispose:function(){this._pointsBuilderList.forEach(function(t){t.dispose()}),this.groupGL.removeAll()},remove:function(){this.groupGL.removeAll()}});(0,O.use)(function(t){t.registerChartView($m),t.registerSeriesModel(Hm),t.registerLayout({seriesType:"scatter3D",reset:function(e){var o=e.coordinateSystem;if(o){var a,s,l,t=o.dimensions;if(!(t.length<3))return a=t.map(function(t){return e.coordDimToDataDim(t)[0]}),s=[],l=[],{progress:function(t,e){for(var r=new Float32Array(3*(t.end-t.start)),i=t.start;i<t.end;i++){var n=3*(i-t.start);s[0]=e.get(a[0],i),s[1]=e.get(a[1],i),s[2]=e.get(a[2],i),o.dataToPoint(s,l),r[n]=l[0],r[1+n]=l[1],r[2+n]=l[2]}e.setLayout("points",r)}};console.error("scatter3D needs 3D coordinateSystem")}}})});var tg=m.vec3,eg=m.vec2,rg=tg.normalize,ig=tg.cross,ng=tg.sub,og=tg.add,ag=tg.create,sg=ag(),lg=ag(),hg=ag(),ug=ag(),cg=[],dg=[];function fg(t,e){eg.copy(cg,t[0]),eg.copy(dg,t[1]);var t=[],r=t[0]=ag(),i=t[1]=ag(),n=t[2]=ag(),o=t[3]=ag(),e=(e.dataToPoint(cg,r),e.dataToPoint(dg,o),rg(sg,r),ng(lg,o,r),rg(lg,lg),ig(hg,lg,sg),rg(hg,hg),ig(lg,sg,hg),og(i,sg,lg),rg(i,i),rg(sg,o),ng(lg,r,o),rg(lg,lg),ig(hg,lg,sg),rg(hg,hg),ig(lg,sg,hg),og(n,sg,lg),rg(n,n),og(ug,r,o),rg(ug,ug),tg.dot(r,ug)),a=tg.dot(ug,i),e=(Math.max(tg.len(r),tg.len(o))-e)/a*2;return tg.scaleAndAdd(i,r,i,e),tg.scaleAndAdd(n,o,n,e),t}function pg(t,e){for(var r=new Float32Array(3*t.length),i=0,n=[],o=0;o<t.length;o++)e.dataToPoint(t[o],n),r[i++]=n[0],r[i++]=n[1],r[i++]=n[2];return r}function mg(e){var r=[];return e.each(function(t){t=e.getItemModel(t),t=t.option instanceof Array?t.option:t.getShallow("coords",!0);if(!(t instanceof Array&&0<t.length&&t[0]instanceof Array))throw new Error("Invalid coords "+JSON.stringify(t)+". Lines must have 2d coords array in data item.");r.push(t)}),{coordsList:r}}function gg(t,h,u){var c=t.getData(),d=t.get("polyline"),f=mg(c);c.setLayout("lineType",d?"polyline":"cubicBezier"),c.each(function(t){var e,r,i,n,o,a,s,l=f.coordsList[t],l=d?pg(l,h):(l=l,e=h,r=u,n=(i=[])[0]=tg.create(),o=i[1]=tg.create(),a=i[2]=tg.create(),s=i[3]=tg.create(),e.dataToPoint(l[0],n),e.dataToPoint(l[1],s),e=tg.dist(n,s),tg.lerp(o,n,s,.3),tg.lerp(a,n,s,.3),tg.scaleAndAdd(o,o,r,Math.min(.1*e,10)),tg.scaleAndAdd(a,a,r,Math.min(.1*e,10)),i);c.setItemLayout(t,l)})}function _g(t,e){t.eachSeriesByType("lines3D",function(t){var e,i,n,o,a,r=t.coordinateSystem;"globe"===r.type?(i=r,n=(e=t).getData(),o=e.get("polyline"),n.setLayout("lineType",o?"polyline":"cubicBezier"),a=mg(n),n.each(function(t){var e=a.coordsList[t],r=o?pg:fg;n.setItemLayout(t,r(e,i))})):"geo3D"===r.type?gg(t,r,[0,1,0]):"mapbox3D"!==r.type&&"maptalks3D"!==r.type||gg(t,r,[0,0,1])})}const yg=O.SeriesModel.extend({type:"series.lines3D",dependencies:["globe"],visualStyleAccessPath:"lineStyle",visualDrawType:"stroke",getInitialData:function(t,e){var n=new O.List(["value"],this);return n.hasItemOption=!1,n.initData(t.data,[],function(t,e,r,i){if(t instanceof Array)return NaN;n.hasItemOption=!0;t=t.value;return null!=t?t instanceof Array?t[i]:t:void 0}),n},defaultOption:{coordinateSystem:"globe",globeIndex:0,geo3DIndex:0,zlevel:-10,polyline:!1,effect:{show:!1,period:4,trailWidth:4,trailLength:.2,spotIntensity:6},silent:!0,blendMode:"source-over",lineStyle:{width:1,opacity:.5}}});var vg=m.vec3;q.Shader.import("@export ecgl.trail2.vertex\nattribute vec3 position: POSITION;\nattribute vec3 positionPrev;\nattribute vec3 positionNext;\nattribute float offset;\nattribute float dist;\nattribute float distAll;\nattribute float start;\n\nattribute vec4 a_Color : COLOR;\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform vec4 viewport : VIEWPORT;\nuniform float near : NEAR;\n\nuniform float speed : 0;\nuniform float trailLength: 0.3;\nuniform float time;\nuniform float period: 1000;\n\nuniform float spotSize: 1;\n\nvarying vec4 v_Color;\nvarying float v_Percent;\nvarying float v_SpotPercent;\n\n@import ecgl.common.wireframe.vertexHeader\n\n@import ecgl.lines3D.clipNear\n\nvoid main()\n{\n @import ecgl.lines3D.expandLine\n\n gl_Position = currProj;\n\n v_Color = a_Color;\n\n @import ecgl.common.wireframe.vertexMain\n\n#ifdef CONSTANT_SPEED\n float t = mod((speed * time + start) / distAll, 1. + trailLength) - trailLength;\n#else\n float t = mod((time + start) / period, 1. + trailLength) - trailLength;\n#endif\n\n float trailLen = distAll * trailLength;\n\n v_Percent = (dist - t * distAll) / trailLen;\n\n v_SpotPercent = spotSize / distAll;\n\n }\n@end\n\n\n@export ecgl.trail2.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\nuniform float spotIntensity: 5;\n\nvarying vec4 v_Color;\nvarying float v_Percent;\nvarying float v_SpotPercent;\n\n@import ecgl.common.wireframe.fragmentHeader\n\n@import clay.util.srgb\n\nvoid main()\n{\n if (v_Percent > 1.0 || v_Percent < 0.0) {\n discard;\n }\n\n float fade = v_Percent;\n\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(color * v_Color);\n#else\n gl_FragColor = color * v_Color;\n#endif\n\n @import ecgl.common.wireframe.fragmentMain\n\n if (v_Percent > (1.0 - v_SpotPercent)) {\n gl_FragColor.rgb *= spotIntensity;\n }\n\n gl_FragColor.a *= fade;\n}\n\n@end");const xg=q.Mesh.extend(function(){var t=new q.Material({shader:new q.Shader(q.Shader.source("ecgl.trail2.vertex"),q.Shader.source("ecgl.trail2.fragment")),transparent:!0,depthMask:!1}),e=new sc({dynamic:!0});return e.createAttribute("dist","float",1),e.createAttribute("distAll","float",1),e.createAttribute("start","float",1),{geometry:e,material:t,culling:!1,$ignorePicking:!0}},{updateData:function(h,t,u){var e=h.hostModel,c=this.geometry,r=e.getModel("effect"),d=r.get("trailWidth")*t.getDevicePixelRatio(),t=r.get("trailLength"),i=e.get("effect.constantSpeed"),f=1e3*e.get("effect.period"),p=null!=i,m=(this.getScene()||console.error("TrailMesh must been add to scene before updateData"),p?this.material.set("speed",i/1e3):this.material.set("period",f),this.material[p?"define":"undefine"]("vertex","CONSTANT_SPEED"),e.get("polyline")),g=(c.trailLength=t,this.material.set("trailLength",t),c.resetOffset(),["position","positionPrev","positionNext"].forEach(function(t){c.attributes[t].value=u.attributes[t].value}),["dist","distAll","start","offset","color"].forEach(function(t){c.attributes[t].init(c.vertexCount)}),c.indices=u.indices,[]),_=r.get("trailColor"),y=r.get("trailOpacity"),v=null!=_,x=null!=y,T=(this.updateWorldTransform(),this.worldTransform.x.len()),b=this.worldTransform.y.len(),w=this.worldTransform.z.len(),S=0,E=0;h.each(function(t){for(var e=h.getItemLayout(t),r=x?y:rp(h,t),t=ep(h,t),i=(null==r&&(r=1),(g=q.parseColor(v?_:t,g))[3]*=r,m?u.getPolylineVertexCount(e):u.getCubicCurveVertexCount(e[0],e[1],e[2],e[3])),n=0,o=[],a=[],s=S;s<S+i;s++)c.attributes.position.get(s,o),o[0]*=T,o[1]*=b,o[2]*=w,S<s&&(n+=vg.dist(o,a)),c.attributes.dist.set(s,n),vg.copy(a,o);E=Math.max(E,n);for(var l=Math.random()*(p?n:f),s=S;s<S+i;s++)c.attributes.distAll.set(s,n),c.attributes.start.set(s,l),c.attributes.offset.set(s,(0<u.attributes.offset.get(s)?1:-1)*d/2),c.attributes.color.set(s,g);S+=i}),this.material.set("spotSize",.1*E*t),this.material.set("spotIntensity",r.get("spotIntensity")),c.dirty()},setAnimationTime:function(t){this.material.set("time",t)}});q.Shader.import(y);const Tg=O.ChartView.extend({type:"lines3D",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this._meshLinesMaterial=new q.Material({shader:q.createShader("ecgl.meshLines3D"),transparent:!0,depthMask:!1}),this._linesMesh=new q.Mesh({geometry:new sc,material:this._meshLinesMaterial,$ignorePicking:!0}),this._trailMesh=new xg},render:function(t,e,r){this.groupGL.add(this._linesMesh);var i=t.coordinateSystem,n=t.getData(),o=(i&&i.viewGL&&(i.viewGL.add(this.groupGL),this._updateLines(t,e,r),e=i.viewGL.isLinearSpace()?"define":"undefine",this._linesMesh.material[e]("fragment","SRGB_DECODE"),this._trailMesh.material[e]("fragment","SRGB_DECODE")),this._trailMesh);o.stopAnimation(),t.get("effect.show")?(this.groupGL.add(o),o.updateData(n,r,this._linesMesh.geometry),o.__time=o.__time||0,this._curveEffectsAnimator=o.animate("",{loop:!0}).when(36e5,{__time:36e5}).during(function(){o.setAnimationTime(o.__time)}).start()):(this.groupGL.remove(o),this._curveEffectsAnimator=null),this._linesMesh.material.blend=this._trailMesh.material.blend="lighter"===t.get("blendMode")?q.additiveBlend:null},pauseEffect:function(){this._curveEffectsAnimator&&this._curveEffectsAnimator.pause()},resumeEffect:function(){this._curveEffectsAnimator&&this._curveEffectsAnimator.resume()},toggleEffect:function(){var t=this._curveEffectsAnimator;t&&(t.isPaused()?t.resume():t.pause())},_updateLines:function(t,e,r){var n=t.getData(),i=t.coordinateSystem,o=this._linesMesh.geometry,a=t.get("polyline"),i=(o.expandLine=!0,null!=(t=i).radius?t.radius:null!=t.size?Math.max(t.size[0],t.size[1],t.size[2]):100),s=(o.segmentScale=i/20,"lineStyle.width".split(".")),l=r.getDevicePixelRatio(),h=0,u=(n.each(function(t){var e=n.getItemModel(t).get(s);n.setItemVisual(t,"lineWidth",e=null==e?1:e),h=Math.max(e,h)}),o.useNativeLine=!1,0),c=0,d=(n.each(function(t){t=n.getItemLayout(t);a?(u+=o.getPolylineVertexCount(t),c+=o.getPolylineTriangleCount(t)):(u+=o.getCubicCurveVertexCount(t[0],t[1],t[2],t[3]),c+=o.getCubicCurveTriangleCount(t[0],t[1],t[2],t[3]))}),o.setVertexCount(u),o.setTriangleCount(c),o.resetOffset(),[]);n.each(function(t){var e=n.getItemLayout(t),r=ep(n,t),i=rp(n,t),t=n.getItemVisual(t,"lineWidth")*l;null==i&&(i=1),(d=q.parseColor(r,d))[3]*=i,a?o.addPolyline(e,d,t):o.addCubicCurve(e[0],e[1],e[2],e[3],d,t)}),o.dirty()},remove:function(){this.groupGL.removeAll()},dispose:function(){this.groupGL.removeAll()}});function bg(t,e){for(var r=[],i=0;i<e.length;i++)r.push(t.dataToPoint(e[i]));return r}(0,O.use)(function(t){t.registerChartView(Tg),t.registerSeriesModel(yg),t.registerLayout(_g),t.registerAction({type:"lines3DPauseEffect",event:"lines3deffectpaused",update:"series.lines3D:pauseEffect"},function(){}),t.registerAction({type:"lines3DResumeEffect",event:"lines3deffectresumed",update:"series.lines3D:resumeEffect"},function(){}),t.registerAction({type:"lines3DToggleEffect",event:"lines3deffectchanged",update:"series.lines3D:toggleEffect"},function(){})});Un=O.SeriesModel.extend({type:"series.polygons3D",getRegionModel:function(t){return this.getData().getItemModel(t)},getRegionPolygonCoords:function(t){for(var e=this.coordinateSystem,t=this.getData().getItemModel(t),r=t.option instanceof Array?t.option:t.getShallow("coords"),i=(t.get("multiPolygon")||(r=[r]),[]),n=0;n<r.length;n++){for(var o=[],a=1;a<r[n].length;a++)o.push(bg(e,r[n][a]));i.push({exterior:bg(e,r[n][0]),interiors:o})}return i},getInitialData:function(t){var n=new O.List(["value"],this);return n.hasItemOption=!1,n.initData(t.data,[],function(t,e,r,i){if(t instanceof Array)return NaN;n.hasItemOption=!0;t=t.value;return null!=t?t instanceof Array?t[i]:t:void 0}),n},defaultOption:{show:!0,data:null,multiPolygon:!1,progressiveThreshold:1e3,progressive:1e3,zlevel:-10,label:{show:!1,distance:2,textStyle:{fontSize:20,color:"#000",backgroundColor:"rgba(255,255,255,0.7)",padding:3,borderRadius:4}},itemStyle:{color:"#fff",borderWidth:0,borderColor:"#333"},emphasis:{itemStyle:{color:"#639fc0"},label:{show:!0}}}});O.util.merge(Un.prototype,t);const wg=Un,Sg=O.ChartView.extend({type:"polygons3D",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this._geo3DBuilderList=[],this._currentStep=0},render:function(t,e,r){this.groupGL.removeAll();var i=t.coordinateSystem,n=(i&&i.viewGL&&i.viewGL.add(this.groupGL),this._geo3DBuilderList[0]);n||((n=new sp(r)).extrudeY="mapbox3D"!==i.type&&"maptalks3D"!==i.type,this._geo3DBuilderList[0]=n),this._updateShaderDefines(i,n),n.update(t,e,r),this._geo3DBuilderList.length=1,this.groupGL.add(n.rootNode)},incrementalPrepareRender:function(t,e,r){this.groupGL.removeAll();t=t.coordinateSystem;t&&t.viewGL&&t.viewGL.add(this.groupGL),this._currentStep=0},incrementalRender:function(t,e,r,i){var n=this._geo3DBuilderList[this._currentStep],o=e.coordinateSystem;n||((n=new sp(i)).extrudeY="mapbox3D"!==o.type&&"maptalks3D"!==o.type,this._geo3DBuilderList[this._currentStep]=n),n.update(e,r,i,t.start,t.end),this.groupGL.add(n.rootNode),this._updateShaderDefines(o,n),this._currentStep++},_updateShaderDefines:function(e,t){var r=e.viewGL.isLinearSpace()?"define":"undefine";t.rootNode.traverse(function(t){t.material&&(t.material[r]("fragment","SRGB_DECODE"),"mapbox3D"!==e.type&&"maptalks3D"!==e.type||(t.material.define("fragment","NORMAL_UP_AXIS",2),t.material.define("fragment","NORMAL_FRONT_AXIS",1)))})},remove:function(){this.groupGL.removeAll()},dispose:function(){this.groupGL.removeAll(),this._geo3DBuilderList.forEach(function(t){t.dispose()})}});(0,O.use)(function(t){t.registerChartView(Sg),t.registerSeriesModel(wg)});d=O.SeriesModel.extend({type:"series.surface",dependencies:["globe","grid3D","geo3D"],visualStyleAccessPath:"itemStyle",formatTooltip:function(t){return Sm(this,t)},getInitialData:function(t,e){function r(t){return!(isNaN(t.min)||isNaN(t.max)||isNaN(t.step))}function i(t){var e=O.number.getPrecisionSafe;return Math.max(e(t.min),e(t.max),e(t.step))+1}if(!(w=t.data))if(t.parametric)for(var n=t.parametricEquation||{},o=n.u||{},a=n.v||{},s=(["u","v"].forEach(function(t){r(n[t])||console.error("Invalid parametricEquation.%s",t)}),["x","y","z"].forEach(function(t){"function"!=typeof n[t]&&console.error("parametricEquation.%s needs to be function",t)}),Math.floor((o.max+o.step-o.min)/o.step)),l=Math.floor((a.max+a.step-a.min)/a.step),h=(w=new Float32Array(s*l*5),i(o)),u=i(a),c=0,d=0;d<l;d++)for(M=0;M<s;M++){var f=M*o.step+o.min,p=d*a.step+a.min,f=O.number.round(Math.min(f,o.max),h),p=O.number.round(Math.min(p,a.max),u),m=n.x(f,p),g=n.y(f,p),_=n.z(f,p);w[c++]=m,w[c++]=g,w[c++]=_,w[c++]=f,w[c++]=p}else{var y=t.equation||{},v=y.x||{},x=y.y||{};if(["x","y"].forEach(function(t){r(y[t])||console.error("Invalid equation.%s",t)}),"function"!=typeof y.z)return void console.error("equation.z needs to be function");for(var T=Math.floor((v.max+v.step-v.min)/v.step),b=Math.floor((x.max+x.step-x.min)/x.step),w=new Float32Array(T*b*3),S=i(v),E=i(x),c=0,d=0;d<b;d++)for(var M=0;M<T;M++){var m=M*v.step+v.min,g=d*x.step+x.min,A=O.number.round(Math.min(m,v.max),S),C=O.number.round(Math.min(g,x.max),E),_=y.z(A,C);w[c++]=A,w[c++]=C,w[c++]=_}}var D=["x","y","z"];return t.parametric&&D.push("u","v"),Em(this,D,w)},defaultOption:{coordinateSystem:"cartesian3D",zlevel:-10,grid3DIndex:0,shading:"lambert",parametric:!1,wireframe:{show:!0,lineStyle:{color:"rgba(0,0,0,0.5)",width:1}},equation:{x:{min:-1,max:1,step:.1},y:{min:-1,max:1,step:.1},z:null},parametricEquation:{u:{min:-1,max:1,step:.1},v:{min:-1,max:1,step:.1},x:null,y:null,z:null},dataShape:null,itemStyle:{},animationDurationUpdate:500}});O.util.merge(d.prototype,t);const Eg=d;var Mg=m.vec3;const Ag=O.ChartView.extend({type:"surface",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node},render:function(t,e,r){var i=this._prevSurfaceMesh,i=(this._prevSurfaceMesh=this._surfaceMesh,this._surfaceMesh=i,this._surfaceMesh||(this._surfaceMesh=this._createSurfaceMesh()),this.groupGL.remove(this._prevSurfaceMesh),this.groupGL.add(this._surfaceMesh),t.coordinateSystem),n=t.get("shading"),o=t.getData(),a="ecgl."+n,n=(this._surfaceMesh.material&&this._surfaceMesh.material.shader.name===a||(this._surfaceMesh.material=q.createMaterial(a,["VERTEX_COLOR","DOUBLE_SIDED"])),q.setMaterialFromModel(n,this._surfaceMesh.material,t,r),i&&i.viewGL&&(i.viewGL.add(this.groupGL),a=i.viewGL.isLinearSpace()?"define":"undefine",this._surfaceMesh.material[a]("fragment","SRGB_DECODE")),t.get("parametric")),i=t.get("dataShape"),a=(i||(i=this._getDataShape(o,n),t.get("data")&&console.warn("dataShape is not provided. Guess it is ",i)),t.getModel("wireframe")),o=a.get("lineStyle.width"),n=a.get("show")&&0<o,i=(this._updateSurfaceMesh(this._surfaceMesh,t,i,n),this._surfaceMesh.material);n?(i.define("WIREFRAME_QUAD"),i.set("wireframeLineWidth",o),i.set("wireframeLineColor",q.parseColor(a.get("lineStyle.color")))):i.undefine("WIREFRAME_QUAD"),this._initHandler(t,r),this._updateAnimation(t)},_updateAnimation:function(t){q.updateVertexAnimation([["prevPosition","position"],["prevNormal","normal"]],this._prevSurfaceMesh,this._surfaceMesh,t)},_createSurfaceMesh:function(){var t=new q.Mesh({geometry:new q.Geometry({dynamic:!0,sortTriangles:!0}),shadowDepthMaterial:new q.Material({shader:new q.Shader(q.Shader.source("ecgl.sm.depth.vertex"),q.Shader.source("ecgl.sm.depth.fragment"))}),culling:!1,renderOrder:10,renderNormal:!0});return t.geometry.createAttribute("barycentric","float",4),t.geometry.createAttribute("prevPosition","float",3),t.geometry.createAttribute("prevNormal","float",3),Object.assign(t.geometry,tp),t},_initHandler:function(t,l){var h=t.getData(),u=this._surfaceMesh,c=t.coordinateSystem;u.seriesIndex=t.seriesIndex;var d=-1;u.off("mousemove"),u.off("mouseout"),u.on("mousemove",function(t){t=function(t,e){for(var r=1/0,i=-1,n=[],o=0;o<t.length;o++){u.geometry.attributes.position.get(t[o],n);var a=Mg.dist(e.array,n);a<r&&(r=a,i=t[o])}return i}(t.triangle,t.point);if(0<=t){for(var e=[],r=(u.geometry.attributes.position.get(t,e),c.pointToData(e)),i=1/0,n=-1,o=[],a=0;a<h.count();a++){o[0]=h.get("x",a),o[1]=h.get("y",a),o[2]=h.get("z",a);var s=Mg.squaredDistance(o,r);s<i&&(n=a,i=s)}n!==d&&l.dispatchAction({type:"grid3DShowAxisPointer",value:r}),d=n,u.dataIndex=n}else u.dataIndex=-1},this),u.on("mouseout",function(t){d=-1,u.dataIndex=-1,l.dispatchAction({type:"grid3DHideAxisPointer"})},this)},_updateSurfaceMesh:function(t,e,r,i){function n(t,e,r){r[1]=t*m+e,r[0]=t*m+e+1,r[3]=(t+1)*m+e+1,r[2]=(t+1)*m+e}var o,a=t.geometry,s=e.getData(),l=s.getLayout("points"),h=0,B=(s.each(function(t){s.hasValue(t)||h++}),h||i),u=a.attributes.position,c=a.attributes.normal,d=a.attributes.texcoord0,F=a.attributes.barycentric,f=a.attributes.color,p=r[0],m=r[1],g="color"!==e.get("shading"),_=(B?(u.init(r=(p-1)*(m-1)*4),i&&F.init(r)):u.value=new Float32Array(l),f.init(a.vertexCount),d.init(a.vertexCount),[0,3,1,1,3,2]),z=[[1,1,0,0],[0,1,0,1],[1,0,0,1],[1,0,1,0]],U=a.indices=new(65535<a.vertexCount?Uint32Array:Uint16Array)((p-1)*(m-1)*6),y=!1;if(B){for(var v=[],x=[],k=0,T=(g?c.init(a.vertexCount):c.value=null,[[],[],[]]),G=[],H=[],b=Mg.create(),w=function(t,e,r){e*=3;return r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r},S=new Float32Array(l.length),V=new Float32Array(l.length/3*4),E=0;E<s.count();E++)if(s.hasValue(E)){var M=q.parseColor(ep(s,E));null!=(O=rp(s,E))&&(M[3]*=O),M[3]<.99&&(y=!0);for(var A=0;A<4;A++)V[4*E+A]=M[A]}for(var W=[1e7,1e7,1e7],E=0;E<p-1;E++)for(var C=0;C<m-1;C++){for(var D=4*(E*(m-1)+C),L=(n(E,C,v),!1),A=0;A<4;A++)w(l,v[A],x),o=x,(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))&&(L=!0);for(A=0;A<4;A++)L?u.set(D+A,W):(w(l,v[A],x),u.set(D+A,x)),i&&F.set(D+A,z[A]);for(A=0;A<6;A++)U[k++]=_[A]+D;if(g&&!L)for(A=0;A<2;A++){for(var X=3*A,P=0;P<3;P++)w(l,I=v[_[X]+P],T[P]);Mg.sub(G,T[0],T[1]),Mg.sub(H,T[1],T[2]),Mg.cross(b,G,H);for(P=0;P<3;P++){var N=3*v[_[X]+P];S[N]=S[N]+b[0],S[1+N]=S[1+N]+b[1],S[2+N]=S[2+N]+b[2]}}}if(g)for(E=0;E<S.length/3;E++)w(S,E,b),Mg.normalize(b,b),S[3*E]=b[0],S[3*E+1]=b[1],S[3*E+2]=b[2];for(var M=[],R=[],E=0;E<p-1;E++)for(C=0;C<m-1;C++){D=4*(E*(m-1)+C);n(E,C,v);for(A=0;A<4;A++){for(P=0;P<4;P++)M[P]=V[4*v[A]+P];f.set(D+A,M),g&&(w(S,v[A],b),c.set(D+A,b));var I=v[A];R[0]=I%m/(m-1),R[1]=Math.floor(I/m)/(p-1),d.set(D+A,R)}0}}else{for(R=[],E=0;E<s.count();E++){R[0]=E%m/(m-1),R[1]=Math.floor(E/m)/(p-1);var O,M=q.parseColor(ep(s,E));null!=(O=rp(s,E))&&(M[3]*=O),M[3]<.99&&(y=!0),f.set(E,M),d.set(E,R)}for(var v=[],j=0,E=0;E<p-1;E++)for(C=0;C<m-1;C++){n(E,C,v);for(A=0;A<6;A++)U[j++]=v[_[A]]}g?a.generateVertexNormals():c.value=null}t.material.get("normalMap")&&a.generateTangents(),a.updateBoundingBox(),a.dirty(),t.material.transparent=y,t.material.depthMask=!y},_getDataShape:function(t,e){for(var r=-1/0,i=0,n=0,o=0,a=!1,s=e?"u":"x",l=t.count(),h=0;h<l;h++){var u=t.get(s,h);u<r&&(o&&o!==n&&(a=!0),o=n,n=0,i++),r=u,n++}if(!(a=i&&1!==n?a:!0))return[i+1,n];for(var c=Math.floor(Math.sqrt(l));0<c;){if(Math.floor(l/c)===l/c)return[c,l/c];c--}return[c=Math.floor(Math.sqrt(l)),c]},dispose:function(){this.groupGL.removeAll()},remove:function(){this.groupGL.removeAll()}});function Cg(t,e){for(var r=[],i=0;i<e.length;i++)r.push(t.dataToPoint(e[i]));return r}(0,O.use)(function(t){t.registerChartView(Ag),t.registerSeriesModel(Eg),t.registerLayout(function(t,e){t.eachSeriesByType("surface",function(e){var t,n=e.coordinateSystem,o=(n&&"cartesian3D"===n.type||console.error("Surface chart only support cartesian3D coordinateSystem"),e.getData()),a=new Float32Array(3*o.count()),s=[NaN,NaN,NaN];n&&"cartesian3D"===n.type&&(t=n.dimensions.map(function(t){return e.coordDimToDataDim(t)[0]}),o.each(t,function(t,e,r,i){t=o.hasValue(i)?n.dataToPoint([t,e,r]):s;a[3*i]=t[0],a[3*i+1]=t[1],a[3*i+2]=t[2]})),o.setLayout("points",a)})})});Gu=O.SeriesModel.extend({type:"series.map3D",layoutMode:"box",coordinateSystem:null,visualStyleAccessPath:"itemStyle",optionUpdated:function(e){e=e||{};var r,t=this.get("coordinateSystem");null!=t&&"geo3D"!==t&&(r=[],["left","top","width","height","boxWidth","boxDepth","boxHeight","light","viewControl","postEffect","temporalSuperSampling","environment","groundPlane"].forEach(function(t){null!=e[t]&&r.push(t)}),r.length&&console.warn("Property %s in map3D series will be ignored if coordinate system is %s",r.join(", "),t),this.get("groundPlane.show")&&(this.option.groundPlane.show=!1),this._geo=null)},getInitialData:function(t){t.data=this.getFilledRegions(t.data,t.map);var e=O.helper.createDimensions(t.data,{coordDimensions:["value"]}),r=new O.List(e,this),i=(r.initData(t.data),{});return r.each(function(t){var e=r.getName(t),t=r.getItemModel(t);i[e]=t}),this._regionModelMap=i,r},formatTooltip:function(t){return Sm(this,t)},getRegionModel:function(t){t=this.getData().getName(t);return this._regionModelMap[t]||new O.Model(null,this)},getRegionPolygonCoords:function(t){var e=this.coordinateSystem,t=this.getData().getName(t);if(e.transform)return(r=e.getRegion(t))?r.geometries:[];this._geo||(this._geo=Tp.createGeo3D(this));for(var r=this._geo.getRegion(t),i=[],n=0;n<r.geometries.length;n++){var o=r.geometries[n],a=[],s=Cg(e,o.exterior);if(a&&a.length)for(var l=0;l<o.interiors.length;l++)a.push(Cg(e,a[l]));i.push({interiors:a,exterior:s})}return i},getFormattedLabel:function(t,e){e=wm.getFormattedLabel(this,t,e);return e=null==e?this.getData().getName(t):e},defaultOption:{coordinateSystem:"geo3D",data:null}});O.util.merge(Gu.prototype,g),O.util.merge(Gu.prototype,Q),O.util.merge(Gu.prototype,Ar),O.util.merge(Gu.prototype,e),O.util.merge(Gu.prototype,t);const Dg=Gu,Lg=O.ChartView.extend({type:"map3D",__ecgl__:!0,init:function(t,e){this._geo3DBuilder=new sp(e),this.groupGL=new q.Node},render:function(t,e,r){var i,n,o,a=t.coordinateSystem;a&&a.viewGL&&(this.groupGL.add(this._geo3DBuilder.rootNode),a.viewGL.add(this.groupGL),"geo3D"===a.type?(this._sceneHelper||(this._sceneHelper=new dc,this._sceneHelper.initLight(this.groupGL)),this._sceneHelper.setScene(a.viewGL.scene),this._sceneHelper.updateLight(t),a.viewGL.setPostEffect(t.getModel("postEffect"),r),a.viewGL.setTemporalSuperSampling(t.getModel("temporalSuperSampling")),(i=this._control)||(i=this._control=new nc({zr:r.getZr()}),this._control.init()),n=t.getModel("viewControl"),i.setViewGL(a.viewGL),i.setFromViewControlModel(n,0),i.off("update"),i.on("update",function(){r.dispatchAction({type:"map3DChangeCamera",alpha:i.getAlpha(),beta:i.getBeta(),distance:i.getDistance(),from:this.uid,map3DId:t.id})}),this._geo3DBuilder.extrudeY=!0):(this._control&&(this._control.dispose(),this._control=null),this._sceneHelper&&(this._sceneHelper.dispose(),this._sceneHelper=null),t.getData().getLayout("geo3D"),this._geo3DBuilder.extrudeY=!1),this._geo3DBuilder.update(t,e,r,0,t.getData().count()),o=a.viewGL.isLinearSpace()?"define":"undefine",this._geo3DBuilder.rootNode.traverse(function(t){t.material&&t.material[o]("fragment","SRGB_DECODE")}))},afterRender:function(t,e,r,i){var i=i.renderer,n=t.coordinateSystem;n&&"geo3D"===n.type&&(this._sceneHelper.updateAmbientCubemap(i,t,r),this._sceneHelper.updateSkybox(i,t,r))},dispose:function(){this.groupGL.removeAll(),this._control.dispose(),this._geo3DBuilder.dispose()}});(0,O.use)(function(t){bp(t),t.registerChartView(Lg),t.registerSeriesModel(Dg),t.registerAction({type:"map3DChangeCamera",event:"map3dcamerachanged",update:"series:updateCamera"},function(e,t){t.eachComponent({mainType:"series",subType:"map3D",query:e},function(t){t.setView(e)})})});const Pg=O.SeriesModel.extend({type:"series.scatterGL",dependencies:["grid","polar","geo","singleAxis"],visualStyleAccessPath:"itemStyle",hasSymbolVisual:!0,getInitialData:function(){return O.helper.createList(this)},defaultOption:{coordinateSystem:"cartesian2d",zlevel:10,progressive:1e5,progressiveThreshold:1e5,large:!1,symbol:"circle",symbolSize:10,zoomScale:0,blendMode:"source-over",itemStyle:{opacity:.8},postEffect:{enable:!1,colorCorrection:{exposure:0,brightness:0,contrast:1,saturation:1,enable:!0}}}});function Ng(t){this.viewGL=t}Ng.prototype.reset=function(t,e){this._updateCamera(e.getWidth(),e.getHeight(),e.getDevicePixelRatio()),this._viewTransform=ha(),this.updateTransform(t,e)},Ng.prototype.updateTransform=function(t,e){t=t.coordinateSystem;t.getRoamTransform&&(pa(this._viewTransform,t.getRoamTransform()),this._setCameraTransform(this._viewTransform),e.getZr().refresh())},Ng.prototype.dataToPoint=function(t,e,r){r=t.dataToPoint(e,null,r);t=this._viewTransform;t&&es(r,r,t)},Ng.prototype.removeTransformInPoint=function(t){return this._viewTransform&&es(t,t,this._viewTransform),t},Ng.prototype.getZoom=function(){var t;return this._viewTransform?(t=this._viewTransform,1/Math.max(Math.sqrt(t[0]*t[0]+t[1]*t[1]),Math.sqrt(t[2]*t[2]+t[3]*t[3]))):1},Ng.prototype._setCameraTransform=function(t){var e=this.viewGL.camera;e.position.set(t[4],t[5],0),e.scale.set(Math.sqrt(t[0]*t[0]+t[1]*t[1]),Math.sqrt(t[2]*t[2]+t[3]*t[3]),1)},Ng.prototype._updateCamera=function(t,e,r){this.viewGL.setViewport(0,0,t,e,r);r=this.viewGL.camera;r.left=r.top=0,r.bottom=e,r.right=t,r.near=0,r.far=100};const Rg=Ng,Ig=O.ChartView.extend({type:"scatterGL",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this.viewGL=new gf("orthographic"),this.viewGL.add(this.groupGL),this._pointsBuilderList=[],this._currentStep=0,this._sizeScale=1,this._glViewHelper=new Rg(this.viewGL)},render:function(t,e,r){var i;this.groupGL.removeAll(),this._glViewHelper.reset(t,r),t.getData().count()&&(i=(i=this._pointsBuilderList[0])||(this._pointsBuilderList[0]=new Jm(!0,r)),this._pointsBuilderList.length=1,this.groupGL.add(i.rootNode),this._removeTransformInPoints(t.getData().getLayout("points")),i.update(t,e,r),this.viewGL.setPostEffect(t.getModel("postEffect"),r))},incrementalPrepareRender:function(t,e,r){this.groupGL.removeAll(),this._glViewHelper.reset(t,r),this._currentStep=0,this.viewGL.setPostEffect(t.getModel("postEffect"),r)},incrementalRender:function(t,e,r,i){var n;t.end<=t.start||((n=this._pointsBuilderList[this._currentStep])||(n=new Jm(!0,i),this._pointsBuilderList[this._currentStep]=n),this.groupGL.add(n.rootNode),this._removeTransformInPoints(e.getData().getLayout("points")),n.setSizeScale(this._sizeScale),n.update(e,r,i,t.start,t.end),i.getZr().refresh(),this._currentStep++)},updateTransform:function(t,e,r){var i;t.coordinateSystem.getRoamTransform&&(this._glViewHelper.updateTransform(t,r),r=this._glViewHelper.getZoom(),i=Math.max((t.get("zoomScale")||0)*(r-1)+1,0),this._sizeScale=i,this._pointsBuilderList.forEach(function(t){t.setSizeScale(i)}))},_removeTransformInPoints:function(t){if(t)for(var e=[],r=0;r<t.length;r+=2)e[0]=t[r],e[1]=t[r+1],this._glViewHelper.removeTransformInPoint(e),t[r]=e[0],t[r+1]=e[1]},dispose:function(){this.groupGL.removeAll(),this._pointsBuilderList.forEach(function(t){t.dispose()})},remove:function(){this.groupGL.removeAll()}});function Og(t){return"_EC_"+t}(0,O.use)(function(t){t.registerChartView(Ig),t.registerSeriesModel(Pg),t.registerLayout({seriesType:"scatterGL",reset:function(t){var e,a,s,l=t.coordinateSystem,h=t.getData();return l&&(a=l.dimensions.map(function(t){return h.mapDimension(t)}).slice(0,2),s=[],1===a.length?e=function(t){for(var e=new Float32Array(2*(t.end-t.start)),r=t.start;r<t.end;r++){var i=2*(r-t.start),n=h.get(a[0],r),n=l.dataToPoint(n);e[i]=n[0],e[1+i]=n[1]}h.setLayout("points",e)}:2===a.length&&(e=function(t){for(var e=new Float32Array(2*(t.end-t.start)),r=t.start;r<t.end;r++){var i=2*(r-t.start),n=h.get(a[0],r),o=h.get(a[1],r);s[0]=n,s[1]=o,s=l.dataToPoint(s),e[i]=s[0],e[1+i]=s[1]}h.setLayout("points",e)})),{progress:e}}})});Bg.prototype.isDirected=function(){return this._directed},Bg.prototype.addNode=function(t,e){var r=this._nodesMap;if(!r[Og(t=null==t?""+e:""+t)])return((e=new Fg(t,e)).hostGraph=this).nodes.push(e),r[Og(t)]=e;console.error("Graph nodes have duplicate name or id")},Bg.prototype.getNodeByIndex=function(t){t=this.data.getRawIndex(t);return this.nodes[t]},Bg.prototype.getNodeById=function(t){return this._nodesMap[Og(t)]},Bg.prototype.addEdge=function(t,e,r){var i=this._nodesMap,n=this._edgesMap;if("number"==typeof t&&(t=this.nodes[t]),"number"==typeof e&&(e=this.nodes[e]),t instanceof Fg||(t=i[Og(t)]),e instanceof Fg||(e=i[Og(e)]),t&&e)return i=t.id+"-"+e.id,((r=new Ug(t,e,r)).hostGraph=this)._directed&&(t.outEdges.push(r),e.inEdges.push(r)),t.edges.push(r),t!==e&&e.edges.push(r),this.edges.push(r),n[i]=r},Bg.prototype.getEdgeByIndex=function(t){t=this.edgeData.getRawIndex(t);return this.edges[t]},Bg.prototype.getEdge=function(t,e){t instanceof Fg&&(t=t.id),e instanceof Fg&&(e=e.id);var r=this._edgesMap;return this._directed?r[t+"-"+e]:r[t+"-"+e]||r[e+"-"+t]},Bg.prototype.eachNode=function(t,e){for(var r=this.nodes,i=r.length,n=0;n<i;n++)0<=r[n].dataIndex&&t.call(e,r[n],n)},Bg.prototype.eachEdge=function(t,e){for(var r=this.edges,i=r.length,n=0;n<i;n++)0<=r[n].dataIndex&&0<=r[n].node1.dataIndex&&0<=r[n].node2.dataIndex&&t.call(e,r[n],n)},Bg.prototype.breadthFirstTraverse=function(t,e,r,i){if(e=e instanceof Fg?e:this._nodesMap[Og(e)]){for(var n="out"===r?"outEdges":"in"===r?"inEdges":"edges",o=0;o<this.nodes.length;o++)this.nodes[o].__visited=!1;if(!t.call(i,e,null))for(var a=[e];a.length;)for(var s=a.shift(),l=s[n],o=0;o<l.length;o++){var h=l[o],h=h.node1===s?h.node2:h.node1;if(!h.__visited){if(t.call(i,h,s))return;a.push(h),h.__visited=!0}}}},Bg.prototype.update=function(){for(var t=this.data,e=this.edgeData,r=this.nodes,i=this.edges,n=0,o=r.length;n<o;n++)r[n].dataIndex=-1;for(n=0,o=t.count();n<o;n++)r[t.getRawIndex(n)].dataIndex=n;e.filterSelf(function(t){t=i[e.getRawIndex(t)];return 0<=t.node1.dataIndex&&0<=t.node2.dataIndex});for(n=0,o=i.length;n<o;n++)i[n].dataIndex=-1;for(n=0,o=e.count();n<o;n++)i[e.getRawIndex(n)].dataIndex=n},Bg.prototype.clone=function(){for(var t=new Bg(this._directed),e=this.nodes,r=this.edges,i=0;i<e.length;i++)t.addNode(e[i].id,e[i].dataIndex);for(i=0;i<r.length;i++){var n=r[i];t.addEdge(n.node1.id,n.node2.id,n.dataIndex)}return t};Ou=Bg;function Bg(t){this.type="graph",this.nodes=[],this.edges=[],this._nodesMap={},this._edgesMap={},this._directed=t||!1}zg.prototype.degree=function(){return this.edges.length},zg.prototype.inDegree=function(){return this.inEdges.length},zg.prototype.outDegree=function(){return this.outEdges.length},zg.prototype.getModel=function(t){if(!(this.dataIndex<0))return this.hostGraph.data.getItemModel(this.dataIndex).getModel(t)},zg.prototype.getAdjacentDataIndices=function(){for(var t={edge:[],node:[]},e=0;e<this.edges.length;e++){var r=this.edges[e];r.dataIndex<0||(t.edge.push(r.dataIndex),t.node.push(r.node1.dataIndex,r.node2.dataIndex))}return t};var Fg=zg;function zg(t,e){this.inEdges=[],this.outEdges=[],this.edges=[],this.dataIndex=-1,this.id=null==t?"":t,this.dataIndex=null==e?-1:e}kg.prototype.getModel=function(t){if(!(this.dataIndex<0))return this.hostGraph.edgeData.getItemModel(this.dataIndex).getModel(t)},kg.prototype.getAdjacentDataIndices=function(){return{edge:[this.dataIndex],node:[this.node1.dataIndex,this.node2.dataIndex]}};var Ug=kg;function kg(t,e,r){this.dataIndex=-1,this.node1=t,this.node2=e,this.dataIndex=null==r?-1:r}function Gg(r,i){return{getValue:function(t){var e=this[r][i];return e.get(e.getDimension(t||"value"),this.dataIndex)},setVisual:function(t,e){0<=this.dataIndex&&this[r][i].setItemVisual(this.dataIndex,t,e)},getVisual:function(t){return this[r][i].getItemVisual(this.dataIndex,t)},setLayout:function(t,e){0<=this.dataIndex&&this[r][i].setItemLayout(this.dataIndex,t,e)},getLayout:function(){return this[r][i].getItemLayout(this.dataIndex)},getGraphicEl:function(){return this[r][i].getItemGraphicEl(this.dataIndex)},getRawIndex:function(){return this[r][i].getRawIndex(this.dataIndex)}}}Jn(Fg,Gg("hostGraph","data")),Jn(Ug,Gg("hostGraph","edgeData"));const Hg=Ou;var Vg=Bh();function Wg(t,e){var r;return Vg(r=this).mainData===r?Yg((r=Yn({},Vg(this).datas))[this.dataType]=e,r,t):Kg(e,this.dataType,Vg(this).mainData,t),e}function Xg(t,e){return t.struct&&t.struct.update(),e}function jg(r,i){return to(Vg(i).datas,function(t,e){t!==i&&Kg(t.cloneShallow(),e,i,r)}),i}function qg(t){var e=Vg(this).mainData;return null==t||null==e?e:Vg(e).datas[t]}function Zg(){var e=Vg(this).mainData;return null==e?[{data:e}]:eo(io(Vg(e).datas),function(t){return{type:t,data:Vg(e).datas[t]}})}function Yg(r,t,i){Vg(r).datas={},to(t,function(t,e){Kg(t,e,r,i)})}function Kg(t,e,r,i){Vg(r).datas[e]=t,Vg(t).mainData=r,t.dataType=e,i.struct&&(t[i.structAttr]=i.struct,i.struct[i.datasAttr[e]]=t),t.getLinkedData=qg,t.getLinkedDataAll=Zg}const Qg=function(r){var i=r.mainData,t=r.datas;t||(t={main:i},r.datasAttr={main:"data"}),r.datas=r.mainData=null,Yg(i,t,r),to(t,function(e){to(i.TRANSFERABLE_METHODS,function(t){e.wrapMethod(t,no(Wg,r))})}),i.wrapMethod("cloneShallow",no(jg,r)),to(i.CHANGABLE_METHODS,function(t){i.wrapMethod(t,no(Xg,r))}),go(t[i.dataType]===i)};var Jg=O.SeriesModel.extend({type:"series.graphGL",visualStyleAccessPath:"itemStyle",hasSymbolVisual:!0,init:function(t){Jg.superApply(this,"init",arguments),this.legendDataProvider=function(){return this._categoriesData},this._updateCategoriesData()},mergeOption:function(t){Jg.superApply(this,"mergeOption",arguments),this._updateCategoriesData()},getFormattedLabel:function(t,e,r,i){e=wm.getFormattedLabel(this,t,e,r,i);return null==e&&(i=(r=this.getData()).dimensions[r.dimensions.length-1],e=r.get(i,t)),e},getInitialData:function(t,o){var e=t.edges||t.links||[],t=t.data||t.nodes||[],a=this;if(t&&e)return function(t,e,r,i,n){for(var o=new Hg(i),a=0;a<t.length;a++)o.addNode(A.firstNotNull(t[a].id,t[a].name,a),a);for(var s=[],l=[],h=0,a=0;a<e.length;a++){var u=e[a],c=u.source,d=u.target;o.addEdge(c,d,h)&&(l.push(u),s.push(A.firstNotNull(u.id,c+" > "+d)),h++)}var i=O.helper.createDimensions(t,{coordDimensions:["value"]});return(i=new O.List(i,r)).initData(t),(r=new O.List(["value"],r)).initData(l,s),n&&n(i,r),Qg({mainData:i,struct:o,structAttr:"graph",datas:{node:i,edge:r},datasAttr:{node:"data",edge:"edgeData"}}),o.update(),o}(t,e,this,!0,function(t,e){t.wrapMethod("getItemModel",function(t){var e=a._categoriesModels[t.getShallow("category")];return e&&(e.parentModel=t.parentModel,t.parentModel=e),t});const r=o.getModel([]).getModel;function i(t,e){t=r.call(this,t,e);return t.resolveParentPath=n,t}function n(t){var e;return!t||"label"!==t[0]&&"label"!==t[1]?t:(e=t.slice(),"label"===t[0]?e[0]="edgeLabel":"label"===t[1]&&(e[1]="edgeLabel"),e)}e.wrapMethod("getItemModel",function(t){return t.resolveParentPath=n,t.getModel=i,t})}).data},getGraph:function(){return this.getData().graph},getEdgeData:function(){return this.getGraph().edgeData},getCategoriesData:function(){return this._categoriesData},formatTooltip:function(t,e,r){var i,n;return"edge"===r?(n=this.getData(),r=this.getDataParams(t,r),t=n.graph.getEdgeByIndex(t),i=n.getName(t.node1.dataIndex),n=n.getName(t.node2.dataIndex),t=[],null!=i&&t.push(i),null!=n&&t.push(n),t=O.format.encodeHTML(t.join(" > ")),r.value&&(t+=" : "+O.format.encodeHTML(r.value)),t):Jg.superApply(this,"formatTooltip",arguments)},_updateCategoriesData:function(){var t=(this.option.categories||[]).map(function(t){return null!=t.value?t:Object.assign({value:0},t)}),e=new O.List(["value"],this);e.initData(t),this._categoriesData=e,this._categoriesModels=e.mapArray(function(t){return e.getItemModel(t,!0)})},setView:function(t){null!=t.zoom&&(this.option.zoom=t.zoom),null!=t.offset&&(this.option.offset=t.offset)},setNodePosition:function(t){for(var e=0;e<t.length/2;e++){var r=t[2*e],i=t[2*e+1],n=this.getData().getRawDataItem(e);n.x=r,n.y=i}},isAnimationEnabled:function(){return Jg.superCall(this,"isAnimationEnabled")&&!("force"===this.get("layout")&&this.get("force.layoutAnimation"))},defaultOption:{zlevel:10,z:2,legendHoverLink:!0,layout:"forceAtlas2",forceAtlas2:{initLayout:null,GPU:!0,steps:1,maxSteps:1e3,repulsionByDegree:!0,linLogMode:!1,strongGravityMode:!1,gravity:1,edgeWeightInfluence:1,edgeWeight:[1,4],nodeWeight:[1,4],preventOverlap:!1,gravityCenter:null},focusNodeAdjacency:!0,focusNodeAdjacencyOn:"mouseover",left:"center",top:"center",symbol:"circle",symbolSize:5,roam:!1,center:null,zoom:1,label:{show:!1,formatter:"{b}",position:"right",distance:5,textStyle:{fontSize:14}},itemStyle:{},lineStyle:{color:"#aaa",width:1,opacity:.5},emphasis:{label:{show:!0}},animation:!1}});const $g=Jg;var t_,e_,r_,i_,n_,o_,a_,s_=m.vec2,l_=[[0,0],[1,1]],Eu=p.extend(function(){return{segmentScale:4,dynamic:!0,useNativeLine:!0,attributes:{position:new p.Attribute("position","float",2,"POSITION"),normal:new p.Attribute("normal","float",2),offset:new p.Attribute("offset","float",1),color:new p.Attribute("color","float",4,"COLOR")}}},{resetOffset:function(){this._vertexOffset=0,this._faceOffset=0,this._itemVertexOffsets=[]},setVertexCount:function(t){var e=this.attributes;this.vertexCount!==t&&(e.position.init(t),e.color.init(t),this.useNativeLine||(e.offset.init(t),e.normal.init(t)),65535<t?this.indices instanceof Uint16Array&&(this.indices=new Uint32Array(this.indices)):this.indices instanceof Uint32Array&&(this.indices=new Uint16Array(this.indices)))},setTriangleCount:function(t){this.triangleCount!==t&&(this.indices=0===t?null:new(65535<this.vertexCount?Uint32Array:Uint16Array)(3*t))},_getCubicCurveApproxStep:function(t,e,r,i){return 1/(s_.dist(t,e)+s_.dist(r,e)+s_.dist(i,r)+1)*this.segmentScale},getCubicCurveVertexCount:function(t,e,r,i){t=this._getCubicCurveApproxStep(t,e,r,i),e=Math.ceil(1/t);return this.useNativeLine?2*e:2*e+2},getCubicCurveTriangleCount:function(t,e,r,i){t=this._getCubicCurveApproxStep(t,e,r,i),e=Math.ceil(1/t);return this.useNativeLine?0:2*e},getLineVertexCount:function(){return this.getPolylineVertexCount(l_)},getLineTriangleCount:function(){return this.getPolylineTriangleCount(l_)},getPolylineVertexCount:function(t){return t="number"==typeof t?t:"number"!=typeof t[0]?t.length:t.length/2,this.useNativeLine?2*(t-1):2*(t-1)+2},getPolylineTriangleCount:function(t){return t="number"==typeof t?t:"number"!=typeof t[0]?t.length:t.length/2,this.useNativeLine?0:2*(t-1)},addCubicCurve:function(t,e,r,i,n,o){null==o&&(o=1);for(var a=t[0],s=t[1],l=e[0],h=e[1],u=r[0],c=r[1],d=i[0],f=i[1],p=this._getCubicCurveApproxStep(t,e,r,i),t=p*p,e=t*p,r=3*p,i=3*t,t=6*t,m=6*e,g=a-2*l+u,_=s-2*h+c,u=3*(l-u)-a+d,c=3*(h-c)-s+f,y=a,v=s,x=(l-a)*r+g*i+u*e,T=(h-s)*r+_*i+c*e,b=g*t+u*m,w=_*t+c*m,S=u*m,E=c*m,M=0,A=0,C=Math.ceil(1/p),D=new Float32Array(3*(C+1)),D=[],L=0,A=0;A<C+1;A++)D[L++]=y,D[L++]=v,y+=x,v+=T,x+=b,T+=w,b+=S,w+=E,1<(M+=p)&&(y=0<x?Math.min(y,d):Math.max(y,d),v=0<T?Math.min(v,f):Math.max(v,f));this.addPolyline(D,n,o)},addLine:function(t,e,r,i){this.addPolyline([t,e],r,i)},addPolyline:(t_=s_.create(),e_=s_.create(),r_=s_.create(),i_=s_.create(),n_=[],o_=[],a_=[],function(t,e,r,i,n){if(t.length){var o="number"!=typeof t[0];if(!((n=null==n?o?t.length:t.length/2:n)<2)){null==i&&(i=0),null==r&&(r=1),this._itemVertexOffsets.push(this._vertexOffset);for(var a,s,l,h,u=o?"number"!=typeof e[0]:e.length/4===n,c=this.attributes.position,d=this.attributes.color,f=this.attributes.offset,p=this.attributes.normal,m=this.indices,g=this._vertexOffset,_=0;_<n;_++)o?(n_=t[_+i],a=u?e[_+i]:e):((n_=n_||[])[0]=t[s=2*_+i],n_[1]=t[s+1],u?((a=a||[])[0]=e[l=4*_+i],a[1]=e[l+1],a[2]=e[l+2],a[3]=e[l+3]):a=e),this.useNativeLine?1<_&&(c.copy(g,g-1),d.copy(g,g-1),g++):(h=_<n-1?(o?s_.copy(o_,t[_+1]):((o_=o_||[])[0]=t[s=2*(_+1)+i],o_[1]=t[s+1]),0<_?(s_.sub(t_,n_,a_),s_.sub(e_,o_,n_),s_.normalize(t_,t_),s_.normalize(e_,e_),s_.add(i_,t_,e_),s_.normalize(i_,i_),l=r/2*Math.min(1/s_.dot(t_,i_),2),r_[0]=-i_[1],r_[1]=i_[0],l):(s_.sub(t_,o_,n_),s_.normalize(t_,t_),r_[0]=-t_[1],r_[1]=t_[0],r/2)):(s_.sub(t_,n_,a_),s_.normalize(t_,t_),r_[0]=-t_[1],r_[1]=t_[0],r/2),p.set(g,r_),p.set(g+1,r_),f.set(g,h),f.set(g+1,-h),s_.copy(a_,n_),c.set(g,n_),c.set(g+1,n_),d.set(g,a),d.set(g+1,a),g+=2),this.useNativeLine?(d.set(g,a),c.set(g,n_),g++):0<_&&(h=3*this._faceOffset,(m=this.indices)[h]=g-4,m[1+h]=g-3,m[2+h]=g-2,m[3+h]=g-3,m[4+h]=g-1,m[5+h]=g-2,this._faceOffset+=2);this._vertexOffset=g}}}),setItemColor:function(t,e){for(var r=this._itemVertexOffsets[t],i=t<this._itemVertexOffsets.length-1?this._itemVertexOffsets[t+1]:this._vertexOffset,n=r;n<i;n++)this.attributes.color.set(n,e);this.dirty("color")}});O.util.defaults(Eu.prototype,gn);const h_=Eu;q.Shader.import("@export ecgl.forceAtlas2.updateNodeRepulsion\n\n#define NODE_COUNT 0\n\nuniform sampler2D positionTex;\n\nuniform vec2 textureSize;\nuniform float gravity;\nuniform float scaling;\nuniform vec2 gravityCenter;\n\nuniform bool strongGravityMode;\nuniform bool preventOverlap;\n\nvarying vec2 v_Texcoord;\n\nvoid main() {\n\n vec4 n0 = texture2D(positionTex, v_Texcoord);\n\n vec2 force = vec2(0.0);\n for (int i = 0; i < NODE_COUNT; i++) {\n vec2 uv = vec2(\n mod(float(i), textureSize.x) / (textureSize.x - 1.0),\n floor(float(i) / textureSize.x) / (textureSize.y - 1.0)\n );\n vec4 n1 = texture2D(positionTex, uv);\n\n vec2 dir = n0.xy - n1.xy;\n float d2 = dot(dir, dir);\n\n if (d2 > 0.0) {\n float factor = 0.0;\n if (preventOverlap) {\n float d = sqrt(d2);\n d = d - n0.w - n1.w;\n if (d > 0.0) {\n factor = scaling * n0.z * n1.z / (d * d);\n }\n else if (d < 0.0) {\n factor = scaling * 100.0 * n0.z * n1.z;\n }\n }\n else {\n factor = scaling * n0.z * n1.z / d2;\n }\n force += dir * factor;\n }\n }\n\n vec2 dir = gravityCenter - n0.xy;\n float d = 1.0;\n if (!strongGravityMode) {\n d = length(dir);\n }\n\n force += dir * n0.z * gravity / (d + 1.0);\n\n gl_FragColor = vec4(force, 0.0, 1.0);\n}\n@end\n\n@export ecgl.forceAtlas2.updateEdgeAttraction.vertex\n\nattribute vec2 node1;\nattribute vec2 node2;\nattribute float weight;\n\nuniform sampler2D positionTex;\nuniform float edgeWeightInfluence;\nuniform bool preventOverlap;\nuniform bool linLogMode;\n\nuniform vec2 windowSize: WINDOW_SIZE;\n\nvarying vec2 v_Force;\n\nvoid main() {\n\n vec4 n0 = texture2D(positionTex, node1);\n vec4 n1 = texture2D(positionTex, node2);\n\n vec2 dir = n1.xy - n0.xy;\n float d = length(dir);\n float w;\n if (edgeWeightInfluence == 0.0) {\n w = 1.0;\n }\n else if (edgeWeightInfluence == 1.0) {\n w = weight;\n }\n else {\n w = pow(weight, edgeWeightInfluence);\n }\n vec2 offset = vec2(1.0 / windowSize.x, 1.0 / windowSize.y);\n vec2 scale = vec2((windowSize.x - 1.0) / windowSize.x, (windowSize.y - 1.0) / windowSize.y);\n vec2 pos = node1 * scale * 2.0 - 1.0;\n gl_Position = vec4(pos + offset, 0.0, 1.0);\n gl_PointSize = 1.0;\n\n float factor;\n if (preventOverlap) {\n d = d - n1.w - n0.w;\n }\n if (d <= 0.0) {\n v_Force = vec2(0.0);\n return;\n }\n\n if (linLogMode) {\n factor = w * log(d) / d;\n }\n else {\n factor = w;\n }\n v_Force = dir * factor;\n}\n@end\n\n@export ecgl.forceAtlas2.updateEdgeAttraction.fragment\n\nvarying vec2 v_Force;\n\nvoid main() {\n gl_FragColor = vec4(v_Force, 0.0, 0.0);\n}\n@end\n\n@export ecgl.forceAtlas2.calcWeightedSum.vertex\n\nattribute vec2 node;\n\nvarying vec2 v_NodeUv;\n\nvoid main() {\n\n v_NodeUv = node;\n gl_Position = vec4(0.0, 0.0, 0.0, 1.0);\n gl_PointSize = 1.0;\n}\n@end\n\n@export ecgl.forceAtlas2.calcWeightedSum.fragment\n\nvarying vec2 v_NodeUv;\n\nuniform sampler2D positionTex;\nuniform sampler2D forceTex;\nuniform sampler2D forcePrevTex;\n\nvoid main() {\n vec2 force = texture2D(forceTex, v_NodeUv).rg;\n vec2 forcePrev = texture2D(forcePrevTex, v_NodeUv).rg;\n\n float mass = texture2D(positionTex, v_NodeUv).z;\n float swing = length(force - forcePrev) * mass;\n float traction = length(force + forcePrev) * 0.5 * mass;\n\n gl_FragColor = vec4(swing, traction, 0.0, 0.0);\n}\n@end\n\n@export ecgl.forceAtlas2.calcGlobalSpeed\n\nuniform sampler2D globalSpeedPrevTex;\nuniform sampler2D weightedSumTex;\nuniform float jitterTolerence;\n\nvoid main() {\n vec2 weightedSum = texture2D(weightedSumTex, vec2(0.5)).xy;\n float prevGlobalSpeed = texture2D(globalSpeedPrevTex, vec2(0.5)).x;\n float globalSpeed = jitterTolerence * jitterTolerence\n * weightedSum.y / weightedSum.x;\n if (prevGlobalSpeed > 0.0) {\n globalSpeed = min(globalSpeed / prevGlobalSpeed, 1.5) * prevGlobalSpeed;\n }\n gl_FragColor = vec4(globalSpeed, 0.0, 0.0, 1.0);\n}\n@end\n\n@export ecgl.forceAtlas2.updatePosition\n\nuniform sampler2D forceTex;\nuniform sampler2D forcePrevTex;\nuniform sampler2D positionTex;\nuniform sampler2D globalSpeedTex;\n\nvarying vec2 v_Texcoord;\n\nvoid main() {\n vec2 force = texture2D(forceTex, v_Texcoord).xy;\n vec2 forcePrev = texture2D(forcePrevTex, v_Texcoord).xy;\n vec4 node = texture2D(positionTex, v_Texcoord);\n\n float globalSpeed = texture2D(globalSpeedTex, vec2(0.5)).r;\n float swing = length(force - forcePrev);\n float speed = 0.1 * globalSpeed / (0.1 + globalSpeed * sqrt(swing));\n\n float df = length(force);\n if (df > 0.0) {\n speed = min(df * speed, 10.0) / df;\n\n gl_FragColor = vec4(node.xy + speed * force, node.zw);\n }\n else {\n gl_FragColor = node;\n }\n}\n@end\n\n@export ecgl.forceAtlas2.edges.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec2 node;\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n\nuniform sampler2D positionTex;\n\nvoid main()\n{\n gl_Position = worldViewProjection * vec4(\n texture2D(positionTex, node).xy, -10.0, 1.0\n );\n v_Color = a_Color;\n}\n@end\n\n@export ecgl.forceAtlas2.edges.fragment\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\nvarying vec4 v_Color;\nvoid main() {\n gl_FragColor = color * v_Color;\n}\n@end");var u_={repulsionByDegree:!0,linLogMode:!1,strongGravityMode:!1,gravity:1,scaling:1,edgeWeightInfluence:1,jitterTolerence:.1,preventOverlap:!1,dissuadeHubs:!1,gravityCenter:null};function c_(t){function e(t){t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE)}var r={type:q.Texture.FLOAT,minFilter:q.Texture.NEAREST,magFilter:q.Texture.NEAREST};this._positionSourceTex=new q.Texture2D(r),this._positionSourceTex.flipY=!1,this._positionTex=new q.Texture2D(r),this._positionPrevTex=new q.Texture2D(r),this._forceTex=new q.Texture2D(r),this._forcePrevTex=new q.Texture2D(r),this._weightedSumTex=new q.Texture2D(r),this._weightedSumTex.width=this._weightedSumTex.height=1,this._globalSpeedTex=new q.Texture2D(r),this._globalSpeedPrevTex=new q.Texture2D(r),this._globalSpeedTex.width=this._globalSpeedTex.height=1,this._globalSpeedPrevTex.width=this._globalSpeedPrevTex.height=1,this._nodeRepulsionPass=new tn({fragment:q.Shader.source("ecgl.forceAtlas2.updateNodeRepulsion")}),this._positionPass=new tn({fragment:q.Shader.source("ecgl.forceAtlas2.updatePosition")}),this._globalSpeedPass=new tn({fragment:q.Shader.source("ecgl.forceAtlas2.calcGlobalSpeed")}),this._copyPass=new tn({fragment:q.Shader.source("clay.compositor.output")});this._edgeForceMesh=new q.Mesh({geometry:new q.Geometry({attributes:{node1:new q.Geometry.Attribute("node1","float",2),node2:new q.Geometry.Attribute("node2","float",2),weight:new q.Geometry.Attribute("weight","float",1)},dynamic:!0,mainAttribute:"node1"}),material:new q.Material({transparent:!0,shader:q.createShader("ecgl.forceAtlas2.updateEdgeAttraction"),blend:e,depthMask:!1,depthText:!1}),mode:q.Mesh.POINTS}),this._weightedSumMesh=new q.Mesh({geometry:new q.Geometry({attributes:{node:new q.Geometry.Attribute("node","float",2)},dynamic:!0,mainAttribute:"node"}),material:new q.Material({transparent:!0,shader:q.createShader("ecgl.forceAtlas2.calcWeightedSum"),blend:e,depthMask:!1,depthText:!1}),mode:q.Mesh.POINTS}),this._framebuffer=new xi({depthBuffer:!1}),this._dummyCamera=new q.OrthographicCamera({left:-1,right:1,top:1,bottom:-1,near:0,far:100}),this._globalSpeed=0}c_.prototype.updateOption=function(t){for(var e in u_)this[e]=u_[e];var r=this._nodes.length;if(this.jitterTolerence=5e4<r?10:5e3<r?1:.1,this.scaling=100<r?2:10,t)for(var e in u_)null!=t[e]&&(this[e]=t[e]);if(this.repulsionByDegree)for(var i=this._positionSourceTex.pixels,n=0;n<this._nodes.length;n++)i[4*n+2]=(this._nodes[n].degree||0)+1},c_.prototype._updateGravityCenter=function(t){var e=this._nodes,r=this._edges;if(this.gravityCenter)this._gravityCenter=this.gravityCenter;else{for(var i=[1/0,1/0],n=[-1/0,-1/0],o=0;o<e.length;o++)i[0]=Math.min(e[o].x,i[0]),i[1]=Math.min(e[o].y,i[1]),n[0]=Math.max(e[o].x,n[0]),n[1]=Math.max(e[o].y,n[1]);this._gravityCenter=[.5*(i[0]+n[0]),.5*(i[1]+n[1])]}for(o=0;o<r.length;o++){var a=r[o].node1,s=r[o].node2;e[a].degree=(e[a].degree||0)+1,e[s].degree=(e[s].degree||0)+1}},c_.prototype.initData=function(t,e){this._nodes=t,this._edges=e,this._updateGravityCenter();for(var r=Math.ceil(Math.sqrt(t.length)),i=r,n=new Float32Array(r*i*4),o=(this._resize(r,i),0),a=0;a<t.length;a++){var s=t[a];n[o++]=s.x||0,n[o++]=s.y||0,n[o++]=s.mass||1,n[o++]=s.size||1}this._positionSourceTex.pixels=n;for(var l=this._edgeForceMesh.geometry,h=e.length,u=(l.attributes.node1.init(2*h),l.attributes.node2.init(2*h),l.attributes.weight.init(2*h),[]),a=0;a<e.length;a++){var c=l.attributes,d=e[a].weight;null==d&&(d=1),c.node1.set(a,this.getNodeUV(e[a].node1,u)),c.node2.set(a,this.getNodeUV(e[a].node2,u)),c.weight.set(a,d),c.node1.set(a+h,this.getNodeUV(e[a].node2,u)),c.node2.set(a+h,this.getNodeUV(e[a].node1,u)),c.weight.set(a+h,d)}var f=this._weightedSumMesh.geometry;f.attributes.node.init(t.length);for(a=0;a<t.length;a++)f.attributes.node.set(a,this.getNodeUV(a,u));l.dirty(),f.dirty(),this._nodeRepulsionPass.material.define("fragment","NODE_COUNT",t.length),this._nodeRepulsionPass.material.setUniform("textureSize",[r,i]),this._inited=!1,this._frame=0},c_.prototype.getNodes=function(){return this._nodes},c_.prototype.getEdges=function(){return this._edges},c_.prototype.step=function(t){this._inited||(this._initFromSource(t),this._inited=!0),this._frame++,this._framebuffer.attach(this._forceTex),this._framebuffer.bind(t);var e=this._nodeRepulsionPass,e=(e.setUniform("strongGravityMode",this.strongGravityMode),e.setUniform("gravity",this.gravity),e.setUniform("gravityCenter",this._gravityCenter),e.setUniform("scaling",this.scaling),e.setUniform("preventOverlap",this.preventOverlap),e.setUniform("positionTex",this._positionPrevTex),e.render(t),this._edgeForceMesh),e=(e.material.set("linLogMode",this.linLogMode),e.material.set("edgeWeightInfluence",this.edgeWeightInfluence),e.material.set("preventOverlap",this.preventOverlap),e.material.set("positionTex",this._positionPrevTex),t.gl.enable(t.gl.BLEND),t.renderPass([e],this._dummyCamera),this._framebuffer.attach(this._weightedSumTex),t.gl.clearColor(0,0,0,0),t.gl.clear(t.gl.COLOR_BUFFER_BIT),t.gl.enable(t.gl.BLEND),this._weightedSumMesh),e=(e.material.set("positionTex",this._positionPrevTex),e.material.set("forceTex",this._forceTex),e.material.set("forcePrevTex",this._forcePrevTex),t.renderPass([e],this._dummyCamera),this._framebuffer.attach(this._globalSpeedTex),this._globalSpeedPass),e=(e.setUniform("globalSpeedPrevTex",this._globalSpeedPrevTex),e.setUniform("weightedSumTex",this._weightedSumTex),e.setUniform("jitterTolerence",this.jitterTolerence),t.gl.disable(t.gl.BLEND),e.render(t),this._positionPass);this._framebuffer.attach(this._positionTex),e.setUniform("globalSpeedTex",this._globalSpeedTex),e.setUniform("positionTex",this._positionPrevTex),e.setUniform("forceTex",this._forceTex),e.setUniform("forcePrevTex",this._forcePrevTex),e.render(t),this._framebuffer.unbind(t),this._swapTexture()},c_.prototype.update=function(t,e,r){null==e&&(e=1),e=Math.max(e,1);for(var i=0;i<e;i++)this.step(t);r&&r()},c_.prototype.getNodePositionTexture=function(){return this._inited?this._positionPrevTex:this._positionSourceTex},c_.prototype.getNodeUV=function(t,e){var r=this._positionTex.width,i=this._positionTex.height;return(e=e||[])[0]=t%r/(r-1),e[1]=Math.floor(t/r)/(i-1)||0,e},c_.prototype.getNodePosition=function(t,e){var r=this._positionArr,i=this._positionTex.width,n=this._positionTex.height,o=i*n;r&&r.length===4*o||(r=this._positionArr=new Float32Array(4*o)),this._framebuffer.bind(t),this._framebuffer.attach(this._positionPrevTex),t.gl.readPixels(0,0,i,n,t.gl.RGBA,t.gl.FLOAT,r),this._framebuffer.unbind(t),e=e||new Float32Array(2*this._nodes.length);for(var a=0;a<this._nodes.length;a++)e[2*a]=r[4*a],e[2*a+1]=r[4*a+1];return e},c_.prototype.getTextureData=function(t,e){var e=this["_"+e+"Tex"],r=e.width,i=e.height,e=(this._framebuffer.bind(t),this._framebuffer.attach(e),new Float32Array(r*i*4));return t.gl.readPixels(0,0,r,i,t.gl.RGBA,t.gl.FLOAT,e),this._framebuffer.unbind(t),e},c_.prototype.getTextureSize=function(){return{width:this._positionTex.width,height:this._positionTex.height}},c_.prototype.isFinished=function(t){return this._frame>t},c_.prototype._swapTexture=function(){var t=this._positionPrevTex,t=(this._positionPrevTex=this._positionTex,this._positionTex=t,this._forcePrevTex),t=(this._forcePrevTex=this._forceTex,this._forceTex=t,this._globalSpeedPrevTex);this._globalSpeedPrevTex=this._globalSpeedTex,this._globalSpeedTex=t},c_.prototype._initFromSource=function(t){this._framebuffer.attach(this._positionPrevTex),this._framebuffer.bind(t),this._copyPass.setUniform("texture",this._positionSourceTex),this._copyPass.render(t),t.gl.clearColor(0,0,0,0),this._framebuffer.attach(this._forcePrevTex),t.gl.clear(t.gl.COLOR_BUFFER_BIT),this._framebuffer.attach(this._globalSpeedPrevTex),t.gl.clear(t.gl.COLOR_BUFFER_BIT),this._framebuffer.unbind(t)},c_.prototype._resize=function(e,r){["_positionSourceTex","_positionTex","_positionPrevTex","_forceTex","_forcePrevTex"].forEach(function(t){this[t].width=e,this[t].height=r,this[t].dirty()},this)},c_.prototype.dispose=function(t){this._framebuffer.dispose(t),this._copyPass.dispose(t),this._nodeRepulsionPass.dispose(t),this._positionPass.dispose(t),this._globalSpeedPass.dispose(t),this._edgeForceMesh.geometry.dispose(t),this._weightedSumMesh.geometry.dispose(t),this._positionSourceTex.dispose(t),this._positionTex.dispose(t),this._positionPrevTex.dispose(t),this._forceTex.dispose(t),this._forcePrevTex.dispose(t),this._weightedSumTex.dispose(t),this._globalSpeedTex.dispose(t),this._globalSpeedPrevTex.dispose(t)};const d_=c_;function f_(t){for(var e in m_)this[e]=m_[e];if(t)for(var e in t)this[e]=t[e];this._nodes=[],this._edges=[],this._disposed=!1,this._positionTex=new F({type:B.FLOAT,flipY:!1,minFilter:B.NEAREST,magFilter:B.NEAREST})}var p_=(p_=function(){var f=function(){return new Float32Array(2)},p=function(t,e){var r=e[0]-t[0],e=e[1]-t[1];return Math.sqrt(r*r+e*e)},m=function(t){var e=t[0],t=t[1];return Math.sqrt(e*e+t*t)},g=function(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t},_=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},a=function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t},y=function(t,e){return t[0]=e[0],t[1]=e[1],t},v=function(t,e,r){return t[0]=e,t[1]=r,t};function e(){this.subRegions=[],this.nSubRegions=0,this.node=null,this.mass=0,this.centerOfMass=null,this.bbox=new Float32Array(4),this.size=0}var t=e.prototype;function s(){this.position=new Float32Array(2),this.force=f(),this.forcePrev=f(),this.mass=1,this.inDegree=0,this.outDegree=0}function l(t,e){this.source=t,this.target=e,this.weight=1}function h(){this.autoSettings=!0,this.barnesHutOptimize=!0,this.barnesHutTheta=1.5,this.repulsionByDegree=!0,this.linLogMode=!1,this.strongGravityMode=!1,this.gravity=1,this.scaling=1,this.edgeWeightInfluence=1,this.jitterTolerence=.1,this.preventOverlap=!1,this.dissuadeHubs=!1,this.rootRegion=new e,this.rootRegion.centerOfMass=f(),this.nodes=[],this.edges=[],this.bbox=new Float32Array(4),this.gravityCenter=null,this._massArr=null,this._swingingArr=null,this._sizeArr=null,this._globalSpeed=0}t.beforeUpdate=function(){for(var t=0;t<this.nSubRegions;t++)this.subRegions[t].beforeUpdate();this.mass=0,this.centerOfMass&&(this.centerOfMass[0]=0,this.centerOfMass[1]=0),this.nSubRegions=0,this.node=null},t.afterUpdate=function(){this.subRegions.length=this.nSubRegions;for(var t=0;t<this.nSubRegions;t++)this.subRegions[t].afterUpdate()},t.addNode=function(t){if(0===this.nSubRegions){if(null==this.node)return void(this.node=t);this._addNodeToSubRegion(this.node),this.node=null}this._addNodeToSubRegion(t),this._updateCenterOfMass(t)},t.findSubRegion=function(t,e){for(var r=0;r<this.nSubRegions;r++){var i=this.subRegions[r];if(i.contain(t,e))return i}},t.contain=function(t,e){return this.bbox[0]<=t&&this.bbox[2]>=t&&this.bbox[1]<=e&&this.bbox[3]>=e},t.setBBox=function(t,e,r,i){this.bbox[0]=t,this.bbox[1]=e,this.bbox[2]=r,this.bbox[3]=i,this.size=(r-t+i-e)/2},t._newSubRegion=function(){var t=this.subRegions[this.nSubRegions];return t||(t=new e,this.subRegions[this.nSubRegions]=t),this.nSubRegions++,t},t._addNodeToSubRegion=function(t){var e,r,i,n,o=this.findSubRegion(t.position[0],t.position[1]),a=this.bbox;o||(i=(a[0]+a[2])/2,n=(a[1]+a[3])/2,e=(a[2]-a[0])/2,r=(a[3]-a[1])/2,i=t.position[0]>=i?1:0,n=t.position[1]>=n?1:0,(o=this._newSubRegion()).setBBox(i*e+a[0],n*r+a[1],(1+i)*e+a[0],(1+n)*r+a[1])),o.addNode(t)},t._updateCenterOfMass=function(t){null==this.centerOfMass&&(this.centerOfMass=new Float32Array(2));var e=this.centerOfMass[0]*this.mass,r=this.centerOfMass[1]*this.mass;e+=t.position[0]*t.mass,r+=t.position[1]*t.mass,this.mass+=t.mass,this.centerOfMass[0]=e/this.mass,this.centerOfMass[1]=r/this.mass};(t=h.prototype).initNodes=function(t,e,r){for(var i=e.length,n=void(this.nodes.length=0)!==r,o=0;o<i;o++){var a=new s;a.position[0]=t[2*o],a.position[1]=t[2*o+1],a.mass=e[o],n&&(a.size=r[o]),this.nodes.push(a)}this._massArr=e,this._swingingArr=new Float32Array(i),n&&(this._sizeArr=r)},t.initEdges=function(t,e){for(var r=t.length/2,i=this.edges.length=0;i<r;i++){var n=t[2*i],o=t[2*i+1],n=this.nodes[n],o=this.nodes[o];if(!n||!o)return void console.error("Node not exists, try initNodes before initEdges");n.outDegree++,o.inDegree++;n=new l(n,o);e&&(n.weight=e[i]),this.edges.push(n)}},t.updateSettings=function(){if(this.repulsionByDegree)for(var t=0;t<this.nodes.length;t++)(e=this.nodes[t]).mass=e.inDegree+e.outDegree+1;else for(var e,t=0;t<this.nodes.length;t++)(e=this.nodes[t]).mass=this._massArr[t]},t.update=function(){var t=this.nodes.length;if(this.updateSettings(),this.updateBBox(),this.barnesHutOptimize){this.rootRegion.setBBox(this.bbox[0],this.bbox[1],this.bbox[2],this.bbox[3]),this.rootRegion.beforeUpdate();for(var e=0;e<t;e++)this.rootRegion.addNode(this.nodes[e]);this.rootRegion.afterUpdate()}for(e=0;e<t;e++){var r=this.nodes[e];y(r.forcePrev,r.force),v(r.force,0,0)}for(e=0;e<t;e++){var i=this.nodes[e];if(this.barnesHutOptimize)this.applyRegionToNodeRepulsion(this.rootRegion,i);else for(var n=e+1;n<t;n++){var o=this.nodes[n];this.applyNodeToNodeRepulsion(i,o,!1)}0<this.gravity&&(this.strongGravityMode?this.applyNodeStrongGravity(i):this.applyNodeGravity(i))}for(e=0;e<this.edges.length;e++)this.applyEdgeAttraction(this.edges[e]);for(var a=0,s=0,l=f(),e=0;e<t;e++){r=this.nodes[e];a+=(u=p(r.force,r.forcePrev))*r.mass,_(l,r.force,r.forcePrev),s+=.5*m(l)*r.mass,this._swingingArr[e]=u}var h=this.jitterTolerence*this.jitterTolerence*s/a;0<this._globalSpeed&&(h=Math.min(h/this._globalSpeed,1.5)*this._globalSpeed),this._globalSpeed=h;for(e=0;e<t;e++){var r=this.nodes[e],u=this._swingingArr[e],c=.1*h/(1+h*Math.sqrt(u)),d=m(r.force);0<d&&(c=Math.min(d*c,10)/d,g(r.position,r.position,r.force,c))}},t.applyRegionToNodeRepulsion=(n=f(),function(t,e){if(t.node)this.applyNodeToNodeRepulsion(t.node,e,!0);else{a(n,e.position,t.centerOfMass);var r=n[0]*n[0]+n[1]*n[1];if(r>this.barnesHutTheta*t.size*t.size){r=this.scaling*e.mass*t.mass/r;g(e.force,e.force,n,r)}else for(var i=0;i<t.nSubRegions;i++)this.applyRegionToNodeRepulsion(t.subRegions[i],e)}}),t.applyNodeToNodeRepulsion=(u=f(),function(t,e,r){if(t!=e){a(u,t.position,e.position);var i,n,o=u[0]*u[0]+u[1]*u[1];if(0!=o){if(this.preventOverlap)if(0<(n=Math.sqrt(o)-t.size-e.size))i=this.scaling*t.mass*e.mass/(n*n);else{if(!(n<0))return;i=100*this.scaling*t.mass*e.mass}else i=this.scaling*t.mass*e.mass/o;g(t.force,t.force,u,i),g(e.force,e.force,u,-i)}}}),t.applyEdgeAttraction=(o=f(),function(t){var e=t.source,r=t.target,i=(a(o,e.position,r.position),m(o)),t=0===this.edgeWeightInfluence?1:1===this.edgeWeightInfluence?t.weight:Math.pow(t.weight,this.edgeWeightInfluence);this.preventOverlap&&(i=i-e.size-r.size)<=0||(i=this.linLogMode?-t*Math.log(i+1)/(i+1):-t,g(e.force,e.force,o,i),g(r.force,r.force,o,-i))}),t.applyNodeGravity=(r=f(),function(t){a(r,this.gravityCenter,t.position);var e=m(r);g(t.force,t.force,r,this.gravity*t.mass/(e+1))}),t.applyNodeStrongGravity=(i=f(),function(t){a(i,this.gravityCenter,t.position),g(t.force,t.force,i,this.gravity*t.mass)}),t.updateBBox=function(){for(var t=1/0,e=1/0,r=-1/0,i=-1/0,n=0;n<this.nodes.length;n++)var o=this.nodes[n].position,t=Math.min(t,o[0]),e=Math.min(e,o[1]),r=Math.max(r,o[0]),i=Math.max(i,o[1]);this.bbox[0]=t,this.bbox[1]=e,this.bbox[2]=r,this.bbox[3]=i},t.getGlobalSpeed=function(){return this._globalSpeed};var n,u,o,r,i,c=null;self.onmessage=function(t){switch(t.data.cmd){case"init":(c=new h).initNodes(t.data.nodesPosition,t.data.nodesMass,t.data.nodesSize),c.initEdges(t.data.edges,t.data.edgesWeight);break;case"updateConfig":if(c)for(var e in t.data.config)c[e]=t.data.config[e];break;case"update":var r=t.data.steps;if(c){for(var i=0;i<r;i++)c.update();for(var n=c.nodes.length,o=new Float32Array(2*n),i=0;i<n;i++){var a=c.nodes[i];o[2*i]=a.position[0],o[2*i+1]=a.position[1]}self.postMessage({buffer:o.buffer,globalSpeed:c.getGlobalSpeed()},[o.buffer])}else{var s=new Float32Array;self.postMessage({buffer:s.buffer,globalSpeed:c.getGlobalSpeed()},[s.buffer])}}}}.toString()).slice(p_.indexOf("{")+1,p_.lastIndexOf("}")),m_={barnesHutOptimize:!0,barnesHutTheta:1.5,repulsionByDegree:!0,linLogMode:!1,strongGravityMode:!1,gravity:1,scaling:1,edgeWeightInfluence:1,jitterTolerence:.1,preventOverlap:!1,dissuadeHubs:!1,gravityCenter:null};f_.prototype.initData=function(t,e){for(var r=new Blob([p_]),r=window.URL.createObjectURL(r),r=(this._worker=new Worker(r),this._worker.onmessage=this._$onupdate.bind(this),this._nodes=t,this._edges=e,this._frame=0,t.length),i=e.length,n=new Float32Array(2*r),o=new Float32Array(r),a=new Float32Array(r),s=new Float32Array(2*i),l=new Float32Array(i),h=0;h<t.length;h++){var u=t[h];n[2*h]=u.x,n[2*h+1]=u.y,o[h]=null==u.mass?1:u.mass,a[h]=null==u.size?1:u.size}for(h=0;h<e.length;h++){var c=e[h],d=c.node1,f=c.node2;s[2*h]=d,s[2*h+1]=f,l[h]=null==c.weight?1:c.weight}var r=Math.ceil(Math.sqrt(t.length)),i=r,p=new Float32Array(r*i*4),m=this._positionTex;m.width=r,m.height=i,m.pixels=p,this._worker.postMessage({cmd:"init",nodesPosition:n,nodesMass:o,nodesSize:a,edges:s,edgesWeight:l}),this._globalSpeed=1/0},f_.prototype.updateOption=function(t){var e={};for(o in m_)e[o]=m_[o];var r=this._nodes,i=this._edges,n=r.length;if(e.jitterTolerence=5e4<n?10:5e3<n?1:.1,e.scaling=100<n?2:10,e.barnesHutOptimize=1e3<n,t)for(var o in m_)null!=t[o]&&(e[o]=t[o]);if(!e.gravityCenter){for(var a=[1/0,1/0],s=[-1/0,-1/0],l=0;l<r.length;l++)a[0]=Math.min(r[l].x,a[0]),a[1]=Math.min(r[l].y,a[1]),s[0]=Math.max(r[l].x,s[0]),s[1]=Math.max(r[l].y,s[1]);e.gravityCenter=[.5*(a[0]+s[0]),.5*(a[1]+s[1])]}for(l=0;l<i.length;l++){var h=i[l].node1,u=i[l].node2;r[h].degree=(r[h].degree||0)+1,r[u].degree=(r[u].degree||0)+1}this._worker&&this._worker.postMessage({cmd:"updateConfig",config:e})},f_.prototype.update=function(t,e,r){null==e&&(e=1),e=Math.max(e,1),this._frame+=e,this._onupdate=r,this._worker&&this._worker.postMessage({cmd:"update",steps:Math.round(e)})},f_.prototype._$onupdate=function(t){var e;this._disposed||(e=new Float32Array(t.data.buffer),this._globalSpeed=t.data.globalSpeed,this._positionArr=e,this._updateTexture(e),this._onupdate&&this._onupdate())},f_.prototype.getNodePositionTexture=function(){return this._positionTex},f_.prototype.getNodeUV=function(t,e){var r=this._positionTex.width,i=this._positionTex.height;return(e=e||[])[0]=t%r/(r-1),e[1]=Math.floor(t/r)/(i-1),e},f_.prototype.getNodes=function(){return this._nodes},f_.prototype.getEdges=function(){return this._edges},f_.prototype.isFinished=function(t){return this._frame>t},f_.prototype.getNodePosition=function(t,e){if(e=e||new Float32Array(2*this._nodes.length),this._positionArr)for(var r=0;r<this._positionArr.length;r++)e[r]=this._positionArr[r];return e},f_.prototype._updateTexture=function(t){for(var e=this._positionTex.pixels,r=0,i=0;i<t.length;)e[r++]=t[i++],e[r++]=t[i++],e[r++]=1,e[r++]=1;this._positionTex.dirty()},f_.prototype.dispose=function(t){this._disposed=!0,this._worker=null};const g_=f_,__=P.extend(function(){return{zr:null,viewGL:null,minZoom:.2,maxZoom:5,_needsUpdate:!1,_dx:0,_dy:0,_zoom:1}},function(){this._mouseDownHandler=this._mouseDownHandler.bind(this),this._mouseWheelHandler=this._mouseWheelHandler.bind(this),this._mouseMoveHandler=this._mouseMoveHandler.bind(this),this._mouseUpHandler=this._mouseUpHandler.bind(this),this._update=this._update.bind(this)},{init:function(){var t=this.zr;t.on("mousedown",this._mouseDownHandler),t.on("mousewheel",this._mouseWheelHandler),t.on("globalout",this._mouseUpHandler),t.animation.on("frame",this._update)},setTarget:function(t){this._target=t},setZoom:function(t){this._zoom=Math.max(Math.min(t,this.maxZoom),this.minZoom),this._needsUpdate=!0},setOffset:function(t){this._dx=t[0],this._dy=t[1],this._needsUpdate=!0},getZoom:function(){return this._zoom},getOffset:function(){return[this._dx,this._dy]},_update:function(){var t,e;this._target&&this._needsUpdate&&(t=this._target,e=this._zoom,t.position.x=this._dx,t.position.y=this._dy,t.scale.set(e,e,e),this.zr.refresh(),this._needsUpdate=!1,this.trigger("update"))},_mouseDownHandler:function(t){var e;t.target||(e=t.offsetX,t=t.offsetY,this.viewGL&&!this.viewGL.containPoint(e,t))||(this.zr.on("mousemove",this._mouseMoveHandler),this.zr.on("mouseup",this._mouseUpHandler),e=this._convertPos(e,t),this._x=e.x,this._y=e.y)},_convertPos:function(t,e){var r=this.viewGL.camera,i=this.viewGL.viewport;return{x:(t-i.x)/i.width*(r.right-r.left)+r.left,y:(e-i.y)/i.height*(r.bottom-r.top)+r.top}},_mouseMoveHandler:function(t){t=this._convertPos(t.offsetX,t.offsetY);this._dx+=t.x-this._x,this._dy+=t.y-this._y,this._x=t.x,this._y=t.y,this._needsUpdate=!0},_mouseUpHandler:function(t){this.zr.off("mousemove",this._mouseMoveHandler),this.zr.off("mouseup",this._mouseUpHandler)},_mouseWheelHandler:function(t){var e,r,i=(t=t.event).wheelDelta||-t.detail;0!==i&&(r=t.offsetX,t=t.offsetY,!this.viewGL||this.viewGL.containPoint(r,t))&&(i=0<i?1.1:.9,i=(e=Math.max(Math.min(this._zoom*i,this.maxZoom),this.minZoom))/this._zoom,t=((r=this._convertPos(r,t)).x-this._dx)*(i-1),r=(r.y-this._dy)*(i-1),this._dx-=t,this._dy-=r,this._zoom=e,this._needsUpdate=!0)},dispose:function(){var t=this.zr;t.off("mousedown",this._mouseDownHandler),t.off("mousemove",this._mouseMoveHandler),t.off("mouseup",this._mouseUpHandler),t.off("mousewheel",this._mouseWheelHandler),t.off("globalout",this._mouseUpHandler),t.animation.off("frame",this._update)}});var y_,v_=m.vec2,x_=(q.Shader.import("@export ecgl.lines2D.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec2 position: POSITION;\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n\n#ifdef POSITIONTEXTURE_ENABLED\nuniform sampler2D positionTexture;\n#endif\n\nvoid main()\n{\n gl_Position = worldViewProjection * vec4(position, -10.0, 1.0);\n\n v_Color = a_Color;\n}\n\n@end\n\n@export ecgl.lines2D.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n gl_FragColor = color * v_Color;\n}\n@end\n\n\n@export ecgl.meshLines2D.vertex\n\nattribute vec2 position: POSITION;\nattribute vec2 normal;\nattribute float offset;\nattribute vec4 a_Color : COLOR;\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform vec4 viewport : VIEWPORT;\n\nvarying vec4 v_Color;\nvarying float v_Miter;\n\nvoid main()\n{\n vec4 p2 = worldViewProjection * vec4(position + normal, -10.0, 1.0);\n gl_Position = worldViewProjection * vec4(position, -10.0, 1.0);\n\n p2.xy /= p2.w;\n gl_Position.xy /= gl_Position.w;\n\n vec2 N = normalize(p2.xy - gl_Position.xy);\n gl_Position.xy += N * offset / viewport.zw * 2.0;\n\n gl_Position.xy *= gl_Position.w;\n\n v_Color = a_Color;\n}\n@end\n\n\n@export ecgl.meshLines2D.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nvarying vec4 v_Color;\nvarying float v_Miter;\n\nvoid main()\n{\n gl_FragColor = color * v_Color;\n}\n\n@end"),1);const T_=O.ChartView.extend({type:"graphGL",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this.viewGL=new gf("orthographic"),this.viewGL.camera.left=this.viewGL.camera.right=0,this.viewGL.add(this.groupGL),this._pointsBuilder=new Jm(!0,e),this._forceEdgesMesh=new q.Mesh({material:new q.Material({shader:q.createShader("ecgl.forceAtlas2.edges"),transparent:!0,depthMask:!1,depthTest:!1}),$ignorePicking:!0,geometry:new q.Geometry({attributes:{node:new q.Geometry.Attribute("node","float",2),color:new q.Geometry.Attribute("color","float",4,"COLOR")},dynamic:!0,mainAttribute:"node"}),renderOrder:-1,mode:q.Mesh.LINES}),this._edgesMesh=new q.Mesh({material:new q.Material({shader:q.createShader("ecgl.meshLines2D"),transparent:!0,depthMask:!1,depthTest:!1}),$ignorePicking:!0,geometry:new h_({useNativeLine:!1,dynamic:!0}),renderOrder:-1,culling:!1}),this._layoutId=0,this._control=new __({zr:e.getZr(),viewGL:this.viewGL}),this._control.setTarget(this.groupGL),this._control.init(),this._clickHandler=this._clickHandler.bind(this)},render:function(t,e,r){this.groupGL.add(this._pointsBuilder.rootNode),this._model=t,this._api=r,this._initLayout(t,e,r),this._pointsBuilder.update(t,e,r),this._forceLayoutInstance instanceof d_||this.groupGL.remove(this._forceEdgesMesh),this._updateCamera(t,r),this._control.off("update"),this._control.on("update",function(){r.dispatchAction({type:"graphGLRoam",seriesId:t.id,zoom:this._control.getZoom(),offset:this._control.getOffset()}),this._pointsBuilder.updateView(this.viewGL.camera)},this),this._control.setZoom(A.firstNotNull(t.get("zoom"),1)),this._control.setOffset(t.get("offset")||[0,0]);var i,e=this._pointsBuilder.getPointsMesh();e.off("mousemove",this._mousemoveHandler),e.off("mouseout",this._mouseOutHandler,this),r.getZr().off("click",this._clickHandler),this._pointsBuilder.highlightOnMouseover=!0,t.get("focusNodeAdjacency")&&("click"===(i=t.get("focusNodeAdjacencyOn"))?r.getZr().on("click",this._clickHandler):"mouseover"===i?(e.on("mousemove",this._mousemoveHandler,this),e.on("mouseout",this._mouseOutHandler,this),this._pointsBuilder.highlightOnMouseover=!1):console.warn("Unkown focusNodeAdjacencyOn value s"+i)),this._lastMouseOverDataIndex=-1},_clickHandler:function(t){var e;this._layouting||(0<=(e=this._pointsBuilder.getPointsMesh().dataIndex)?this._api.dispatchAction({type:"graphGLFocusNodeAdjacency",seriesId:this._model.id,dataIndex:e}):this._api.dispatchAction({type:"graphGLUnfocusNodeAdjacency",seriesId:this._model.id}))},_mousemoveHandler:function(t){var e;this._layouting||(0<=(e=this._pointsBuilder.getPointsMesh().dataIndex)?e!==this._lastMouseOverDataIndex&&this._api.dispatchAction({type:"graphGLFocusNodeAdjacency",seriesId:this._model.id,dataIndex:e}):this._mouseOutHandler(t),this._lastMouseOverDataIndex=e)},_mouseOutHandler:function(t){this._layouting||(this._api.dispatchAction({type:"graphGLUnfocusNodeAdjacency",seriesId:this._model.id}),this._lastMouseOverDataIndex=-1)},_updateForceEdgesGeometry:function(r,t){var i=this._forceEdgesMesh.geometry,n=t.getEdgeData(),o=0,a=this._forceLayoutInstance,t=2*n.count();i.attributes.node.init(t),i.attributes.color.init(t),n.each(function(t){var t=r[t],e=(i.attributes.node.set(o,a.getNodeUV(t.node1)),i.attributes.node.set(o+1,a.getNodeUV(t.node2)),ep(n,t.dataIndex)),e=q.parseColor(e);e[3]*=A.firstNotNull(rp(n,t.dataIndex),1),i.attributes.color.set(o,e),i.attributes.color.set(o+1,e),o+=2}),i.dirty()},_updateMeshLinesGeometry:function(){var a=this._model.getEdgeData(),s=this._edgesMesh.geometry,a=this._model.getEdgeData(),l=this._model.getData().getLayout("points"),h=(s.resetOffset(),s.setVertexCount(a.count()*s.getLineVertexCount()),s.setTriangleCount(a.count()*s.getLineTriangleCount()),[]),u=[],c=["lineStyle","width"];this._originalEdgeColors=new Float32Array(4*a.count()),this._edgeIndicesMap=new Float32Array(a.count()),a.each(function(t){var e=a.graph.getEdgeByIndex(t),r=2*e.node1.dataIndex,i=2*e.node2.dataIndex,r=(h[0]=l[r],h[1]=l[1+r],u[0]=l[i],u[1]=l[1+i],ep(a,e.dataIndex)),n=q.parseColor(r),i=(n[3]*=A.firstNotNull(rp(a,e.dataIndex),1),a.getItemModel(e.dataIndex)),r=A.firstNotNull(i.get(c),1)*this._api.getDevicePixelRatio();s.addLine(h,u,n,r);for(var o=0;o<4;o++)this._originalEdgeColors[4*e.dataIndex+o]=n[o];this._edgeIndicesMap[e.dataIndex]=t},this),s.dirty()},_updateForceNodesGeometry:function(t){for(var e=this._pointsBuilder.getPointsMesh(),r=[],i=0;i<t.count();i++)this._forceLayoutInstance.getNodeUV(i,r),e.geometry.attributes.position.set(i,r);e.geometry.dirty("position")},_initLayout:function(t,e,r){var i,o,n,a,s,l,h,u,c,d,f=t.get("layout"),p=t.getGraph(),m=ad(t.getBoxLayoutParams(),{width:r.getWidth(),height:r.getHeight()}),g=("force"===f&&(console.warn("Currently only forceAtlas2 layout supported."),f="forceAtlas2"),this.stopLayout(t,e,r,{beforeLayout:!0}),t.getData()),_=t.getData();"forceAtlas2"===f?(f=t.getModel("forceAtlas2"),i=this._forceLayoutInstance,o=[],n=[],a=g.getDataExtent("value"),s=_.getDataExtent("value"),l=A.firstNotNull(f.get("edgeWeight"),1),h=A.firstNotNull(f.get("nodeWeight"),1),"number"==typeof l&&(l=[l,l]),"number"==typeof h&&(h=[h,h]),d=0,u={},c=new Float32Array(2*g.count()),p.eachNode(function(t){var e,r,i=t.dataIndex,n=g.get("value",i),t=(g.hasItemOption&&(e=(r=g.getItemModel(i)).get("x"),r=r.get("y")),null==e&&(e=m.x+Math.random()*m.width,r=m.y+Math.random()*m.height),c[2*d]=e,c[2*d+1]=r,u[t.id]=d++,O.number.linearMap(n,a,h));isNaN(t)&&(t=isNaN(h[0])?1:h[0]),o.push({x:e,y:r,mass:t,size:g.getItemVisual(i,"symbolSize")})}),g.setLayout("points",c),p.eachEdge(function(t){var e=t.dataIndex,r=g.get("value",e),r=O.number.linearMap(r,s,l);isNaN(r)&&(r=isNaN(l[0])?1:l[0]),n.push({node1:u[t.node1.id],node2:u[t.node2.id],weight:r,dataIndex:e})}),i||(_=f.get("GPU"),!this._forceLayoutInstance||(!_||this._forceLayoutInstance instanceof d_)&&(_||this._forceLayoutInstance instanceof g_)||(this._forceLayoutInstanceToDispose=this._forceLayoutInstance),i=this._forceLayoutInstance=new(_?d_:g_)),i.initData(o,n),i.updateOption(f.option),this._updateForceEdgesGeometry(i.getEdges(),t),this._updatePositionTexture(),r.dispatchAction({type:"graphGLStartLayout",from:this.uid})):(c=new Float32Array(2*g.count()),d=0,p.eachNode(function(t){var e,r,t=t.dataIndex;g.hasItemOption&&(e=(t=g.getItemModel(t)).get("x"),r=t.get("y")),c[d++]=e,c[d++]=r}),g.setLayout("points",c),this._updateAfterLayout(t,e,r))},_updatePositionTexture:function(){var t=this._forceLayoutInstance.getNodePositionTexture();this._pointsBuilder.setPositionTexture(t),this._forceEdgesMesh.material.set("positionTex",t)},startLayout:function(e,t,r,i){var n,o,a,s,l,h,u,c,d,f;i&&null!=i.from&&i.from!==this.uid||(n=this.viewGL,r=this._api,o=this._forceLayoutInstance,a=this._model.getData(),i=this._model.getModel("forceAtlas2"),o?(this.groupGL.remove(this._edgesMesh),this.groupGL.add(this._forceEdgesMesh),this._forceLayoutInstance&&(this._updateForceNodesGeometry(e.getData()),this._pointsBuilder.hideLabels(),l=(s=this)._layoutId=x_++,h=i.getShallow("maxSteps"),u=i.getShallow("steps"),c=0,d=Math.max(2*u,20),f=function(t){t===s._layoutId&&(o.isFinished(h)?(r.dispatchAction({type:"graphGLStopLayout",from:s.uid}),r.dispatchAction({type:"graphGLFinishLayout",points:a.getLayout("points"),from:s.uid})):o.update(n.layer.renderer,u,function(){s._updatePositionTexture(),d<=(c+=u)&&(s._syncNodePosition(e),c=0),r.getZr().refresh(),jo(function(){f(t)})}))},jo(function(){s._forceLayoutInstanceToDispose&&(s._forceLayoutInstanceToDispose.dispose(n.layer.renderer),s._forceLayoutInstanceToDispose=null),f(l)}),this._layouting=!0)):console.error("None layout don't have startLayout action"))},stopLayout:function(t,e,r,i){i&&null!=i.from&&i.from!==this.uid||(this._layoutId=0,this.groupGL.remove(this._forceEdgesMesh),this.groupGL.add(this._edgesMesh),this._forceLayoutInstance&&this.viewGL.layer&&(i&&i.beforeLayout||(this._syncNodePosition(t),this._updateAfterLayout(t,e,r)),this._api.getZr().refresh(),this._layouting=!1))},_syncNodePosition:function(t){var e=this._forceLayoutInstance.getNodePosition(this.viewGL.layer.renderer);t.getData().setLayout("points",e),t.setNodePosition(e)},_updateAfterLayout:function(t,e,r){this._updateMeshLinesGeometry(),this._pointsBuilder.removePositionTexture(),this._pointsBuilder.updateLayout(t,e,r),this._pointsBuilder.updateView(this.viewGL.camera),this._pointsBuilder.updateLabels(),this._pointsBuilder.showLabels()},focusNodeAdjacency:function(t,e,r,i){var n=this._model.getData(),i=(this._downplayAll(),i.dataIndex),o=n.graph,a=[],s=o.getNodeByIndex(i),l=(a.push(s),s.edges.forEach(function(t){t.dataIndex<0||(t.node1!==s&&a.push(t.node1),t.node2!==s&&a.push(t.node2))},this),this._pointsBuilder.fadeOutAll(.05),this._fadeOutEdgesAll(.05),a.forEach(function(t){this._pointsBuilder.highlight(n,t.dataIndex)},this),this._pointsBuilder.updateLabels(a.map(function(t){return t.dataIndex})),[]);s.edges.forEach(function(t){0<=t.dataIndex&&(this._highlightEdge(t.dataIndex),l.push(t))},this),this._focusNodes=a,this._focusEdges=l},unfocusNodeAdjacency:function(t,e,r,i){this._downplayAll(),this._pointsBuilder.fadeInAll(),this._fadeInEdgesAll(),this._pointsBuilder.updateLabels()},_highlightEdge:function(t){var e=this._model.getEdgeData().getItemModel(t),r=q.parseColor(e.get("emphasis.lineStyle.color")||e.get("lineStyle.color")),e=A.firstNotNull(e.get("emphasis.lineStyle.opacity"),e.get("lineStyle.opacity"),1);r[3]*=e,this._edgesMesh.geometry.setItemColor(this._edgeIndicesMap[t],r)},_downplayAll:function(){this._focusNodes&&this._focusNodes.forEach(function(t){this._pointsBuilder.downplay(this._model.getData(),t.dataIndex)},this),this._focusEdges&&this._focusEdges.forEach(function(t){this._downplayEdge(t.dataIndex)},this)},_downplayEdge:function(t){var e=this._getColor(t,[]);this._edgesMesh.geometry.setItemColor(this._edgeIndicesMap[t],e)},_setEdgeFade:(y_=[],function(t,e){this._getColor(t,y_),y_[3]*=e,this._edgesMesh.geometry.setItemColor(this._edgeIndicesMap[t],y_)}),_getColor:function(t,e){for(var r=0;r<4;r++)e[r]=this._originalEdgeColors[4*t+r];return e},_fadeOutEdgesAll:function(e){this._model.getData().graph.eachEdge(function(t){this._setEdgeFade(t.dataIndex,e)},this)},_fadeInEdgesAll:function(){this._fadeOutEdgesAll(1)},_updateCamera:function(t,e){this.viewGL.setViewport(0,0,e.getWidth(),e.getHeight(),e.getDevicePixelRatio());for(var r=this.viewGL.camera,i=t.getData().getLayout("points"),n=v_.create(1/0,1/0),o=v_.create(-1/0,-1/0),a=[],s=0;s<i.length;)a[0]=i[s++],a[1]=i[s++],v_.min(n,n,a),v_.max(o,o,a);var t=(o[1]+n[1])/2,l=(o[0]+n[0])/2;l>r.left&&l<r.right&&t<r.bottom&&t>r.top||(e=(l=Math.max(o[0]-n[0],10))/e.getWidth()*e.getHeight(),e*=1.4,n[0]-=.2*(l*=1.4),r.left=n[0],r.top=t-e/2,r.bottom=t+e/2,r.right=l+n[0],r.near=0,r.far=100)},dispose:function(){var t=this.viewGL.layer.renderer;this._forceLayoutInstance&&this._forceLayoutInstance.dispose(t),this.groupGL.removeAll(),this._layoutId=-1,this._pointsBuilder.dispose()},remove:function(){this.groupGL.removeAll(),this._control.dispose()}});function b_(t){return t=t instanceof Array?t:[t,t]}(0,O.use)(function(t){function e(){}t.registerChartView(T_),t.registerSeriesModel($g),t.registerVisual(function(t){const h={};t.eachSeriesByType("graphGL",function(a){var s=a.getCategoriesData(),o=a.getData(),l={};s.each(function(e){var t=s.getName(e),r=(l["ec-"+t]=e,s.getItemModel(e)),i=r.getModel("itemStyle").getItemStyle(),n=(i.fill||(i.fill=a.getColorFromPalette(t,h)),s.setItemVisual(e,"style",i),["symbol","symbolSize","symbolKeepAspect"]);for(let t=0;t<n.length;t++){var o=r.getShallow(n[t],!0);null!=o&&s.setItemVisual(e,n[t],o)}}),s.count()&&o.each(function(e){let r=o.getItemModel(e).getShallow("category");if(null!=r){"string"==typeof r&&(r=l["ec-"+r]);var t=s.getItemVisual(r,"style"),i=o.ensureUniqueItemVisual(e,"style"),n=(O.util.extend(i,t),["symbol","symbolSize","symbolKeepAspect"]);for(let t=0;t<n.length;t++)o.setItemVisual(e,n[t],s.getItemVisual(r,n[t]))}})})}),t.registerVisual(function(t){t.eachSeriesByType("graphGL",function(t){var s=t.getGraph(),l=t.getEdgeData(),e=b_(t.get("edgeSymbol")),r=b_(t.get("edgeSymbolSize"));l.setVisual("drawType","stroke"),l.setVisual("fromSymbol",e&&e[0]),l.setVisual("toSymbol",e&&e[1]),l.setVisual("fromSymbolSize",r&&r[0]),l.setVisual("toSymbolSize",r&&r[1]),l.setVisual("style",t.getModel("lineStyle").getLineStyle()),l.each(function(t){var e=l.getItemModel(t),r=s.getEdgeByIndex(t),i=b_(e.getShallow("symbol",!0)),n=b_(e.getShallow("symbolSize",!0)),e=e.getModel("lineStyle").getLineStyle(),o=l.ensureUniqueItemVisual(t,"style");switch(O.util.extend(o,e),o.stroke){case"source":var a=r.node1.getVisual("style");o.stroke=a&&a.fill;break;case"target":a=r.node2.getVisual("style");o.stroke=a&&a.fill}i[0]&&r.setVisual("fromSymbol",i[0]),i[1]&&r.setVisual("toSymbol",i[1]),n[0]&&r.setVisual("fromSymbolSize",n[0]),n[1]&&r.setVisual("toSymbolSize",n[1])})})}),t.registerAction({type:"graphGLRoam",event:"graphglroam",update:"series.graphGL:roam"},function(e,t){t.eachComponent({mainType:"series",query:e},function(t){t.setView(e)})}),t.registerAction({type:"graphGLStartLayout",event:"graphgllayoutstarted",update:"series.graphGL:startLayout"},e),t.registerAction({type:"graphGLStopLayout",event:"graphgllayoutstopped",update:"series.graphGL:stopLayout"},e),t.registerAction({type:"graphGLFocusNodeAdjacency",event:"graphGLFocusNodeAdjacency",update:"series.graphGL:focusNodeAdjacency"},e),t.registerAction({type:"graphGLUnfocusNodeAdjacency",event:"graphGLUnfocusNodeAdjacency",update:"series.graphGL:unfocusNodeAdjacency"},e)});const w_=O.SeriesModel.extend({type:"series.flowGL",dependencies:["geo","grid","bmap"],visualStyleAccessPath:"itemStyle",getInitialData:function(t,e){var r=this.get("coordinateSystem"),r="geo"===r?["lng","lat"]:O.getCoordinateSystemDimensions(r)||["x","y"];if(2<r.length)throw new Error("flowGL can only be used on 2d coordinate systems.");r.push("vx","vy");r=O.helper.createDimensions(this.getSource(),{coordDimensions:r,encodeDefine:this.get("encode"),dimensionsDefine:this.get("dimensions")}),r=new O.List(r,this);return r.initData(this.getSource()),r},defaultOption:{coordinateSystem:"cartesian2d",zlevel:10,supersampling:1,particleType:"point",particleDensity:128,particleSize:1,particleSpeed:1,particleTrail:2,colorTexture:null,gridWidth:"auto",gridHeight:"auto",itemStyle:{color:"#fff",opacity:.8}}}),S_=p.extend(function(){return{dynamic:!0,attributes:{position:new p.Attribute("position","float",3,"POSITION")}}},{resetOffset:function(){this._vertexOffset=0,this._faceOffset=0},setLineCount:function(t){var e=this.attributes,r=4*t,t=2*t;this.vertexCount!==r&&e.position.init(r),this.triangleCount!==t&&(this.indices=0==t?null:new(65535<this.vertexCount?Uint32Array:Uint16Array)(3*t))},addLine:function(t){var e=this._vertexOffset;this.attributes.position.set(e,[t[0],t[1],1]),this.attributes.position.set(e+1,[t[0],t[1],-1]),this.attributes.position.set(e+2,[t[0],t[1],2]),this.attributes.position.set(e+3,[t[0],t[1],-2]),this.setTriangleIndices(this._faceOffset++,[e,e+1,e+2]),this.setTriangleIndices(this._faceOffset++,[e+1,e+2,e+3]),this._vertexOffset+=4}});S.import("@export ecgl.vfParticle.particle.fragment\n\nuniform sampler2D particleTexture;\nuniform sampler2D spawnTexture;\nuniform sampler2D velocityTexture;\n\nuniform float deltaTime;\nuniform float elapsedTime;\n\nuniform float speedScaling : 1.0;\n\nuniform vec2 textureSize;\nuniform vec4 region : [0, 0, 1, 1];\nuniform float firstFrameTime;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n vec4 p = texture2D(particleTexture, v_Texcoord);\n bool spawn = false;\n if (p.w <= 0.0) {\n p = texture2D(spawnTexture, fract(v_Texcoord + elapsedTime / 10.0));\n p.w -= firstFrameTime;\n spawn = true;\n }\n vec2 v = texture2D(velocityTexture, fract(p.xy * region.zw + region.xy)).xy;\n v = (v - 0.5) * 2.0;\n p.z = length(v);\n p.xy += v * deltaTime / 10.0 * speedScaling;\n p.w -= deltaTime;\n\n if (spawn || p.xy != fract(p.xy)) {\n p.z = 0.0;\n }\n p.xy = fract(p.xy);\n\n gl_FragColor = p;\n}\n@end\n\n@export ecgl.vfParticle.renderPoints.vertex\n\n#define PI 3.1415926\n\nattribute vec2 texcoord : TEXCOORD_0;\n\nuniform sampler2D particleTexture;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nuniform float size : 1.0;\n\nvarying float v_Mag;\nvarying vec2 v_Uv;\n\nvoid main()\n{\n vec4 p = texture2D(particleTexture, texcoord);\n\n if (p.w > 0.0 && p.z > 1e-5) {\n gl_Position = worldViewProjection * vec4(p.xy * 2.0 - 1.0, 0.0, 1.0);\n }\n else {\n gl_Position = vec4(100000.0, 100000.0, 100000.0, 1.0);\n }\n\n v_Mag = p.z;\n v_Uv = p.xy;\n\n gl_PointSize = size;\n}\n\n@end\n\n@export ecgl.vfParticle.renderPoints.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\nuniform sampler2D gradientTexture;\nuniform sampler2D colorTexture;\nuniform sampler2D spriteTexture;\n\nvarying float v_Mag;\nvarying vec2 v_Uv;\n\nvoid main()\n{\n gl_FragColor = color;\n#ifdef SPRITETEXTURE_ENABLED\n gl_FragColor *= texture2D(spriteTexture, gl_PointCoord);\n if (color.a == 0.0) {\n discard;\n }\n#endif\n#ifdef GRADIENTTEXTURE_ENABLED\n gl_FragColor *= texture2D(gradientTexture, vec2(v_Mag, 0.5));\n#endif\n#ifdef COLORTEXTURE_ENABLED\n gl_FragColor *= texture2D(colorTexture, v_Uv);\n#endif\n}\n\n@end\n\n@export ecgl.vfParticle.renderLines.vertex\n\n#define PI 3.1415926\n\nattribute vec3 position : POSITION;\n\nuniform sampler2D particleTexture;\nuniform sampler2D prevParticleTexture;\n\nuniform float size : 1.0;\nuniform vec4 vp: VIEWPORT;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nvarying float v_Mag;\nvarying vec2 v_Uv;\n\n@import clay.util.rand\n\nvoid main()\n{\n vec4 p = texture2D(particleTexture, position.xy);\n vec4 p2 = texture2D(prevParticleTexture, position.xy);\n\n p.xy = p.xy * 2.0 - 1.0;\n p2.xy = p2.xy * 2.0 - 1.0;\n\n if (p.w > 0.0 && p.z > 1e-5) {\n vec2 dir = normalize(p.xy - p2.xy);\n vec2 norm = vec2(dir.y / vp.z, -dir.x / vp.w) * sign(position.z) * size;\n if (abs(position.z) == 2.0) {\n gl_Position = vec4(p.xy + norm, 0.0, 1.0);\n v_Uv = p.xy;\n v_Mag = p.z;\n }\n else {\n gl_Position = vec4(p2.xy + norm, 0.0, 1.0);\n v_Mag = p2.z;\n v_Uv = p2.xy;\n }\n gl_Position = worldViewProjection * gl_Position;\n }\n else {\n gl_Position = vec4(100000.0, 100000.0, 100000.0, 1.0);\n }\n}\n\n@end\n\n@export ecgl.vfParticle.renderLines.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\nuniform sampler2D gradientTexture;\nuniform sampler2D colorTexture;\n\nvarying float v_Mag;\nvarying vec2 v_Uv;\n\nvoid main()\n{\n gl_FragColor = color;\n #ifdef GRADIENTTEXTURE_ENABLED\n gl_FragColor *= texture2D(gradientTexture, vec2(v_Mag, 0.5));\n#endif\n#ifdef COLORTEXTURE_ENABLED\n gl_FragColor *= texture2D(colorTexture, v_Uv);\n#endif\n}\n\n@end\n");function E_(){this.motionBlurFactor=.99,this.vectorFieldTexture=new F({type:B.FLOAT,flipY:!1}),this.particleLife=[5,20],this._particleType="point",this._particleSize=1,this.particleColor=[1,1,1,1],this.particleSpeedScaling=1,this._thisFrameTexture=null,this._particlePass=null,this._spawnTexture=null,this._particleTexture0=null,this._particleTexture1=null,this._particlePointsMesh=null,this._surfaceFrameBuffer=null,this._elapsedTime=0,this._scene=null,this._camera=null,this._lastFrameTexture=null,this._supersampling=1,this._downsampleTextures=[],this._width=512,this._height=512,this.init()}E_.prototype={constructor:E_,init:function(){var t={type:B.FLOAT,minFilter:B.NEAREST,magFilter:B.NEAREST,useMipmap:!1},t=(this._spawnTexture=new F(t),this._particleTexture0=new F(t),this._particleTexture1=new F(t),this._frameBuffer=new xi({depthBuffer:!1}),this._particlePass=new tn({fragment:S.source("ecgl.vfParticle.particle.fragment")}),this._particlePass.setUniform("velocityTexture",this.vectorFieldTexture),this._particlePass.setUniform("spawnTexture",this._spawnTexture),this._downsamplePass=new tn({fragment:S.source("clay.compositor.downsample")}),new mr({renderOrder:10,material:new Tt({shader:new S(S.source("ecgl.vfParticle.renderPoints.vertex"),S.source("ecgl.vfParticle.renderPoints.fragment"))}),mode:mr.POINTS,geometry:new p({dynamic:!0,mainAttribute:"texcoord0"})})),e=new mr({renderOrder:10,material:new Tt({shader:new S(S.source("ecgl.vfParticle.renderLines.vertex"),S.source("ecgl.vfParticle.renderLines.fragment"))}),geometry:new S_,culling:!1}),r=new mr({material:new Tt({shader:new S(S.source("ecgl.color.vertex"),S.source("ecgl.color.fragment"))}),geometry:new wi});r.material.enableTexture("diffuseMap"),this._particlePointsMesh=t,this._particleLinesMesh=e,this._lastFrameFullQuadMesh=r,this._camera=new Qi,this._thisFrameTexture=new F,this._lastFrameTexture=new F},setParticleDensity:function(t,e){for(var r=new Float32Array(4*(t*e)),i=0,n=this.particleLife,o=0;o<t;o++)for(var a=0;a<e;a++,i++){r[4*i]=Math.random(),r[4*i+1]=Math.random(),r[4*i+2]=Math.random();var s=(n[1]-n[0])*Math.random()+n[0];r[4*i+3]=s}"line"===this._particleType?this._setLineGeometry(t,e):this._setPointsGeometry(t,e),this._spawnTexture.width=t,this._spawnTexture.height=e,this._spawnTexture.pixels=r,this._particleTexture0.width=this._particleTexture1.width=t,this._particleTexture0.height=this._particleTexture1.height=e,this._particlePass.setUniform("textureSize",[t,e])},_setPointsGeometry:function(t,e){for(var r=this._particlePointsMesh.geometry,i=r.attributes,n=(i.texcoord0.init(t*e),0),o=0;o<t;o++)for(var a=0;a<e;a++,n++)i.texcoord0.value[2*n]=o/t,i.texcoord0.value[2*n+1]=a/e;r.dirty()},_setLineGeometry:function(t,e){var r=t*e,i=this._getParticleMesh().geometry;i.setLineCount(r),i.resetOffset();for(var n=0;n<t;n++)for(var o=0;o<e;o++)i.addLine([n/t,o/e]);i.dirty()},_getParticleMesh:function(){return"line"===this._particleType?this._particleLinesMesh:this._particlePointsMesh},update:function(t,e,r,i){var n=this._getParticleMesh(),o=this._frameBuffer,a=this._particlePass,e=(i&&this._updateDownsampleTextures(t,e),n.material.set("size",this._particleSize*this._supersampling),n.material.set("color",this.particleColor),a.setUniform("speedScaling",this.particleSpeedScaling),o.attach(this._particleTexture1),a.setUniform("firstFrameTime",i?(this.particleLife[1]+this.particleLife[0])/2:0),a.setUniform("particleTexture",this._particleTexture0),a.setUniform("deltaTime",r),a.setUniform("elapsedTime",this._elapsedTime),a.render(t,o),n.material.set("particleTexture",this._particleTexture1),n.material.set("prevParticleTexture",this._particleTexture0),o.attach(this._thisFrameTexture),o.bind(t),t.gl.clear(t.gl.DEPTH_BUFFER_BIT|t.gl.COLOR_BUFFER_BIT),this._lastFrameFullQuadMesh);e.material.set("diffuseMap",this._lastFrameTexture),e.material.set("color",[1,1,1,this.motionBlurFactor]),this._camera.update(!0),t.renderPass([e,n],this._camera),o.unbind(t),this._downsample(t),this._swapTexture(),this._elapsedTime+=r},_downsample:function(t){var e=this._downsampleTextures;if(0!==e.length)for(var r=0,i=this._thisFrameTexture,n=e[r];n;)this._frameBuffer.attach(n),this._downsamplePass.setUniform("texture",i),this._downsamplePass.setUniform("textureSize",[i.width,i.height]),this._downsamplePass.render(t,this._frameBuffer),i=n,n=e[++r]},getSurfaceTexture:function(){var t=this._downsampleTextures;return 0<t.length?t[t.length-1]:this._lastFrameTexture},setRegion:function(t){this._particlePass.setUniform("region",t)},resize:function(t,e){this._lastFrameTexture.width=t*this._supersampling,this._lastFrameTexture.height=e*this._supersampling,this._thisFrameTexture.width=t*this._supersampling,this._thisFrameTexture.height=e*this._supersampling,this._width=t,this._height=e},setParticleSize:function(t){var e,r,i,n=this._getParticleMesh();t<=2?(n.material.disableTexture("spriteTexture"),n.material.transparent=!1):(this._spriteTexture||(this._spriteTexture=new F),this._spriteTexture.image&&this._spriteTexture.image.width===t||(this._spriteTexture.image=(e=t,(r=document.createElement("canvas")).width=r.height=e,(i=r.getContext("2d")).fillStyle="#fff",i.arc(e/2,e/2,e/2,0,2*Math.PI),i.fill(),r),this._spriteTexture.dirty()),n.material.transparent=!0,n.material.enableTexture("spriteTexture"),n.material.set("spriteTexture",this._spriteTexture),this._particleSize=t)},setGradientTexture:function(t){var e=this._getParticleMesh().material;e[t?"enableTexture":"disableTexture"]("gradientTexture"),e.setUniform("gradientTexture",t)},setColorTextureImage:function(t,e){this._getParticleMesh().material.setTextureImage("colorTexture",t,e,{flipY:!0})},setParticleType:function(t){this._particleType=t},clearFrame:function(t){var e=this._frameBuffer;e.attach(this._lastFrameTexture),e.bind(t),t.gl.clear(t.gl.DEPTH_BUFFER_BIT|t.gl.COLOR_BUFFER_BIT),e.unbind(t)},setSupersampling:function(t){this._supersampling=t,this.resize(this._width,this._height)},_updateDownsampleTextures:function(t,e){for(var r=this._downsampleTextures,i=Math.max(Math.floor(Math.log(this._supersampling/e.getDevicePixelRatio())/Math.log(2)),0),n=2,o=this._width*this._supersampling,a=this._height*this._supersampling,s=0;s<i;s++)r[s]=r[s]||new F,r[s].width=o/n,r[s].height=a/n,n*=2;for(;s<r.length;s++)r[s].dispose(t);r.length=i},_swapTexture:function(){var t=this._particleTexture0,t=(this._particleTexture0=this._particleTexture1,this._particleTexture1=t,this._thisFrameTexture);this._thisFrameTexture=this._lastFrameTexture,this._lastFrameTexture=t},dispose:function(e){e.disposeFrameBuffer(this._frameBuffer),e.disposeTexture(this.vectorFieldTexture),e.disposeTexture(this._spawnTexture),e.disposeTexture(this._particleTexture0),e.disposeTexture(this._particleTexture1),e.disposeTexture(this._thisFrameTexture),e.disposeTexture(this._lastFrameTexture),e.disposeGeometry(this._particleLinesMesh.geometry),e.disposeGeometry(this._particlePointsMesh.geometry),e.disposeGeometry(this._lastFrameFullQuadMesh.geometry),this._spriteTexture&&e.disposeTexture(this._spriteTexture),this._particlePass.dispose(e),this._downsamplePass.dispose(e),this._downsampleTextures.forEach(function(t){t.dispose(e)})}};const M_=E_,A_=O.ChartView.extend({type:"flowGL",__ecgl__:!0,init:function(t,e){this.viewGL=new gf("orthographic"),this.groupGL=new q.Node,this.viewGL.add(this.groupGL),this._particleSurface=new M_;var r=new q.Mesh({geometry:new q.PlaneGeometry,material:new q.Material({shader:new q.Shader({vertex:q.Shader.source("ecgl.color.vertex"),fragment:q.Shader.source("ecgl.color.fragment")}),transparent:!0})});r.material.enableTexture("diffuseMap"),this.groupGL.add(r),this._planeMesh=r},render:function(t,e,r){var i=this._particleSurface,n=(i.setParticleType(t.get("particleType")),i.setSupersampling(t.get("supersampling")),this._updateData(t,r),this._updateCamera(r.getWidth(),r.getHeight(),r.getDevicePixelRatio()),A.firstNotNull(t.get("particleDensity"),128)),o=(i.setParticleDensity(n,n),this._planeMesh),a=+new Date,s=this,l=!0,n=(o.__percent=0,o.stopAnimation(),o.animate("",{loop:!0}).when(1e5,{__percent:1}).during(function(){var t=+new Date,t=Math.min(t-a,20);a+=t,s._renderer&&(i.update(s._renderer,r,t/1e3,l),o.material.set("diffuseMap",i.getSurfaceTexture())),l=!1}).start(),t.getModel("itemStyle")),h=q.parseColor(n.get("color"));h[3]*=A.firstNotNull(n.get("opacity"),1),o.material.set("color",h),i.setColorTextureImage(t.get("colorTexture"),r),i.setParticleSize(t.get("particleSize")),i.particleSpeedScaling=t.get("particleSpeed"),i.motionBlurFactor=1-Math.pow(.1,t.get("particleTrail"))},updateTransform:function(t,e,r){this._updateData(t,r)},afterRender:function(t,e,r,i){i=i.renderer;this._renderer=i},_updateData:function(e,t){var n=e.coordinateSystem,r=n.dimensions.map(function(t){return e.coordDimToDataDim(t)[0]}),i=e.getData(),o=i.getDataExtent(r[0]),a=i.getDataExtent(r[1]),s=e.get("gridWidth"),l=e.get("gridHeight"),a=(null!=s&&"auto"!==s||(o=(o[1]-o[0])/(a[1]-a[0]),s=Math.round(Math.sqrt(o*i.count()))),null!=l&&"auto"!==l||(l=Math.ceil(i.count()/s)),this._particleSurface.vectorFieldTexture),h=a.pixels;if(h&&h.length===l*s*4)for(var u=0;u<h.length;u++)h[u]=0;else h=a.pixels=new Float32Array(s*l*4);var c=0,d=1/0,f=new Float32Array(2*i.count()),p=0,m=[[1/0,1/0],[-1/0,-1/0]];i.each([r[0],r[1],"vx","vy"],function(t,e,r,i){t=n.dataToPoint([t,e]),f[p++]=t[0],f[p++]=t[1],m[0][0]=Math.min(t[0],m[0][0]),m[0][1]=Math.min(t[1],m[0][1]),m[1][0]=Math.max(t[0],m[1][0]),m[1][1]=Math.max(t[1],m[1][1]),e=Math.sqrt(r*r+i*i);c=Math.max(c,e),d=Math.min(d,e)}),i.each(["vx","vy"],function(t,e,r){var i=Math.round((f[2*r]-m[0][0])/(m[1][0]-m[0][0])*(s-1)),r=4*((l-1-Math.round((f[2*r+1]-m[0][1])/(m[1][1]-m[0][1])*(l-1)))*s+i);h[r]=t/c*.5+.5,h[1+r]=e/c*.5+.5,h[3+r]=1}),a.width=s,a.height=l,"bmap"===e.get("coordinateSystem")&&this._fillEmptyPixels(a),a.dirty(),this._updatePlanePosition(m[0],m[1],e,t),this._updateGradientTexture(i.getVisual("visualMeta"),[d,c])},_fillEmptyPixels:function(t){var i=t.pixels,n=t.width,o=t.height;function e(t,e,r){t=Math.max(Math.min(t,n-1),0);e=4*((e=Math.max(Math.min(e,o-1),0))*(n-1)+t);return 0!==i[3+e]&&(r[0]=i[e],r[1]=i[1+e],1)}function r(t,e,r){r[0]=t[0]+e[0],r[1]=t[1]+e[1]}for(var a=[],s=[],l=[],h=[],u=[],c=0,d=0;d<o;d++)for(var f=0;f<n;f++){var p=4*(d*(n-1)+f);0===i[3+p]&&(c=a[0]=a[1]=0,e(f-1,d,s)&&(c++,r(s,a,a)),e(f+1,d,l)&&(c++,r(l,a,a)),e(f,d-1,h)&&(c++,r(h,a,a)),e(f,d+1,u)&&(c++,r(u,a,a)),a[0]/=c,a[1]/=c,i[p]=a[0],i[1+p]=a[1]),i[3+p]=1}},_updateGradientTexture:function(t,r){var e,i,n,o;t&&t.length?(this._gradientTexture=this._gradientTexture||new q.Texture2D({image:document.createElement("canvas")}),(i=(e=this._gradientTexture).image).width=200,i.height=1,n=i.getContext("2d"),o=n.createLinearGradient(0,.5,i.width,.5),t[0].stops.forEach(function(t){var e=r[1]===r[0]?0:(e=t.value/r[1],Math.min(Math.max(e,0),1));o.addColorStop(e,t.color)}),n.fillStyle=o,n.fillRect(0,0,i.width,i.height),e.dirty(),this._particleSurface.setGradientTexture(this._gradientTexture)):this._particleSurface.setGradientTexture(null)},_updatePlanePosition:function(t,e,r,i){r=this._limitInViewportAndFullFill(t,e,r,i),t=r.leftTop,e=r.rightBottom,this._particleSurface.setRegion(r.region),this._planeMesh.position.set((t[0]+e[0])/2,i.getHeight()-(t[1]+e[1])/2,0),r=e[0]-t[0],i=e[1]-t[1];this._planeMesh.scale.set(r/2,i/2,1),this._particleSurface.resize(Math.max(Math.min(r,2048),1),Math.max(Math.min(i,2048),1)),this._renderer&&this._particleSurface.clearFrame(this._renderer)},_limitInViewportAndFullFill:function(t,e,r,i){var n=[Math.max(t[0],0),Math.max(t[1],0)],o=[Math.min(e[0],i.getWidth()),Math.min(e[1],i.getHeight())],r=("bmap"===r.get("coordinateSystem")&&(r=r.getData().getDataExtent(r.coordDimToDataDim("lng")[0]),359<=Math.floor(r[1]-r[0]))&&(0<n[0]&&(n[0]=0),o[0]<i.getWidth())&&(o[0]=i.getWidth()),e[0]-t[0]),i=e[1]-t[1],e=o[1]-n[1];return{leftTop:n,rightBottom:o,region:[(n[0]-t[0])/r,1-e/i-(n[1]-t[1])/i,(o[0]-n[0])/r,e/i]}},_updateCamera:function(t,e,r){this.viewGL.setViewport(0,0,t,e,r);r=this.viewGL.camera;r.left=r.bottom=0,r.top=e,r.right=t,r.near=0,r.far=100,r.position.z=10},remove:function(){this._planeMesh.stopAnimation(),this.groupGL.removeAll()},dispose:function(){this._renderer&&this._particleSurface.dispose(this._renderer),this.groupGL.removeAll()}});(0,O.use)(function(t){t.registerChartView(A_),t.registerSeriesModel(w_)});var C_=O.SeriesModel.extend({type:"series.linesGL",dependencies:["grid","geo"],visualStyleAccessPath:"lineStyle",visualDrawType:"stroke",streamEnabled:!0,init:function(t){var e=this._processFlatCoordsArray(t.data);this._flatCoords=e.flatCoords,this._flatCoordsOffset=e.flatCoordsOffset,e.flatCoords&&(t.data=new Float32Array(e.count)),C_.superApply(this,"init",arguments)},mergeOption:function(t){var e=this._processFlatCoordsArray(t.data);this._flatCoords=e.flatCoords,this._flatCoordsOffset=e.flatCoordsOffset,e.flatCoords&&(t.data=new Float32Array(e.count)),C_.superApply(this,"mergeOption",arguments)},appendData:function(t){var e=this._processFlatCoordsArray(t.data);e.flatCoords&&(this._flatCoords?(this._flatCoords=wo(this._flatCoords,e.flatCoords),this._flatCoordsOffset=wo(this._flatCoordsOffset,e.flatCoordsOffset)):(this._flatCoords=e.flatCoords,this._flatCoordsOffset=e.flatCoordsOffset),t.data=new Float32Array(e.count)),this.getRawData().appendData(t.data)},_getCoordsFromItemModel:function(t){t=this.getData().getItemModel(t),t=t.option instanceof Array?t.option:t.getShallow("coords");if(t instanceof Array&&0<t.length&&t[0]instanceof Array)return t;throw new Error("Invalid coords "+JSON.stringify(t)+". Lines must have 2d coords array in data item.")},getLineCoordsCount:function(t){return this._flatCoordsOffset?this._flatCoordsOffset[2*t+1]:this._getCoordsFromItemModel(t).length},getLineCoords:function(t,e){if(this._flatCoordsOffset){for(var r=this._flatCoordsOffset[2*t],i=this._flatCoordsOffset[2*t+1],n=0;n<i;n++)e[n]=e[n]||[],e[n][0]=this._flatCoords[r+2*n],e[n][1]=this._flatCoords[r+2*n+1];return i}for(var o=this._getCoordsFromItemModel(t),n=0;n<o.length;n++)e[n]=e[n]||[],e[n][0]=o[n][0],e[n][1]=o[n][1];return o.length},_processFlatCoordsArray:function(t){var e=0;if(this._flatCoords&&(e=this._flatCoords.length),"number"!=typeof t[0])return{flatCoordsOffset:null,flatCoords:null,count:t.length};for(var r=t.length,i=new Uint32Array(r),n=new Float64Array(r),o=0,a=0,s=0,l=0;l<r;){s++;var h=t[l++];i[a++]=o+e,i[a++]=h;for(var u=0;u<h;u++){var c=t[l++],d=t[l++];if(n[o++]=c,n[o++]=d,r<l)throw new Error("Invalid data format.")}}return{flatCoordsOffset:new Uint32Array(i.buffer,0,a),flatCoords:n,count:s}},getInitialData:function(t,e){var n=new O.List(["value"],this);return n.hasItemOption=!1,n.initData(t.data,[],function(t,e,r,i){if(t instanceof Array)return NaN;n.hasItemOption=!0;t=t.value;return null!=t?t instanceof Array?t[i]:t:void 0}),n},defaultOption:{coordinateSystem:"geo",zlevel:10,progressive:1e4,progressiveThreshold:5e4,blendMode:"source-over",lineStyle:{opacity:.8},postEffect:{enable:!1,colorCorrection:{exposure:0,brightness:0,contrast:1,saturation:1,enable:!0}}}});const D_=C_,L_=O.ChartView.extend({type:"linesGL",__ecgl__:!0,init:function(t,e){this.groupGL=new q.Node,this.viewGL=new gf("orthographic"),this.viewGL.add(this.groupGL),this._glViewHelper=new Rg(this.viewGL),this._nativeLinesShader=q.createShader("ecgl.lines3D"),this._meshLinesShader=q.createShader("ecgl.meshLines3D"),this._linesMeshes=[],this._currentStep=0},render:function(t,e,r){this.groupGL.removeAll(),this._glViewHelper.reset(t,r);var i=(i=this._linesMeshes[0])||(this._linesMeshes[0]=this._createLinesMesh(t));this._linesMeshes.length=1,this.groupGL.add(i),this._updateLinesMesh(t,i,0,t.getData().count()),this.viewGL.setPostEffect(t.getModel("postEffect"),r)},incrementalPrepareRender:function(t,e,r){this.groupGL.removeAll(),this._glViewHelper.reset(t,r),this._currentStep=0,this.viewGL.setPostEffect(t.getModel("postEffect"),r)},incrementalRender:function(t,e,r,i){var n=this._linesMeshes[this._currentStep];n||(n=this._createLinesMesh(e),this._linesMeshes[this._currentStep]=n),this._updateLinesMesh(e,n,t.start,t.end),this.groupGL.add(n),i.getZr().refresh(),this._currentStep++},updateTransform:function(t,e,r){t.coordinateSystem.getRoamTransform&&this._glViewHelper.updateTransform(t,r)},_createLinesMesh:function(t){return new q.Mesh({$ignorePicking:!0,material:new q.Material({shader:q.createShader("ecgl.lines3D"),transparent:!0,depthMask:!1,depthTest:!1}),geometry:new h_({segmentScale:10,useNativeLine:!0,dynamic:!1}),mode:q.Mesh.LINES,culling:!1})},_updateLinesMesh:function(t,e,r,i){var n=t.getData(),o=(e.material.blend="lighter"===t.get("blendMode")?q.additiveBlend:null,t.get("lineStyle.curveness")||0),a=t.get("polyline"),s=e.geometry,l=t.coordinateSystem,h=A.firstNotNull(t.get("lineStyle.width"),1),u=(1<h?(e.material.shader!==this._meshLinesShader&&e.material.attachShader(this._meshLinesShader),e.mode=q.Mesh.TRIANGLES):(e.material.shader!==this._nativeLinesShader&&e.material.attachShader(this._nativeLinesShader),e.mode=q.Mesh.LINES),r=r||0,i=i||n.count(),s.resetOffset(),0),c=0,d=[],f=[],p=[],m=[],g=[],_=.3,y=.7;function v(){f[0]=d[0]*y+m[0]*_-(d[1]-m[1])*o,f[1]=d[1]*y+m[1]*_-(m[0]-d[0])*o,p[0]=d[0]*_+m[0]*y-(d[1]-m[1])*o,p[1]=d[1]*_+m[1]*y-(m[0]-d[0])*o}if(a||0!==o)for(var x=r;x<i;x++)a?(S=t.getLineCoordsCount(x),u+=s.getPolylineVertexCount(S),c+=s.getPolylineTriangleCount(S)):(t.getLineCoords(x,g),this._glViewHelper.dataToPoint(l,g[0],d),this._glViewHelper.dataToPoint(l,g[1],m),v(),u+=s.getCubicCurveVertexCount(d,f,p,m),c+=s.getCubicCurveTriangleCount(d,f,p,m));else{e=i-r;u+=e*s.getLineVertexCount(),c+=e*s.getLineVertexCount()}s.setVertexCount(u),s.setTriangleCount(c);for(var T=r,b=[],x=r;x<i;x++){q.parseColor(ep(n,T),b);for(var w=A.firstNotNull(rp(n,T),1),S=(b[3]*=w,t.getLineCoords(x,g)),E=0;E<S;E++)this._glViewHelper.dataToPoint(l,g[E],g[E]);a?s.addPolyline(g,b,h,0,S):0!==o?(d=g[0],m=g[1],v(),s.addCubicCurve(d,f,p,m,b,h)):s.addPolyline(g,b,h,0,2),T++}},dispose:function(){this.groupGL.removeAll()},remove:function(){this.groupGL.removeAll()}});(0,O.use)(function(t){t.registerChartView(L_),t.registerSeriesModel(D_)})},"echarts/lib/echarts":t=>{t.exports=e}},i={};function n(t){var e;return(i[t]||(e=i[t]={exports:{}},r[t](e,e.exports,n),e)).exports}return n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n("./src/export/all.js")})()});